<!DOCTYPE html>
<html lang="en">
<head>
    <title>Photo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Photo"]'>


    <meta property="og:title" value="Photo">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="Photo class, set_uuid, parse_extension, parse_url_prefix, original_url, large_url, medium_url, small_url, square_url, thumb_url, processing?, sized_url, to_s, to_plain_s, licensed_if_no_user, set_license, trim_fields, to_taxon, sync, update, update_default_license, update_all_licenses, index_observations, index_taxa, editable_by?, orphaned?, source_title, source_url, best_url, serializable_hash, flagged_with, original_dimensions, metadata, repair_photos_for_user, repair_single_photo, local_photo_from_remote_photo, turn_remote_photo_into_local_photo, best_available_url, valid_remote_photo_url?, valid_remote_photo_url, get_api_response, new_from_api_response, destroy_orphans, default_json_options, as_indexed_json, update_photo_native_columns_and_copy_metadata">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Photo
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/models/photo_rb.html">app/models/photo.rb</a></li>
            
            <li><a href="../files/app/models/wikimedia_commons_photo_rb.html">app/models/wikimedia_commons_photo.rb</a></li>
            
            <li><a href="../files/lib/ruby_picasa_rb.html">lib/ruby_picasa.rb</a></li>
            
            <li><a href="../files/lib/ruby_picasa/types_rb.html">lib/ruby_picasa/types.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Photo/MissingPhotoError.html">Photo::MissingPhotoError</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-as_indexed_json">as_indexed_json</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-best_available_url">best_available_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-best_url">best_url</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-default_json_options">default_json_options</a>,
              </li>
            
              
              <li>
                <a href="#method-c-destroy_orphans">destroy_orphans</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-editable_by-3F">editable_by?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-flagged_with">flagged_with</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-get_api_response">get_api_response</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-index_observations">index_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index_taxa">index_taxa</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-large_url">large_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-licensed_if_no_user">licensed_if_no_user</a>,
              </li>
            
              
              <li>
                <a href="#method-c-local_photo_from_remote_photo">local_photo_from_remote_photo</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-medium_url">medium_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-metadata">metadata</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new_from_api_response">new_from_api_response</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-original_dimensions">original_dimensions</a>,
              </li>
            
              
              <li>
                <a href="#method-i-original_url">original_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-orphaned-3F">orphaned?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-parse_extension">parse_extension</a>,
              </li>
            
              
              <li>
                <a href="#method-i-parse_url_prefix">parse_url_prefix</a>,
              </li>
            
              
              <li>
                <a href="#method-i-processing-3F">processing?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-repair_photos_for_user">repair_photos_for_user</a>,
              </li>
            
              
              <li>
                <a href="#method-c-repair_single_photo">repair_single_photo</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-serializable_hash">serializable_hash</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_license">set_license</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_uuid">set_uuid</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sized_url">sized_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-small_url">small_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-source_title">source_title</a>,
              </li>
            
              
              <li>
                <a href="#method-i-source_url">source_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-square_url">square_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sync">sync</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-thumb_url">thumb_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_plain_s">to_plain_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_taxon">to_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-trim_fields">trim_fields</a>,
              </li>
            
              
              <li>
                <a href="#method-c-turn_remote_photo_into_local_photo">turn_remote_photo_into_local_photo</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-update">update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_all_licenses">update_all_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_default_license">update_default_license</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_photo_native_columns_and_copy_metadata">update_photo_native_columns_and_copy_metadata</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-valid_remote_photo_url">valid_remote_photo_url</a>,
              </li>
            
              
              <li>
                <a href="#method-c-valid_remote_photo_url-3F">valid_remote_photo_url?</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="Shared/LicenseModule.html">
              Shared::LicenseModule
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">LARGE</td>
            <td>=</td>
            <td class="attr-value">1024</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MEDIUM</td>
            <td>=</td>
            <td class="attr-value">500</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MIME_PATTERNS</td>
            <td>=</td>
            <td class="attr-value">[/jpe?g/i, /png/i, /gif/i, /octet-stream/]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SMALL</td>
            <td>=</td>
            <td class="attr-value">240</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SQUARE</td>
            <td>=</td>
            <td class="attr-value">75</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">THUMB</td>
            <td>=</td>
            <td class="attr-value">100</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>api_response</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>orphan</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_large_url</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_medium_url</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_original_url</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_small_url</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_square_url</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>remote_thumb_url</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-default_json_options">
            
              <b>default_json_options</b>()
            
            <a href="../classes/Photo.html#method-c-default_json_options" name="method-c-default_json_options" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-default_json_options_source')" id="l_method-c-default_json_options_source">show</a>
                

                

                
              </p>
              <div id="method-c-default_json_options_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">482</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">default_json_options</span>
<span class="line-num">483</span>   {
<span class="line-num">484</span>     <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:license_code</span>, <span class="ruby-value">:attribution</span>, <span class="ruby-value">:square_url</span>,
<span class="line-num">485</span>       <span class="ruby-value">:thumb_url</span>, <span class="ruby-value">:small_url</span>, <span class="ruby-value">:medium_url</span>, <span class="ruby-value">:large_url</span>],
<span class="line-num">486</span>     <span class="ruby-value">:except</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:file_processing</span>, <span class="ruby-value">:file_file_size</span>,
<span class="line-num">487</span>       <span class="ruby-value">:file_content_type</span>, <span class="ruby-value">:file_file_name</span>, <span class="ruby-value">:mobile</span>, <span class="ruby-value">:metadata</span>, <span class="ruby-value">:user_id</span>,
<span class="line-num">488</span>       <span class="ruby-value">:native_realname</span>, <span class="ruby-value">:native_photo_id</span>]
<span class="line-num">489</span>   }
<span class="line-num">490</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-destroy_orphans">
            
              <b>destroy_orphans</b>(ids)
            
            <a href="../classes/Photo.html#method-c-destroy_orphans" name="method-c-destroy_orphans" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Destroy a photo if it no longer belongs to any observations or taxa</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-destroy_orphans_source')" id="l_method-c-destroy_orphans_source">show</a>
                

                

                
              </p>
              <div id="method-c-destroy_orphans_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">474</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">destroy_orphans</span>(<span class="ruby-identifier">ids</span>)
<span class="line-num">475</span>   <span class="ruby-identifier">photos</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> [ <span class="ruby-identifier">ids</span> ].<span class="ruby-identifier">flatten</span>)
<span class="line-num">476</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">477</span>   <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num">478</span>     <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">orphaned?</span>
<span class="line-num">479</span>   <span class="ruby-keyword">end</span>
<span class="line-num">480</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-get_api_response">
            
              <b>get_api_response</b>(native_photo_id, options = {})
            
            <a href="../classes/Photo.html#method-c-get_api_response" name="method-c-get_api_response" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Retrieve info about a photo from its native source given its native id.</p>

<p>Should be implemented by descendents</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-get_api_response_source')" id="l_method-c-get_api_response_source">show</a>
                

                

                
              </p>
              <div id="method-c-get_api_response_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">463</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">get_api_response</span>(<span class="ruby-identifier">native_photo_id</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">464</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">465</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-local_photo_from_remote_photo">
            
              <b>local_photo_from_remote_photo</b>(remote_photo)
            
            <a href="../classes/Photo.html#method-c-local_photo_from_remote_photo" name="method-c-local_photo_from_remote_photo" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>used in the <a href="ObservationsController.html"><code>ObservationsController</code></a> to create an un-saved <a href="LocalPhoto.html"><code>LocalPhoto</code></a> from an unsaved remote photo and inherit necessary attributes</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-local_photo_from_remote_photo_source')" id="l_method-c-local_photo_from_remote_photo_source">show</a>
                

                

                
              </p>
              <div id="method-c-local_photo_from_remote_photo_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">380</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">local_photo_from_remote_photo</span>(<span class="ruby-identifier">remote_photo</span>)
<span class="line-num">381</span>   <span class="ruby-comment"># inherit native_* and other attributes from remote photos</span>
<span class="line-num">382</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">remote_photo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Photo</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;LocalPhoto&quot;</span>
<span class="line-num">383</span>   <span class="ruby-identifier">remote_photo_attrs</span> = <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">384</span>     <span class="ruby-identifier">k</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^native/</span> <span class="ruby-operator">||</span>
<span class="line-num">385</span>       [ <span class="ruby-string">&quot;user_id&quot;</span>, <span class="ruby-string">&quot;license&quot;</span>, <span class="ruby-string">&quot;mobile&quot;</span>, <span class="ruby-string">&quot;metadata&quot;</span> ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">k</span>)
<span class="line-num">386</span>   <span class="ruby-keyword">end</span>
<span class="line-num">387</span>   <span class="ruby-identifier">photo_url</span> = [ <span class="ruby-value">:original</span>, <span class="ruby-value">:large</span>, <span class="ruby-value">:medium</span>, <span class="ruby-value">:small</span> ].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
<span class="line-num">388</span>     <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">instance_variable_get</span>( <span class="ruby-node">&quot;@remote_#{ s }_url&quot;</span> )
<span class="line-num">389</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">first</span>
<span class="line-num">390</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo_url</span>
<span class="line-num">391</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo_url</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">512</span>
<span class="line-num">392</span>     <span class="ruby-identifier">remote_photo_attrs</span>[<span class="ruby-string">&quot;native_original_image_url&quot;</span>] = <span class="ruby-identifier">photo_url</span>
<span class="line-num">393</span>   <span class="ruby-keyword">end</span>
<span class="line-num">394</span>   <span class="ruby-identifier">remote_photo_attrs</span>[<span class="ruby-string">&quot;subtype&quot;</span>] = <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>
<span class="line-num">395</span>   <span class="ruby-comment"># stub this LocalPhoto&#39;s file with the remote photo URL</span>
<span class="line-num">396</span>   <span class="ruby-identifier">remote_photo_attrs</span>[<span class="ruby-string">&quot;file&quot;</span>] = <span class="ruby-constant">URI</span>(<span class="ruby-identifier">photo_url</span>)
<span class="line-num">397</span>   <span class="ruby-constant">LocalPhoto</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">remote_photo_attrs</span>)
<span class="line-num">398</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-new_from_api_response">
            
              <b>new_from_api_response</b>(api_response, options = {})
            
            <a href="../classes/Photo.html#method-c-new_from_api_response" name="method-c-new_from_api_response" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a new <a href="Photo.html"><code>Photo</code></a> object from an API response.  Should be implemented by  descendents</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-new_from_api_response_source')" id="l_method-c-new_from_api_response_source">show</a>
                

                

                
              </p>
              <div id="method-c-new_from_api_response_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">469</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">new_from_api_response</span>(<span class="ruby-identifier">api_response</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">470</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">471</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-repair_photos_for_user">
            
              <b>repair_photos_for_user</b>(user, type)
            
            <a href="../classes/Photo.html#method-c-repair_photos_for_user" name="method-c-repair_photos_for_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-repair_photos_for_user_source')" id="l_method-c-repair_photos_for_user_source">show</a>
                

                

                
              </p>
              <div id="method-c-repair_photos_for_user_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">331</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">repair_photos_for_user</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">type</span>)
<span class="line-num">332</span>   <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
<span class="line-num">333</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">type:</span> <span class="ruby-identifier">type</span>).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num">334</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">valid_remote_photo_url?</span>(<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">original_url</span>)
<span class="line-num">335</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">valid_remote_photo_url?</span>(<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">large_url</span>)
<span class="line-num">336</span>     <span class="ruby-identifier">p</span>, <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">repair</span>(<span class="ruby-value">no_save:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">337</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">338</span>       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR] Failed to repair #{p}: #{errors.inspect}&quot;</span>
<span class="line-num">339</span>       <span class="ruby-keyword">next</span>
<span class="line-num">340</span>     <span class="ruby-keyword">end</span>
<span class="line-num">341</span>     <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">turn_remote_photo_into_local_photo</span>(<span class="ruby-identifier">p</span>)
<span class="line-num">342</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">343</span>       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR] Failed to save #{p}: #{p.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">344</span>       <span class="ruby-keyword">next</span>
<span class="line-num">345</span>     <span class="ruby-keyword">end</span>
<span class="line-num">346</span>     <span class="ruby-identifier">count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">347</span>   <span class="ruby-keyword">end</span>
<span class="line-num">348</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO] Repaired #{count} #{type}s for #{user}&quot;</span>
<span class="line-num">349</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-repair_single_photo">
            
              <b>repair_single_photo</b>(photo)
            
            <a href="../classes/Photo.html#method-c-repair_single_photo" name="method-c-repair_single_photo" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-repair_single_photo_source')" id="l_method-c-repair_single_photo_source">show</a>
                

                

                
              </p>
              <div id="method-c-repair_single_photo_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">351</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">repair_single_photo</span>(<span class="ruby-identifier">photo</span>)
<span class="line-num">352</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">subtype</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">klass</span> = (<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">subtype</span>.<span class="ruby-identifier">constantize</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>)
<span class="line-num">353</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">klass</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Photo</span>
<span class="line-num">354</span>       <span class="ruby-comment"># we have a photo with a valid Photo subtype (cached remote photo)</span>
<span class="line-num">355</span>       <span class="ruby-identifier">repair_photo</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">type:</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">subtype</span>))
<span class="line-num">356</span>       <span class="ruby-comment"># repair as if it were the remote photo, but don&#39;t save anything</span>
<span class="line-num">357</span>       <span class="ruby-identifier">repaired</span>, <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">repair_photo</span>.<span class="ruby-identifier">repair</span>(<span class="ruby-value">no_save:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">358</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">359</span>         <span class="ruby-keyword">return</span> [ <span class="ruby-identifier">photo</span>, <span class="ruby-identifier">errors</span> ]
<span class="line-num">360</span>       <span class="ruby-keyword">end</span>
<span class="line-num">361</span>       <span class="ruby-comment"># if that succeded, update this photo with the repaired remote URL</span>
<span class="line-num">362</span> 
<span class="line-num">363</span>       <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">file</span> = <span class="ruby-constant">URI</span>( <span class="ruby-identifier">repaired</span>.<span class="ruby-identifier">best_available_url</span> )
<span class="line-num">364</span>       <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span>
<span class="line-num">365</span>       <span class="ruby-keyword">return</span> [ <span class="ruby-identifier">photo</span>, { } ]
<span class="line-num">366</span>     <span class="ruby-keyword">end</span>
<span class="line-num">367</span>   <span class="ruby-keyword">end</span>
<span class="line-num">368</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:repair</span>)
<span class="line-num">369</span>     <span class="ruby-identifier">repaired_photo</span>, <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">repair</span>
<span class="line-num">370</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repaired_photo</span>.<span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">repaired_photo</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">LocalPhoto</span> )
<span class="line-num">371</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">turn_remote_photo_into_local_photo</span>( <span class="ruby-identifier">repaired_photo</span> )
<span class="line-num">372</span>     <span class="ruby-keyword">end</span>
<span class="line-num">373</span>     [<span class="ruby-identifier">repaired_photo</span>, <span class="ruby-identifier">errors</span>]
<span class="line-num">374</span>   <span class="ruby-keyword">end</span>
<span class="line-num">375</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-turn_remote_photo_into_local_photo">
            
              <b>turn_remote_photo_into_local_photo</b>(remote_photo)
            
            <a href="../classes/Photo.html#method-c-turn_remote_photo_into_local_photo" name="method-c-turn_remote_photo_into_local_photo" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>to be used primarly for retroactive caching of remote photos</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-turn_remote_photo_into_local_photo_source')" id="l_method-c-turn_remote_photo_into_local_photo_source">show</a>
                

                

                
              </p>
              <div id="method-c-turn_remote_photo_into_local_photo_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">401</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">turn_remote_photo_into_local_photo</span>(<span class="ruby-identifier">remote_photo</span>)
<span class="line-num">402</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">remote_photo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Photo</span>
<span class="line-num">403</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fetch_url</span> = <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">best_available_url</span>
<span class="line-num">404</span>   <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">type</span> = <span class="ruby-string">&quot;LocalPhoto&quot;</span>
<span class="line-num">405</span>   <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">subtype</span> = <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>
<span class="line-num">406</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">fetch_url</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">512</span>
<span class="line-num">407</span>     <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">native_original_image_url</span> = <span class="ruby-identifier">fetch_url</span>
<span class="line-num">408</span>   <span class="ruby-keyword">end</span>
<span class="line-num">409</span>   <span class="ruby-identifier">remote_photo</span> = <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">becomes</span>(<span class="ruby-constant">LocalPhoto</span>)
<span class="line-num">410</span>   <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">file</span> = <span class="ruby-constant">URI</span>(<span class="ruby-identifier">fetch_url</span>)
<span class="line-num">411</span>   <span class="ruby-identifier">remote_photo</span>.<span class="ruby-identifier">save</span>
<span class="line-num">412</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_photo_native_columns_and_copy_metadata">
            
              <b>update_photo_native_columns_and_copy_metadata</b>( min_id, max_id )
            
            <a href="../classes/Photo.html#method-c-update_photo_native_columns_and_copy_metadata" name="method-c-update_photo_native_columns_and_copy_metadata" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_photo_native_columns_and_copy_metadata_source')" id="l_method-c-update_photo_native_columns_and_copy_metadata_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_photo_native_columns_and_copy_metadata_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">511</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_photo_native_columns_and_copy_metadata</span>( <span class="ruby-identifier">min_id</span>, <span class="ruby-identifier">max_id</span> )
<span class="line-num">512</span>   <span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">513</span>   <span class="ruby-identifier">counter</span> = <span class="ruby-value">0</span>
<span class="line-num">514</span>   <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id &gt; ? AND id &lt;= ?&quot;</span>, <span class="ruby-identifier">min_id</span>, <span class="ruby-identifier">max_id</span> ).<span class="ruby-identifier">find_in_batches</span>( <span class="ruby-value">batch_size:</span> <span class="ruby-value">100</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">515</span>     <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
<span class="line-num">516</span>       <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num">517</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">counter</span> <span class="ruby-operator">%</span> <span class="ruby-value">1000</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">518</span>           <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{counter}, ID: #{photo.id}, Time: #{(Time.now - start_time).round(2)}&quot;</span>
<span class="line-num">519</span>         <span class="ruby-keyword">end</span>
<span class="line-num">520</span>         <span class="ruby-identifier">counter</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">521</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;LocalPhoto&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">subtype</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">522</span>           ( <span class="ruby-operator">!</span><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_photo_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_page_url</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>
<span class="line-num">523</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_username</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_realname</span>.<span class="ruby-identifier">nil?</span> )
<span class="line-num">524</span>           <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">update_columns</span>(
<span class="line-num">525</span>             <span class="ruby-value">native_photo_id:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">526</span>             <span class="ruby-value">native_page_url:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">527</span>             <span class="ruby-value">native_username:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">528</span>             <span class="ruby-value">native_realname:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">529</span>           )
<span class="line-num">530</span>         <span class="ruby-keyword">end</span>
<span class="line-num">531</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">metadata</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">532</span>         <span class="ruby-constant">PhotoMetadata</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">photo_id:</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first_or_create</span>
<span class="line-num">533</span>         <span class="ruby-constant">PhotoMetadata</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">photo_id:</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">metadata:</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">metadata</span> )
<span class="line-num">534</span>       <span class="ruby-keyword">end</span>
<span class="line-num">535</span>     <span class="ruby-keyword">end</span>
<span class="line-num">536</span>   <span class="ruby-keyword">end</span>
<span class="line-num">537</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-valid_remote_photo_url">
            
              <b>valid_remote_photo_url</b>( remote_photo_url, options = {} )
            
            <a href="../classes/Photo.html#method-c-valid_remote_photo_url" name="method-c-valid_remote_photo_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Like <a href="Photo.html#method-c-valid_remote_photo_url"><code>valid_remote_photo_url</code></a>? this sends a HEAD request to see if an image is still there, but it returns the URL if it is and will follow redirects up to 5 times and return a valid URL if it finds one.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-valid_remote_photo_url_source')" id="l_method-c-valid_remote_photo_url_source">show</a>
                

                

                
              </p>
              <div id="method-c-valid_remote_photo_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">437</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">valid_remote_photo_url</span>( <span class="ruby-identifier">remote_photo_url</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">438</span>   <span class="ruby-identifier">depth</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:depth</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">439</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">depth</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>
<span class="line-num">440</span>   <span class="ruby-comment"># Flickr&#39;s unavailable photo URL. When served from yimg they don&#39;t always</span>
<span class="line-num">441</span>   <span class="ruby-comment"># return a 404 status, so just checking the URL here.</span>
<span class="line-num">442</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">remote_photo_url</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/photo_unavailable\.png/</span>
<span class="line-num">443</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">444</span>   <span class="ruby-keyword">end</span>
<span class="line-num">445</span>   <span class="ruby-identifier">head</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">446</span>     <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>( <span class="ruby-value">5</span> ) { <span class="ruby-identifier">fetch_head</span>( <span class="ruby-identifier">remote_photo_url</span> ) }
<span class="line-num">447</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
<span class="line-num">448</span>     <span class="ruby-keyword">false</span>
<span class="line-num">449</span>   <span class="ruby-keyword">end</span>
<span class="line-num">450</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">head</span>
<span class="line-num">451</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">head</span>.<span class="ruby-identifier">to_hash</span>
<span class="line-num">452</span>   <span class="ruby-keyword">if</span> <span class="ruby-node">%w(301 302 303 307 308)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">head</span>.<span class="ruby-identifier">code</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;location&quot;</span>]
<span class="line-num">453</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">valid_remote_photo_url</span>( <span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;location&quot;</span>][<span class="ruby-value">0</span>], <span class="ruby-value">depth:</span> <span class="ruby-identifier">depth</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> )
<span class="line-num">454</span>   <span class="ruby-keyword">end</span>
<span class="line-num">455</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">code</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;200&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;content-type&quot;</span>].<span class="ruby-identifier">any?</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-constant">MIME_PATTERNS</span>.<span class="ruby-identifier">any?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">mime_pattern</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">mime_pattern</span> } }
<span class="line-num">456</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">remote_photo_url</span>
<span class="line-num">457</span>   <span class="ruby-keyword">end</span>
<span class="line-num">458</span>   <span class="ruby-keyword">false</span>
<span class="line-num">459</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-valid_remote_photo_url-3F">
            
              <b>valid_remote_photo_url?</b>(remote_photo_url)
            
            <a href="../classes/Photo.html#method-c-valid_remote_photo_url-3F" name="method-c-valid_remote_photo_url-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-valid_remote_photo_url-3F_source')" id="l_method-c-valid_remote_photo_url-3F_source">show</a>
                

                

                
              </p>
              <div id="method-c-valid_remote_photo_url-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">425</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">valid_remote_photo_url?</span>(<span class="ruby-identifier">remote_photo_url</span>)
<span class="line-num">426</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span> = <span class="ruby-identifier">fetch_head</span>(<span class="ruby-identifier">remote_photo_url</span>)
<span class="line-num">427</span>     <span class="ruby-comment"># image must return 200 and have a valid image mime-type</span>
<span class="line-num">428</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">code</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;200&quot;</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">429</span>       <span class="ruby-identifier">head</span>.<span class="ruby-identifier">to_hash</span>[<span class="ruby-string">&quot;content-type&quot;</span>].<span class="ruby-identifier">any?</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-constant">MIME_PATTERNS</span>.<span class="ruby-identifier">any?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">mime_pattern</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">mime_pattern</span> } }
<span class="line-num">430</span>   <span class="ruby-keyword">end</span>
<span class="line-num">431</span>   <span class="ruby-keyword">false</span>
<span class="line-num">432</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-as_indexed_json">
            
              <b>as_indexed_json</b>( options={ } )
            
            <a href="../classes/Photo.html#method-i-as_indexed_json" name="method-i-as_indexed_json" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-as_indexed_json_source')" id="l_method-i-as_indexed_json_source">show</a>
                

                

                
              </p>
              <div id="method-i-as_indexed_json_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">492</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">as_indexed_json</span>( <span class="ruby-identifier">options</span>={ } )
<span class="line-num">493</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">494</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">495</span>     <span class="ruby-value">license_code:</span> <span class="ruby-identifier">index_license_code</span>,
<span class="line-num">496</span>     <span class="ruby-value">attribution:</span> <span class="ruby-identifier">attribution</span>,
<span class="line-num">497</span>     <span class="ruby-value">url:</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">LocalPhoto</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">processing?</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>(<span class="ruby-value">:square</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">square_url</span>,
<span class="line-num">498</span>     <span class="ruby-value">original_dimensions:</span> <span class="ruby-identifier">original_dimensions</span>,
<span class="line-num">499</span>     <span class="ruby-value">flags:</span> <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>)
<span class="line-num">500</span>   }
<span class="line-num">501</span>   <span class="ruby-identifier">json</span>[<span class="ruby-value">:native_page_url</span>] = <span class="ruby-identifier">native_page_url</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:native_page_url</span>]
<span class="line-num">502</span>   <span class="ruby-identifier">json</span>[<span class="ruby-value">:native_photo_id</span>] = <span class="ruby-identifier">native_photo_id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:native_photo_id</span>]
<span class="line-num">503</span>   <span class="ruby-identifier">json</span>[<span class="ruby-value">:type</span>] = <span class="ruby-identifier">type</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:type</span>]
<span class="line-num">504</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:sizes</span>] <span class="ruby-operator">||=</span> [ ]
<span class="line-num">505</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:sizes</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">size</span><span class="ruby-operator">|</span>
<span class="line-num">506</span>     <span class="ruby-identifier">json</span>[<span class="ruby-node">&quot;#{ size }_url&quot;</span>] = <span class="ruby-identifier">best_url</span>(<span class="ruby-identifier">size</span>)
<span class="line-num">507</span>   <span class="ruby-keyword">end</span>
<span class="line-num">508</span>   <span class="ruby-identifier">json</span>
<span class="line-num">509</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-best_available_url">
            
              <b>best_available_url</b>()
            
            <a href="../classes/Photo.html#method-i-best_available_url" name="method-i-best_available_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>to be used primarly for <a href="Photo.html#method-c-turn_remote_photo_into_local_photo"><code>turn_remote_photo_into_local_photo</code></a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-best_available_url_source')" id="l_method-i-best_available_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-best_available_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">415</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">best_available_url</span>
<span class="line-num">416</span>   [ <span class="ruby-value">:original</span>, <span class="ruby-value">:large</span>, <span class="ruby-value">:medium</span>, <span class="ruby-value">:small</span> ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
<span class="line-num">417</span>     <span class="ruby-identifier">url</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-node">&quot;@remote_#{s}_url&quot;</span>)
<span class="line-num">418</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">url</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">valid_remote_photo_url?</span>(<span class="ruby-identifier">url</span>)
<span class="line-num">419</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">url</span>
<span class="line-num">420</span>     <span class="ruby-keyword">end</span>
<span class="line-num">421</span>   <span class="ruby-keyword">end</span>
<span class="line-num">422</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">423</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-best_url">
            
              <b>best_url</b>(size = &quot;medium&quot;)
            
            <a href="../classes/Photo.html#method-i-best_url" name="method-i-best_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-best_url_source')" id="l_method-i-best_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-best_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">264</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">best_url</span>(<span class="ruby-identifier">size</span> = <span class="ruby-string">&quot;medium&quot;</span>)
<span class="line-num">265</span>   <span class="ruby-identifier">size</span> = <span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">266</span>   <span class="ruby-identifier">sizes</span> = <span class="ruby-node">%w(original large medium small thumb square)</span>
<span class="line-num">267</span>   <span class="ruby-identifier">size</span> = <span class="ruby-string">&quot;medium&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sizes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">size</span>)
<span class="line-num">268</span>   <span class="ruby-identifier">size_index</span> = <span class="ruby-identifier">sizes</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">size</span>)
<span class="line-num">269</span>   <span class="ruby-identifier">methods</span> = <span class="ruby-identifier">sizes</span>[<span class="ruby-identifier">size_index</span>.<span class="ruby-identifier">to_i</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{s}_url&quot;</span>} <span class="ruby-operator">+</span> [<span class="ruby-string">&#39;original&#39;</span>]
<span class="line-num">270</span>   <span class="ruby-identifier">try_methods</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">methods</span>)
<span class="line-num">271</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-editable_by-3F">
            
              <b>editable_by?</b>(user)
            
            <a href="../classes/Photo.html#method-i-editable_by-3F" name="method-i-editable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-editable_by-3F_source')" id="l_method-i-editable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-editable_by-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">232</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">editable_by?</span>(<span class="ruby-identifier">user</span>)
<span class="line-num">233</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">234</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">235</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flagged_with">
            
              <b>flagged_with</b>(flag, options = {})
            
            <a href="../classes/Photo.html#method-i-flagged_with" name="method-i-flagged_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flagged_with_source')" id="l_method-i-flagged_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-flagged_with_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">295</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flagged_with</span>(<span class="ruby-identifier">flag</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">296</span>   <span class="ruby-identifier">flag_is_copyright</span> = <span class="ruby-identifier">flag</span>.<span class="ruby-identifier">flag</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT_INFRINGEMENT</span>
<span class="line-num">297</span>   <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">298</span>   <span class="ruby-identifier">other_unresolved_copyright_flags_exist</span> = <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
<span class="line-num">299</span>     <span class="ruby-identifier">f</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">flag</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">flag</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT_INFRINGEMENT</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">resolved?</span>
<span class="line-num">300</span>   <span class="ruby-keyword">end</span>
<span class="line-num">301</span>   <span class="ruby-comment"># flagged photos should move to the public bucket, so make sure they end up in the right place</span>
<span class="line-num">302</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">LocalPhoto</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>[<span class="ruby-string">&quot;original_url&quot;</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/copyright/</span>
<span class="line-num">303</span>     <span class="ruby-identifier">change_photo_bucket_if_needed</span>
<span class="line-num">304</span>   <span class="ruby-keyword">end</span>
<span class="line-num">305</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">flag_is_copyright</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">other_unresolved_copyright_flags_exist</span>
<span class="line-num">306</span>     <span class="ruby-comment"># For copyright flags reset the URLs if they still point to a copyright placeholder</span>
<span class="line-num">307</span>     <span class="ruby-keyword">if</span> <span class="ruby-node">%w(resolved destroyed)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:action</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>[<span class="ruby-string">&quot;original_url&quot;</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/copyright/</span>
<span class="line-num">308</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">repair_single_photo</span>(<span class="ruby-keyword">self</span>)
<span class="line-num">309</span>     <span class="ruby-keyword">end</span>
<span class="line-num">310</span>     <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:update_stats</span>)
<span class="line-num">311</span>   <span class="ruby-keyword">end</span>
<span class="line-num">312</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">313</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">update_mappable</span>
<span class="line-num">314</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">set_quality_grade</span>( <span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">315</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">316</span>   <span class="ruby-keyword">end</span>
<span class="line-num">317</span>   <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">each</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:elastic_index!</span> )
<span class="line-num">318</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index_observations">
            
              <b>index_observations</b>()
            
            <a href="../classes/Photo.html#method-i-index_observations" name="method-i-index_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_observations_source')" id="l_method-i-index_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">223</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index_observations</span>
<span class="line-num">224</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-identifier">observations</span> )
<span class="line-num">225</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index_taxa">
            
              <b>index_taxa</b>()
            
            <a href="../classes/Photo.html#method-i-index_taxa" name="method-i-index_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_taxa_source')" id="l_method-i-index_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_taxa_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">227</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index_taxa</span>
<span class="line-num">228</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">229</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">unique_hash:</span> { <span class="ruby-string">&quot;Photo::index_taxa&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">id</span> } ).<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">taxon_ids</span> )
<span class="line-num">230</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-large_url">
            
              <b>large_url</b>()
            
            <a href="../classes/Photo.html#method-i-large_url" name="method-i-large_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-large_url_source')" id="l_method-i-large_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-large_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">70</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">large_url</span>
<span class="line-num">71</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:large</span> )
<span class="line-num">72</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-licensed_if_no_user">
            
              <b>licensed_if_no_user</b>()
            
            <a href="../classes/Photo.html#method-i-licensed_if_no_user" name="method-i-licensed_if_no_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-licensed_if_no_user_source')" id="l_method-i-licensed_if_no_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-licensed_if_no_user_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">115</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">licensed_if_no_user</span>
<span class="line-num">116</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">license</span> <span class="ruby-operator">==</span> <span class="ruby-constant">COPYRIGHT</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">blank?</span>)
<span class="line-num">117</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(
<span class="line-num">118</span>       <span class="ruby-value">:license</span>, 
<span class="line-num">119</span>       <span class="ruby-string">&quot;must be set if the photo wasn&#39;t added by a local user.&quot;</span>)
<span class="line-num">120</span>   <span class="ruby-keyword">end</span>
<span class="line-num">121</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-medium_url">
            
              <b>medium_url</b>()
            
            <a href="../classes/Photo.html#method-i-medium_url" name="method-i-medium_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-medium_url_source')" id="l_method-i-medium_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-medium_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">74</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">medium_url</span>
<span class="line-num">75</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:medium</span> )
<span class="line-num">76</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-metadata">
            
              <b>metadata</b>()
            
            <a href="../classes/Photo.html#method-i-metadata" name="method-i-metadata" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-metadata_source')" id="l_method-i-metadata_source">show</a>
                

                

                
              </p>
              <div id="method-i-metadata_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">327</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">metadata</span>
<span class="line-num">328</span>   <span class="ruby-identifier">photo_metadata</span>&amp;.<span class="ruby-identifier">metadata</span>
<span class="line-num">329</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-original_dimensions">
            
              <b>original_dimensions</b>()
            
            <a href="../classes/Photo.html#method-i-original_dimensions" name="method-i-original_dimensions" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-original_dimensions_source')" id="l_method-i-original_dimensions_source">show</a>
                

                

                
              </p>
              <div id="method-i-original_dimensions_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">320</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">original_dimensions</span>
<span class="line-num">321</span>   {
<span class="line-num">322</span>     <span class="ruby-value">height:</span> <span class="ruby-identifier">height</span>,
<span class="line-num">323</span>     <span class="ruby-value">width:</span> <span class="ruby-identifier">width</span>
<span class="line-num">324</span>   }
<span class="line-num">325</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-original_url">
            
              <b>original_url</b>()
            
            <a href="../classes/Photo.html#method-i-original_url" name="method-i-original_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-original_url_source')" id="l_method-i-original_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-original_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">66</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">original_url</span>
<span class="line-num">67</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:original</span> )
<span class="line-num">68</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-orphaned-3F">
            
              <b>orphaned?</b>()
            
            <a href="../classes/Photo.html#method-i-orphaned-3F" name="method-i-orphaned-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-orphaned-3F_source')" id="l_method-i-orphaned-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-orphaned-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">237</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">orphaned?</span>
<span class="line-num">238</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">239</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">240</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">guide_photos</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">guide_photos</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">guide_photos</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">241</span>   <span class="ruby-keyword">true</span>
<span class="line-num">242</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-parse_extension">
            
              <b>parse_extension</b>()
            
            <a href="../classes/Photo.html#method-i-parse_extension" name="method-i-parse_extension" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-parse_extension_source')" id="l_method-i-parse_extension_source">show</a>
                

                

                
              </p>
              <div id="method-i-parse_extension_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">47</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parse_extension</span>
<span class="line-num">48</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:original</span> )
<span class="line-num">49</span> 
<span class="line-num">50</span>   <span class="ruby-identifier">ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>( <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:original</span> ) ).<span class="ruby-identifier">path</span> ).<span class="ruby-identifier">sub</span>( <span class="ruby-string">&quot;.&quot;</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">51</span>   <span class="ruby-identifier">ext</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ext</span>
<span class="line-num">52</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-parse_url_prefix">
            
              <b>parse_url_prefix</b>()
            
            <a href="../classes/Photo.html#method-i-parse_url_prefix" name="method-i-parse_url_prefix" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-parse_url_prefix_source')" id="l_method-i-parse_url_prefix_source">show</a>
                

                

                
              </p>
              <div id="method-i-parse_url_prefix_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">54</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parse_url_prefix</span>
<span class="line-num">55</span>   <span class="ruby-identifier">original</span> =  <span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:original</span> )
<span class="line-num">56</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">original</span>
<span class="line-num">57</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">original</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp">/http/</span>
<span class="line-num">58</span>     <span class="ruby-identifier">original</span> = <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">uri_join</span>( <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">root_url</span>, <span class="ruby-identifier">original</span> ).<span class="ruby-identifier">to_s</span>
<span class="line-num">59</span>   <span class="ruby-keyword">end</span>
<span class="line-num">60</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">original</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^(.*)\/#{id}\/original/</span> )
<span class="line-num">61</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">1</span>]
<span class="line-num">62</span>   <span class="ruby-keyword">end</span>
<span class="line-num">63</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">64</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-processing-3F">
            
              <b>processing?</b>()
            
            <a href="../classes/Photo.html#method-i-processing-3F" name="method-i-processing-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-processing-3F_source')" id="l_method-i-processing-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-processing-3F_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">90</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">processing?</span>
<span class="line-num">91</span>   <span class="ruby-identifier">file_prefix</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">92</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-serializable_hash">
            
              <b>serializable_hash</b>( opts = nil )
            
            <a href="../classes/Photo.html#method-i-serializable_hash" name="method-i-serializable_hash" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-serializable_hash_source')" id="l_method-i-serializable_hash_source">show</a>
                

                

                
              </p>
              <div id="method-i-serializable_hash_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">273</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">serializable_hash</span>( <span class="ruby-identifier">opts</span> = <span class="ruby-keyword">nil</span> )
<span class="line-num">274</span>   <span class="ruby-identifier">options</span> = <span class="ruby-identifier">opts</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">clone</span> <span class="ruby-operator">:</span> { }
<span class="line-num">275</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">276</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:metadata</span>, <span class="ruby-value">:file_content_type</span>, <span class="ruby-value">:file_file_name</span>,
<span class="line-num">277</span>     <span class="ruby-value">:file_file_size</span>, <span class="ruby-value">:file_processing</span>, <span class="ruby-value">:file_updated_at</span>, <span class="ruby-value">:mobile</span>,
<span class="line-num">278</span>     <span class="ruby-value">:original_url</span>]
<span class="line-num">279</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">280</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [
<span class="line-num">281</span>     <span class="ruby-value">:license_code</span>,
<span class="line-num">282</span>     <span class="ruby-value">:license_name</span>,
<span class="line-num">283</span>     <span class="ruby-value">:license_url</span>,
<span class="line-num">284</span>     <span class="ruby-value">:attribution</span>,
<span class="line-num">285</span>     <span class="ruby-value">:type</span>,
<span class="line-num">286</span>     <span class="ruby-value">:square_url</span>,
<span class="line-num">287</span>     <span class="ruby-value">:thumb_url</span>,
<span class="line-num">288</span>     <span class="ruby-value">:small_url</span>,
<span class="line-num">289</span>     <span class="ruby-value">:medium_url</span>,
<span class="line-num">290</span>     <span class="ruby-value">:large_url</span>
<span class="line-num">291</span>   ]
<span class="line-num">292</span>   <span class="ruby-keyword">super</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">293</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_license">
            
              <b>set_license</b>()
            
            <a href="../classes/Photo.html#method-i-set_license" name="method-i-set_license" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_license_source')" id="l_method-i-set_license_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_license_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">123</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_license</span>
<span class="line-num">124</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">125</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">126</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">127</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">license</span> = <span class="ruby-constant">Shared</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseModule</span>.<span class="ruby-identifier">license_number_for_code</span>(<span class="ruby-identifier">user</span>.<span class="ruby-identifier">preferred_photo_license</span>)
<span class="line-num">128</span>   <span class="ruby-keyword">end</span>
<span class="line-num">129</span>   <span class="ruby-keyword">true</span>
<span class="line-num">130</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_uuid">
            
              <b>set_uuid</b>()
            
            <a href="../classes/Photo.html#method-i-set_uuid" name="method-i-set_uuid" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_uuid_source')" id="l_method-i-set_uuid_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_uuid_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">25</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_uuid</span>
<span class="line-num">26</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">uuid</span>
<span class="line-num">27</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> = <span class="ruby-identifier">uuid</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">28</span>   <span class="ruby-keyword">true</span>
<span class="line-num">29</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sized_url">
            
              <b>sized_url</b>( size = &quot;original&quot; )
            
            <a href="../classes/Photo.html#method-i-sized_url" name="method-i-sized_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sized_url_source')" id="l_method-i-sized_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-sized_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num"> 94</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sized_url</span>( <span class="ruby-identifier">size</span> = <span class="ruby-string">&quot;original&quot;</span> )
<span class="line-num"> 95</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">any?</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">flag</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT_INFRINGEMENT</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">resolved?</span> }
<span class="line-num"> 96</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-node">&quot;copyright-infringement-#{size}.png&quot;</span> )
<span class="line-num"> 97</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 98</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-node">&quot;@remote_#{size}_url&quot;</span>)
<span class="line-num"> 99</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-node">&quot;@remote_#{size}_url&quot;</span>)
<span class="line-num">100</span>   <span class="ruby-keyword">end</span>
<span class="line-num">101</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">processing?</span>
<span class="line-num">102</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">uri_join</span>( <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">root_url</span>, <span class="ruby-constant">LocalPhoto</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>( <span class="ruby-identifier">size</span> ) )
<span class="line-num">103</span>   <span class="ruby-keyword">end</span>
<span class="line-num">104</span>   <span class="ruby-node">&quot;#{file_prefix.prefix}/#{id}/#{size}.#{file_extension.extension}&quot;</span>
<span class="line-num">105</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-small_url">
            
              <b>small_url</b>()
            
            <a href="../classes/Photo.html#method-i-small_url" name="method-i-small_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-small_url_source')" id="l_method-i-small_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-small_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">78</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">small_url</span>
<span class="line-num">79</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:small</span> )
<span class="line-num">80</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-source_title">
            
              <b>source_title</b>()
            
            <a href="../classes/Photo.html#method-i-source_title" name="method-i-source_title" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-source_title_source')" id="l_method-i-source_title_source">show</a>
                

                

                
              </p>
              <div id="method-i-source_title_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">244</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">source_title</span>
<span class="line-num">245</span>   <span class="ruby-identifier">t</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">subtype</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;PicasaPhoto&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">PicasaPhoto</span> )
<span class="line-num">246</span>     <span class="ruby-string">&quot;Google&quot;</span>
<span class="line-num">247</span>   <span class="ruby-keyword">end</span>
<span class="line-num">248</span>   <span class="ruby-identifier">t</span> <span class="ruby-operator">||=</span> ( <span class="ruby-identifier">subtype</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">type</span> ).<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/Photo$/</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">humanize</span>.<span class="ruby-identifier">titleize</span>
<span class="line-num">249</span>   <span class="ruby-identifier">t</span>
<span class="line-num">250</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-source_url">
            
              <b>source_url</b>()
            
            <a href="../classes/Photo.html#method-i-source_url" name="method-i-source_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-source_url_source')" id="l_method-i-source_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-source_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">252</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">source_url</span>
<span class="line-num">253</span>   <span class="ruby-comment"># If it used to be an EOL photo and its native photo ID isn&#39;t an integer,</span>
<span class="line-num">254</span>   <span class="ruby-comment"># it&#39;s probably an EOL v2 data object identifier that EOL has lost track of</span>
<span class="line-num">255</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">subtype</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;EolPhoto&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">native_photo_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">native_photo_id</span>.<span class="ruby-identifier">index</span>( <span class="ruby-regexp">/[A-z]/</span> ).<span class="ruby-identifier">nil?</span>
<span class="line-num">256</span>     <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;https://eol.org/media/#{native_photo_id}&quot;</span>
<span class="line-num">257</span>   <span class="ruby-keyword">end</span>
<span class="line-num">258</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">native_page_url</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/#{source_title}/i</span>
<span class="line-num">259</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">native_page_url</span>
<span class="line-num">260</span>   <span class="ruby-keyword">end</span>
<span class="line-num">261</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">262</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-square_url">
            
              <b>square_url</b>()
            
            <a href="../classes/Photo.html#method-i-square_url" name="method-i-square_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-square_url_source')" id="l_method-i-square_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-square_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">82</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">square_url</span>
<span class="line-num">83</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:square</span> )
<span class="line-num">84</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sync">
            
              <b>sync</b>()
            
            <a href="../classes/Photo.html#method-i-sync" name="method-i-sync" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Sync photo object with its native source.  Implemented by descendents</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sync_source')" id="l_method-i-sync_source">show</a>
                

                

                
              </p>
              <div id="method-i-sync_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">194</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sync</span>
<span class="line-num">195</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">196</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-thumb_url">
            
              <b>thumb_url</b>()
            
            <a href="../classes/Photo.html#method-i-thumb_url" name="method-i-thumb_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-thumb_url_source')" id="l_method-i-thumb_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-thumb_url_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">86</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">thumb_url</span>
<span class="line-num">87</span>   <span class="ruby-identifier">sized_url</span>( <span class="ruby-value">:thumb</span> )
<span class="line-num">88</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_plain_s">
            
              <b>to_plain_s</b>()
            
            <a href="../classes/Photo.html#method-i-to_plain_s" name="method-i-to_plain_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_plain_s_source')" id="l_method-i-to_plain_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_plain_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">111</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_plain_s</span>
<span class="line-num">112</span>   <span class="ruby-node">&quot;#{type.underscore.humanize} #{id} by #{attribution}&quot;</span>
<span class="line-num">113</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../classes/Photo.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">107</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">108</span>   <span class="ruby-node">&quot;&lt;#{self.class} id: #{id}, user_id: #{user_id}&gt;&quot;</span>
<span class="line-num">109</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_taxon">
            
              <b>to_taxon</b>()
            
            <a href="../classes/Photo.html#method-i-to_taxon" name="method-i-to_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Try to choose a single taxon for this photo.  Only works if class has  implemented to_taxa</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_taxon_source')" id="l_method-i-to_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">141</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_taxon</span>
<span class="line-num">142</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_taxa</span>)
<span class="line-num">143</span>   <span class="ruby-identifier">photo_taxa</span> = <span class="ruby-identifier">to_taxa</span>(<span class="ruby-value">:lexicon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">SCIENTIFIC_NAMES</span>, <span class="ruby-value">:valid</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:active</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">144</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">145</span>     <span class="ruby-identifier">photo_taxa</span> = <span class="ruby-identifier">to_taxa</span>(<span class="ruby-value">:lexicon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">SCIENTIFIC_NAMES</span>)
<span class="line-num">146</span>   <span class="ruby-keyword">end</span>
<span class="line-num">147</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">148</span>     <span class="ruby-identifier">photo_taxa</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">lexicon</span> = <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">language_for_locale</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> ) )
<span class="line-num">149</span>       <span class="ruby-identifier">to_taxa</span>( <span class="ruby-value">lexicon:</span> <span class="ruby-identifier">lexicon</span> )
<span class="line-num">150</span>     <span class="ruby-keyword">else</span>
<span class="line-num">151</span>       <span class="ruby-identifier">to_taxa</span>
<span class="line-num">152</span>     <span class="ruby-keyword">end</span>
<span class="line-num">153</span>   <span class="ruby-keyword">end</span>
<span class="line-num">154</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">155</span>   <span class="ruby-comment"># If there are synonyms on the same branch, only keep the coarsest one</span>
<span class="line-num">156</span>   <span class="ruby-comment"># (e.g. if a genus and subgenus have the same name, throw out the</span>
<span class="line-num">157</span>   <span class="ruby-comment"># subgenus)</span>
<span class="line-num">158</span>   <span class="ruby-identifier">photo_taxa</span> = <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">name_taxa</span> <span class="ruby-operator">|</span>
<span class="line-num">159</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">name_taxa</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">160</span>       <span class="ruby-identifier">sorted_taxa</span> = <span class="ruby-identifier">name_taxa</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_i</span> }
<span class="line-num">161</span>       <span class="ruby-identifier">keepers</span> = []
<span class="line-num">162</span>       <span class="ruby-keyword">while</span> <span class="ruby-identifier">sorted_taxa</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">163</span>         <span class="ruby-identifier">t</span> = <span class="ruby-identifier">sorted_taxa</span>.<span class="ruby-identifier">shift</span>
<span class="line-num">164</span>         <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sorted_taxa</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">st</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">st</span>.<span class="ruby-identifier">id</span> ) }
<span class="line-num">165</span>           <span class="ruby-identifier">keepers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
<span class="line-num">166</span>         <span class="ruby-keyword">end</span>
<span class="line-num">167</span>       <span class="ruby-keyword">end</span>
<span class="line-num">168</span>       <span class="ruby-identifier">keepers</span>
<span class="line-num">169</span>     <span class="ruby-keyword">else</span>
<span class="line-num">170</span>       <span class="ruby-identifier">name_taxa</span>
<span class="line-num">171</span>     <span class="ruby-keyword">end</span>
<span class="line-num">172</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>
<span class="line-num">173</span>   <span class="ruby-identifier">photo_taxa</span> = <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ROOT_LEVEL</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>}
<span class="line-num">174</span>   <span class="ruby-identifier">candidate</span> = <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">detect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:species_or_lower?</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">first</span>
<span class="line-num">175</span>   <span class="ruby-comment"># if there are synonyms, don&#39;t decide</span>
<span class="line-num">176</span>   <span class="ruby-identifier">synonym</span> = <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">id</span>}
<span class="line-num">177</span>   <span class="ruby-identifier">synonym</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">photo_taxa</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">178</span>     <span class="ruby-identifier">t_common_names</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span>
<span class="line-num">179</span>       <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">lexicon</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">SCIENTIFIC_NAMES</span>}.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">180</span>     }
<span class="line-num">181</span>     <span class="ruby-identifier">c_common_names</span> = <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span>
<span class="line-num">182</span>       <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">lexicon</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">SCIENTIFIC_NAMES</span>}.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">183</span>     }
<span class="line-num">184</span>     <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">t_common_names</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">c_common_names</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">185</span>   <span class="ruby-keyword">end</span>
<span class="line-num">186</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">synonym</span>
<span class="line-num">187</span>     <span class="ruby-keyword">nil</span>
<span class="line-num">188</span>   <span class="ruby-keyword">else</span>
<span class="line-num">189</span>     <span class="ruby-identifier">candidate</span>
<span class="line-num">190</span>   <span class="ruby-keyword">end</span>
<span class="line-num">191</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-trim_fields">
            
              <b>trim_fields</b>()
            
            <a href="../classes/Photo.html#method-i-trim_fields" name="method-i-trim_fields" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-trim_fields_source')" id="l_method-i-trim_fields_source">show</a>
                

                

                
              </p>
              <div id="method-i-trim_fields_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">132</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">trim_fields</span>
<span class="line-num">133</span>   <span class="ruby-node">%w(native_realname native_username)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num">134</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{c}=&quot;</span>, <span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">c</span>).<span class="ruby-identifier">to_s</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">254</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">c</span>)
<span class="line-num">135</span>   <span class="ruby-keyword">end</span>
<span class="line-num">136</span>   <span class="ruby-keyword">true</span>
<span class="line-num">137</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>(attributes)
            
            <a href="../classes/Photo.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">198</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>(<span class="ruby-identifier">attributes</span>)
<span class="line-num">199</span>   <span class="ruby-constant">MASS_ASSIGNABLE_ATTRIBUTES</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">200</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{a}=&quot;</span>, <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_s</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_s</span>)
<span class="line-num">201</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{a}=&quot;</span>, <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">a</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">a</span>)
<span class="line-num">202</span>   <span class="ruby-keyword">end</span>
<span class="line-num">203</span>   <span class="ruby-keyword">super</span>(<span class="ruby-identifier">attributes</span>)
<span class="line-num">204</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_all_licenses">
            
              <b>update_all_licenses</b>()
            
            <a href="../classes/Photo.html#method-i-update_all_licenses" name="method-i-update_all_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_all_licenses_source')" id="l_method-i-update_all_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_all_licenses_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">212</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_all_licenses</span>
<span class="line-num">213</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;true&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@make_licenses_same</span>)
<span class="line-num">214</span>   <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">license:</span> <span class="ruby-identifier">license</span> )
<span class="line-num">215</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">216</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;photos&quot;</span>,
<span class="line-num">217</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::enqueue_photo_bucket_moving_jobs&quot;:</span> <span class="ruby-identifier">user_id</span> }
<span class="line-num">218</span>   ).<span class="ruby-identifier">enqueue_photo_bucket_moving_jobs</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">219</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">index_observations_later</span>
<span class="line-num">220</span>   <span class="ruby-keyword">true</span>
<span class="line-num">221</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_default_license">
            
              <b>update_default_license</b>()
            
            <a href="../classes/Photo.html#method-i-update_default_license" name="method-i-update_default_license" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_default_license_source')" id="l_method-i-update_default_license_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_default_license_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/photo.rb</span>
<span class="line-num">206</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_default_license</span>
<span class="line-num">207</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;true&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@make_license_default</span>)
<span class="line-num">208</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:preferred_photo_license</span>, <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">license_code_for_number</span>(<span class="ruby-identifier">license</span>))
<span class="line-num">209</span>   <span class="ruby-keyword">true</span>
<span class="line-num">210</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
