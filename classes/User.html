<!DOCTYPE html>
<html lang="en">
<head>
    <title>User</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["User"]'>


    <meta property="og:title" value="User">

  

    <meta name="keywords" content="User class, as_indexed_json, set_uuid, followees, followers, validate_email_pattern, validate_email_domain_exists, email_required?, icon_url_provided?, user_icon_url, medium_user_icon_url, original_user_icon_url, active?, child_without_permission?, active_for_authentication?, download_remote_icon, strip_name, strip_login, allow_some_licenses, add_provider_auth, has_provider_auth, login=, email=, has_role?, recent_observations, friends_observations, is_curator?, is_app_owner?, is_admin?, admin?, is_site_admin_of?, to_s, friends_with?, trusts?, picasa_client, facebook_api, facebook_identity, facebook_token, picasa_identity, twitter_identity, api_token, orcid, update_observation_licenses, update_photo_licenses, update_sound_licenses, update_observation_sites_later, update_observation_sites, index_observations_later, index_observations, merge, merge_cleanup, set_locale, set_time_zone, set_uri, get_lat_lon_from_ip, email_suppressed_in_group?, get_lat_lon_from_ip_if_last_ip_changed, check_suspended_by_user, published_name, query, find_for_authentication, authenticate, create_from_omniauth, suggest_login, sane_destroy, forget, remove_icon_from_s3, create_deleted_user, remove_oauth_access_tokens, destroy_project_rules, reindex_faved_observations_after_destroy, reindex_faved_observations_after_destroy_later, generate_csv, destroy_messages_by_suspended_user, revoke_access_tokens_by_suspended_user, restore_access_tokens_by_suspended_user, set_observations_taxa_if_pref_changed, recent_notifications, blocked_by?, default_json_options, active_ids, header_cache_key_for, update_identifications_counter_cache, update_observations_counter_cache, update_species_counter_cache, to_plain_s, subscribed_to?, recent_observation_fields, test_groups_array, in_test_group?, flagged_with, moderated_with, personal_lists, privileged_with?, remove_email_from_name, remove_email_from_string, set_pi_consent_at, set_data_transfer_consent_at, donor?, display_donor_since, taxa_unobserved_before_date, header_projects, enqueue_photo_bucket_moving_jobs, check_recent_probable_spammers, ip_address_is_often_suspended">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            User
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/es_indices/user_index_rb.html">app/es_indices/user_index.rb</a></li>
            
            <li><a href="../files/app/models/observation_rb.html">app/models/observation.rb</a></li>
            
            <li><a href="../files/app/models/observation_field_value_rb.html">app/models/observation_field_value.rb</a></li>
            
            <li><a href="../files/app/models/project_rb.html">app/models/project.rb</a></li>
            
            <li><a href="../files/app/models/project_observation_rb.html">app/models/project_observation.rb</a></li>
            
            <li><a href="../files/app/models/user_rb.html">app/models/user.rb</a></li>
            
            <li><a href="../files/lib/darwin_core/archive_rb.html">lib/darwin_core/archive.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-active-3F">active?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-active_for_authentication-3F">active_for_authentication?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-active_ids">active_ids</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_provider_auth">add_provider_auth</a>,
              </li>
            
              
              <li>
                <a href="#method-i-admin-3F">admin?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-allow_some_licenses">allow_some_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-i-api_token">api_token</a>,
              </li>
            
              
              <li>
                <a href="#method-i-as_indexed_json">as_indexed_json</a>,
              </li>
            
              
              <li>
                <a href="#method-c-authenticate">authenticate</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-blocked_by-3F">blocked_by?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-check_recent_probable_spammers">check_recent_probable_spammers</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_suspended_by_user">check_suspended_by_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-child_without_permission-3F">child_without_permission?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_deleted_user">create_deleted_user</a>,
              </li>
            
              
              <li>
                <a href="#method-c-create_from_omniauth">create_from_omniauth</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-default_json_options">default_json_options</a>,
              </li>
            
              
              <li>
                <a href="#method-i-destroy_messages_by_suspended_user">destroy_messages_by_suspended_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-destroy_project_rules">destroy_project_rules</a>,
              </li>
            
              
              <li>
                <a href="#method-i-display_donor_since">display_donor_since</a>,
              </li>
            
              
              <li>
                <a href="#method-i-donor-3F">donor?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-download_remote_icon">download_remote_icon</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-email-3D">email=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-email_required-3F">email_required?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-email_suppressed_in_group-3F">email_suppressed_in_group?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-enqueue_photo_bucket_moving_jobs">enqueue_photo_bucket_moving_jobs</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-facebook_api">facebook_api</a>,
              </li>
            
              
              <li>
                <a href="#method-i-facebook_identity">facebook_identity</a>,
              </li>
            
              
              <li>
                <a href="#method-i-facebook_token">facebook_token</a>,
              </li>
            
              
              <li>
                <a href="#method-c-find_for_authentication">find_for_authentication</a>,
              </li>
            
              
              <li>
                <a href="#method-i-flagged_with">flagged_with</a>,
              </li>
            
              
              <li>
                <a href="#method-i-followees">followees</a>,
              </li>
            
              
              <li>
                <a href="#method-i-followers">followers</a>,
              </li>
            
              
              <li>
                <a href="#method-c-forget">forget</a>,
              </li>
            
              
              <li>
                <a href="#method-i-friends_observations">friends_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-friends_with-3F">friends_with?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-generate_csv">generate_csv</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_lat_lon_from_ip">get_lat_lon_from_ip</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_lat_lon_from_ip_if_last_ip_changed">get_lat_lon_from_ip_if_last_ip_changed</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-has_provider_auth">has_provider_auth</a>,
              </li>
            
              
              <li>
                <a href="#method-i-has_role-3F">has_role?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-header_cache_key_for">header_cache_key_for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-header_projects">header_projects</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-icon_url_provided-3F">icon_url_provided?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-in_test_group-3F">in_test_group?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index_observations">index_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index_observations_later">index_observations_later</a>,
              </li>
            
              
              <li>
                <a href="#method-c-ip_address_is_often_suspended">ip_address_is_often_suspended</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_admin-3F">is_admin?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_app_owner-3F">is_app_owner?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_curator-3F">is_curator?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_site_admin_of-3F">is_site_admin_of?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-login-3D">login=</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-medium_user_icon_url">medium_user_icon_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-merge">merge</a>,
              </li>
            
              
              <li>
                <a href="#method-c-merge_cleanup">merge_cleanup</a>,
              </li>
            
              
              <li>
                <a href="#method-i-moderated_with">moderated_with</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-orcid">orcid</a>,
              </li>
            
              
              <li>
                <a href="#method-i-original_user_icon_url">original_user_icon_url</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-personal_lists">personal_lists</a>,
              </li>
            
              
              <li>
                <a href="#method-i-picasa_client">picasa_client</a>,
              </li>
            
              
              <li>
                <a href="#method-i-picasa_identity">picasa_identity</a>,
              </li>
            
              
              <li>
                <a href="#method-i-privileged_with-3F">privileged_with?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-published_name">published_name</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>Q</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-query">query</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-recent_notifications">recent_notifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-recent_observation_fields">recent_observation_fields</a>,
              </li>
            
              
              <li>
                <a href="#method-i-recent_observations">recent_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reindex_faved_observations_after_destroy">reindex_faved_observations_after_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reindex_faved_observations_after_destroy_later">reindex_faved_observations_after_destroy_later</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_email_from_name">remove_email_from_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-remove_email_from_string">remove_email_from_string</a>,
              </li>
            
              
              <li>
                <a href="#method-c-remove_icon_from_s3">remove_icon_from_s3</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_oauth_access_tokens">remove_oauth_access_tokens</a>,
              </li>
            
              
              <li>
                <a href="#method-i-restore_access_tokens_by_suspended_user">restore_access_tokens_by_suspended_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-revoke_access_tokens_by_suspended_user">revoke_access_tokens_by_suspended_user</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-sane_destroy">sane_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_data_transfer_consent_at">set_data_transfer_consent_at</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_locale">set_locale</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_observations_taxa_if_pref_changed">set_observations_taxa_if_pref_changed</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_pi_consent_at">set_pi_consent_at</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_time_zone">set_time_zone</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_uri">set_uri</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_uuid">set_uuid</a>,
              </li>
            
              
              <li>
                <a href="#method-i-strip_login">strip_login</a>,
              </li>
            
              
              <li>
                <a href="#method-i-strip_name">strip_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-subscribed_to-3F">subscribed_to?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-suggest_login">suggest_login</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-taxa_unobserved_before_date">taxa_unobserved_before_date</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_groups_array">test_groups_array</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_plain_s">to_plain_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-trusts-3F">trusts?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-twitter_identity">twitter_identity</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-update_identifications_counter_cache">update_identifications_counter_cache</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation_licenses">update_observation_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation_sites">update_observation_sites</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation_sites_later">update_observation_sites_later</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_observations_counter_cache">update_observations_counter_cache</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_photo_licenses">update_photo_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_sound_licenses">update_sound_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_species_counter_cache">update_species_counter_cache</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user_icon_url">user_icon_url</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-validate_email_domain_exists">validate_email_domain_exists</a>,
              </li>
            
              
              <li>
                <a href="#method-i-validate_email_pattern">validate_email_pattern</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="ActsAsElasticModel.html">
              ActsAsElasticModel
            </a>
          
        </li>
      
        <li>
          
            <a href="ActsAsSpammable/User.html">
              ActsAsSpammable::User
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_LOGIN</td>
            <td>=</td>
            <td class="attr-value">&quot;naturalist&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">JEDI_MASTER_ROLE</td>
            <td>=</td>
            <td class="attr-value">&#39;admin&#39;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>If the user has this role, has_role? will always return true</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LOGIN_PATTERN</td>
            <td>=</td>
            <td class="attr-value">&quot;[A-Za-z][\\\w\\\-_]+&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Regexes from restful_authentication</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAX_LOGIN_SIZE</td>
            <td>=</td>
            <td class="attr-value">40</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MIN_LOGIN_SIZE</td>
            <td>=</td>
            <td class="attr-value">3</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NOTIFICATION_PREFERENCES</td>
            <td>=</td>
            <td class="attr-value">%w(
comment_email_notification
identification_email_notification 
mention_email_notification
message_email_notification
project_journal_post_email_notification
project_added_your_observation_email_notification
project_curator_change_email_notification
taxon_change_email_notification
user_observation_email_notification
taxon_or_place_observation_email_notification
)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PREFERRED_OBSERVATION_FIELDS_BY_ANYONE</td>
            <td>=</td>
            <td class="attr-value">&quot;anyone&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PREFERRED_OBSERVATION_FIELDS_BY_CURATORS</td>
            <td>=</td>
            <td class="attr-value">&quot;curators&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PREFERRED_OBSERVATION_FIELDS_BY_OBSERVER</td>
            <td>=</td>
            <td class="attr-value">&quot;observer&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PROJECT_ADDITION_BY_ANY</td>
            <td>=</td>
            <td class="attr-value">&quot;any&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PROJECT_ADDITION_BY_JOINED</td>
            <td>=</td>
            <td class="attr-value">&quot;joined&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PROJECT_ADDITION_BY_NONE</td>
            <td>=</td>
            <td class="attr-value">&quot;none&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>data_transfer_consent</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>html</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>make_observation_licenses_same</td>
            <td class='attr-desc'><p>licensing extras</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>make_photo_licenses_same</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>make_sound_licenses_same</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>pi_consent</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_email_validation</td>
            <td class='attr-desc'><p>set user.skip_email_validation = true if you want to, um, skip email validation before creating+saving</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_registration_email</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-active_ids">
            
              <b>active_ids</b>(at_time = Time.now)
            
            <a href="../classes/User.html#method-c-active_ids" name="method-c-active_ids" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-active_ids_source')" id="l_method-c-active_ids_source">show</a>
                

                

                
              </p>
              <div id="method-c-active_ids_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1288</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">active_ids</span>(<span class="ruby-identifier">at_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
<span class="line-num">1289</span>   <span class="ruby-identifier">date_range</span> = (<span class="ruby-identifier">at_time</span> <span class="ruby-operator">-</span> <span class="ruby-value">30</span>.<span class="ruby-identifier">days</span>)<span class="ruby-operator">..</span><span class="ruby-identifier">at_time</span>
<span class="line-num">1290</span>   <span class="ruby-identifier">classes</span> = [ <span class="ruby-constant">Identification</span>, <span class="ruby-constant">Observation</span>, <span class="ruby-constant">Comment</span>, <span class="ruby-constant">Post</span> ]
<span class="line-num">1291</span>   <span class="ruby-comment"># get the unique user_ids that created instances of any of these</span>
<span class="line-num">1292</span>   <span class="ruby-comment"># classes within the last 30 days, then get the union (with .inject(:|))</span>
<span class="line-num">1293</span>   <span class="ruby-comment"># of the array of arrays.</span>
<span class="line-num">1294</span>   <span class="ruby-identifier">user_ids</span> = <span class="ruby-identifier">classes</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">1295</span>     <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;DISTINCT(user_id)&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">created_at:</span> <span class="ruby-identifier">date_range</span>).
<span class="line-num">1296</span>       <span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> }
<span class="line-num">1297</span>   }.<span class="ruby-identifier">inject</span>(<span class="ruby-value">:|</span>)
<span class="line-num">1298</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-authenticate">
            
              <b>authenticate</b>(login, password)
            
            <a href="../classes/User.html#method-c-authenticate" name="method-c-authenticate" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p><a href="http://stackoverflow.com/questions/6724494">stackoverflow.com/questions/6724494</a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-authenticate_source')" id="l_method-c-authenticate_source">show</a>
                

                

                
              </p>
              <div id="method-c-authenticate_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">789</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">authenticate</span>(<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>)
<span class="line-num">790</span>   <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_for_authentication</span>(<span class="ruby-value">:email</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">login</span>)
<span class="line-num">791</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">792</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">valid_password?</span>(<span class="ruby-identifier">password</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">active?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">793</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-check_recent_probable_spammers">
            
              <b>check_recent_probable_spammers</b>( limit = 100 )
            
            <a href="../classes/User.html#method-c-check_recent_probable_spammers" name="method-c-check_recent_probable_spammers" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Iterates over recently created accounts of unknown spammer status, zero obs or ids, and a description with a link. Attempts to run them past akismet three times, which seems to catch most spammers</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-check_recent_probable_spammers_source')" id="l_method-c-check_recent_probable_spammers_source">show</a>
                

                

                
              </p>
              <div id="method-c-check_recent_probable_spammers_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1502</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">check_recent_probable_spammers</span>( <span class="ruby-identifier">limit</span> = <span class="ruby-value">100</span> )
<span class="line-num">1503</span>   <span class="ruby-identifier">spammers</span> = []
<span class="line-num">1504</span>   <span class="ruby-identifier">num_checks</span> = {}
<span class="line-num">1505</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id desc&quot;</span> ).<span class="ruby-identifier">limit</span>( <span class="ruby-identifier">limit</span> ).
<span class="line-num">1506</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;spammer is null &quot;</span> ).
<span class="line-num">1507</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at &lt; ? &quot;</span>, <span class="ruby-value">12</span>.<span class="ruby-identifier">hours</span>.<span class="ruby-identifier">ago</span> ). <span class="ruby-comment"># half day grace period</span>
<span class="line-num">1508</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;description is not null and description != &#39;&#39; and description ilike &#39;%http%&#39;&quot;</span> ).
<span class="line-num">1509</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations_count = 0 and identifications_count = 0&quot;</span> ).
<span class="line-num">1510</span>     <span class="ruby-identifier">pluck</span>( <span class="ruby-value">:id</span> ).
<span class="line-num">1511</span>     <span class="ruby-identifier">in_groups_of</span>( <span class="ruby-value">10</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">ids</span> <span class="ruby-operator">|</span>
<span class="line-num">1512</span>     <span class="ruby-identifier">puts</span>
<span class="line-num">1513</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;BATCH #{ids[0]}&quot;</span>
<span class="line-num">1514</span>     <span class="ruby-identifier">puts</span>
<span class="line-num">1515</span>     <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span>
<span class="line-num">1516</span>       <span class="ruby-identifier">batch</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">ids</span> )
<span class="line-num">1517</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Try #{i}&quot;</span>
<span class="line-num">1518</span>       <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">u</span> <span class="ruby-operator">|</span>
<span class="line-num">1519</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">spammers</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span> )
<span class="line-num">1520</span> 
<span class="line-num">1521</span>         <span class="ruby-identifier">num_checks</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
<span class="line-num">1522</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{u}, checked #{num_checks[u.login]} times already&quot;</span>
<span class="line-num">1523</span>         <span class="ruby-identifier">num_checks</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1524</span>         <span class="ruby-identifier">u</span>.<span class="ruby-identifier">description_will_change!</span>
<span class="line-num">1525</span>         <span class="ruby-identifier">u</span>.<span class="ruby-identifier">check_for_spam</span>
<span class="line-num">1526</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tu.akismet_response: #{u.akismet_response}&quot;</span>
<span class="line-num">1527</span>         <span class="ruby-identifier">u</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1528</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">spammer</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
<span class="line-num">1529</span>           <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;\tSPAM&quot;</span>
<span class="line-num">1530</span>           <span class="ruby-identifier">spammers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span>
<span class="line-num">1531</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1532</span>         <span class="ruby-identifier">sleep</span> <span class="ruby-value">1</span>
<span class="line-num">1533</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1534</span>       <span class="ruby-identifier">sleep</span> <span class="ruby-value">10</span>
<span class="line-num">1535</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1536</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1537</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-create_from_omniauth">
            
              <b>create_from_omniauth</b>(auth_info)
            
            <a href="../classes/User.html#method-c-create_from_omniauth" name="method-c-create_from_omniauth" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>create a user using 3rd party provider credentials (via omniauth) note that this bypasses validation and immediately activates the new user see <a href="https://github.com/intridea/omniauth/wiki/Auth-Hash-Schema">github.com/intridea/omniauth/wiki/Auth-Hash-Schema</a> for details of auth_info data</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-create_from_omniauth_source')" id="l_method-c-create_from_omniauth_source">show</a>
                

                

                
              </p>
              <div id="method-c-create_from_omniauth_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">798</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">create_from_omniauth</span>(<span class="ruby-identifier">auth_info</span>)
<span class="line-num">799</span>   <span class="ruby-identifier">email</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-string">&quot;email&quot;</span>)
<span class="line-num">800</span>   <span class="ruby-identifier">email</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;extra&quot;</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-string">&quot;user_hash&quot;</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-string">&quot;email&quot;</span>)
<span class="line-num">801</span>   <span class="ruby-comment"># see if there&#39;s an existing inat user with this email. if so, just link the accounts and return the existing user.</span>
<span class="line-num">802</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">email</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_email</span>(<span class="ruby-identifier">email</span>)
<span class="line-num">803</span>     <span class="ruby-identifier">u</span>.<span class="ruby-identifier">add_provider_auth</span>(<span class="ruby-identifier">auth_info</span>)
<span class="line-num">804</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">u</span>
<span class="line-num">805</span>   <span class="ruby-keyword">end</span>
<span class="line-num">806</span>   <span class="ruby-identifier">auth_info_name</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>][<span class="ruby-string">&quot;nickname&quot;</span>]
<span class="line-num">807</span>   <span class="ruby-identifier">auth_info_name</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>][<span class="ruby-string">&quot;first_name&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">auth_info_name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">808</span>   <span class="ruby-identifier">auth_info_name</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>][<span class="ruby-string">&quot;name&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">auth_info_name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">809</span>   <span class="ruby-identifier">auth_info_name</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">remove_email_from_string</span>( <span class="ruby-identifier">auth_info_name</span> )
<span class="line-num">810</span>   <span class="ruby-identifier">autogen_login</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">suggest_login</span>(<span class="ruby-identifier">auth_info_name</span>)
<span class="line-num">811</span>   <span class="ruby-identifier">autogen_login</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">suggest_login</span>( <span class="ruby-constant">DEFAULT_LOGIN</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">autogen_login</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">812</span>   <span class="ruby-identifier">autogen_pw</span> = <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">hex</span>(<span class="ruby-value">6</span>) <span class="ruby-comment"># autogenerate a random password (or else validation fails)</span>
<span class="line-num">813</span>   <span class="ruby-identifier">icon_url</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>][<span class="ruby-string">&quot;image&quot;</span>]
<span class="line-num">814</span>   <span class="ruby-comment"># Don&#39;t bother if the icon URL looks like the default Google user icon</span>
<span class="line-num">815</span>   <span class="ruby-identifier">icon_url</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">icon_url</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/4252rscbv5M/</span>
<span class="line-num">816</span>   <span class="ruby-identifier">icon_url</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">icon_url</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/s96-c/</span>
<span class="line-num">817</span>   <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">818</span>     <span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">autogen_login</span>,
<span class="line-num">819</span>     <span class="ruby-value">:email</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">email</span>,
<span class="line-num">820</span>     <span class="ruby-value">:name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">auth_info</span>[<span class="ruby-string">&quot;info&quot;</span>][<span class="ruby-string">&quot;name&quot;</span>],
<span class="line-num">821</span>     <span class="ruby-value">:password</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">autogen_pw</span>,
<span class="line-num">822</span>     <span class="ruby-value">:password_confirmation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">autogen_pw</span>,
<span class="line-num">823</span>     <span class="ruby-value">:icon_url</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">icon_url</span>
<span class="line-num">824</span>   )
<span class="line-num">825</span>   <span class="ruby-identifier">u</span>.<span class="ruby-identifier">skip_email_validation</span> = <span class="ruby-keyword">true</span>
<span class="line-num">826</span>   <span class="ruby-identifier">u</span>.<span class="ruby-identifier">skip_confirmation!</span>
<span class="line-num">827</span>   <span class="ruby-identifier">user_saved</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">828</span>     <span class="ruby-identifier">u</span>.<span class="ruby-identifier">save</span>
<span class="line-num">829</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotUnique</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">830</span>     <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/duplicate key value violates unique constraint/</span>
<span class="line-num">831</span>     <span class="ruby-keyword">false</span>
<span class="line-num">832</span>   <span class="ruby-keyword">end</span>
<span class="line-num">833</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user_saved</span>
<span class="line-num">834</span>     <span class="ruby-identifier">suggestion</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">suggest_login</span>(<span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">835</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO #{Time.now}] unique violation on #{u.login}, suggested login: #{suggestion}&quot;</span>
<span class="line-num">836</span>     <span class="ruby-identifier">u</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">suggestion</span>)
<span class="line-num">837</span>   <span class="ruby-keyword">end</span>
<span class="line-num">838</span>   <span class="ruby-identifier">u</span>.<span class="ruby-identifier">add_provider_auth</span>(<span class="ruby-identifier">auth_info</span>)
<span class="line-num">839</span>   <span class="ruby-identifier">u</span>
<span class="line-num">840</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-default_json_options">
            
              <b>default_json_options</b>()
            
            <a href="../classes/User.html#method-c-default_json_options" name="method-c-default_json_options" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-default_json_options_source')" id="l_method-c-default_json_options_source">show</a>
                

                

                
              </p>
              <div id="method-c-default_json_options_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1270</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">default_json_options</span>
<span class="line-num">1271</span>   {
<span class="line-num">1272</span>     <span class="ruby-value">only:</span> [
<span class="line-num">1273</span>       <span class="ruby-value">:id</span>,
<span class="line-num">1274</span>       <span class="ruby-value">:login</span>,
<span class="line-num">1275</span>       <span class="ruby-value">:name</span>,
<span class="line-num">1276</span>       <span class="ruby-value">:created</span>,
<span class="line-num">1277</span>       <span class="ruby-value">:observations_count</span>,
<span class="line-num">1278</span>       <span class="ruby-value">:identifications_count</span>
<span class="line-num">1279</span>     ],
<span class="line-num">1280</span>     <span class="ruby-value">methods:</span> [
<span class="line-num">1281</span>       <span class="ruby-value">:user_icon_url</span>,
<span class="line-num">1282</span>       <span class="ruby-value">:medium_user_icon_url</span>,
<span class="line-num">1283</span>       <span class="ruby-value">:original_user_icon_url</span>
<span class="line-num">1284</span>     ]
<span class="line-num">1285</span>   }
<span class="line-num">1286</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-enqueue_photo_bucket_moving_jobs">
            
              <b>enqueue_photo_bucket_moving_jobs</b>( user )
            
            <a href="../classes/User.html#method-c-enqueue_photo_bucket_moving_jobs" name="method-c-enqueue_photo_bucket_moving_jobs" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>this method will look at all this users photos and create separate delayed jobs for each photo that should be moved to the other bucket</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-enqueue_photo_bucket_moving_jobs_source')" id="l_method-c-enqueue_photo_bucket_moving_jobs_source">show</a>
                

                

                
              </p>
              <div id="method-c-enqueue_photo_bucket_moving_jobs_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1478</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">enqueue_photo_bucket_moving_jobs</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1479</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">LocalPhoto</span>.<span class="ruby-identifier">odp_s3_bucket_enabled?</span>
<span class="line-num">1480</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> )
<span class="line-num">1481</span>     <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1482</span>     <span class="ruby-identifier">u</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1483</span>     <span class="ruby-identifier">user</span> = <span class="ruby-identifier">u</span>
<span class="line-num">1484</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1485</span>   <span class="ruby-constant">LocalPhoto</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> ).
<span class="line-num">1486</span>     <span class="ruby-identifier">select</span>( <span class="ruby-value">:id</span>, <span class="ruby-value">:license</span>, <span class="ruby-value">:user_id</span>, <span class="ruby-value">:file_prefix_id</span>, <span class="ruby-value">:file_extension_id</span> ).
<span class="line-num">1487</span>     <span class="ruby-identifier">includes</span>( <span class="ruby-value">:user</span>, <span class="ruby-value">:file_prefix</span>, <span class="ruby-value">:file_extension</span>, <span class="ruby-value">:flags</span> ).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num">1488</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">photo_bucket_should_be_changed?</span>
<span class="line-num">1489</span>       <span class="ruby-constant">LocalPhoto</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">1490</span>         <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;photos&quot;</span>,
<span class="line-num">1491</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;LocalPhoto::change_photo_bucket_if_needed&quot;:</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">1492</span>       ).<span class="ruby-identifier">change_photo_bucket_if_needed</span>( <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1493</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1494</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1495</span>   <span class="ruby-comment"># return nil so this isn&#39;t returning all results of the above query</span>
<span class="line-num">1496</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">1497</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-find_for_authentication">
            
              <b>find_for_authentication</b>(conditions = {})
            
            <a href="../classes/User.html#method-c-find_for_authentication" name="method-c-find_for_authentication" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-find_for_authentication_source')" id="l_method-c-find_for_authentication_source">show</a>
                

                

                
              </p>
              <div id="method-c-find_for_authentication_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">783</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">find_for_authentication</span>(<span class="ruby-identifier">conditions</span> = {})
<span class="line-num">784</span>   <span class="ruby-identifier">s</span> = <span class="ruby-identifier">conditions</span>[<span class="ruby-value">:email</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">785</span>   <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(login) = ?&quot;</span>, <span class="ruby-identifier">s</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(email) = ?&quot;</span>, <span class="ruby-identifier">s</span>).<span class="ruby-identifier">first</span>
<span class="line-num">786</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-forget">
            
              <b>forget</b>( user_id, options = {} )
            
            <a href="../classes/User.html#method-c-forget" name="method-c-forget" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Wipes all the data related to a user, within reason (can&#39;t do backups). Only for extreme cases and compliance with privacy regulations. Do not expose in the UI.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-forget_source')" id="l_method-c-forget_source">show</a>
                

                

                
              </p>
              <div id="method-c-forget_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1015</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">forget</span>( <span class="ruby-identifier">user_id</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1016</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1017</span>     <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;User ID cannot be blank&quot;</span>
<span class="line-num">1018</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1019</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">1020</span>     <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Destroying user (this could take a while)&quot;</span>
<span class="line-num">1021</span>     <span class="ruby-identifier">user</span>.<span class="ruby-identifier">sane_destroy</span>
<span class="line-num">1022</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1023</span> 
<span class="line-num">1024</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">deleted_user</span> = <span class="ruby-constant">DeletedUser</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">first</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">deleted_user</span>.<span class="ruby-identifier">email</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1025</span>     <span class="ruby-constant">EmailSuppression</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">email:</span> <span class="ruby-identifier">deleted_user</span>.<span class="ruby-identifier">email</span> ).<span class="ruby-identifier">delete_all</span>
<span class="line-num">1026</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1027</span> 
<span class="line-num">1028</span>   <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Updating flags created by user...&quot;</span>
<span class="line-num">1029</span>   <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">user_id:</span> <span class="ruby-value">-1</span> )
<span class="line-num">1030</span> 
<span class="line-num">1031</span>   <span class="ruby-identifier">deleted_observations</span> = <span class="ruby-constant">DeletedObservation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> )
<span class="line-num">1032</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleting #{deleted_observations.count} DeletedObservations&quot;</span>
<span class="line-num">1033</span>   <span class="ruby-identifier">deleted_observations</span>.<span class="ruby-identifier">delete_all</span>
<span class="line-num">1034</span> 
<span class="line-num">1035</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_aws</span>]
<span class="line-num">1036</span>     <span class="ruby-identifier">s3_config</span> = <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>( <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;config&quot;</span>, <span class="ruby-string">&quot;s3.yml&quot;</span>) )
<span class="line-num">1037</span>     <span class="ruby-identifier">s3_client</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Aws</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1038</span>       <span class="ruby-value">access_key_id:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;access_key_id&quot;</span>],
<span class="line-num">1039</span>       <span class="ruby-value">secret_access_key:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;secret_access_key&quot;</span>],
<span class="line-num">1040</span>       <span class="ruby-value">region:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_region</span>
<span class="line-num">1041</span>     )
<span class="line-num">1042</span>     <span class="ruby-identifier">cf_client</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Aws</span><span class="ruby-operator">::</span><span class="ruby-constant">CloudFront</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1043</span>       <span class="ruby-value">access_key_id:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;access_key_id&quot;</span>],
<span class="line-num">1044</span>       <span class="ruby-value">secret_access_key:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;secret_access_key&quot;</span>],
<span class="line-num">1045</span>       <span class="ruby-value">region:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_region</span>
<span class="line-num">1046</span>     )
<span class="line-num">1047</span> 
<span class="line-num">1048</span>     <span class="ruby-identifier">deleted_photos</span> = <span class="ruby-constant">DeletedPhoto</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> )
<span class="line-num">1049</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleting #{deleted_photos.count} DeletedPhotos and associated records from s3&quot;</span>
<span class="line-num">1050</span>     <span class="ruby-identifier">deleted_photos</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dp</span><span class="ruby-operator">|</span>
<span class="line-num">1051</span>       <span class="ruby-identifier">dp</span>.<span class="ruby-identifier">remove_from_s3</span>( <span class="ruby-value">s3_client:</span> <span class="ruby-identifier">s3_client</span> )
<span class="line-num">1052</span>       <span class="ruby-identifier">dp</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1053</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1054</span> 
<span class="line-num">1055</span>     <span class="ruby-comment"># delete user profile pic form s3</span>
<span class="line-num">1056</span>     <span class="ruby-identifier">user_images</span> = <span class="ruby-identifier">s3_client</span>.<span class="ruby-identifier">list_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">prefix:</span> <span class="ruby-node">&quot;attachments/users/icons/#{user_id}/&quot;</span> ).<span class="ruby-identifier">contents</span>
<span class="line-num">1057</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_images</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1058</span>       <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Deleting profile pic from S3&quot;</span>
<span class="line-num">1059</span>       <span class="ruby-identifier">s3_client</span>.<span class="ruby-identifier">delete_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">delete:</span> { <span class="ruby-value">objects:</span> <span class="ruby-identifier">user_images</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> { <span class="ruby-value">key:</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key</span> } } } )
<span class="line-num">1060</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1061</span> 
<span class="line-num">1062</span>     <span class="ruby-comment"># This might cause problems with multiple simultaneous invalidations. FWIW,</span>
<span class="line-num">1063</span>     <span class="ruby-comment"># CloudFront is supposed to expire things in 24 hours by default</span>
<span class="line-num">1064</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:cloudfront_distribution_id</span>]
<span class="line-num">1065</span>       <span class="ruby-identifier">paths</span> = <span class="ruby-identifier">deleted_photos</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dp</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;/photos/#{ dp.photo_id }/*&quot;</span> }
<span class="line-num">1066</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_images</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1067</span>         <span class="ruby-identifier">paths</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;attachments/users/icons/#{user_id}/*&quot;</span>
<span class="line-num">1068</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1069</span>       <span class="ruby-identifier">cf_client</span>.<span class="ruby-identifier">create_invalidation</span>(
<span class="line-num">1070</span>         <span class="ruby-value">distribution_id:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:cloudfront_distribution_id</span>],
<span class="line-num">1071</span>         <span class="ruby-value">invalidation_batch:</span> {
<span class="line-num">1072</span>           <span class="ruby-value">paths:</span> {
<span class="line-num">1073</span>             <span class="ruby-value">quantity:</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">size</span>,
<span class="line-num">1074</span>             <span class="ruby-value">items:</span> <span class="ruby-identifier">paths</span>
<span class="line-num">1075</span>           },
<span class="line-num">1076</span>           <span class="ruby-value">caller_reference:</span> <span class="ruby-node">&quot;#{paths[0]}/#{Time.now.to_i}&quot;</span>
<span class="line-num">1077</span>         }
<span class="line-num">1078</span>       )
<span class="line-num">1079</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1080</span> 
<span class="line-num">1081</span>     <span class="ruby-identifier">deleted_sounds</span> = <span class="ruby-constant">DeletedSound</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> )
<span class="line-num">1082</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleting #{deleted_sounds.count} DeletedSounds and associated records from s3&quot;</span>
<span class="line-num">1083</span>     <span class="ruby-identifier">deleted_sounds</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
<span class="line-num">1084</span>       <span class="ruby-identifier">sounds</span> = <span class="ruby-identifier">s3_client</span>.<span class="ruby-identifier">list_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">prefix:</span> <span class="ruby-node">&quot;sounds/#{ ds.sound_id }.&quot;</span> ).<span class="ruby-identifier">contents</span>
<span class="line-num">1085</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tSound #{ds.sound_id}, removing #{sounds.size} sounds from S3&quot;</span>
<span class="line-num">1086</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1087</span>         <span class="ruby-identifier">s3_client</span>.<span class="ruby-identifier">delete_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">delete:</span> { <span class="ruby-value">objects:</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> { <span class="ruby-value">key:</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key</span> } } } )
<span class="line-num">1088</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1089</span>       <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1090</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1091</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1092</span> 
<span class="line-num">1093</span>   <span class="ruby-comment"># Delete from PandionES where user_id:user_id</span>
<span class="line-num">1094</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:logstash_es_host</span>]
<span class="line-num">1095</span>     <span class="ruby-identifier">logstash_es_client</span> = <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1096</span>       <span class="ruby-value">host:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:logstash_es_host</span>],
<span class="line-num">1097</span>     )
<span class="line-num">1098</span>     <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Deleting logstash records&quot;</span>
<span class="line-num">1099</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">1100</span>       <span class="ruby-identifier">logstash_es_client</span>.<span class="ruby-identifier">delete_by_query</span>(
<span class="line-num">1101</span>         <span class="ruby-value">index:</span> <span class="ruby-string">&quot;logstash-*&quot;</span>,
<span class="line-num">1102</span>         <span class="ruby-value">body:</span> {
<span class="line-num">1103</span>           <span class="ruby-value">query:</span> {
<span class="line-num">1104</span>             <span class="ruby-value">term:</span> {
<span class="line-num">1105</span>               <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">1106</span>             }
<span class="line-num">1107</span>           }
<span class="line-num">1108</span>         }
<span class="line-num">1109</span>       )
<span class="line-num">1110</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Faraday</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeoutError</span>, <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">ReadTimeout</span>
<span class="line-num">1111</span>       <span class="ruby-keyword">retry</span>
<span class="line-num">1112</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1113</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1114</span>     <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Logstash ES host not configured. You may have to manually remove log entries for this user.&quot;</span>
<span class="line-num">1115</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1116</span> 
<span class="line-num">1117</span>   <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Deleting DeletedUser&quot;</span>
<span class="line-num">1118</span>   <span class="ruby-constant">DeletedUser</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">delete_all</span>
<span class="line-num">1119</span> 
<span class="line-num">1120</span>   <span class="ruby-comment"># Trigger sync on all staging servers</span>
<span class="line-num">1121</span>   <span class="ruby-identifier">puts</span>
<span class="line-num">1122</span>   <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Ensure all staging servers get synced&quot;</span>
<span class="line-num">1123</span>   <span class="ruby-identifier">puts</span>
<span class="line-num">1124</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-header_cache_key_for">
            
              <b>header_cache_key_for</b>(user, options = {})
            
            <a href="../classes/User.html#method-c-header_cache_key_for" name="method-c-header_cache_key_for" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-header_cache_key_for_source')" id="l_method-c-header_cache_key_for_source">show</a>
                

                

                
              </p>
              <div id="method-c-header_cache_key_for_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1300</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">header_cache_key_for</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">1301</span>   <span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>
<span class="line-num">1302</span>   <span class="ruby-identifier">user_id</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;signed_on&quot;</span>
<span class="line-num">1303</span>   <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site_name</span>]
<span class="line-num">1304</span>   <span class="ruby-identifier">site_name</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>)
<span class="line-num">1305</span>   <span class="ruby-identifier">version</span> = <span class="ruby-constant">ApplicationController</span><span class="ruby-operator">::</span><span class="ruby-constant">HEADER_VERSION</span>
<span class="line-num">1306</span>   <span class="ruby-node">&quot;header_cache_key_for_#{user_id}_on_#{site_name}_#{I18n.locale}_#{version}&quot;</span>
<span class="line-num">1307</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-ip_address_is_often_suspended">
            
              <b>ip_address_is_often_suspended</b>( ip )
            
            <a href="../classes/User.html#method-c-ip_address_is_often_suspended" name="method-c-ip_address_is_often_suspended" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-ip_address_is_often_suspended_source')" id="l_method-c-ip_address_is_often_suspended_source">show</a>
                

                

                
              </p>
              <div id="method-c-ip_address_is_often_suspended_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1539</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">ip_address_is_often_suspended</span>( <span class="ruby-identifier">ip</span> )
<span class="line-num">1540</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1541</span> 
<span class="line-num">1542</span>   <span class="ruby-identifier">count_suspended</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">last_ip:</span> <span class="ruby-identifier">ip</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;suspended_at IS NOT NULL&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">1543</span>   <span class="ruby-identifier">count_active</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">last_ip:</span> <span class="ruby-identifier">ip</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;suspended_at IS NULL&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">1544</span>   <span class="ruby-identifier">total</span> = <span class="ruby-identifier">count_suspended</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">count_active</span>
<span class="line-num">1545</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">total</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
<span class="line-num">1546</span> 
<span class="line-num">1547</span>   <span class="ruby-identifier">count_suspended</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> ( <span class="ruby-identifier">count_suspended</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">count_active</span> ) <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0.9</span>
<span class="line-num">1548</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-merge_cleanup">
            
              <b>merge_cleanup</b>( user_id )
            
            <a href="../classes/User.html#method-c-merge_cleanup" name="method-c-merge_cleanup" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-merge_cleanup_source')" id="l_method-c-merge_cleanup_source">show</a>
                

                

                
              </p>
              <div id="method-c-merge_cleanup_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">667</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">merge_cleanup</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">668</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">669</span>   <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">670</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">671</span>     <span class="ruby-value">scope:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">user_id</span> ),
<span class="line-num">672</span>     <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>
<span class="line-num">673</span>   )
<span class="line-num">674</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">675</span>     <span class="ruby-value">scope:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:identifications</span> ).
<span class="line-num">676</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications.user_id = ?&quot;</span>, <span class="ruby-identifier">user_id</span> ).
<span class="line-num">677</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations.last_indexed_at &lt; ?&quot;</span>, <span class="ruby-identifier">start</span> ),
<span class="line-num">678</span>     <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>
<span class="line-num">679</span>   )
<span class="line-num">680</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">681</span>     <span class="ruby-value">scope:</span> <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ),
<span class="line-num">682</span>     <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>
<span class="line-num">683</span>   )
<span class="line-num">684</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">update_identifications_counter_cache</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">685</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">update_observations_counter_cache</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">686</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">update_species_counter_cache</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">687</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">688</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">689</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">690</span>     <span class="ruby-value">ids:</span> <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:project_id</span>),
<span class="line-num">691</span>     <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>
<span class="line-num">692</span>   )
<span class="line-num">693</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-query">
            
              <b>query</b>(params={})
            
            <a href="../classes/User.html#method-c-query" name="method-c-query" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-query_source')" id="l_method-c-query_source">show</a>
                

                

                
              </p>
              <div id="method-c-query_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">773</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">query</span>(<span class="ruby-identifier">params</span>={}) 
<span class="line-num">774</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">all</span>
<span class="line-num">775</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_by</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_dir</span>]
<span class="line-num">776</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">order</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_by</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_dir</span>])
<span class="line-num">777</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_by</span>]
<span class="line-num">778</span>     <span class="ruby-identifier">params</span>.<span class="ruby-identifier">order</span>(<span class="ruby-identifier">query</span>[<span class="ruby-value">:sort_by</span>])
<span class="line-num">779</span>   <span class="ruby-keyword">end</span>
<span class="line-num">780</span>   <span class="ruby-identifier">scope</span>
<span class="line-num">781</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reindex_faved_observations_after_destroy">
            
              <b>reindex_faved_observations_after_destroy</b>( user_id )
            
            <a href="../classes/User.html#method-c-reindex_faved_observations_after_destroy" name="method-c-reindex_faved_observations_after_destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reindex_faved_observations_after_destroy_source')" id="l_method-c-reindex_faved_observations_after_destroy_source">show</a>
                

                

                
              </p>
              <div id="method-c-reindex_faved_observations_after_destroy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1165</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reindex_faved_observations_after_destroy</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">1166</span>   <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
<span class="line-num">1167</span>     <span class="ruby-identifier">obs</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">1168</span>       <span class="ruby-value">_source:</span> [<span class="ruby-value">:id</span>],
<span class="line-num">1169</span>       <span class="ruby-value">limit:</span> <span class="ruby-value">200</span>,
<span class="line-num">1170</span>       <span class="ruby-value">where:</span> {
<span class="line-num">1171</span>         <span class="ruby-value">nested:</span> {
<span class="line-num">1172</span>           <span class="ruby-value">path:</span> <span class="ruby-string">&quot;votes&quot;</span>,
<span class="line-num">1173</span>           <span class="ruby-value">query:</span> {
<span class="line-num">1174</span>             <span class="ruby-value">bool:</span> {
<span class="line-num">1175</span>               <span class="ruby-value">filter:</span> {
<span class="line-num">1176</span>                 <span class="ruby-value">term:</span> {
<span class="line-num">1177</span>                   <span class="ruby-value">&quot;votes.user_id&quot;:</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">1178</span>                 }
<span class="line-num">1179</span>               }
<span class="line-num">1180</span>             }
<span class="line-num">1181</span>           }
<span class="line-num">1182</span>         }
<span class="line-num">1183</span>       }
<span class="line-num">1184</span>     ).<span class="ruby-identifier">results</span>.<span class="ruby-identifier">results</span>
<span class="line-num">1185</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1186</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>), <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1187</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1188</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-remove_email_from_string">
            
              <b>remove_email_from_string</b>( s )
            
            <a href="../classes/User.html#method-c-remove_email_from_string" name="method-c-remove_email_from_string" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-remove_email_from_string_source')" id="l_method-c-remove_email_from_string_source">show</a>
                

                

                
              </p>
              <div id="method-c-remove_email_from_string_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1411</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">remove_email_from_string</span>( <span class="ruby-identifier">s</span> )
<span class="line-num">1412</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1413</span>   <span class="ruby-identifier">email_pattern</span> = <span class="ruby-regexp">/#{Devise.email_regexp.to_s.gsub(&quot;\\A&quot; , &quot;&quot;).gsub( &quot;\\z&quot;, &quot;&quot; )}/</span>
<span class="line-num">1414</span>   <span class="ruby-identifier">s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-identifier">email_pattern</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1415</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-remove_icon_from_s3">
            
              <b>remove_icon_from_s3</b>( user_id )
            
            <a href="../classes/User.html#method-c-remove_icon_from_s3" name="method-c-remove_icon_from_s3" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-remove_icon_from_s3_source')" id="l_method-c-remove_icon_from_s3_source">show</a>
                

                

                
              </p>
              <div id="method-c-remove_icon_from_s3_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1126</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">remove_icon_from_s3</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">1127</span>   <span class="ruby-ivar">@s3_config</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>( <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;config&quot;</span>, <span class="ruby-string">&quot;s3.yml&quot;</span>) )
<span class="line-num">1128</span>   <span class="ruby-ivar">@s3_client</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">::</span><span class="ruby-constant">Aws</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1129</span>     <span class="ruby-value">access_key_id:</span> <span class="ruby-ivar">@s3_config</span>[<span class="ruby-string">&quot;access_key_id&quot;</span>],
<span class="line-num">1130</span>     <span class="ruby-value">secret_access_key:</span> <span class="ruby-ivar">@s3_config</span>[<span class="ruby-string">&quot;secret_access_key&quot;</span>],
<span class="line-num">1131</span>     <span class="ruby-value">region:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_region</span>
<span class="line-num">1132</span>   )
<span class="line-num">1133</span>   <span class="ruby-identifier">user_images</span> = <span class="ruby-ivar">@s3_client</span>.<span class="ruby-identifier">list_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">prefix:</span> <span class="ruby-node">&quot;attachments/users/icons/#{user_id}/&quot;</span> ).<span class="ruby-identifier">contents</span>
<span class="line-num">1134</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_images</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1135</span>     <span class="ruby-ivar">@s3_client</span>.<span class="ruby-identifier">delete_objects</span>( <span class="ruby-value">bucket:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span>, <span class="ruby-value">delete:</span> { <span class="ruby-value">objects:</span> <span class="ruby-identifier">user_images</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> { <span class="ruby-value">key:</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key</span> } } } )
<span class="line-num">1136</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1137</span>   <span class="ruby-comment"># Note that the images might remain in Cloudfront for 24 hours, but by the time this gets called they&#39;re probably already gone</span>
<span class="line-num">1138</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-suggest_login">
            
              <b>suggest_login</b>(requested_login)
            
            <a href="../classes/User.html#method-c-suggest_login" name="method-c-suggest_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>given a requested login, will try to find existing users with that login and suggest handle2, handle3, handle4, etc if the login&#39;s taken to prevent namespace clashes (e.g. i register with twitter @joe but  there&#39;s already an inat user where login=joe, so it suggest joe2)</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-suggest_login_source')" id="l_method-c-suggest_login_source">show</a>
                

                

                
              </p>
              <div id="method-c-suggest_login_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">846</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">suggest_login</span>(<span class="ruby-identifier">requested_login</span>)
<span class="line-num">847</span>   <span class="ruby-identifier">requested_login</span> = <span class="ruby-identifier">requested_login</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">848</span>   <span class="ruby-identifier">requested_login</span> = <span class="ruby-constant">DEFAULT_LOGIN</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">requested_login</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">849</span>   <span class="ruby-identifier">requested_login</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">transliterate</span>( <span class="ruby-identifier">requested_login</span> ).<span class="ruby-identifier">sub</span>( <span class="ruby-regexp">/^\d*/</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/\?+/</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">850</span>   <span class="ruby-identifier">requested_login</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">requested_login</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">851</span>     <span class="ruby-constant">DEFAULT_LOGIN</span>
<span class="line-num">852</span>   <span class="ruby-keyword">else</span>
<span class="line-num">853</span>     <span class="ruby-identifier">requested_login</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/\W/</span>, <span class="ruby-string">&quot;_&quot;</span> ).<span class="ruby-identifier">downcase</span>
<span class="line-num">854</span>   <span class="ruby-keyword">end</span>
<span class="line-num">855</span>   <span class="ruby-identifier">suggested_login</span> = <span class="ruby-identifier">requested_login</span>
<span class="line-num">856</span> 
<span class="line-num">857</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">suggested_login</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">MAX_LOGIN_SIZE</span>
<span class="line-num">858</span>     <span class="ruby-identifier">suggested_login</span> = <span class="ruby-identifier">suggested_login</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-constant">MAX_LOGIN_SIZE</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>]
<span class="line-num">859</span>   <span class="ruby-keyword">end</span>
<span class="line-num">860</span> 
<span class="line-num">861</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">suggested_login</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^#{DEFAULT_LOGIN}\d+?/</span>
<span class="line-num">862</span>     <span class="ruby-keyword">while</span> <span class="ruby-identifier">suggested_login</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MIN_LOGIN_SIZE</span> <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>( <span class="ruby-identifier">suggested_login</span> )
<span class="line-num">863</span>       <span class="ruby-identifier">suggested_login</span> = <span class="ruby-node">&quot;#{requested_login}#{rand( User.maximum(:id) * 2 )}&quot;</span>
<span class="line-num">864</span>     <span class="ruby-keyword">end</span>
<span class="line-num">865</span>   <span class="ruby-keyword">else</span>
<span class="line-num">866</span>     <span class="ruby-comment"># if the name is semi-unique, try to append integers, so kueda would get</span>
<span class="line-num">867</span>     <span class="ruby-comment"># kueda2 and not kueda34097348976 off the bat</span>
<span class="line-num">868</span>     <span class="ruby-identifier">appendix</span> = <span class="ruby-value">1</span>
<span class="line-num">869</span>     <span class="ruby-keyword">while</span> <span class="ruby-identifier">suggested_login</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MIN_LOGIN_SIZE</span> <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>(<span class="ruby-identifier">suggested_login</span>)
<span class="line-num">870</span>       <span class="ruby-identifier">suggested_login</span> = <span class="ruby-node">&quot;#{requested_login}#{appendix}&quot;</span>
<span class="line-num">871</span>       <span class="ruby-identifier">appendix</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">872</span>     <span class="ruby-keyword">end</span>
<span class="line-num">873</span>   <span class="ruby-keyword">end</span>
<span class="line-num">874</span> 
<span class="line-num">875</span>   (<span class="ruby-constant">MIN_LOGIN_SIZE</span><span class="ruby-operator">..</span><span class="ruby-constant">MAX_LOGIN_SIZE</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">suggested_login</span>.<span class="ruby-identifier">size</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">suggested_login</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">876</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_identifications_counter_cache">
            
              <b>update_identifications_counter_cache</b>(user_id)
            
            <a href="../classes/User.html#method-c-update_identifications_counter_cache" name="method-c-update_identifications_counter_cache" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_identifications_counter_cache_source')" id="l_method-c-update_identifications_counter_cache_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_identifications_counter_cache_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1309</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_identifications_counter_cache</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">1310</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">1311</span>   <span class="ruby-identifier">new_fields_result</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">1312</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">1313</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;non_owner_identifier_user_ids.keyword&quot;:</span> <span class="ruby-identifier">user_id</span> } }
<span class="line-num">1314</span>     ],
<span class="line-num">1315</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1316</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">1317</span>   )
<span class="line-num">1318</span>   <span class="ruby-identifier">count</span> = (<span class="ruby-identifier">new_fields_result</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">new_fields_result</span>.<span class="ruby-identifier">response</span>) <span class="ruby-operator">?</span>
<span class="line-num">1319</span>     <span class="ruby-identifier">new_fields_result</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">total</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">1320</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-value">identifications_count:</span> <span class="ruby-identifier">count</span>)
<span class="line-num">1321</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_observations_counter_cache">
            
              <b>update_observations_counter_cache</b>(user_id)
            
            <a href="../classes/User.html#method-c-update_observations_counter_cache" name="method-c-update_observations_counter_cache" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_observations_counter_cache_source')" id="l_method-c-update_observations_counter_cache_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_observations_counter_cache_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1323</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_observations_counter_cache</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">1324</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">1325</span>   <span class="ruby-identifier">result</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">1326</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">1327</span>       { <span class="ruby-value">bool:</span> { <span class="ruby-value">must:</span> [
<span class="line-num">1328</span>         { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;user.id.keyword&quot;:</span> <span class="ruby-identifier">user_id</span> } },
<span class="line-num">1329</span>       ] } }
<span class="line-num">1330</span>     ],
<span class="line-num">1331</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1332</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">1333</span>   )
<span class="line-num">1334</span>   <span class="ruby-identifier">count</span> = (<span class="ruby-identifier">result</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">response</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">total</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">1335</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">observations_count:</span> <span class="ruby-identifier">count</span> )
<span class="line-num">1336</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1337</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">1338</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_species_counter_cache">
            
              <b>update_species_counter_cache</b>( user, options={ } )
            
            <a href="../classes/User.html#method-c-update_species_counter_cache" name="method-c-update_species_counter_cache" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_species_counter_cache_source')" id="l_method-c-update_species_counter_cache_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_species_counter_cache_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1340</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_species_counter_cache</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span>={ } )
<span class="line-num">1341</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> )
<span class="line-num">1342</span>     <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1343</span>     <span class="ruby-identifier">u</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1344</span>     <span class="ruby-identifier">user</span> = <span class="ruby-identifier">u</span>
<span class="line-num">1345</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1346</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">1347</span>   <span class="ruby-identifier">count</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">observations_species_counts</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">0</span> ).<span class="ruby-identifier">total_results</span> <span class="ruby-keyword">rescue</span> <span class="ruby-value">0</span>
<span class="line-num">1348</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">species_count</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">count</span>
<span class="line-num">1349</span>     <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">species_count:</span> <span class="ruby-identifier">count</span> )
<span class="line-num">1350</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_indexing</span>]
<span class="line-num">1351</span>       <span class="ruby-identifier">user</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1352</span>       <span class="ruby-identifier">user</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">1353</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1354</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1355</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-active-3F">
            
              <b>active?</b>()
            
            <a href="../classes/User.html#method-i-active-3F" name="method-i-active-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-active-3F_source')" id="l_method-i-active-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-active-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">388</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">active?</span>
<span class="line-num">389</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">suspended?</span>
<span class="line-num">390</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-active_for_authentication-3F">
            
              <b>active_for_authentication?</b>()
            
            <a href="../classes/User.html#method-i-active_for_authentication-3F" name="method-i-active_for_authentication-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>This is a dangerous override in that it doesn&#39;t call super, thereby ignoring the results of all the devise modules like confirmable. We do this b/c we want all users to be able to sign in, even if unconfirmed, but not if suspended.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-active_for_authentication-3F_source')" id="l_method-i-active_for_authentication-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-active_for_authentication-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">402</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">active_for_authentication?</span>
<span class="line-num">403</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">suspended?</span>
<span class="line-num">404</span> 
<span class="line-num">405</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_without_permission?</span>
<span class="line-num">406</span> 
<span class="line-num">407</span>   <span class="ruby-keyword">true</span>
<span class="line-num">408</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-add_provider_auth">
            
              <b>add_provider_auth</b>(auth_info)
            
            <a href="../classes/User.html#method-i-add_provider_auth" name="method-i-add_provider_auth" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>add a provider_authorization to this user.</p>

<p>auth_info is the omniauth info from rack.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_provider_auth_source')" id="l_method-i-add_provider_auth_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_provider_auth_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">456</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_provider_auth</span>(<span class="ruby-identifier">auth_info</span>)
<span class="line-num">457</span>   <span class="ruby-identifier">pa</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">provider_authorizations</span>.<span class="ruby-identifier">build</span>
<span class="line-num">458</span>   <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">assign_auth_info</span>(<span class="ruby-identifier">auth_info</span>)
<span class="line-num">459</span>   <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">auth_info</span> = <span class="ruby-identifier">auth_info</span>
<span class="line-num">460</span>   <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">save</span>
<span class="line-num">461</span>   <span class="ruby-identifier">pa</span>
<span class="line-num">462</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-admin-3F">
            
              <b>admin?</b>()
            
            <a href="../classes/User.html#method-i-admin-3F" name="method-i-admin-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          
            <div class="aka">
              Alias for: <a href="User.html#method-i-is_admin-3F">is_admin?</a>
            </div>
          

          
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-allow_some_licenses">
            
              <b>allow_some_licenses</b>()
            
            <a href="../classes/User.html#method-i-allow_some_licenses" name="method-i-allow_some_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-allow_some_licenses_source')" id="l_method-i-allow_some_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-allow_some_licenses_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">434</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">allow_some_licenses</span>
<span class="line-num">435</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_observation_license</span> = <span class="ruby-constant">Shared</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseModule</span>.<span class="ruby-identifier">normalize_license_code</span>( <span class="ruby-identifier">preferred_observation_license</span> )
<span class="line-num">436</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_photo_license</span> = <span class="ruby-constant">Shared</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseModule</span>.<span class="ruby-identifier">normalize_license_code</span>( <span class="ruby-identifier">preferred_photo_license</span> )
<span class="line-num">437</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_sound_license</span> = <span class="ruby-constant">Shared</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseModule</span>.<span class="ruby-identifier">normalize_license_code</span>( <span class="ruby-identifier">preferred_sound_license</span> )
<span class="line-num">438</span>   
<span class="line-num">439</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">preferred_observation_license</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">LICENSE_CODES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">preferred_observation_license</span> )
<span class="line-num">440</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_observation_license</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">441</span>   <span class="ruby-keyword">end</span>
<span class="line-num">442</span>   
<span class="line-num">443</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">preferred_photo_license</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">LICENSE_CODES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">preferred_photo_license</span> )
<span class="line-num">444</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_photo_license</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">445</span>   <span class="ruby-keyword">end</span>
<span class="line-num">446</span> 
<span class="line-num">447</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">preferred_sound_license</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">LICENSE_CODES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">preferred_sound_license</span> )
<span class="line-num">448</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_sound_license</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">449</span>   <span class="ruby-keyword">end</span>
<span class="line-num">450</span> 
<span class="line-num">451</span>   <span class="ruby-keyword">true</span>
<span class="line-num">452</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-api_token">
            
              <b>api_token</b>()
            
            <a href="../classes/User.html#method-i-api_token" name="method-i-api_token" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-api_token_source')" id="l_method-i-api_token_source">show</a>
                

                

                
              </p>
              <div id="method-i-api_token_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">575</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">api_token</span>
<span class="line-num">576</span>   <span class="ruby-constant">JsonWebToken</span>.<span class="ruby-identifier">encode</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> )
<span class="line-num">577</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-as_indexed_json">
            
              <b>as_indexed_json</b>(options={})
            
            <a href="../classes/User.html#method-i-as_indexed_json" name="method-i-as_indexed_json" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-as_indexed_json_source')" id="l_method-i-as_indexed_json_source">show</a>
                

                

                
              </p>
              <div id="method-i-as_indexed_json_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/es_indices/user_index.rb</span>
<span class="line-num">38</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">as_indexed_json</span>(<span class="ruby-identifier">options</span>={})
<span class="line-num">39</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">40</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">41</span>     <span class="ruby-value">login:</span> <span class="ruby-identifier">login</span>,
<span class="line-num">42</span>     <span class="ruby-value">spam:</span> <span class="ruby-identifier">known_spam?</span>,
<span class="line-num">43</span>     <span class="ruby-value">suspended:</span> <span class="ruby-identifier">suspended?</span>,
<span class="line-num">44</span>     <span class="ruby-value">created_at:</span> <span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">in_time_zone</span>( <span class="ruby-string">&quot;UTC&quot;</span> )
<span class="line-num">45</span>   }
<span class="line-num">46</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">47</span>     <span class="ruby-identifier">obs_count</span> = [<span class="ruby-identifier">observations_count</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span>
<span class="line-num">48</span>     <span class="ruby-identifier">ident_count</span> = [<span class="ruby-identifier">identifications_count</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span>
<span class="line-num">49</span>     <span class="ruby-identifier">post_count</span> = [<span class="ruby-identifier">journal_posts_count</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span>
<span class="line-num">50</span>     <span class="ruby-identifier">json</span>.<span class="ruby-identifier">merge!</span>({
<span class="line-num">51</span>       <span class="ruby-value">login_autocomplete:</span> <span class="ruby-identifier">login</span>,
<span class="line-num">52</span>       <span class="ruby-value">login_exact:</span> <span class="ruby-identifier">login</span>,
<span class="line-num">53</span>       <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">54</span>       <span class="ruby-value">name_autocomplete:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">55</span>       <span class="ruby-value">orcid:</span> <span class="ruby-identifier">orcid</span>,
<span class="line-num">56</span>       <span class="ruby-value">icon:</span> <span class="ruby-identifier">icon</span>.<span class="ruby-identifier">file?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">icon</span>.<span class="ruby-identifier">url</span>(<span class="ruby-value">:thumb</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">57</span>       <span class="ruby-value">observations_count:</span> <span class="ruby-identifier">obs_count</span>,
<span class="line-num">58</span>       <span class="ruby-value">identifications_count:</span> <span class="ruby-identifier">ident_count</span>,
<span class="line-num">59</span>       <span class="ruby-value">journal_posts_count:</span> <span class="ruby-identifier">post_count</span>,
<span class="line-num">60</span>       <span class="ruby-value">activity_count:</span> <span class="ruby-identifier">obs_count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ident_count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">post_count</span>,
<span class="line-num">61</span>       <span class="ruby-value">species_count:</span> <span class="ruby-identifier">species_count</span>,
<span class="line-num">62</span>       <span class="ruby-value">universal_search_rank:</span> <span class="ruby-identifier">obs_count</span>,
<span class="line-num">63</span>       <span class="ruby-value">roles:</span> <span class="ruby-identifier">roles</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">uniq</span>,
<span class="line-num">64</span>       <span class="ruby-value">site_id:</span> <span class="ruby-identifier">site_id</span>
<span class="line-num">65</span>     })
<span class="line-num">66</span>   <span class="ruby-keyword">end</span>
<span class="line-num">67</span>   <span class="ruby-identifier">json</span>
<span class="line-num">68</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-blocked_by-3F">
            
              <b>blocked_by?</b>( user )
            
            <a href="../classes/User.html#method-i-blocked_by-3F" name="method-i-blocked_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-blocked_by-3F_source')" id="l_method-i-blocked_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-blocked_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1266</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">blocked_by?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1267</span>   <span class="ruby-identifier">user_blocks_as_blocked_user</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1268</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_suspended_by_user">
            
              <b>check_suspended_by_user</b>()
            
            <a href="../classes/User.html#method-i-check_suspended_by_user" name="method-i-check_suspended_by_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-check_suspended_by_user_source')" id="l_method-i-check_suspended_by_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-check_suspended_by_user_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">764</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_suspended_by_user</span>
<span class="line-num">765</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">suspended?</span>
<span class="line-num">766</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">suspended_by_user_id</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">767</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-child_without_permission-3F">
            
              <b>child_without_permission?</b>()
            
            <a href="../classes/User.html#method-i-child_without_permission-3F" name="method-i-child_without_permission-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-child_without_permission-3F_source')" id="l_method-i-child_without_permission-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-child_without_permission-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">392</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">child_without_permission?</span>
<span class="line-num">393</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">birthday</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">394</span>     <span class="ruby-identifier">birthday</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">13</span>.<span class="ruby-identifier">years</span>.<span class="ruby-identifier">ago</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">395</span>     <span class="ruby-constant">UserParent</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;user_id = ? AND donorbox_donor_id IS NULL&quot;</span>, <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">396</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_deleted_user">
            
              <b>create_deleted_user</b>()
            
            <a href="../classes/User.html#method-i-create_deleted_user" name="method-i-create_deleted_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_deleted_user_source')" id="l_method-i-create_deleted_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_deleted_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1140</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_deleted_user</span>
<span class="line-num">1141</span>   <span class="ruby-constant">DeletedUser</span>.<span class="ruby-identifier">create</span>(
<span class="line-num">1142</span>     <span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">id</span>,
<span class="line-num">1143</span>     <span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">login</span>,
<span class="line-num">1144</span>     <span class="ruby-value">:email</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">email</span>,
<span class="line-num">1145</span>     <span class="ruby-value">:user_created_at</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">created_at</span>,
<span class="line-num">1146</span>     <span class="ruby-value">:user_updated_at</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">updated_at</span>,
<span class="line-num">1147</span>     <span class="ruby-value">:observations_count</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">observations_count</span>
<span class="line-num">1148</span>   )
<span class="line-num">1149</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1150</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy_messages_by_suspended_user">
            
              <b>destroy_messages_by_suspended_user</b>()
            
            <a href="../classes/User.html#method-i-destroy_messages_by_suspended_user" name="method-i-destroy_messages_by_suspended_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_messages_by_suspended_user_source')" id="l_method-i-destroy_messages_by_suspended_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_messages_by_suspended_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1210</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy_messages_by_suspended_user</span>
<span class="line-num">1211</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">suspended?</span>
<span class="line-num">1212</span>   <span class="ruby-constant">Message</span>.<span class="ruby-identifier">inbox</span>.<span class="ruby-identifier">unread</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:from_user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">destroy_all</span>
<span class="line-num">1213</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1214</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy_project_rules">
            
              <b>destroy_project_rules</b>()
            
            <a href="../classes/User.html#method-i-destroy_project_rules" name="method-i-destroy_project_rules" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_project_rules_source')" id="l_method-i-destroy_project_rules_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_project_rules_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1158</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy_project_rules</span>
<span class="line-num">1159</span>   <span class="ruby-constant">ProjectObservationRule</span>.<span class="ruby-identifier">where</span>(
<span class="line-num">1160</span>     <span class="ruby-value">operand_type:</span> <span class="ruby-string">&quot;User&quot;</span>,
<span class="line-num">1161</span>     <span class="ruby-value">operand_id:</span> <span class="ruby-identifier">id</span>
<span class="line-num">1162</span>   ).<span class="ruby-identifier">destroy_all</span>
<span class="line-num">1163</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-display_donor_since">
            
              <b>display_donor_since</b>()
            
            <a href="../classes/User.html#method-i-display_donor_since" name="method-i-display_donor_since" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-display_donor_since_source')" id="l_method-i-display_donor_since_source">show</a>
                

                

                
              </p>
              <div id="method-i-display_donor_since_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1435</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">display_donor_since</span>
<span class="line-num">1436</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">prefers_monthly_supporter_badge?</span>
<span class="line-num">1437</span>   <span class="ruby-identifier">donorbox_plan_status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;active&quot;</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1438</span>     <span class="ruby-identifier">donorbox_plan_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;monthly&quot;</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1439</span>     <span class="ruby-identifier">donorbox_plan_started_at</span>
<span class="line-num">1440</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-donor-3F">
            
              <b>donor?</b>()
            
            <a href="../classes/User.html#method-i-donor-3F" name="method-i-donor-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-donor-3F_source')" id="l_method-i-donor-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-donor-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1431</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">donor?</span>
<span class="line-num">1432</span>   <span class="ruby-identifier">donorbox_donor_id</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1433</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-download_remote_icon">
            
              <b>download_remote_icon</b>()
            
            <a href="../classes/User.html#method-i-download_remote_icon" name="method-i-download_remote_icon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-download_remote_icon_source')" id="l_method-i-download_remote_icon_source">show</a>
                

                

                
              </p>
              <div id="method-i-download_remote_icon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">410</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">download_remote_icon</span>
<span class="line-num">411</span>   <span class="ruby-identifier">io</span> = <span class="ruby-identifier">open</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">icon_url</span>))
<span class="line-num">412</span>   <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>(<span class="ruby-value">10</span>) <span class="ruby-keyword">do</span>
<span class="line-num">413</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">icon</span> = (<span class="ruby-identifier">io</span>.<span class="ruby-identifier">base_uri</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;/&#39;</span>).<span class="ruby-identifier">last</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">io</span>)
<span class="line-num">414</span>   <span class="ruby-keyword">end</span>
<span class="line-num">415</span>   <span class="ruby-keyword">true</span>
<span class="line-num">416</span> <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span> <span class="ruby-comment"># catch url errors with validations instead of exceptions (Errno::ENOENT, OpenURI::HTTPError, etc...)</span>
<span class="line-num">417</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Failed to download_remote_icon for #{id}: #{e}&quot;</span>
<span class="line-num">418</span>   <span class="ruby-keyword">true</span>
<span class="line-num">419</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-email-3D">
            
              <b>email=</b>(value)
            
            <a href="../classes/User.html#method-i-email-3D" name="method-i-email-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-email-3D_source')" id="l_method-i-email-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-email-3D_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">478</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">email=</span>(<span class="ruby-identifier">value</span>)
<span class="line-num">479</span>   <span class="ruby-identifier">write_attribute</span> <span class="ruby-value">:email</span>, (<span class="ruby-identifier">value</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
<span class="line-num">480</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-email_required-3F">
            
              <b>email_required?</b>()
            
            <a href="../classes/User.html#method-i-email_required-3F" name="method-i-email_required-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>only validate_presence_of email if user hasn&#39;t auth&#39;d via a 3rd-party provider you can also force skipping email validation by setting u.skip_email_validation=true before you save (this option is necessary because the <a href="User.html"><code>User</code></a> is created before the associated <a href="ProviderAuthorization.html"><code>ProviderAuthorization</code></a>) This is not a normal validation b/c email validation happens in <a href="Devise.html"><code>Devise</code></a>, which looks for this method</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-email_required-3F_source')" id="l_method-i-email_required-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-email_required-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">365</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">email_required?</span>
<span class="line-num">366</span>   <span class="ruby-operator">!</span>(<span class="ruby-identifier">skip_email_validation</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">provider_authorizations</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
<span class="line-num">367</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-email_suppressed_in_group-3F">
            
              <b>email_suppressed_in_group?</b>( suppressed_groups )
            
            <a href="../classes/User.html#method-i-email_suppressed_in_group-3F" name="method-i-email_suppressed_in_group-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-email_suppressed_in_group-3F_source')" id="l_method-i-email_suppressed_in_group-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-email_suppressed_in_group-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">741</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">email_suppressed_in_group?</span>( <span class="ruby-identifier">suppressed_groups</span> )
<span class="line-num">742</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">suppressed_groups</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Array</span> )
<span class="line-num">743</span>     <span class="ruby-identifier">suppressed_groups</span> = [<span class="ruby-identifier">suppressed_groups</span>]
<span class="line-num">744</span>   <span class="ruby-keyword">end</span>
<span class="line-num">745</span>   <span class="ruby-identifier">unsuppressed_groups</span> = [
<span class="line-num">746</span>     <span class="ruby-constant">EmailSuppression</span><span class="ruby-operator">::</span><span class="ruby-constant">ACCOUNT_EMAILS</span>,
<span class="line-num">747</span>     <span class="ruby-constant">EmailSuppression</span><span class="ruby-operator">::</span><span class="ruby-constant">DONATION_EMAILS</span>,
<span class="line-num">748</span>     <span class="ruby-constant">EmailSuppression</span><span class="ruby-operator">::</span><span class="ruby-constant">NEWS_EMAILS</span>,
<span class="line-num">749</span>     <span class="ruby-constant">EmailSuppression</span><span class="ruby-operator">::</span><span class="ruby-constant">TRANSACTIONAL_EMAILS</span>
<span class="line-num">750</span>   ].<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span> ( <span class="ruby-identifier">suppressed_groups</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">i</span> ) }
<span class="line-num">751</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">EmailSuppression</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;email = ? AND suppression_type NOT IN (?)&quot;</span>,
<span class="line-num">752</span>     <span class="ruby-identifier">email</span>, <span class="ruby-identifier">unsuppressed_groups</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">753</span> 
<span class="line-num">754</span>   <span class="ruby-keyword">false</span>
<span class="line-num">755</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-facebook_api">
            
              <b>facebook_api</b>()
            
            <a href="../classes/User.html#method-i-facebook_api" name="method-i-facebook_api" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>returns a koala object to make (authenticated) facebook api calls e.g. @facebook_api.get_object(&#39;me&#39;) see koala docs for available methods: <a href="https://github.com/arsduo/koala">github.com/arsduo/koala</a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-facebook_api_source')" id="l_method-i-facebook_api_source">show</a>
                

                

                
              </p>
              <div id="method-i-facebook_api_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">552</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">facebook_api</span>
<span class="line-num">553</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">facebook_identity</span>
<span class="line-num">554</span>   <span class="ruby-ivar">@facebook_api</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">API</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">facebook_identity</span>.<span class="ruby-identifier">token</span>)
<span class="line-num">555</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-facebook_identity">
            
              <b>facebook_identity</b>()
            
            <a href="../classes/User.html#method-i-facebook_identity" name="method-i-facebook_identity" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>returns nil or the facebook <a href="ProviderAuthorization.html"><code>ProviderAuthorization</code></a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-facebook_identity_source')" id="l_method-i-facebook_identity_source">show</a>
                

                

                
              </p>
              <div id="method-i-facebook_identity_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">558</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">facebook_identity</span>
<span class="line-num">559</span>   <span class="ruby-ivar">@facebook_identity</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">has_provider_auth</span>(<span class="ruby-string">&#39;facebook&#39;</span>)
<span class="line-num">560</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-facebook_token">
            
              <b>facebook_token</b>()
            
            <a href="../classes/User.html#method-i-facebook_token" name="method-i-facebook_token" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-facebook_token_source')" id="l_method-i-facebook_token_source">show</a>
                

                

                
              </p>
              <div id="method-i-facebook_token_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">562</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">facebook_token</span>
<span class="line-num">563</span>   <span class="ruby-identifier">facebook_identity</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:token</span>)
<span class="line-num">564</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flagged_with">
            
              <b>flagged_with</b>( flag, options = {} )
            
            <a href="../classes/User.html#method-i-flagged_with" name="method-i-flagged_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flagged_with_source')" id="l_method-i-flagged_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-flagged_with_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1377</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flagged_with</span>( <span class="ruby-identifier">flag</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1378</span>   <span class="ruby-identifier">evaluate_new_flag_for_spam</span>( <span class="ruby-identifier">flag</span> )
<span class="line-num">1379</span>   <span class="ruby-identifier">elastic_index!</span>
<span class="line-num">1380</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">id</span> ), <span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1381</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> ), <span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1382</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> ), <span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1383</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-followees">
            
              <b>followees</b>()
            
            <a href="../classes/User.html#method-i-followees" name="method-i-followees" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-followees_source')" id="l_method-i-followees_source">show</a>
                

                

                
              </p>
              <div id="method-i-followees_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">140</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">followees</span>
<span class="line-num">141</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;friendships.user_id = ?&quot;</span>, <span class="ruby-identifier">id</span> ).
<span class="line-num">142</span>     <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN friendships ON friendships.friend_id = users.id&quot;</span> ).
<span class="line-num">143</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;friendships.following&quot;</span> ).
<span class="line-num">144</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;users.suspended_at IS NULL&quot;</span> )
<span class="line-num">145</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-followers">
            
              <b>followers</b>()
            
            <a href="../classes/User.html#method-i-followers" name="method-i-followers" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-followers_source')" id="l_method-i-followers_source">show</a>
                

                

                
              </p>
              <div id="method-i-followers_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">147</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">followers</span>
<span class="line-num">148</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;friendships.friend_id = ?&quot;</span>, <span class="ruby-identifier">id</span> ).
<span class="line-num">149</span>     <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN friendships ON friendships.user_id = users.id&quot;</span> ).
<span class="line-num">150</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;friendships.following&quot;</span> ).
<span class="line-num">151</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;users.suspended_at IS NULL&quot;</span> )
<span class="line-num">152</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-friends_observations">
            
              <b>friends_observations</b>(limit = 5)
            
            <a href="../classes/User.html#method-i-friends_observations" name="method-i-friends_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>TODO: named_scope</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-friends_observations_source')" id="l_method-i-friends_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-friends_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">499</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">friends_observations</span>(<span class="ruby-identifier">limit</span> = <span class="ruby-value">5</span>)
<span class="line-num">500</span>   <span class="ruby-identifier">obs</span> = []
<span class="line-num">501</span>   <span class="ruby-identifier">friends</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">friend</span><span class="ruby-operator">|</span>
<span class="line-num">502</span>     <span class="ruby-identifier">obs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">friend</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;created_at DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-identifier">limit</span>)
<span class="line-num">503</span>   <span class="ruby-keyword">end</span>
<span class="line-num">504</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">flatten</span>
<span class="line-num">505</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-friends_with-3F">
            
              <b>friends_with?</b>(user)
            
            <a href="../classes/User.html#method-i-friends_with-3F" name="method-i-friends_with-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-friends_with-3F_source')" id="l_method-i-friends_with-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-friends_with-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">532</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">friends_with?</span>(<span class="ruby-identifier">user</span>)
<span class="line-num">533</span>   <span class="ruby-identifier">friends</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">user</span>)
<span class="line-num">534</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-generate_csv">
            
              <b>generate_csv</b>(path, columns, options = {})
            
            <a href="../classes/User.html#method-i-generate_csv" name="method-i-generate_csv" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-generate_csv_source')" id="l_method-i-generate_csv_source">show</a>
                

                

                
              </p>
              <div id="method-i-generate_csv_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1195</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_csv</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">columns</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">1196</span>   <span class="ruby-identifier">of_names</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">observation_field_values:</span> <span class="ruby-value">:observation</span>).
<span class="line-num">1197</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.user_id = ?&quot;</span>, <span class="ruby-identifier">id</span>).
<span class="line-num">1198</span>     <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;DISTINCT observation_fields.name&quot;</span>).
<span class="line-num">1199</span>     <span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">of</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;field:#{of.normalized_name}&quot;</span>}
<span class="line-num">1200</span>   <span class="ruby-identifier">columns</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">of_names</span>
<span class="line-num">1201</span>   <span class="ruby-identifier">columns</span> <span class="ruby-operator">-=</span> <span class="ruby-node">%w(user_id user_login)</span>
<span class="line-num">1202</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">path</span>, <span class="ruby-string">&#39;w&#39;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">1203</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">columns</span>
<span class="line-num">1204</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>, {<span class="ruby-value">:observation_field_values</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:observation_field</span>}).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">1205</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">columns</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">c</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>}
<span class="line-num">1206</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1207</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1208</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_lat_lon_from_ip">
            
              <b>get_lat_lon_from_ip</b>()
            
            <a href="../classes/User.html#method-i-get_lat_lon_from_ip" name="method-i-get_lat_lon_from_ip" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_lat_lon_from_ip_source')" id="l_method-i-get_lat_lon_from_ip_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_lat_lon_from_ip_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">712</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_lat_lon_from_ip</span>
<span class="line-num">713</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_ip</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">714</span>   <span class="ruby-identifier">latitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">715</span>   <span class="ruby-identifier">longitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">716</span>   <span class="ruby-identifier">lat_lon_acc_admin_level</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">717</span>   <span class="ruby-identifier">geoip_response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">geoip_lookup</span>( { <span class="ruby-value">ip:</span> <span class="ruby-identifier">last_ip</span> } )
<span class="line-num">718</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoip_response</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">geoip_response</span>.<span class="ruby-identifier">results</span>
<span class="line-num">719</span>     <span class="ruby-comment"># don&#39;t set any location if the country is unknown</span>
<span class="line-num">720</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoip_response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">country</span>
<span class="line-num">721</span>       <span class="ruby-identifier">ll</span> = <span class="ruby-identifier">geoip_response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">ll</span>
<span class="line-num">722</span>       <span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">ll</span>[<span class="ruby-value">0</span>]
<span class="line-num">723</span>       <span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">ll</span>[<span class="ruby-value">1</span>]
<span class="line-num">724</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoip_response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">city</span>
<span class="line-num">725</span>         <span class="ruby-comment"># also probably know the county</span>
<span class="line-num">726</span>         <span class="ruby-identifier">lat_lon_acc_admin_level</span> = <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>
<span class="line-num">727</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">geoip_response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">region</span>
<span class="line-num">728</span>         <span class="ruby-comment"># also probably know the state</span>
<span class="line-num">729</span>         <span class="ruby-identifier">lat_lon_acc_admin_level</span> = <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>
<span class="line-num">730</span>       <span class="ruby-keyword">else</span>
<span class="line-num">731</span>         <span class="ruby-comment"># probably just know the country</span>
<span class="line-num">732</span>         <span class="ruby-identifier">lat_lon_acc_admin_level</span> = <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>
<span class="line-num">733</span>       <span class="ruby-keyword">end</span>
<span class="line-num">734</span>     <span class="ruby-keyword">end</span>
<span class="line-num">735</span>   <span class="ruby-keyword">end</span>
<span class="line-num">736</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">latitude</span>
<span class="line-num">737</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">longitude</span>
<span class="line-num">738</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lat_lon_acc_admin_level</span> = <span class="ruby-identifier">lat_lon_acc_admin_level</span>
<span class="line-num">739</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_lat_lon_from_ip_if_last_ip_changed">
            
              <b>get_lat_lon_from_ip_if_last_ip_changed</b>()
            
            <a href="../classes/User.html#method-i-get_lat_lon_from_ip_if_last_ip_changed" name="method-i-get_lat_lon_from_ip_if_last_ip_changed" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_lat_lon_from_ip_if_last_ip_changed_source')" id="l_method-i-get_lat_lon_from_ip_if_last_ip_changed_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_lat_lon_from_ip_if_last_ip_changed_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">757</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_lat_lon_from_ip_if_last_ip_changed</span>
<span class="line-num">758</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_ip</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">759</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_ip_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">760</span>     <span class="ruby-identifier">get_lat_lon_from_ip</span>
<span class="line-num">761</span>   <span class="ruby-keyword">end</span>
<span class="line-num">762</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-has_provider_auth">
            
              <b>has_provider_auth</b>(provider)
            
            <a href="../classes/User.html#method-i-has_provider_auth" name="method-i-has_provider_auth" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>test to see if this user has authorized with the given provider argument is one of: &#39;facebook&#39;, &#39;twitter&#39;, &#39;google&#39;, &#39;yahoo&#39; returns either nil or the appropriate <a href="ProviderAuthorization.html"><code>ProviderAuthorization</code></a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-has_provider_auth_source')" id="l_method-i-has_provider_auth_source">show</a>
                

                

                
              </p>
              <div id="method-i-has_provider_auth_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">467</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">has_provider_auth</span>(<span class="ruby-identifier">provider</span>)
<span class="line-num">468</span>   <span class="ruby-identifier">provider</span> = <span class="ruby-identifier">provider</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">469</span>   <span class="ruby-identifier">provider_authorizations</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> 
<span class="line-num">470</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">provider_name</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">provider</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">provider_uid</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">provider</span>)
<span class="line-num">471</span>   <span class="ruby-keyword">end</span>
<span class="line-num">472</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-has_role-3F">
            
              <b>has_role?</b>(role)
            
            <a href="../classes/User.html#method-i-has_role-3F" name="method-i-has_role-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Checks if a user has a role; returns true if they don&#39;t but are admin.  Admins are supreme beings</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-has_role-3F_source')" id="l_method-i-has_role-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-has_role-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">486</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">has_role?</span>(<span class="ruby-identifier">role</span>)
<span class="line-num">487</span>   <span class="ruby-identifier">role_list</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">roles</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>)
<span class="line-num">488</span>   <span class="ruby-identifier">role_list</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">role_list</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">JEDI_MASTER_ROLE</span>)
<span class="line-num">489</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-header_projects">
            
              <b>header_projects</b>()
            
            <a href="../classes/User.html#method-i-header_projects" name="method-i-header_projects" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-header_projects_source')" id="l_method-i-header_projects_source">show</a>
                

                

                
              </p>
              <div id="method-i-header_projects_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1470</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">header_projects</span>
<span class="line-num">1471</span>   <span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:project</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">7</span>).
<span class="line-num">1472</span>     <span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-node">&quot;(projects.user_id = #{id}) DESC, projects.updated_at ASC&quot;</span> ) ).
<span class="line-num">1473</span>     <span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">pu</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">project</span> }.<span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num">1474</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-icon_url_provided-3F">
            
              <b>icon_url_provided?</b>()
            
            <a href="../classes/User.html#method-i-icon_url_provided-3F" name="method-i-icon_url_provided-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-icon_url_provided-3F_source')" id="l_method-i-icon_url_provided-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-icon_url_provided-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">369</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">icon_url_provided?</span>
<span class="line-num">370</span>   <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">icon</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">icon_url</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">371</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-in_test_group-3F">
            
              <b>in_test_group?</b>( group )
            
            <a href="../classes/User.html#method-i-in_test_group-3F" name="method-i-in_test_group-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-in_test_group-3F_source')" id="l_method-i-in_test_group-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-in_test_group-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1373</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">in_test_group?</span>( <span class="ruby-identifier">group</span> )
<span class="line-num">1374</span>   <span class="ruby-identifier">test_groups_array</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">group</span>)
<span class="line-num">1375</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index_observations">
            
              <b>index_observations</b>()
            
            <a href="../classes/User.html#method-i-index_observations" name="method-i-index_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_observations_source')" id="l_method-i-index_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">655</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index_observations</span>
<span class="line-num">656</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(<span class="ruby-value">ids:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>(<span class="ruby-keyword">self</span>).<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:id</span>), <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">657</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index_observations_later">
            
              <b>index_observations_later</b>()
            
            <a href="../classes/User.html#method-i-index_observations_later" name="method-i-index_observations_later" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_observations_later_source')" id="l_method-i-index_observations_later_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_observations_later_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">647</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index_observations_later</span>
<span class="line-num">648</span>   <span class="ruby-identifier">delay</span>(
<span class="line-num">649</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>,
<span class="line-num">650</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::index_observations_later&quot;:</span> <span class="ruby-identifier">id</span> },
<span class="line-num">651</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;throttled&quot;</span>
<span class="line-num">652</span>   ).<span class="ruby-identifier">index_observations</span>
<span class="line-num">653</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_admin-3F">
            
              <b>is_admin?</b>()
            
            <a href="../classes/User.html#method-i-is_admin-3F" name="method-i-is_admin-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          
            <div class="aka">
              Also aliased as: <a href="User.html#method-i-admin-3F">admin?</a>
            </div>
          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_admin-3F_source')" id="l_method-i-is_admin-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_admin-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">517</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_admin?</span>
<span class="line-num">518</span>   <span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:admin</span>)
<span class="line-num">519</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_app_owner-3F">
            
              <b>is_app_owner?</b>()
            
            <a href="../classes/User.html#method-i-is_app_owner-3F" name="method-i-is_app_owner-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_app_owner-3F_source')" id="l_method-i-is_app_owner-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_app_owner-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">513</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_app_owner?</span>
<span class="line-num">514</span>   <span class="ruby-identifier">has_role?</span>( <span class="ruby-constant">Role</span><span class="ruby-operator">::</span><span class="ruby-constant">APP_OWNER</span> )
<span class="line-num">515</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_curator-3F">
            
              <b>is_curator?</b>()
            
            <a href="../classes/User.html#method-i-is_curator-3F" name="method-i-is_curator-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>TODO: named_scope / roles plugin</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_curator-3F_source')" id="l_method-i-is_curator-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_curator-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">509</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_curator?</span>
<span class="line-num">510</span>   <span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:curator</span>)
<span class="line-num">511</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_site_admin_of-3F">
            
              <b>is_site_admin_of?</b>( site )
            
            <a href="../classes/User.html#method-i-is_site_admin_of-3F" name="method-i-is_site_admin_of-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_site_admin_of-3F_source')" id="l_method-i-is_site_admin_of-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_site_admin_of-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">522</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_site_admin_of?</span>( <span class="ruby-identifier">site</span> )
<span class="line-num">523</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_admin?</span>
<span class="line-num">524</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Site</span> )
<span class="line-num">525</span>   <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">site_admins</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">sa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sa</span>.<span class="ruby-identifier">site_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">526</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-login-3D">
            
              <b>login=</b>(value)
            
            <a href="../classes/User.html#method-i-login-3D" name="method-i-login-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-login-3D_source')" id="l_method-i-login-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-login-3D_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">474</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">login=</span>(<span class="ruby-identifier">value</span>)
<span class="line-num">475</span>   <span class="ruby-identifier">write_attribute</span> <span class="ruby-value">:login</span>, (<span class="ruby-identifier">value</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
<span class="line-num">476</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-medium_user_icon_url">
            
              <b>medium_user_icon_url</b>()
            
            <a href="../classes/User.html#method-i-medium_user_icon_url" name="method-i-medium_user_icon_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-medium_user_icon_url_source')" id="l_method-i-medium_user_icon_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-medium_user_icon_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">378</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">medium_user_icon_url</span>
<span class="line-num">379</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">icon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">380</span>   <span class="ruby-node">&quot;#{FakeView.asset_url(icon.url(:medium))}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/([^\:])\/\//</span>, <span class="ruby-string">&#39;\\1/&#39;</span>)
<span class="line-num">381</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-merge">
            
              <b>merge</b>(reject)
            
            <a href="../classes/User.html#method-i-merge" name="method-i-merge" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-merge_source')" id="l_method-i-merge_source">show</a>
                

                

                
              </p>
              <div id="method-i-merge_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">659</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">merge</span>(<span class="ruby-identifier">reject</span>)
<span class="line-num">660</span>   <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Can&#39;t merge a user with itself&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span>
<span class="line-num">661</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">friend_id:</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">destroy</span> }
<span class="line-num">662</span>   <span class="ruby-identifier">merge_has_many_associations</span>(<span class="ruby-identifier">reject</span>)
<span class="line-num">663</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_PRIORITY</span>, <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::sane_destroy&quot;:</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">id</span> } ).<span class="ruby-identifier">sane_destroy</span>
<span class="line-num">664</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">merge_cleanup</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">665</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-moderated_with">
            
              <b>moderated_with</b>( moderator_action )
            
            <a href="../classes/User.html#method-i-moderated_with" name="method-i-moderated_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-moderated_with_source')" id="l_method-i-moderated_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-moderated_with_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1385</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">moderated_with</span>( <span class="ruby-identifier">moderator_action</span> )
<span class="line-num">1386</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">moderator_action</span>.<span class="ruby-identifier">action</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ModeratorAction</span><span class="ruby-operator">::</span><span class="ruby-constant">SUSPEND</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_admin?</span>
<span class="line-num">1387</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">suspended_by_user</span> = <span class="ruby-identifier">moderator_action</span>.<span class="ruby-identifier">user</span>
<span class="line-num">1388</span>     <span class="ruby-identifier">suspend!</span>
<span class="line-num">1389</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">moderator_action</span>.<span class="ruby-identifier">action</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ModeratorAction</span><span class="ruby-operator">::</span><span class="ruby-constant">UNSUSPEND</span>
<span class="line-num">1390</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">suspended_by_user</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1391</span>     <span class="ruby-identifier">unsuspend!</span>
<span class="line-num">1392</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1393</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-orcid">
            
              <b>orcid</b>()
            
            <a href="../classes/User.html#method-i-orcid" name="method-i-orcid" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-orcid_source')" id="l_method-i-orcid_source">show</a>
                

                

                
              </p>
              <div id="method-i-orcid_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">579</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">orcid</span>
<span class="line-num">580</span>   <span class="ruby-identifier">provider_authorizations</span>.
<span class="line-num">581</span>     <span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">provider_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;orcid&quot;</span> }.<span class="ruby-identifier">try</span>( <span class="ruby-value">:provider_uid</span> )
<span class="line-num">582</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-original_user_icon_url">
            
              <b>original_user_icon_url</b>()
            
            <a href="../classes/User.html#method-i-original_user_icon_url" name="method-i-original_user_icon_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-original_user_icon_url_source')" id="l_method-i-original_user_icon_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-original_user_icon_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">383</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">original_user_icon_url</span>
<span class="line-num">384</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">icon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">385</span>   <span class="ruby-node">&quot;#{FakeView.asset_url(icon.url)}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/([^\:])\/\//</span>, <span class="ruby-string">&#39;\\1/&#39;</span>)
<span class="line-num">386</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-personal_lists">
            
              <b>personal_lists</b>()
            
            <a href="../classes/User.html#method-i-personal_lists" name="method-i-personal_lists" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-personal_lists_source')" id="l_method-i-personal_lists_source">show</a>
                

                

                
              </p>
              <div id="method-i-personal_lists_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1395</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">personal_lists</span>
<span class="line-num">1396</span>   <span class="ruby-identifier">lists</span>.<span class="ruby-identifier">not_flagged_as_spam</span>.
<span class="line-num">1397</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;type = &#39;List&#39; OR type IS NULL&quot;</span>)
<span class="line-num">1398</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-picasa_client">
            
              <b>picasa_client</b>()
            
            <a href="../classes/User.html#method-i-picasa_client" name="method-i-picasa_client" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-picasa_client_source')" id="l_method-i-picasa_client_source">show</a>
                

                

                
              </p>
              <div id="method-i-picasa_client_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">544</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">picasa_client</span>
<span class="line-num">545</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">pa</span> = <span class="ruby-identifier">has_provider_auth</span>(<span class="ruby-string">&#39;google&#39;</span>))
<span class="line-num">546</span>   <span class="ruby-ivar">@picasa_client</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Picasa</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pa</span>.<span class="ruby-identifier">token</span>)
<span class="line-num">547</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-picasa_identity">
            
              <b>picasa_identity</b>()
            
            <a href="../classes/User.html#method-i-picasa_identity" name="method-i-picasa_identity" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-picasa_identity_source')" id="l_method-i-picasa_identity_source">show</a>
                

                

                
              </p>
              <div id="method-i-picasa_identity_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">566</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">picasa_identity</span>
<span class="line-num">567</span>   <span class="ruby-ivar">@picasa_identity</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">has_provider_auth</span>(<span class="ruby-string">&#39;google_oauth2&#39;</span>)
<span class="line-num">568</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-privileged_with-3F">
            
              <b>privileged_with?</b>( privilege )
            
            <a href="../classes/User.html#method-i-privileged_with-3F" name="method-i-privileged_with-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-privileged_with-3F_source')" id="l_method-i-privileged_with-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-privileged_with-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1400</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">privileged_with?</span>( <span class="ruby-identifier">privilege</span> )
<span class="line-num">1401</span>   <span class="ruby-identifier">user_privileges</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">privilege:</span> <span class="ruby-identifier">privilege</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;revoked_at IS NULL&quot;</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1402</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-published_name">
            
              <b>published_name</b>()
            
            <a href="../classes/User.html#method-i-published_name" name="method-i-published_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-published_name_source')" id="l_method-i-published_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-published_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">769</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">published_name</span>
<span class="line-num">770</span>   <span class="ruby-identifier">name</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">login</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">name</span>
<span class="line-num">771</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-recent_notifications">
            
              <b>recent_notifications</b>(options={})
            
            <a href="../classes/User.html#method-i-recent_notifications" name="method-i-recent_notifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-recent_notifications_source')" id="l_method-i-recent_notifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-recent_notifications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1242</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">recent_notifications</span>(<span class="ruby-identifier">options</span>={})
<span class="line-num">1243</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">has_subscribers</span> <span class="ruby-operator">==</span> <span class="ruby-value">:disabled</span>
<span class="line-num">1244</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">dup</span> <span class="ruby-operator">:</span> [ ]
<span class="line-num">1245</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>].<span class="ruby-identifier">dup</span> <span class="ruby-operator">:</span> [ ]
<span class="line-num">1246</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:per_page</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">10</span>
<span class="line-num">1247</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:unviewed</span>]
<span class="line-num">1248</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">viewed_subscriber_ids:</span> <span class="ruby-identifier">id</span> } }
<span class="line-num">1249</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:viewed</span>]
<span class="line-num">1250</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">viewed_subscriber_ids:</span> <span class="ruby-identifier">id</span> } }
<span class="line-num">1251</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1252</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;subscriber_ids.keyword&quot;:</span> <span class="ruby-identifier">id</span> } }
<span class="line-num">1253</span>   <span class="ruby-identifier">ops</span> = {
<span class="line-num">1254</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>],
<span class="line-num">1255</span>     <span class="ruby-value">inverse_filters:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>],
<span class="line-num">1256</span>     <span class="ruby-value">per_page:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:per_page</span>],
<span class="line-num">1257</span>     <span class="ruby-value">sort:</span> { <span class="ruby-value">id:</span> <span class="ruby-value">:desc</span> }
<span class="line-num">1258</span>   }
<span class="line-num">1259</span>   <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">elastic_paginate</span>(
<span class="line-num">1260</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:filters</span>],
<span class="line-num">1261</span>     <span class="ruby-value">inverse_filters:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:inverse_filters</span>],
<span class="line-num">1262</span>     <span class="ruby-value">per_page:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:per_page</span>],
<span class="line-num">1263</span>     <span class="ruby-value">sort:</span> { <span class="ruby-value">id:</span> <span class="ruby-value">:desc</span> })
<span class="line-num">1264</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-recent_observation_fields">
            
              <b>recent_observation_fields</b>()
            
            <a href="../classes/User.html#method-i-recent_observation_fields" name="method-i-recent_observation_fields" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-recent_observation_fields_source')" id="l_method-i-recent_observation_fields_source">show</a>
                

                

                
              </p>
              <div id="method-i-recent_observation_fields_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1365</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">recent_observation_fields</span>
<span class="line-num">1366</span>   <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">recently_used_by</span>(<span class="ruby-keyword">self</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="line-num">1367</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-recent_observations">
            
              <b>recent_observations</b>(num = 5)
            
            <a href="../classes/User.html#method-i-recent_observations" name="method-i-recent_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>TODO: named_scope</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-recent_observations_source')" id="l_method-i-recent_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-recent_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">494</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">recent_observations</span>(<span class="ruby-identifier">num</span> = <span class="ruby-value">5</span>)
<span class="line-num">495</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;created_at DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-identifier">num</span>)
<span class="line-num">496</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reindex_faved_observations_after_destroy_later">
            
              <b>reindex_faved_observations_after_destroy_later</b>()
            
            <a href="../classes/User.html#method-i-reindex_faved_observations_after_destroy_later" name="method-i-reindex_faved_observations_after_destroy_later" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reindex_faved_observations_after_destroy_later_source')" id="l_method-i-reindex_faved_observations_after_destroy_later_source">show</a>
                

                

                
              </p>
              <div id="method-i-reindex_faved_observations_after_destroy_later_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1190</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reindex_faved_observations_after_destroy_later</span>
<span class="line-num">1191</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>.<span class="ruby-identifier">reindex_faved_observations_after_destroy</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">1192</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1193</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_email_from_name">
            
              <b>remove_email_from_name</b>()
            
            <a href="../classes/User.html#method-i-remove_email_from_name" name="method-i-remove_email_from_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Apparently some people, and maybe some third-party auth providers, sometimes stick the email in the name field… which is not ok</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_email_from_name_source')" id="l_method-i-remove_email_from_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_email_from_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1406</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_email_from_name</span>
<span class="line-num">1407</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">remove_email_from_string</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> )
<span class="line-num">1408</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1409</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_oauth_access_tokens">
            
              <b>remove_oauth_access_tokens</b>()
            
            <a href="../classes/User.html#method-i-remove_oauth_access_tokens" name="method-i-remove_oauth_access_tokens" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_oauth_access_tokens_source')" id="l_method-i-remove_oauth_access_tokens_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_oauth_access_tokens_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1152</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_oauth_access_tokens</span>
<span class="line-num">1153</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">frozen?</span>
<span class="line-num">1154</span>   <span class="ruby-constant">Doorkeeper</span><span class="ruby-operator">::</span><span class="ruby-constant">AccessToken</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">resource_owner_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">delete_all</span>
<span class="line-num">1155</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-restore_access_tokens_by_suspended_user">
            
              <b>restore_access_tokens_by_suspended_user</b>()
            
            <a href="../classes/User.html#method-i-restore_access_tokens_by_suspended_user" name="method-i-restore_access_tokens_by_suspended_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-restore_access_tokens_by_suspended_user_source')" id="l_method-i-restore_access_tokens_by_suspended_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-restore_access_tokens_by_suspended_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1222</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">restore_access_tokens_by_suspended_user</span>
<span class="line-num">1223</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">suspended?</span>
<span class="line-num">1224</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_change_to_suspended_at?</span>
<span class="line-num">1225</span>     <span class="ruby-comment"># This is not an ideal solution because there are reasons to revoke a</span>
<span class="line-num">1226</span>     <span class="ruby-comment"># token that are not related to suspension, like trying to deal with a</span>
<span class="line-num">1227</span>     <span class="ruby-comment"># oauth app that&#39;s behaving badly for some reason, or a user&#39;s token is</span>
<span class="line-num">1228</span>     <span class="ruby-comment"># stolen and someone else is using it, but I&#39;m hoping those are rare</span>
<span class="line-num">1229</span>     <span class="ruby-comment"># situations that we can deal with by deleting tokens</span>
<span class="line-num">1230</span>     <span class="ruby-constant">Doorkeeper</span><span class="ruby-operator">::</span><span class="ruby-constant">AccessToken</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">resource_owner_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">revoked_at:</span> <span class="ruby-keyword">nil</span> )
<span class="line-num">1231</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1232</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1233</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-revoke_access_tokens_by_suspended_user">
            
              <b>revoke_access_tokens_by_suspended_user</b>()
            
            <a href="../classes/User.html#method-i-revoke_access_tokens_by_suspended_user" name="method-i-revoke_access_tokens_by_suspended_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-revoke_access_tokens_by_suspended_user_source')" id="l_method-i-revoke_access_tokens_by_suspended_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-revoke_access_tokens_by_suspended_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1216</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">revoke_access_tokens_by_suspended_user</span>
<span class="line-num">1217</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">suspended?</span>
<span class="line-num">1218</span>   <span class="ruby-constant">Doorkeeper</span><span class="ruby-operator">::</span><span class="ruby-constant">AccessToken</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">resource_owner_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:revoke</span>)
<span class="line-num">1219</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1220</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sane_destroy">
            
              <b>sane_destroy</b>(options = {})
            
            <a href="../classes/User.html#method-i-sane_destroy" name="method-i-sane_destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Destroying a user triggers a giant, slow, costly cascade of deletions that all occur within a transaction. This method tries to circumvent some of that madness by assigning communal assets to new users and pre-destroying some associates</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sane_destroy_source')" id="l_method-i-sane_destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-sane_destroy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num"> 882</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sane_destroy</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num"> 883</span>   <span class="ruby-identifier">start_log_timer</span> <span class="ruby-node">&quot;sane_destroy user #{id}&quot;</span>
<span class="line-num"> 884</span>   <span class="ruby-identifier">taxon_ids</span> = []
<span class="line-num"> 885</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>(<span class="ruby-string">&quot;/observations/taxonomy&quot;</span>, {<span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span>})
<span class="line-num"> 886</span>     <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&quot;id&quot;</span>]}
<span class="line-num"> 887</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 888</span>   <span class="ruby-identifier">project_ids</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">project_ids</span>
<span class="line-num"> 889</span> 
<span class="line-num"> 890</span>   <span class="ruby-comment"># delete lists without triggering most of the callbacks</span>
<span class="line-num"> 891</span>   <span class="ruby-identifier">lists</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;type = &#39;List&#39; OR type IS NULL&quot;</span>).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
<span class="line-num"> 892</span>     <span class="ruby-identifier">l</span>.<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">lt</span><span class="ruby-operator">|</span>
<span class="line-num"> 893</span>       <span class="ruby-identifier">lt</span>.<span class="ruby-identifier">skip_sync_with_parent</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 894</span>       <span class="ruby-identifier">lt</span>.<span class="ruby-identifier">skip_update_cache_columns</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 895</span>       <span class="ruby-identifier">lt</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 896</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 897</span>     <span class="ruby-identifier">l</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 898</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 899</span> 
<span class="line-num"> 900</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-keyword">self</span>, [ <span class="ruby-value">:stored_preferences</span>, <span class="ruby-value">:roles</span>, <span class="ruby-value">:flags</span> ])
<span class="line-num"> 901</span>   <span class="ruby-comment"># delete observations without onerous callbacks</span>
<span class="line-num"> 902</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">includes</span>([
<span class="line-num"> 903</span>     { <span class="ruby-value">user:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num"> 904</span>     <span class="ruby-value">:votes_for</span>,
<span class="line-num"> 905</span>     <span class="ruby-value">:flags</span>,
<span class="line-num"> 906</span>     <span class="ruby-value">:stored_preferences</span>,
<span class="line-num"> 907</span>     <span class="ruby-value">:observation_photos</span>,
<span class="line-num"> 908</span>     <span class="ruby-value">:comments</span>,
<span class="line-num"> 909</span>     <span class="ruby-value">:annotations</span>,
<span class="line-num"> 910</span>     { <span class="ruby-value">identifications:</span> [
<span class="line-num"> 911</span>       <span class="ruby-value">:taxon</span>,
<span class="line-num"> 912</span>       <span class="ruby-value">:user</span>,
<span class="line-num"> 913</span>       <span class="ruby-value">:flags</span>
<span class="line-num"> 914</span>     ] },
<span class="line-num"> 915</span>     <span class="ruby-value">:project_observations</span>,
<span class="line-num"> 916</span>     <span class="ruby-value">:quality_metrics</span>,
<span class="line-num"> 917</span>     <span class="ruby-value">:observation_field_values</span>,
<span class="line-num"> 918</span>     <span class="ruby-value">:observation_sounds</span>,
<span class="line-num"> 919</span>     <span class="ruby-value">:observation_reviews</span>,
<span class="line-num"> 920</span>     { <span class="ruby-value">listed_taxa:</span> <span class="ruby-value">:list</span> },
<span class="line-num"> 921</span>     <span class="ruby-value">:tags</span>,
<span class="line-num"> 922</span>     <span class="ruby-value">:taxon</span>,
<span class="line-num"> 923</span>     <span class="ruby-value">:quality_metrics</span>,
<span class="line-num"> 924</span>     <span class="ruby-value">:sounds</span>
<span class="line-num"> 925</span>   ]).<span class="ruby-identifier">find_each</span>(<span class="ruby-value">batch_size:</span> <span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num"> 926</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">skip_refresh_check_lists</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 927</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">skip_identifications</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 928</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 929</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span> }
<span class="line-num"> 930</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">annotations</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span> }
<span class="line-num"> 931</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 932</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 933</span> 
<span class="line-num"> 934</span>   <span class="ruby-identifier">identification_observation_ids</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span>).
<span class="line-num"> 935</span>     <span class="ruby-identifier">select</span>(<span class="ruby-value">:observation_id</span>).<span class="ruby-identifier">distinct</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:observation_id</span>)
<span class="line-num"> 936</span>   <span class="ruby-identifier">comment_observation_ids</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">parent_type:</span> <span class="ruby-string">&quot;Observation&quot;</span>).
<span class="line-num"> 937</span>     <span class="ruby-identifier">select</span>(<span class="ruby-value">:parent_id</span>).<span class="ruby-identifier">distinct</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:parent_id</span>)
<span class="line-num"> 938</span>   <span class="ruby-identifier">annotation_observation_ids</span> = <span class="ruby-constant">Annotation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">resource_type:</span> <span class="ruby-string">&quot;Observation&quot;</span>).
<span class="line-num"> 939</span>     <span class="ruby-identifier">select</span>(<span class="ruby-value">:resource_id</span>).<span class="ruby-identifier">distinct</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:resource_id</span>)
<span class="line-num"> 940</span>   <span class="ruby-identifier">unique_obs_ids</span> = ( <span class="ruby-identifier">identification_observation_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">comment_observation_ids</span> <span class="ruby-operator">+</span>
<span class="line-num"> 941</span>     <span class="ruby-identifier">annotation_observation_ids</span> ).<span class="ruby-identifier">uniq</span>
<span class="line-num"> 942</span> 
<span class="line-num"> 943</span>   <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">includes</span>([
<span class="line-num"> 944</span>     <span class="ruby-value">:observation</span>,
<span class="line-num"> 945</span>     <span class="ruby-value">:taxon</span>,
<span class="line-num"> 946</span>     <span class="ruby-value">:user</span>,
<span class="line-num"> 947</span>     <span class="ruby-value">:flags</span>
<span class="line-num"> 948</span>   ]).<span class="ruby-identifier">find_each</span>(<span class="ruby-value">batch_size:</span> <span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num"> 949</span>     <span class="ruby-identifier">i</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 950</span>     <span class="ruby-identifier">i</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 951</span>     <span class="ruby-identifier">i</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 952</span>     <span class="ruby-identifier">i</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 953</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 954</span> 
<span class="line-num"> 955</span>   <span class="ruby-identifier">identification_observation_ids</span>.<span class="ruby-identifier">in_groups_of</span>(<span class="ruby-value">100</span>, <span class="ruby-keyword">false</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obs_ids</span><span class="ruby-operator">|</span>
<span class="line-num"> 956</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">obs_ids</span>).<span class="ruby-identifier">includes</span>(
<span class="line-num"> 957</span>       { <span class="ruby-value">user:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num"> 958</span>       <span class="ruby-value">:votes_for</span>,
<span class="line-num"> 959</span>       <span class="ruby-value">:flags</span>,
<span class="line-num"> 960</span>       <span class="ruby-value">:taxon</span>,
<span class="line-num"> 961</span>       { <span class="ruby-value">photos:</span> <span class="ruby-value">:flags</span> },
<span class="line-num"> 962</span>       { <span class="ruby-value">identifications:</span> [ <span class="ruby-value">:taxon</span>, { <span class="ruby-value">user:</span> <span class="ruby-value">:flags</span> } ] },
<span class="line-num"> 963</span>       <span class="ruby-value">:quality_metrics</span>
<span class="line-num"> 964</span>     ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num"> 965</span>       <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">update_categories_for_observation</span>( <span class="ruby-identifier">o</span>, { <span class="ruby-value">skip_reload:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">skip_indexing:</span> <span class="ruby-keyword">true</span> } )
<span class="line-num"> 966</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">update_stats</span>
<span class="line-num"> 967</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 968</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num"> 969</span>       <span class="ruby-value">scope:</span> <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-identifier">obs_ids</span>),
<span class="line-num"> 970</span>       <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>
<span class="line-num"> 971</span>     )
<span class="line-num"> 972</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 973</span> 
<span class="line-num"> 974</span>   <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">find_each</span>(<span class="ruby-value">batch_size:</span> <span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num"> 975</span>     <span class="ruby-identifier">c</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 976</span>     <span class="ruby-identifier">c</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 977</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 978</span> 
<span class="line-num"> 979</span>   <span class="ruby-identifier">annotations</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:votes_for</span>).<span class="ruby-identifier">find_each</span>(<span class="ruby-value">batch_size:</span> <span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num"> 980</span>     <span class="ruby-identifier">a</span>.<span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span> }
<span class="line-num"> 981</span>     <span class="ruby-identifier">a</span>.<span class="ruby-identifier">bulk_delete</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 982</span>     <span class="ruby-identifier">a</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 983</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 984</span> 
<span class="line-num"> 985</span>   <span class="ruby-comment"># transition ownership of projects with observations, delete the rest</span>
<span class="line-num"> 986</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span>
<span class="line-num"> 987</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">manager</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">managers</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;user_id != ?&quot;</span>, <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num"> 988</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">user</span>
<span class="line-num"> 989</span>       <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">role_will_change!</span>
<span class="line-num"> 990</span>       <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">save</span>
<span class="line-num"> 991</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">save</span>
<span class="line-num"> 992</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 993</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 994</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 995</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 996</span> 
<span class="line-num"> 997</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(<span class="ruby-value">ids:</span> <span class="ruby-identifier">unique_obs_ids</span>, <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span> )
<span class="line-num"> 998</span> 
<span class="line-num"> 999</span>   <span class="ruby-comment"># delete the user</span>
<span class="line-num">1000</span>   <span class="ruby-identifier">destroy</span>
<span class="line-num">1001</span> 
<span class="line-num">1002</span>   <span class="ruby-comment"># refresh check lists with relevant taxa</span>
<span class="line-num">1003</span>   <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">in_groups_of</span>(<span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">group</span><span class="ruby-operator">|</span>
<span class="line-num">1004</span>     <span class="ruby-constant">CheckList</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">OPTIONAL_PRIORITY</span>, <span class="ruby-value">:queue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;slow&quot;</span>).<span class="ruby-identifier">refresh</span>(<span class="ruby-value">:taxa</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">compact</span>)
<span class="line-num">1005</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1006</span> 
<span class="line-num">1007</span>   <span class="ruby-identifier">end_log_timer</span>
<span class="line-num">1008</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_data_transfer_consent_at">
            
              <b>set_data_transfer_consent_at</b>()
            
            <a href="../classes/User.html#method-i-set_data_transfer_consent_at" name="method-i-set_data_transfer_consent_at" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_data_transfer_consent_at_source')" id="l_method-i-set_data_transfer_consent_at_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_data_transfer_consent_at_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1424</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_data_transfer_consent_at</span>
<span class="line-num">1425</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">data_transfer_consent</span>
<span class="line-num">1426</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">data_transfer_consent_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">1427</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1428</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1429</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_locale">
            
              <b>set_locale</b>()
            
            <a href="../classes/User.html#method-i-set_locale" name="method-i-set_locale" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_locale_source')" id="l_method-i-set_locale_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_locale_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">695</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_locale</span>
<span class="line-num">696</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">locale</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">697</span>   <span class="ruby-keyword">true</span>
<span class="line-num">698</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_observations_taxa_if_pref_changed">
            
              <b>set_observations_taxa_if_pref_changed</b>()
            
            <a href="../classes/User.html#method-i-set_observations_taxa_if_pref_changed" name="method-i-set_observations_taxa_if_pref_changed" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_observations_taxa_if_pref_changed_source')" id="l_method-i-set_observations_taxa_if_pref_changed_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_observations_taxa_if_pref_changed_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1235</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_observations_taxa_if_pref_changed</span>
<span class="line-num">1236</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">prefers_community_taxa_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1237</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">set_observations_taxa_for_user</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">1238</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1239</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1240</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_pi_consent_at">
            
              <b>set_pi_consent_at</b>()
            
            <a href="../classes/User.html#method-i-set_pi_consent_at" name="method-i-set_pi_consent_at" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_pi_consent_at_source')" id="l_method-i-set_pi_consent_at_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_pi_consent_at_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1417</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_pi_consent_at</span>
<span class="line-num">1418</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">pi_consent</span>
<span class="line-num">1419</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pi_consent_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">1420</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1421</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1422</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_time_zone">
            
              <b>set_time_zone</b>()
            
            <a href="../classes/User.html#method-i-set_time_zone" name="method-i-set_time_zone" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_time_zone_source')" id="l_method-i-set_time_zone_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_time_zone_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">700</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_time_zone</span>
<span class="line-num">701</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">702</span>   <span class="ruby-keyword">true</span>
<span class="line-num">703</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_uri">
            
              <b>set_uri</b>()
            
            <a href="../classes/User.html#method-i-set_uri" name="method-i-set_uri" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_uri_source')" id="l_method-i-set_uri_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_uri_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">705</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_uri</span>
<span class="line-num">706</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">707</span>     <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-value">uri:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">user_url</span>(<span class="ruby-identifier">id</span>))
<span class="line-num">708</span>   <span class="ruby-keyword">end</span>
<span class="line-num">709</span>   <span class="ruby-keyword">true</span>
<span class="line-num">710</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_uuid">
            
              <b>set_uuid</b>()
            
            <a href="../classes/User.html#method-i-set_uuid" name="method-i-set_uuid" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_uuid_source')" id="l_method-i-set_uuid_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_uuid_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num"> 6</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_uuid</span>
<span class="line-num"> 7</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">uuid</span>
<span class="line-num"> 8</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> = <span class="ruby-identifier">uuid</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num"> 9</span>   <span class="ruby-keyword">true</span>
<span class="line-num">10</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-strip_login">
            
              <b>strip_login</b>()
            
            <a href="../classes/User.html#method-i-strip_login" name="method-i-strip_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-strip_login_source')" id="l_method-i-strip_login_source">show</a>
                

                

                
              </p>
              <div id="method-i-strip_login_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">428</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">strip_login</span>
<span class="line-num">429</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">login</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">430</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">login</span> = <span class="ruby-identifier">login</span>.<span class="ruby-identifier">strip</span>
<span class="line-num">431</span>   <span class="ruby-keyword">true</span>
<span class="line-num">432</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-strip_name">
            
              <b>strip_name</b>()
            
            <a href="../classes/User.html#method-i-strip_name" name="method-i-strip_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-strip_name_source')" id="l_method-i-strip_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-strip_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">421</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">strip_name</span>
<span class="line-num">422</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">423</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">strip_tags</span>( <span class="ruby-identifier">name</span> ).<span class="ruby-identifier">to_s</span>
<span class="line-num">424</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[\s\n\t]+/</span>, <span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">strip</span>
<span class="line-num">425</span>   <span class="ruby-keyword">true</span>
<span class="line-num">426</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-subscribed_to-3F">
            
              <b>subscribed_to?</b>(resource)
            
            <a href="../classes/User.html#method-i-subscribed_to-3F" name="method-i-subscribed_to-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-subscribed_to-3F_source')" id="l_method-i-subscribed_to-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-subscribed_to-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1361</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">subscribed_to?</span>(<span class="ruby-identifier">resource</span>)
<span class="line-num">1362</span>   <span class="ruby-identifier">subscriptions</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">resource:</span> <span class="ruby-identifier">resource</span>).<span class="ruby-identifier">exists?</span>
<span class="line-num">1363</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxa_unobserved_before_date">
            
              <b>taxa_unobserved_before_date</b>( date, taxa = [] )
            
            <a href="../classes/User.html#method-i-taxa_unobserved_before_date" name="method-i-taxa_unobserved_before_date" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>given an array of taxa, return the taxa and ancestors that were not observed before the given date. Note that this method does not check if the taxa were observed by this user on this date</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxa_unobserved_before_date_source')" id="l_method-i-taxa_unobserved_before_date_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxa_unobserved_before_date_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1445</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxa_unobserved_before_date</span>( <span class="ruby-identifier">date</span>, <span class="ruby-identifier">taxa</span> = [] )
<span class="line-num">1446</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">1447</span>   <span class="ruby-identifier">taxa_plus_ancestor_ids</span> = ( <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) <span class="ruby-operator">+</span> <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:ancestor_ids</span> ).<span class="ruby-identifier">flatten</span> ).<span class="ruby-identifier">uniq</span>
<span class="line-num">1448</span>   <span class="ruby-identifier">taxon_counts</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">1449</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1450</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">1451</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;user.id.keyword&quot;:</span> <span class="ruby-identifier">id</span> } },
<span class="line-num">1452</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;taxon.ancestor_ids.keyword&quot;:</span> <span class="ruby-identifier">taxa_plus_ancestor_ids</span> } },
<span class="line-num">1453</span>       { <span class="ruby-value">range:</span> { <span class="ruby-value">&quot;observed_on_details.date&quot;:</span> { <span class="ruby-value">lt:</span> <span class="ruby-identifier">date</span>.<span class="ruby-identifier">to_s</span> } } }
<span class="line-num">1454</span>     ],
<span class="line-num">1455</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">1456</span>       <span class="ruby-value">distinct_taxa:</span> {
<span class="line-num">1457</span>         <span class="ruby-value">terms:</span> {
<span class="line-num">1458</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon.ancestor_ids&quot;</span>,
<span class="line-num">1459</span>           <span class="ruby-value">include:</span> <span class="ruby-identifier">taxa_plus_ancestor_ids</span>,
<span class="line-num">1460</span>           <span class="ruby-value">size:</span> <span class="ruby-identifier">taxa_plus_ancestor_ids</span>.<span class="ruby-identifier">length</span>
<span class="line-num">1461</span>         }
<span class="line-num">1462</span>       }
<span class="line-num">1463</span>     }
<span class="line-num">1464</span>   ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1465</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_counts</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1466</span>   <span class="ruby-identifier">previous_observed_taxon_ids</span> = <span class="ruby-identifier">taxon_counts</span>.<span class="ruby-identifier">distinct_taxa</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>] }
<span class="line-num">1467</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">taxa_plus_ancestor_ids</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">previous_observed_taxon_ids</span> )
<span class="line-num">1468</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-test_groups_array">
            
              <b>test_groups_array</b>()
            
            <a href="../classes/User.html#method-i-test_groups_array" name="method-i-test_groups_array" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-test_groups_array_source')" id="l_method-i-test_groups_array_source">show</a>
                

                

                
              </p>
              <div id="method-i-test_groups_array_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1369</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">test_groups_array</span>
<span class="line-num">1370</span>   <span class="ruby-identifier">test_groups</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;|&quot;</span> )
<span class="line-num">1371</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_plain_s">
            
              <b>to_plain_s</b>()
            
            <a href="../classes/User.html#method-i-to_plain_s" name="method-i-to_plain_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_plain_s_source')" id="l_method-i-to_plain_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_plain_s_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">1357</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_plain_s</span>
<span class="line-num">1358</span>   <span class="ruby-node">&quot;User #{login}&quot;</span>
<span class="line-num">1359</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../classes/User.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">528</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">529</span>   <span class="ruby-node">&quot;&lt;User #{self.id}: #{self.login}&gt;&quot;</span>
<span class="line-num">530</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-trusts-3F">
            
              <b>trusts?</b>( user )
            
            <a href="../classes/User.html#method-i-trusts-3F" name="method-i-trusts-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-trusts-3F_source')" id="l_method-i-trusts-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-trusts-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">536</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">trusts?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">537</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">538</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">539</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span>
<span class="line-num">540</span> 
<span class="line-num">541</span>   <span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">trust:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">542</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-twitter_identity">
            
              <b>twitter_identity</b>()
            
            <a href="../classes/User.html#method-i-twitter_identity" name="method-i-twitter_identity" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>returns nil or the twitter <a href="ProviderAuthorization.html"><code>ProviderAuthorization</code></a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-twitter_identity_source')" id="l_method-i-twitter_identity_source">show</a>
                

                

                
              </p>
              <div id="method-i-twitter_identity_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">571</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">twitter_identity</span>
<span class="line-num">572</span>   <span class="ruby-ivar">@twitter_identity</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">has_provider_auth</span>(<span class="ruby-string">&#39;twitter&#39;</span>)
<span class="line-num">573</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation_licenses">
            
              <b>update_observation_licenses</b>()
            
            <a href="../classes/User.html#method-i-update_observation_licenses" name="method-i-update_observation_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_licenses_source')" id="l_method-i-update_observation_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_licenses_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">584</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation_licenses</span>
<span class="line-num">585</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;true&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@make_observation_licenses_same</span>)
<span class="line-num">586</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> ).
<span class="line-num">587</span>     <span class="ruby-identifier">update_all</span>( <span class="ruby-value">license:</span> <span class="ruby-identifier">preferred_observation_license</span>, <span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">588</span>   <span class="ruby-identifier">index_observations_later</span>
<span class="line-num">589</span>   <span class="ruby-keyword">true</span>
<span class="line-num">590</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation_sites">
            
              <b>update_observation_sites</b>()
            
            <a href="../classes/User.html#method-i-update_observation_sites" name="method-i-update_observation_sites" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_sites_source')" id="l_method-i-update_observation_sites_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_sites_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">619</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation_sites</span>
<span class="line-num">620</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">update_all</span>( <span class="ruby-value">site_id:</span> <span class="ruby-identifier">site_id</span>, <span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">621</span>   <span class="ruby-comment"># update ES-indexed observations in place with update_by_query as the site_id</span>
<span class="line-num">622</span>   <span class="ruby-comment"># will not affect any other attributes that necessitate a full reindex</span>
<span class="line-num">623</span>   <span class="ruby-identifier">try_and_try_again</span>( <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">Conflict</span>, <span class="ruby-value">sleep:</span> <span class="ruby-value">1</span>, <span class="ruby-value">tries:</span> <span class="ruby-value">10</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">624</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">__elasticsearch__</span>.<span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_by_query</span>(
<span class="line-num">625</span>       <span class="ruby-value">index:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">index_name</span>,
<span class="line-num">626</span>       <span class="ruby-value">refresh:</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span>,
<span class="line-num">627</span>       <span class="ruby-value">body:</span> {
<span class="line-num">628</span>         <span class="ruby-value">query:</span> {
<span class="line-num">629</span>           <span class="ruby-value">term:</span> {
<span class="line-num">630</span>             <span class="ruby-value">&quot;user.id&quot;:</span> <span class="ruby-identifier">id</span>
<span class="line-num">631</span>           }
<span class="line-num">632</span>         },
<span class="line-num">633</span>         <span class="ruby-value">script:</span> {
<span class="line-num">634</span>           <span class="ruby-value">source:</span> <span class="ruby-string">&quot;
<span class="line-num">635</span>             if ( ctx._source.site_id != params.site_id ) {
<span class="line-num">636</span>               ctx._source.site_id = params.site_id;
<span class="line-num">637</span>             } else { ctx.op = &#39;noop&#39; }&quot;</span>,
<span class="line-num">638</span>           <span class="ruby-value">params:</span> {
<span class="line-num">639</span>             <span class="ruby-value">site_id:</span> <span class="ruby-identifier">site_id</span>
<span class="line-num">640</span>           }
<span class="line-num">641</span>         }
<span class="line-num">642</span>       }
<span class="line-num">643</span>     )
<span class="line-num">644</span>   <span class="ruby-keyword">end</span>
<span class="line-num">645</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation_sites_later">
            
              <b>update_observation_sites_later</b>()
            
            <a href="../classes/User.html#method-i-update_observation_sites_later" name="method-i-update_observation_sites_later" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_sites_later_source')" id="l_method-i-update_observation_sites_later_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_sites_later_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">611</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation_sites_later</span>
<span class="line-num">612</span>   <span class="ruby-identifier">delay</span>(
<span class="line-num">613</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>,
<span class="line-num">614</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::update_observation_sites&quot;:</span> <span class="ruby-identifier">id</span> },
<span class="line-num">615</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;throttled&quot;</span>
<span class="line-num">616</span>   ).<span class="ruby-identifier">update_observation_sites</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_change_to_site_id?</span>
<span class="line-num">617</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_photo_licenses">
            
              <b>update_photo_licenses</b>()
            
            <a href="../classes/User.html#method-i-update_photo_licenses" name="method-i-update_photo_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_photo_licenses_source')" id="l_method-i-update_photo_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_photo_licenses_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">592</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_photo_licenses</span>
<span class="line-num">593</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;true&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@make_photo_licenses_same</span>)
<span class="line-num">594</span>   <span class="ruby-identifier">number</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">license_number_for_code</span>(<span class="ruby-identifier">preferred_photo_license</span>)
<span class="line-num">595</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">number</span>
<span class="line-num">596</span>   <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;user_id = ? AND type != &#39;GoogleStreetViewPhoto&#39;&quot;</span>, <span class="ruby-identifier">id</span> ).
<span class="line-num">597</span>     <span class="ruby-identifier">update_all</span>( <span class="ruby-value">license:</span> <span class="ruby-identifier">number</span>, <span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">598</span>   <span class="ruby-identifier">index_observations_later</span>
<span class="line-num">599</span>   <span class="ruby-keyword">true</span>
<span class="line-num">600</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_sound_licenses">
            
              <b>update_sound_licenses</b>()
            
            <a href="../classes/User.html#method-i-update_sound_licenses" name="method-i-update_sound_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_sound_licenses_source')" id="l_method-i-update_sound_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_sound_licenses_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">602</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_sound_licenses</span>
<span class="line-num">603</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;true&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@make_sound_licenses_same</span>)
<span class="line-num">604</span>   <span class="ruby-identifier">number</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">license_number_for_code</span>(<span class="ruby-identifier">preferred_sound_license</span>)
<span class="line-num">605</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">number</span>
<span class="line-num">606</span>   <span class="ruby-constant">Sound</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">license:</span> <span class="ruby-identifier">number</span>, <span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">607</span>   <span class="ruby-identifier">index_observations_later</span>
<span class="line-num">608</span>   <span class="ruby-keyword">true</span>
<span class="line-num">609</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user_icon_url">
            
              <b>user_icon_url</b>()
            
            <a href="../classes/User.html#method-i-user_icon_url" name="method-i-user_icon_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_icon_url_source')" id="l_method-i-user_icon_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_icon_url_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">373</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user_icon_url</span>
<span class="line-num">374</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">icon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">375</span>   <span class="ruby-node">&quot;#{FakeView.asset_url(icon.url(:thumb))}&quot;</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/([^\:])\/\//</span>, <span class="ruby-string">&#39;\\1/&#39;</span>)
<span class="line-num">376</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-validate_email_domain_exists">
            
              <b>validate_email_domain_exists</b>()
            
            <a href="../classes/User.html#method-i-validate_email_domain_exists" name="method-i-validate_email_domain_exists" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>As noted at <a href="https://stackoverflow.com/questions/39721917/check-if-email-domain-is-valid">stackoverflow.com/questions/39721917/check-if-email-domain-is-valid</a>, this approach is probably going to have some false positives… but probably not many</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-validate_email_domain_exists_source')" id="l_method-i-validate_email_domain_exists_source">show</a>
                

                

                
              </p>
              <div id="method-i-validate_email_domain_exists_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">330</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate_email_domain_exists</span>
<span class="line-num">331</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">user_email_domain_exists_validation</span> <span class="ruby-operator">!=</span> <span class="ruby-value">:enabled</span>
<span class="line-num">332</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">email</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">333</span>   <span class="ruby-identifier">domain</span> = <span class="ruby-identifier">email</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;@&quot;</span> )[<span class="ruby-value">1</span>].<span class="ruby-identifier">strip</span>
<span class="line-num">334</span>   <span class="ruby-identifier">dns_response</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">335</span>     <span class="ruby-identifier">r</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">336</span>     <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>( <span class="ruby-value">5</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">337</span>       <span class="ruby-constant">Resolv</span><span class="ruby-operator">::</span><span class="ruby-constant">DNS</span>.<span class="ruby-identifier">open</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dns</span><span class="ruby-operator">|</span>
<span class="line-num">338</span>         <span class="ruby-identifier">r</span> = <span class="ruby-identifier">dns</span>.<span class="ruby-identifier">getresources</span>( <span class="ruby-identifier">domain</span>, <span class="ruby-constant">Resolv</span><span class="ruby-operator">::</span><span class="ruby-constant">DNS</span><span class="ruby-operator">::</span><span class="ruby-constant">Resource</span><span class="ruby-operator">::</span><span class="ruby-constant">IN</span><span class="ruby-operator">::</span><span class="ruby-constant">MX</span> )
<span class="line-num">339</span>       <span class="ruby-keyword">end</span>
<span class="line-num">340</span>     <span class="ruby-keyword">end</span>
<span class="line-num">341</span>     <span class="ruby-identifier">r</span>
<span class="line-num">342</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
<span class="line-num">343</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">344</span>       <span class="ruby-identifier">r</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">345</span>       <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-identifier">timeout</span>( <span class="ruby-value">5</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">346</span>         <span class="ruby-constant">Resolv</span><span class="ruby-operator">::</span><span class="ruby-constant">DNS</span>.<span class="ruby-identifier">open</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dns</span><span class="ruby-operator">|</span>
<span class="line-num">347</span>           <span class="ruby-identifier">r</span> = <span class="ruby-identifier">dns</span>.<span class="ruby-identifier">getresources</span>( <span class="ruby-identifier">domain</span>, <span class="ruby-constant">Resolv</span><span class="ruby-operator">::</span><span class="ruby-constant">DNS</span><span class="ruby-operator">::</span><span class="ruby-constant">Resource</span><span class="ruby-operator">::</span><span class="ruby-constant">IN</span><span class="ruby-operator">::</span><span class="ruby-constant">A</span> )
<span class="line-num">348</span>         <span class="ruby-keyword">end</span>
<span class="line-num">349</span>       <span class="ruby-keyword">end</span>
<span class="line-num">350</span>       <span class="ruby-identifier">r</span>
<span class="line-num">351</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
<span class="line-num">352</span>       <span class="ruby-identifier">r</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">353</span>     <span class="ruby-keyword">end</span>
<span class="line-num">354</span>   <span class="ruby-keyword">end</span>
<span class="line-num">355</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">dns_response</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">356</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:email</span>, <span class="ruby-value">:domain_is_not_supported</span> )
<span class="line-num">357</span>   <span class="ruby-keyword">end</span>
<span class="line-num">358</span>   <span class="ruby-keyword">true</span>
<span class="line-num">359</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-validate_email_pattern">
            
              <b>validate_email_pattern</b>()
            
            <a href="../classes/User.html#method-i-validate_email_pattern" name="method-i-validate_email_pattern" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-validate_email_pattern_source')" id="l_method-i-validate_email_pattern_source">show</a>
                

                

                
              </p>
              <div id="method-i-validate_email_pattern_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/user.rb</span>
<span class="line-num">313</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate_email_pattern</span>
<span class="line-num">314</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">banned_emails</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">315</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">email</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">316</span>   <span class="ruby-identifier">failed</span> = <span class="ruby-keyword">false</span>
<span class="line-num">317</span>   <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">banned_emails</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">banned_suffix</span><span class="ruby-operator">|</span>
<span class="line-num">318</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">failed</span>
<span class="line-num">319</span>     <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">email</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/#{banned_suffix}$/</span>)
<span class="line-num">320</span>       <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:email</span>, <span class="ruby-value">:domain_is_not_supported</span> )
<span class="line-num">321</span>       <span class="ruby-identifier">failed</span> = <span class="ruby-keyword">true</span>
<span class="line-num">322</span>     <span class="ruby-keyword">end</span>
<span class="line-num">323</span>   <span class="ruby-keyword">end</span>
<span class="line-num">324</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
