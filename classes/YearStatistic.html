<!DOCTYPE html>
<html lang="en">
<head>
    <title>YearStatistic</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["YearStatistic"]'>


    <meta property="og:title" value="YearStatistic">

  

    <meta name="keywords" content="YearStatistic class, generate_for_year, generate_for_site_year, generate_for_user_year, regenerate_existing, regenerate_defaults_for_year, tree_taxa, observations_histogram, identifications_histogram, identification_counts_by_category, identification_counts_by_iconic_taxon, obervation_counts_by_quality_grade, leaf_taxa_count, iconic_taxa_counts, popular_observations, users_helped, users_who_helped, generate_shareable_image, generate_shareable_image_obs_grid, generate_shareable_image_no_obs, end_of_month, observed_species_accumulation, publications, observations_histogram_by_created_month, users_histogram_by_created_month, observation_counts_by_country, streaks, translators, observed_taxa_counts, observed_taxa_changes, donors, max_obs_distances_for_user, est_max_obs_distances, identifications_es_base_params, time_zone_for_options, run_cmd, run_cmd">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            YearStatistic
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/models/year_statistic_rb.html">app/models/year_statistic.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-donors">donors</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-end_of_month">end_of_month</a>,
              </li>
            
              
              <li>
                <a href="#method-i-est_max_obs_distances">est_max_obs_distances</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-generate_for_site_year">generate_for_site_year</a>,
              </li>
            
              
              <li>
                <a href="#method-c-generate_for_user_year">generate_for_user_year</a>,
              </li>
            
              
              <li>
                <a href="#method-c-generate_for_year">generate_for_year</a>,
              </li>
            
              
              <li>
                <a href="#method-i-generate_shareable_image">generate_shareable_image</a>,
              </li>
            
              
              <li>
                <a href="#method-i-generate_shareable_image_no_obs">generate_shareable_image_no_obs</a>,
              </li>
            
              
              <li>
                <a href="#method-i-generate_shareable_image_obs_grid">generate_shareable_image_obs_grid</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-iconic_taxa_counts">iconic_taxa_counts</a>,
              </li>
            
              
              <li>
                <a href="#method-c-identification_counts_by_category">identification_counts_by_category</a>,
              </li>
            
              
              <li>
                <a href="#method-c-identification_counts_by_iconic_taxon">identification_counts_by_iconic_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-identifications_es_base_params">identifications_es_base_params</a>,
              </li>
            
              
              <li>
                <a href="#method-c-identifications_histogram">identifications_histogram</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-leaf_taxa_count">leaf_taxa_count</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-max_obs_distances_for_user">max_obs_distances_for_user</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-obervation_counts_by_quality_grade">obervation_counts_by_quality_grade</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observation_counts_by_country">observation_counts_by_country</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observations_histogram">observations_histogram</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observations_histogram_by_created_month">observations_histogram_by_created_month</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observed_species_accumulation">observed_species_accumulation</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observed_taxa_changes">observed_taxa_changes</a>,
              </li>
            
              
              <li>
                <a href="#method-c-observed_taxa_counts">observed_taxa_counts</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-popular_observations">popular_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-c-publications">publications</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-regenerate_defaults_for_year">regenerate_defaults_for_year</a>,
              </li>
            
              
              <li>
                <a href="#method-c-regenerate_existing">regenerate_existing</a>,
              </li>
            
              
              <li>
                <a href="#method-c-run_cmd">run_cmd</a>,
              </li>
            
              
              <li>
                <a href="#method-i-run_cmd">run_cmd</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-streaks">streaks</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-time_zone_for_options">time_zone_for_options</a>,
              </li>
            
              
              <li>
                <a href="#method-c-translators">translators</a>,
              </li>
            
              
              <li>
                <a href="#method-c-tree_taxa">tree_taxa</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-users_helped">users_helped</a>,
              </li>
            
              
              <li>
                <a href="#method-c-users_histogram_by_created_month">users_histogram_by_created_month</a>,
              </li>
            
              
              <li>
                <a href="#method-c-users_who_helped">users_who_helped</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">NUM_ES_WORKERS</td>
            <td>=</td>
            <td class="attr-value">[1, ( CONFIG.elasticsearch_hosts&amp;.size || 2 ) - 1].max</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-donors">
            
              <b>donors</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-donors" name="method-c-donors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-donors_source')" id="l_method-c-donors_source">show</a>
                

                

                
              </p>
              <div id="method-c-donors_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1521</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">donors</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1522</span>   <span class="ruby-identifier">options</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">clone</span>
<span class="line-num">1523</span>   <span class="ruby-identifier">debug</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:debug</span> )
<span class="line-num">1524</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:limit</span> )
<span class="line-num">1525</span>   <span class="ruby-identifier">donorbox_email</span> = <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">donorbox</span>.<span class="ruby-identifier">email</span>
<span class="line-num">1526</span>   <span class="ruby-identifier">donorbox_key</span> = <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">donorbox</span>.<span class="ruby-identifier">key</span>
<span class="line-num">1527</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">donorbox_key</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1528</span> 
<span class="line-num">1529</span>   <span class="ruby-identifier">page</span> = <span class="ruby-value">1</span>
<span class="line-num">1530</span>   <span class="ruby-identifier">per_page</span> = <span class="ruby-value">100</span>
<span class="line-num">1531</span>   <span class="ruby-identifier">donations</span> = []
<span class="line-num">1532</span>   <span class="ruby-identifier">donation_encountered</span> = {}
<span class="line-num">1533</span>   <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
<span class="line-num">1534</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">donations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">limit</span>
<span class="line-num">1535</span> 
<span class="line-num">1536</span>     <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;https://donorbox.org/api/v1/donations?page=#{page}&amp;per_page=#{per_page}&quot;</span>
<span class="line-num">1537</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Fetching #{url}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1538</span>     <span class="ruby-identifier">response</span> = <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>( <span class="ruby-identifier">url</span>, {
<span class="line-num">1539</span>       <span class="ruby-string">&quot;Authorization&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;Basic #{Base64.strict_encode64( &quot;#{donorbox_email}:#{donorbox_key}&quot; ).strip}&quot;</span>,
<span class="line-num">1540</span>       <span class="ruby-string">&quot;User-Agent&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;iNaturalist/Donorbox&quot;</span>
<span class="line-num">1541</span>     } )
<span class="line-num">1542</span>     <span class="ruby-identifier">json</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">response</span> )
<span class="line-num">1543</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received #{json.size} donations&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1544</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">json</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">1545</span> 
<span class="line-num">1546</span>     <span class="ruby-identifier">page_donations</span> = <span class="ruby-identifier">json</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">d</span> <span class="ruby-operator">|</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;donation_date&quot;</span>] ).<span class="ruby-identifier">year</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">year</span> }
<span class="line-num">1547</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received #{page_donations.size} donations for #{year}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1548</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_donations</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">1549</span>       <span class="ruby-identifier">page</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1550</span>       <span class="ruby-keyword">next</span>
<span class="line-num">1551</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1552</span>     <span class="ruby-identifier">page_donations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">d</span> <span class="ruby-operator">|</span>
<span class="line-num">1553</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;amount_refunded&quot;</span>].<span class="ruby-identifier">to_f</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1554</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;status&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;paid&quot;</span>
<span class="line-num">1555</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">donation_encountered</span>[<span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;id&quot;</span>]]
<span class="line-num">1556</span> 
<span class="line-num">1557</span>       <span class="ruby-identifier">donation_encountered</span>[<span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;id&quot;</span>]] = <span class="ruby-keyword">true</span>
<span class="line-num">1558</span>       <span class="ruby-identifier">net_amount_usd</span> = <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;converted_net_amount&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;converted_amount&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;amount&quot;</span>]
<span class="line-num">1559</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">net_amount_usd</span>
<span class="line-num">1560</span> 
<span class="line-num">1561</span>       <span class="ruby-identifier">donations</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1562</span>         <span class="ruby-comment"># net_amount_usd: net_amount_usd.to_f,</span>
<span class="line-num">1563</span>         <span class="ruby-value">date:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;donation_date&quot;</span>] ),
<span class="line-num">1564</span>         <span class="ruby-value">donor_id:</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;donor&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>],
<span class="line-num">1565</span>         <span class="ruby-value">recurring:</span> <span class="ruby-identifier">d</span>[<span class="ruby-string">&quot;recurring&quot;</span>]
<span class="line-num">1566</span>         <span class="ruby-comment"># monthly: d[&quot;campaign&quot;] &amp;&amp; d[&quot;campaign&quot;][&quot;name&quot;].to_s =~ /Monthly Support/</span>
<span class="line-num">1567</span>       }
<span class="line-num">1568</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1569</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{donations.size} total donations for #{year} so far&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1570</span>     <span class="ruby-identifier">page</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1571</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1572</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received #{donations.size} total donations&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1573</span>   <span class="ruby-identifier">monthly</span> = <span class="ruby-identifier">donations</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">1574</span>     <span class="ruby-identifier">key</span> = <span class="ruby-identifier">d</span>[<span class="ruby-value">:date</span>].<span class="ruby-identifier">strftime</span>( <span class="ruby-string">&quot;%Y-%m-01&quot;</span> )
<span class="line-num">1575</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">1576</span>     <span class="ruby-comment"># memo[key][:total_net_amount_usd] = memo[key][:total_net_amount_usd].to_f + d[:net_amount_usd]</span>
<span class="line-num">1577</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>][<span class="ruby-value">:total_donors</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
<span class="line-num">1578</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>][<span class="ruby-value">:total_donors</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">:donor_id</span>]
<span class="line-num">1579</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">:recurring</span>]
<span class="line-num">1580</span> 
<span class="line-num">1581</span>     <span class="ruby-comment"># memo[key][:recurring_net_amount_usd] = memo[key][:recurring_net_amount_usd].to_f + d[:net_amount_usd]</span>
<span class="line-num">1582</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>][<span class="ruby-value">:recurring_donors</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
<span class="line-num">1583</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>][<span class="ruby-value">:recurring_donors</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">:donor_id</span>]
<span class="line-num">1584</span>     <span class="ruby-comment"># if d[:monthly]</span>
<span class="line-num">1585</span>     <span class="ruby-comment">#   memo[key][:monthly_net_amount_usd] = memo[key][:monthly_net_amount_usd].to_f + d[:net_amount_usd]</span>
<span class="line-num">1586</span>     <span class="ruby-comment">#   memo[key][:monthly_donors] ||= Set.new</span>
<span class="line-num">1587</span>     <span class="ruby-comment">#   memo[key][:monthly_donors] &lt;&lt; d[:donor_id]</span>
<span class="line-num">1588</span>     <span class="ruby-comment"># end</span>
<span class="line-num">1589</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1590</span>   <span class="ruby-identifier">monthly</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">|</span>
<span class="line-num">1591</span>     <span class="ruby-identifier">d</span> = <span class="ruby-identifier">monthly</span>[<span class="ruby-identifier">key</span>]
<span class="line-num">1592</span>     {
<span class="line-num">1593</span>       <span class="ruby-value">date:</span> <span class="ruby-identifier">key</span>,
<span class="line-num">1594</span>       <span class="ruby-comment"># total_net_amount_usd: d[:total_net_amount_usd],</span>
<span class="line-num">1595</span>       <span class="ruby-value">total_donors:</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">:total_donors</span>].<span class="ruby-identifier">size</span>,
<span class="line-num">1596</span>       <span class="ruby-comment"># recurring_net_amount_usd: d[:recurring_net_amount_usd],</span>
<span class="line-num">1597</span>       <span class="ruby-value">recurring_donors:</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">:recurring_donors</span>].<span class="ruby-identifier">size</span>
<span class="line-num">1598</span>       <span class="ruby-comment"># monthly_net_amount_usd: d[:monthly_net_amount_usd],</span>
<span class="line-num">1599</span>       <span class="ruby-comment"># monthly_donors: d[:monthly_donors].size</span>
<span class="line-num">1600</span>     }
<span class="line-num">1601</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1602</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-end_of_month">
            
              <b>end_of_month</b>( date )
            
            <a href="../classes/YearStatistic.html#method-c-end_of_month" name="method-c-end_of_month" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-end_of_month_source')" id="l_method-c-end_of_month_source">show</a>
                

                

                
              </p>
              <div id="method-c-end_of_month_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">930</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">end_of_month</span>( <span class="ruby-identifier">date</span> )
<span class="line-num">931</span>   <span class="ruby-identifier">n</span> = <span class="ruby-identifier">date</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>
<span class="line-num">932</span>   <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{n.year}-#{n.month}-01&quot;</span> ) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>
<span class="line-num">933</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_for_site_year">
            
              <b>generate_for_site_year</b>( site, year )
            
            <a href="../classes/YearStatistic.html#method-c-generate_for_site_year" name="method-c-generate_for_site_year" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Generates stats for a specific network site for a single year</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_for_site_year_source')" id="l_method-c-generate_for_site_year_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_for_site_year_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">96</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_for_site_year</span>( <span class="ruby-identifier">site</span>, <span class="ruby-identifier">year</span> )
<span class="line-num">97</span>   <span class="ruby-identifier">generate_for_year</span>( <span class="ruby-identifier">year</span>, { <span class="ruby-value">site:</span> <span class="ruby-identifier">site</span> } )
<span class="line-num">98</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_for_user_year">
            
              <b>generate_for_user_year</b>( user, year )
            
            <a href="../classes/YearStatistic.html#method-c-generate_for_user_year" name="method-c-generate_for_user_year" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Generates stats for a specific user for a single year</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_for_user_year_source')" id="l_method-c-generate_for_user_year_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_for_user_year_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">101</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_for_user_year</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">year</span> )
<span class="line-num">102</span>   <span class="ruby-identifier">user</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">:</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">103</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">104</span> 
<span class="line-num">105</span>   <span class="ruby-identifier">year_statistic</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span> ).<span class="ruby-identifier">first_or_create</span>
<span class="line-num">106</span>   <span class="ruby-identifier">users_who_helped_arr</span>, <span class="ruby-identifier">total_users_who_helped</span>, <span class="ruby-identifier">total_ids_received</span> = <span class="ruby-identifier">users_who_helped</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">107</span>   <span class="ruby-identifier">users_helped_arr</span>, <span class="ruby-identifier">total_users_helped</span>, <span class="ruby-identifier">total_ids_given</span> = <span class="ruby-identifier">users_helped</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">108</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">109</span>     <span class="ruby-value">observations:</span> {
<span class="line-num">110</span>       <span class="ruby-value">quality_grade_counts:</span> <span class="ruby-identifier">obervation_counts_by_quality_grade</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">111</span>       <span class="ruby-value">month_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span>, <span class="ruby-value">d1:</span> <span class="ruby-string">&quot;1908-01-01&quot;</span> ),
<span class="line-num">112</span>       <span class="ruby-value">week_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;week&quot;</span> ),
<span class="line-num">113</span>       <span class="ruby-value">day_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ),
<span class="line-num">114</span>       <span class="ruby-value">day_last_year_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ),
<span class="line-num">115</span>       <span class="ruby-value">popular:</span> <span class="ruby-identifier">popular_observations</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">116</span>       <span class="ruby-value">streaks:</span> <span class="ruby-identifier">streaks</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> )
<span class="line-num">117</span>     },
<span class="line-num">118</span>     <span class="ruby-value">identifications:</span> {
<span class="line-num">119</span>       <span class="ruby-value">category_counts:</span> <span class="ruby-identifier">identification_counts_by_category</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">120</span>       <span class="ruby-value">month_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span> ),
<span class="line-num">121</span>       <span class="ruby-value">week_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;week&quot;</span> ),
<span class="line-num">122</span>       <span class="ruby-value">day_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ),
<span class="line-num">123</span>       <span class="ruby-value">users_helped:</span> <span class="ruby-identifier">users_helped_arr</span>,
<span class="line-num">124</span>       <span class="ruby-value">total_users_helped:</span> <span class="ruby-identifier">total_users_helped</span>,
<span class="line-num">125</span>       <span class="ruby-value">total_ids_given:</span> <span class="ruby-identifier">total_ids_given</span>,
<span class="line-num">126</span>       <span class="ruby-value">users_who_helped:</span> <span class="ruby-identifier">users_who_helped_arr</span>,
<span class="line-num">127</span>       <span class="ruby-value">total_users_who_helped:</span> <span class="ruby-identifier">total_users_who_helped</span>,
<span class="line-num">128</span>       <span class="ruby-value">total_ids_received:</span> <span class="ruby-identifier">total_ids_received</span>,
<span class="line-num">129</span>       <span class="ruby-value">iconic_taxon_counts:</span> <span class="ruby-identifier">identification_counts_by_iconic_taxon</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">130</span>     },
<span class="line-num">131</span>     <span class="ruby-value">taxa:</span> {
<span class="line-num">132</span>       <span class="ruby-value">leaf_taxa_count:</span> <span class="ruby-identifier">leaf_taxa_count</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">133</span>       <span class="ruby-value">iconic_taxa_counts:</span> <span class="ruby-identifier">iconic_taxa_counts</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">134</span>       <span class="ruby-value">tree_taxa:</span> <span class="ruby-identifier">tree_taxa</span>( <span class="ruby-identifier">year</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ),
<span class="line-num">135</span>       <span class="ruby-value">accumulation:</span> <span class="ruby-identifier">observed_species_accumulation</span>(
<span class="line-num">136</span>         <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>,
<span class="line-num">137</span>         <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>
<span class="line-num">138</span>       ),
<span class="line-num">139</span>       <span class="ruby-value">accumulation_by_date_observed:</span> <span class="ruby-identifier">observed_species_accumulation</span>(
<span class="line-num">140</span>         <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>,
<span class="line-num">141</span>         <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">142</span>         <span class="ruby-value">date_field:</span> <span class="ruby-string">&quot;observed_on&quot;</span>
<span class="line-num">143</span>       )
<span class="line-num">144</span>       <span class="ruby-comment"># observed_taxa_changes: observed_taxa_changes( year, user: user )</span>
<span class="line-num">145</span>     },
<span class="line-num">146</span>     <span class="ruby-value">growth:</span> {
<span class="line-num">147</span>       <span class="ruby-value">observations:</span> <span class="ruby-identifier">observations_histogram_by_created_month</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> )
<span class="line-num">148</span>     }
<span class="line-num">149</span>   }
<span class="line-num">150</span>   <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">data:</span> <span class="ruby-identifier">json</span> )
<span class="line-num">151</span>   <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">152</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_PRIORITY</span>,
<span class="line-num">153</span>     <span class="ruby-value">unique_hash:</span> <span class="ruby-node">&quot;YearStatistic::generate_shareable_image::#{user.id}::#{year}&quot;</span>
<span class="line-num">154</span>   ).<span class="ruby-identifier">generate_shareable_image</span>
<span class="line-num">155</span>   <span class="ruby-identifier">year_statistic</span>
<span class="line-num">156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_for_year">
            
              <b>generate_for_year</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-generate_for_year" name="method-c-generate_for_year" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Generates stats for all of iNat for a single year</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_for_year_source')" id="l_method-c-generate_for_year_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_for_year_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">31</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_for_year</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">32</span>   <span class="ruby-identifier">year_statistic</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;user_id IS NULL&quot;</span> )
<span class="line-num">33</span>   <span class="ruby-identifier">year_statistic</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>]
<span class="line-num">34</span>     <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">site_id:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">35</span>   <span class="ruby-keyword">else</span>
<span class="line-num">36</span>     <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;site_id IS NULL&quot;</span> )
<span class="line-num">37</span>   <span class="ruby-keyword">end</span>
<span class="line-num">38</span>   <span class="ruby-identifier">year_statistic</span> = <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">first_or_create</span>
<span class="line-num">39</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">40</span>     <span class="ruby-value">observations:</span> {
<span class="line-num">41</span>       <span class="ruby-value">quality_grade_counts:</span> <span class="ruby-identifier">obervation_counts_by_quality_grade</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> ),
<span class="line-num">42</span>       <span class="ruby-value">month_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span>, <span class="ruby-value">d1:</span> <span class="ruby-string">&quot;1908-01-01&quot;</span> ) ),
<span class="line-num">43</span>       <span class="ruby-value">week_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;week&quot;</span> ) ),
<span class="line-num">44</span>       <span class="ruby-value">day_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ) ),
<span class="line-num">45</span>       <span class="ruby-value">day_last_year_histogram:</span> <span class="ruby-identifier">observations_histogram</span>( <span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ) ),
<span class="line-num">46</span>       <span class="ruby-value">popular:</span> <span class="ruby-identifier">popular_observations</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">47</span>     },
<span class="line-num">48</span>     <span class="ruby-value">identifications:</span> {
<span class="line-num">49</span>       <span class="ruby-value">category_counts:</span> <span class="ruby-identifier">identification_counts_by_category</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> ),
<span class="line-num">50</span>       <span class="ruby-value">month_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span> ) ),
<span class="line-num">51</span>       <span class="ruby-value">week_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;week&quot;</span> ) ),
<span class="line-num">52</span>       <span class="ruby-value">day_histogram:</span> <span class="ruby-identifier">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span> ) )
<span class="line-num">53</span>     },
<span class="line-num">54</span>     <span class="ruby-value">taxa:</span> {
<span class="line-num">55</span>       <span class="ruby-value">leaf_taxa_count:</span> <span class="ruby-identifier">leaf_taxa_count</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> ),
<span class="line-num">56</span>       <span class="ruby-value">iconic_taxa_counts:</span> <span class="ruby-identifier">iconic_taxa_counts</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> ),
<span class="line-num">57</span>       <span class="ruby-value">accumulation:</span> <span class="ruby-identifier">observed_species_accumulation</span>(
<span class="line-num">58</span>         <span class="ruby-value">site:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>],
<span class="line-num">59</span>         <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>
<span class="line-num">60</span>       )
<span class="line-num">61</span>     },
<span class="line-num">62</span>     <span class="ruby-value">growth:</span> {
<span class="line-num">63</span>       <span class="ruby-value">observations:</span> <span class="ruby-identifier">observations_histogram_by_created_month</span>( <span class="ruby-identifier">options</span> ),
<span class="line-num">64</span>       <span class="ruby-value">users:</span> <span class="ruby-identifier">users_histogram_by_created_month</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">65</span>     },
<span class="line-num">66</span>     <span class="ruby-value">translators:</span> <span class="ruby-identifier">translators</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">67</span>   }
<span class="line-num">68</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">69</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:publications</span>] = <span class="ruby-identifier">publications</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">70</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:growth</span>][<span class="ruby-value">:countries</span>] = <span class="ruby-identifier">observation_counts_by_country</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">71</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">year</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2021</span>
<span class="line-num">72</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:budget</span>] = {
<span class="line-num">73</span>         <span class="ruby-value">donors:</span> <span class="ruby-identifier">donors</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">74</span>       }
<span class="line-num">75</span>     <span class="ruby-keyword">end</span>
<span class="line-num">76</span>   <span class="ruby-keyword">end</span>
<span class="line-num">77</span>   <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">data:</span> <span class="ruby-identifier">json</span> )
<span class="line-num">78</span>   <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">generate_shareable_image</span>
<span class="line-num">79</span> 
<span class="line-num">80</span>   <span class="ruby-comment"># Streaks are the longest-running and most memory intensive piece to</span>
<span class="line-num">81</span>   <span class="ruby-comment"># calculate, and are probably not sustainable for the whole site in the</span>
<span class="line-num">82</span>   <span class="ruby-comment"># long term. In 2021, it doesn&#39;t seem like any available production</span>
<span class="line-num">83</span>   <span class="ruby-comment"># machine has enough memory to do it for all users. Putting it here</span>
<span class="line-num">84</span>   <span class="ruby-comment"># ensures that everything else gets calculated first, and if streaks</span>
<span class="line-num">85</span>   <span class="ruby-comment"># fail, they don&#39;t take down everything else. They&#39;re also pretty boring</span>
<span class="line-num">86</span>   <span class="ruby-comment"># as of 2021 since it&#39;s basically just a lot of people on year+ long</span>
<span class="line-num">87</span>   <span class="ruby-comment"># streaks. Yet another thing I never should have built...</span>
<span class="line-num">88</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">year</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2021</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">89</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:observations</span>][<span class="ruby-value">:streaks</span>] = <span class="ruby-identifier">streaks</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">90</span>     <span class="ruby-identifier">year_statistic</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">data:</span> <span class="ruby-identifier">json</span> )
<span class="line-num">91</span>   <span class="ruby-keyword">end</span>
<span class="line-num">92</span>   <span class="ruby-identifier">year_statistic</span>
<span class="line-num">93</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-iconic_taxa_counts">
            
              <b>iconic_taxa_counts</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-iconic_taxa_counts" name="method-c-iconic_taxa_counts" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-iconic_taxa_counts_source')" id="l_method-c-iconic_taxa_counts_source">show</a>
                

                

                
              </p>
              <div id="method-c-iconic_taxa_counts_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">342</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">iconic_taxa_counts</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">343</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span> }
<span class="line-num">344</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">345</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">346</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">347</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">348</span>     <span class="ruby-keyword">else</span>
<span class="line-num">349</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">350</span>     <span class="ruby-keyword">end</span>
<span class="line-num">351</span>   <span class="ruby-keyword">end</span>
<span class="line-num">352</span>   <span class="ruby-identifier">elastic_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">params</span> )
<span class="line-num">353</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">354</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">355</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">356</span>       <span class="ruby-value">iconic_taxa:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon.iconic_taxon_id&quot;</span> } }
<span class="line-num">357</span>     }
<span class="line-num">358</span>   ) ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">iconic_taxa</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">359</span>     <span class="ruby-identifier">key</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA_BY_ID</span>[<span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:name</span> )
<span class="line-num">360</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">361</span>   <span class="ruby-keyword">end</span>
<span class="line-num">362</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-identification_counts_by_category">
            
              <b>identification_counts_by_category</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-identification_counts_by_category" name="method-c-identification_counts_by_category" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-identification_counts_by_category_source')" id="l_method-c-identification_counts_by_category_source">show</a>
                

                

                
              </p>
              <div id="method-c-identification_counts_by_category_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">267</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">identification_counts_by_category</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">268</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> ).<span class="ruby-identifier">merge</span>(
<span class="line-num">269</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">270</span>       <span class="ruby-value">categories:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;category&quot;</span> } }
<span class="line-num">271</span>     }
<span class="line-num">272</span>   )
<span class="line-num">273</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">274</span>     <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;user.id&quot;:</span> [<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span>] } }
<span class="line-num">275</span>   <span class="ruby-keyword">end</span>
<span class="line-num">276</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">277</span>     <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">278</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;observation.place_ids&quot;:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">279</span>     <span class="ruby-keyword">else</span>
<span class="line-num">280</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;observation.site_id&quot;:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">281</span>     <span class="ruby-keyword">end</span>
<span class="line-num">282</span>   <span class="ruby-keyword">end</span>
<span class="line-num">283</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.
<span class="line-num">284</span>     <span class="ruby-identifier">categories</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">285</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>]] = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">286</span>   <span class="ruby-keyword">end</span>
<span class="line-num">287</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-identification_counts_by_iconic_taxon">
            
              <b>identification_counts_by_iconic_taxon</b>( year, user )
            
            <a href="../classes/YearStatistic.html#method-c-identification_counts_by_iconic_taxon" name="method-c-identification_counts_by_iconic_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-identification_counts_by_iconic_taxon_source')" id="l_method-c-identification_counts_by_iconic_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-c-identification_counts_by_iconic_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">289</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">identification_counts_by_iconic_taxon</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">290</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">291</span> 
<span class="line-num">292</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-identifier">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">293</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;user.id&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">294</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:aggregate</span>] = {
<span class="line-num">295</span>     <span class="ruby-value">iconic_taxa:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon.iconic_taxon_id&quot;</span> } }
<span class="line-num">296</span>   }
<span class="line-num">297</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">iconic_taxa</span>.
<span class="line-num">298</span>     <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">299</span>     <span class="ruby-comment"># memo[bucket[&quot;key&quot;]] = bucket.doc_count</span>
<span class="line-num">300</span>     <span class="ruby-comment"># memo</span>
<span class="line-num">301</span>     <span class="ruby-identifier">key</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA_BY_ID</span>[<span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:name</span> )
<span class="line-num">302</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">303</span>   <span class="ruby-keyword">end</span>
<span class="line-num">304</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-identifications_es_base_params">
            
              <b>identifications_es_base_params</b>( year )
            
            <a href="../classes/YearStatistic.html#method-c-identifications_es_base_params" name="method-c-identifications_es_base_params" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-identifications_es_base_params_source')" id="l_method-c-identifications_es_base_params_source">show</a>
                

                

                
              </p>
              <div id="method-c-identifications_es_base_params_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1709</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">1710</span>   {
<span class="line-num">1711</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1712</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">1713</span>       { <span class="ruby-value">range:</span> { <span class="ruby-value">created_at:</span> { <span class="ruby-value">gte:</span> <span class="ruby-node">&quot;#{year}-01-01&quot;</span> } } },
<span class="line-num">1714</span>       { <span class="ruby-value">range:</span> { <span class="ruby-value">created_at:</span> { <span class="ruby-value">lte:</span> <span class="ruby-node">&quot;#{year}-12-31&quot;</span> } } },
<span class="line-num">1715</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">own_observation:</span> [<span class="ruby-keyword">false</span>] } },
<span class="line-num">1716</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;observation.quality_grade&quot;:</span> [<span class="ruby-string">&quot;research&quot;</span>, <span class="ruby-string">&quot;needs_id&quot;</span>] } },
<span class="line-num">1717</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">current:</span> [<span class="ruby-keyword">true</span>] } }
<span class="line-num">1718</span>     ],
<span class="line-num">1719</span>     <span class="ruby-value">inverse_filters:</span> [
<span class="line-num">1720</span>       { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon_change_id&quot;</span> } }
<span class="line-num">1721</span>     ]
<span class="line-num">1722</span>   }
<span class="line-num">1723</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-identifications_histogram">
            
              <b>identifications_histogram</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-identifications_histogram" name="method-c-identifications_histogram" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-identifications_histogram_source')" id="l_method-c-identifications_histogram_source">show</a>
                

                

                
              </p>
              <div id="method-c-identifications_histogram_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">236</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">identifications_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">237</span>   <span class="ruby-identifier">interval</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:interval</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;day&quot;</span>
<span class="line-num">238</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> ).<span class="ruby-identifier">merge</span>(
<span class="line-num">239</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">240</span>       <span class="ruby-value">histogram:</span> {
<span class="line-num">241</span>         <span class="ruby-value">date_histogram:</span> {
<span class="line-num">242</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;created_at&quot;</span>,
<span class="line-num">243</span>           <span class="ruby-value">interval:</span> <span class="ruby-identifier">interval</span>,
<span class="line-num">244</span>           <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM-dd&quot;</span>,
<span class="line-num">245</span>           <span class="ruby-value">time_zone:</span> <span class="ruby-identifier">time_zone_for_options</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">246</span>         }
<span class="line-num">247</span>       }
<span class="line-num">248</span>     }
<span class="line-num">249</span>   )
<span class="line-num">250</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">251</span>     <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;user.id&quot;:</span> [<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span>] } }
<span class="line-num">252</span>   <span class="ruby-keyword">end</span>
<span class="line-num">253</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">254</span>     <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">255</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;observation.place_ids&quot;:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">256</span>     <span class="ruby-keyword">else</span>
<span class="line-num">257</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;observation.site_id&quot;:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">258</span>     <span class="ruby-keyword">end</span>
<span class="line-num">259</span>   <span class="ruby-keyword">end</span>
<span class="line-num">260</span>   <span class="ruby-identifier">histogram</span> = {}
<span class="line-num">261</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">histogram</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">|</span>
<span class="line-num">262</span>     <span class="ruby-identifier">histogram</span>[<span class="ruby-identifier">b</span>.<span class="ruby-identifier">key_as_string</span>] = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">263</span>   <span class="ruby-keyword">end</span>
<span class="line-num">264</span>   <span class="ruby-identifier">histogram</span>
<span class="line-num">265</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-leaf_taxa_count">
            
              <b>leaf_taxa_count</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-leaf_taxa_count" name="method-c-leaf_taxa_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-leaf_taxa_count_source')" id="l_method-c-leaf_taxa_count_source">show</a>
                

                

                
              </p>
              <div id="method-c-leaf_taxa_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">327</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">leaf_taxa_count</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">328</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span> }
<span class="line-num">329</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">330</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">331</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">332</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">333</span>     <span class="ruby-keyword">else</span>
<span class="line-num">334</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">335</span>     <span class="ruby-keyword">end</span>
<span class="line-num">336</span>   <span class="ruby-keyword">end</span>
<span class="line-num">337</span>   <span class="ruby-comment"># Observation.elastic_taxon_leaf_counts( Observation.params_to_elastic_query( params ) ).size</span>
<span class="line-num">338</span>   <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-string">&quot;/observations/species_counts&quot;</span>, <span class="ruby-identifier">params</span>,
<span class="line-num">339</span>     { <span class="ruby-value">timeout:</span> <span class="ruby-value">30</span> } ) )[<span class="ruby-string">&quot;total_results&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">340</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-obervation_counts_by_quality_grade">
            
              <b>obervation_counts_by_quality_grade</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-obervation_counts_by_quality_grade" name="method-c-obervation_counts_by_quality_grade" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-obervation_counts_by_quality_grade_source')" id="l_method-c-obervation_counts_by_quality_grade_source">show</a>
                

                

                
              </p>
              <div id="method-c-obervation_counts_by_quality_grade_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">306</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">obervation_counts_by_quality_grade</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">307</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span> }
<span class="line-num">308</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">309</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">310</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">311</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">312</span>     <span class="ruby-keyword">else</span>
<span class="line-num">313</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">314</span>     <span class="ruby-keyword">end</span>
<span class="line-num">315</span>   <span class="ruby-keyword">end</span>
<span class="line-num">316</span>   <span class="ruby-identifier">elastic_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">params</span> )
<span class="line-num">317</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">318</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">319</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">320</span>       <span class="ruby-value">quality_grades:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;quality_grade&quot;</span> } }
<span class="line-num">321</span>     }
<span class="line-num">322</span>   ) ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">quality_grades</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">323</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>]] = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">324</span>   <span class="ruby-keyword">end</span>
<span class="line-num">325</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observation_counts_by_country">
            
              <b>observation_counts_by_country</b>( year, _params = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observation_counts_by_country" name="method-c-observation_counts_by_country" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observation_counts_by_country_source')" id="l_method-c-observation_counts_by_country_source">show</a>
                

                

                
              </p>
              <div id="method-c-observation_counts_by_country_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1159</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observation_counts_by_country</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">_params</span> = {} )
<span class="line-num">1160</span>   <span class="ruby-constant">Place</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">admin_level:</span> <span class="ruby-value">0</span> ).<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each_with_object</span>( [] ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">1161</span>     <span class="ruby-identifier">r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">observations</span>( <span class="ruby-value">per_page:</span> <span class="ruby-value">0</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1162</span>       <span class="ruby-value">created_d1:</span> <span class="ruby-node">&quot;#{year}-01-01&quot;</span>,
<span class="line-num">1163</span>       <span class="ruby-value">created_d2:</span> <span class="ruby-node">&quot;#{year}-12-31&quot;</span>,
<span class="line-num">1164</span>       <span class="ruby-value">place_id:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1165</span>     <span class="ruby-identifier">year_count</span> = <span class="ruby-identifier">r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">total_results</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">1166</span>     <span class="ruby-identifier">r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">observations</span>( <span class="ruby-value">per_page:</span> <span class="ruby-value">0</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1167</span>       <span class="ruby-value">created_d1:</span> <span class="ruby-node">&quot;#{year - 1}-01-01&quot;</span>,
<span class="line-num">1168</span>       <span class="ruby-value">created_d2:</span> <span class="ruby-node">&quot;#{year - 1}-12-31&quot;</span>,
<span class="line-num">1169</span>       <span class="ruby-value">place_id:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1170</span>     <span class="ruby-identifier">last_year_count</span> = <span class="ruby-identifier">r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">total_results</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">1171</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">year_count</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
<span class="line-num">1172</span> 
<span class="line-num">1173</span>     <span class="ruby-identifier">memo</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1174</span>       <span class="ruby-value">place_id:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">1175</span>       <span class="ruby-value">place_code:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">code</span>,
<span class="line-num">1176</span>       <span class="ruby-value">place_bounding_box:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bounding_box</span>,
<span class="line-num">1177</span>       <span class="ruby-value">name:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">name</span>,
<span class="line-num">1178</span>       <span class="ruby-value">observations:</span> <span class="ruby-identifier">year_count</span>,
<span class="line-num">1179</span>       <span class="ruby-value">observations_last_year:</span> <span class="ruby-identifier">last_year_count</span>
<span class="line-num">1180</span>     }
<span class="line-num">1181</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1182</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observations_histogram">
            
              <b>observations_histogram</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observations_histogram" name="method-c-observations_histogram" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observations_histogram_source')" id="l_method-c-observations_histogram_source">show</a>
                

                

                
              </p>
              <div id="method-c-observations_histogram_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">215</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observations_histogram</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">216</span>   <span class="ruby-identifier">params</span> = {
<span class="line-num">217</span>     <span class="ruby-value">d1:</span> <span class="ruby-node">&quot;#{year}-01-01&quot;</span>,
<span class="line-num">218</span>     <span class="ruby-value">d2:</span> <span class="ruby-node">&quot;#{year}-12-31&quot;</span>,
<span class="line-num">219</span>     <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;day&quot;</span>,
<span class="line-num">220</span>     <span class="ruby-value">quality_grade:</span> <span class="ruby-string">&quot;research,needs_id&quot;</span>
<span class="line-num">221</span>   }.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">222</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] )
<span class="line-num">223</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">224</span>   <span class="ruby-keyword">end</span>
<span class="line-num">225</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">226</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">227</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">228</span>     <span class="ruby-keyword">else</span>
<span class="line-num">229</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">230</span>     <span class="ruby-keyword">end</span>
<span class="line-num">231</span>   <span class="ruby-keyword">end</span>
<span class="line-num">232</span>   <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-string">&quot;/observations/histogram&quot;</span>, <span class="ruby-identifier">params</span>,
<span class="line-num">233</span>     { <span class="ruby-value">timeout:</span> <span class="ruby-value">30</span> } ) )[<span class="ruby-string">&quot;results&quot;</span>][<span class="ruby-identifier">params</span>[<span class="ruby-value">:interval</span>]]
<span class="line-num">234</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observations_histogram_by_created_month">
            
              <b>observations_histogram_by_created_month</b>( options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observations_histogram_by_created_month" name="method-c-observations_histogram_by_created_month" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observations_histogram_by_created_month_source')" id="l_method-c-observations_histogram_by_created_month_source">show</a>
                

                

                
              </p>
              <div id="method-c-observations_histogram_by_created_month_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1113</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observations_histogram_by_created_month</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1114</span>   <span class="ruby-identifier">filters</span> = [
<span class="line-num">1115</span>     { <span class="ruby-value">terms:</span> { <span class="ruby-value">quality_grade:</span> [<span class="ruby-string">&quot;research&quot;</span>, <span class="ruby-string">&quot;needs_id&quot;</span>] } }
<span class="line-num">1116</span>   ]
<span class="line-num">1117</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">1118</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">1119</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">place_ids:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">1120</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1121</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">site_id:</span> [<span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">1122</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1123</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1124</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] )
<span class="line-num">1125</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-string">&quot;user.id&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> } }
<span class="line-num">1126</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1127</span>   <span class="ruby-identifier">es_params</span> = {
<span class="line-num">1128</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1129</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>,
<span class="line-num">1130</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">1131</span>       <span class="ruby-value">histogram:</span> {
<span class="line-num">1132</span>         <span class="ruby-value">date_histogram:</span> {
<span class="line-num">1133</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;created_at_details.date&quot;</span>,
<span class="line-num">1134</span>           <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span>,
<span class="line-num">1135</span>           <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM-dd&quot;</span>,
<span class="line-num">1136</span>           <span class="ruby-value">time_zone:</span> <span class="ruby-identifier">time_zone_for_options</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">1137</span>         }
<span class="line-num">1138</span>       }
<span class="line-num">1139</span>     }
<span class="line-num">1140</span>   }
<span class="line-num">1141</span>   <span class="ruby-identifier">histogram</span> = {}
<span class="line-num">1142</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">histogram</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">|</span>
<span class="line-num">1143</span>     <span class="ruby-identifier">histogram</span>[<span class="ruby-identifier">b</span>.<span class="ruby-identifier">key_as_string</span>] = <span class="ruby-identifier">b</span>.<span class="ruby-identifier">doc_count</span>
<span class="line-num">1144</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1145</span>   <span class="ruby-identifier">histogram</span>
<span class="line-num">1146</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observed_species_accumulation">
            
              <b>observed_species_accumulation</b>( params = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observed_species_accumulation" name="method-c-observed_species_accumulation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observed_species_accumulation_source')" id="l_method-c-observed_species_accumulation_source">show</a>
                

                

                
              </p>
              <div id="method-c-observed_species_accumulation_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num"> 935</span>   <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observed_species_accumulation</span>( <span class="ruby-identifier">params</span> = {} )
<span class="line-num"> 936</span>     <span class="ruby-identifier">debug</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:debug</span> )
<span class="line-num"> 937</span>     <span class="ruby-identifier">interval</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:interval</span> ) <span class="ruby-operator">||</span> <span class="ruby-string">&quot;month&quot;</span>
<span class="line-num"> 938</span>     <span class="ruby-identifier">date_field</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:date_field</span> ) <span class="ruby-operator">||</span> <span class="ruby-string">&quot;created_at&quot;</span>
<span class="line-num"> 939</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:user</span>]
<span class="line-num"> 940</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:quality_grade</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:quality_grade</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;research,needs_id&quot;</span>
<span class="line-num"> 941</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:site</span>] )
<span class="line-num"> 942</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num"> 943</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num"> 944</span>       <span class="ruby-keyword">else</span>
<span class="line-num"> 945</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num"> 946</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 947</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 948</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:hrank</span>] = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES</span>
<span class="line-num"> 949</span>     <span class="ruby-identifier">elastic_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">params</span> )
<span class="line-num"> 950</span>     <span class="ruby-identifier">histogram_params</span> = <span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num"> 951</span>       <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num"> 952</span>       <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>,
<span class="line-num"> 953</span>       <span class="ruby-value">aggs:</span> {
<span class="line-num"> 954</span>         <span class="ruby-value">histogram:</span> {
<span class="line-num"> 955</span>           <span class="ruby-value">date_histogram:</span> {
<span class="line-num"> 956</span>             <span class="ruby-value">field:</span> <span class="ruby-identifier">date_field</span>,
<span class="line-num"> 957</span>             <span class="ruby-value">interval:</span> <span class="ruby-identifier">interval</span>,
<span class="line-num"> 958</span>             <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM-dd&quot;</span>,
<span class="line-num"> 959</span>             <span class="ruby-value">time_zone:</span> <span class="ruby-identifier">time_zone_for_options</span>( <span class="ruby-identifier">params</span> )
<span class="line-num"> 960</span>           },
<span class="line-num"> 961</span>           <span class="ruby-value">aggs:</span> {
<span class="line-num"> 962</span>             <span class="ruby-value">taxon_ids:</span> {
<span class="line-num"> 963</span>               <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon.min_species_ancestry&quot;</span>, <span class="ruby-value">size:</span> <span class="ruby-value">100_000</span> }
<span class="line-num"> 964</span>             }
<span class="line-num"> 965</span>           }
<span class="line-num"> 966</span>         }
<span class="line-num"> 967</span>       }
<span class="line-num"> 968</span>     )
<span class="line-num"> 969</span>     <span class="ruby-identifier">bucketer</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">es_params</span> <span class="ruby-operator">|</span>
<span class="line-num"> 970</span>       <span class="ruby-identifier">buckets</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">histogram</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num"> 971</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num"> 972</span>         <span class="ruby-identifier">d1_filter</span> = <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span>
<span class="line-num"> 973</span>           <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:gte</span>]
<span class="line-num"> 974</span>         <span class="ruby-keyword">end</span>
<span class="line-num"> 975</span>         <span class="ruby-identifier">d2_filter</span> = <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span>
<span class="line-num"> 976</span>           <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:lte</span>]
<span class="line-num"> 977</span>         <span class="ruby-keyword">end</span>
<span class="line-num"> 978</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">d1_filter</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">d2_filter</span>
<span class="line-num"> 979</span>           <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d1_filter</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:gte</span>] )
<span class="line-num"> 980</span>           <span class="ruby-identifier">d2</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d2_filter</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:lte</span>] )
<span class="line-num"> 981</span>         <span class="ruby-keyword">else</span>
<span class="line-num"> 982</span>           <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-string">&quot;2008-01-01&quot;</span> )
<span class="line-num"> 983</span>           <span class="ruby-identifier">d2</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
<span class="line-num"> 984</span>         <span class="ruby-keyword">end</span>
<span class="line-num"> 985</span>         <span class="ruby-identifier">bucket_dates</span> = <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key_as_string&quot;</span>] }.<span class="ruby-identifier">sort</span>
<span class="line-num"> 986</span>         <span class="ruby-identifier">species_ids</span> = <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span> <span class="ruby-operator">|</span>
<span class="line-num"> 987</span>           <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">|</span>
<span class="line-num"> 988</span>             <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>].<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> )
<span class="line-num"> 989</span>           <span class="ruby-keyword">end</span>
<span class="line-num"> 990</span>         <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num"> 991</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">&lt;&lt;~MSG</span>
<span class="line-num"> 992</span> <span class="ruby-value">          observed_species_accumulation results for #{d1} - #{d2}:
<span class="line-num"> 993</span>           #{buckets.size} buckets, #{bucket_dates.first} - #{bucket_dates.last},
<span class="line-num"> 994</span>           #{species_ids.size} species&quot;
<span class="line-num"> 995</span> </span><span class="ruby-identifier">        MSG</span>
<span class="line-num"> 996</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 997</span>       <span class="ruby-identifier">buckets</span>
<span class="line-num"> 998</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 999</span> 
<span class="line-num">1000</span>     <span class="ruby-identifier">histogram_buckets</span> = <span class="ruby-identifier">call_and_rescue_with_partitioner</span>(
<span class="line-num">1001</span>       <span class="ruby-identifier">bucketer</span>,
<span class="line-num">1002</span>       [<span class="ruby-identifier">histogram_params</span>],
<span class="line-num">1003</span>       [
<span class="line-num">1004</span>         <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceUnavailable</span>,
<span class="line-num">1005</span>         <span class="ruby-constant">Faraday</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeoutError</span>
<span class="line-num">1006</span>       ],
<span class="line-num">1007</span>       <span class="ruby-value">exception_checker:</span> <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/(timed out|too_many_buckets_exception)/</span> },
<span class="line-num">1008</span>       <span class="ruby-value">parallel:</span> <span class="ruby-constant">NUM_ES_WORKERS</span>
<span class="line-num">1009</span>     ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">|</span>
<span class="line-num">1010</span>       <span class="ruby-identifier">es_params</span> = <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">dup</span>
<span class="line-num">1011</span>       <span class="ruby-identifier">d1_filter</span> = <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:gte</span>] }
<span class="line-num">1012</span>       <span class="ruby-identifier">d2_filter</span> = <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:lte</span>] }
<span class="line-num">1013</span>       <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] = <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>].<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>] }
<span class="line-num">1014</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">d1_filter</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">d2_filter</span>
<span class="line-num">1015</span>         <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d1_filter</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:gte</span>] )
<span class="line-num">1016</span>         <span class="ruby-identifier">d2</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">d2_filter</span>[<span class="ruby-value">:range</span>][<span class="ruby-identifier">date_field</span>][<span class="ruby-value">:lte</span>] )
<span class="line-num">1017</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1018</span>         <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-string">&quot;2008-01-01&quot;</span> )
<span class="line-num">1019</span>         <span class="ruby-identifier">d2</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">end_of_month</span>( <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> )
<span class="line-num">1020</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1021</span>       <span class="ruby-identifier">half</span> = ( <span class="ruby-identifier">d2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">d1</span> ) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">1022</span>       <span class="ruby-identifier">d1_p1</span> = <span class="ruby-identifier">d1</span>
<span class="line-num">1023</span>       <span class="ruby-identifier">d2_p1</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">end_of_month</span>( <span class="ruby-identifier">d1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">half</span>.<span class="ruby-identifier">days</span> )
<span class="line-num">1024</span>       <span class="ruby-identifier">d1_p2</span> = <span class="ruby-identifier">d2_p1</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>
<span class="line-num">1025</span>       <span class="ruby-identifier">d2_p2</span> = <span class="ruby-identifier">d2</span>
<span class="line-num">1026</span>       <span class="ruby-identifier">es_params1</span> = <span class="ruby-identifier">es_params</span>.<span class="ruby-identifier">dup</span>
<span class="line-num">1027</span>       <span class="ruby-identifier">es_params1</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">+=</span> [
<span class="line-num">1028</span>         { <span class="ruby-value">range:</span> { <span class="ruby-identifier">date_field</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">d1_p1</span>.<span class="ruby-identifier">to_s</span> } } },
<span class="line-num">1029</span>         { <span class="ruby-value">range:</span> { <span class="ruby-identifier">date_field</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">lte:</span> <span class="ruby-identifier">d2_p1</span>.<span class="ruby-identifier">to_s</span> } } }
<span class="line-num">1030</span>       ]
<span class="line-num">1031</span>       <span class="ruby-identifier">es_params2</span> = <span class="ruby-identifier">es_params</span>.<span class="ruby-identifier">dup</span>
<span class="line-num">1032</span>       <span class="ruby-identifier">es_params2</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">+=</span> [
<span class="line-num">1033</span>         { <span class="ruby-value">range:</span> { <span class="ruby-identifier">date_field</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">d1_p2</span>.<span class="ruby-identifier">to_s</span> } } },
<span class="line-num">1034</span>         { <span class="ruby-value">range:</span> { <span class="ruby-identifier">date_field</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">lte:</span> <span class="ruby-identifier">d2_p2</span>.<span class="ruby-identifier">to_s</span> } } }
<span class="line-num">1035</span>       ]
<span class="line-num">1036</span>       <span class="ruby-identifier">new_params</span> = [<span class="ruby-identifier">es_params1</span>, <span class="ruby-identifier">es_params2</span>]
<span class="line-num">1037</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1038</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;observed_species_accumulation partitions: #{d1_p1} - #{d2_p1}, #{d1_p2} - #{d2_p2}&quot;</span>
<span class="line-num">1039</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1040</span>       <span class="ruby-identifier">new_params</span>
<span class="line-num">1041</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1042</span> 
<span class="line-num">1043</span>     <span class="ruby-identifier">accumulation_with_all_species_ids</span> = <span class="ruby-identifier">histogram_buckets</span>.<span class="ruby-identifier">each_with_index</span>.<span class="ruby-identifier">each_with_object</span>( [] ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">pair</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">1044</span>       <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">i</span> = <span class="ruby-identifier">pair</span>
<span class="line-num">1045</span>       <span class="ruby-identifier">interval_species_ids</span> = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>].<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> ) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1046</span>       <span class="ruby-identifier">interval_species_ids</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">interval_species_ids</span>, <span class="ruby-value">rank:</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES</span> ).<span class="ruby-identifier">pluck</span>( <span class="ruby-value">:id</span> )
<span class="line-num">1047</span>       <span class="ruby-identifier">accumulated_species_ids</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">positive?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
<span class="line-num">1048</span>         <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>][<span class="ruby-value">:accumulated_species_ids</span>]
<span class="line-num">1049</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1050</span>         []
<span class="line-num">1051</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1052</span>       <span class="ruby-identifier">novel_species_ids</span> = <span class="ruby-identifier">interval_species_ids</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">accumulated_species_ids</span>
<span class="line-num">1053</span>       <span class="ruby-identifier">memo</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1054</span>         <span class="ruby-value">date:</span> <span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key_as_string&quot;</span>],
<span class="line-num">1055</span>         <span class="ruby-value">accumulated_species_ids:</span> <span class="ruby-identifier">accumulated_species_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">novel_species_ids</span>,
<span class="line-num">1056</span>         <span class="ruby-value">novel_species_ids:</span> <span class="ruby-identifier">novel_species_ids</span>,
<span class="line-num">1057</span>         <span class="ruby-value">species_ids:</span> <span class="ruby-identifier">interval_species_ids</span>
<span class="line-num">1058</span>       }
<span class="line-num">1059</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1060</span>     <span class="ruby-identifier">accumulation_with_all_species_ids</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">acc_interval</span> <span class="ruby-operator">|</span>
<span class="line-num">1061</span>       {
<span class="line-num">1062</span>         <span class="ruby-value">date:</span> <span class="ruby-identifier">acc_interval</span>[<span class="ruby-value">:date</span>],
<span class="line-num">1063</span>         <span class="ruby-value">accumulated_species_count:</span> <span class="ruby-identifier">acc_interval</span>[<span class="ruby-value">:accumulated_species_ids</span>].<span class="ruby-identifier">size</span>,
<span class="line-num">1064</span>         <span class="ruby-value">novel_species_ids:</span> <span class="ruby-identifier">acc_interval</span>[<span class="ruby-value">:novel_species_ids</span>],
<span class="line-num">1065</span>         <span class="ruby-value">species_count:</span> <span class="ruby-identifier">acc_interval</span>[<span class="ruby-value">:species_ids</span>].<span class="ruby-identifier">size</span>
<span class="line-num">1066</span>       }
<span class="line-num">1067</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1068</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observed_taxa_changes">
            
              <b>observed_taxa_changes</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observed_taxa_changes" name="method-c-observed_taxa_changes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observed_taxa_changes_source')" id="l_method-c-observed_taxa_changes_source">show</a>
                

                

                
              </p>
              <div id="method-c-observed_taxa_changes_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1480</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observed_taxa_changes</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1481</span>   <span class="ruby-comment"># final number of top gains and losses to return</span>
<span class="line-num">1482</span>   <span class="ruby-identifier">final_cutoff</span> = <span class="ruby-value">30</span>
<span class="line-num">1483</span>   <span class="ruby-identifier">this_years_taxa</span> = <span class="ruby-identifier">observed_taxa_counts</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">1484</span>   <span class="ruby-identifier">last_years_taxa</span> = <span class="ruby-identifier">observed_taxa_counts</span>( <span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">1485</span>   <span class="ruby-identifier">all_taxon_ids</span> = ( <span class="ruby-identifier">this_years_taxa</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">last_years_taxa</span>.<span class="ruby-identifier">keys</span> ).<span class="ruby-identifier">uniq</span>
<span class="line-num">1486</span>   <span class="ruby-comment"># top most observose taxa to derive leaves from. since coarser rank taxa</span>
<span class="line-num">1487</span>   <span class="ruby-comment"># will always have higher counts, the lower this number is the more coarser</span>
<span class="line-num">1488</span>   <span class="ruby-comment"># taxa will be favored</span>
<span class="line-num">1489</span>   <span class="ruby-identifier">leaf_cuttoff</span> = [( <span class="ruby-value">0.02</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">all_taxon_ids</span>.<span class="ruby-identifier">size</span> ).<span class="ruby-identifier">ceil</span>, <span class="ruby-identifier">final_cutoff</span>].<span class="ruby-identifier">max</span>
<span class="line-num">1490</span>   <span class="ruby-identifier">data</span> = {}
<span class="line-num">1491</span>   [<span class="ruby-value">:species</span>, <span class="ruby-value">:observations</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">metric</span> <span class="ruby-operator">|</span>
<span class="line-num">1492</span>     <span class="ruby-identifier">deltas</span> = <span class="ruby-identifier">all_taxon_ids</span>.<span class="ruby-identifier">each_with_object</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">1493</span>       <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">taxon_id</span>] =
<span class="line-num">1494</span>         <span class="ruby-identifier">this_years_taxa</span>[<span class="ruby-identifier">taxon_id</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:[]</span>, <span class="ruby-identifier">metric</span> ).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">last_years_taxa</span>[<span class="ruby-identifier">taxon_id</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:[]</span>, <span class="ruby-identifier">metric</span> ).<span class="ruby-identifier">to_i</span>
<span class="line-num">1495</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1496</span>     <span class="ruby-identifier">top_losses</span> = <span class="ruby-identifier">deltas</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">_k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">negative?</span> }.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">_k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-value">-1</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">abs</span> }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">leaf_cuttoff</span>]
<span class="line-num">1497</span>     <span class="ruby-identifier">top_gains</span> = <span class="ruby-identifier">deltas</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">_k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">positive?</span> }.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">_k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-value">-1</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">abs</span> }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">leaf_cuttoff</span>]
<span class="line-num">1498</span>     <span class="ruby-identifier">top_taxon_ids</span> = ( <span class="ruby-identifier">top_losses</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) <span class="ruby-operator">+</span> <span class="ruby-identifier">top_gains</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) ).<span class="ruby-identifier">uniq</span>
<span class="line-num">1499</span>     <span class="ruby-identifier">taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">top_taxon_ids</span> ).<span class="ruby-identifier">index_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> )
<span class="line-num">1500</span>     <span class="ruby-identifier">losses_ancestor_ids</span> = <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">fetch_values</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">top_losses</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) ).<span class="ruby-identifier">collect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:ancestor_ids</span> ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1501</span>     <span class="ruby-identifier">top_losses</span> = <span class="ruby-identifier">top_losses</span>.<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">_delta</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">losses_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon_id</span> ) }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">final_cutoff</span>]
<span class="line-num">1502</span>     <span class="ruby-identifier">gains_ancestor_ids</span> = <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">fetch_values</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">top_gains</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) ).<span class="ruby-identifier">collect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:ancestor_ids</span> ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1503</span>     <span class="ruby-identifier">top_gains</span> = <span class="ruby-identifier">top_gains</span>.<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">_delta</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">gains_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon_id</span> ) }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">final_cutoff</span>]
<span class="line-num">1504</span>     <span class="ruby-identifier">final_taxon_ids</span> = ( <span class="ruby-identifier">top_losses</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) <span class="ruby-operator">+</span> <span class="ruby-identifier">top_gains</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span> ) ).<span class="ruby-identifier">uniq</span>
<span class="line-num">1505</span>     <span class="ruby-identifier">data</span>[<span class="ruby-identifier">metric</span>] = <span class="ruby-identifier">final_taxon_ids</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">|</span>
<span class="line-num">1506</span>       <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">taxa</span>[<span class="ruby-identifier">taxon_id</span>]
<span class="line-num">1507</span>       {
<span class="line-num">1508</span>         <span class="ruby-value">taxon:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">as_indexed_json</span>( <span class="ruby-value">no_details:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">keep_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">_v</span> <span class="ruby-operator">|</span>
<span class="line-num">1509</span>           [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:rank</span>, <span class="ruby-value">:rank_level</span>, <span class="ruby-value">:default_photo</span>, <span class="ruby-value">:is_active</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> )
<span class="line-num">1510</span>         <span class="ruby-keyword">end</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">1511</span>           <span class="ruby-value">iconic_taxon_name:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon_name</span>,
<span class="line-num">1512</span>           <span class="ruby-value">preferred_common_name:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">common_name</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] ).<span class="ruby-identifier">try</span>( <span class="ruby-value">:name</span> )
<span class="line-num">1513</span>         ),
<span class="line-num">1514</span>         <span class="ruby-value">delta:</span> <span class="ruby-identifier">deltas</span>[<span class="ruby-identifier">taxon_id</span>]
<span class="line-num">1515</span>       }
<span class="line-num">1516</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1517</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1518</span>   <span class="ruby-identifier">data</span>
<span class="line-num">1519</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-observed_taxa_counts">
            
              <b>observed_taxa_counts</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-observed_taxa_counts" name="method-c-observed_taxa_counts" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-observed_taxa_counts_source')" id="l_method-c-observed_taxa_counts_source">show</a>
                

                

                
              </p>
              <div id="method-c-observed_taxa_counts_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1455</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">observed_taxa_counts</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1456</span>   <span class="ruby-identifier">params</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">page:</span> <span class="ruby-value">1</span> )
<span class="line-num">1457</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1458</span>   <span class="ruby-identifier">data</span> = {}
<span class="line-num">1459</span>   <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
<span class="line-num">1460</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Fetching results for #{params}&quot;</span>
<span class="line-num">1461</span>     <span class="ruby-identifier">results</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">observations_species_counts</span>( <span class="ruby-identifier">params</span> ).<span class="ruby-identifier">results</span>
<span class="line-num">1462</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">results</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">1463</span> 
<span class="line-num">1464</span>     <span class="ruby-identifier">results</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span>
<span class="line-num">1465</span>       <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;ancestor_ids&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tid</span> <span class="ruby-operator">|</span>
<span class="line-num">1466</span>         <span class="ruby-identifier">data</span>[<span class="ruby-identifier">tid</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">1467</span>         <span class="ruby-identifier">data</span>[<span class="ruby-identifier">tid</span>][<span class="ruby-value">:observations</span>] = <span class="ruby-identifier">data</span>[<span class="ruby-identifier">tid</span>][<span class="ruby-value">:observations</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;count&quot;</span>]
<span class="line-num">1468</span>         <span class="ruby-identifier">data</span>[<span class="ruby-identifier">tid</span>][<span class="ruby-value">:species</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">tid</span>
<span class="line-num">1469</span>           <span class="ruby-value">1</span>
<span class="line-num">1470</span>         <span class="ruby-keyword">else</span>
<span class="line-num">1471</span>           <span class="ruby-identifier">data</span>[<span class="ruby-identifier">tid</span>][<span class="ruby-value">:species</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
<span class="line-num">1472</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1473</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1474</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1475</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1476</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1477</span>   <span class="ruby-identifier">data</span>
<span class="line-num">1478</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-popular_observations">
            
              <b>popular_observations</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-popular_observations" name="method-c-popular_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-popular_observations_source')" id="l_method-c-popular_observations_source">show</a>
                

                

                
              </p>
              <div id="method-c-popular_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">364</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">popular_observations</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">365</span>   <span class="ruby-identifier">params</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">has_photos:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">366</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:user</span> ) )
<span class="line-num">367</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">368</span>   <span class="ruby-keyword">end</span>
<span class="line-num">369</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:site</span> ) )
<span class="line-num">370</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">371</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">372</span>     <span class="ruby-keyword">else</span>
<span class="line-num">373</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">374</span>     <span class="ruby-keyword">end</span>
<span class="line-num">375</span>   <span class="ruby-keyword">end</span>
<span class="line-num">376</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">params</span> )
<span class="line-num">377</span>   <span class="ruby-comment"># es_params_with_sort = es_params.merge(</span>
<span class="line-num">378</span>   <span class="ruby-comment">#   sort: {</span>
<span class="line-num">379</span>   <span class="ruby-comment">#     &quot;_script&quot;: {</span>
<span class="line-num">380</span>   <span class="ruby-comment">#       &quot;type&quot;: &quot;number&quot;,</span>
<span class="line-num">381</span>   <span class="ruby-comment">#       &quot;script&quot;: {</span>
<span class="line-num">382</span>   <span class="ruby-comment">#         &quot;lang&quot;: &quot;painless&quot;,</span>
<span class="line-num">383</span>   <span class="ruby-comment">#         &quot;inline&quot;: &quot;doc[&#39;cached_votes_total&#39;].value + doc[&#39;comments_count&#39;].value&quot;</span>
<span class="line-num">384</span>   <span class="ruby-comment">#       },</span>
<span class="line-num">385</span>   <span class="ruby-comment">#       &quot;order&quot;: &quot;desc&quot;</span>
<span class="line-num">386</span>   <span class="ruby-comment">#     }</span>
<span class="line-num">387</span>   <span class="ruby-comment">#   }</span>
<span class="line-num">388</span>   <span class="ruby-comment"># )</span>
<span class="line-num">389</span>   <span class="ruby-identifier">es_params_with_sort</span> = <span class="ruby-identifier">es_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">390</span>     <span class="ruby-value">sort:</span> [
<span class="line-num">391</span>       { <span class="ruby-value">faves_count:</span> <span class="ruby-string">&quot;desc&quot;</span> },
<span class="line-num">392</span>       { <span class="ruby-value">comments_count:</span> <span class="ruby-string">&quot;desc&quot;</span> }
<span class="line-num">393</span>     ]
<span class="line-num">394</span>   )
<span class="line-num">395</span>   <span class="ruby-identifier">r</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params_with_sort</span> ).<span class="ruby-identifier">per_page</span>( <span class="ruby-value">200</span> ).<span class="ruby-identifier">response</span>
<span class="line-num">396</span>   <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">_source</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">397</span>   <span class="ruby-identifier">api_params</span> = {
<span class="line-num">398</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">ids</span>,
<span class="line-num">399</span>     <span class="ruby-value">per_page:</span> <span class="ruby-value">200</span>
<span class="line-num">400</span>   }
<span class="line-num">401</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">402</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">place</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">place</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:place</span> ) )
<span class="line-num">403</span>       <span class="ruby-identifier">api_params</span>[<span class="ruby-value">:preferred_place_id</span>] = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">404</span>     <span class="ruby-keyword">end</span>
<span class="line-num">405</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:locale</span> ) )
<span class="line-num">406</span>       <span class="ruby-identifier">api_params</span>[<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">locale</span>
<span class="line-num">407</span>     <span class="ruby-keyword">end</span>
<span class="line-num">408</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">409</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">place</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span> )
<span class="line-num">410</span>       <span class="ruby-identifier">api_params</span>[<span class="ruby-value">:preferred_place_id</span>] = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">411</span>     <span class="ruby-keyword">end</span>
<span class="line-num">412</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">413</span>       <span class="ruby-identifier">api_params</span>[<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">locale</span>
<span class="line-num">414</span>     <span class="ruby-keyword">end</span>
<span class="line-num">415</span>   <span class="ruby-keyword">end</span>
<span class="line-num">416</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">417</span> 
<span class="line-num">418</span>   <span class="ruby-identifier">response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-string">&quot;/observations&quot;</span>, <span class="ruby-identifier">api_params</span>, { <span class="ruby-value">timeout:</span> <span class="ruby-value">30</span> } )
<span class="line-num">419</span>   <span class="ruby-identifier">json</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">response</span> )
<span class="line-num">420</span>   <span class="ruby-identifier">json</span>[<span class="ruby-string">&quot;results&quot;</span>].
<span class="line-num">421</span>     <span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span> [<span class="ruby-value">0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;faves_count&quot;</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-value">0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;comments_count&quot;</span>].<span class="ruby-identifier">to_i</span>] }.
<span class="line-num">422</span>     <span class="ruby-identifier">each_with_index</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>, <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span>
<span class="line-num">423</span>     <span class="ruby-identifier">json_obs</span> = {
<span class="line-num">424</span>       <span class="ruby-value">id:</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;id&quot;</span>]
<span class="line-num">425</span>     }
<span class="line-num">426</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;photos&quot;</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">427</span>       <span class="ruby-identifier">json_obs</span>[<span class="ruby-value">:photos</span>] = [<span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;photos&quot;</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">_v</span> <span class="ruby-operator">|</span> <span class="ruby-node">%w(url original_dimensions)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> ) }]
<span class="line-num">428</span>     <span class="ruby-keyword">end</span>
<span class="line-num">429</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">36</span>
<span class="line-num">430</span>       <span class="ruby-identifier">json_obs</span> = <span class="ruby-identifier">json_obs</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">o</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">_v</span> <span class="ruby-operator">|</span> <span class="ruby-node">%w(comments_count faves_count observed_on)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> ) } )
<span class="line-num">431</span>       <span class="ruby-identifier">json_obs</span>[<span class="ruby-value">:user</span>] = <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;user&quot;</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">_v</span> <span class="ruby-operator">|</span> <span class="ruby-string">%(id login name icon_url)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> ) }
<span class="line-num">432</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;taxon&quot;</span>]
<span class="line-num">433</span>         <span class="ruby-identifier">json_obs</span>[<span class="ruby-value">:taxon</span>] = <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;taxon&quot;</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">_v</span> <span class="ruby-operator">|</span> <span class="ruby-string">%(id name rank preferred_common_name)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> ) }
<span class="line-num">434</span>       <span class="ruby-keyword">end</span>
<span class="line-num">435</span>     <span class="ruby-keyword">end</span>
<span class="line-num">436</span>     <span class="ruby-identifier">json_obs</span>
<span class="line-num">437</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">438</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-publications">
            
              <b>publications</b>( year, _options )
            
            <a href="../classes/YearStatistic.html#method-c-publications" name="method-c-publications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-publications_source')" id="l_method-c-publications_source">show</a>
                

                

                
              </p>
              <div id="method-c-publications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1070</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">publications</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">_options</span> )
<span class="line-num">1071</span>   <span class="ruby-identifier">gbif_endpont</span> = <span class="ruby-string">&quot;https://www.gbif.org/api/resource/search&quot;</span>
<span class="line-num">1072</span>   <span class="ruby-identifier">gbif_params</span> = {
<span class="line-num">1073</span>     <span class="ruby-value">contentType:</span> <span class="ruby-string">&quot;literature&quot;</span>,
<span class="line-num">1074</span>     <span class="ruby-comment"># iNat RG Observations dataset identifier on GBIF We don&#39;t publish site-</span>
<span class="line-num">1075</span>     <span class="ruby-comment"># specific datasets, so there&#39;s no reason not to hard-code it here.</span>
<span class="line-num">1076</span>     <span class="ruby-value">gbifDatasetKey:</span> <span class="ruby-string">&quot;50c9509d-22c7-4a22-a47d-8c48425ef4a7&quot;</span>,
<span class="line-num">1077</span>     <span class="ruby-value">literatureType:</span> <span class="ruby-string">&quot;journal&quot;</span>,
<span class="line-num">1078</span>     <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>,
<span class="line-num">1079</span>     <span class="ruby-value">limit:</span> <span class="ruby-value">50</span>
<span class="line-num">1080</span>   }
<span class="line-num">1081</span>   <span class="ruby-identifier">data</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>( <span class="ruby-node">&quot;#{gbif_endpont}?#{gbif_params.to_query}&quot;</span> ) )
<span class="line-num">1082</span>   <span class="ruby-identifier">new_results</span> = []
<span class="line-num">1083</span>   <span class="ruby-identifier">data</span>[<span class="ruby-string">&quot;results&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">|</span>
<span class="line-num">1084</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">doi</span> = <span class="ruby-identifier">result</span>[<span class="ruby-string">&quot;identifiers&quot;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>[<span class="ruby-string">&quot;identifiers&quot;</span>][<span class="ruby-string">&quot;doi&quot;</span>] )
<span class="line-num">1085</span>       <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;https://api.altmetric.com/v1/doi/#{doi}&quot;</span>
<span class="line-num">1086</span>       <span class="ruby-keyword">begin</span>
<span class="line-num">1087</span>         <span class="ruby-identifier">am_response</span> = <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>( <span class="ruby-identifier">url</span> )
<span class="line-num">1088</span>         <span class="ruby-identifier">result</span>[<span class="ruby-string">&quot;altmetric_score&quot;</span>] = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">am_response</span> )[<span class="ruby-string">&quot;score&quot;</span>]
<span class="line-num">1089</span>       <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">NotFound</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1090</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] Request failed for #{url}: #{e}&quot;</span>
<span class="line-num">1091</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1092</span>       <span class="ruby-identifier">sleep</span>( <span class="ruby-value">1</span> )
<span class="line-num">1093</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1094</span>     <span class="ruby-identifier">result</span>[<span class="ruby-string">&quot;_gbifDOIs&quot;</span>] = <span class="ruby-identifier">result</span>[<span class="ruby-string">&quot;_gbifDOIs&quot;</span>][<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">9</span>]
<span class="line-num">1095</span>     <span class="ruby-identifier">new_results</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">slice</span>(
<span class="line-num">1096</span>       <span class="ruby-string">&quot;title&quot;</span>,
<span class="line-num">1097</span>       <span class="ruby-string">&quot;authors&quot;</span>,
<span class="line-num">1098</span>       <span class="ruby-string">&quot;year&quot;</span>,
<span class="line-num">1099</span>       <span class="ruby-string">&quot;source&quot;</span>,
<span class="line-num">1100</span>       <span class="ruby-string">&quot;websites&quot;</span>,
<span class="line-num">1101</span>       <span class="ruby-string">&quot;publisher&quot;</span>,
<span class="line-num">1102</span>       <span class="ruby-string">&quot;id&quot;</span>,
<span class="line-num">1103</span>       <span class="ruby-string">&quot;identifiers&quot;</span>,
<span class="line-num">1104</span>       <span class="ruby-string">&quot;_gbifDOIs&quot;</span>,
<span class="line-num">1105</span>       <span class="ruby-string">&quot;altmetric_score&quot;</span>
<span class="line-num">1106</span>     )
<span class="line-num">1107</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1108</span>   <span class="ruby-identifier">data</span>[<span class="ruby-string">&quot;results&quot;</span>] = <span class="ruby-identifier">new_results</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;altmetric_score&quot;</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-operator">*</span> <span class="ruby-value">-1</span> }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">5</span>]
<span class="line-num">1109</span>   <span class="ruby-identifier">data</span>[<span class="ruby-value">:url</span>] = <span class="ruby-node">&quot;https://www.gbif.org/resource/search?#{gbif_params.to_query}&quot;</span>
<span class="line-num">1110</span>   <span class="ruby-identifier">data</span>
<span class="line-num">1111</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-regenerate_defaults_for_year">
            
              <b>regenerate_defaults_for_year</b>( year )
            
            <a href="../classes/YearStatistic.html#method-c-regenerate_defaults_for_year" name="method-c-regenerate_defaults_for_year" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-regenerate_defaults_for_year_source')" id="l_method-c-regenerate_defaults_for_year_source">show</a>
                

                

                
              </p>
              <div id="method-c-regenerate_defaults_for_year_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">170</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">regenerate_defaults_for_year</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">171</span>   <span class="ruby-constant">Site</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">site</span> <span class="ruby-operator">|</span>
<span class="line-num">172</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">173</span> 
<span class="line-num">174</span>     <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">generate_for_site_year</span>( <span class="ruby-identifier">site</span>, <span class="ruby-identifier">year</span> )
<span class="line-num">175</span>   <span class="ruby-keyword">end</span>
<span class="line-num">176</span>   <span class="ruby-comment"># The global YIR will always be the slowest and the most prone to failure so</span>
<span class="line-num">177</span>   <span class="ruby-comment"># do it last</span>
<span class="line-num">178</span>   <span class="ruby-identifier">generate_for_year</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">179</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-regenerate_existing">
            
              <b>regenerate_existing</b>()
            
            <a href="../classes/YearStatistic.html#method-c-regenerate_existing" name="method-c-regenerate_existing" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-regenerate_existing_source')" id="l_method-c-regenerate_existing_source">show</a>
                

                

                
              </p>
              <div id="method-c-regenerate_existing_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">158</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">regenerate_existing</span>
<span class="line-num">159</span>   <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">ys</span> <span class="ruby-operator">|</span>
<span class="line-num">160</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">user</span>
<span class="line-num">161</span>       <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">generate_for_user_year</span>( <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">year</span> )
<span class="line-num">162</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">site</span>
<span class="line-num">163</span>       <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">generate_for_site_year</span>( <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">site</span>, <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">year</span> )
<span class="line-num">164</span>     <span class="ruby-keyword">else</span>
<span class="line-num">165</span>       <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">generate_for_year</span>( <span class="ruby-identifier">ys</span>.<span class="ruby-identifier">year</span> )
<span class="line-num">166</span>     <span class="ruby-keyword">end</span>
<span class="line-num">167</span>   <span class="ruby-keyword">end</span>
<span class="line-num">168</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-run_cmd">
            
              <b>run_cmd</b>( cmd, options = { timeout: 60 } )
            
            <a href="../classes/YearStatistic.html#method-c-run_cmd" name="method-c-run_cmd" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-run_cmd_source')" id="l_method-c-run_cmd_source">show</a>
                

                

                
              </p>
              <div id="method-c-run_cmd_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1733</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">run_cmd</span>( <span class="ruby-identifier">cmd</span>, <span class="ruby-identifier">options</span> = { <span class="ruby-value">timeout:</span> <span class="ruby-value">60</span> } )
<span class="line-num">1734</span>   <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>( <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:timeout</span> ) ) <span class="ruby-keyword">do</span>
<span class="line-num">1735</span>     <span class="ruby-identifier">system</span> <span class="ruby-identifier">cmd</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">exception:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1736</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1737</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-streaks">
            
              <b>streaks</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-streaks" name="method-c-streaks" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-streaks_source')" id="l_method-c-streaks_source">show</a>
                

                

                
              </p>
              <div id="method-c-streaks_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1184</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">streaks</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1185</span>   <span class="ruby-identifier">options</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">clone</span>
<span class="line-num">1186</span>   <span class="ruby-identifier">debug</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">1187</span>   <span class="ruby-identifier">streak_length</span> = <span class="ruby-value">5</span>
<span class="line-num">1188</span>   <span class="ruby-identifier">base_query</span> = { <span class="ruby-value">quality_grade:</span> <span class="ruby-string">&quot;research,needs_id&quot;</span>, <span class="ruby-value">d2:</span> <span class="ruby-node">&quot;#{year}-12-31&quot;</span> }
<span class="line-num">1189</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>]
<span class="line-num">1190</span>     <span class="ruby-identifier">base_query</span> = <span class="ruby-identifier">base_query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">site_id:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>].<span class="ruby-identifier">id</span> )
<span class="line-num">1191</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1192</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1193</span>     <span class="ruby-identifier">base_query</span> = <span class="ruby-identifier">base_query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">id</span> )
<span class="line-num">1194</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1195</span> 
<span class="line-num">1196</span>   <span class="ruby-identifier">streaks</span> = []
<span class="line-num">1197</span>   <span class="ruby-identifier">current_streaks</span> = {}
<span class="line-num">1198</span>   <span class="ruby-identifier">previous_user_ids</span> = []
<span class="line-num">1199</span> 
<span class="line-num">1200</span>   <span class="ruby-identifier">streak_bucketer</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">query</span> <span class="ruby-operator">|</span>
<span class="line-num">1201</span>     <span class="ruby-identifier">elastic_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">query</span> )
<span class="line-num">1202</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">1203</span>       <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1204</span>       <span class="ruby-value">aggs:</span> {
<span class="line-num">1205</span>         <span class="ruby-value">histogram:</span> {
<span class="line-num">1206</span>           <span class="ruby-value">date_histogram:</span> {
<span class="line-num">1207</span>             <span class="ruby-value">field:</span> <span class="ruby-string">&quot;observed_on&quot;</span>,
<span class="line-num">1208</span>             <span class="ruby-value">calendar_interval:</span> <span class="ruby-string">&quot;day&quot;</span>,
<span class="line-num">1209</span>             <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM-dd&quot;</span>,
<span class="line-num">1210</span>             <span class="ruby-value">time_zone:</span> <span class="ruby-identifier">time_zone_for_options</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">1211</span>           },
<span class="line-num">1212</span>           <span class="ruby-value">aggs:</span> {
<span class="line-num">1213</span>             <span class="ruby-value">user_ids:</span> {
<span class="line-num">1214</span>               <span class="ruby-value">terms:</span> {
<span class="line-num">1215</span>                 <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>,
<span class="line-num">1216</span>                 <span class="ruby-value">size:</span> <span class="ruby-value">300_000</span>
<span class="line-num">1217</span>               }
<span class="line-num">1218</span>             }
<span class="line-num">1219</span>           }
<span class="line-num">1220</span>         }
<span class="line-num">1221</span>       }
<span class="line-num">1222</span>     ) ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">histogram</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num">1223</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1224</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Aggregating all relevant observations by day and user...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1225</span>   <span class="ruby-identifier">histogram_buckets</span> = <span class="ruby-identifier">call_and_rescue_with_partitioner</span>(
<span class="line-num">1226</span>     <span class="ruby-identifier">streak_bucketer</span>,
<span class="line-num">1227</span>     <span class="ruby-identifier">base_query</span>,
<span class="line-num">1228</span>     [
<span class="line-num">1229</span>       <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceUnavailable</span>,
<span class="line-num">1230</span>       <span class="ruby-constant">Faraday</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeoutError</span>
<span class="line-num">1231</span>     ],
<span class="line-num">1232</span>     <span class="ruby-value">exception_checker:</span> <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/(timed out|too_many_buckets_exception)/</span> },
<span class="line-num">1233</span>     <span class="ruby-value">parallel:</span> <span class="ruby-constant">NUM_ES_WORKERS</span>,
<span class="line-num">1234</span>     <span class="ruby-value">debug:</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1235</span>   ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">|</span>
<span class="line-num">1236</span>     <span class="ruby-identifier">query</span> = <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>]
<span class="line-num">1237</span>     <span class="ruby-comment"># Assume no one has been on a streak since before 2008-01-01</span>
<span class="line-num">1238</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] partitioning #{query}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1239</span>     <span class="ruby-identifier">d1</span> = ( <span class="ruby-identifier">query</span>[<span class="ruby-value">:d1</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">query</span>[<span class="ruby-value">:d1</span>] ) ) <span class="ruby-operator">||</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-string">&quot;2008-01-01&quot;</span> )
<span class="line-num">1240</span>     <span class="ruby-identifier">d2</span> = ( <span class="ruby-identifier">query</span>[<span class="ruby-value">:d2</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">query</span>[<span class="ruby-value">:d2</span>] ) ) <span class="ruby-operator">||</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
<span class="line-num">1241</span> 
<span class="line-num">1242</span>     <span class="ruby-comment"># Even n-ary partitioner (splits into n even partitions)</span>
<span class="line-num">1243</span>     <span class="ruby-comment"># num_breaks = 8</span>
<span class="line-num">1244</span>     <span class="ruby-comment"># break_interval = ( d2 - d1 ) / num_breaks</span>
<span class="line-num">1245</span>     <span class="ruby-comment"># new_queries = []</span>
<span class="line-num">1246</span>     <span class="ruby-comment"># num_breaks.times do | i |</span>
<span class="line-num">1247</span>     <span class="ruby-comment">#   interval_d1 = d1 + ( i * break_interval ).days</span>
<span class="line-num">1248</span>     <span class="ruby-comment">#   interval_d2 = interval_d1 + break_interval.days - 1.day</span>
<span class="line-num">1249</span>     <span class="ruby-comment">#   interval_query = query.dup</span>
<span class="line-num">1250</span>     <span class="ruby-comment">#   new_queries &lt;&lt; interval_query.merge( d1: interval_d1.to_s, d2: interval_d2.to_s )</span>
<span class="line-num">1251</span>     <span class="ruby-comment"># end</span>
<span class="line-num">1252</span> 
<span class="line-num">1253</span>     <span class="ruby-comment"># If we&#39;re partitioning more than a year, assume a lot more buckets in</span>
<span class="line-num">1254</span>     <span class="ruby-comment"># more recent partitions</span>
<span class="line-num">1255</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">d2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">d1</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">365</span>
<span class="line-num">1256</span>       <span class="ruby-comment"># Weighted binary partitioner</span>
<span class="line-num">1257</span>       <span class="ruby-identifier">weight</span> = <span class="ruby-value">0.9</span>
<span class="line-num">1258</span>       <span class="ruby-identifier">break_point</span> = ( ( <span class="ruby-identifier">d2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">d1</span> ) <span class="ruby-operator">*</span> <span class="ruby-identifier">weight</span> ).<span class="ruby-identifier">ceil</span>
<span class="line-num">1259</span>       <span class="ruby-identifier">new_queries</span> = [
<span class="line-num">1260</span>         <span class="ruby-identifier">query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">d1:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> ( <span class="ruby-identifier">d1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">break_point</span>.<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span> ),
<span class="line-num">1261</span>         <span class="ruby-identifier">query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">d1:</span> ( <span class="ruby-identifier">d1</span> <span class="ruby-operator">+</span> ( <span class="ruby-identifier">break_point</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> ).<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">to_s</span> )
<span class="line-num">1262</span>       ]
<span class="line-num">1263</span>     <span class="ruby-comment"># If we&#39;re partitioning less than a year, assume variance has more to do</span>
<span class="line-num">1264</span>     <span class="ruby-comment"># with seasonality and events like CNC, so take a simple even approach</span>
<span class="line-num">1265</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1266</span>       <span class="ruby-comment"># Even binary partitioner</span>
<span class="line-num">1267</span>       <span class="ruby-identifier">half</span> = ( <span class="ruby-identifier">d2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">d1</span> ) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">1268</span>       <span class="ruby-identifier">new_queries</span> = [
<span class="line-num">1269</span>         <span class="ruby-identifier">query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">d1:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> ( <span class="ruby-identifier">d1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">half</span>.<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span> ),
<span class="line-num">1270</span>         <span class="ruby-identifier">query</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">d1:</span> ( <span class="ruby-identifier">d1</span> <span class="ruby-operator">+</span> ( <span class="ruby-identifier">half</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> ).<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">to_s</span> )
<span class="line-num">1271</span>       ]
<span class="line-num">1272</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1273</span> 
<span class="line-num">1274</span>     <span class="ruby-comment"># # Logarithmic n-ary partitioner</span>
<span class="line-num">1275</span>     <span class="ruby-comment"># num_breaks = 4</span>
<span class="line-num">1276</span>     <span class="ruby-comment"># # break_interval = ( d2 - d1 ) / num_breaks</span>
<span class="line-num">1277</span>     <span class="ruby-comment"># new_queries = []</span>
<span class="line-num">1278</span>     <span class="ruby-comment"># num_breaks.times do | i |</span>
<span class="line-num">1279</span>     <span class="ruby-comment">#   d2_offset = i**Math.log( d2 - d1, num_breaks )</span>
<span class="line-num">1280</span>     <span class="ruby-comment">#   d1_offset = ( i + 1 )**Math.log( d2 - d1, num_breaks )</span>
<span class="line-num">1281</span>     <span class="ruby-comment">#   interval_d1 = d2 - d1_offset.days</span>
<span class="line-num">1282</span>     <span class="ruby-comment">#   interval_d1 += 1.day unless i == 0</span>
<span class="line-num">1283</span>     <span class="ruby-comment">#   interval_d2 = d2 - d2_offset.days</span>
<span class="line-num">1284</span>     <span class="ruby-comment">#   interval_query = query.dup</span>
<span class="line-num">1285</span>     <span class="ruby-comment">#   new_queries &lt;&lt; interval_query.merge( d1: interval_d1.to_s, d2: interval_d2.to_s )</span>
<span class="line-num">1286</span>     <span class="ruby-comment"># end</span>
<span class="line-num">1287</span> 
<span class="line-num">1288</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] partitioned into #{new_queries}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1289</span>     <span class="ruby-identifier">new_queries</span>
<span class="line-num">1290</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1291</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Processing #{histogram_buckets.size} buckets...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1292</span>   <span class="ruby-identifier">histogram_buckets</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">bucket_i</span> <span class="ruby-operator">|</span>
<span class="line-num">1293</span>     <span class="ruby-identifier">date</span> = <span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key_as_string&quot;</span>]
<span class="line-num">1294</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Processing #{date}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1295</span>     <span class="ruby-identifier">user_ids</span> = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">user_ids</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>].<span class="ruby-identifier">to_i</span> }
<span class="line-num">1296</span>     <span class="ruby-identifier">user_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">streaking_user_id</span> <span class="ruby-operator">|</span>
<span class="line-num">1297</span>       <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">streaking_user_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
<span class="line-num">1298</span>       <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">streaking_user_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1299</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1300</span> 
<span class="line-num">1301</span>     <span class="ruby-comment"># Finished users are all the users who were present in the previous day</span>
<span class="line-num">1302</span>     <span class="ruby-comment"># but not in this one. For each of these, we need to add their streaks</span>
<span class="line-num">1303</span>     <span class="ruby-comment"># with the stop date set to the previous day</span>
<span class="line-num">1304</span>     <span class="ruby-identifier">stop_date</span> = ( <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date</span> ) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> )
<span class="line-num">1305</span>     <span class="ruby-identifier">finished_user_ids</span> = <span class="ruby-identifier">previous_user_ids</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">user_ids</span>
<span class="line-num">1306</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] \t#{date}: #{user_ids.size} users, #{finished_user_ids.size} finished&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1307</span>     <span class="ruby-identifier">finished_user_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">|</span>
<span class="line-num">1308</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1309</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] \tFinished streak of length #{current_streaks[user_id]}&quot;</span>
<span class="line-num">1310</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1311</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">streak_length</span>
<span class="line-num">1312</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1313</span>           <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] \tAdding streak #{stop_date + 1.day - ( current_streaks[user_id] ).days} - #{stop_date}&quot;</span>
<span class="line-num">1314</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1315</span>         <span class="ruby-identifier">streaks</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1316</span>           <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>,
<span class="line-num">1317</span>           <span class="ruby-value">days:</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>],
<span class="line-num">1318</span>           <span class="ruby-value">stop:</span> <span class="ruby-identifier">stop_date</span>.<span class="ruby-identifier">to_s</span>,
<span class="line-num">1319</span>           <span class="ruby-value">start:</span> ( <span class="ruby-identifier">stop_date</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> ( <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] ).<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span>
<span class="line-num">1320</span>         }
<span class="line-num">1321</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1322</span>       <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">1323</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1324</span> 
<span class="line-num">1325</span>     <span class="ruby-comment"># If this is the final day and there are still streaks in progress, we</span>
<span class="line-num">1326</span>     <span class="ruby-comment"># need to add their streaks with the stop today set to *this* day</span>
<span class="line-num">1327</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">bucket_i</span> <span class="ruby-operator">==</span> ( <span class="ruby-identifier">histogram_buckets</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> ) <span class="ruby-comment"># &amp;&amp; range_i == ( ranges.size - 1 )</span>
<span class="line-num">1328</span>       <span class="ruby-identifier">streaking_user_ids</span> = <span class="ruby-identifier">current_streaks</span>.<span class="ruby-identifier">keys</span>
<span class="line-num">1329</span>       <span class="ruby-identifier">stop_date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date</span> )
<span class="line-num">1330</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Processing final day for #{streaking_user_ids.size} streaking users...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1331</span>       <span class="ruby-identifier">streaking_user_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">|</span>
<span class="line-num">1332</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">streak_length</span>
<span class="line-num">1333</span>           <span class="ruby-identifier">streaks</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1334</span>             <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>,
<span class="line-num">1335</span>             <span class="ruby-value">days:</span> <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>],
<span class="line-num">1336</span>             <span class="ruby-value">stop:</span> <span class="ruby-identifier">stop_date</span>.<span class="ruby-identifier">to_s</span>,
<span class="line-num">1337</span>             <span class="ruby-value">start:</span> ( <span class="ruby-identifier">stop_date</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> ( <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] ).<span class="ruby-identifier">days</span> ).<span class="ruby-identifier">to_s</span>
<span class="line-num">1338</span>           }
<span class="line-num">1339</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1340</span>         <span class="ruby-identifier">current_streaks</span>[<span class="ruby-identifier">user_id</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">1341</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1342</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1343</span> 
<span class="line-num">1344</span>     <span class="ruby-identifier">previous_user_ids</span> = <span class="ruby-identifier">user_ids</span>
<span class="line-num">1345</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1346</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">streaks</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1347</span> 
<span class="line-num">1348</span>   <span class="ruby-identifier">max_stop_date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">streaks</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>[<span class="ruby-value">:stop</span>] }.<span class="ruby-identifier">max</span> ) <span class="ruby-operator">-</span> <span class="ruby-value">2</span>.<span class="ruby-identifier">days</span>
<span class="line-num">1349</span>   <span class="ruby-identifier">year_start</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{year}-01-01&quot;</span> )
<span class="line-num">1350</span>   <span class="ruby-identifier">year_stop</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{year}-12-31&quot;</span> )
<span class="line-num">1351</span>   <span class="ruby-identifier">year_range</span> = ( <span class="ruby-identifier">year_start</span><span class="ruby-operator">..</span><span class="ruby-identifier">year_stop</span> )
<span class="line-num">1352</span>   <span class="ruby-identifier">top_streaks</span> = <span class="ruby-identifier">streaks</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">|</span>
<span class="line-num">1353</span>     <span class="ruby-identifier">streak_in_progress</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">s</span>[<span class="ruby-value">:stop</span>] ) <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">max_stop_date</span>
<span class="line-num">1354</span>     <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">s</span>[<span class="ruby-value">:start</span>] )
<span class="line-num">1355</span>     <span class="ruby-identifier">stop_date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">s</span>[<span class="ruby-value">:stop</span>] )
<span class="line-num">1356</span>     <span class="ruby-identifier">streak_started_this_year</span>  = <span class="ruby-identifier">year_range</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">start_date</span> )
<span class="line-num">1357</span>     <span class="ruby-identifier">streak_stopped_this_year</span>  = <span class="ruby-identifier">year_range</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">stop_date</span> )
<span class="line-num">1358</span>     <span class="ruby-comment"># Only counting streaks in progress and streaks started this year EXCEPT</span>
<span class="line-num">1359</span>     <span class="ruby-comment"># when looking at an individual user&#39;s streaks</span>
<span class="line-num">1360</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1361</span>       <span class="ruby-identifier">streak_in_progress</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">streak_stopped_this_year</span>
<span class="line-num">1362</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1363</span>       <span class="ruby-identifier">streak_in_progress</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">streak_started_this_year</span>
<span class="line-num">1364</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1365</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1366</span>   <span class="ruby-identifier">top_streaks</span> = <span class="ruby-identifier">top_streaks</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>[<span class="ruby-value">:days</span>] <span class="ruby-operator">*</span> <span class="ruby-value">-1</span> }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">100</span>]
<span class="line-num">1367</span>   <span class="ruby-identifier">top_streaks_user_ids</span> = <span class="ruby-identifier">top_streaks</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">u</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>[<span class="ruby-value">:user_id</span>] }.<span class="ruby-identifier">uniq</span>
<span class="line-num">1368</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Fetching top streak users...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1369</span>   <span class="ruby-identifier">top_streaks_users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">top_streaks_user_ids</span> )
<span class="line-num">1370</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[#{Time.now}] Generating logins and icons for top streak users...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1371</span>   <span class="ruby-identifier">top_streaks</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">|</span>
<span class="line-num">1372</span>     <span class="ruby-identifier">u</span> = <span class="ruby-identifier">top_streaks_users</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">streak_user</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">streak_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>[<span class="ruby-value">:user_id</span>] }
<span class="line-num">1373</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">suspended?</span>
<span class="line-num">1374</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">1375</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1376</span>       <span class="ruby-identifier">s</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">1377</span>         <span class="ruby-value">login:</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">login</span>,
<span class="line-num">1378</span>         <span class="ruby-value">icon_url:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">u</span>.<span class="ruby-identifier">icon</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:medium</span> ) ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">1379</span>       )
<span class="line-num">1380</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1381</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1382</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-time_zone_for_options">
            
              <b>time_zone_for_options</b>( options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-time_zone_for_options" name="method-c-time_zone_for_options" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-time_zone_for_options_source')" id="l_method-c-time_zone_for_options_source">show</a>
                

                

                
              </p>
              <div id="method-c-time_zone_for_options_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1725</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">time_zone_for_options</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1726</span>   <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;UTC&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">1727</span>   <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;UTC&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1728</span>   <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;UTC&quot;</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">tz</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">time_zone</span>] )
<span class="line-num">1729</span> 
<span class="line-num">1730</span>   <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">tzinfo</span>.<span class="ruby-identifier">name</span>
<span class="line-num">1731</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-translators">
            
              <b>translators</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-translators" name="method-c-translators" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-translators_source')" id="l_method-c-translators_source">show</a>
                

                

                
              </p>
              <div id="method-c-translators_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1384</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">translators</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1385</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">crowdin</span>&amp;.<span class="ruby-identifier">projects</span>
<span class="line-num">1386</span> 
<span class="line-num">1387</span>   <span class="ruby-identifier">locale_to_ci_code</span> = {
<span class="line-num">1388</span>     <span class="ruby-string">&quot;es&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;es-ES&quot;</span>,
<span class="line-num">1389</span>     <span class="ruby-string">&quot;pt&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;pt-PT&quot;</span>
<span class="line-num">1390</span>   }
<span class="line-num">1391</span>   <span class="ruby-identifier">data</span> = { <span class="ruby-value">languages:</span> {}, <span class="ruby-value">users:</span> {} }
<span class="line-num">1392</span>   <span class="ruby-identifier">staff_usernames</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">admins</span>.<span class="ruby-identifier">pluck</span>( <span class="ruby-value">:login</span> ) <span class="ruby-operator">+</span> <span class="ruby-node">%w(alexinat)</span>
<span class="line-num">1393</span>   <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">crowdin</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">to_h</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">project_name</span> <span class="ruby-operator">|</span>
<span class="line-num">1394</span>     <span class="ruby-identifier">project</span> = <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">crowdin</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">project_name</span> )
<span class="line-num">1395</span>     <span class="ruby-identifier">info_r</span> = <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>(
<span class="line-num">1396</span>       <span class="ruby-node">&quot;https://api.crowdin.com/api/project/#{project.identifier}/info?key=#{project.key}&amp;json&quot;</span>
<span class="line-num">1397</span>     )
<span class="line-num">1398</span>     <span class="ruby-identifier">info_j</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">info_r</span> )
<span class="line-num">1399</span>     <span class="ruby-identifier">translated_locales</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;locales&quot;</span> ).<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span> )
<span class="line-num">1400</span>     <span class="ruby-identifier">info_j</span>[<span class="ruby-string">&quot;languages&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">lang</span> <span class="ruby-operator">|</span>
<span class="line-num">1401</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-value">:name</span>]]
<span class="line-num">1402</span> 
<span class="line-num">1403</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]] = {}
<span class="line-num">1404</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]][<span class="ruby-string">&quot;name&quot;</span>] = <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]
<span class="line-num">1405</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]][<span class="ruby-string">&quot;code&quot;</span>] = <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>]
<span class="line-num">1406</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">translated_locales</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>] )
<span class="line-num">1407</span>         <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]][<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>]
<span class="line-num">1408</span>         <span class="ruby-identifier">locale_to_ci_code</span>[<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>].<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>]
<span class="line-num">1409</span>       <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">two_letter</span> = <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>].<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;-&quot;</span> )[<span class="ruby-value">0</span>] ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">translated_locales</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">two_letter</span> )
<span class="line-num">1410</span>         <span class="ruby-identifier">data</span>[<span class="ruby-value">:languages</span>][<span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;name&quot;</span>]][<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">two_letter</span>
<span class="line-num">1411</span>         <span class="ruby-identifier">locale_to_ci_code</span>[<span class="ruby-identifier">two_letter</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">lang</span>[<span class="ruby-string">&quot;code&quot;</span>]
<span class="line-num">1412</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1413</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1414</span>     <span class="ruby-identifier">export_params</span> = {
<span class="line-num">1415</span>       <span class="ruby-value">key:</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">key</span>,
<span class="line-num">1416</span>       <span class="ruby-value">json:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1417</span>       <span class="ruby-value">format:</span> <span class="ruby-string">&quot;csv&quot;</span>,
<span class="line-num">1418</span>       <span class="ruby-value">date_from:</span> <span class="ruby-node">&quot;#{year - 1}-01-01+00:00&quot;</span>,
<span class="line-num">1419</span>       <span class="ruby-value">date_to:</span> <span class="ruby-node">&quot;#{year}-12-31+23:00&quot;</span>
<span class="line-num">1420</span>     }
<span class="line-num">1421</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>]&amp;.<span class="ruby-identifier">locale</span>
<span class="line-num">1422</span>       <span class="ruby-identifier">export_params</span>[<span class="ruby-value">:language</span>] = <span class="ruby-identifier">locale_to_ci_code</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>].<span class="ruby-identifier">locale</span>]
<span class="line-num">1423</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1424</span>     <span class="ruby-identifier">export_r</span> = <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">post</span>(
<span class="line-num">1425</span>       <span class="ruby-node">&quot;https://api.crowdin.com/api/project/#{project.identifier}/reports/top-members/export&quot;</span>,
<span class="line-num">1426</span>       <span class="ruby-identifier">export_params</span>
<span class="line-num">1427</span>     )
<span class="line-num">1428</span>     <span class="ruby-identifier">export_j</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">export_r</span> )
<span class="line-num">1429</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">export_j</span>[<span class="ruby-string">&quot;success&quot;</span>]
<span class="line-num">1430</span> 
<span class="line-num">1431</span>     <span class="ruby-identifier">report_r</span> = <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>(
<span class="line-num">1432</span>       <span class="ruby-node">&quot;https://api.crowdin.com/api/project/#{project.identifier}/reports/top-members/download?key=#{project.key}&amp;hash=#{export_j[&#39;hash&#39;]}&quot;</span>
<span class="line-num">1433</span>     )
<span class="line-num">1434</span>     <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">report_r</span>, <span class="ruby-value">headers:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">|</span>
<span class="line-num">1435</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Languages&quot;</span>]
<span class="line-num">1436</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">staff_usernames</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Name&quot;</span>] )
<span class="line-num">1437</span> 
<span class="line-num">1438</span>       <span class="ruby-identifier">username</span> = <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Name&quot;</span>][<span class="ruby-regexp">/\((.+)\)/</span>, <span class="ruby-value">1</span>]
<span class="line-num">1439</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">staff_usernames</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">username</span> )
<span class="line-num">1440</span> 
<span class="line-num">1441</span>       <span class="ruby-identifier">languages</span> = <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Languages&quot;</span>].<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;;&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:strip</span> ).<span class="ruby-identifier">grep_v</span>( <span class="ruby-regexp">/English/</span> )
<span class="line-num">1442</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">languages</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1443</span> 
<span class="line-num">1444</span>       <span class="ruby-identifier">username</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Name&quot;</span>]
<span class="line-num">1445</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:users</span>][<span class="ruby-identifier">username</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">1446</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:users</span>][<span class="ruby-identifier">username</span>][<span class="ruby-value">:name</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Name&quot;</span>].<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/\(.+\)/</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">strip</span>
<span class="line-num">1447</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:users</span>][<span class="ruby-identifier">username</span>][<span class="ruby-node">&quot;words_#{project_name}&quot;</span>] = <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Translated (Words)&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">1448</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:users</span>][<span class="ruby-identifier">username</span>][<span class="ruby-node">&quot;approved_#{project_name}&quot;</span>] = <span class="ruby-identifier">row</span>[<span class="ruby-string">&quot;Approved (Words)&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">1449</span>       <span class="ruby-identifier">data</span>[<span class="ruby-value">:users</span>][<span class="ruby-identifier">username</span>][<span class="ruby-value">:languages</span>] = <span class="ruby-identifier">languages</span>
<span class="line-num">1450</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1451</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1452</span>   <span class="ruby-identifier">data</span>
<span class="line-num">1453</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-tree_taxa">
            
              <b>tree_taxa</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-tree_taxa" name="method-c-tree_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-tree_taxa_source')" id="l_method-c-tree_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-c-tree_taxa_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">181</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">tree_taxa</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">182</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span> }
<span class="line-num">183</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] )
<span class="line-num">184</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">185</span>   <span class="ruby-keyword">end</span>
<span class="line-num">186</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">187</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">188</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">189</span>     <span class="ruby-keyword">else</span>
<span class="line-num">190</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">191</span>     <span class="ruby-keyword">end</span>
<span class="line-num">192</span>   <span class="ruby-keyword">end</span>
<span class="line-num">193</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">194</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">place</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">place</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:place</span> ) )
<span class="line-num">195</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:preferred_place_id</span>] = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">196</span>     <span class="ruby-keyword">end</span>
<span class="line-num">197</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:locale</span> ) )
<span class="line-num">198</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">locale</span>
<span class="line-num">199</span>     <span class="ruby-keyword">end</span>
<span class="line-num">200</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">201</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">place</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">place</span> )
<span class="line-num">202</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:preferred_place_id</span>] = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">203</span>     <span class="ruby-keyword">end</span>
<span class="line-num">204</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">205</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:locale</span>] = <span class="ruby-identifier">locale</span>
<span class="line-num">206</span>     <span class="ruby-keyword">end</span>
<span class="line-num">207</span>   <span class="ruby-keyword">end</span>
<span class="line-num">208</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">209</span>     <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-string">&quot;/observations/tree_taxa&quot;</span>, <span class="ruby-identifier">params</span>, { <span class="ruby-value">timeout:</span> <span class="ruby-value">30</span> } ) )[<span class="ruby-string">&quot;results&quot;</span>]
<span class="line-num">210</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span>
<span class="line-num">211</span>     <span class="ruby-keyword">nil</span>
<span class="line-num">212</span>   <span class="ruby-keyword">end</span>
<span class="line-num">213</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-users_helped">
            
              <b>users_helped</b>( year, user )
            
            <a href="../classes/YearStatistic.html#method-c-users_helped" name="method-c-users_helped" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-users_helped_source')" id="l_method-c-users_helped_source">show</a>
                

                

                
              </p>
              <div id="method-c-users_helped_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">440</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">users_helped</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">441</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">442</span> 
<span class="line-num">443</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">444</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;user.id&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">445</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:aggregate</span>] = {
<span class="line-num">446</span>     <span class="ruby-value">users_helped:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;observation.user_id&quot;</span>, <span class="ruby-value">size:</span> <span class="ruby-value">40_000</span> } }
<span class="line-num">447</span>   }
<span class="line-num">448</span>   <span class="ruby-identifier">buckets</span> = <span class="ruby-constant">Identification</span>.
<span class="line-num">449</span>     <span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).
<span class="line-num">450</span>     <span class="ruby-identifier">response</span>.
<span class="line-num">451</span>     <span class="ruby-identifier">aggregations</span>.
<span class="line-num">452</span>     <span class="ruby-identifier">users_helped</span>.
<span class="line-num">453</span>     <span class="ruby-identifier">buckets</span>
<span class="line-num">454</span>   <span class="ruby-identifier">users</span> = <span class="ruby-identifier">buckets</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>].<span class="ruby-identifier">each_with_object</span>( [] ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">455</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">helped_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>] ) )
<span class="line-num">456</span> 
<span class="line-num">457</span>     <span class="ruby-identifier">memo</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">458</span>       <span class="ruby-value">count:</span> <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>,
<span class="line-num">459</span>       <span class="ruby-value">user:</span> <span class="ruby-identifier">helped_user</span>.<span class="ruby-identifier">as_indexed_json</span>
<span class="line-num">460</span>     }
<span class="line-num">461</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">462</span>   [<span class="ruby-identifier">users</span>, <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:doc_count</span> ).<span class="ruby-identifier">sum</span>]
<span class="line-num">463</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-users_histogram_by_created_month">
            
              <b>users_histogram_by_created_month</b>( options = {} )
            
            <a href="../classes/YearStatistic.html#method-c-users_histogram_by_created_month" name="method-c-users_histogram_by_created_month" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-users_histogram_by_created_month_source')" id="l_method-c-users_histogram_by_created_month_source">show</a>
                

                

                
              </p>
              <div id="method-c-users_histogram_by_created_month_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1148</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">users_histogram_by_created_month</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1149</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;EXTRACT(&#39;year&#39; FROM created_at) || &#39;-&#39; || EXTRACT(&#39;month&#39; FROM created_at)&quot;</span> ).
<span class="line-num">1150</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;suspended_at IS NULL AND created_at &gt; &#39;2008-03-01&#39; AND observations_count &gt; 0&quot;</span> )
<span class="line-num">1151</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">site</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>] )
<span class="line-num">1152</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;site_id = ?&quot;</span>, <span class="ruby-identifier">site</span> )
<span class="line-num">1153</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1154</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span>
<span class="line-num">1155</span>     [<span class="ruby-node">&quot;#{k.split( &#39;-&#39; ).map {| s | s.rjust( 2, &#39;0&#39; ) }.join( &#39;-&#39; )}-01&quot;</span>, <span class="ruby-identifier">v</span>]
<span class="line-num">1156</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">to_h</span>
<span class="line-num">1157</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-users_who_helped">
            
              <b>users_who_helped</b>( year, user )
            
            <a href="../classes/YearStatistic.html#method-c-users_who_helped" name="method-c-users_who_helped" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-users_who_helped_source')" id="l_method-c-users_who_helped_source">show</a>
                

                

                
              </p>
              <div id="method-c-users_who_helped_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">465</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">users_who_helped</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">466</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">467</span> 
<span class="line-num">468</span>   <span class="ruby-identifier">es_params</span> = <span class="ruby-constant">YearStatistic</span>.<span class="ruby-identifier">identifications_es_base_params</span>( <span class="ruby-identifier">year</span> )
<span class="line-num">469</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;observation.user_id&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">470</span>   <span class="ruby-identifier">es_params</span>[<span class="ruby-value">:aggregate</span>] = {
<span class="line-num">471</span>     <span class="ruby-value">users_helped:</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>, <span class="ruby-value">size:</span> <span class="ruby-value">40_000</span> } }
<span class="line-num">472</span>   }
<span class="line-num">473</span>   <span class="ruby-identifier">buckets</span> = <span class="ruby-constant">Identification</span>.
<span class="line-num">474</span>     <span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">es_params</span> ).
<span class="line-num">475</span>     <span class="ruby-identifier">response</span>.
<span class="line-num">476</span>     <span class="ruby-identifier">aggregations</span>.
<span class="line-num">477</span>     <span class="ruby-identifier">users_helped</span>.
<span class="line-num">478</span>     <span class="ruby-identifier">buckets</span>
<span class="line-num">479</span>   <span class="ruby-identifier">users</span> = <span class="ruby-identifier">buckets</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>].<span class="ruby-identifier">each_with_object</span>( [] ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span>, <span class="ruby-identifier">memo</span> <span class="ruby-operator">|</span>
<span class="line-num">480</span>     <span class="ruby-identifier">helped_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">bucket</span>[<span class="ruby-string">&quot;key&quot;</span>] )
<span class="line-num">481</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">helped_user</span>
<span class="line-num">482</span> 
<span class="line-num">483</span>     <span class="ruby-identifier">memo</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">484</span>       <span class="ruby-value">count:</span> <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>,
<span class="line-num">485</span>       <span class="ruby-value">user:</span> <span class="ruby-identifier">helped_user</span>.<span class="ruby-identifier">as_indexed_json</span>
<span class="line-num">486</span>     }
<span class="line-num">487</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">488</span>   [<span class="ruby-identifier">users</span>, <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:doc_count</span> ).<span class="ruby-identifier">sum</span>]
<span class="line-num">489</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-est_max_obs_distances">
            
              <b>est_max_obs_distances</b>( year, options = {} )
            
            <a href="../classes/YearStatistic.html#method-i-est_max_obs_distances" name="method-i-est_max_obs_distances" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Stats on maximum distance in meters between obs created by all users for each month of the year. Instead of pairwise comparisons, this just calculates the bounding box for each user&#39;s observations within a month and uses the box&#39;s diagonal as the “distance,” so it&#39;s just an approximation.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-est_max_obs_distances_source')" id="l_method-i-est_max_obs_distances_source">show</a>
                

                

                
              </p>
              <div id="method-i-est_max_obs_distances_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1647</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">est_max_obs_distances</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1648</span>   <span class="ruby-identifier">debug</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:debug</span> )
<span class="line-num">1649</span>   <span class="ruby-identifier">data</span> = []
<span class="line-num">1650</span>   ( <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">12</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">month</span> <span class="ruby-operator">|</span>
<span class="line-num">1651</span>     <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">month</span> )
<span class="line-num">1652</span>     <span class="ruby-identifier">d2</span> = <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">end_of_month</span>
<span class="line-num">1653</span>     <span class="ruby-identifier">params</span> = { <span class="ruby-value">geo:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">d1:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">to_s</span> }
<span class="line-num">1654</span>     <span class="ruby-identifier">elastic_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>( <span class="ruby-identifier">params</span> )
<span class="line-num">1655</span>     <span class="ruby-identifier">geo_bounds_params</span> = <span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">1656</span>       <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1657</span>       <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1658</span>       <span class="ruby-value">aggs:</span> {
<span class="line-num">1659</span>         <span class="ruby-value">user_ids:</span> {
<span class="line-num">1660</span>           <span class="ruby-value">terms:</span> {
<span class="line-num">1661</span>             <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>,
<span class="line-num">1662</span>             <span class="ruby-value">size:</span> <span class="ruby-value">300_000</span>
<span class="line-num">1663</span>           },
<span class="line-num">1664</span>           <span class="ruby-value">aggs:</span> {
<span class="line-num">1665</span>             <span class="ruby-value">bounding_box:</span> {
<span class="line-num">1666</span>               <span class="ruby-value">geo_bounds:</span> {
<span class="line-num">1667</span>                 <span class="ruby-value">field:</span> <span class="ruby-string">&quot;private_location&quot;</span>
<span class="line-num">1668</span>               }
<span class="line-num">1669</span>             }
<span class="line-num">1670</span>           }
<span class="line-num">1671</span>         }
<span class="line-num">1672</span>       }
<span class="line-num">1673</span>     )
<span class="line-num">1674</span>     <span class="ruby-identifier">distances</span> = []
<span class="line-num">1675</span>     <span class="ruby-identifier">buckets</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">geo_bounds_params</span> ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">user_ids</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num">1676</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{d1}, calculating distances for #{buckets.size} users...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1677</span>     <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">bucket</span> <span class="ruby-operator">|</span>
<span class="line-num">1678</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">bounding_box</span>&amp;.<span class="ruby-identifier">bounds</span>
<span class="line-num">1679</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">1</span>
<span class="line-num">1680</span> 
<span class="line-num">1681</span>       <span class="ruby-identifier">d</span> = <span class="ruby-identifier">lat_lon_distance_in_meters</span>(
<span class="line-num">1682</span>         <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">bounding_box</span>.<span class="ruby-identifier">bounds</span>.<span class="ruby-identifier">bottom_right</span>.<span class="ruby-identifier">lat</span>,
<span class="line-num">1683</span>         <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">bounding_box</span>.<span class="ruby-identifier">bounds</span>.<span class="ruby-identifier">bottom_right</span>.<span class="ruby-identifier">lon</span>,
<span class="line-num">1684</span>         <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">bounding_box</span>.<span class="ruby-identifier">bounds</span>.<span class="ruby-identifier">top_left</span>.<span class="ruby-identifier">lat</span>,
<span class="line-num">1685</span>         <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">bounding_box</span>.<span class="ruby-identifier">bounds</span>.<span class="ruby-identifier">top_left</span>.<span class="ruby-identifier">lon</span>
<span class="line-num">1686</span>       )
<span class="line-num">1687</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">1688</span> 
<span class="line-num">1689</span>       <span class="ruby-identifier">distances</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>
<span class="line-num">1690</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1691</span>     <span class="ruby-identifier">data</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1692</span>       <span class="ruby-value">date:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span>,
<span class="line-num">1693</span>       <span class="ruby-value">avg:</span> <span class="ruby-identifier">distances</span>.<span class="ruby-identifier">sum</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">distances</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_f</span>,
<span class="line-num">1694</span>       <span class="ruby-value">med:</span> <span class="ruby-identifier">distances</span>.<span class="ruby-identifier">median</span>
<span class="line-num">1695</span>       <span class="ruby-comment"># min: distances.min,</span>
<span class="line-num">1696</span>       <span class="ruby-comment"># max: distances.max</span>
<span class="line-num">1697</span>     }
<span class="line-num">1698</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1699</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">keys</span>
<span class="line-num">1700</span>   <span class="ruby-constant">CSV</span>( <span class="ruby-identifier">$stdout</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">csv</span> <span class="ruby-operator">|</span>
<span class="line-num">1701</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">1702</span>     <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">|</span>
<span class="line-num">1703</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>[<span class="ruby-identifier">h</span>] }
<span class="line-num">1704</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1705</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1706</span>   <span class="ruby-identifier">data</span>
<span class="line-num">1707</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-generate_shareable_image">
            
              <b>generate_shareable_image</b>()
            
            <a href="../classes/YearStatistic.html#method-i-generate_shareable_image" name="method-i-generate_shareable_image" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-generate_shareable_image_source')" id="l_method-i-generate_shareable_image_source">show</a>
                

                

                
              </p>
              <div id="method-i-generate_shareable_image_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">491</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_shareable_image</span>
<span class="line-num">492</span>   <span class="ruby-comment"># Disabling shareable image generation until we fix imagemagick issue:</span>
<span class="line-num">493</span>   <span class="ruby-comment"># https://github.com/inaturalist/chef-repo-azure/issues/31</span>
<span class="line-num">494</span>   <span class="ruby-keyword">return</span>
<span class="line-num">495</span> 
<span class="line-num">496</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">year</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2020</span>
<span class="line-num">497</span>     <span class="ruby-identifier">generate_shareable_image_no_obs</span>
<span class="line-num">498</span>   <span class="ruby-keyword">else</span>
<span class="line-num">499</span>     <span class="ruby-identifier">generate_shareable_image_obs_grid</span>
<span class="line-num">500</span>   <span class="ruby-keyword">end</span>
<span class="line-num">501</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-generate_shareable_image_no_obs">
            
              <b>generate_shareable_image_no_obs</b>( options = {} )
            
            <a href="../classes/YearStatistic.html#method-i-generate_shareable_image_no_obs" name="method-i-generate_shareable_image_no_obs" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-generate_shareable_image_no_obs_source')" id="l_method-i-generate_shareable_image_no_obs_source">show</a>
                

                

                
              </p>
              <div id="method-i-generate_shareable_image_no_obs_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">641</span>   <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_shareable_image_no_obs</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">642</span>     <span class="ruby-identifier">debug</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:debug</span> )
<span class="line-num">643</span>     <span class="ruby-identifier">work_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;year-stat-#{id}-#{Time.now.to_i}&quot;</span> )
<span class="line-num">644</span>     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-identifier">work_path</span>, <span class="ruby-value">mode:</span> <span class="ruby-value">0o755</span>
<span class="line-num">645</span>     <span class="ruby-comment"># Get the icon</span>
<span class="line-num">646</span>     <span class="ruby-identifier">icon_url</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">647</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">icon</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:large</span> ) ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">648</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">649</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">site</span>.<span class="ruby-identifier">logo_square</span>.<span class="ruby-identifier">url</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">650</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">651</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">logo_square</span>.<span class="ruby-identifier">url</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">652</span>     <span class="ruby-keyword">else</span>
<span class="line-num">653</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-string">&quot;bird.png&quot;</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">654</span>     <span class="ruby-keyword">end</span>
<span class="line-num">655</span>     <span class="ruby-identifier">icon_url</span> = <span class="ruby-identifier">icon_url</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-string">&quot;staticdev&quot;</span>, <span class="ruby-string">&quot;static&quot;</span> ) <span class="ruby-comment"># basically just for testing</span>
<span class="line-num">656</span>     <span class="ruby-identifier">icon_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>( <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">icon_url</span> ).<span class="ruby-identifier">path</span> )
<span class="line-num">657</span>     <span class="ruby-identifier">icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-node">&quot;icon#{icon_ext}&quot;</span> )
<span class="line-num">658</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;curl -f -s -o #{icon_path} \&quot;#{icon_url}\&quot;&quot;</span>
<span class="line-num">659</span> 
<span class="line-num">660</span>     <span class="ruby-comment"># Resize icon to a 500x500 square</span>
<span class="line-num">661</span>     <span class="ruby-identifier">square_icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;square_icon.png&quot;</span> )
<span class="line-num">662</span>     <span class="ruby-identifier">resize_cmd</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">663</span>       <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">664</span> <span class="ruby-value">        convert #{icon_path} \
<span class="line-num">665</span>           -fill transparent \
<span class="line-num">666</span>           -resize &quot;500x500^&quot; \
<span class="line-num">667</span>           -gravity Center  \
<span class="line-num">668</span>           -extent 500x500  \
<span class="line-num">669</span>           #{square_icon_path}
<span class="line-num">670</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">671</span>     <span class="ruby-keyword">else</span>
<span class="line-num">672</span>       <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">673</span> <span class="ruby-value">        convert #{icon_path} \
<span class="line-num">674</span>           -fill transparent \
<span class="line-num">675</span>           -resize 500x500 \
<span class="line-num">676</span>           -gravity Center  \
<span class="line-num">677</span>           -extent 500x500  \
<span class="line-num">678</span>           #{square_icon_path}
<span class="line-num">679</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">680</span>     <span class="ruby-keyword">end</span>
<span class="line-num">681</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">resize_cmd</span>
<span class="line-num">682</span> 
<span class="line-num">683</span>     <span class="ruby-identifier">final_logo_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;final-logo.png&quot;</span> )
<span class="line-num">684</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">685</span>       <span class="ruby-comment"># Apply circle mask</span>
<span class="line-num">686</span>       <span class="ruby-identifier">circle_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;circle.png&quot;</span> )
<span class="line-num">687</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">688</span> <span class="ruby-value">        convert -size 500x500 xc:black -fill white \
<span class="line-num">689</span>           -draw &quot;translate 250,250 circle 0,0 0,250&quot; -alpha off #{circle_path}
<span class="line-num">690</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">691</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">692</span> <span class="ruby-value">        convert #{square_icon_path} #{circle_path} \
<span class="line-num">693</span>           -alpha Off -compose CopyOpacity -composite \
<span class="line-num">694</span>           -scale 212x212 \
<span class="line-num">695</span>           #{final_logo_path}
<span class="line-num">696</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">697</span>     <span class="ruby-keyword">else</span>
<span class="line-num">698</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;convert #{square_icon_path} -resize 212x212 #{final_logo_path}&quot;</span>
<span class="line-num">699</span>     <span class="ruby-keyword">end</span>
<span class="line-num">700</span> 
<span class="line-num">701</span>     <span class="ruby-identifier">background_url</span> = <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-string">&quot;yir-background.png&quot;</span> ).<span class="ruby-identifier">to_s</span>.
<span class="line-num">702</span>       <span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> ).
<span class="line-num">703</span>       <span class="ruby-identifier">gsub</span>( <span class="ruby-string">&quot;staging.inaturalist&quot;</span>, <span class="ruby-string">&quot;www.inaturalist&quot;</span> )
<span class="line-num">704</span>     <span class="ruby-identifier">background_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;background.png&quot;</span> )
<span class="line-num">705</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;curl -f -s -o #{background_path} #{background_url}&quot;</span>
<span class="line-num">706</span> 
<span class="line-num">707</span>     <span class="ruby-identifier">left_vertical_offset</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">708</span>       <span class="ruby-value">0</span>
<span class="line-num">709</span>     <span class="ruby-keyword">else</span>
<span class="line-num">710</span>       <span class="ruby-value">30</span>
<span class="line-num">711</span>     <span class="ruby-keyword">end</span>
<span class="line-num">712</span> 
<span class="line-num">713</span>     <span class="ruby-comment"># Overlay the icon onto the montage</span>
<span class="line-num">714</span>     <span class="ruby-identifier">background_with_icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;background_with_icon.png&quot;</span> )
<span class="line-num">715</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">716</span> <span class="ruby-value">      composite -gravity northwest \
<span class="line-num">717</span>         -geometry +145+#{left_vertical_offset + 230} \
<span class="line-num">718</span>         #{final_logo_path} #{background_path} #{background_with_icon_path}
<span class="line-num">719</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">720</span>     <span class="ruby-identifier">wordmark_site</span> = <span class="ruby-identifier">user</span>&amp;.<span class="ruby-identifier">site</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">site</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">721</span>     <span class="ruby-identifier">wordmark_url</span> = <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">wordmark_site</span>.<span class="ruby-identifier">logo</span>.<span class="ruby-identifier">url</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">722</span>     <span class="ruby-identifier">wordmark_url</span> = <span class="ruby-identifier">wordmark_url</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-string">&quot;staticdev&quot;</span>, <span class="ruby-string">&quot;static&quot;</span> )
<span class="line-num">723</span>     <span class="ruby-identifier">wordmark_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>( <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">wordmark_url</span> ).<span class="ruby-identifier">path</span> )
<span class="line-num">724</span>     <span class="ruby-identifier">wordmark_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-node">&quot;wordmark#{wordmark_ext}&quot;</span> )
<span class="line-num">725</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;curl -f -s -o #{wordmark_path} #{wordmark_url}&quot;</span>
<span class="line-num">726</span>     <span class="ruby-identifier">wordmark_composite_bg_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;wordmark-composite-bg.png&quot;</span> )
<span class="line-num">727</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;convert -size 500x562 xc:transparent -type TrueColorAlpha #{wordmark_composite_bg_path}&quot;</span>
<span class="line-num">728</span>     <span class="ruby-identifier">wordmark_resized_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;wordmark-resized.png&quot;</span> )
<span class="line-num">729</span>     <span class="ruby-identifier">density</span> = <span class="ruby-value">1024</span>
<span class="line-num">730</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">731</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">732</span> <span class="ruby-value">        convert -resize x65 -background none +antialias -density #{density} \
<span class="line-num">733</span>           #{wordmark_path} #{wordmark_resized_path}
<span class="line-num">734</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">735</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RuntimeError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">736</span>       <span class="ruby-identifier">density</span> <span class="ruby-operator">/=</span> <span class="ruby-value">2</span>
<span class="line-num">737</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">density</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">8</span>
<span class="line-num">738</span> 
<span class="line-num">739</span>       <span class="ruby-keyword">retry</span>
<span class="line-num">740</span>     <span class="ruby-keyword">end</span>
<span class="line-num">741</span>     <span class="ruby-identifier">wordmark_composite_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;wordmark-composite.png&quot;</span> )
<span class="line-num">742</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">743</span> <span class="ruby-value">      convert #{wordmark_composite_bg_path} \
<span class="line-num">744</span>         #{wordmark_resized_path} \
<span class="line-num">745</span>         -type TrueColorAlpha \
<span class="line-num">746</span>         -gravity north -geometry +0+#{left_vertical_offset + 70} \
<span class="line-num">747</span>         -composite \
<span class="line-num">748</span>         #{wordmark_composite_path}
<span class="line-num">749</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">750</span>     <span class="ruby-identifier">background_icon_wordmark_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;background-icon-wordmark.png&quot;</span> )
<span class="line-num">751</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">752</span> <span class="ruby-value">      convert #{background_with_icon_path} #{wordmark_composite_path} \
<span class="line-num">753</span>         -gravity west -composite #{background_icon_wordmark_path}
<span class="line-num">754</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">755</span> 
<span class="line-num">756</span>     <span class="ruby-comment"># Add the text</span>
<span class="line-num">757</span>     <span class="ruby-comment"># background_with_icon_and_text_path = File.join( work_path, &quot;background_with_icon_and_text.jpg&quot; )</span>
<span class="line-num">758</span>     <span class="ruby-identifier">light_font_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;public&quot;</span>, <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;Whitney-Light-Pro.otf&quot;</span> )
<span class="line-num">759</span>     <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;public&quot;</span>, <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;Whitney-Medium-Pro.otf&quot;</span> )
<span class="line-num">760</span>     <span class="ruby-identifier">semibold_font_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;public&quot;</span>, <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;Whitney-Semibold-Pro.otf&quot;</span> )
<span class="line-num">761</span>     <span class="ruby-identifier">final_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;final.jpg&quot;</span> )
<span class="line-num">762</span>     <span class="ruby-identifier">owner</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">763</span>       <span class="ruby-node">&quot;@#{user.login}&quot;</span>
<span class="line-num">764</span>     <span class="ruby-keyword">else</span>
<span class="line-num">765</span>       <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">766</span>     <span class="ruby-keyword">end</span>
<span class="line-num">767</span>     <span class="ruby-identifier">title</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">768</span>       <span class="ruby-identifier">user_site</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">769</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">770</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">771</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">772</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">773</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">774</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">775</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span> )
<span class="line-num">776</span>     <span class="ruby-keyword">else</span>
<span class="line-num">777</span>       <span class="ruby-identifier">default_site</span> = <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">778</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">779</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">presence</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">name</span>
<span class="line-num">780</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span> )
<span class="line-num">781</span>     <span class="ruby-keyword">end</span>
<span class="line-num">782</span>     <span class="ruby-identifier">title</span> = <span class="ruby-identifier">title</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">783</span>     <span class="ruby-identifier">obs_count</span> = <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">qg_counts</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">dig</span>( <span class="ruby-string">&quot;observations&quot;</span>, <span class="ruby-string">&quot;quality_grade_counts&quot;</span> ) )
<span class="line-num">784</span>       <span class="ruby-identifier">qg_counts</span>[<span class="ruby-string">&quot;research&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">qg_counts</span>[<span class="ruby-string">&quot;needs_id&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">785</span>     <span class="ruby-keyword">else</span>
<span class="line-num">786</span>       <span class="ruby-value">0</span>
<span class="line-num">787</span>     <span class="ruby-keyword">end</span>
<span class="line-num">788</span>     <span class="ruby-identifier">species_count</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">dig</span>( <span class="ruby-string">&quot;taxa&quot;</span>, <span class="ruby-string">&quot;leaf_taxa_count&quot;</span> ).<span class="ruby-identifier">to_i</span>
<span class="line-num">789</span>     <span class="ruby-identifier">identifications_count</span> = (
<span class="line-num">790</span>       ( <span class="ruby-identifier">data</span>.<span class="ruby-identifier">dig</span>( <span class="ruby-string">&quot;identifications&quot;</span>, <span class="ruby-string">&quot;category_counts&quot;</span> ) <span class="ruby-operator">||</span> {} ).<span class="ruby-identifier">inject</span>( <span class="ruby-value">0</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span>, <span class="ruby-identifier">keyval</span> <span class="ruby-operator">|</span>
<span class="line-num">791</span>         <span class="ruby-identifier">sum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">keyval</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">792</span>         <span class="ruby-identifier">sum</span>
<span class="line-num">793</span>       <span class="ruby-keyword">end</span>
<span class="line-num">794</span>     ).<span class="ruby-identifier">to_i</span>
<span class="line-num">795</span> 
<span class="line-num">796</span>     <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">797</span>     <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>
<span class="line-num">798</span>     <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">799</span>     <span class="ruby-identifier">label_method</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(il|he|ar)/</span>
<span class="line-num">800</span>       <span class="ruby-string">&quot;pango&quot;</span>
<span class="line-num">801</span>     <span class="ruby-keyword">else</span>
<span class="line-num">802</span>       <span class="ruby-string">&quot;label&quot;</span>
<span class="line-num">803</span>     <span class="ruby-keyword">end</span>
<span class="line-num">804</span>     <span class="ruby-identifier">obs_translation</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;x_observations_html&quot;</span>,
<span class="line-num">805</span>       <span class="ruby-value">count:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">number_with_delimiter</span>( <span class="ruby-identifier">obs_count</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> ),
<span class="line-num">806</span>       <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">807</span>     <span class="ruby-identifier">obs_count_txt</span> = <span class="ruby-identifier">obs_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">808</span>     <span class="ruby-identifier">obs_label_txt</span> = <span class="ruby-identifier">obs_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">809</span>     <span class="ruby-identifier">species_translation</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;x_species_html&quot;</span>,
<span class="line-num">810</span>       <span class="ruby-value">count:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">number_with_delimiter</span>( <span class="ruby-identifier">species_count</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> ),
<span class="line-num">811</span>       <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">812</span>     <span class="ruby-identifier">species_count_txt</span> = <span class="ruby-identifier">species_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">813</span>     <span class="ruby-identifier">species_label_txt</span> = <span class="ruby-identifier">species_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">814</span>     <span class="ruby-identifier">identifications_translation</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;x_identifications_html&quot;</span>,
<span class="line-num">815</span>       <span class="ruby-value">count:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">number_with_delimiter</span>( <span class="ruby-identifier">identifications_count</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> ),
<span class="line-num">816</span>       <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">817</span>     <span class="ruby-identifier">identifications_count_txt</span> = <span class="ruby-identifier">identifications_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">818</span>     <span class="ruby-identifier">identifications_label_txt</span> = <span class="ruby-identifier">identifications_translation</span>[<span class="ruby-regexp">%r{&lt;span.*?&gt;(.+)&lt;/span&gt;(.+)}</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">819</span>     <span class="ruby-keyword">if</span> [<span class="ruby-identifier">owner</span>, <span class="ruby-identifier">title</span>, <span class="ruby-identifier">species_label_txt</span>, <span class="ruby-identifier">identifications_label_txt</span>, <span class="ruby-identifier">obs_label_txt</span>].<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">|</span>
<span class="line-num">820</span>          <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">non_latin_chars?</span>
<span class="line-num">821</span>        <span class="ruby-keyword">end</span>
<span class="line-num">822</span>       <span class="ruby-keyword">if</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">production?</span>
<span class="line-num">823</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(ja|ko|zh)/</span>
<span class="line-num">824</span>           <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-string">&quot;Noto-Sans-CJK-HK&quot;</span>
<span class="line-num">825</span>           <span class="ruby-identifier">light_font_path</span> = <span class="ruby-string">&quot;Noto-Sans-CJK-HK&quot;</span>
<span class="line-num">826</span>           <span class="ruby-identifier">semibold_font_path</span> = <span class="ruby-string">&quot;Noto-Sans-CJK-HK-Bold&quot;</span>
<span class="line-num">827</span>         <span class="ruby-keyword">else</span>
<span class="line-num">828</span>           <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-string">&quot;DejaVu-Sans&quot;</span>
<span class="line-num">829</span>           <span class="ruby-identifier">light_font_path</span> = <span class="ruby-string">&quot;DejaVu-Sans-ExtraLight&quot;</span>
<span class="line-num">830</span>           <span class="ruby-identifier">semibold_font_path</span> = <span class="ruby-string">&quot;DejaVu-Sans-Bold&quot;</span>
<span class="line-num">831</span>         <span class="ruby-keyword">end</span>
<span class="line-num">832</span>       <span class="ruby-keyword">else</span>
<span class="line-num">833</span>         <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-string">&quot;Helvetica&quot;</span>
<span class="line-num">834</span>         <span class="ruby-identifier">light_font_path</span> = <span class="ruby-string">&quot;Helvetica-Narrow&quot;</span>
<span class="line-num">835</span>         <span class="ruby-identifier">semibold_font_path</span> = <span class="ruby-string">&quot;Helvetica-Bold&quot;</span>
<span class="line-num">836</span>       <span class="ruby-keyword">end</span>
<span class="line-num">837</span>     <span class="ruby-keyword">end</span>
<span class="line-num">838</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">label_method</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;pango&quot;</span>
<span class="line-num">839</span>       <span class="ruby-identifier">title</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 22}&#39;&gt;#{title}&lt;/span&gt;&quot;</span>
<span class="line-num">840</span>       <span class="ruby-identifier">owner</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 20}&#39;&gt;#{owner}&lt;/span&gt;&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">841</span>       <span class="ruby-identifier">obs_count_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 24}&#39;&gt;#{obs_count_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">842</span>       <span class="ruby-identifier">obs_label_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 20}&#39;&gt;#{obs_label_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">843</span>       <span class="ruby-identifier">species_count_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 24}&#39;&gt;#{species_count_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">844</span>       <span class="ruby-identifier">species_label_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 20}&#39;&gt;#{species_label_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">845</span>       <span class="ruby-identifier">identifications_count_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 24}&#39;&gt;#{identifications_count_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">846</span>       <span class="ruby-identifier">identifications_label_txt</span> = <span class="ruby-node">&quot;&lt;span size=&#39;#{1024 * 20}&#39;&gt;#{identifications_label_txt}&lt;/span&gt;&quot;</span>
<span class="line-num">847</span>     <span class="ruby-keyword">end</span>
<span class="line-num">848</span>     <span class="ruby-identifier">title_composite</span> = <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">849</span> <span class="ruby-value">      \\( \
<span class="line-num">850</span>         -size 500x30 \
<span class="line-num">851</span>         -background transparent \
<span class="line-num">852</span>         -font #{light_font_path} \
<span class="line-num">853</span>         -kerning 2 \
<span class="line-num">854</span>         #{label_method}:&quot;#{title}&quot; \
<span class="line-num">855</span>         -trim \
<span class="line-num">856</span>         -gravity center \
<span class="line-num">857</span>         -extent 500x30 \
<span class="line-num">858</span>       \\) \
<span class="line-num">859</span>       -gravity northwest \
<span class="line-num">860</span>       -geometry +0+#{left_vertical_offset + 165} \
<span class="line-num">861</span>       -composite
<span class="line-num">862</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">863</span>     <span class="ruby-identifier">owner_composite</span> = <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">864</span> <span class="ruby-value">      \\( \
<span class="line-num">865</span>         -size 500x40 \
<span class="line-num">866</span>         -background transparent \
<span class="line-num">867</span>         -font #{medium_font_path} \
<span class="line-num">868</span>         #{label_method}:&quot;#{owner}&quot; \
<span class="line-num">869</span>         -trim \
<span class="line-num">870</span>         -gravity center \
<span class="line-num">871</span>         -extent 500x40 \
<span class="line-num">872</span>       \\) \
<span class="line-num">873</span>       -gravity northwest \
<span class="line-num">874</span>       -geometry +0+#{left_vertical_offset + 480} \
<span class="line-num">875</span>       -composite
<span class="line-num">876</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">877</span>     <span class="ruby-identifier">composites</span> = [<span class="ruby-identifier">title_composite</span>]
<span class="line-num">878</span>     <span class="ruby-identifier">composites</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">owner_composite</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">879</span>     [
<span class="line-num">880</span>       [<span class="ruby-identifier">obs_count_txt</span>, <span class="ruby-identifier">obs_label_txt</span>],
<span class="line-num">881</span>       [<span class="ruby-identifier">species_count_txt</span>, <span class="ruby-identifier">species_label_txt</span>],
<span class="line-num">882</span>       [<span class="ruby-identifier">identifications_count_txt</span>, <span class="ruby-identifier">identifications_label_txt</span>]
<span class="line-num">883</span>     ].<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">texts</span>, <span class="ruby-identifier">idx</span> <span class="ruby-operator">|</span>
<span class="line-num">884</span>       <span class="ruby-identifier">count_txt</span>, <span class="ruby-identifier">label_txt</span> = <span class="ruby-identifier">texts</span>
<span class="line-num">885</span>       <span class="ruby-identifier">y</span> = <span class="ruby-value">80</span> <span class="ruby-operator">+</span> ( <span class="ruby-identifier">idx</span> <span class="ruby-operator">*</span> <span class="ruby-value">145</span> )
<span class="line-num">886</span>       <span class="ruby-comment"># text_width = 332 # this would go to the right edge</span>
<span class="line-num">887</span>       <span class="ruby-identifier">text_width</span> = <span class="ruby-value">312</span> <span class="ruby-comment"># this provides a bit of margin</span>
<span class="line-num">888</span>       <span class="ruby-comment"># Note that the use of label below will automatically try to choose the</span>
<span class="line-num">889</span>       <span class="ruby-comment"># best font size to fit the space</span>
<span class="line-num">890</span>       <span class="ruby-identifier">composites</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">891</span> <span class="ruby-value">        \\( \
<span class="line-num">892</span>           -size #{text_width}x55 \
<span class="line-num">893</span>           -background transparent \
<span class="line-num">894</span>           -font #{semibold_font_path} \
<span class="line-num">895</span>           -fill white \
<span class="line-num">896</span>           #{label_method}:&quot;#{count_txt}&quot; \
<span class="line-num">897</span>           -trim \
<span class="line-num">898</span>           -gravity west \
<span class="line-num">899</span>           -extent #{text_width}x55 \
<span class="line-num">900</span>         \\) \
<span class="line-num">901</span>         -gravity northwest \
<span class="line-num">902</span>         -geometry +668+#{y} \
<span class="line-num">903</span>         -composite \
<span class="line-num">904</span>         \\( \
<span class="line-num">905</span>           -size #{text_width}x34 \
<span class="line-num">906</span>           -background transparent \
<span class="line-num">907</span>           -font #{medium_font_path} \
<span class="line-num">908</span>           -kerning 2 \
<span class="line-num">909</span>           -fill white \
<span class="line-num">910</span>           #{label_method}:&quot;#{label_txt}&quot; \
<span class="line-num">911</span>           -trim \
<span class="line-num">912</span>           -gravity west \
<span class="line-num">913</span>           -extent #{text_width}x34 \
<span class="line-num">914</span>         \\) \
<span class="line-num">915</span>         -gravity northwest \
<span class="line-num">916</span>         -geometry +668+#{y + ( 148 - 80 )} \
<span class="line-num">917</span>         -composite
<span class="line-num">918</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">919</span>     <span class="ruby-keyword">end</span>
<span class="line-num">920</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">921</span> <span class="ruby-value">      convert #{background_icon_wordmark_path} \
<span class="line-num">922</span>         #{composites.map( &amp;:strip ).join( &quot; \\\n&quot; )} \
<span class="line-num">923</span>         #{final_path}
<span class="line-num">924</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">925</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;final_path: #{final_path}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">926</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shareable_image</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">final_path</span> )
<span class="line-num">927</span>     <span class="ruby-identifier">save!</span>
<span class="line-num">928</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-generate_shareable_image_obs_grid">
            
              <b>generate_shareable_image_obs_grid</b>()
            
            <a href="../classes/YearStatistic.html#method-i-generate_shareable_image_obs_grid" name="method-i-generate_shareable_image_obs_grid" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-generate_shareable_image_obs_grid_source')" id="l_method-i-generate_shareable_image_obs_grid_source">show</a>
                

                

                
              </p>
              <div id="method-i-generate_shareable_image_obs_grid_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">503</span>   <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_shareable_image_obs_grid</span>
<span class="line-num">504</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">popular_obs</span> = <span class="ruby-identifier">data</span>&amp;.<span class="ruby-identifier">dig</span>( <span class="ruby-value">:observations</span>, <span class="ruby-value">:popular</span> ) )
<span class="line-num">505</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">popular_obs</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">506</span> 
<span class="line-num">507</span>     <span class="ruby-identifier">work_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;year-stat-#{id}-#{Time.now.to_i}&quot;</span> )
<span class="line-num">508</span>     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-identifier">work_path</span>, <span class="ruby-value">mode:</span> <span class="ruby-value">0o755</span>
<span class="line-num">509</span>     <span class="ruby-identifier">image_urls</span> = <span class="ruby-identifier">popular_obs</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;photos&quot;</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:[]</span>, <span class="ruby-value">0</span> ).<span class="ruby-identifier">try</span>( <span class="ruby-value">:[]</span>, <span class="ruby-string">&quot;url&quot;</span> ) }.<span class="ruby-identifier">compact</span>
<span class="line-num">510</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">image_urls</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">511</span> 
<span class="line-num">512</span>     <span class="ruby-identifier">target_size</span> = <span class="ruby-value">200</span>
<span class="line-num">513</span>     <span class="ruby-identifier">image_urls</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">image_urls</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">image_urls</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">target_size</span>
<span class="line-num">514</span>     <span class="ruby-identifier">image_urls</span> = <span class="ruby-identifier">image_urls</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">target_size</span>]
<span class="line-num">515</span> 
<span class="line-num">516</span>     <span class="ruby-comment"># Make the montage</span>
<span class="line-num">517</span>     <span class="ruby-identifier">image_urls</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">url</span>, <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span>
<span class="line-num">518</span>       <span class="ruby-identifier">ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>( <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">url</span> ).<span class="ruby-identifier">path</span> )
<span class="line-num">519</span>       <span class="ruby-identifier">outpath</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-node">&quot;photo-#{i}#{ext}&quot;</span> )
<span class="line-num">520</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;curl -f -s -o #{outpath} #{url}&quot;</span>
<span class="line-num">521</span>     <span class="ruby-keyword">end</span>
<span class="line-num">522</span>     <span class="ruby-identifier">inpaths</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;photo-*&quot;</span> )
<span class="line-num">523</span>     <span class="ruby-identifier">montage_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;montage.jpg&quot;</span> )
<span class="line-num">524</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;montage #{inpaths} -tile 20x -geometry 50x50+0+0 #{montage_path}&quot;</span>
<span class="line-num">525</span> 
<span class="line-num">526</span>     <span class="ruby-comment"># Get the icon</span>
<span class="line-num">527</span>     <span class="ruby-identifier">icon_url</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">528</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">icon</span>.<span class="ruby-identifier">url</span>( <span class="ruby-value">:large</span> ) ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">529</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">530</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">site</span>.<span class="ruby-identifier">logo_square</span>.<span class="ruby-identifier">url</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">531</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">532</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">logo_square</span>.<span class="ruby-identifier">url</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">533</span>     <span class="ruby-keyword">else</span>
<span class="line-num">534</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-string">&quot;bird.png&quot;</span> ).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">%r{([^:])//}</span>, <span class="ruby-string">&quot;\\1/&quot;</span> )
<span class="line-num">535</span>     <span class="ruby-keyword">end</span>
<span class="line-num">536</span>     <span class="ruby-identifier">icon_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>( <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">icon_url</span> ).<span class="ruby-identifier">path</span> )
<span class="line-num">537</span>     <span class="ruby-identifier">icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-node">&quot;icon#{icon_ext}&quot;</span> )
<span class="line-num">538</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;curl -f -s -o #{icon_path} #{icon_url}&quot;</span>
<span class="line-num">539</span> 
<span class="line-num">540</span>     <span class="ruby-comment"># Resize icon to a 500x500 square</span>
<span class="line-num">541</span>     <span class="ruby-identifier">square_icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;square_icon.jpg&quot;</span> )
<span class="line-num">542</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">543</span> <span class="ruby-value">      convert #{icon_path} -resize &quot;500x500^&quot; \
<span class="line-num">544</span>                         -gravity Center  \
<span class="line-num">545</span>                         -extent 500x500  \
<span class="line-num">546</span>               #{square_icon_path}
<span class="line-num">547</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">548</span> 
<span class="line-num">549</span>     <span class="ruby-comment"># Apply circle mask and white border</span>
<span class="line-num">550</span>     <span class="ruby-identifier">circle_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;circle.png&quot;</span> )
<span class="line-num">551</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">552</span> <span class="ruby-value">      convert -size 500x500 xc:black -fill white \
<span class="line-num">553</span>         -draw &quot;translate 250,250 circle 0,0 0,250&quot; -alpha off #{circle_path}
<span class="line-num">554</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">555</span>     <span class="ruby-identifier">circle_icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;circle-user-icon.png&quot;</span> )
<span class="line-num">556</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">557</span> <span class="ruby-value">      convert #{square_icon_path} #{circle_path} \
<span class="line-num">558</span>         -alpha Off -compose CopyOpacity -composite \
<span class="line-num">559</span>         -stroke white -strokewidth 20 -fill transparent -draw &quot;translate 250,250 circle 0,0 0,240&quot; \
<span class="line-num">560</span>         -scale 50% \
<span class="line-num">561</span>         #{circle_icon_path}
<span class="line-num">562</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">563</span> 
<span class="line-num">564</span>     <span class="ruby-comment"># Apply mask to the montage</span>
<span class="line-num">565</span>     <span class="ruby-identifier">ellipse_mask_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;ellipse_mask.png&quot;</span> )
<span class="line-num">566</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;convert -size 1000x500 radial-gradient:\&quot;#ccc\&quot;-\&quot;#111\&quot; #{ellipse_mask_path}&quot;</span>
<span class="line-num">567</span>     <span class="ruby-identifier">ellipse_montage_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;ellipse_montage.jpg&quot;</span> )
<span class="line-num">568</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">569</span> <span class="ruby-value">      convert #{montage_path} #{ellipse_mask_path} \
<span class="line-num">570</span>         -alpha Off -compose multiply -composite\
<span class="line-num">571</span>         #{ellipse_montage_path}
<span class="line-num">572</span> </span><span class="ruby-identifier">    BASH</span>
<span class="line-num">573</span> 
<span class="line-num">574</span>     <span class="ruby-comment"># Overlay the icon onto the montage</span>
<span class="line-num">575</span>     <span class="ruby-identifier">montage_with_icon_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;montage_with_icon.jpg&quot;</span> )
<span class="line-num">576</span>     <span class="ruby-identifier">run_cmd</span> <span class="ruby-node">&quot;composite -gravity center #{circle_icon_path} #{ellipse_montage_path} #{montage_with_icon_path}&quot;</span>
<span class="line-num">577</span> 
<span class="line-num">578</span>     <span class="ruby-comment"># Add the text</span>
<span class="line-num">579</span>     <span class="ruby-identifier">light_font_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;public&quot;</span>, <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;Whitney-Light-Pro.otf&quot;</span> )
<span class="line-num">580</span>     <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;public&quot;</span>, <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;Whitney-Medium-Pro.otf&quot;</span> )
<span class="line-num">581</span>     <span class="ruby-identifier">final_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-identifier">work_path</span>, <span class="ruby-string">&quot;final.jpg&quot;</span> )
<span class="line-num">582</span>     <span class="ruby-identifier">owner</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">583</span>       <span class="ruby-identifier">user</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">name</span>
<span class="line-num">584</span>     <span class="ruby-keyword">else</span>
<span class="line-num">585</span>       <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">586</span>     <span class="ruby-keyword">end</span>
<span class="line-num">587</span>     <span class="ruby-identifier">title</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">588</span>       <span class="ruby-identifier">user_site</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">589</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">590</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">user_site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">591</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">592</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">site</span>
<span class="line-num">593</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">594</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">595</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span> )
<span class="line-num">596</span>     <span class="ruby-keyword">else</span>
<span class="line-num">597</span>       <span class="ruby-identifier">default_site</span> = <span class="ruby-constant">Site</span>.<span class="ruby-identifier">default</span>
<span class="line-num">598</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">599</span>       <span class="ruby-identifier">site_name</span> = <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">site_name_short</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">default_site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">600</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:year_on_site</span>, <span class="ruby-value">year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">site:</span> <span class="ruby-identifier">site_name</span> )
<span class="line-num">601</span>     <span class="ruby-keyword">end</span>
<span class="line-num">602</span>     <span class="ruby-identifier">title</span> = <span class="ruby-identifier">title</span>.<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">603</span>     <span class="ruby-identifier">obs_count</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">604</span>       <span class="ruby-identifier">quality_grade_counts</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">dig</span>( <span class="ruby-string">&quot;observations&quot;</span>, <span class="ruby-string">&quot;quality_grade_counts&quot;</span> )
<span class="line-num">605</span>       <span class="ruby-identifier">quality_grade_counts</span>[<span class="ruby-string">&quot;research&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">quality_grade_counts</span>[<span class="ruby-string">&quot;needs_id&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">606</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span>
<span class="line-num">607</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">608</span>     <span class="ruby-keyword">end</span>
<span class="line-num">609</span>     <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-string">&quot;Lato-Regular&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">non_latin_chars?</span>
<span class="line-num">610</span>     <span class="ruby-identifier">light_font_path</span> = <span class="ruby-string">&quot;Lato-Light&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">title</span>.<span class="ruby-identifier">non_latin_chars?</span>
<span class="line-num">611</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">obs_count</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">612</span>       <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">613</span>       <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>
<span class="line-num">614</span>       <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">615</span>       <span class="ruby-identifier">obs_text</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(
<span class="line-num">616</span>         <span class="ruby-string">&quot;x_observations&quot;</span>,
<span class="line-num">617</span>         <span class="ruby-value">count:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">number_with_delimiter</span>( <span class="ruby-identifier">obs_count</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> ),
<span class="line-num">618</span>         <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>
<span class="line-num">619</span>       ).<span class="ruby-identifier">mb_chars</span>.<span class="ruby-identifier">upcase</span>
<span class="line-num">620</span>       <span class="ruby-identifier">medium_font_path</span> = <span class="ruby-string">&quot;Lato-Regular&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">obs_text</span>.<span class="ruby-identifier">non_latin_chars?</span>
<span class="line-num">621</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">622</span> <span class="ruby-value">        convert #{montage_with_icon_path} \
<span class="line-num">623</span>           -fill white -font #{medium_font_path} -pointsize 24 -gravity north -annotate 0x0+0+30 &quot;#{owner}&quot; \
<span class="line-num">624</span>           -fill white -font #{light_font_path} -pointsize 65 -gravity north -annotate 0x0+0+60 &quot;#{title}&quot; \
<span class="line-num">625</span>           -fill white -font #{medium_font_path} -pointsize 46 -gravity south -annotate 0x0+0+50 &quot;#{obs_text}&quot; \
<span class="line-num">626</span>           #{final_path}
<span class="line-num">627</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">628</span>     <span class="ruby-keyword">else</span>
<span class="line-num">629</span>       <span class="ruby-identifier">run_cmd</span> <span class="ruby-identifier">&lt;&lt;~BASH</span>
<span class="line-num">630</span> <span class="ruby-value">        convert #{montage_with_icon_path} \
<span class="line-num">631</span>           -fill white -font #{medium_font_path} -pointsize 24 -gravity north -annotate 0x0+0+30 &quot;#{owner}&quot; \
<span class="line-num">632</span>           -fill white -font #{light_font_path} -pointsize 65 -gravity north -annotate 0x0+0+60 &quot;#{title}&quot; \
<span class="line-num">633</span>           #{final_path}
<span class="line-num">634</span> </span><span class="ruby-identifier">      BASH</span>
<span class="line-num">635</span>     <span class="ruby-keyword">end</span>
<span class="line-num">636</span> 
<span class="line-num">637</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">shareable_image</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">final_path</span> )
<span class="line-num">638</span>     <span class="ruby-identifier">save!</span>
<span class="line-num">639</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-max_obs_distances_for_user">
            
              <b>max_obs_distances_for_user</b>( year, user )
            
            <a href="../classes/YearStatistic.html#method-i-max_obs_distances_for_user" name="method-i-max_obs_distances_for_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Maximum distance in meters between obs created by a single user for each month of the year. Calculates pairwise comparisons between all obs made by the user in that month so it&#39;s pretty slow.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-max_obs_distances_for_user_source')" id="l_method-i-max_obs_distances_for_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-max_obs_distances_for_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1607</span>   <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">max_obs_distances_for_user</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">user</span> )
<span class="line-num">1608</span>     <span class="ruby-identifier">data</span> = []
<span class="line-num">1609</span>     ( <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">12</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">month</span> <span class="ruby-operator">|</span>
<span class="line-num">1610</span>       <span class="ruby-identifier">d1</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">month</span> )
<span class="line-num">1611</span>       <span class="ruby-identifier">d2</span> = <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">end_of_month</span>
<span class="line-num">1612</span>       <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">1613</span> <span class="ruby-value">        SELECT
<span class="line-num">1614</span>           o1.id,
<span class="line-num">1615</span>           o2.id,
<span class="line-num">1616</span>           ST_DistanceSphere(o1.private_geom, o2.private_geom) AS distance
<span class="line-num">1617</span>         FROM
<span class="line-num">1618</span>           observations o1,
<span class="line-num">1619</span>           observations o2
<span class="line-num">1620</span>         WHERE
<span class="line-num">1621</span>           o1.user_id = #{user.id}
<span class="line-num">1622</span>           AND o2.user_id = #{user.id}
<span class="line-num">1623</span>           AND o1.id != o2.id
<span class="line-num">1624</span>           AND o1.geom IS NOT NULL
<span class="line-num">1625</span>           AND o2.geom IS NOT NULL
<span class="line-num">1626</span>           AND o1.observed_on BETWEEN &#39;#{d1}&#39; AND &#39;#{d2}&#39;
<span class="line-num">1627</span>           AND o2.observed_on BETWEEN &#39;#{d1}&#39; AND &#39;#{d2}&#39;
<span class="line-num">1628</span>         ORDER BY distance DESC
<span class="line-num">1629</span>         LIMIT 1
<span class="line-num">1630</span> </span><span class="ruby-identifier">      SQL</span>
<span class="line-num">1631</span>       <span class="ruby-identifier">r</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>( <span class="ruby-identifier">sql</span> )
<span class="line-num">1632</span>       <span class="ruby-identifier">data</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span>, ( <span class="ruby-identifier">r</span>&amp;.<span class="ruby-identifier">count</span>&amp;.<span class="ruby-identifier">positive?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>][<span class="ruby-string">&quot;distance&quot;</span>] <span class="ruby-operator">:</span> <span class="ruby-value">0</span> ).<span class="ruby-identifier">to_f</span>]
<span class="line-num">1633</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1634</span>     <span class="ruby-comment"># CSV(STDOUT) do |csv|</span>
<span class="line-num">1635</span>     <span class="ruby-comment">#   csv &lt;&lt; %w(date distance)</span>
<span class="line-num">1636</span>     <span class="ruby-comment">#   data.each do |row|</span>
<span class="line-num">1637</span>     <span class="ruby-comment">#     csv &lt;&lt; row</span>
<span class="line-num">1638</span>     <span class="ruby-comment">#   end</span>
<span class="line-num">1639</span>     <span class="ruby-comment"># end</span>
<span class="line-num">1640</span>     <span class="ruby-identifier">data</span>
<span class="line-num">1641</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-run_cmd">
            
              <b>run_cmd</b>( cmd, options = {} )
            
            <a href="../classes/YearStatistic.html#method-i-run_cmd" name="method-i-run_cmd" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-run_cmd_source')" id="l_method-i-run_cmd_source">show</a>
                

                

                
              </p>
              <div id="method-i-run_cmd_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/year_statistic.rb</span>
<span class="line-num">1739</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run_cmd</span>( <span class="ruby-identifier">cmd</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1740</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">run_cmd</span>( <span class="ruby-identifier">cmd</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">1741</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
