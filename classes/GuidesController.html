<!DOCTYPE html>
<html lang="en">
<head>
    <title>GuidesController</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["GuidesController"]'>


    <meta property="og:title" value="GuidesController">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="GuidesController class, index, show, new, edit, create, update, destroy, import_taxa, search, reorder, user, add_color_tags, add_tags_for_rank, remove_all_tags, import_tags_from_csv, import_tags_from_csv_template">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            GuidesController
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationController.html">ApplicationController</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/controllers/guides_controller_rb.html">app/controllers/guides_controller.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add_color_tags">add_color_tags</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_tags_for_rank">add_tags_for_rank</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-create">create</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-destroy">destroy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-edit">edit</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-import_tags_from_csv">import_tags_from_csv</a>,
              </li>
            
              
              <li>
                <a href="#method-i-import_tags_from_csv_template">import_tags_from_csv_template</a>,
              </li>
            
              
              <li>
                <a href="#method-i-import_taxa">import_taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index">index</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-remove_all_tags">remove_all_tags</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reorder">reorder</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-search">search</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show">show</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-update">update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user">user</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="GuidesHelper.html">
              GuidesHelper
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-add_color_tags">
            
              <b>add_color_tags</b>()
            
            <a href="../classes/GuidesController.html#method-i-add_color_tags" name="method-i-add_color_tags" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_color_tags_source')" id="l_method-i-add_color_tags_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_color_tags_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">404</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_color_tags</span>
<span class="line-num">405</span>   <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">taxon:</span> <span class="ruby-value">:colors</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;colors.id IS NOT NULL&quot;</span>)
<span class="line-num">406</span>   <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;guide_taxa.id IN (?)&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide_taxon_ids</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide_taxon_ids</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">407</span>   <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span><span class="ruby-operator">|</span>
<span class="line-num">408</span>     <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">add_color_tags</span>
<span class="line-num">409</span>   <span class="ruby-keyword">end</span>
<span class="line-num">410</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">411</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:tag_list</span>])}
<span class="line-num">412</span>   <span class="ruby-keyword">end</span>
<span class="line-num">413</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-add_tags_for_rank">
            
              <b>add_tags_for_rank</b>()
            
            <a href="../classes/GuidesController.html#method-i-add_tags_for_rank" name="method-i-add_tags_for_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_tags_for_rank_source')" id="l_method-i-add_tags_for_rank_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_tags_for_rank_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">415</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_tags_for_rank</span>
<span class="line-num">416</span>   <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:taxon_names</span>])
<span class="line-num">417</span>   <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;guide_taxa.id IN (?)&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide_taxon_ids</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide_taxon_ids</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">418</span>   <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span><span class="ruby-operator">|</span>
<span class="line-num">419</span>     <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">add_rank_tag</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:rank</span>], <span class="ruby-value">:lexicon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:lexicon</span>])
<span class="line-num">420</span>   <span class="ruby-keyword">end</span>
<span class="line-num">421</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">422</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:tag_list</span>])}
<span class="line-num">423</span>   <span class="ruby-keyword">end</span>
<span class="line-num">424</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create">
            
              <b>create</b>()
            
            <a href="../classes/GuidesController.html#method-i-create" name="method-i-create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>POST /guides POST /guides.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_source')" id="l_method-i-create_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">280</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create</span>
<span class="line-num">281</span>   <span class="ruby-ivar">@guide</span> = <span class="ruby-constant">Guide</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:guide</span>])
<span class="line-num">282</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">283</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">published_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:publish</span>]
<span class="line-num">284</span> 
<span class="line-num">285</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">286</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">save</span>
<span class="line-num">287</span>       <span class="ruby-identifier">create_default_guide_taxa</span>
<span class="line-num">288</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_guide_path</span>(<span class="ruby-ivar">@guide</span>), <span class="ruby-value">notice:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:guide_was_successfully_created</span>) }
<span class="line-num">289</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:root</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>), <span class="ruby-value">status:</span> <span class="ruby-value">:created</span>, <span class="ruby-value">location:</span> <span class="ruby-ivar">@guide</span> }
<span class="line-num">290</span>     <span class="ruby-keyword">else</span>
<span class="line-num">291</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">action:</span> <span class="ruby-string">&quot;new&quot;</span> }
<span class="line-num">292</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">errors</span>, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">293</span>     <span class="ruby-keyword">end</span>
<span class="line-num">294</span>   <span class="ruby-keyword">end</span>
<span class="line-num">295</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy">
            
              <b>destroy</b>()
            
            <a href="../classes/GuidesController.html#method-i-destroy" name="method-i-destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>DELETE /guides/1 DELETE /guides/1.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_source')" id="l_method-i-destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">331</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
<span class="line-num">332</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>
<span class="line-num">333</span>     <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>).<span class="ruby-identifier">destroy</span>
<span class="line-num">334</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:guide_will_be_deleted</span>)
<span class="line-num">335</span>   <span class="ruby-keyword">else</span>
<span class="line-num">336</span>     <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">337</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:guide_deleted</span>)
<span class="line-num">338</span>   <span class="ruby-keyword">end</span>
<span class="line-num">339</span> 
<span class="line-num">340</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">341</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">guides_url</span>, <span class="ruby-value">notice:</span> <span class="ruby-identifier">msg</span> }
<span class="line-num">342</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
<span class="line-num">343</span>   <span class="ruby-keyword">end</span>
<span class="line-num">344</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit">
            
              <b>edit</b>()
            
            <a href="../classes/GuidesController.html#method-i-edit" name="method-i-edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /guides/1/edit</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_source')" id="l_method-i-edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">271</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit</span>
<span class="line-num">272</span>   <span class="ruby-identifier">load_data_for_edit</span>
<span class="line-num">273</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">274</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">275</span>   <span class="ruby-keyword">end</span>
<span class="line-num">276</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import_tags_from_csv">
            
              <b>import_tags_from_csv</b>()
            
            <a href="../classes/GuidesController.html#method-i-import_tags_from_csv" name="method-i-import_tags_from_csv" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_tags_from_csv_source')" id="l_method-i-import_tags_from_csv_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_tags_from_csv_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">436</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_tags_from_csv</span>
<span class="line-num">437</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:file</span>]
<span class="line-num">438</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">439</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">440</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-string">&quot;You must choose a CSV file.&quot;</span>
<span class="line-num">441</span>         <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@guide</span>)
<span class="line-num">442</span>         <span class="ruby-keyword">return</span>
<span class="line-num">443</span>       <span class="ruby-keyword">end</span>
<span class="line-num">444</span>     <span class="ruby-keyword">end</span>
<span class="line-num">445</span>   <span class="ruby-keyword">end</span>
<span class="line-num">446</span>   <span class="ruby-identifier">tags</span> = {}
<span class="line-num">447</span>   <span class="ruby-identifier">row_handler</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">448</span>     <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">row</span>[<span class="ruby-value">0</span>]] <span class="ruby-operator">||=</span> []
<span class="line-num">449</span>     <span class="ruby-identifier">row</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pair</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">450</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">451</span>       <span class="ruby-identifier">header</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">pair</span>
<span class="line-num">452</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">453</span>       <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;|&#39;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">454</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">455</span>           <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">row</span>[<span class="ruby-value">0</span>]] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">v</span>
<span class="line-num">456</span>         <span class="ruby-keyword">else</span>
<span class="line-num">457</span>           <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">row</span>[<span class="ruby-value">0</span>]] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{header}=#{v}&quot;</span>
<span class="line-num">458</span>         <span class="ruby-keyword">end</span>
<span class="line-num">459</span>       <span class="ruby-keyword">end</span>
<span class="line-num">460</span>     <span class="ruby-keyword">end</span>
<span class="line-num">461</span>   <span class="ruby-keyword">end</span>
<span class="line-num">462</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">463</span>     <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">foreach</span>(<span class="ruby-identifier">open</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:file</span>]), <span class="ruby-value">headers:</span> <span class="ruby-keyword">true</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">row_handler</span>)
<span class="line-num">464</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">465</span>     <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/invalid byte sequence in UTF-8/</span>
<span class="line-num">466</span>     <span class="ruby-comment"># if there&#39;s an encoding issue we&#39;ll try to load the entire file and adjust the encoding</span>
<span class="line-num">467</span>     <span class="ruby-identifier">content</span> = <span class="ruby-identifier">open</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:file</span>]).<span class="ruby-identifier">read</span>
<span class="line-num">468</span>     <span class="ruby-identifier">utf_content</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">content</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;UTF-8&#39;</span>
<span class="line-num">469</span>       <span class="ruby-comment"># if Ruby thinks it&#39;s UTF-8 but it obviously isn&#39;t, we&#39;ll assume it&#39;s LATIN1</span>
<span class="line-num">470</span>       <span class="ruby-identifier">content</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-string">&#39;ISO-8859-1&#39;</span>)
<span class="line-num">471</span>       <span class="ruby-identifier">content</span>.<span class="ruby-identifier">encode</span>(<span class="ruby-string">&#39;UTF-8&#39;</span>)
<span class="line-num">472</span>     <span class="ruby-keyword">else</span>
<span class="line-num">473</span>       <span class="ruby-comment"># otherwise we try to coerce it into UTF-8</span>
<span class="line-num">474</span>       <span class="ruby-identifier">content</span>.<span class="ruby-identifier">encode</span>(<span class="ruby-string">&#39;UTF-8&#39;</span>)
<span class="line-num">475</span>     <span class="ruby-keyword">end</span>
<span class="line-num">476</span>     <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">utf_content</span>, <span class="ruby-value">headers:</span> <span class="ruby-keyword">true</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">row_handler</span>)
<span class="line-num">477</span>   <span class="ruby-keyword">end</span>
<span class="line-num">478</span> 
<span class="line-num">479</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span><span class="ruby-operator">|</span>
<span class="line-num">480</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">name</span>]
<span class="line-num">481</span>     <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">tag_list:</span> <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">tag_list</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">name</span>])
<span class="line-num">482</span>   <span class="ruby-keyword">end</span>
<span class="line-num">483</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">484</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@guide</span>) }
<span class="line-num">485</span>   <span class="ruby-keyword">end</span>
<span class="line-num">486</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import_tags_from_csv_template">
            
              <b>import_tags_from_csv_template</b>()
            
            <a href="../classes/GuidesController.html#method-i-import_tags_from_csv_template" name="method-i-import_tags_from_csv_template" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_tags_from_csv_template_source')" id="l_method-i-import_tags_from_csv_template_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_tags_from_csv_template_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">488</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_tags_from_csv_template</span>
<span class="line-num">489</span>   <span class="ruby-identifier">tags</span> = {}
<span class="line-num">490</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
<span class="line-num">491</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:position</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">taggings:</span> <span class="ruby-value">:tag</span>).<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">492</span>     <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">493</span>     <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
<span class="line-num">494</span>       <span class="ruby-identifier">namespace</span>, <span class="ruby-identifier">predicate</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">machine_tag_pieces</span>(<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span>)
<span class="line-num">495</span>       <span class="ruby-identifier">header</span> = [<span class="ruby-identifier">namespace</span>, <span class="ruby-identifier">predicate</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;:&#39;</span>)
<span class="line-num">496</span>       <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">header</span>
<span class="line-num">497</span>       <span class="ruby-identifier">tags</span>[<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">name</span>][<span class="ruby-identifier">header</span>] = [<span class="ruby-identifier">tags</span>[<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">name</span>][<span class="ruby-identifier">header</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;|&#39;</span>), <span class="ruby-identifier">value</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;|&#39;</span>)
<span class="line-num">498</span>     <span class="ruby-keyword">end</span>
<span class="line-num">499</span>   <span class="ruby-keyword">end</span>
<span class="line-num">500</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">sort</span>
<span class="line-num">501</span>   <span class="ruby-identifier">csvdata</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">generate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">502</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">&#39;Name&#39;</span>, <span class="ruby-identifier">headers</span>].<span class="ruby-identifier">flatten</span>
<span class="line-num">503</span>     <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">values_by_headers</span><span class="ruby-operator">|</span>
<span class="line-num">504</span>       <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">name</span>]
<span class="line-num">505</span>       <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header</span><span class="ruby-operator">|</span>
<span class="line-num">506</span>         <span class="ruby-identifier">line</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">values_by_headers</span>[<span class="ruby-identifier">header</span>]
<span class="line-num">507</span>       <span class="ruby-keyword">end</span>
<span class="line-num">508</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">line</span>
<span class="line-num">509</span>     <span class="ruby-keyword">end</span>
<span class="line-num">510</span>   <span class="ruby-keyword">end</span>
<span class="line-num">511</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">512</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span>
<span class="line-num">513</span>       <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">csvdata</span>, { <span class="ruby-value">:filename</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@guide.title.parameterize}.csv&quot;</span>, <span class="ruby-value">:type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:csv</span> })
<span class="line-num">514</span>     <span class="ruby-keyword">end</span>
<span class="line-num">515</span>   <span class="ruby-keyword">end</span>
<span class="line-num">516</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import_taxa">
            
              <b>import_taxa</b>()
            
            <a href="../classes/GuidesController.html#method-i-import_taxa" name="method-i-import_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_taxa_source')" id="l_method-i-import_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_taxa_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">346</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_taxa</span>
<span class="line-num">347</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">348</span>     <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">import_taxa</span>(<span class="ruby-identifier">params</span>) <span class="ruby-operator">||</span> []
<span class="line-num">349</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">OpenURI</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">350</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">351</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">352</span>         <span class="ruby-identifier">msg</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:eol_collection_url</span>]
<span class="line-num">353</span>           <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_x_is_not_responding</span>, <span class="ruby-value">:x</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;EOL&quot;</span>)
<span class="line-num">354</span>         <span class="ruby-keyword">else</span>
<span class="line-num">355</span>           <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_that_service_is_not_responding</span>)
<span class="line-num">356</span>         <span class="ruby-keyword">end</span>
<span class="line-num">357</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">358</span>       <span class="ruby-keyword">end</span>
<span class="line-num">359</span>     <span class="ruby-keyword">end</span>
<span class="line-num">360</span>     <span class="ruby-keyword">return</span>
<span class="line-num">361</span>   <span class="ruby-keyword">end</span>
<span class="line-num">362</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">363</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">364</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">partial</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]
<span class="line-num">365</span>         <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">366</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">new_record?</span>
<span class="line-num">367</span>           <span class="ruby-ivar">@guide_taxa</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">html</span> = <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">render_in_format</span>(<span class="ruby-value">:html</span>, <span class="ruby-identifier">partial</span>, <span class="ruby-value">:guide_taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">gt</span>)
<span class="line-num">368</span>         <span class="ruby-keyword">end</span>
<span class="line-num">369</span>       <span class="ruby-keyword">end</span>
<span class="line-num">370</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:guide_taxa</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:root</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:errors</span>, <span class="ruby-value">:html</span>, <span class="ruby-value">:valid?</span>])}
<span class="line-num">371</span>     <span class="ruby-keyword">end</span>
<span class="line-num">372</span>   <span class="ruby-keyword">end</span>
<span class="line-num">373</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index">
            
              <b>index</b>()
            
            <a href="../classes/GuidesController.html#method-i-index" name="method-i-index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /guides GET /guides.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_source')" id="l_method-i-index_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">25</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
<span class="line-num">26</span>   <span class="ruby-ivar">@guides</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:by</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;you&quot;</span>
<span class="line-num">27</span>     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">editing_guides</span>.<span class="ruby-identifier">not_flagged_as_spam</span>.
<span class="line-num">28</span>       <span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;guides.id DESC&quot;</span>)
<span class="line-num">29</span>   <span class="ruby-keyword">else</span>
<span class="line-num">30</span>     <span class="ruby-constant">Guide</span>.<span class="ruby-identifier">not_flagged_as_spam</span>.<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).
<span class="line-num">31</span>       <span class="ruby-identifier">per_page</span>(<span class="ruby-identifier">limited_per_page</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;guides.id DESC&quot;</span>).<span class="ruby-identifier">published</span>
<span class="line-num">32</span>   <span class="ruby-keyword">end</span>
<span class="line-num">33</span>   <span class="ruby-ivar">@guides</span> = <span class="ruby-ivar">@guides</span>.<span class="ruby-identifier">near_point</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]
<span class="line-num">34</span> 
<span class="line-num">35</span>   <span class="ruby-ivar">@root_place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>
<span class="line-num">36</span>   <span class="ruby-ivar">@place</span> = (<span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">37</span>   <span class="ruby-ivar">@place</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@root_place</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:by</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;you&quot;</span>
<span class="line-num">38</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">39</span>     <span class="ruby-ivar">@guides</span> = <span class="ruby-ivar">@guides</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:place</span>).<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;places.id = ? OR (#{Place.send(:sanitize_sql, @place.descendant_conditions.to_sql)})&quot;</span>, <span class="ruby-ivar">@place</span>)
<span class="line-num">40</span>   <span class="ruby-keyword">end</span>
<span class="line-num">41</span> 
<span class="line-num">42</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">43</span>     <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>])
<span class="line-num">44</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">45</span>       <span class="ruby-ivar">@guides</span> = <span class="ruby-ivar">@guides</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;taxa.id = ? OR (#{Taxon.send(:sanitize_sql, @taxon.descendant_conditions.to_sql)})&quot;</span>, <span class="ruby-ivar">@taxon</span>)
<span class="line-num">46</span>     <span class="ruby-keyword">end</span>
<span class="line-num">47</span>   <span class="ruby-keyword">end</span>
<span class="line-num">48</span> 
<span class="line-num">49</span>   <span class="ruby-identifier">nav_places_for_index</span>
<span class="line-num">50</span>   <span class="ruby-identifier">nav_taxa_for_index</span>
<span class="line-num">51</span> 
<span class="line-num">52</span>   <span class="ruby-identifier">pagination_headers_for</span>(<span class="ruby-ivar">@observations</span>)
<span class="line-num">53</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">54</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">55</span>       <span class="ruby-ivar">@guides</span> = <span class="ruby-ivar">@guides</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:guide_users</span>)
<span class="line-num">56</span>     <span class="ruby-keyword">end</span>
<span class="line-num">57</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guides</span> }
<span class="line-num">58</span>   <span class="ruby-keyword">end</span>
<span class="line-num">59</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new">
            
              <b>new</b>()
            
            <a href="../classes/GuidesController.html#method-i-new" name="method-i-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /guides/new GET /guides/new.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_source')" id="l_method-i-new_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">258</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new</span>
<span class="line-num">259</span>   <span class="ruby-ivar">@guide</span> = <span class="ruby-constant">Guide</span>.<span class="ruby-identifier">new</span>
<span class="line-num">260</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:source_url</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">261</span>     <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">source_url</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:source_url</span>]
<span class="line-num">262</span>     <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">set_defaults_from_source_url</span>(<span class="ruby-value">:skip_icon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">263</span>   <span class="ruby-keyword">end</span>
<span class="line-num">264</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">265</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment"># new.html.erb</span>
<span class="line-num">266</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:root</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) }
<span class="line-num">267</span>   <span class="ruby-keyword">end</span>
<span class="line-num">268</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_all_tags">
            
              <b>remove_all_tags</b>()
            
            <a href="../classes/GuidesController.html#method-i-remove_all_tags" name="method-i-remove_all_tags" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_all_tags_source')" id="l_method-i-remove_all_tags_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_all_tags_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">426</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_all_tags</span>
<span class="line-num">427</span>   <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>
<span class="line-num">428</span>   <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gt</span><span class="ruby-operator">|</span>
<span class="line-num">429</span>     <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">taggings</span>.<span class="ruby-identifier">delete_all</span>
<span class="line-num">430</span>   <span class="ruby-keyword">end</span>
<span class="line-num">431</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">432</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:tag_list</span>])}
<span class="line-num">433</span>   <span class="ruby-keyword">end</span>
<span class="line-num">434</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reorder">
            
              <b>reorder</b>()
            
            <a href="../classes/GuidesController.html#method-i-reorder" name="method-i-reorder" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reorder_source')" id="l_method-i-reorder_source">show</a>
                

                

                
              </p>
              <div id="method-i-reorder_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">386</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reorder</span>
<span class="line-num">387</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">reorder_by_taxonomy</span>
<span class="line-num">388</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">389</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_guide_path</span>(<span class="ruby-ivar">@guide</span>) }
<span class="line-num">390</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">204</span> }
<span class="line-num">391</span>   <span class="ruby-keyword">end</span>
<span class="line-num">392</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-search">
            
              <b>search</b>()
            
            <a href="../classes/GuidesController.html#method-i-search" name="method-i-search" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-search_source')" id="l_method-i-search_source">show</a>
                

                

                
              </p>
              <div id="method-i-search_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">375</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">search</span>
<span class="line-num">376</span>   <span class="ruby-ivar">@guides</span> = <span class="ruby-constant">Guide</span>.<span class="ruby-identifier">published</span>.<span class="ruby-identifier">dbsearch</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>]).<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">per_page</span>(<span class="ruby-identifier">limited_per_page</span>)
<span class="line-num">377</span>   <span class="ruby-identifier">pagination_headers_for</span> <span class="ruby-ivar">@guides</span>
<span class="line-num">378</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">379</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">380</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">381</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guides</span>
<span class="line-num">382</span>     <span class="ruby-keyword">end</span>
<span class="line-num">383</span>   <span class="ruby-keyword">end</span>
<span class="line-num">384</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show">
            
              <b>show</b>()
            
            <a href="../classes/GuidesController.html#method-i-show" name="method-i-show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /guides/1 GET /guides/1.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_source')" id="l_method-i-show_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">143</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show</span>
<span class="line-num">144</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">published?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">editable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">145</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">146</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render_404</span> }
<span class="line-num">147</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span>(<span class="ruby-value">:xml</span>, <span class="ruby-value">:ngz</span>) { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">404</span>, <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;&quot;</span>}
<span class="line-num">148</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Not found&quot;</span>}, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">404</span> }
<span class="line-num">149</span>     <span class="ruby-keyword">end</span>
<span class="line-num">150</span>     <span class="ruby-keyword">return</span>
<span class="line-num">151</span>   <span class="ruby-keyword">end</span>
<span class="line-num">152</span>   <span class="ruby-identifier">guide_taxa_from_params</span>
<span class="line-num">153</span>   <span class="ruby-ivar">@photo_tag</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;photo-tag&#39;</span>]
<span class="line-num">154</span> 
<span class="line-num">155</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">156</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">157</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:print</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">158</span>         <span class="ruby-ivar">@layout</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:layout</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">Guide</span><span class="ruby-operator">::</span><span class="ruby-constant">PDF_LAYOUTS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:layout</span>])
<span class="line-num">159</span>         <span class="ruby-ivar">@layout</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Guide</span><span class="ruby-operator">::</span><span class="ruby-constant">GRID</span>
<span class="line-num">160</span>         <span class="ruby-ivar">@template</span> = <span class="ruby-node">&quot;guides/show_#{@layout}.pdf.haml&quot;</span>
<span class="line-num">161</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap.pdf&quot;</span>,
<span class="line-num">162</span>           <span class="ruby-value">template:</span> <span class="ruby-ivar">@template</span>,
<span class="line-num">163</span>           <span class="ruby-value">orientation:</span> <span class="ruby-ivar">@layout</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;journal&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;Landscape&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">164</span>           <span class="ruby-value">margin:</span> {
<span class="line-num">165</span>             <span class="ruby-value">:left</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0</span>,
<span class="line-num">166</span>             <span class="ruby-value">:right</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">167</span>           }
<span class="line-num">168</span>         <span class="ruby-keyword">return</span>
<span class="line-num">169</span>       <span class="ruby-keyword">end</span>
<span class="line-num">170</span>       <span class="ruby-ivar">@guide_taxa</span> = <span class="ruby-ivar">@guide_taxa</span>.<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">per_page</span>(<span class="ruby-value">100</span>)
<span class="line-num">171</span>       <span class="ruby-constant">GuideTaxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@guide_taxa</span>, [
<span class="line-num">172</span>         { <span class="ruby-value">guide_photos:</span> [ { <span class="ruby-value">photo:</span> [<span class="ruby-value">:flags</span>, <span class="ruby-value">:file_prefix</span>, <span class="ruby-value">:file_extension</span>] }, { <span class="ruby-value">taggings:</span> <span class="ruby-value">:tag</span> } ] } ])
<span class="line-num">173</span>       <span class="ruby-ivar">@tag_counts</span> = <span class="ruby-constant">ActsAsTaggableOn</span><span class="ruby-operator">::</span><span class="ruby-constant">Tag</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taggings</span>).
<span class="line-num">174</span>         <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;JOIN guide_taxa gt ON gt.id = taggings.taggable_id&quot;</span>).
<span class="line-num">175</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taggings.taggable_type = &#39;GuideTaxon&#39; AND taggings.context = &#39;tags&#39; AND gt.guide_id = ?&quot;</span>, <span class="ruby-ivar">@guide</span>).
<span class="line-num">176</span>         <span class="ruby-identifier">group</span>(<span class="ruby-string">&quot;tags.name&quot;</span>).
<span class="line-num">177</span>         <span class="ruby-identifier">count</span>
<span class="line-num">178</span>       <span class="ruby-ivar">@nav_tags</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">OrderedHash</span>.<span class="ruby-identifier">new</span>
<span class="line-num">179</span>       <span class="ruby-ivar">@tag_counts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span>, <span class="ruby-identifier">count</span><span class="ruby-operator">|</span>
<span class="line-num">180</span>         <span class="ruby-identifier">namespace</span>, <span class="ruby-identifier">predicate</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;tags&quot;</span>
<span class="line-num">181</span>         <span class="ruby-identifier">nsp</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;=&#39;</span>)
<span class="line-num">182</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">183</span>           <span class="ruby-identifier">value</span> = <span class="ruby-identifier">nsp</span>
<span class="line-num">184</span>         <span class="ruby-keyword">else</span>
<span class="line-num">185</span>           <span class="ruby-identifier">namespace</span>, <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">nsp</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;:&#39;</span>)
<span class="line-num">186</span>           <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">namespace</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">187</span>         <span class="ruby-keyword">end</span>
<span class="line-num">188</span>         <span class="ruby-ivar">@nav_tags</span>[<span class="ruby-identifier">predicate</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">189</span>         <span class="ruby-ivar">@nav_tags</span>[<span class="ruby-identifier">predicate</span>] <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">count</span>]
<span class="line-num">190</span>       <span class="ruby-keyword">end</span>
<span class="line-num">191</span> 
<span class="line-num">192</span>       <span class="ruby-identifier">photo_tag_counts</span> = <span class="ruby-constant">ActsAsTaggableOn</span><span class="ruby-operator">::</span><span class="ruby-constant">Tag</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taggings</span>).
<span class="line-num">193</span>         <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;JOIN guide_photos gp ON gp.id = taggings.taggable_id&quot;</span>).
<span class="line-num">194</span>         <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;JOIN guide_taxa gt ON gt.id = gp.guide_taxon_id&quot;</span>).
<span class="line-num">195</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taggings.taggable_type = &#39;GuidePhoto&#39; AND taggings.context = &#39;tags&#39; AND gt.guide_id = ?&quot;</span>, <span class="ruby-ivar">@guide</span>).
<span class="line-num">196</span>         <span class="ruby-identifier">group</span>(<span class="ruby-string">&quot;tags.name&quot;</span>).
<span class="line-num">197</span>         <span class="ruby-identifier">count</span>
<span class="line-num">198</span>       <span class="ruby-ivar">@photo_tags</span> = <span class="ruby-identifier">photo_tag_counts</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">sort</span>
<span class="line-num">199</span>       
<span class="line-num">200</span>       <span class="ruby-identifier">ancestry_counts_scope</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:guide_taxa</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;guide_taxa.guide_id = ?&quot;</span>, <span class="ruby-ivar">@guide</span>)
<span class="line-num">201</span>       <span class="ruby-identifier">ancestry_counts_scope</span> = <span class="ruby-identifier">ancestry_counts_scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">descendant_conditions</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">202</span>       <span class="ruby-identifier">ancestry_counts</span> = <span class="ruby-identifier">ancestry_counts_scope</span>.<span class="ruby-identifier">group</span>(<span class="ruby-value">:ancestry</span>).<span class="ruby-identifier">count</span>
<span class="line-num">203</span>       <span class="ruby-identifier">ancestries</span> = <span class="ruby-identifier">ancestry_counts</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;/&#39;</span>)}.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:size</span>).<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>}
<span class="line-num">204</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestries</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">205</span>         <span class="ruby-ivar">@nav_taxa</span> = []
<span class="line-num">206</span>         <span class="ruby-ivar">@nav_taxa_counts</span> = {}
<span class="line-num">207</span>       <span class="ruby-keyword">else</span>
<span class="line-num">208</span>         <span class="ruby-identifier">width</span> = <span class="ruby-identifier">ancestries</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">size</span>
<span class="line-num">209</span>         <span class="ruby-identifier">matrix</span> = <span class="ruby-identifier">ancestries</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">210</span>           <span class="ruby-identifier">a</span> <span class="ruby-operator">+</span> ([<span class="ruby-keyword">nil</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">width</span><span class="ruby-operator">-</span><span class="ruby-identifier">a</span>.<span class="ruby-identifier">size</span>))
<span class="line-num">211</span>         <span class="ruby-keyword">end</span>
<span class="line-num">212</span>         <span class="ruby-comment"># start at the right col (lowest rank), look for the first occurrence of</span>
<span class="line-num">213</span>         <span class="ruby-comment"># consensus within a rank</span>
<span class="line-num">214</span>         <span class="ruby-identifier">consensus_taxon_id</span>, <span class="ruby-identifier">subconsensus_taxon_ids</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>
<span class="line-num">215</span>         (<span class="ruby-identifier">width</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">downto</span>(<span class="ruby-value">0</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num">216</span>           <span class="ruby-identifier">column_taxon_ids</span> = <span class="ruby-identifier">matrix</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ancestry</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ancestry</span>[<span class="ruby-identifier">c</span>]}
<span class="line-num">217</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">column_taxon_ids</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">column_taxon_ids</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">218</span>             <span class="ruby-identifier">consensus_taxon_id</span> = <span class="ruby-identifier">column_taxon_ids</span>.<span class="ruby-identifier">first</span>
<span class="line-num">219</span>             <span class="ruby-identifier">subconsensus_taxon_ids</span> = <span class="ruby-identifier">matrix</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ancestry</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ancestry</span>[<span class="ruby-identifier">c</span><span class="ruby-value">+1</span>]}.<span class="ruby-identifier">uniq</span>
<span class="line-num">220</span>             <span class="ruby-keyword">break</span>
<span class="line-num">221</span>           <span class="ruby-keyword">end</span>
<span class="line-num">222</span>         <span class="ruby-keyword">end</span>
<span class="line-num">223</span>         <span class="ruby-identifier">subconsensus_taxon_ids</span>.<span class="ruby-identifier">compact!</span>
<span class="line-num">224</span>         <span class="ruby-ivar">@nav_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">subconsensus_taxon_ids</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>).<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>)
<span class="line-num">225</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@nav_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:rank</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@nav_taxa</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">species?</span>
<span class="line-num">226</span>           <span class="ruby-ivar">@nav_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">consensus_taxon_id</span>)
<span class="line-num">227</span>         <span class="ruby-keyword">end</span>
<span class="line-num">228</span>         <span class="ruby-ivar">@nav_taxa_counts</span> = {}
<span class="line-num">229</span>         <span class="ruby-ivar">@nav_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">230</span>           <span class="ruby-ivar">@nav_taxa_counts</span>[<span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>] = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">guide_taxa</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).<span class="ruby-identifier">where</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">descendant_conditions</span>).<span class="ruby-identifier">count</span>
<span class="line-num">231</span>         <span class="ruby-keyword">end</span>
<span class="line-num">232</span>       <span class="ruby-keyword">end</span>
<span class="line-num">233</span>     <span class="ruby-keyword">end</span>
<span class="line-num">234</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:root</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) }
<span class="line-num">235</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>
<span class="line-num">236</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">ngz</span> <span class="ruby-keyword">do</span>
<span class="line-num">237</span>       <span class="ruby-identifier">path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-node">&quot;public/guides/#{@guide.to_param}.ngz&quot;</span> )
<span class="line-num">238</span>       <span class="ruby-identifier">job_id</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">generate_ngz_cache_key</span>)
<span class="line-num">239</span>       <span class="ruby-identifier">job</span> = <span class="ruby-constant">Delayed</span><span class="ruby-operator">::</span><span class="ruby-constant">Job</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">job_id</span>)
<span class="line-num">240</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">job</span>
<span class="line-num">241</span>         <span class="ruby-comment"># Still working&quot;</span>
<span class="line-num">242</span>         <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Failed to generate NGZ for guide #{@guide.id}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">job</span>.<span class="ruby-identifier">last_error</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">243</span>       <span class="ruby-keyword">else</span>
<span class="line-num">244</span>         <span class="ruby-comment"># no job id, no job, let&#39;s get this party started</span>
<span class="line-num">245</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">generate_ngz_cache_key</span>)
<span class="line-num">246</span>         <span class="ruby-identifier">job</span> = <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">generate_ngz_later</span>( <span class="ruby-value">path:</span> <span class="ruby-identifier">path</span> )
<span class="line-num">247</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">write</span>(<span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">generate_ngz_cache_key</span>, <span class="ruby-identifier">job</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:expires_in</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">hour</span>)
<span class="line-num">248</span>       <span class="ruby-keyword">end</span>
<span class="line-num">249</span>       <span class="ruby-identifier">prevent_caching</span>
<span class="line-num">250</span>       <span class="ruby-comment"># Would prefer to use accepted, but don&#39;t want to deliver an invlid zip file</span>
<span class="line-num">251</span>       <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">252</span>     <span class="ruby-keyword">end</span>
<span class="line-num">253</span>   <span class="ruby-keyword">end</span>
<span class="line-num">254</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>()
            
            <a href="../classes/GuidesController.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>PUT /guides/1 PUT /guides/1.json</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">299</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>
<span class="line-num">300</span>   <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">icon</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:icon_delete</span>]
<span class="line-num">301</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">302</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:publish</span>]
<span class="line-num">303</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide</span>][<span class="ruby-value">:publish</span>] = <span class="ruby-string">&quot;publish&quot;</span>
<span class="line-num">304</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:unpublish</span>]
<span class="line-num">305</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:guide</span>][<span class="ruby-value">:publish</span>] = <span class="ruby-string">&quot;unpublish&quot;</span>
<span class="line-num">306</span>   <span class="ruby-keyword">end</span>
<span class="line-num">307</span>   <span class="ruby-identifier">create_default_guide_taxa</span>
<span class="line-num">308</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">309</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">guide_params</span>)
<span class="line-num">310</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">311</span>         <span class="ruby-identifier">notice</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:publish</span>]
<span class="line-num">312</span>           <span class="ruby-identifier">t</span>( <span class="ruby-value">:guide_was_successfully_published</span> )
<span class="line-num">313</span>         <span class="ruby-keyword">else</span>
<span class="line-num">314</span>           <span class="ruby-identifier">t</span>( <span class="ruby-value">:guide_was_successfully_updated</span> )
<span class="line-num">315</span>         <span class="ruby-keyword">end</span>
<span class="line-num">316</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@guide</span>, <span class="ruby-value">notice:</span> <span class="ruby-identifier">notice</span>
<span class="line-num">317</span>       <span class="ruby-keyword">end</span>
<span class="line-num">318</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
<span class="line-num">319</span>     <span class="ruby-keyword">else</span>
<span class="line-num">320</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">321</span>         <span class="ruby-identifier">load_data_for_edit</span>
<span class="line-num">322</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">action:</span> <span class="ruby-string">&quot;edit&quot;</span>
<span class="line-num">323</span>       <span class="ruby-keyword">end</span>
<span class="line-num">324</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@guide</span>.<span class="ruby-identifier">errors</span>, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">325</span>     <span class="ruby-keyword">end</span>
<span class="line-num">326</span>   <span class="ruby-keyword">end</span>
<span class="line-num">327</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user">
            
              <b>user</b>()
            
            <a href="../classes/GuidesController.html#method-i-user" name="method-i-user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_source')" id="l_method-i-user_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/guides_controller.rb</span>
<span class="line-num">394</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user</span>
<span class="line-num">395</span>   <span class="ruby-ivar">@guides</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">editing_guides</span>.<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">per_page</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">order</span>(
<span class="line-num">396</span>     <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;lower(title)&quot;</span> )
<span class="line-num">397</span>   )
<span class="line-num">398</span>   <span class="ruby-identifier">pagination_headers_for</span>(<span class="ruby-ivar">@observations</span>)
<span class="line-num">399</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">400</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@guides</span> }
<span class="line-num">401</span>   <span class="ruby-keyword">end</span>
<span class="line-num">402</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
