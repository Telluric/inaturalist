<!DOCTYPE html>
<html lang="en">
<head>
    <title>ProjectsController</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["ProjectsController"]'>


    <meta property="og:title" value="ProjectsController">

  

    <meta name="keywords" content="ProjectsController class, index, browse, convert_to_collection, convert_to_traditional, show, bulk_template, new_traditional, new, edit, create, update, destroy, terms, by_login, members, observed_taxa_count, contributors, show_contributor, list, change_role, remove_project_user, join, confirm_leave, leave, calendar, stats, add, remove, add_batch, remove_batch, search, invite, stats_slideshow, change_admin, feature, unfeature">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            ProjectsController
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationController.html">ApplicationController</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/controllers/projects_controller_rb.html">app/controllers/projects_controller.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add">add</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_batch">add_batch</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-browse">browse</a>,
              </li>
            
              
              <li>
                <a href="#method-i-bulk_template">bulk_template</a>,
              </li>
            
              
              <li>
                <a href="#method-i-by_login">by_login</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-calendar">calendar</a>,
              </li>
            
              
              <li>
                <a href="#method-i-change_admin">change_admin</a>,
              </li>
            
              
              <li>
                <a href="#method-i-change_role">change_role</a>,
              </li>
            
              
              <li>
                <a href="#method-i-confirm_leave">confirm_leave</a>,
              </li>
            
              
              <li>
                <a href="#method-i-contributors">contributors</a>,
              </li>
            
              
              <li>
                <a href="#method-i-convert_to_collection">convert_to_collection</a>,
              </li>
            
              
              <li>
                <a href="#method-i-convert_to_traditional">convert_to_traditional</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create">create</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-destroy">destroy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-edit">edit</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-feature">feature</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-index">index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-invite">invite</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>J</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-join">join</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-leave">leave</a>,
              </li>
            
              
              <li>
                <a href="#method-i-list">list</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-members">members</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-new">new</a>,
              </li>
            
              
              <li>
                <a href="#method-i-new_traditional">new_traditional</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-observed_taxa_count">observed_taxa_count</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-remove">remove</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_batch">remove_batch</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_project_user">remove_project_user</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-search">search</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show">show</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show_contributor">show_contributor</a>,
              </li>
            
              
              <li>
                <a href="#method-i-stats">stats</a>,
              </li>
            
              
              <li>
                <a href="#method-i-stats_slideshow">stats_slideshow</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-terms">terms</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-unfeature">unfeature</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update">update</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ORDERS</td>
            <td>=</td>
            <td class="attr-value">%w(title created)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ORDER_CLAUSES</td>
            <td>=</td>
            <td class="attr-value">{
&#39;title&#39; =&gt; &#39;lower(title)&#39;,
&#39;created&#39; =&gt; &#39;id&#39;
}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">WIDGET_CACHE_EXPIRATION</td>
            <td>=</td>
            <td class="attr-value">15.minutes</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-add">
            
              <b>add</b>()
            
            <a href="../classes/ProjectsController.html#method-i-add" name="method-i-add" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_source')" id="l_method-i-add_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">912</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add</span>
<span class="line-num">913</span>   <span class="ruby-identifier">error_msg</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">914</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>])
<span class="line-num">915</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_observation_doesnt_exist</span>)
<span class="line-num">916</span>   <span class="ruby-keyword">end</span>
<span class="line-num">917</span> 
<span class="line-num">918</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_observation</span> = <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">where</span>(
<span class="line-num">919</span>       <span class="ruby-value">:project_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:observation_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">920</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:the_observation_was_already_added_to_that_project</span>)
<span class="line-num">921</span>   <span class="ruby-keyword">end</span>
<span class="line-num">922</span> 
<span class="line-num">923</span>   <span class="ruby-ivar">@project_observation</span> = <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">create</span>(
<span class="line-num">924</span>     <span class="ruby-value">project:</span> <span class="ruby-ivar">@project</span>,
<span class="line-num">925</span>     <span class="ruby-value">observation:</span> <span class="ruby-ivar">@observation</span>,
<span class="line-num">926</span>     <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">927</span>   )
<span class="line-num">928</span>   
<span class="line-num">929</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">930</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:there_were_problems_adding_that_observation_to_this_project</span>) <span class="ruby-operator">+</span> 
<span class="line-num">931</span>       <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>
<span class="line-num">932</span>   <span class="ruby-keyword">end</span>
<span class="line-num">933</span> 
<span class="line-num">934</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">error_msg</span>
<span class="line-num">935</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">936</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">937</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">error_msg</span>
<span class="line-num">938</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">error_msg</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/must belong to a member/</span>
<span class="line-num">939</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">join_project_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">940</span>         <span class="ruby-keyword">else</span>
<span class="line-num">941</span>           <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">942</span>         <span class="ruby-keyword">end</span>
<span class="line-num">943</span>       <span class="ruby-keyword">end</span>
<span class="line-num">944</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">945</span>         <span class="ruby-identifier">json</span> = {
<span class="line-num">946</span>           <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">error_msg</span>,
<span class="line-num">947</span>           <span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>,
<span class="line-num">948</span>           <span class="ruby-value">:project_observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>
<span class="line-num">949</span>         }
<span class="line-num">950</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/observation field/</span>
<span class="line-num">951</span>           <span class="ruby-identifier">json</span>[<span class="ruby-value">:observation_fields</span>] = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observation_fields</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:observation_field</span>)
<span class="line-num">952</span>         <span class="ruby-keyword">end</span>
<span class="line-num">953</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">json</span>
<span class="line-num">954</span>       <span class="ruby-keyword">end</span>
<span class="line-num">955</span>     <span class="ruby-keyword">end</span>
<span class="line-num">956</span>     <span class="ruby-keyword">return</span>
<span class="line-num">957</span>   <span class="ruby-keyword">end</span>
<span class="line-num">958</span>   
<span class="line-num">959</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">960</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">961</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:observation_added_to_the_project</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>)
<span class="line-num">962</span>       <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">963</span>     <span class="ruby-keyword">end</span>
<span class="line-num">964</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">965</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">966</span>         <span class="ruby-value">:observation</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:observation_field_values</span>}, 
<span class="line-num">967</span>         <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:project_observation_fields</span>}
<span class="line-num">968</span>       })
<span class="line-num">969</span>     <span class="ruby-keyword">end</span>
<span class="line-num">970</span>   <span class="ruby-keyword">end</span>
<span class="line-num">971</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-add_batch">
            
              <b>add_batch</b>()
            
            <a href="../classes/ProjectsController.html#method-i-add_batch" name="method-i-add_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_batch_source')" id="l_method-i-add_batch_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_batch_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1005</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_batch</span>
<span class="line-num">1006</span>   <span class="ruby-identifier">observation_ids</span> = <span class="ruby-identifier">observation_ids_batch_from_params</span>
<span class="line-num">1007</span>   
<span class="line-num">1008</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">observation_ids</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">1009</span>   
<span class="line-num">1010</span>   <span class="ruby-ivar">@errors</span> = {}
<span class="line-num">1011</span>   <span class="ruby-ivar">@project_observations</span> = []
<span class="line-num">1012</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">1013</span>     <span class="ruby-identifier">project_observation</span> = <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">create</span>( <span class="ruby-value">project:</span> <span class="ruby-ivar">@project</span>, <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>,
<span class="line-num">1014</span>       <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-value">skip_touch_observation:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1015</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">project_observation</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">1016</span>       <span class="ruby-ivar">@project_observations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">project_observation</span>
<span class="line-num">1017</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1018</span>       <span class="ruby-ivar">@errors</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>] = <span class="ruby-identifier">project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>
<span class="line-num">1019</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1020</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1021</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) )
<span class="line-num">1022</span>   
<span class="line-num">1023</span>   <span class="ruby-ivar">@unique_errors</span> = <span class="ruby-ivar">@errors</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">to_sentence</span>
<span class="line-num">1024</span>   
<span class="line-num">1025</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">1026</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-node">&quot;You must specify at least one observation to add the project \&quot;#{@project.title}\&quot;&quot;</span>
<span class="line-num">1027</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@project_observations</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">1028</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-node">&quot;None of those observations could be added to the project \&quot;#{@project.title}\&quot;&quot;</span>
<span class="line-num">1029</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;: #{@unique_errors}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@unique_errors</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1030</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1031</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;#{@project_observations.size} of #{@observations.size} added to the project \&quot;#{@project.title}\&quot;&quot;</span>
<span class="line-num">1032</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span>
<span class="line-num">1033</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;. Some observations failed to add for the following reasons: #{@unique_errors}&quot;</span>
<span class="line-num">1034</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1035</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1036</span>   
<span class="line-num">1037</span>   <span class="ruby-comment"># Cache the errors in case the next action wants to show the details</span>
<span class="line-num">1038</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">write</span>(<span class="ruby-node">&quot;proj_obs_errors_#{current_user.id}&quot;</span>, {<span class="ruby-value">:project_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@errors</span>})
<span class="line-num">1039</span>   
<span class="line-num">1040</span>   <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">observations_by_login_path</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">1041</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-browse">
            
              <b>browse</b>()
            
            <a href="../classes/ProjectsController.html#method-i-browse" name="method-i-browse" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-browse_source')" id="l_method-i-browse_source">show</a>
                

                

                
              </p>
              <div id="method-i-browse_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">158</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">browse</span>
<span class="line-num">159</span>   <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">160</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@place</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@site_place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span>)
<span class="line-num">161</span>     <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:everywhere</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">162</span>   <span class="ruby-keyword">end</span>
<span class="line-num">163</span>   <span class="ruby-ivar">@order</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ORDERS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>])
<span class="line-num">164</span>   <span class="ruby-ivar">@order</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&#39;title&#39;</span>
<span class="line-num">165</span> 
<span class="line-num">166</span>   <span class="ruby-identifier">filters</span> = []
<span class="line-num">167</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">168</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">associated_place_ids:</span> [<span class="ruby-ivar">@place</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">169</span>   <span class="ruby-keyword">end</span>
<span class="line-num">170</span>   <span class="ruby-identifier">sort</span> = { <span class="ruby-value">title_exact:</span> <span class="ruby-value">:asc</span> }
<span class="line-num">171</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@order</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;created&quot;</span>
<span class="line-num">172</span>     <span class="ruby-identifier">sort</span> = { <span class="ruby-value">created_at:</span> <span class="ruby-value">:desc</span> }
<span class="line-num">173</span>   <span class="ruby-keyword">end</span>
<span class="line-num">174</span>   <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">elastic_paginate</span>(
<span class="line-num">175</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>,
<span class="line-num">176</span>     <span class="ruby-value">inverse_filters:</span> [
<span class="line-num">177</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">spam:</span> <span class="ruby-keyword">true</span> } }
<span class="line-num">178</span>     ],
<span class="line-num">179</span>     <span class="ruby-value">sort:</span> <span class="ruby-identifier">sort</span>,
<span class="line-num">180</span>     <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]
<span class="line-num">181</span>   )
<span class="line-num">182</span> 
<span class="line-num">183</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">184</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">185</span>   <span class="ruby-keyword">end</span>
<span class="line-num">186</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-bulk_template">
            
              <b>bulk_template</b>()
            
            <a href="../classes/ProjectsController.html#method-i-bulk_template" name="method-i-bulk_template" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-bulk_template_source')" id="l_method-i-bulk_template_source">show</a>
                

                

                
              </p>
              <div id="method-i-bulk_template_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">318</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bulk_template</span>
<span class="line-num">319</span>   <span class="ruby-identifier">csv</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">generate_bulk_upload_template</span>
<span class="line-num">320</span>   <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">csv</span>, { <span class="ruby-value">:filename</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@project.title.parameterize}.csv&quot;</span>, <span class="ruby-value">:type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:csv</span> })
<span class="line-num">321</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-by_login">
            
              <b>by_login</b>()
            
            <a href="../classes/ProjectsController.html#method-i-by_login" name="method-i-by_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-by_login_source')" id="l_method-i-by_login_source">show</a>
                

                

                
              </p>
              <div id="method-i-by_login_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">483</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">by_login</span>
<span class="line-num">484</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">485</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">486</span>       <span class="ruby-ivar">@started</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">projects</span>.
<span class="line-num">487</span>         <span class="ruby-identifier">paginate</span>( <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:started_page</span>], <span class="ruby-value">per_page:</span> <span class="ruby-value">7</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;lower( projects.title )&quot;</span> ) )
<span class="line-num">488</span>       <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:project</span>, <span class="ruby-value">:user</span> ).
<span class="line-num">489</span>         <span class="ruby-identifier">paginate</span>( <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:main_page</span>], <span class="ruby-value">per_page:</span> <span class="ruby-value">20</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;lower( projects.title )&quot;</span> ) )
<span class="line-num">490</span>       <span class="ruby-ivar">@projects</span> = <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">pu</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">project</span> }
<span class="line-num">491</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">492</span>     <span class="ruby-keyword">end</span>
<span class="line-num">493</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">494</span>       <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).
<span class="line-num">495</span>         <span class="ruby-identifier">includes</span>({
<span class="line-num">496</span>           <span class="ruby-value">project:</span> [
<span class="line-num">497</span>             <span class="ruby-value">:project_list</span>,
<span class="line-num">498</span>             { <span class="ruby-value">project_observation_rules:</span> <span class="ruby-value">:operand</span> },
<span class="line-num">499</span>             { <span class="ruby-value">project_observation_fields:</span> <span class="ruby-value">:observation_field</span> }
<span class="line-num">500</span>           ]
<span class="line-num">501</span>         }, <span class="ruby-value">:user</span>).
<span class="line-num">502</span>         <span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;lower(projects.title)&quot;</span> ) ).
<span class="line-num">503</span>         <span class="ruby-identifier">limit</span>(<span class="ruby-value">1000</span>)
<span class="line-num">504</span>       <span class="ruby-identifier">project_options</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">default_json_options</span>.<span class="ruby-identifier">update</span>(
<span class="line-num">505</span>         <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">506</span>           <span class="ruby-value">:project_list</span>, 
<span class="line-num">507</span>           {
<span class="line-num">508</span>             <span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ProjectObservationField</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">509</span>           }
<span class="line-num">510</span>         ]
<span class="line-num">511</span>       )
<span class="line-num">512</span>       <span class="ruby-identifier">project_options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:project_observation_rule_terms</span>
<span class="line-num">513</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">514</span>         <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:login</span>},
<span class="line-num">515</span>         <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">project_options</span>
<span class="line-num">516</span>       })
<span class="line-num">517</span>     <span class="ruby-keyword">end</span>
<span class="line-num">518</span>   <span class="ruby-keyword">end</span>
<span class="line-num">519</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-calendar">
            
              <b>calendar</b>()
            
            <a href="../classes/ProjectsController.html#method-i-calendar" name="method-i-calendar" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-calendar_source')" id="l_method-i-calendar_source">show</a>
                

                

                
              </p>
              <div id="method-i-calendar_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">793</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">calendar</span>
<span class="line-num">794</span>   <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_type:</span> <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">BIOBLITZ_TYPE</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;start_time ASC, end_time ASC&quot;</span>).
<span class="line-num">795</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;end_time &gt; ?&quot;</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:place</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;places.id IS NOT NULL&quot;</span>)
<span class="line-num">796</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">797</span>     <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">798</span>   <span class="ruby-keyword">end</span>
<span class="line-num">799</span>   <span class="ruby-ivar">@projects</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">in_place</span>(<span class="ruby-ivar">@place</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">800</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@eventsonly</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:eventsonly</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">801</span>     <span class="ruby-ivar">@projects</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;(end_time - start_time) &lt; &#39;2 weeks&#39;::interval&quot;</span>)
<span class="line-num">802</span>   <span class="ruby-keyword">end</span>
<span class="line-num">803</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">804</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">805</span>       <span class="ruby-ivar">@projects</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:place</span>)
<span class="line-num">806</span>       <span class="ruby-ivar">@finished</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_type:</span> <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">BIOBLITZ_TYPE</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;end_time DESC, start_time ASC&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;end_time &lt; ?&quot;</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>).<span class="ruby-identifier">page</span>(<span class="ruby-value">1</span>)
<span class="line-num">807</span>       <span class="ruby-ivar">@finished</span> = <span class="ruby-ivar">@finished</span>.<span class="ruby-identifier">in_place</span>(<span class="ruby-ivar">@place</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">808</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&#39;bootstrap&#39;</span>
<span class="line-num">809</span>     <span class="ruby-keyword">end</span>
<span class="line-num">810</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">ics</span> <span class="ruby-keyword">do</span>
<span class="line-num">811</span>       <span class="ruby-ivar">@projects</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">place:</span> <span class="ruby-value">:user</span>)
<span class="line-num">812</span>     <span class="ruby-keyword">end</span>
<span class="line-num">813</span>   <span class="ruby-keyword">end</span>
<span class="line-num">814</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-change_admin">
            
              <b>change_admin</b>()
            
            <a href="../classes/ProjectsController.html#method-i-change_admin" name="method-i-change_admin" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-change_admin_source')" id="l_method-i-change_admin_source">show</a>
                

                

                
              </p>
              <div id="method-i-change_admin_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1117</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">change_admin</span>
<span class="line-num">1118</span>   <span class="ruby-identifier">current_project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1119</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_project_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_project_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1120</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_the_project_admin_can_do_that</span>)
<span class="line-num">1121</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1122</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1123</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1124</span>   <span class="ruby-identifier">new_admin</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] )
<span class="line-num">1125</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">curated_by?</span>( <span class="ruby-identifier">new_admin</span> )
<span class="line-num">1126</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_curators_can_become_the_new_admin</span>)
<span class="line-num">1127</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1128</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1129</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1130</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">new_admin</span> )
<span class="line-num">1131</span>   <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1132</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-change_role">
            
              <b>change_role</b>()
            
            <a href="../classes/ProjectsController.html#method-i-change_role" name="method-i-change_role" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-change_role_source')" id="l_method-i-change_role_source">show</a>
                

                

                
              </p>
              <div id="method-i-change_role_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">631</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">change_role</span>
<span class="line-num">632</span>   <span class="ruby-ivar">@project_user</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_user_id</span>])
<span class="line-num">633</span>   <span class="ruby-identifier">current_project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">634</span>   <span class="ruby-identifier">role</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:role</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">ROLES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:role</span>])
<span class="line-num">635</span>   
<span class="line-num">636</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">637</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_user_cannot_be_found</span>)
<span class="line-num">638</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">639</span>     <span class="ruby-keyword">return</span>
<span class="line-num">640</span>   <span class="ruby-keyword">end</span>
<span class="line-num">641</span>   
<span class="line-num">642</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_project_user</span>.<span class="ruby-identifier">is_manager?</span>
<span class="line-num">643</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_a_project_manager_can_add</span>)
<span class="line-num">644</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">645</span>     <span class="ruby-keyword">return</span>
<span class="line-num">646</span>   <span class="ruby-keyword">end</span>
<span class="line-num">647</span>   
<span class="line-num">648</span>   <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">role</span> = <span class="ruby-identifier">role</span>
<span class="line-num">649</span>   
<span class="line-num">650</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">save</span>
<span class="line-num">651</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:grant_role</span>, <span class="ruby-value">:grant</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">role</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:removed</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:added</span>), <span class="ruby-value">:role</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">role</span>)
<span class="line-num">652</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">653</span>   <span class="ruby-keyword">else</span>
<span class="line-num">654</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_user_was_invalid</span>, <span class="ruby-value">:project_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>)
<span class="line-num">655</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">656</span>     <span class="ruby-keyword">return</span>
<span class="line-num">657</span>   <span class="ruby-keyword">end</span>
<span class="line-num">658</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-confirm_leave">
            
              <b>confirm_leave</b>()
            
            <a href="../classes/ProjectsController.html#method-i-confirm_leave" name="method-i-confirm_leave" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-confirm_leave_source')" id="l_method-i-confirm_leave_source">show</a>
                

                

                
              </p>
              <div id="method-i-confirm_leave_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">732</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">confirm_leave</span>
<span class="line-num">733</span>   <span class="ruby-ivar">@project_requires_curator_coordinate_access</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observation_rules</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">por</span><span class="ruby-operator">|</span>
<span class="line-num">734</span>     <span class="ruby-identifier">por</span>.<span class="ruby-identifier">operator</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;coordinates_shareable_by_project_curators?&#39;</span>
<span class="line-num">735</span>   <span class="ruby-keyword">end</span>
<span class="line-num">736</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">737</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">738</span>   <span class="ruby-keyword">end</span>
<span class="line-num">739</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-contributors">
            
              <b>contributors</b>()
            
            <a href="../classes/ProjectsController.html#method-i-contributors" name="method-i-contributors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-contributors_source')" id="l_method-i-contributors_source">show</a>
                

                

                
              </p>
              <div id="method-i-contributors_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">554</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">contributors</span>
<span class="line-num">555</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;observation+contest&quot;</span>
<span class="line-num">556</span>     <span class="ruby-ivar">@contributors</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations_count &gt; 0&quot;</span>).<span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;observations_count DESC, taxa_count DESC&quot;</span>)
<span class="line-num">557</span>     <span class="ruby-ivar">@top_contributors</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa_count &gt; 0&quot;</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;observations_count DESC, taxa_count DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">558</span>   <span class="ruby-keyword">else</span>
<span class="line-num">559</span>     <span class="ruby-ivar">@contributors</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa_count &gt; 0&quot;</span>).<span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;taxa_count DESC, observations_count DESC&quot;</span>)
<span class="line-num">560</span>     <span class="ruby-ivar">@top_contributors</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa_count &gt; 0&quot;</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;taxa_count DESC, observations_count DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">561</span>   <span class="ruby-keyword">end</span>
<span class="line-num">562</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">563</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">564</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">widget</span> <span class="ruby-keyword">do</span>
<span class="line-num">565</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget.js.erb&quot;</span>)
<span class="line-num">566</span>     <span class="ruby-keyword">end</span>
<span class="line-num">567</span>   <span class="ruby-keyword">end</span>
<span class="line-num">568</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-convert_to_collection">
            
              <b>convert_to_collection</b>()
            
            <a href="../classes/ProjectsController.html#method-i-convert_to_collection" name="method-i-convert_to_collection" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-convert_to_collection_source')" id="l_method-i-convert_to_collection_source">show</a>
                

                

                
              </p>
              <div id="method-i-convert_to_collection_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">188</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">convert_to_collection</span>
<span class="line-num">189</span>   <span class="ruby-identifier">project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">190</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:admin</span>) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">is_admin?</span> )
<span class="line-num">191</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_the_project_admin_can_do_that</span>)
<span class="line-num">192</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">193</span>     <span class="ruby-keyword">return</span>
<span class="line-num">194</span>   <span class="ruby-keyword">end</span>
<span class="line-num">195</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">convert_to_collection_project</span>
<span class="line-num">196</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">refresh_es_index</span>
<span class="line-num">197</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">198</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-convert_to_traditional">
            
              <b>convert_to_traditional</b>()
            
            <a href="../classes/ProjectsController.html#method-i-convert_to_traditional" name="method-i-convert_to_traditional" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-convert_to_traditional_source')" id="l_method-i-convert_to_traditional_source">show</a>
                

                

                
              </p>
              <div id="method-i-convert_to_traditional_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">200</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">convert_to_traditional</span>
<span class="line-num">201</span>   <span class="ruby-identifier">project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">202</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:admin</span>) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">is_admin?</span> )
<span class="line-num">203</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_the_project_admin_can_do_that</span>)
<span class="line-num">204</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">205</span>     <span class="ruby-keyword">return</span>
<span class="line-num">206</span>   <span class="ruby-keyword">end</span>
<span class="line-num">207</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">convert_collection_project_to_traditional_project</span>
<span class="line-num">208</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">refresh_es_index</span>
<span class="line-num">209</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">210</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create">
            
              <b>create</b>()
            
            <a href="../classes/ProjectsController.html#method-i-create" name="method-i-create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_source')" id="l_method-i-create_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">374</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create</span>
<span class="line-num">375</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>].<span class="ruby-identifier">merge</span>(<span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>))
<span class="line-num">376</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">377</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">378</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">save</span>
<span class="line-num">379</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span>(<span class="ruby-ivar">@project</span>, <span class="ruby-value">:notice</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_was_successfully_created</span>)) }
<span class="line-num">380</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
<span class="line-num">381</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">to_json</span>
<span class="line-num">382</span>       }
<span class="line-num">383</span>     <span class="ruby-keyword">else</span>
<span class="line-num">384</span>       <span class="ruby-ivar">@project_types</span> = [<span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">ASSESSMENT_TYPE</span>]
<span class="line-num">385</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;new_traditional&quot;</span> }
<span class="line-num">386</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>,
<span class="line-num">387</span>         <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span> } }
<span class="line-num">388</span>     <span class="ruby-keyword">end</span>
<span class="line-num">389</span>   <span class="ruby-keyword">end</span>
<span class="line-num">390</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy">
            
              <b>destroy</b>()
            
            <a href="../classes/ProjectsController.html#method-i-destroy" name="method-i-destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>DELETE /projects/1 DELETE /projects/1.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_source')" id="l_method-i-destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">447</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
<span class="line-num">448</span>   <span class="ruby-identifier">project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">449</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">450</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_the_project_admin_can_delete_this_project</span>)
<span class="line-num">451</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">452</span>     <span class="ruby-keyword">return</span>
<span class="line-num">453</span>   <span class="ruby-keyword">end</span>
<span class="line-num">454</span>   
<span class="line-num">455</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">is_new_project?</span>
<span class="line-num">456</span>     <span class="ruby-comment"># new projects can be destroyed immediately as they will have no</span>
<span class="line-num">457</span>     <span class="ruby-comment"># project observations</span>
<span class="line-num">458</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">sane_destroy</span>
<span class="line-num">459</span>   <span class="ruby-keyword">else</span>
<span class="line-num">460</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>,
<span class="line-num">461</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Project::sane_destroy&quot;:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span> } ).<span class="ruby-identifier">sane_destroy</span>
<span class="line-num">462</span>   <span class="ruby-keyword">end</span>
<span class="line-num">463</span> 
<span class="line-num">464</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">465</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">466</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_x_was_delete</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>)
<span class="line-num">467</span>       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">projects_url</span>)
<span class="line-num">468</span>     <span class="ruby-keyword">end</span>
<span class="line-num">469</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">470</span>       <span class="ruby-identifier">head</span> <span class="ruby-value">:ok</span>
<span class="line-num">471</span>     <span class="ruby-keyword">end</span>
<span class="line-num">472</span>   <span class="ruby-keyword">end</span>
<span class="line-num">473</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit">
            
              <b>edit</b>()
            
            <a href="../classes/ProjectsController.html#method-i-edit" name="method-i-edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_source')" id="l_method-i-edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">345</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit</span>
<span class="line-num">346</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">is_new_project?</span>
<span class="line-num">347</span>     <span class="ruby-identifier">projects_response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">project</span>( <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, {
<span class="line-num">348</span>       <span class="ruby-value">rule_details:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">349</span>       <span class="ruby-value">ttl:</span> <span class="ruby-value">-1</span>,
<span class="line-num">350</span>       <span class="ruby-value">authenticate:</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">351</span>     } )
<span class="line-num">352</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">353</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:doh_something_went_wrong</span> )
<span class="line-num">354</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">projects_path</span>
<span class="line-num">355</span>     <span class="ruby-keyword">end</span>
<span class="line-num">356</span>     <span class="ruby-ivar">@project_json</span> = <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">results</span>[<span class="ruby-value">0</span>]
<span class="line-num">357</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;new&quot;</span>
<span class="line-num">358</span>   <span class="ruby-keyword">end</span>
<span class="line-num">359</span>   <span class="ruby-ivar">@project_assets</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_assets</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">360</span>   <span class="ruby-ivar">@kml_assets</span> = <span class="ruby-ivar">@project_assets</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">asset_file_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\.km[lz]$/</span>}
<span class="line-num">361</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">place</span>
<span class="line-num">362</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">prefers_place_boundary_visible</span>
<span class="line-num">363</span>       <span class="ruby-ivar">@place_geometry</span> = <span class="ruby-constant">PlaceGeometry</span>.<span class="ruby-identifier">without_geom</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">place_id:</span> <span class="ruby-ivar">@place</span>).<span class="ruby-identifier">first</span>
<span class="line-num">364</span>     <span class="ruby-keyword">end</span>
<span class="line-num">365</span>   <span class="ruby-keyword">end</span>
<span class="line-num">366</span>   <span class="ruby-ivar">@project_curators</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.
<span class="line-num">367</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;role IN (?)&quot;</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">ROLES</span> ).
<span class="line-num">368</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;user_id != ?&quot;</span>, <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span> ).
<span class="line-num">369</span>     <span class="ruby-identifier">limit</span>( <span class="ruby-value">100</span> ).
<span class="line-num">370</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;users.login&quot;</span> )
<span class="line-num">371</span>   <span class="ruby-ivar">@project_types</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">bioblitz?</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">PROJECT_TYPES</span> <span class="ruby-operator">:</span> [<span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">ASSESSMENT_TYPE</span>]
<span class="line-num">372</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-feature">
            
              <b>feature</b>()
            
            <a href="../classes/ProjectsController.html#method-i-feature" name="method-i-feature" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-feature_source')" id="l_method-i-feature_source">show</a>
                

                

                
              </p>
              <div id="method-i-feature_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1134</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">feature</span>
<span class="line-num">1135</span>   <span class="ruby-identifier">feature</span> = <span class="ruby-constant">SiteFeaturedProject</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">site:</span> <span class="ruby-ivar">@site</span>, <span class="ruby-value">project:</span> <span class="ruby-ivar">@project</span>).
<span class="line-num">1136</span>     <span class="ruby-identifier">first_or_create</span>(<span class="ruby-value">user:</span> <span class="ruby-ivar">@current_user</span>)
<span class="line-num">1137</span>   <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">user:</span> <span class="ruby-ivar">@current_user</span> )
<span class="line-num">1138</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">noteworthy</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:noteworthy</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:noteworthy</span>].<span class="ruby-identifier">noish?</span> )
<span class="line-num">1139</span>     <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">noteworthy:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">1140</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">feature</span>.<span class="ruby-identifier">noteworthy</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:noteworthy</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">1141</span>     <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">noteworthy:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1142</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1143</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">json:</span> { }
<span class="line-num">1144</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index">
            
              <b>index</b>()
            
            <a href="../classes/ProjectsController.html#method-i-index" name="method-i-index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_source')" id="l_method-i-index_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num"> 49</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
<span class="line-num"> 50</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 51</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 52</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@site_place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span>)
<span class="line-num"> 53</span>         <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:everywhere</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 54</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 55</span> 
<span class="line-num"> 56</span>       <span class="ruby-identifier">base_params</span> = { <span class="ruby-value">site_id:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">ttl:</span> <span class="ruby-value">600</span> }
<span class="line-num"> 57</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">site_admins</span>.<span class="ruby-identifier">any?</span> )
<span class="line-num"> 58</span>         <span class="ruby-identifier">base_params</span>[<span class="ruby-value">:ttl</span>] = <span class="ruby-value">-1</span>
<span class="line-num"> 59</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 60</span>       <span class="ruby-identifier">carousel_r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">projects</span>( <span class="ruby-identifier">base_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num"> 61</span>         <span class="ruby-value">noteworthy:</span> <span class="ruby-keyword">true</span>,
<span class="line-num"> 62</span>         <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;featured&quot;</span>,
<span class="line-num"> 63</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">3</span>
<span class="line-num"> 64</span>       ) )
<span class="line-num"> 65</span> 
<span class="line-num"> 66</span>       <span class="ruby-identifier">carousel_ids</span> = ( <span class="ruby-identifier">carousel_r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">carousel_r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">:</span> [] ).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num"> 67</span>       <span class="ruby-ivar">@carousel</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">carousel_ids</span>).<span class="ruby-identifier">to_a</span>
<span class="line-num"> 68</span> 
<span class="line-num"> 69</span>       <span class="ruby-identifier">featured_r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">projects</span>( <span class="ruby-identifier">base_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num"> 70</span>         <span class="ruby-value">featured:</span> <span class="ruby-keyword">true</span>,
<span class="line-num"> 71</span>         <span class="ruby-value">not_id:</span> <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>),
<span class="line-num"> 72</span>         <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;featured&quot;</span>,
<span class="line-num"> 73</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">11</span>
<span class="line-num"> 74</span>       ) )
<span class="line-num"> 75</span>       <span class="ruby-identifier">featured_ids</span> = ( <span class="ruby-identifier">featured_r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">featured_r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">:</span> [] ).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num"> 76</span>       <span class="ruby-ivar">@featured</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">featured_ids</span>).<span class="ruby-identifier">to_a</span>
<span class="line-num"> 77</span>       <span class="ruby-keyword">while</span> <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@featured</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 78</span>         <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">push</span>( <span class="ruby-ivar">@featured</span>.<span class="ruby-identifier">shift</span> )
<span class="line-num"> 79</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 80</span>       <span class="ruby-ivar">@featured</span> = <span class="ruby-ivar">@featured</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">8</span>]
<span class="line-num"> 81</span> 
<span class="line-num"> 82</span>       <span class="ruby-identifier">recent_r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">projects</span>( <span class="ruby-identifier">base_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num"> 83</span>         <span class="ruby-value">not_id:</span> <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@featured</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>),
<span class="line-num"> 84</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">11</span>,
<span class="line-num"> 85</span>         <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;recent_posts&quot;</span>,
<span class="line-num"> 86</span>         <span class="ruby-value">place_id:</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num"> 87</span>       ) )
<span class="line-num"> 88</span>       <span class="ruby-identifier">recent_ids</span> = ( <span class="ruby-identifier">recent_r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">recent_r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">:</span> [] ).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num"> 89</span>       <span class="ruby-ivar">@recent</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">recent_ids</span>).<span class="ruby-identifier">to_a</span>
<span class="line-num"> 90</span>       <span class="ruby-keyword">while</span> <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@recent</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 91</span>         <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">push</span>( <span class="ruby-ivar">@recent</span>.<span class="ruby-identifier">shift</span> )
<span class="line-num"> 92</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 93</span>       <span class="ruby-ivar">@recent</span> = <span class="ruby-ivar">@recent</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">8</span>]
<span class="line-num"> 94</span> 
<span class="line-num"> 95</span>       <span class="ruby-identifier">created_r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">projects</span>( <span class="ruby-identifier">base_params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num"> 96</span>         <span class="ruby-value">not_id:</span> <span class="ruby-ivar">@carousel</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@featured</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@recent</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>),
<span class="line-num"> 97</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">8</span>,
<span class="line-num"> 98</span>         <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;created&quot;</span>,
<span class="line-num"> 99</span>         <span class="ruby-value">place_id:</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>),
<span class="line-num">100</span>         <span class="ruby-value">has_posts:</span> <span class="ruby-keyword">true</span>
<span class="line-num">101</span>       ) )
<span class="line-num">102</span>       <span class="ruby-identifier">created_ids</span> = ( <span class="ruby-identifier">created_r</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">created_r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">:</span> [] ).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num">103</span>       <span class="ruby-ivar">@created</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">created_ids</span>).<span class="ruby-identifier">to_a</span>
<span class="line-num">104</span> 
<span class="line-num">105</span>       <span class="ruby-constant">Project</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-ivar">@carousel</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@featured</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@recent</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@created</span>, <span class="ruby-value">:stored_preferences</span> )
<span class="line-num">106</span> 
<span class="line-num">107</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">108</span>         <span class="ruby-ivar">@started</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">not_flagged_as_spam</span>.
<span class="line-num">109</span>           <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;projects.id desc&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:stored_preferences</span>)
<span class="line-num">110</span>         <span class="ruby-ivar">@joined</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).
<span class="line-num">111</span>           <span class="ruby-identifier">merge</span>(<span class="ruby-constant">Project</span>.<span class="ruby-identifier">not_flagged_as_spam</span>).<span class="ruby-identifier">includes</span>( <span class="ruby-value">project:</span> <span class="ruby-value">:stored_preferences</span> ).
<span class="line-num">112</span>           <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;projects.user_id != ?&quot;</span>, <span class="ruby-identifier">current_user</span> ).
<span class="line-num">113</span>           <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;projects.id desc&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:project</span>)
<span class="line-num">114</span>       <span class="ruby-keyword">end</span>
<span class="line-num">115</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">116</span>     <span class="ruby-keyword">end</span>
<span class="line-num">117</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">118</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">all</span>
<span class="line-num">119</span>       <span class="ruby-comment"># ensuring lat/lng are floats to prevent SQL injection in an order clause below</span>
<span class="line-num">120</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>]
<span class="line-num">121</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>] = <span class="ruby-constant">Float</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">122</span>       <span class="ruby-keyword">end</span>
<span class="line-num">123</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]
<span class="line-num">124</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>] = <span class="ruby-constant">Float</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">125</span>       <span class="ruby-keyword">end</span>
<span class="line-num">126</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:featured</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]
<span class="line-num">127</span>         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:site_featured_projects</span>)
<span class="line-num">128</span>         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.
<span class="line-num">129</span>           <span class="ruby-identifier">where</span>([<span class="ruby-string">&quot;projects.latitude IS NULL OR ST_Distance(ST_Point(projects.longitude, projects.latitude), ST_Point(?, ?)) &lt; 5&quot;</span>,
<span class="line-num">130</span>             <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]]).
<span class="line-num">131</span>           <span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>(
<span class="line-num">132</span>             <span class="ruby-node">&quot;CASE WHEN projects.latitude IS NULL THEN 6 ELSE ST_Distance(ST_Point(projects.longitude, projects.latitude), ST_Point(#{params[:latitude]}, #{params[:latitude]})) END&quot;</span>
<span class="line-num">133</span>           ) )
<span class="line-num">134</span>       <span class="ruby-keyword">else</span>
<span class="line-num">135</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:featured</span>]
<span class="line-num">136</span>           <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:site_featured_projects</span>)
<span class="line-num">137</span>         <span class="ruby-keyword">end</span>
<span class="line-num">138</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>]
<span class="line-num">139</span>           <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">near_point</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:latitude</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:longitude</span>])
<span class="line-num">140</span>         <span class="ruby-keyword">end</span>
<span class="line-num">141</span>       <span class="ruby-keyword">end</span>
<span class="line-num">142</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">in_group</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:group</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:group</span>]
<span class="line-num">143</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">from_source_url</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:source</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:source</span>]
<span class="line-num">144</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>( { <span class="ruby-value">project_observation_rules:</span> <span class="ruby-value">:operand</span> }, <span class="ruby-value">:project_list</span>, <span class="ruby-value">:place</span>,
<span class="line-num">145</span>         { <span class="ruby-value">project_observation_fields:</span> <span class="ruby-value">:observation_field</span> }, <span class="ruby-value">:stored_preferences</span>
<span class="line-num">146</span>       )
<span class="line-num">147</span>       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], <span class="ruby-value">:per_page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">100</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">148</span>       <span class="ruby-identifier">opts</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">default_json_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">149</span>         <span class="ruby-value">:project_list</span>, 
<span class="line-num">150</span>         {<span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ProjectObservationField</span>.<span class="ruby-identifier">default_json_options</span>}
<span class="line-num">151</span>       ])
<span class="line-num">152</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:project_observations_count</span>
<span class="line-num">153</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">opts</span>)
<span class="line-num">154</span>     <span class="ruby-keyword">end</span>
<span class="line-num">155</span>   <span class="ruby-keyword">end</span>
<span class="line-num">156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-invite">
            
              <b>invite</b>()
            
            <a href="../classes/ProjectsController.html#method-i-invite" name="method-i-invite" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-invite_source')" id="l_method-i-invite_source">show</a>
                

                

                
              </p>
              <div id="method-i-invite_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1084</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">invite</span>
<span class="line-num">1085</span>   <span class="ruby-ivar">@project_user_invitations</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_user_invitations</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>, <span class="ruby-value">:invited_user</span>).<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).
<span class="line-num">1086</span>     <span class="ruby-identifier">joins</span>(<span class="ruby-node">&quot;LEFT OUTER JOIN project_users ON project_users.user_id = project_user_invitations.invited_user_id AND project_users.project_id = #{@project.id}&quot;</span>).
<span class="line-num">1087</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;project_users.id IS NULL&quot;</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;project_user_invitations.id DESC&quot;</span>)
<span class="line-num">1088</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1089</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1090</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1091</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-join">
            
              <b>join</b>()
            
            <a href="../classes/ProjectsController.html#method-i-join" name="method-i-join" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-join_source')" id="l_method-i-join_source">show</a>
                

                

                
              </p>
              <div id="method-i-join_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">683</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">join</span>
<span class="line-num">684</span>   <span class="ruby-ivar">@observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>])
<span class="line-num">685</span>   <span class="ruby-ivar">@project_curators</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">role:</span> [<span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>])
<span class="line-num">686</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>
<span class="line-num">687</span>     <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:notice</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_are_already_a_member_of_this_project</span>))
<span class="line-num">688</span>     <span class="ruby-keyword">return</span>
<span class="line-num">689</span>   <span class="ruby-keyword">end</span>
<span class="line-num">690</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span>
<span class="line-num">691</span>     <span class="ruby-ivar">@project_user_invitation</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_user_invitations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:invited_user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>).<span class="ruby-identifier">first</span>
<span class="line-num">692</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">693</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">694</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">partial</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]
<span class="line-num">695</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;projects/#{partial}&quot;</span>
<span class="line-num">696</span>         <span class="ruby-keyword">else</span>
<span class="line-num">697</span>           <span class="ruby-comment"># just render the default</span>
<span class="line-num">698</span>         <span class="ruby-keyword">end</span>
<span class="line-num">699</span>       <span class="ruby-keyword">end</span>
<span class="line-num">700</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span> }
<span class="line-num">701</span>     <span class="ruby-keyword">end</span>
<span class="line-num">702</span>     <span class="ruby-keyword">return</span>
<span class="line-num">703</span>   <span class="ruby-keyword">end</span>
<span class="line-num">704</span> 
<span class="line-num">705</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">706</span>   <span class="ruby-ivar">@project_user</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">create</span>((<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_user</span>] <span class="ruby-operator">||</span> {}).<span class="ruby-identifier">merge</span>(<span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>))
<span class="line-num">707</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">708</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">709</span>       <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:notice</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:welcome_to_x_project</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>))
<span class="line-num">710</span>     <span class="ruby-keyword">else</span>
<span class="line-num">711</span>       <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_there_were_problems_with_your_request</span>, <span class="ruby-value">:project_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>))
<span class="line-num">712</span>     <span class="ruby-keyword">end</span>
<span class="line-num">713</span>     <span class="ruby-keyword">return</span>
<span class="line-num">714</span>   <span class="ruby-keyword">end</span>
<span class="line-num">715</span>   
<span class="line-num">716</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">717</span>     <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:dest</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>,
<span class="line-num">718</span>       <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_there_were_problems_with_your_request</span>, <span class="ruby-value">:project_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>))
<span class="line-num">719</span>     <span class="ruby-keyword">return</span>
<span class="line-num">720</span>   <span class="ruby-keyword">end</span>
<span class="line-num">721</span>   
<span class="line-num">722</span>   <span class="ruby-ivar">@project_observation</span> = <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>, <span class="ruby-value">:observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>)
<span class="line-num">723</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">724</span>     <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:dest</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>,
<span class="line-num">725</span>       <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:there_were_problems_adding_that_observation_to_this_project</span>, <span class="ruby-value">:project_observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>))
<span class="line-num">726</span>     <span class="ruby-keyword">return</span>
<span class="line-num">727</span>   <span class="ruby-keyword">end</span>
<span class="line-num">728</span>   
<span class="line-num">729</span>   <span class="ruby-identifier">respond_to_join</span>(<span class="ruby-value">:dest</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>, <span class="ruby-value">:notice</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:youve_joined_the_x_project</span>, <span class="ruby-value">:project_invitation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>))
<span class="line-num">730</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-leave">
            
              <b>leave</b>()
            
            <a href="../classes/ProjectsController.html#method-i-leave" name="method-i-leave" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-leave_source')" id="l_method-i-leave_source">show</a>
                

                

                
              </p>
              <div id="method-i-leave_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">741</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">leave</span>
<span class="line-num">742</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project_user</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">delete?</span>)
<span class="line-num">743</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">744</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">745</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_arent_a_member_of_that_project</span>)
<span class="line-num">746</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">747</span>       <span class="ruby-keyword">end</span>
<span class="line-num">748</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">749</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {}
<span class="line-num">750</span>       <span class="ruby-keyword">end</span>
<span class="line-num">751</span>     <span class="ruby-keyword">end</span>
<span class="line-num">752</span>     <span class="ruby-keyword">return</span>
<span class="line-num">753</span>   <span class="ruby-keyword">end</span>
<span class="line-num">754</span>   
<span class="line-num">755</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span>
<span class="line-num">756</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_cant_leave_a_project_you_created</span>)
<span class="line-num">757</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">758</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">759</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">760</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">761</span>       <span class="ruby-keyword">end</span>
<span class="line-num">762</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">763</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">764</span>       <span class="ruby-keyword">end</span>
<span class="line-num">765</span>     <span class="ruby-keyword">end</span>
<span class="line-num">766</span>     <span class="ruby-keyword">return</span>
<span class="line-num">767</span>   <span class="ruby-keyword">end</span>
<span class="line-num">768</span>   
<span class="line-num">769</span>   
<span class="line-num">770</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">role</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
<span class="line-num">771</span>     <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>).<span class="ruby-identifier">update_curator_idents_on_remove_curator</span>(<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">772</span>   <span class="ruby-keyword">end</span>
<span class="line-num">773</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:keep</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;revoke&#39;</span>
<span class="line-num">774</span>     <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>).<span class="ruby-identifier">revoke_project_observations_on_leave_project</span>(<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">775</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:keep</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">776</span>     <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>).<span class="ruby-identifier">delete_project_observations_on_leave_project</span>(<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">777</span>   <span class="ruby-keyword">end</span>
<span class="line-num">778</span>   <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">779</span>   <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">780</span>   
<span class="line-num">781</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">782</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">783</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_have_left_x_project</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>)
<span class="line-num">784</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@project</span>
<span class="line-num">785</span>     <span class="ruby-keyword">end</span>
<span class="line-num">786</span>     
<span class="line-num">787</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">788</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {}
<span class="line-num">789</span>     <span class="ruby-keyword">end</span>
<span class="line-num">790</span>   <span class="ruby-keyword">end</span>
<span class="line-num">791</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-list">
            
              <b>list</b>()
            
            <a href="../classes/ProjectsController.html#method-i-list" name="method-i-list" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-list_source')" id="l_method-i-list_source">show</a>
                

                

                
              </p>
              <div id="method-i-list_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">604</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">list</span>
<span class="line-num">605</span>   <span class="ruby-comment"># TODO this causes a temporary table sort, which == badness</span>
<span class="line-num">606</span>   <span class="ruby-ivar">@listed_taxa</span> =  <span class="ruby-constant">ProjectList</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">listed_taxa</span>.
<span class="line-num">607</span>     <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;LEFT OUTER JOIN taxon_photos ON taxon_photos.taxon_id = listed_taxa.taxon_id &quot;</span> <span class="ruby-operator">+</span>
<span class="line-num">608</span>       <span class="ruby-string">&quot;LEFT OUTER JOIN photos ON photos.id = taxon_photos.photo_id&quot;</span>).
<span class="line-num">609</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;photos.id IS NOT NULL&quot;</span>).
<span class="line-num">610</span>     <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;MAX(listed_taxa.id) AS id, listed_taxa.taxon_id&quot;</span>).
<span class="line-num">611</span>     <span class="ruby-identifier">group</span>(<span class="ruby-string">&quot;listed_taxa.taxon_id&quot;</span>).
<span class="line-num">612</span>     <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">11</span>).
<span class="line-num">613</span>     <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id DESC&quot;</span>)
<span class="line-num">614</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@listed_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>)).
<span class="line-num">615</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:photos</span>, <span class="ruby-value">:taxon_names</span>)
<span class="line-num">616</span>   
<span class="line-num">617</span> 
<span class="line-num">618</span>   <span class="ruby-comment"># Load tips HTML</span>
<span class="line-num">619</span>   <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">map!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">620</span>     <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">html</span> = <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;taxa/taxon.html.erb&#39;</span>, 
<span class="line-num">621</span>       <span class="ruby-value">:object</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">622</span>         <span class="ruby-value">:image_options</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:size</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;small&#39;</span>},
<span class="line-num">623</span>         <span class="ruby-value">:link_image</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,
<span class="line-num">624</span>         <span class="ruby-value">:link_name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,
<span class="line-num">625</span>         <span class="ruby-value">:include_image_attribution</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>
<span class="line-num">626</span>     })
<span class="line-num">627</span>     <span class="ruby-identifier">taxon</span>
<span class="line-num">628</span>   <span class="ruby-keyword">end</span>
<span class="line-num">629</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-members">
            
              <b>members</b>()
            
            <a href="../classes/ProjectsController.html#method-i-members" name="method-i-members" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-members_source')" id="l_method-i-members_source">show</a>
                

                

                
              </p>
              <div id="method-i-members_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">521</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">members</span>
<span class="line-num">522</span>   <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:user</span>).
<span class="line-num">523</span>     <span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>])
<span class="line-num">524</span>   <span class="ruby-ivar">@order_by</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:order_by</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;login&quot;</span>
<span class="line-num">525</span>   <span class="ruby-ivar">@order</span> = <span class="ruby-node">%w(asc desc)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] ) <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">:</span> <span class="ruby-string">&quot;asc&quot;</span>
<span class="line-num">526</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:order_by</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;created_at&quot;</span>
<span class="line-num">527</span>     <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">order</span>( <span class="ruby-node">&quot;project_users.id #{@order}&quot;</span> )
<span class="line-num">528</span>   <span class="ruby-keyword">else</span>
<span class="line-num">529</span>     <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">order</span>( <span class="ruby-node">&quot;users.login #{@order}&quot;</span> )
<span class="line-num">530</span>   <span class="ruby-keyword">end</span>
<span class="line-num">531</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">532</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">533</span>       <span class="ruby-ivar">@admin</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user</span>
<span class="line-num">534</span>       <span class="ruby-ivar">@curators</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">curators</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pu</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">user</span>}
<span class="line-num">535</span>       <span class="ruby-ivar">@managers</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">managers</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pu</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">user</span>}
<span class="line-num">536</span>     <span class="ruby-keyword">end</span>
<span class="line-num">537</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">user:</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">default_json_options</span>}) }
<span class="line-num">538</span>   <span class="ruby-keyword">end</span>
<span class="line-num">539</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new">
            
              <b>new</b>()
            
            <a href="../classes/ProjectsController.html#method-i-new" name="method-i-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_source')" id="l_method-i-new_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">328</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new</span>
<span class="line-num">329</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:copy_project_id</span>]
<span class="line-num">330</span>     <span class="ruby-ivar">@copy_project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:copy_project_id</span>] ) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">331</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@copy_project</span>
<span class="line-num">332</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@copy_project</span>.<span class="ruby-identifier">is_new_project?</span>
<span class="line-num">333</span>         <span class="ruby-identifier">projects_response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">project</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:copy_project_id</span>], { <span class="ruby-value">rule_details:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">ttl:</span> <span class="ruby-value">-1</span> } )
<span class="line-num">334</span>         <span class="ruby-keyword">unless</span> <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">335</span>           <span class="ruby-ivar">@copy_project_json</span> = <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">results</span>[<span class="ruby-value">0</span>]
<span class="line-num">336</span>         <span class="ruby-keyword">end</span>
<span class="line-num">337</span>       <span class="ruby-keyword">else</span>
<span class="line-num">338</span>         <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;views.projects.new.traditional_projects_cannot_be_copied&quot;</span> )
<span class="line-num">339</span>       <span class="ruby-keyword">end</span>
<span class="line-num">340</span>     <span class="ruby-keyword">end</span>
<span class="line-num">341</span>   <span class="ruby-keyword">end</span>
<span class="line-num">342</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">343</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new_traditional">
            
              <b>new_traditional</b>()
            
            <a href="../classes/ProjectsController.html#method-i-new_traditional" name="method-i-new_traditional" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_traditional_source')" id="l_method-i-new_traditional_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_traditional_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">323</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_traditional</span>
<span class="line-num">324</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">new</span>
<span class="line-num">325</span>   <span class="ruby-ivar">@project_types</span> = [<span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">ASSESSMENT_TYPE</span>]
<span class="line-num">326</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observed_taxa_count">
            
              <b>observed_taxa_count</b>()
            
            <a href="../classes/ProjectsController.html#method-i-observed_taxa_count" name="method-i-observed_taxa_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observed_taxa_count_source')" id="l_method-i-observed_taxa_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-observed_taxa_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">541</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observed_taxa_count</span>
<span class="line-num">542</span>   <span class="ruby-ivar">@observed_taxa_count</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">observed_taxa_count</span>
<span class="line-num">543</span>   <span class="ruby-ivar">@list_count</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_list</span>.<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">count</span>
<span class="line-num">544</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">545</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">546</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;projects/observed_taxa_count_widget&quot;</span>
<span class="line-num">547</span>     <span class="ruby-keyword">end</span>
<span class="line-num">548</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">widget</span> <span class="ruby-keyword">do</span>
<span class="line-num">549</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;projects/observed_taxa_count_widget.js.erb&quot;</span>)
<span class="line-num">550</span>     <span class="ruby-keyword">end</span>
<span class="line-num">551</span>   <span class="ruby-keyword">end</span>
<span class="line-num">552</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove">
            
              <b>remove</b>()
            
            <a href="../classes/ProjectsController.html#method-i-remove" name="method-i-remove" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_source')" id="l_method-i-remove_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num"> 973</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove</span>
<span class="line-num"> 974</span>   <span class="ruby-ivar">@project_observation</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">find_by_observation_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>])
<span class="line-num"> 975</span>   <span class="ruby-identifier">error_msg</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 976</span>     <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_observation_hasnt_been_added_this_project</span>)
<span class="line-num"> 977</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">removable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num"> 978</span>     <span class="ruby-string">&quot;you don&#39;t have permission to remove that observation&quot;</span>
<span class="line-num"> 979</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 980</span> 
<span class="line-num"> 981</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">error_msg</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 982</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 983</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 984</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">error_msg</span>
<span class="line-num"> 985</span>         <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num"> 986</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 987</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num"> 988</span>         <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">error_msg</span>
<span class="line-num"> 989</span>       }}
<span class="line-num"> 990</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 991</span>     <span class="ruby-keyword">return</span>
<span class="line-num"> 992</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 993</span>   <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num"> 994</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 995</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 996</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:observation_removed_from_the_project</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>)
<span class="line-num"> 997</span>       <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num"> 998</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 999</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1000</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>
<span class="line-num">1001</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1002</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1003</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_batch">
            
              <b>remove_batch</b>()
            
            <a href="../classes/ProjectsController.html#method-i-remove_batch" name="method-i-remove_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_batch_source')" id="l_method-i-remove_batch_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_batch_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1043</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_batch</span>
<span class="line-num">1044</span>   <span class="ruby-identifier">observation_ids</span> = <span class="ruby-identifier">observation_ids_batch_from_params</span>
<span class="line-num">1045</span>   <span class="ruby-ivar">@project_observations</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-identifier">observation_ids</span>).
<span class="line-num">1046</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:observation</span>)
<span class="line-num">1047</span>   
<span class="line-num">1048</span>   <span class="ruby-ivar">@project_observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">project_observation</span><span class="ruby-operator">|</span>
<span class="line-num">1049</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">project_observation</span>.<span class="ruby-identifier">removable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">1050</span>     <span class="ruby-identifier">project_observation</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1051</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1052</span>   
<span class="line-num">1053</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:observations_removed_from_the_project</span>, <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>)
<span class="line-num">1054</span>   <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">1055</span>   <span class="ruby-keyword">return</span>
<span class="line-num">1056</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_project_user">
            
              <b>remove_project_user</b>()
            
            <a href="../classes/ProjectsController.html#method-i-remove_project_user" name="method-i-remove_project_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_project_user_source')" id="l_method-i-remove_project_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_project_user_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">660</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_project_user</span>
<span class="line-num">661</span>   <span class="ruby-ivar">@project_user</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_user_id</span>])
<span class="line-num">662</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">663</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_user_cannot_be_found</span>)
<span class="line-num">664</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">665</span>     <span class="ruby-keyword">return</span>
<span class="line-num">666</span>   <span class="ruby-keyword">end</span>
<span class="line-num">667</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">668</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_an_admin_can_remove_project_users</span>)
<span class="line-num">669</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">670</span>     <span class="ruby-keyword">return</span>
<span class="line-num">671</span>   <span class="ruby-keyword">end</span>
<span class="line-num">672</span>   <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">:priority</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span>).<span class="ruby-identifier">delete_project_observations_on_leave_project</span>(<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">673</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">674</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:removed_project_user</span>)
<span class="line-num">675</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">676</span>   <span class="ruby-keyword">else</span>
<span class="line-num">677</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_user_was_invalid</span>, <span class="ruby-value">:project_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>)
<span class="line-num">678</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_members_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">679</span>     <span class="ruby-keyword">return</span>
<span class="line-num">680</span>   <span class="ruby-keyword">end</span>
<span class="line-num">681</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-search">
            
              <b>search</b>()
            
            <a href="../classes/ProjectsController.html#method-i-search" name="method-i-search" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-search_source')" id="l_method-i-search_source">show</a>
                

                

                
              </p>
              <div id="method-i-search_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1058</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">search</span>
<span class="line-num">1059</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@q</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>]
<span class="line-num">1060</span>     <span class="ruby-identifier">response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>(
<span class="line-num">1061</span>       <span class="ruby-string">&quot;/search&quot;</span>,
<span class="line-num">1062</span>       <span class="ruby-value">q:</span> <span class="ruby-ivar">@q</span>,
<span class="line-num">1063</span>       <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>],
<span class="line-num">1064</span>       <span class="ruby-value">sources:</span> <span class="ruby-string">&quot;projects&quot;</span>,
<span class="line-num">1065</span>       <span class="ruby-value">ttl:</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;-1&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1066</span>     )
<span class="line-num">1067</span>     <span class="ruby-identifier">projects</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;record&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>]} ).<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1068</span>     <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">WillPaginate</span><span class="ruby-operator">::</span><span class="ruby-constant">Collection</span>.<span class="ruby-identifier">create</span>( <span class="ruby-identifier">response</span>[<span class="ruby-string">&quot;page&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">response</span>[<span class="ruby-string">&quot;per_page&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">response</span>[<span class="ruby-string">&quot;total_results&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pager</span><span class="ruby-operator">|</span>
<span class="line-num">1069</span>       <span class="ruby-identifier">pager</span>.<span class="ruby-identifier">replace</span>( <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">projects</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;record&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>]]} )
<span class="line-num">1070</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1071</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1072</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1073</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1074</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1075</span>       <span class="ruby-identifier">opts</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">default_json_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">1076</span>         <span class="ruby-value">:project_list</span>, 
<span class="line-num">1077</span>         {<span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ProjectObservationField</span>.<span class="ruby-identifier">default_json_options</span>}
<span class="line-num">1078</span>       ])
<span class="line-num">1079</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">opts</span>)
<span class="line-num">1080</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1081</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1082</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show">
            
              <b>show</b>()
            
            <a href="../classes/ProjectsController.html#method-i-show" name="method-i-show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_source')" id="l_method-i-show_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">212</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show</span>
<span class="line-num">213</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">214</span> 
<span class="line-num">215</span>     <span class="ruby-identifier">list_observed_and_total</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">list_observed_and_total</span>
<span class="line-num">216</span>     <span class="ruby-ivar">@list_denom</span> = <span class="ruby-identifier">list_observed_and_total</span>[<span class="ruby-value">:denominator</span>]
<span class="line-num">217</span>     <span class="ruby-ivar">@list_numerator</span> = <span class="ruby-identifier">list_observed_and_total</span>[<span class="ruby-value">:numerator</span>]
<span class="line-num">218</span> 
<span class="line-num">219</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">220</span>       <span class="ruby-ivar">@fb_admin_ids</span> = <span class="ruby-constant">ProviderAuthorization</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:project_users</span>).
<span class="line-num">221</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;provider_authorizations.provider_name = &#39;facebook&#39;&quot;</span>).
<span class="line-num">222</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;project_users.project_id = ? AND project_users.role = ?&quot;</span>, <span class="ruby-ivar">@project</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>).
<span class="line-num">223</span>         <span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:provider_uid</span>)
<span class="line-num">224</span>       <span class="ruby-ivar">@fb_admin_ids</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">facebook</span>.<span class="ruby-identifier">admin_ids</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">facebook</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">facebook</span>.<span class="ruby-identifier">admin_ids</span>
<span class="line-num">225</span>       <span class="ruby-ivar">@fb_admin_ids</span> = <span class="ruby-ivar">@fb_admin_ids</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span>).<span class="ruby-identifier">uniq</span>
<span class="line-num">226</span>       <span class="ruby-comment"># check if the project can be previewed as a new-style project</span>
<span class="line-num">227</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value">:collection_preview</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@project</span>.<span class="ruby-identifier">is_new_project?</span>
<span class="line-num">228</span>         <span class="ruby-identifier">project_user</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">229</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:admin</span>) <span class="ruby-operator">||</span> ( <span class="ruby-identifier">project_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">project_user</span>.<span class="ruby-identifier">is_admin?</span> )
<span class="line-num">230</span>           <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">can_be_converted_to_collection_project?</span>
<span class="line-num">231</span>             <span class="ruby-identifier">preview</span> = <span class="ruby-keyword">true</span>
<span class="line-num">232</span>           <span class="ruby-keyword">else</span>
<span class="line-num">233</span>             <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-string">&quot;This project cannot be converted&quot;</span>
<span class="line-num">234</span>           <span class="ruby-keyword">end</span>
<span class="line-num">235</span>         <span class="ruby-keyword">end</span>
<span class="line-num">236</span>       <span class="ruby-keyword">end</span>
<span class="line-num">237</span>       <span class="ruby-comment"># if previewing new-style project, make sure the projects index has the</span>
<span class="line-num">238</span>       <span class="ruby-comment"># properties that new-style projects would have, and sync the ES index</span>
<span class="line-num">239</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">preview</span>
<span class="line-num">240</span>         <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">convert_properties_for_collection_project</span>
<span class="line-num">241</span>         <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">242</span>         <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">243</span>       <span class="ruby-keyword">end</span>
<span class="line-num">244</span>       <span class="ruby-comment"># if previewing, or the project is a new-style, fetch the API</span>
<span class="line-num">245</span>       <span class="ruby-comment"># response and render the React projects show page</span>
<span class="line-num">246</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">is_new_project?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">preview</span>
<span class="line-num">247</span>         <span class="ruby-identifier">projects_response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">project</span>( <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, {
<span class="line-num">248</span>           <span class="ruby-value">rule_details:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">249</span>           <span class="ruby-value">ttl:</span> <span class="ruby-value">-1</span>,
<span class="line-num">250</span>           <span class="ruby-value">authenticate:</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">251</span>         } )
<span class="line-num">252</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">253</span>           <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:doh_something_went_wrong</span> )
<span class="line-num">254</span>           <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">projects_path</span>
<span class="line-num">255</span>         <span class="ruby-keyword">end</span>
<span class="line-num">256</span>         <span class="ruby-ivar">@projects_data</span> = <span class="ruby-identifier">projects_response</span>.<span class="ruby-identifier">results</span>[<span class="ruby-value">0</span>]
<span class="line-num">257</span>         <span class="ruby-ivar">@current_tab</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tab</span>]
<span class="line-num">258</span>         <span class="ruby-ivar">@current_subtab</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:subtab</span>]
<span class="line-num">259</span>         <span class="ruby-ivar">@flash_js</span> = <span class="ruby-keyword">true</span>
<span class="line-num">260</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;show2&quot;</span>
<span class="line-num">261</span>       <span class="ruby-keyword">end</span>
<span class="line-num">262</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">263</span>         <span class="ruby-ivar">@provider_authorizations</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">provider_authorizations</span>.<span class="ruby-identifier">all</span>
<span class="line-num">264</span>       <span class="ruby-keyword">end</span>
<span class="line-num">265</span>       <span class="ruby-ivar">@project_users</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>).
<span class="line-num">266</span>         <span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-value">:per_page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">5</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id DESC&quot;</span>)
<span class="line-num">267</span>       <span class="ruby-ivar">@members_count</span> = <span class="ruby-ivar">@project_users</span>.<span class="ruby-identifier">total_entries</span>
<span class="line-num">268</span>       <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>( { <span class="ruby-value">projects:</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>] }, <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span> )
<span class="line-num">269</span>       <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>( <span class="ruby-identifier">search_params</span> )
<span class="line-num">270</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>( <span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span> )
<span class="line-num">271</span>       <span class="ruby-ivar">@project_journal_posts</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">posts</span>.<span class="ruby-identifier">published</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;published_at DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">4</span>)
<span class="line-num">272</span>       <span class="ruby-ivar">@custom_project</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">custom_project</span>
<span class="line-num">273</span>       <span class="ruby-ivar">@project_assets</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_assets</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">274</span>       <span class="ruby-ivar">@logo_image</span> = <span class="ruby-ivar">@project_assets</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">asset_file_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/logo\.(png|jpg|jpeg|gif)/</span>}    
<span class="line-num">275</span>       <span class="ruby-ivar">@kml_assets</span> = <span class="ruby-ivar">@project_assets</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">asset_file_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\.km[lz]$/</span>}
<span class="line-num">276</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">place</span>
<span class="line-num">277</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">prefers_place_boundary_visible</span>
<span class="line-num">278</span>           <span class="ruby-ivar">@place_geometry</span> = <span class="ruby-constant">PlaceGeometry</span>.<span class="ruby-identifier">without_geom</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:place_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@place</span>).<span class="ruby-identifier">first</span>
<span class="line-num">279</span>         <span class="ruby-keyword">end</span>
<span class="line-num">280</span>       <span class="ruby-keyword">end</span>
<span class="line-num">281</span>       <span class="ruby-ivar">@project_assessments</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">assessments</span>.<span class="ruby-identifier">incomplete</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;assessments.id DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">282</span>       <span class="ruby-ivar">@observations_url_params</span> = { <span class="ruby-value">projects:</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">slug</span>] }
<span class="line-num">283</span>       <span class="ruby-ivar">@observations_url</span> = <span class="ruby-identifier">observations_url</span>(<span class="ruby-ivar">@observations_url_params</span>)
<span class="line-num">284</span>       <span class="ruby-ivar">@observation_search_url_params</span> = { <span class="ruby-value">place_id:</span> <span class="ruby-string">&quot;any&quot;</span>, <span class="ruby-value">verifiable:</span> <span class="ruby-string">&quot;any&quot;</span>, <span class="ruby-value">project_id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">slug</span> }
<span class="line-num">285</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@project_user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">286</span>         <span class="ruby-ivar">@project_user_invitation</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_user_invitations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:invited_user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>).<span class="ruby-identifier">first</span>
<span class="line-num">287</span>       <span class="ruby-keyword">end</span>
<span class="line-num">288</span>       <span class="ruby-ivar">@site_feature</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">site_featured_projects</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">site_id:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">289</span> 
<span class="line-num">290</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:iframe</span>]
<span class="line-num">291</span>         <span class="ruby-ivar">@headless</span> = <span class="ruby-ivar">@footless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">292</span>         <span class="ruby-identifier">top_observers_scope</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="line-num">293</span>         <span class="ruby-ivar">@top_observers</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;observation contest&quot;</span>
<span class="line-num">294</span>           <span class="ruby-identifier">top_observers_scope</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;observations_count desc, taxa_count desc&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations_count &gt; 0&quot;</span>)
<span class="line-num">295</span>         <span class="ruby-keyword">else</span>
<span class="line-num">296</span>           <span class="ruby-identifier">top_observers_scope</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;taxa_count desc, observations_count desc&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa_count &gt; 0&quot;</span>)
<span class="line-num">297</span>         <span class="ruby-keyword">end</span>
<span class="line-num">298</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;show_iframe&quot;</span>
<span class="line-num">299</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:test</span>]
<span class="line-num">300</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">action:</span> <span class="ruby-string">&#39;show_test&#39;</span>, <span class="ruby-value">layout:</span> <span class="ruby-string">&#39;bootstrap&#39;</span>
<span class="line-num">301</span>       <span class="ruby-keyword">end</span>
<span class="line-num">302</span>     <span class="ruby-keyword">end</span>
<span class="line-num">303</span>     
<span class="line-num">304</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">305</span>       <span class="ruby-identifier">opts</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">default_json_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">306</span>         <span class="ruby-value">:project_list</span>, 
<span class="line-num">307</span>         {<span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ProjectObservationField</span>.<span class="ruby-identifier">default_json_options</span>}
<span class="line-num">308</span>       ])
<span class="line-num">309</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:project_observations_count</span>
<span class="line-num">310</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:list_observed_and_total</span>
<span class="line-num">311</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:posts_count</span>
<span class="line-num">312</span> 
<span class="line-num">313</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">as_json</span>(<span class="ruby-identifier">opts</span>)
<span class="line-num">314</span>     <span class="ruby-keyword">end</span>
<span class="line-num">315</span>   <span class="ruby-keyword">end</span>
<span class="line-num">316</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show_contributor">
            
              <b>show_contributor</b>()
            
            <a href="../classes/ProjectsController.html#method-i-show_contributor" name="method-i-show_contributor" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_contributor_source')" id="l_method-i-show_contributor_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_contributor_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">570</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show_contributor</span>
<span class="line-num">571</span>   <span class="ruby-ivar">@contributor</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_user_id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">572</span>   <span class="ruby-ivar">@contributor</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">users:</span> { <span class="ruby-value">login:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_user_id</span>] }).<span class="ruby-identifier">first</span>
<span class="line-num">573</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@contributor</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">574</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:contributor_cannot_be_found</span>)
<span class="line-num">575</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">project_contributors_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">576</span>     <span class="ruby-keyword">return</span>
<span class="line-num">577</span>   <span class="ruby-keyword">end</span>
<span class="line-num">578</span> 
<span class="line-num">579</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">is_new_project?</span>
<span class="line-num">580</span>     <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>({
<span class="line-num">581</span>       <span class="ruby-value">projects:</span> [ <span class="ruby-ivar">@project</span> ],
<span class="line-num">582</span>       <span class="ruby-value">user:</span> <span class="ruby-ivar">@contributor</span>.<span class="ruby-identifier">user</span>,
<span class="line-num">583</span>       <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>],
<span class="line-num">584</span>       <span class="ruby-value">per_page:</span> <span class="ruby-value">20</span>
<span class="line-num">585</span>     })
<span class="line-num">586</span>   <span class="ruby-keyword">else</span>
<span class="line-num">587</span>     <span class="ruby-ivar">@project_observations</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:observation</span>).
<span class="line-num">588</span>       <span class="ruby-identifier">where</span>(<span class="ruby-value">observations:</span> { <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@contributor</span>.<span class="ruby-identifier">user</span> }).
<span class="line-num">589</span>       <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], <span class="ruby-value">per_page:</span> <span class="ruby-value">28</span>)
<span class="line-num">590</span> 
<span class="line-num">591</span>     <span class="ruby-ivar">@research_grade_count</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.
<span class="line-num">592</span>       <span class="ruby-identifier">joins</span>(<span class="ruby-value">:observation</span>).
<span class="line-num">593</span>       <span class="ruby-identifier">where</span>(<span class="ruby-value">observations:</span> { <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@contributor</span>.<span class="ruby-identifier">user</span>,
<span class="line-num">594</span>         <span class="ruby-value">quality_grade:</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span> }).<span class="ruby-identifier">count</span>
<span class="line-num">595</span> 
<span class="line-num">596</span>     <span class="ruby-ivar">@research_grade_species_count</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.
<span class="line-num">597</span>       <span class="ruby-identifier">joins</span>(<span class="ruby-value">observation:</span> <span class="ruby-value">:taxon</span>).
<span class="line-num">598</span>       <span class="ruby-identifier">where</span>(<span class="ruby-value">observations:</span> { <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@contributor</span>.<span class="ruby-identifier">user</span>,
<span class="line-num">599</span>         <span class="ruby-value">quality_grade:</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span> }).
<span class="line-num">600</span>       <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa.rank_level &lt; ?&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">GENUS_LEVEL</span>).<span class="ruby-identifier">count</span>
<span class="line-num">601</span>   <span class="ruby-keyword">end</span>
<span class="line-num">602</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-stats">
            
              <b>stats</b>()
            
            <a href="../classes/ProjectsController.html#method-i-stats" name="method-i-stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-stats_source')" id="l_method-i-stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-stats_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">816</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">stats</span>
<span class="line-num">817</span>   <span class="ruby-ivar">@project_user_stats</span> = <span class="ruby-constant">Hash</span>[
<span class="line-num">818</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.
<span class="line-num">819</span>       <span class="ruby-identifier">group</span>(<span class="ruby-string">&quot;date_trunc(&#39;month&#39;, created_at)&quot;</span>).
<span class="line-num">820</span>       <span class="ruby-identifier">count</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-regexp">/\d{4}-\d{2}/</span>, <span class="ruby-value">0</span>], <span class="ruby-identifier">v</span>]}
<span class="line-num">821</span>   ]
<span class="line-num">822</span>   <span class="ruby-ivar">@project_observation_stats</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">823</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">824</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">825</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">project_ids:</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">826</span>     ],
<span class="line-num">827</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">828</span>       <span class="ruby-value">year_months:</span> {
<span class="line-num">829</span>         <span class="ruby-value">date_histogram:</span> {
<span class="line-num">830</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;created_at&quot;</span>,
<span class="line-num">831</span>           <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span>,
<span class="line-num">832</span>           <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM&quot;</span>,
<span class="line-num">833</span>           <span class="ruby-value">keyed:</span> <span class="ruby-keyword">true</span>
<span class="line-num">834</span>         }
<span class="line-num">835</span>       }
<span class="line-num">836</span>     }
<span class="line-num">837</span>   ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">year_months</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num">838</span>   <span class="ruby-ivar">@project_observation_stats</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-ivar">@project_observation_stats</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">year_month</span>, <span class="ruby-identifier">bucket</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">year_month</span>, <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">doc_count</span>]}]
<span class="line-num">839</span>   <span class="ruby-ivar">@unique_observer_stats</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">840</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">841</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">842</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">project_ids:</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">843</span>     ],
<span class="line-num">844</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">845</span>       <span class="ruby-value">year_months:</span> {
<span class="line-num">846</span>         <span class="ruby-value">date_histogram:</span> {
<span class="line-num">847</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;created_at&quot;</span>,
<span class="line-num">848</span>           <span class="ruby-value">interval:</span> <span class="ruby-string">&quot;month&quot;</span>,
<span class="line-num">849</span>           <span class="ruby-value">format:</span> <span class="ruby-string">&quot;yyyy-MM&quot;</span>,
<span class="line-num">850</span>           <span class="ruby-value">keyed:</span> <span class="ruby-keyword">true</span>
<span class="line-num">851</span>         },
<span class="line-num">852</span>         <span class="ruby-value">aggs:</span> {
<span class="line-num">853</span>           <span class="ruby-value">distinct_users:</span> {
<span class="line-num">854</span>             <span class="ruby-value">cardinality:</span> {
<span class="line-num">855</span>               <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>
<span class="line-num">856</span>             }
<span class="line-num">857</span>           }
<span class="line-num">858</span>         }
<span class="line-num">859</span>       }
<span class="line-num">860</span>     }
<span class="line-num">861</span>   ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">year_months</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num">862</span>   <span class="ruby-ivar">@unique_observer_stats</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-ivar">@unique_observer_stats</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">year_month</span>, <span class="ruby-identifier">bucket</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">year_month</span>, <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">distinct_users</span>.<span class="ruby-identifier">value</span>]}]
<span class="line-num">863</span>   <span class="ruby-ivar">@total_project_users</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">count</span>
<span class="line-num">864</span>   <span class="ruby-ivar">@total_project_observations</span> = <span class="ruby-ivar">@project_observation_stats</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">sum</span>
<span class="line-num">865</span>   <span class="ruby-ivar">@total_unique_observers</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">866</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">867</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">868</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-value">project_ids:</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>] } }
<span class="line-num">869</span>     ],
<span class="line-num">870</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">871</span>       <span class="ruby-value">distinct_users:</span> {
<span class="line-num">872</span>         <span class="ruby-value">cardinality:</span> {
<span class="line-num">873</span>           <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>
<span class="line-num">874</span>         }
<span class="line-num">875</span>       }
<span class="line-num">876</span>     }
<span class="line-num">877</span>   ).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">distinct_users</span>.<span class="ruby-identifier">value</span>
<span class="line-num">878</span>   <span class="ruby-ivar">@headers</span> = [<span class="ruby-identifier">t</span>(<span class="ruby-value">:year_month</span>), <span class="ruby-identifier">t</span>(<span class="ruby-value">:new_members</span>), <span class="ruby-identifier">t</span>(<span class="ruby-value">:new_observations</span>), <span class="ruby-identifier">t</span>(<span class="ruby-value">:unique_observers</span>)]
<span class="line-num">879</span>   <span class="ruby-ivar">@data</span> = []
<span class="line-num">880</span>   (<span class="ruby-ivar">@project_user_stats</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@project_observation_stats</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@unique_observer_stats</span>.<span class="ruby-identifier">keys</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
<span class="line-num">881</span>     <span class="ruby-ivar">@data</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">key</span>, <span class="ruby-ivar">@project_user_stats</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-ivar">@project_observation_stats</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-ivar">@unique_observer_stats</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_i</span>]
<span class="line-num">882</span>   <span class="ruby-keyword">end</span>
<span class="line-num">883</span>   <span class="ruby-ivar">@data</span>.<span class="ruby-identifier">sort_by!</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span>).<span class="ruby-identifier">reverse!</span>
<span class="line-num">884</span>   
<span class="line-num">885</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">886</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">887</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">888</span>       <span class="ruby-identifier">opts</span> = {}
<span class="line-num">889</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:project_id</span>] = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>
<span class="line-num">890</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:project_title</span>] = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>
<span class="line-num">891</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:total_project_users</span>] = <span class="ruby-ivar">@total_project_users</span>
<span class="line-num">892</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:total_project_observations</span>] = <span class="ruby-ivar">@total_project_observations</span>
<span class="line-num">893</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:total_unique_observers</span>] = <span class="ruby-ivar">@total_unique_observers</span>
<span class="line-num">894</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:data</span>] = []
<span class="line-num">895</span>       <span class="ruby-ivar">@data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span>
<span class="line-num">896</span>         <span class="ruby-identifier">per_period</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
<span class="line-num">897</span>         <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each_with_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">d</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">per_period</span>[<span class="ruby-ivar">@headers</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[ \/]/</span>, <span class="ruby-string">&#39;_&#39;</span>)] = <span class="ruby-identifier">d</span> }
<span class="line-num">898</span>         <span class="ruby-identifier">opts</span>[<span class="ruby-value">:data</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">per_period</span>
<span class="line-num">899</span>       <span class="ruby-keyword">end</span>
<span class="line-num">900</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>
<span class="line-num">901</span>     <span class="ruby-keyword">end</span>
<span class="line-num">902</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span> 
<span class="line-num">903</span>       <span class="ruby-identifier">csv_text</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-value">:headers</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">904</span>         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@headers</span>
<span class="line-num">905</span>         <span class="ruby-ivar">@data</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span> <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">row</span>}
<span class="line-num">906</span>       <span class="ruby-keyword">end</span>
<span class="line-num">907</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">csv_text</span>
<span class="line-num">908</span>     <span class="ruby-keyword">end</span>
<span class="line-num">909</span>   <span class="ruby-keyword">end</span>
<span class="line-num">910</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-stats_slideshow">
            
              <b>stats_slideshow</b>()
            
            <a href="../classes/ProjectsController.html#method-i-stats_slideshow" name="method-i-stats_slideshow" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-stats_slideshow_source')" id="l_method-i-stats_slideshow_source">show</a>
                

                

                
              </p>
              <div id="method-i-stats_slideshow_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1093</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">stats_slideshow</span>
<span class="line-num">1094</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">NPS_BIOBLITZ_PROJECT_NAME</span>
<span class="line-num">1095</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">nps_bioblitz_stats_path</span>
<span class="line-num">1096</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1097</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1098</span>     <span class="ruby-ivar">@slideshow_project</span> = {
<span class="line-num">1099</span>       <span class="ruby-value">id:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">1100</span>       <span class="ruby-value">title:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;2016 National Parks BioBlitz - &quot;</span>, <span class="ruby-string">&quot;&quot;</span>),
<span class="line-num">1101</span>       <span class="ruby-value">slug:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">slug</span>,
<span class="line-num">1102</span>       <span class="ruby-value">start_time:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">start_time</span>,
<span class="line-num">1103</span>       <span class="ruby-value">end_time:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">end_time</span>,
<span class="line-num">1104</span>       <span class="ruby-value">place_id:</span> (<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">place</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">rule_place</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>),
<span class="line-num">1105</span>       <span class="ruby-value">observation_count:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">count</span>,
<span class="line-num">1106</span>       <span class="ruby-value">in_progress:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">event_in_progress?</span>,
<span class="line-num">1107</span>       <span class="ruby-value">species_count:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">node_api_species_count</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
<span class="line-num">1108</span>     }
<span class="line-num">1109</span>   <span class="ruby-keyword">rescue</span>
<span class="line-num">1110</span>     <span class="ruby-identifier">sleep</span>(<span class="ruby-value">2</span>)
<span class="line-num">1111</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">stats_slideshow_project_path</span>(<span class="ruby-ivar">@project</span>)
<span class="line-num">1112</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1113</span> 
<span class="line-num">1114</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;basic&quot;</span>
<span class="line-num">1115</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-terms">
            
              <b>terms</b>()
            
            <a href="../classes/ProjectsController.html#method-i-terms" name="method-i-terms" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-terms_source')" id="l_method-i-terms_source">show</a>
                

                

                
              </p>
              <div id="method-i-terms_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">475</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">terms</span>
<span class="line-num">476</span>   <span class="ruby-ivar">@project_observation_rules</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observation_rules</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">477</span>   <span class="ruby-ivar">@project_user_rules</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_user_rules</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">478</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">479</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">480</span>   <span class="ruby-keyword">end</span>
<span class="line-num">481</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unfeature">
            
              <b>unfeature</b>()
            
            <a href="../classes/ProjectsController.html#method-i-unfeature" name="method-i-unfeature" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unfeature_source')" id="l_method-i-unfeature_source">show</a>
                

                

                
              </p>
              <div id="method-i-unfeature_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">1146</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unfeature</span>
<span class="line-num">1147</span>   <span class="ruby-constant">SiteFeaturedProject</span>.<span class="ruby-identifier">where</span>(
<span class="line-num">1148</span>     <span class="ruby-value">site:</span> <span class="ruby-ivar">@site</span>, <span class="ruby-value">project:</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1149</span>   ).<span class="ruby-identifier">destroy_all</span>
<span class="line-num">1150</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">json:</span> { }
<span class="line-num">1151</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>()
            
            <a href="../classes/ProjectsController.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>PUT /projects/1 PUT /projects/1.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/projects_controller.rb</span>
<span class="line-num">394</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>
<span class="line-num">395</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">icon</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:icon_delete</span>]
<span class="line-num">396</span>   <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">cover</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cover_delete</span>]
<span class="line-num">397</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>][<span class="ruby-value">:user_id</span>]
<span class="line-num">398</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>][<span class="ruby-value">:user_id</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">399</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;errors.messages.only_project_owner_can_change_project_owner&quot;</span> )
<span class="line-num">400</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>][<span class="ruby-value">:user_id</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">401</span>       <span class="ruby-identifier">new_admin</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>][<span class="ruby-value">:user_id</span>] )
<span class="line-num">402</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_admin</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">403</span>         <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:x_does_not_exist</span>, <span class="ruby-value">x:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:user</span> ) )
<span class="line-num">404</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">new_admin</span>, <span class="ruby-value">role:</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">405</span>         <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;errors.messages.new_project_owner_must_be_a_manager&quot;</span> )
<span class="line-num">406</span>       <span class="ruby-keyword">end</span>
<span class="line-num">407</span>     <span class="ruby-keyword">end</span>
<span class="line-num">408</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">msg</span>
<span class="line-num">409</span>       <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">410</span>         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">411</span>           <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">412</span>           <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-ivar">@project</span> )
<span class="line-num">413</span>         <span class="ruby-keyword">end</span>
<span class="line-num">414</span>         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">415</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> }, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>
<span class="line-num">416</span>         <span class="ruby-keyword">end</span>
<span class="line-num">417</span>       <span class="ruby-keyword">end</span>
<span class="line-num">418</span>       <span class="ruby-keyword">return</span>
<span class="line-num">419</span>     <span class="ruby-keyword">end</span>
<span class="line-num">420</span>   <span class="ruby-keyword">end</span>
<span class="line-num">421</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">422</span>     <span class="ruby-comment"># Project uses accepts_nested_attributes which saves associates after the main record,</span>
<span class="line-num">423</span>     <span class="ruby-comment"># potentially trigging a lot of indexing for things like ProjectUsers. So skip indexing the</span>
<span class="line-num">424</span>     <span class="ruby-comment"># project until the entire save/update process is done</span>
<span class="line-num">425</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">426</span>     <span class="ruby-identifier">saved_successfully</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project</span>])
<span class="line-num">427</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">428</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">429</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_successfully</span>
<span class="line-num">430</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span>(<span class="ruby-ivar">@project</span>, <span class="ruby-value">:notice</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:project_was_successfully_updated</span>)) }
<span class="line-num">431</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@project</span> }
<span class="line-num">432</span>     <span class="ruby-keyword">else</span>
<span class="line-num">433</span>       <span class="ruby-ivar">@project_types</span> = <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">PROJECT_TYPES</span>
<span class="line-num">434</span>       <span class="ruby-ivar">@project_types</span> = <span class="ruby-keyword">if</span> [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_type</span>, <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_type_was</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">BIOBLITZ_TYPE</span> )
<span class="line-num">435</span>         <span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">PROJECT_TYPES</span>
<span class="line-num">436</span>       <span class="ruby-keyword">else</span>
<span class="line-num">437</span>         [<span class="ruby-constant">Project</span><span class="ruby-operator">::</span><span class="ruby-constant">ASSESSMENT_TYPE</span>]
<span class="line-num">438</span>       <span class="ruby-keyword">end</span>
<span class="line-num">439</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;edit&quot;</span> }
<span class="line-num">440</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">errors</span>, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">441</span>     <span class="ruby-keyword">end</span>
<span class="line-num">442</span>   <span class="ruby-keyword">end</span>
<span class="line-num">443</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
