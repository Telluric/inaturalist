<!DOCTYPE html>
<html lang="en">
<head>
    <title>Observation</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Observation"]'>


    <meta property="og:title" value="Observation">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="Observation class, as_indexed_json, prepare_batch_for_index, matching_taxon_ids, params_to_elastic_query, captive_flag, captive_flag=, distinct_taxon, identifications, near_place, preload_for_component, to_s, to_plain_s, time_observed_at_utc, serializable_hash, datetime, timezone_object, timezone_offset, time_observed_at_in_zone, munge_observed_on_with_chronic, englishize_month_abbrevs_for_locale, update_identifications, observation_field_values_attributes=, refresh_check_lists, keep_old_taxon_id, set_iconic_taxon, replace_inactive_taxon, strip_species_guess, set_time_zone, set_time_in_time_zone, set_captive, component_cache_key, component_cache_key, num_identifications_by_others, appropriate?, georeferenced?, was_georeferenced?, quality_metric_score, community_supported_id?, quality_metrics_pass?, passes_quality_metric?, research_grade_candidate?, human?, research_grade?, verifiable?, photos?, sounds?, set_quality_grade, set_quality_grade, get_quality_grade, coordinates_obscured?, coordinates_obscured, coordinates_private?, coordinates_changed?, geoprivacy_private?, geoprivacy_obscured?, coordinates_viewable_by?, normalize_geoprivacy, reassess_coordinate_obscuration, hide_coordinates, obscure_coordinates, obscure_place_guess, lat_lon_in_place_guess?, unobscure_coordinates, iconic_taxon_name, captive_cultivated?, captive_cultivated, reviewed_by?, get_community_taxon, print_community_taxon_nodes, community_taxon_nodes, set_community_taxon, set_community_taxon_before_save, set_observations_taxa_for_user, community_taxon_rejected?, probable_taxon, set_taxon_from_probable_taxon, reassess_coordinates_for_observations_of, reassess_coordinates_for_observations_by, reassess_coordinates_of, find_observations_of, must_be_in_the_past, date_observed_must_be_before_date_created, must_not_be_a_range, must_not_be_on_null_island, set_taxon_from_taxon_name, set_taxon_from_species_guess, set_taxon_geoprivacy, single_taxon_for_name, single_taxon_id_for_name, set_latlon_from_place_guess, set_geom_from_latlon, place_guess_from_latlon, set_place_guess_from_latlon, set_license, license_code=, trim_user_agent, set_uri, update_default_license, update_all_licenses, update_taxon_counter_caches, update_user_counter_caches_after_create, update_user_counter_caches_after_destroy, update_user_counter_caches_after_update, update_user_counter_caches, update_user_species_counter_cache_later, delete_observations_places, update_quality_metrics, license_name, image_url, obs_image_url, sound_url, short_description, scientific_name, common_name, url, user_login, update_stats, update_stats_for_observations_of, random_neighbor_lat_lon, uncertainty_cell_center_latlon, uncertainty_cell_diagonal_meters, private_sw_latlon, sw_latlon, private_ne_latlon, ne_latlon, uncertainty_cell_diagonal_meters, places_for_latlon, places_without_obscuration_protection, places, public_places, system_places_for_latlon, system_places, public_system_places, intersecting_places, taxon_and_ancestors, mobile?, device_name, device_url, owners_identification, others_identifications, method_missing, respond_to?, merge, create_observation_review, reassess_annotations, create_deleted_observation, build_observation_fields_from_tags, fields_addable_by?, set_coordinates, nilify_positional_accuracy_if_zero, update_for_taxon_change, generate_csv, generate_csv_for, generate_csv_for_cache_key, public_positional_accuracy, update_public_positional_accuracy, calculate_public_positional_accuracy, inaccurate_location?, update_mappable, calculate_mappable, update_observations_places, set_taxon_photo, update_observations_places, observation_photos_finished_processing, interpolate_coordinates, as_csv, community_taxon_at_species_or_lower?, community_taxon_at_family_or_lower?, community_taxon_below_family?, needs_id_upvotes_count, needs_id_downvotes_count, needs_id_vote_score, voted_out_of_needs_id?, voted_in_to_needs_id?, needs_id?, casual?, flagged_with, mentioned_users, faves_count, probably_captive?, application_id_to_index, owners_identification_from_vision, owners_identification_from_vision=, reindex_identifications, reindex_places, reindex_projects, user_viewed_updates, in_collection_projects?, collection_projects, dedupe_for_user, index_observations_for_user, mark_as_updated">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Observation
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/es_indices/observation_index_rb.html">app/es_indices/observation_index.rb</a></li>
            
            <li><a href="../files/app/helpers/application_helper_rb.html">app/helpers/application_helper.rb</a></li>
            
            <li><a href="../files/app/helpers/observations_helper_rb.html">app/helpers/observations_helper.rb</a></li>
            
            <li><a href="../files/app/models/check_list_rb.html">app/models/check_list.rb</a></li>
            
            <li><a href="../files/app/models/conservation_status_rb.html">app/models/conservation_status.rb</a></li>
            
            <li><a href="../files/app/models/guide_range_rb.html">app/models/guide_range.rb</a></li>
            
            <li><a href="../files/app/models/guide_section_rb.html">app/models/guide_section.rb</a></li>
            
            <li><a href="../files/app/models/guide_taxon_rb.html">app/models/guide_taxon.rb</a></li>
            
            <li><a href="../files/app/models/mushroom_observer_import_flow_task_rb.html">app/models/mushroom_observer_import_flow_task.rb</a></li>
            
            <li><a href="../files/app/models/observation_rb.html">app/models/observation.rb</a></li>
            
            <li><a href="../files/app/models/observation_field_value_rb.html">app/models/observation_field_value.rb</a></li>
            
            <li><a href="../files/app/models/observations_export_flow_task_rb.html">app/models/observations_export_flow_task.rb</a></li>
            
            <li><a href="../files/app/models/project_observation_rb.html">app/models/project_observation.rb</a></li>
            
            <li><a href="../files/app/models/site_statistic_rb.html">app/models/site_statistic.rb</a></li>
            
            <li><a href="../files/app/models/taxon_rb.html">app/models/taxon.rb</a></li>
            
            <li><a href="../files/app/models/user_rb.html">app/models/user.rb</a></li>
            
            <li><a href="../files/lib/acts_as_spammable/user_rb.html">lib/acts_as_spammable/user.rb</a></li>
            
            <li><a href="../files/lib/darwin_core/archive_rb.html">lib/darwin_core/archive.rb</a></li>
            
            <li><a href="../files/lib/darwin_core/occurrence_rb.html">lib/darwin_core/occurrence.rb</a></li>
            
            <li><a href="../files/lib/observation_search_rb.html">lib/observation_search.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-application_id_to_index">application_id_to_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-appropriate-3F">appropriate?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-as_csv">as_csv</a>,
              </li>
            
              
              <li>
                <a href="#method-i-as_indexed_json">as_indexed_json</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-build_observation_fields_from_tags">build_observation_fields_from_tags</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-calculate_mappable">calculate_mappable</a>,
              </li>
            
              
              <li>
                <a href="#method-i-calculate_public_positional_accuracy">calculate_public_positional_accuracy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-captive_cultivated">captive_cultivated</a>,
              </li>
            
              
              <li>
                <a href="#method-i-captive_cultivated-3F">captive_cultivated?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-captive_flag">captive_flag</a>,
              </li>
            
              
              <li>
                <a href="#method-i-captive_flag-3D">captive_flag=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-casual-3F">casual?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-collection_projects">collection_projects</a>,
              </li>
            
              
              <li>
                <a href="#method-i-common_name">common_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_supported_id-3F">community_supported_id?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_taxon_at_family_or_lower-3F">community_taxon_at_family_or_lower?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_taxon_at_species_or_lower-3F">community_taxon_at_species_or_lower?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_taxon_below_family-3F">community_taxon_below_family?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_taxon_nodes">community_taxon_nodes</a>,
              </li>
            
              
              <li>
                <a href="#method-i-community_taxon_rejected-3F">community_taxon_rejected?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-component_cache_key">component_cache_key</a>,
              </li>
            
              
              <li>
                <a href="#method-c-component_cache_key">component_cache_key</a>,
              </li>
            
              
              <li>
                <a href="#method-i-coordinates_changed-3F">coordinates_changed?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-coordinates_obscured">coordinates_obscured</a>,
              </li>
            
              
              <li>
                <a href="#method-i-coordinates_obscured-3F">coordinates_obscured?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-coordinates_private-3F">coordinates_private?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-coordinates_viewable_by-3F">coordinates_viewable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_deleted_observation">create_deleted_observation</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_observation_review">create_observation_review</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-date_observed_must_be_before_date_created">date_observed_must_be_before_date_created</a>,
              </li>
            
              
              <li>
                <a href="#method-i-datetime">datetime</a>,
              </li>
            
              
              <li>
                <a href="#method-c-dedupe_for_user">dedupe_for_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-delete_observations_places">delete_observations_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-device_name">device_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-device_url">device_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-distinct_taxon">distinct_taxon</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-englishize_month_abbrevs_for_locale">englishize_month_abbrevs_for_locale</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-faves_count">faves_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-fields_addable_by-3F">fields_addable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-find_observations_of">find_observations_of</a>,
              </li>
            
              
              <li>
                <a href="#method-i-flagged_with">flagged_with</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-generate_csv">generate_csv</a>,
              </li>
            
              
              <li>
                <a href="#method-c-generate_csv_for">generate_csv_for</a>,
              </li>
            
              
              <li>
                <a href="#method-c-generate_csv_for_cache_key">generate_csv_for_cache_key</a>,
              </li>
            
              
              <li>
                <a href="#method-i-geoprivacy_obscured-3F">geoprivacy_obscured?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-geoprivacy_private-3F">geoprivacy_private?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-georeferenced-3F">georeferenced?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_community_taxon">get_community_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_quality_grade">get_quality_grade</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-hide_coordinates">hide_coordinates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-human-3F">human?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-iconic_taxon_name">iconic_taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-identifications">identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-image_url">image_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-in_collection_projects-3F">in_collection_projects?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-inaccurate_location-3F">inaccurate_location?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-index_observations_for_user">index_observations_for_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-interpolate_coordinates">interpolate_coordinates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-intersecting_places">intersecting_places</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>K</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-keep_old_taxon_id">keep_old_taxon_id</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-lat_lon_in_place_guess-3F">lat_lon_in_place_guess?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-license_code-3D">license_code=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-license_name">license_name</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-mark_as_updated">mark_as_updated</a>,
              </li>
            
              
              <li>
                <a href="#method-c-matching_taxon_ids">matching_taxon_ids</a>,
              </li>
            
              
              <li>
                <a href="#method-i-mentioned_users">mentioned_users</a>,
              </li>
            
              
              <li>
                <a href="#method-i-merge">merge</a>,
              </li>
            
              
              <li>
                <a href="#method-i-method_missing">method_missing</a>,
              </li>
            
              
              <li>
                <a href="#method-i-mobile-3F">mobile?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-munge_observed_on_with_chronic">munge_observed_on_with_chronic</a>,
              </li>
            
              
              <li>
                <a href="#method-i-must_be_in_the_past">must_be_in_the_past</a>,
              </li>
            
              
              <li>
                <a href="#method-i-must_not_be_a_range">must_not_be_a_range</a>,
              </li>
            
              
              <li>
                <a href="#method-i-must_not_be_on_null_island">must_not_be_on_null_island</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-ne_latlon">ne_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-near_place">near_place</a>,
              </li>
            
              
              <li>
                <a href="#method-i-needs_id-3F">needs_id?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-needs_id_downvotes_count">needs_id_downvotes_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-needs_id_upvotes_count">needs_id_upvotes_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-needs_id_vote_score">needs_id_vote_score</a>,
              </li>
            
              
              <li>
                <a href="#method-i-nilify_positional_accuracy_if_zero">nilify_positional_accuracy_if_zero</a>,
              </li>
            
              
              <li>
                <a href="#method-i-normalize_geoprivacy">normalize_geoprivacy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-num_identifications_by_others">num_identifications_by_others</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-obs_image_url">obs_image_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-obscure_coordinates">obscure_coordinates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-obscure_place_guess">obscure_place_guess</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observation_field_values_attributes-3D">observation_field_values_attributes=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observation_photos_finished_processing">observation_photos_finished_processing</a>,
              </li>
            
              
              <li>
                <a href="#method-i-others_identifications">others_identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-owners_identification">owners_identification</a>,
              </li>
            
              
              <li>
                <a href="#method-i-owners_identification_from_vision">owners_identification_from_vision</a>,
              </li>
            
              
              <li>
                <a href="#method-i-owners_identification_from_vision-3D">owners_identification_from_vision=</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-params_to_elastic_query">params_to_elastic_query</a>,
              </li>
            
              
              <li>
                <a href="#method-i-passes_quality_metric-3F">passes_quality_metric?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photos-3F">photos?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-place_guess_from_latlon">place_guess_from_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-places">places</a>,
              </li>
            
              
              <li>
                <a href="#method-c-places_for_latlon">places_for_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-places_without_obscuration_protection">places_without_obscuration_protection</a>,
              </li>
            
              
              <li>
                <a href="#method-c-preload_for_component">preload_for_component</a>,
              </li>
            
              
              <li>
                <a href="#method-c-prepare_batch_for_index">prepare_batch_for_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-print_community_taxon_nodes">print_community_taxon_nodes</a>,
              </li>
            
              
              <li>
                <a href="#method-i-private_ne_latlon">private_ne_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-private_sw_latlon">private_sw_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-probable_taxon">probable_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-probably_captive-3F">probably_captive?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-public_places">public_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-public_positional_accuracy">public_positional_accuracy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-public_system_places">public_system_places</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>Q</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-quality_metric_score">quality_metric_score</a>,
              </li>
            
              
              <li>
                <a href="#method-i-quality_metrics_pass-3F">quality_metrics_pass?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-random_neighbor_lat_lon">random_neighbor_lat_lon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reassess_annotations">reassess_annotations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reassess_coordinate_obscuration">reassess_coordinate_obscuration</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reassess_coordinates_for_observations_by">reassess_coordinates_for_observations_by</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reassess_coordinates_for_observations_of">reassess_coordinates_for_observations_of</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reassess_coordinates_of">reassess_coordinates_of</a>,
              </li>
            
              
              <li>
                <a href="#method-i-refresh_check_lists">refresh_check_lists</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reindex_identifications">reindex_identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reindex_places">reindex_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reindex_projects">reindex_projects</a>,
              </li>
            
              
              <li>
                <a href="#method-i-replace_inactive_taxon">replace_inactive_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-research_grade-3F">research_grade?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-research_grade_candidate-3F">research_grade_candidate?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-respond_to-3F">respond_to?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reviewed_by-3F">reviewed_by?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-scientific_name">scientific_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-serializable_hash">serializable_hash</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_captive">set_captive</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_community_taxon">set_community_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_community_taxon_before_save">set_community_taxon_before_save</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_coordinates">set_coordinates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_geom_from_latlon">set_geom_from_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_iconic_taxon">set_iconic_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_latlon_from_place_guess">set_latlon_from_place_guess</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_license">set_license</a>,
              </li>
            
              
              <li>
                <a href="#method-c-set_observations_taxa_for_user">set_observations_taxa_for_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_place_guess_from_latlon">set_place_guess_from_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_quality_grade">set_quality_grade</a>,
              </li>
            
              
              <li>
                <a href="#method-c-set_quality_grade">set_quality_grade</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_taxon_from_probable_taxon">set_taxon_from_probable_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_taxon_from_species_guess">set_taxon_from_species_guess</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_taxon_from_taxon_name">set_taxon_from_taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_taxon_geoprivacy">set_taxon_geoprivacy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_taxon_photo">set_taxon_photo</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_time_in_time_zone">set_time_in_time_zone</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_time_zone">set_time_zone</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_uri">set_uri</a>,
              </li>
            
              
              <li>
                <a href="#method-i-short_description">short_description</a>,
              </li>
            
              
              <li>
                <a href="#method-i-single_taxon_for_name">single_taxon_for_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-single_taxon_id_for_name">single_taxon_id_for_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sound_url">sound_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sounds-3F">sounds?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-strip_species_guess">strip_species_guess</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sw_latlon">sw_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-system_places">system_places</a>,
              </li>
            
              
              <li>
                <a href="#method-c-system_places_for_latlon">system_places_for_latlon</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-taxon_and_ancestors">taxon_and_ancestors</a>,
              </li>
            
              
              <li>
                <a href="#method-i-time_observed_at_in_zone">time_observed_at_in_zone</a>,
              </li>
            
              
              <li>
                <a href="#method-i-time_observed_at_utc">time_observed_at_utc</a>,
              </li>
            
              
              <li>
                <a href="#method-i-timezone_object">timezone_object</a>,
              </li>
            
              
              <li>
                <a href="#method-i-timezone_offset">timezone_offset</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_plain_s">to_plain_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-trim_user_agent">trim_user_agent</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-uncertainty_cell_center_latlon">uncertainty_cell_center_latlon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-uncertainty_cell_diagonal_meters">uncertainty_cell_diagonal_meters</a>,
              </li>
            
              
              <li>
                <a href="#method-i-uncertainty_cell_diagonal_meters">uncertainty_cell_diagonal_meters</a>,
              </li>
            
              
              <li>
                <a href="#method-i-unobscure_coordinates">unobscure_coordinates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_all_licenses">update_all_licenses</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_default_license">update_default_license</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_for_taxon_change">update_for_taxon_change</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_identifications">update_identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_mappable">update_mappable</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observations_places">update_observations_places</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_observations_places">update_observations_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_public_positional_accuracy">update_public_positional_accuracy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_quality_metrics">update_quality_metrics</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_stats">update_stats</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_stats_for_observations_of">update_stats_for_observations_of</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_taxon_counter_caches">update_taxon_counter_caches</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_counter_caches">update_user_counter_caches</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_counter_caches_after_create">update_user_counter_caches_after_create</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_counter_caches_after_destroy">update_user_counter_caches_after_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_counter_caches_after_update">update_user_counter_caches_after_update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_species_counter_cache_later">update_user_species_counter_cache_later</a>,
              </li>
            
              
              <li>
                <a href="#method-i-url">url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user_login">user_login</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user_viewed_updates">user_viewed_updates</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-verifiable-3F">verifiable?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-voted_in_to_needs_id-3F">voted_in_to_needs_id?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-voted_out_of_needs_id-3F">voted_out_of_needs_id?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-was_georeferenced-3F">was_georeferenced?</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="ActsAsElasticModel.html">
              ActsAsElasticModel
            </a>
          
        </li>
      
        <li>
          
            <a href="ObservationSearch.html">
              ObservationSearch
            </a>
          
        </li>
      
        <li>
          
            <a href="ActsAsUUIDable.html">
              ActsAsUUIDable
            </a>
          
        </li>
      
        <li>
          
            <a href="Ambidextrous.html">
              Ambidextrous
            </a>
          
        </li>
      
        <li>
          
            <a href="ObservationsHelper.html">
              ObservationsHelper
            </a>
          
        </li>
      
        <li>
          
            ActionView::Helpers::SanitizeHelper
          
        </li>
      
        <li>
          
            ActionView::Helpers::TextHelper
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_DESCRIPTION_TAGS</td>
            <td>=</td>
            <td class="attr-value">%w(
a
abbr
acronym
b
blockquote
br
cite
code
em
i
img
pre
s
small
strike
strong
sub
sup
)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALL_EXPORT_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">(CSV_COLUMNS + BASIC_COLUMNS + GEO_COLUMNS + TAXON_COLUMNS + EXTRA_TAXON_COLUMNS).uniq</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">BASIC_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;id&quot;, 
&quot;observed_on_string&quot;,
&quot;observed_on&quot;, 
&quot;time_observed_at&quot;,
&quot;time_zone&quot;,
&quot;user_id&quot;, 
&quot;user_login&quot;,
&quot;created_at&quot;,
&quot;updated_at&quot;,
&quot;quality_grade&quot;,
&quot;license&quot;,
&quot;url&quot;, 
&quot;image_url&quot;,
&quot;sound_url&quot;,
&quot;tag_list&quot;,
&quot;description&quot;,
&quot;num_identification_agreements&quot;,
&quot;num_identification_disagreements&quot;,
&quot;captive_cultivated&quot;,
&quot;oauth_application_id&quot;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">CASUAL</td>
            <td>=</td>
            <td class="attr-value">&quot;casual&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">COMMUNITY_TAXON_SCORE_CUTOFF</td>
            <td>=</td>
            <td class="attr-value">(2.0 / 3)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">COORDINATE_REGEX</td>
            <td>=</td>
            <td class="attr-value">/[^\d\,]*?(#{FLOAT_REGEX})[^\d\,]*?/</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">COORDINATE_UNCERTAINTY_CELL_SIZE</td>
            <td>=</td>
            <td class="attr-value">0.2</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">CSV_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;id&quot;, 
&quot;species_guess&quot;,
&quot;scientific_name&quot;, 
&quot;common_name&quot;, 
&quot;iconic_taxon_name&quot;,
&quot;taxon_id&quot;,
&quot;num_identification_agreements&quot;,
&quot;num_identification_disagreements&quot;,
&quot;observed_on_string&quot;,
&quot;observed_on&quot;, 
&quot;time_observed_at&quot;,
&quot;time_zone&quot;,
&quot;place_guess&quot;,
&quot;latitude&quot;, 
&quot;longitude&quot;,
&quot;positional_accuracy&quot;,
&quot;private_place_guess&quot;,
&quot;private_latitude&quot;,
&quot;private_longitude&quot;,
&quot;public_positional_accuracy&quot;,
&quot;geoprivacy&quot;,
&quot;taxon_geoprivacy&quot;,
&quot;coordinates_obscured&quot;,
&quot;positioning_method&quot;,
&quot;positioning_device&quot;,
&quot;user_id&quot;, 
&quot;user_login&quot;,
&quot;created_at&quot;,
&quot;updated_at&quot;,
&quot;quality_grade&quot;,
&quot;license&quot;,
&quot;url&quot;, 
&quot;image_url&quot;,
&quot;sound_url&quot;,
&quot;tag_list&quot;,
&quot;description&quot;,
&quot;oauth_application_id&quot;,
&quot;captive_cultivated&quot;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_ES_BATCH_SIZE</td>
            <td>=</td>
            <td class="attr-value">100</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_ES_BATCH_SLEEP</td>
            <td>=</td>
            <td class="attr-value">2</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">DEGREES_PER_RADIAN</td>
            <td>=</td>
            <td class="attr-value">57.2958</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">EXTRA_TAXON_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">%w(
kingdom
phylum
subphylum
superclass
class
subclass
superorder
order
suborder
superfamily
family
subfamily
supertribe
tribe
subtribe
genus
genushybrid
species
hybrid
subspecies
variety
form
).map{|r| &quot;taxon_#{r}_name&quot;}.compact</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">FIELDS_TO_SEARCH_ON</td>
            <td>=</td>
            <td class="attr-value">%w(names tags description place)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">FLOAT_REGEX</td>
            <td>=</td>
            <td class="attr-value">/[-+]?[0-9]*\.?[0-9]+/</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">GEOPRIVACIES</td>
            <td>=</td>
            <td class="attr-value">[OBSCURED, PRIVATE]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">GEOPRIVACY_DESCRIPTIONS</td>
            <td>=</td>
            <td class="attr-value">{
OPEN =&gt; :open_description,
OBSCURED =&gt; :obscured_description, 
PRIVATE =&gt; :private_description
}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">GEO_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;place_guess&quot;,
&quot;latitude&quot;, 
&quot;longitude&quot;,
&quot;positional_accuracy&quot;,
&quot;private_place_guess&quot;,
&quot;private_latitude&quot;,
&quot;private_longitude&quot;,
&quot;public_positional_accuracy&quot;,
&quot;geoprivacy&quot;,
&quot;taxon_geoprivacy&quot;,
&quot;coordinates_obscured&quot;,
&quot;positioning_method&quot;,
&quot;positioning_device&quot;,
&quot;place_town_name&quot;,
&quot;place_county_name&quot;,
&quot;place_state_name&quot;,
&quot;place_country_name&quot;,
&quot;place_admin1_name&quot;,
&quot;place_admin2_name&quot;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LAT_LON_REGEX</td>
            <td>=</td>
            <td class="attr-value">/#{COORDINATE_REGEX}#{LAT_LON_SEPARATOR_REGEX}#{COORDINATE_REGEX}/</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LAT_LON_SEPARATOR_REGEX</td>
            <td>=</td>
            <td class="attr-value">/[\,\s]\s*/</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LICENSES</td>
            <td>=</td>
            <td class="attr-value">[
[&quot;CC0&quot;, :cc_0_name, :cc_0_description],
[&quot;CC-BY&quot;, :cc_by_name, :cc_by_description],
[&quot;CC-BY-NC&quot;, :cc_by_nc_name, :cc_by_nc_description],
[&quot;CC-BY-SA&quot;, :cc_by_sa_name, :cc_by_sa_description],
[&quot;CC-BY-ND&quot;, :cc_by_nd_name, :cc_by_nd_description],
[&quot;CC-BY-NC-SA&quot;,:cc_by_nc_sa_name, :cc_by_nc_sa_description],
[&quot;CC-BY-NC-ND&quot;, :cc_by_nc_nd_name, :cc_by_nc_nd_description]
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LICENSE_CODES</td>
            <td>=</td>
            <td class="attr-value">LICENSES.map{|row| row.first}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MASS_ASSIGNABLE_ATTRIBUTES</td>
            <td>=</td>
            <td class="attr-value">[:make_license_default, :make_licenses_same]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">M_TO_OBSCURE_THREATENED_TAXA</td>
            <td>=</td>
            <td class="attr-value">10000</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NEEDS_ID</td>
            <td>=</td>
            <td class="attr-value">&quot;needs_id&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">OBSCURED</td>
            <td>=</td>
            <td class="attr-value">&quot;obscured&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">OPEN</td>
            <td>=</td>
            <td class="attr-value">&quot;open&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PLANETARY_RADIUS</td>
            <td>=</td>
            <td class="attr-value">6370997.0</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PREFERRED_LICENSES</td>
            <td>=</td>
            <td class="attr-value">[CC_BY, CC_BY_NC, CC0]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PRIVATE</td>
            <td>=</td>
            <td class="attr-value">&quot;private&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">QUALITY_GRADES</td>
            <td>=</td>
            <td class="attr-value">[CASUAL, NEEDS_ID, RESEARCH_GRADE]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">RESEARCH_GRADE</td>
            <td>=</td>
            <td class="attr-value">&quot;research&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">TAXON_COLUMNS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;species_guess&quot;,
&quot;scientific_name&quot;, 
&quot;common_name&quot;, 
&quot;iconic_taxon_name&quot;,
&quot;taxon_id&quot;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">WGS84_PROJ4</td>
            <td>=</td>
            <td class="attr-value">&quot;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>bulk_delete</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>bulk_import</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>coordinate_system</td>
            <td class='attr-desc'><p>coordinate system</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>custom_field_errors</td>
            <td class='attr-desc'><p>custom project field errors</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>editing_user_id</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>force_quality_metrics</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>geo_x</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>geo_y</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>indexed_place_ids</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>indexed_private_place_ids</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>indexed_private_places</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>localize_locale</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>localize_place</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>make_license_default</td>
            <td class='attr-desc'><p>licensing extras</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>make_licenses_same</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>obscuration_changed</td>
            <td class='attr-desc'><p>Track whether obscuration has changed over the life of this instance</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>owners_identification_from_vision_requested</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_identification_indexing</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_identifications</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_indexing</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_quality_metrics</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_refresh_check_lists</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>taxon_endemic</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>taxon_introduced</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>taxon_name</td>
            <td class='attr-desc'><p>Set if you need to set the taxon from a name separate from the species  guess</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>taxon_native</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>will_be_saved_with_photos</td>
            <td class='attr-desc'><p>Set to true if you want to skip the expensive updating of all the user&#39;s lists after saving.  Useful if you&#39;re saving many observations at once and you want to update lists in a batch</p></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-as_csv">
            
              <b>as_csv</b>(scope, methods, options = {})
            
            <a href="../classes/Observation.html#method-c-as_csv" name="method-c-as_csv" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-as_csv_source')" id="l_method-c-as_csv_source">show</a>
                

                

                
              </p>
              <div id="method-c-as_csv_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3137</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">as_csv</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">methods</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">3138</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">generate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">3139</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">methods</span>
<span class="line-num">3140</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
<span class="line-num">3141</span>       <span class="ruby-comment"># image_url gets options, which will include an SSL boolean</span>
<span class="line-num">3142</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">methods</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">:image_url</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">m</span>, <span class="ruby-identifier">options</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">m</span>) }
<span class="line-num">3143</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3144</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3145</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-component_cache_key">
            
              <b>component_cache_key</b>(id, options = {})
            
            <a href="../classes/Observation.html#method-c-component_cache_key" name="method-c-component_cache_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-component_cache_key_source')" id="l_method-c-component_cache_key_source">show</a>
                

                

                
              </p>
              <div id="method-c-component_cache_key_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1362</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">component_cache_key</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">1363</span>   <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;obs_comp_#{id}&quot;</span>
<span class="line-num">1364</span>   <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{k}-#{v}&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1365</span>   <span class="ruby-identifier">key</span>
<span class="line-num">1366</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-dedupe_for_user">
            
              <b>dedupe_for_user</b>(user, options = {})
            
            <a href="../classes/Observation.html#method-c-dedupe_for_user" name="method-c-dedupe_for_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-dedupe_for_user_source')" id="l_method-c-dedupe_for_user_source">show</a>
                

                

                
              </p>
              <div id="method-c-dedupe_for_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3330</span>   <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">dedupe_for_user</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">3331</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>)
<span class="line-num">3332</span>       <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">user</span>) 
<span class="line-num">3333</span>       <span class="ruby-identifier">u</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>(<span class="ruby-identifier">user</span>)
<span class="line-num">3334</span>       <span class="ruby-identifier">user</span> = <span class="ruby-identifier">u</span>
<span class="line-num">3335</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3336</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>
<span class="line-num">3337</span>     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">3338</span> <span class="ruby-value">      SELECT 
<span class="line-num">3339</span>         array_agg(id) AS observation_ids
<span class="line-num">3340</span>       FROM
<span class="line-num">3341</span>         observations
<span class="line-num">3342</span>       WHERE
<span class="line-num">3343</span>         user_id = #{user.id}
<span class="line-num">3344</span>         AND taxon_id IS NOT NULL
<span class="line-num">3345</span>         AND observed_on_string IS NOT NULL AND observed_on_string != &#39;&#39;
<span class="line-num">3346</span>         AND private_geom IS NOT NULL
<span class="line-num">3347</span>       GROUP BY 
<span class="line-num">3348</span>         user_id,
<span class="line-num">3349</span>         taxon_id, 
<span class="line-num">3350</span>         observed_on_string, 
<span class="line-num">3351</span>         private_geom
<span class="line-num">3352</span>       HAVING count(*) &gt; 1;
<span class="line-num">3353</span> </span><span class="ruby-identifier">    SQL</span>
<span class="line-num">3354</span>     <span class="ruby-identifier">deleted</span> = <span class="ruby-value">0</span>
<span class="line-num">3355</span>     <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">3356</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">sql</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">3357</span>       <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;observation_ids&#39;</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[\{\}]/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>).<span class="ruby-identifier">sort</span>
<span class="line-num">3358</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Found duplicates: #{ids.join(&#39;,&#39;)}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">3359</span>       <span class="ruby-identifier">keeper_id</span> = <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">shift</span>
<span class="line-num">3360</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tKeeping #{keeper_id}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">3361</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:test</span>]
<span class="line-num">3362</span>         <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">ids</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">3363</span>           <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tDeleting #{o.id}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">3364</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">3365</span>         <span class="ruby-keyword">end</span>
<span class="line-num">3366</span>       <span class="ruby-keyword">end</span>
<span class="line-num">3367</span>       <span class="ruby-identifier">deleted</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">size</span>
<span class="line-num">3368</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3369</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleted #{deleted} observations in #{Time.now - start}s&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">3370</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-find_observations_of">
            
              <b>find_observations_of</b>(taxon)
            
            <a href="../classes/Observation.html#method-c-find_observations_of" name="method-c-find_observations_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-find_observations_of_source')" id="l_method-c-find_observations_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-find_observations_of_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2002</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">find_observations_of</span>(<span class="ruby-identifier">taxon</span>)
<span class="line-num">2003</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">2004</span>     <span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;observations.taxon_id = ? OR taxa.ancestry LIKE &#39;#{taxon.ancestry}/#{taxon.id}%&#39;&quot;</span>, <span class="ruby-identifier">taxon</span>).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">2005</span>     <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">o</span>)
<span class="line-num">2006</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2007</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_csv">
            
              <b>generate_csv</b>(scope, options = {})
            
            <a href="../classes/Observation.html#method-c-generate_csv" name="method-c-generate_csv" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>2014-01 I tried improving performance by loading ancestor taxa for each batch, but it didn&#39;t really speed things up much</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_csv_source')" id="l_method-c-generate_csv_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_csv_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2956</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_csv</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">2957</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:fname</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;observations.csv&quot;</span>
<span class="line-num">2958</span>   <span class="ruby-identifier">fpath</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:path</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:dir</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Dir</span><span class="ruby-operator">::</span><span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">fname</span>)
<span class="line-num">2959</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">fpath</span>), <span class="ruby-value">:mode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0755</span>
<span class="line-num">2960</span>   <span class="ruby-identifier">columns</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:columns</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">CSV_COLUMNS</span>
<span class="line-num">2961</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">fpath</span>, <span class="ruby-string">&#39;w&#39;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">2962</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">columns</span>
<span class="line-num">2963</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_each</span>(<span class="ruby-value">batch_size:</span> <span class="ruby-value">500</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">2964</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">columns</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num">2965</span>         <span class="ruby-identifier">c</span> = <span class="ruby-string">&quot;cached_tag_list&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;tag_list&quot;</span>
<span class="line-num">2966</span>         <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">c</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">2967</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2968</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2969</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2970</span>   <span class="ruby-identifier">fpath</span>
<span class="line-num">2971</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_csv_for">
            
              <b>generate_csv_for</b>(record, options = {})
            
            <a href="../classes/Observation.html#method-c-generate_csv_for" name="method-c-generate_csv_for" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_csv_for_source')" id="l_method-c-generate_csv_for_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_csv_for_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2973</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_csv_for</span>(<span class="ruby-identifier">record</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">2974</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:fname</span>] <span class="ruby-operator">||</span> <span class="ruby-node">&quot;#{record.to_param}-observations.csv&quot;</span>
<span class="line-num">2975</span>   <span class="ruby-identifier">fpath</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:path</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:dir</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Dir</span><span class="ruby-operator">::</span><span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">fname</span>)
<span class="line-num">2976</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Dir</span><span class="ruby-operator">::</span><span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">fname</span>)
<span class="line-num">2977</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">tmp_path</span>), <span class="ruby-value">:mode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0755</span>
<span class="line-num">2978</span>   <span class="ruby-identifier">columns</span> = <span class="ruby-constant">CSV_COLUMNS</span>
<span class="line-num">2979</span> 
<span class="line-num">2980</span>   <span class="ruby-comment"># ensure private coordinates are hidden unless they shouldn&#39;t be</span>
<span class="line-num">2981</span>   <span class="ruby-identifier">viewer_curates_project</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Project</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">curated_by?</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>])
<span class="line-num">2982</span>   <span class="ruby-identifier">viewer_is_owner</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">record</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">2983</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">viewer_curates_project</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">viewer_is_owner</span>
<span class="line-num">2984</span>     <span class="ruby-identifier">columns</span> = <span class="ruby-identifier">columns</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp">/^private_/</span>}
<span class="line-num">2985</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2986</span> 
<span class="line-num">2987</span>   <span class="ruby-comment"># generate the csv</span>
<span class="line-num">2988</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:generate_csv</span>)
<span class="line-num">2989</span>     <span class="ruby-identifier">record</span>.<span class="ruby-identifier">generate_csv</span>(<span class="ruby-identifier">tmp_path</span>, <span class="ruby-identifier">columns</span>, <span class="ruby-value">viewer:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>])
<span class="line-num">2990</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2991</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">observations</span>.
<span class="line-num">2992</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">2993</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">observation_field_values:</span> <span class="ruby-value">:observation_field</span>)
<span class="line-num">2994</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] <span class="ruby-operator">===</span> <span class="ruby-identifier">record</span>
<span class="line-num">2995</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">project_observations:</span> <span class="ruby-value">:stored_preferences</span>).
<span class="line-num">2996</span>         <span class="ruby-identifier">includes</span>(<span class="ruby-value">user:</span> {<span class="ruby-value">project_users:</span> <span class="ruby-value">:stored_preferences</span>})
<span class="line-num">2997</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2998</span>     <span class="ruby-identifier">generate_csv</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-value">:path</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">:fname</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">fname</span>, <span class="ruby-value">:columns</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">columns</span>, <span class="ruby-value">:viewer</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>])
<span class="line-num">2999</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3000</span> 
<span class="line-num">3001</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">fpath</span>), <span class="ruby-value">:mode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0755</span>
<span class="line-num">3002</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">tmp_path</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">fpath</span>
<span class="line-num">3003</span>     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-identifier">fpath</span>
<span class="line-num">3004</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3005</span>   <span class="ruby-identifier">fpath</span>
<span class="line-num">3006</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_csv_for_cache_key">
            
              <b>generate_csv_for_cache_key</b>(record, options = {})
            
            <a href="../classes/Observation.html#method-c-generate_csv_for_cache_key" name="method-c-generate_csv_for_cache_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_csv_for_cache_key_source')" id="l_method-c-generate_csv_for_cache_key_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_csv_for_cache_key_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3008</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_csv_for_cache_key</span>(<span class="ruby-identifier">record</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">3009</span>   <span class="ruby-node">&quot;#{record.class.name.underscore}_#{record.id}&quot;</span>
<span class="line-num">3010</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-identifications">
            
              <b>identifications</b>(agreement)
            
            <a href="../classes/Observation.html#method-c-identifications" name="method-c-identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-identifications_source')" id="l_method-c-identifications_source">show</a>
                

                

                
              </p>
              <div id="method-c-identifications_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">624</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">identifications</span>(<span class="ruby-identifier">agreement</span>)
<span class="line-num">625</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>
<span class="line-num">626</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:identifications</span>)
<span class="line-num">627</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">agreement</span>
<span class="line-num">628</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;most_agree&#39;</span>
<span class="line-num">629</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;num_identification_agreements &gt; num_identification_disagreements&quot;</span>)
<span class="line-num">630</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;some_agree&#39;</span>
<span class="line-num">631</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;num_identification_agreements &gt; 0&quot;</span>)
<span class="line-num">632</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;most_disagree&#39;</span>
<span class="line-num">633</span>     <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;num_identification_agreements &lt; num_identification_disagreements&quot;</span>)
<span class="line-num">634</span>   <span class="ruby-keyword">else</span>
<span class="line-num">635</span>     <span class="ruby-identifier">scope</span>
<span class="line-num">636</span>   <span class="ruby-keyword">end</span>
<span class="line-num">637</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-index_observations_for_user">
            
              <b>index_observations_for_user</b>(user_id)
            
            <a href="../classes/Observation.html#method-c-index_observations_for_user" name="method-c-index_observations_for_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-index_observations_for_user_source')" id="l_method-c-index_observations_for_user_source">show</a>
                

                

                
              </p>
              <div id="method-c-index_observations_for_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3372</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">index_observations_for_user</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">3373</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">user_id</span> ), <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">3374</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-matching_taxon_ids">
            
              <b>matching_taxon_ids</b>( search_term )
            
            <a href="../classes/Observation.html#method-c-matching_taxon_ids" name="method-c-matching_taxon_ids" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-matching_taxon_ids_source')" id="l_method-c-matching_taxon_ids_source">show</a>
                

                

                
              </p>
              <div id="method-c-matching_taxon_ids_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/observation_index.rb</span>
<span class="line-num">542</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">matching_taxon_ids</span>( <span class="ruby-identifier">search_term</span> )
<span class="line-num">543</span>   <span class="ruby-identifier">filters</span> = [
<span class="line-num">544</span>     { <span class="ruby-value">term:</span> { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> } },
<span class="line-num">545</span>     {
<span class="line-num">546</span>       <span class="ruby-value">nested:</span> {
<span class="line-num">547</span>         <span class="ruby-value">path:</span> <span class="ruby-string">&quot;names&quot;</span>,
<span class="line-num">548</span>         <span class="ruby-value">query:</span> {
<span class="line-num">549</span>           <span class="ruby-value">match:</span> {
<span class="line-num">550</span>             <span class="ruby-value">&quot;names.name&quot;:</span> {
<span class="line-num">551</span>               <span class="ruby-value">query:</span> <span class="ruby-identifier">search_term</span>,
<span class="line-num">552</span>               <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span>
<span class="line-num">553</span>             }
<span class="line-num">554</span>           }
<span class="line-num">555</span>         }
<span class="line-num">556</span>       }
<span class="line-num">557</span>     }
<span class="line-num">558</span>   ]
<span class="line-num">559</span>   <span class="ruby-identifier">search_result</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_search</span>(<span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>, <span class="ruby-value">source:</span> [<span class="ruby-value">:id</span>], <span class="ruby-value">size:</span> <span class="ruby-value">2000</span> )
<span class="line-num">560</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">search_result</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> )
<span class="line-num">561</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-near_place">
            
              <b>near_place</b>(place)
            
            <a href="../classes/Observation.html#method-c-near_place" name="method-c-near_place" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-near_place_source')" id="l_method-c-near_place_source">show</a>
                

                

                
              </p>
              <div id="method-c-near_place_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">746</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">near_place</span>(<span class="ruby-identifier">place</span>)
<span class="line-num">747</span>   <span class="ruby-identifier">place</span> = (<span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">place</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Place</span>)
<span class="line-num">748</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">swlat</span>
<span class="line-num">749</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">in_bounding_box</span>(<span class="ruby-identifier">place</span>.<span class="ruby-identifier">swlat</span>, <span class="ruby-identifier">place</span>.<span class="ruby-identifier">swlng</span>, <span class="ruby-identifier">place</span>.<span class="ruby-identifier">nelat</span>, <span class="ruby-identifier">place</span>.<span class="ruby-identifier">nelng</span>)
<span class="line-num">750</span>   <span class="ruby-keyword">else</span>
<span class="line-num">751</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">near_point</span>(<span class="ruby-identifier">place</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">place</span>.<span class="ruby-identifier">longitude</span>)
<span class="line-num">752</span>   <span class="ruby-keyword">end</span>
<span class="line-num">753</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-params_to_elastic_query">
            
              <b>params_to_elastic_query</b>(params, options = {})
            
            <a href="../classes/Observation.html#method-c-params_to_elastic_query" name="method-c-params_to_elastic_query" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-params_to_elastic_query_source')" id="l_method-c-params_to_elastic_query_source">show</a>
                

                

                
              </p>
              <div id="method-c-params_to_elastic_query_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/es_indices/observation_index.rb</span>
<span class="line-num"> 563</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">params_to_elastic_query</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num"> 564</span>   <span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:current_user</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:viewer</span>]
<span class="line-num"> 565</span>   <span class="ruby-identifier">p</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:_query_params_set</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">query_params</span>(<span class="ruby-identifier">params</span>)
<span class="line-num"> 566</span>   <span class="ruby-comment"># one of the param initializing steps saw an impossible condition</span>
<span class="line-num"> 567</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:empty_set</span>]
<span class="line-num"> 568</span>   <span class="ruby-identifier">p</span> = <span class="ruby-identifier">site_search_params</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:site</span>], <span class="ruby-identifier">p</span>)
<span class="line-num"> 569</span>   <span class="ruby-identifier">search_filters</span> = [ ]
<span class="line-num"> 570</span>   <span class="ruby-identifier">inverse_filters</span> = [ ]
<span class="line-num"> 571</span>   <span class="ruby-identifier">extra_preloads</span> = [ ]
<span class="line-num"> 572</span>   <span class="ruby-identifier">q</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:q</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 573</span>   <span class="ruby-identifier">search_on</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:search_on</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">FIELDS_TO_SEARCH_ON</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:search_on</span>])
<span class="line-num"> 574</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">q</span>
<span class="line-num"> 575</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">search_on</span> <span class="ruby-operator">===</span> <span class="ruby-string">&quot;names&quot;</span>
<span class="line-num"> 576</span>       <span class="ruby-identifier">search_taxa</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 577</span>       <span class="ruby-identifier">searched_taxa</span> = <span class="ruby-identifier">matching_taxon_ids</span>( <span class="ruby-identifier">q</span> )
<span class="line-num"> 578</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">search_on</span> <span class="ruby-operator">===</span> <span class="ruby-string">&quot;tags&quot;</span>
<span class="line-num"> 579</span>       <span class="ruby-identifier">fields</span> = [ <span class="ruby-value">:tags</span> ]
<span class="line-num"> 580</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">search_on</span> <span class="ruby-operator">===</span> <span class="ruby-string">&quot;description&quot;</span>
<span class="line-num"> 581</span>       <span class="ruby-identifier">fields</span> = [ <span class="ruby-value">:description</span> ]
<span class="line-num"> 582</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">search_on</span> <span class="ruby-operator">===</span> <span class="ruby-string">&quot;place&quot;</span>
<span class="line-num"> 583</span>       <span class="ruby-identifier">fields</span> = [ <span class="ruby-value">:place_guess</span> ]
<span class="line-num"> 584</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 585</span>       <span class="ruby-identifier">fields</span> = [ <span class="ruby-value">:tags</span>, <span class="ruby-value">:description</span>, <span class="ruby-value">:place_guess</span> ]
<span class="line-num"> 586</span>       <span class="ruby-identifier">search_taxa</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 587</span>       <span class="ruby-identifier">searched_taxa</span> = <span class="ruby-identifier">matching_taxon_ids</span>( <span class="ruby-identifier">q</span> )
<span class="line-num"> 588</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 589</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">searched_taxa</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">searched_taxa</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num"> 590</span>       <span class="ruby-identifier">taxon_search_filter</span> = { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;taxon.id&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">searched_taxa</span> } }
<span class="line-num"> 591</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 592</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">fields</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">fields</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num"> 593</span>       <span class="ruby-identifier">match_filter</span> = { <span class="ruby-value">multi_match:</span> { <span class="ruby-value">query:</span> <span class="ruby-identifier">q</span>, <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span>, <span class="ruby-value">fields:</span> <span class="ruby-identifier">fields</span> } }
<span class="line-num"> 594</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 595</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">match_filter</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_search_filter</span>
<span class="line-num"> 596</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num"> 597</span>         <span class="ruby-value">bool:</span> {
<span class="line-num"> 598</span>           <span class="ruby-value">should:</span> [
<span class="line-num"> 599</span>             <span class="ruby-identifier">match_filter</span>,
<span class="line-num"> 600</span>             <span class="ruby-identifier">taxon_search_filter</span>
<span class="line-num"> 601</span>           ]
<span class="line-num"> 602</span>         }
<span class="line-num"> 603</span>       }
<span class="line-num"> 604</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">match_filter</span>
<span class="line-num"> 605</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">match_filter</span>
<span class="line-num"> 606</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">search_taxa</span>
<span class="line-num"> 607</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> ( <span class="ruby-identifier">taxon_search_filter</span> <span class="ruby-operator">||</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">id:</span> <span class="ruby-value">-1</span> } } )
<span class="line-num"> 608</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 609</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 610</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:user</span>]
<span class="line-num"> 611</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> {
<span class="line-num"> 612</span>       <span class="ruby-string">&quot;user.id.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:user</span>]) } }
<span class="line-num"> 613</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:user_id</span>]
<span class="line-num"> 614</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 615</span>       <span class="ruby-string">&quot;user.id.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:user_id</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">u</span>) } } }
<span class="line-num"> 616</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 617</span> 
<span class="line-num"> 618</span>   <span class="ruby-comment"># params to search based on value</span>
<span class="line-num"> 619</span>   [ { <span class="ruby-value">http_param:</span> <span class="ruby-value">:rank</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon.rank&quot;</span> },
<span class="line-num"> 620</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:observed_on_day</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.day&quot;</span> },
<span class="line-num"> 621</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:observed_on_month</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.month&quot;</span> },
<span class="line-num"> 622</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:observed_on_year</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.year&quot;</span> },
<span class="line-num"> 623</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:day</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.day&quot;</span> },
<span class="line-num"> 624</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:month</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.month&quot;</span> },
<span class="line-num"> 625</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:year</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.year&quot;</span> },
<span class="line-num"> 626</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:week</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;observed_on_details.week&quot;</span> },
<span class="line-num"> 627</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:site_id</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;site_id.keyword&quot;</span> },
<span class="line-num"> 628</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:id</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;id&quot;</span> }
<span class="line-num"> 629</span>   ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
<span class="line-num"> 630</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 631</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-identifier">filter</span>[<span class="ruby-value">:es_field</span>] <span class="ruby-operator">=&gt;</span>
<span class="line-num"> 632</span>         [ <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num"> 633</span>           <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">v</span>) } } }
<span class="line-num"> 634</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 635</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 636</span> 
<span class="line-num"> 637</span>   <span class="ruby-comment"># Place searches require special handling if the user is asking for their</span>
<span class="line-num"> 638</span>   <span class="ruby-comment"># own observations</span>
<span class="line-num"> 639</span>   <span class="ruby-identifier">params_user_ids</span> = [<span class="ruby-identifier">p</span>[<span class="ruby-value">:user_id</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
<span class="line-num"> 640</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:place_id</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 641</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:viewer</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params_user_ids</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:viewer</span>].<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">params_user_ids</span>[<span class="ruby-value">0</span>]
<span class="line-num"> 642</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;private_place_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:place_id</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num"> 643</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">v</span>)
<span class="line-num"> 644</span>       } } }
<span class="line-num"> 645</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 646</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;place_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:place_id</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num"> 647</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">v</span>)
<span class="line-num"> 648</span>       } } }
<span class="line-num"> 649</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 650</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 651</span> 
<span class="line-num"> 652</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:not_in_place</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 653</span>     <span class="ruby-identifier">place_ids</span> = [<span class="ruby-identifier">p</span>[<span class="ruby-value">:not_in_place</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>( <span class="ruby-identifier">v</span> ) }
<span class="line-num"> 654</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">params_user_ids</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:viewer</span>]&amp;.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">params_user_ids</span>[<span class="ruby-value">0</span>] )
<span class="line-num"> 655</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;private_place_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">place_ids</span> } }
<span class="line-num"> 656</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 657</span>       { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;place_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">place_ids</span> } }
<span class="line-num"> 658</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 659</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 660</span> 
<span class="line-num"> 661</span>   <span class="ruby-comment"># params that can be true / false / any</span>
<span class="line-num"> 662</span>   [ { <span class="ruby-value">http_param:</span> <span class="ruby-value">:introduced</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon.introduced&quot;</span> },
<span class="line-num"> 663</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:threatened</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon.threatened&quot;</span> },
<span class="line-num"> 664</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:native</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon.native&quot;</span> },
<span class="line-num"> 665</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:endemic</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon.endemic&quot;</span> },
<span class="line-num"> 666</span>     <span class="ruby-comment"># TODO remove id_please when we remove it from the ES index</span>
<span class="line-num"> 667</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:id_please</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;id_please&quot;</span> },
<span class="line-num"> 668</span>     <span class="ruby-comment"># TODO remove out_of_range when we remove it from the ES index</span>
<span class="line-num"> 669</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:out_of_range</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;out_of_range&quot;</span> },
<span class="line-num"> 670</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:mappable</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;mappable&quot;</span> },
<span class="line-num"> 671</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:captive</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;captive&quot;</span> },
<span class="line-num"> 672</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:spam</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;spam&quot;</span> }
<span class="line-num"> 673</span>   ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
<span class="line-num"> 674</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 675</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-identifier">filter</span>[<span class="ruby-value">:es_field</span>] <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span> } }
<span class="line-num"> 676</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 677</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-identifier">filter</span>[<span class="ruby-value">:es_field</span>] <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span> } }
<span class="line-num"> 678</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 679</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 680</span> 
<span class="line-num"> 681</span>   <span class="ruby-comment"># params that can check for presence of something</span>
<span class="line-num"> 682</span>   [ { <span class="ruby-value">http_param:</span> <span class="ruby-value">:with_photos</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;photos_count&quot;</span> },
<span class="line-num"> 683</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:with_sounds</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;sounds_count&quot;</span> },
<span class="line-num"> 684</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:with_geo</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;geojson&quot;</span> },
<span class="line-num"> 685</span>     { <span class="ruby-value">http_param:</span> <span class="ruby-value">:identified</span>, <span class="ruby-value">es_field:</span> <span class="ruby-string">&quot;taxon&quot;</span> },
<span class="line-num"> 686</span>   ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
<span class="line-num"> 687</span>     <span class="ruby-identifier">f</span> = { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-identifier">filter</span>[<span class="ruby-value">:es_field</span>] } }
<span class="line-num"> 688</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 689</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>
<span class="line-num"> 690</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[ <span class="ruby-identifier">filter</span>[<span class="ruby-value">:http_param</span>] ].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 691</span>       <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>
<span class="line-num"> 692</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 693</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 694</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:verifiable</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 695</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 696</span>       <span class="ruby-value">quality_grade:</span> [ <span class="ruby-string">&quot;research&quot;</span>, <span class="ruby-string">&quot;needs_id&quot;</span> ] } }
<span class="line-num"> 697</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:verifiable</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 698</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">not:</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 699</span>       <span class="ruby-value">quality_grade:</span> [ <span class="ruby-string">&quot;research&quot;</span>, <span class="ruby-string">&quot;needs_id&quot;</span> ] } } }
<span class="line-num"> 700</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 701</span>   <span class="ruby-comment"># include the taxon plus all of its descendants.</span>
<span class="line-num"> 702</span>   <span class="ruby-comment"># Every taxon has its own ID in ancestor_ids</span>
<span class="line-num"> 703</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:observations_taxon</span>]
<span class="line-num"> 704</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> {
<span class="line-num"> 705</span>       <span class="ruby-string">&quot;taxon.ancestor_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:observations_taxon</span>]) } }
<span class="line-num"> 706</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:observations_taxon_ids</span>]
<span class="line-num"> 707</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 708</span>       <span class="ruby-string">&quot;taxon.ancestor_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:observations_taxon_ids</span>] } }
<span class="line-num"> 709</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 710</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:without_observations_taxon</span>]
<span class="line-num"> 711</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num"> 712</span>       <span class="ruby-value">term:</span> {
<span class="line-num"> 713</span>         <span class="ruby-string">&quot;taxon.ancestor_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>( <span class="ruby-identifier">p</span>[<span class="ruby-value">:without_observations_taxon</span>] )
<span class="line-num"> 714</span>       }
<span class="line-num"> 715</span>     }
<span class="line-num"> 716</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 717</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 718</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;license_code&quot;</span> } }
<span class="line-num"> 719</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;none&quot;</span>
<span class="line-num"> 720</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;license_code&quot;</span> } }
<span class="line-num"> 721</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">String</span> )
<span class="line-num"> 722</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">license_code:</span>
<span class="line-num"> 723</span>       [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ) ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">downcase</span> } } }
<span class="line-num"> 724</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Array</span> )
<span class="line-num"> 725</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">license_code:</span>
<span class="line-num"> 726</span>       [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:license</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">downcase</span> } } }
<span class="line-num"> 727</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 728</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 729</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;photo_licenses&quot;</span> } }
<span class="line-num"> 730</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;none&quot;</span>
<span class="line-num"> 731</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;photo_licenses&quot;</span> } }
<span class="line-num"> 732</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>]
<span class="line-num"> 733</span>     <span class="ruby-identifier">licenses</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">String</span> )
<span class="line-num"> 734</span>       [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ) ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num"> 735</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 736</span>       [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:photo_license</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num"> 737</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 738</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;photo_licenses&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">licenses</span> } }
<span class="line-num"> 739</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 740</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:sound_license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 741</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;sound_licenses&quot;</span> } }
<span class="line-num"> 742</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:sound_license</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;none&quot;</span>
<span class="line-num"> 743</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;sound_licenses&quot;</span> } }
<span class="line-num"> 744</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:sound_license</span>]
<span class="line-num"> 745</span>     <span class="ruby-identifier">licenses</span> = [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:sound_license</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num"> 746</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;sound_licenses&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">licenses</span> } }
<span class="line-num"> 747</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 748</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">split_date</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:created_on</span>], <span class="ruby-value">utc:</span> <span class="ruby-keyword">true</span>)
<span class="line-num"> 749</span>     [ <span class="ruby-value">:day</span>, <span class="ruby-value">:month</span>, <span class="ruby-value">:year</span> ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">part</span><span class="ruby-operator">|</span>
<span class="line-num"> 750</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span>[<span class="ruby-identifier">part</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">d</span>[<span class="ruby-identifier">part</span>] <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
<span class="line-num"> 751</span>         <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-node">&quot;created_at_details.#{ part }&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">d</span>[<span class="ruby-identifier">part</span>] } }
<span class="line-num"> 752</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 753</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 754</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 755</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">p</span>[<span class="ruby-value">:project</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 756</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>] = [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:project</span>] ]
<span class="line-num"> 757</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 758</span>   <span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>] = [<span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>]].<span class="ruby-identifier">flatten</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>]
<span class="line-num"> 759</span>   <span class="ruby-identifier">extra</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:extra</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num"> 760</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 761</span>     <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">proj</span><span class="ruby-operator">|</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">proj</span>) }
<span class="line-num"> 762</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">project_ids:</span> <span class="ruby-identifier">project_ids</span> } }
<span class="line-num"> 763</span>     <span class="ruby-identifier">extra_preloads</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:projects</span>
<span class="line-num"> 764</span>     <span class="ruby-comment"># since we have projects, check the `pcid` param</span>
<span class="line-num"> 765</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pcid</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 766</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 767</span>         <span class="ruby-value">project_ids_with_curator_id:</span> <span class="ruby-identifier">project_ids</span> } }
<span class="line-num"> 768</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pcid</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 769</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> {
<span class="line-num"> 770</span>         <span class="ruby-value">project_ids_without_curator_id:</span> <span class="ruby-identifier">project_ids</span> } }
<span class="line-num"> 771</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 772</span>   <span class="ruby-keyword">else</span>
<span class="line-num"> 773</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pcid</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 774</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> {
<span class="line-num"> 775</span>         <span class="ruby-value">field:</span> <span class="ruby-string">&quot;project_ids_with_curator_id&quot;</span> } }
<span class="line-num"> 776</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pcid</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 777</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> {
<span class="line-num"> 778</span>         <span class="ruby-value">field:</span> <span class="ruby-string">&quot;project_ids_without_curator_id&quot;</span> } }
<span class="line-num"> 779</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 780</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 781</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:not_in_project</span>]
<span class="line-num"> 782</span>     <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;project_ids.keyword&quot;:</span>
<span class="line-num"> 783</span>       <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:not_in_project</span>]) } }
<span class="line-num"> 784</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 785</span> 
<span class="line-num"> 786</span>   <span class="ruby-identifier">extra_preloads</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">identifications:</span> [<span class="ruby-value">:user</span>, <span class="ruby-value">:taxon</span>] } <span class="ruby-keyword">if</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;identifications&quot;</span>)
<span class="line-num"> 787</span>   <span class="ruby-identifier">extra_preloads</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">observation_photos:</span> <span class="ruby-value">:photo</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;observation_photos&quot;</span>)
<span class="line-num"> 788</span>   <span class="ruby-identifier">extra_preloads</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">observation_field_values:</span> <span class="ruby-value">:observation_field</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;fields&quot;</span>)
<span class="line-num"> 789</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:hrank</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:lrank</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 790</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;taxon.rank_level&quot;</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num"> 791</span>       <span class="ruby-value">gte:</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-identifier">p</span>[<span class="ruby-value">:lrank</span>]] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>,
<span class="line-num"> 792</span>       <span class="ruby-value">lte:</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-identifier">p</span>[<span class="ruby-value">:hrank</span>]] <span class="ruby-operator">||</span> <span class="ruby-value">100</span> } } }
<span class="line-num"> 793</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 794</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:quality_grade</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:quality_grade</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num"> 795</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">quality_grade:</span>
<span class="line-num"> 796</span>       <span class="ruby-identifier">p</span>[<span class="ruby-value">:quality_grade</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">QUALITY_GRADES</span> } }
<span class="line-num"> 797</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 798</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:identifications</span>]
<span class="line-num"> 799</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;most_agree&quot;</span>
<span class="line-num"> 800</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">identifications_most_agree:</span> <span class="ruby-keyword">true</span> } }
<span class="line-num"> 801</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;some_agree&quot;</span>
<span class="line-num"> 802</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">identifications_some_agree:</span> <span class="ruby-keyword">true</span> } }
<span class="line-num"> 803</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;most_disagree&quot;</span>
<span class="line-num"> 804</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">identifications_most_disagree:</span> <span class="ruby-keyword">true</span> } }
<span class="line-num"> 805</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 806</span> 
<span class="line-num"> 807</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:nelat</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:nelng</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:swlat</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:swlng</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 808</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">envelope:</span> { <span class="ruby-value">geojson:</span> {
<span class="line-num"> 809</span>       <span class="ruby-value">nelat:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:nelat</span>], <span class="ruby-value">nelng:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:nelng</span>], <span class="ruby-value">swlat:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:swlat</span>], <span class="ruby-value">swlng:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:swlng</span>],
<span class="line-num"> 810</span>       <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> } } }
<span class="line-num"> 811</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 812</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:lat</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:lng</span>]
<span class="line-num"> 813</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">geo_distance:</span> {
<span class="line-num"> 814</span>       <span class="ruby-value">distance:</span> <span class="ruby-node">&quot;#{p[:radius] || 10}km&quot;</span>,
<span class="line-num"> 815</span>       <span class="ruby-value">location:</span> {
<span class="line-num"> 816</span>         <span class="ruby-value">lat:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:lat</span>], <span class="ruby-value">lon:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:lng</span>] } } }
<span class="line-num"> 817</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 818</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:iconic_taxa_instances</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:iconic_taxa_instances</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num"> 819</span>     <span class="ruby-comment"># iconic_taxa will be an array which might contain a nil value</span>
<span class="line-num"> 820</span>     <span class="ruby-identifier">known_taxa</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:iconic_taxa_instances</span>].<span class="ruby-identifier">compact</span>
<span class="line-num"> 821</span>     <span class="ruby-comment"># if it is smaller after compact, then it contained nil and</span>
<span class="line-num"> 822</span>     <span class="ruby-comment"># we will need to do a different kind of Elasticsearch query</span>
<span class="line-num"> 823</span>     <span class="ruby-identifier">allows_unknown</span> = (<span class="ruby-identifier">known_taxa</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:iconic_taxa_instances</span>].<span class="ruby-identifier">size</span>)
<span class="line-num"> 824</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">allows_unknown</span>
<span class="line-num"> 825</span>       <span class="ruby-comment"># to allow iconic_taxon_id to be nil, I think the best way</span>
<span class="line-num"> 826</span>       <span class="ruby-comment"># is a &quot;should&quot; boolean filter, which allows anyof a set of</span>
<span class="line-num"> 827</span>       <span class="ruby-comment"># valid terms as well as missing terms (null)</span>
<span class="line-num"> 828</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">should:</span> [
<span class="line-num"> 829</span>         { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;taxon.iconic_taxon_id&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">known_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) } },
<span class="line-num"> 830</span>         { <span class="ruby-value">bool:</span> { <span class="ruby-value">must_not:</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;taxon.iconic_taxon_id&quot;</span> } } } }
<span class="line-num"> 831</span>       ]}}
<span class="line-num"> 832</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 833</span>       <span class="ruby-comment"># if we don&#39;t want to include null values, a terms filter is simpler</span>
<span class="line-num"> 834</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;taxon.iconic_taxon_id&quot;</span> <span class="ruby-operator">=&gt;</span>
<span class="line-num"> 835</span>         <span class="ruby-identifier">p</span>[<span class="ruby-value">:iconic_taxa_instances</span>].<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">id_or_object</span>(<span class="ruby-identifier">t</span>) } } }
<span class="line-num"> 836</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 837</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 838</span> 
<span class="line-num"> 839</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>
<span class="line-num"> 840</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:reviewed</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num"> 841</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">reviewed_by:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> } }
<span class="line-num"> 842</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:reviewed</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num"> 843</span>       <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">reviewed_by:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> } }
<span class="line-num"> 844</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 845</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 846</span> 
<span class="line-num"> 847</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>]
<span class="line-num"> 848</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>].<span class="ruby-identifier">to_s</span>
<span class="line-num"> 849</span>     <span class="ruby-identifier">d1</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-string">&quot;1800-01-01&quot;</span>)
<span class="line-num"> 850</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>].<span class="ruby-identifier">to_s</span>
<span class="line-num"> 851</span>     <span class="ruby-identifier">d2</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num"> 852</span>     <span class="ruby-comment"># d2 = Time.now if d2 &amp;&amp; d2 &gt; Time.now # not sure why we need to prevent queries into the future</span>
<span class="line-num"> 853</span>     <span class="ruby-identifier">query_by_date</span> = (
<span class="line-num"> 854</span>       (<span class="ruby-operator">!</span><span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/00:00:00/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:d1</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/00:00:00/</span>) <span class="ruby-operator">||</span>
<span class="line-num"> 855</span>       (<span class="ruby-operator">!</span><span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/00:00:00/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:d2</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/00:00:00/</span>))
<span class="line-num"> 856</span>     <span class="ruby-identifier">date_filter</span> = { <span class="ruby-value">&quot;observed_on_details.date&quot;:</span> {
<span class="line-num"> 857</span>       <span class="ruby-value">gte:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%F&quot;</span>),
<span class="line-num"> 858</span>       <span class="ruby-value">lte:</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%F&quot;</span>) }}
<span class="line-num"> 859</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_by_date</span>
<span class="line-num"> 860</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> <span class="ruby-identifier">date_filter</span> }
<span class="line-num"> 861</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 862</span>       <span class="ruby-identifier">time_filter</span> = { <span class="ruby-value">time_observed_at:</span> {
<span class="line-num"> 863</span>         <span class="ruby-value">gte:</span> <span class="ruby-identifier">d1</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%FT%T%:z&quot;</span>),
<span class="line-num"> 864</span>         <span class="ruby-value">lte:</span> <span class="ruby-identifier">d2</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%FT%T%:z&quot;</span>) } }
<span class="line-num"> 865</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">should:</span> [
<span class="line-num"> 866</span>         { <span class="ruby-value">bool:</span> { <span class="ruby-value">must:</span> [ { <span class="ruby-value">range:</span> <span class="ruby-identifier">time_filter</span> }, { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;time_observed_at&quot;</span> } } ] } },
<span class="line-num"> 867</span>         { <span class="ruby-value">bool:</span> {
<span class="line-num"> 868</span>           <span class="ruby-value">must:</span> { <span class="ruby-value">range:</span> <span class="ruby-identifier">date_filter</span> },
<span class="line-num"> 869</span>           <span class="ruby-value">must_not:</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;time_observed_at&quot;</span> } } } }
<span class="line-num"> 870</span>       ] } }
<span class="line-num"> 871</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 872</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 873</span> 
<span class="line-num"> 874</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d2</span>]
<span class="line-num"> 875</span>     <span class="ruby-identifier">created_d1</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d1</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-string">&quot;1800-01-01&quot;</span>)
<span class="line-num"> 876</span>     <span class="ruby-identifier">created_d2</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d2</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num"> 877</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d2</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">created_d2</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/00:00:00/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:created_d2</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/00:00:00/</span>
<span class="line-num"> 878</span>       <span class="ruby-comment"># if you provide a date like 2018-02-01, the DateTime will be Thu, 01</span>
<span class="line-num"> 879</span>       <span class="ruby-comment"># Feb 2018 00:00:00 +0000, so to perform an inclusive search you want</span>
<span class="line-num"> 880</span>       <span class="ruby-comment"># another day</span>
<span class="line-num"> 881</span>       <span class="ruby-identifier">created_d2</span> = <span class="ruby-identifier">created_d2</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>
<span class="line-num"> 882</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 883</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num"> 884</span>       <span class="ruby-value">range:</span> {
<span class="line-num"> 885</span>         <span class="ruby-value">&quot;created_at&quot;:</span> {
<span class="line-num"> 886</span>           <span class="ruby-value">gte:</span> <span class="ruby-identifier">created_d1</span>.<span class="ruby-identifier">strftime</span>( <span class="ruby-string">&quot;%FT%T%:z&quot;</span> ),
<span class="line-num"> 887</span>           <span class="ruby-value">lte:</span> <span class="ruby-identifier">created_d2</span>.<span class="ruby-identifier">strftime</span>( <span class="ruby-string">&quot;%FT%T%:z&quot;</span> )
<span class="line-num"> 888</span>         }
<span class="line-num"> 889</span>       }
<span class="line-num"> 890</span>     }
<span class="line-num"> 891</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 892</span> 
<span class="line-num"> 893</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>]
<span class="line-num"> 894</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-value">24</span>
<span class="line-num"> 895</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-value">24</span>
<span class="line-num"> 896</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>]
<span class="line-num"> 897</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">should:</span> [
<span class="line-num"> 898</span>         { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.hour&quot;</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>] } } },
<span class="line-num"> 899</span>         { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.hour&quot;</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">lte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>] } } }
<span class="line-num"> 900</span>       ] } }
<span class="line-num"> 901</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 902</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.hour&quot;</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num"> 903</span>         <span class="ruby-value">gte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h1</span>], <span class="ruby-value">lte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:h2</span>] } } }
<span class="line-num"> 904</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 905</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 906</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>]
<span class="line-num"> 907</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-value">12</span>
<span class="line-num"> 908</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-value">12</span>
<span class="line-num"> 909</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>]
<span class="line-num"> 910</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">should:</span> [
<span class="line-num"> 911</span>         { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.month&quot;</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>] } } },
<span class="line-num"> 912</span>         { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.month&quot;</span> <span class="ruby-operator">=&gt;</span> { <span class="ruby-value">lte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>] } } }
<span class="line-num"> 913</span>       ] } }
<span class="line-num"> 914</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 915</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-string">&quot;observed_on_details.month&quot;</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num"> 916</span>         <span class="ruby-value">gte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m1</span>], <span class="ruby-value">lte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:m2</span>] } } }
<span class="line-num"> 917</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 918</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 919</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:updated_since</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 920</span>     <span class="ruby-comment"># This inanity brought to by the fact that all +&#39;s in URLs get interpreted</span>
<span class="line-num"> 921</span>     <span class="ruby-comment"># as spaces, so if you want a plus, we either have to handle it like this</span>
<span class="line-num"> 922</span>     <span class="ruby-comment"># or you use %2B</span>
<span class="line-num"> 923</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:updated_since</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">String</span> )
<span class="line-num"> 924</span>       <span class="ruby-identifier">p</span>[<span class="ruby-value">:updated_since</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:updated_since</span>].<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/\s(\d+\:\d+)$/</span>, <span class="ruby-string">&quot;+\\1&quot;</span> )
<span class="line-num"> 925</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 926</span>     <span class="ruby-identifier">timestamp</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">p</span>[<span class="ruby-value">:updated_since</span>])
<span class="line-num"> 927</span>     <span class="ruby-comment"># there is an expectation in a spec that when updated_since is</span>
<span class="line-num"> 928</span>     <span class="ruby-comment"># invalid, the search will fail to return any results</span>
<span class="line-num"> 929</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">timestamp</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 930</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:aggregation_user_ids</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 931</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">updated_at:</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">timestamp</span> } } }
<span class="line-num"> 932</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 933</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">should:</span> [
<span class="line-num"> 934</span>         { <span class="ruby-value">range:</span> { <span class="ruby-value">updated_at:</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">timestamp</span> } } },
<span class="line-num"> 935</span>         { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;user.id.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:aggregation_user_ids</span>] } }
<span class="line-num"> 936</span>       ] } }
<span class="line-num"> 937</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 938</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 939</span> 
<span class="line-num"> 940</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:term_id</span>]
<span class="line-num"> 941</span>     <span class="ruby-identifier">nested_query</span> = {
<span class="line-num"> 942</span>       <span class="ruby-value">nested:</span> {
<span class="line-num"> 943</span>         <span class="ruby-value">path:</span> <span class="ruby-string">&quot;annotations&quot;</span>,
<span class="line-num"> 944</span>         <span class="ruby-value">query:</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">must:</span> [
<span class="line-num"> 945</span>           { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;annotations.controlled_attribute_id.keyword&quot;:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:term_id</span>] } },
<span class="line-num"> 946</span>           { <span class="ruby-value">range:</span> { <span class="ruby-value">&quot;annotations.vote_score&quot;:</span> { <span class="ruby-value">gte:</span> <span class="ruby-value">0</span> } } }
<span class="line-num"> 947</span>         ] }
<span class="line-num"> 948</span>         }
<span class="line-num"> 949</span>       }
<span class="line-num"> 950</span>     }
<span class="line-num"> 951</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:term_value_id</span>]
<span class="line-num"> 952</span>       <span class="ruby-identifier">nested_query</span>[<span class="ruby-value">:nested</span>][<span class="ruby-value">:query</span>][<span class="ruby-value">:bool</span>][<span class="ruby-value">:must</span>] <span class="ruby-operator">&lt;&lt;</span>
<span class="line-num"> 953</span>         { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;annotations.controlled_value_id.keyword&quot;:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:term_value_id</span>] } }
<span class="line-num"> 954</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 955</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">nested_query</span>
<span class="line-num"> 956</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 957</span> 
<span class="line-num"> 958</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:ofv_params</span>]
<span class="line-num"> 959</span>     <span class="ruby-identifier">p</span>[<span class="ruby-value">:ofv_params</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num"> 960</span>       <span class="ruby-comment"># use a nested query to search within a single nested</span>
<span class="line-num"> 961</span>       <span class="ruby-comment"># object and not across all nested objects</span>
<span class="line-num"> 962</span>       <span class="ruby-identifier">nested_query</span> = {
<span class="line-num"> 963</span>         <span class="ruby-value">nested:</span> {
<span class="line-num"> 964</span>           <span class="ruby-value">path:</span> <span class="ruby-string">&quot;ofvs&quot;</span>,
<span class="line-num"> 965</span>           <span class="ruby-value">query:</span> { <span class="ruby-value">bool:</span> { <span class="ruby-value">must:</span> [ { <span class="ruby-value">match:</span> {
<span class="line-num"> 966</span>             <span class="ruby-string">&quot;ofvs.name_ci&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">v</span>[<span class="ruby-value">:observation_field</span>].<span class="ruby-identifier">name</span> } } ] }
<span class="line-num"> 967</span>           }
<span class="line-num"> 968</span>         }
<span class="line-num"> 969</span>       }
<span class="line-num"> 970</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-value">:value</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num"> 971</span>         <span class="ruby-identifier">nested_query</span>[<span class="ruby-value">:nested</span>][<span class="ruby-value">:query</span>][<span class="ruby-value">:bool</span>][<span class="ruby-value">:must</span>] <span class="ruby-operator">&lt;&lt;</span>
<span class="line-num"> 972</span>           { <span class="ruby-value">match:</span> { <span class="ruby-string">&quot;ofvs.value_ci&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">v</span>[<span class="ruby-value">:value</span>] } }
<span class="line-num"> 973</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 974</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">nested_query</span>
<span class="line-num"> 975</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 976</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 977</span> 
<span class="line-num"> 978</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:ofv_datatype</span>]
<span class="line-num"> 979</span>     <span class="ruby-identifier">vals</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:ofv_datatype</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> )
<span class="line-num"> 980</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num"> 981</span>       <span class="ruby-value">nested:</span> {
<span class="line-num"> 982</span>         <span class="ruby-value">path:</span> <span class="ruby-string">&quot;ofvs&quot;</span>,
<span class="line-num"> 983</span>         <span class="ruby-value">query:</span> {
<span class="line-num"> 984</span>           <span class="ruby-value">bool:</span> {
<span class="line-num"> 985</span>             <span class="ruby-value">filter:</span> [
<span class="line-num"> 986</span>               {
<span class="line-num"> 987</span>                 <span class="ruby-value">terms:</span> {
<span class="line-num"> 988</span>                   <span class="ruby-string">&quot;ofvs.datatype&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vals</span>
<span class="line-num"> 989</span>                 }
<span class="line-num"> 990</span>               }
<span class="line-num"> 991</span>             ]
<span class="line-num"> 992</span>           }
<span class="line-num"> 993</span>         }
<span class="line-num"> 994</span>       }
<span class="line-num"> 995</span>     }
<span class="line-num"> 996</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 997</span> 
<span class="line-num"> 998</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:ident_user_id</span>]
<span class="line-num"> 999</span>     <span class="ruby-identifier">vals</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:ident_user_id</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> )
<span class="line-num">1000</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;identifier_user_ids.keyword&quot;:</span> <span class="ruby-identifier">vals</span> } }
<span class="line-num">1001</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1002</span> 
<span class="line-num">1003</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:ident_taxon_id</span>]
<span class="line-num">1004</span>     <span class="ruby-identifier">vals</span> = <span class="ruby-identifier">p</span>[<span class="ruby-value">:ident_taxon_id</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> )
<span class="line-num">1005</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;ident_taxon_ids.keyword&quot;:</span> <span class="ruby-identifier">vals</span> } }
<span class="line-num">1006</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1007</span> 
<span class="line-num">1008</span>   <span class="ruby-comment"># conservation status</span>
<span class="line-num">1009</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:cs</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1010</span>     <span class="ruby-identifier">values</span> = [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:cs</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span>)
<span class="line-num">1011</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conservation_condition</span>(<span class="ruby-value">:status</span>, <span class="ruby-identifier">values</span>, <span class="ruby-identifier">p</span>)
<span class="line-num">1012</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1013</span>   <span class="ruby-comment"># IUCN conservation status</span>
<span class="line-num">1014</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:csi</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1015</span>     <span class="ruby-identifier">iucn_equivs</span> = [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:csi</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">1016</span>       <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">IUCN_CODE_VALUES</span>[<span class="ruby-identifier">v</span>.<span class="ruby-identifier">upcase</span>] }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1017</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">iucn_equivs</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1018</span>       <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conservation_condition</span>(<span class="ruby-value">:iucn</span>, <span class="ruby-identifier">iucn_equivs</span>, <span class="ruby-identifier">p</span>)
<span class="line-num">1019</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1020</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1021</span>   <span class="ruby-comment"># conservation status authority</span>
<span class="line-num">1022</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:csa</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1023</span>     <span class="ruby-identifier">values</span> = [ <span class="ruby-identifier">p</span>[<span class="ruby-value">:csa</span>] ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span>)
<span class="line-num">1024</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conservation_condition</span>(<span class="ruby-value">:authority</span>, <span class="ruby-identifier">values</span>, <span class="ruby-identifier">p</span>)
<span class="line-num">1025</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1026</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_above</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1027</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">positional_accuracy:</span> { <span class="ruby-value">gt:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_above</span>].<span class="ruby-identifier">to_i</span> } } }
<span class="line-num">1028</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1029</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_below</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1030</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">positional_accuracy:</span> { <span class="ruby-value">lt:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_below</span>].<span class="ruby-identifier">to_i</span> } } }
<span class="line-num">1031</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1032</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_below_or_unknown</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1033</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">1034</span>       <span class="ruby-value">bool:</span> {
<span class="line-num">1035</span>         <span class="ruby-value">should:</span> [
<span class="line-num">1036</span>           {
<span class="line-num">1037</span>             <span class="ruby-value">range:</span> {
<span class="line-num">1038</span>               <span class="ruby-value">positional_accuracy:</span> {
<span class="line-num">1039</span>                 <span class="ruby-value">lt:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:acc_below_or_unknown</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">1040</span>               }
<span class="line-num">1041</span>             }
<span class="line-num">1042</span>           },
<span class="line-num">1043</span>           {
<span class="line-num">1044</span>             <span class="ruby-value">bool:</span> {
<span class="line-num">1045</span>               <span class="ruby-value">must_not:</span> [
<span class="line-num">1046</span>                 {
<span class="line-num">1047</span>                   <span class="ruby-value">exists:</span> {
<span class="line-num">1048</span>                     <span class="ruby-value">field:</span> <span class="ruby-string">&quot;positional_accuracy&quot;</span>
<span class="line-num">1049</span>                   }
<span class="line-num">1050</span>                 }
<span class="line-num">1051</span>               ]
<span class="line-num">1052</span>             }
<span class="line-num">1053</span>           }
<span class="line-num">1054</span>         ]
<span class="line-num">1055</span>       }
<span class="line-num">1056</span>     }
<span class="line-num">1057</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1058</span>   <span class="ruby-comment"># sort defaults to created at descending</span>
<span class="line-num">1059</span>   <span class="ruby-identifier">sort_order</span> = (<span class="ruby-identifier">p</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;desc&quot;</span>).<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">to_sym</span>
<span class="line-num">1060</span>   <span class="ruby-identifier">sort</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:order_by</span>]
<span class="line-num">1061</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;observed_on&quot;</span>
<span class="line-num">1062</span>     { <span class="ruby-value">observed_on:</span> <span class="ruby-identifier">sort_order</span>, <span class="ruby-value">time_observed_at:</span> <span class="ruby-identifier">sort_order</span> }
<span class="line-num">1063</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;species_guess&quot;</span>
<span class="line-num">1064</span>     { <span class="ruby-value">species_guess:</span> <span class="ruby-identifier">sort_order</span> }
<span class="line-num">1065</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;votes&quot;</span>
<span class="line-num">1066</span>     { <span class="ruby-value">cached_votes_total:</span> <span class="ruby-identifier">sort_order</span> }
<span class="line-num">1067</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;observations.id&quot;</span>
<span class="line-num">1068</span>     { <span class="ruby-value">id:</span> <span class="ruby-identifier">sort_order</span> }
<span class="line-num">1069</span>   <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;random&quot;</span>
<span class="line-num">1070</span>     <span class="ruby-string">&quot;random&quot;</span>
<span class="line-num">1071</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1072</span>     { <span class="ruby-value">created_at:</span> <span class="ruby-identifier">sort_order</span> }
<span class="line-num">1073</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1074</span> 
<span class="line-num">1075</span>   [<span class="ruby-value">:geoprivacy</span>, <span class="ruby-value">:taxon_geoprivacy</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">geoprivacy_type</span><span class="ruby-operator">|</span>
<span class="line-num">1076</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>[<span class="ruby-identifier">geoprivacy_type</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>[<span class="ruby-identifier">geoprivacy_type</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;any&quot;</span>
<span class="line-num">1077</span>       <span class="ruby-keyword">case</span> <span class="ruby-identifier">p</span>[<span class="ruby-identifier">geoprivacy_type</span>]
<span class="line-num">1078</span>       <span class="ruby-keyword">when</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1079</span>         <span class="ruby-identifier">inverse_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-identifier">geoprivacy_type</span> } }
<span class="line-num">1080</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;obscured_private&quot;</span>
<span class="line-num">1081</span>         <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-identifier">geoprivacy_type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">GEOPRIVACIES</span> } }
<span class="line-num">1082</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1083</span>         <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-identifier">geoprivacy_type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">p</span>[<span class="ruby-identifier">geoprivacy_type</span>] } }
<span class="line-num">1084</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1085</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1086</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1087</span> 
<span class="line-num">1088</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:popular</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">1089</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">cached_votes_total:</span> { <span class="ruby-value">gte:</span> <span class="ruby-value">1</span> } } }
<span class="line-num">1090</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:popular</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num">1091</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">cached_votes_total:</span> <span class="ruby-value">0</span> } }
<span class="line-num">1092</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1093</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:min_id</span>]
<span class="line-num">1094</span>     <span class="ruby-identifier">id_filter</span> = { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">gte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:min_id</span>] } } }
<span class="line-num">1095</span>     <span class="ruby-identifier">id_filter</span>[<span class="ruby-value">:range</span>][<span class="ruby-value">:id</span>][<span class="ruby-value">:lte</span>] = <span class="ruby-identifier">p</span>[<span class="ruby-value">:max_id</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:max_id</span>]
<span class="line-num">1096</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">id_filter</span>
<span class="line-num">1097</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:max_id</span>]
<span class="line-num">1098</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">lte:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:max_id</span>] } } }
<span class="line-num">1099</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1100</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:id_above</span>]
<span class="line-num">1101</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">gt:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:id_above</span>] } } }
<span class="line-num">1102</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1103</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:id_below</span>]
<span class="line-num">1104</span>     <span class="ruby-identifier">search_filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">lt:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:id_below</span>] } } }
<span class="line-num">1105</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1106</span> 
<span class="line-num">1107</span>   { <span class="ruby-value">filters:</span> <span class="ruby-identifier">search_filters</span>,
<span class="line-num">1108</span>     <span class="ruby-value">inverse_filters:</span> <span class="ruby-identifier">inverse_filters</span>,
<span class="line-num">1109</span>     <span class="ruby-value">per_page:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:per_page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">30</span>,
<span class="line-num">1110</span>     <span class="ruby-value">page:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:page</span>],
<span class="line-num">1111</span>     <span class="ruby-value">sort:</span> <span class="ruby-identifier">sort</span>,
<span class="line-num">1112</span>     <span class="ruby-value">extra_preloads:</span> <span class="ruby-identifier">extra_preloads</span>,
<span class="line-num">1113</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">p</span>[<span class="ruby-value">:track_total_hits</span>] }
<span class="line-num">1114</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-place_guess_from_latlon">
            
              <b>place_guess_from_latlon</b>( lat, lon, options = {} )
            
            <a href="../classes/Observation.html#method-c-place_guess_from_latlon" name="method-c-place_guess_from_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-place_guess_from_latlon_source')" id="l_method-c-place_guess_from_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-c-place_guess_from_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2158</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">place_guess_from_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2159</span>   <span class="ruby-identifier">sys_places</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">system_places_for_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">2160</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sys_places</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2161</span>   <span class="ruby-identifier">sys_places_codes</span> = <span class="ruby-identifier">sys_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:code</span>)
<span class="line-num">2162</span>   <span class="ruby-identifier">user</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">2163</span>   <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>]
<span class="line-num">2164</span>   <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
<span class="line-num">2165</span>   <span class="ruby-identifier">locale</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">2166</span>   <span class="ruby-identifier">first_name</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">sys_places</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">admin_level</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sys_places_codes</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;US&quot;</span> )
<span class="line-num">2167</span>     <span class="ruby-node">&quot;#{sys_places[0].name} County&quot;</span>
<span class="line-num">2168</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2169</span>     <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-identifier">sys_places</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">default:</span> <span class="ruby-identifier">sys_places</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span> )
<span class="line-num">2170</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2171</span>   <span class="ruby-identifier">remaining_names</span> = <span class="ruby-identifier">sys_places</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">2172</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sys_places_codes</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;US&quot;</span> )
<span class="line-num">2173</span>       <span class="ruby-node">&quot;#{p.name} County&quot;</span>
<span class="line-num">2174</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2175</span>       <span class="ruby-identifier">translated_place</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">translated_name</span>( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">2176</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">translated_place</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">code</span>
<span class="line-num">2177</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2178</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2179</span>   [<span class="ruby-identifier">first_name</span>, <span class="ruby-identifier">remaining_names</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;, &quot;</span> )
<span class="line-num">2180</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-places_for_latlon">
            
              <b>places_for_latlon</b>( lat, lon, acc, options = {} )
            
            <a href="../classes/Observation.html#method-c-places_for_latlon" name="method-c-places_for_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-places_for_latlon_source')" id="l_method-c-places_for_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-c-places_for_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2584</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">places_for_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">acc</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2585</span>   <span class="ruby-identifier">candidates</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:candidates</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Place</span>.<span class="ruby-identifier">containing_lat_lng</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2586</span>   <span class="ruby-identifier">candidates</span> = <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_area</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>}
<span class="line-num">2587</span> 
<span class="line-num">2588</span>   <span class="ruby-comment"># At present we use PostGIS GEOMETRY types, which are a bit stupid about</span>
<span class="line-num">2589</span>   <span class="ruby-comment"># things crossing the dateline, so we need to do an app-layer check.</span>
<span class="line-num">2590</span>   <span class="ruby-comment"># Converting to the GEOGRAPHY type would solve this, in theory.</span>
<span class="line-num">2591</span>   <span class="ruby-comment"># Unfortunately this does NOT solve the problem of failing to select</span>
<span class="line-num">2592</span>   <span class="ruby-comment"># legit geoms that cross the dateline. GEOGRAPHY would solve that too.</span>
<span class="line-num">2593</span>   <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> 
<span class="line-num">2594</span>     <span class="ruby-comment"># HACK: bbox_contains_lat_lng_acc uses rgeo, which despite having a</span>
<span class="line-num">2595</span>     <span class="ruby-comment"># spherical geometry factory, doesn&#39;t seem to allow spherical polygons</span>
<span class="line-num">2596</span>     <span class="ruby-comment"># to use a contains? method, which means it doesn&#39;t really work for</span>
<span class="line-num">2597</span>     <span class="ruby-comment"># polygons that cross the dateline, so... skip it until we switch to</span>
<span class="line-num">2598</span>     <span class="ruby-comment"># geography, I guess.</span>
<span class="line-num">2599</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">straddles_date_line?</span>
<span class="line-num">2600</span>       <span class="ruby-keyword">true</span>
<span class="line-num">2601</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2602</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_contains_lat_lng_acc?</span>(<span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">acc</span>)
<span class="line-num">2603</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2604</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2605</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-places_without_obscuration_protection">
            
              <b>places_without_obscuration_protection</b>()
            
            <a href="../classes/Observation.html#method-c-places_without_obscuration_protection" name="method-c-places_without_obscuration_protection" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-places_without_obscuration_protection_source')" id="l_method-c-places_without_obscuration_protection_source">show</a>
                

                

                
              </p>
              <div id="method-c-places_without_obscuration_protection_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2607</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">places_without_obscuration_protection</span>
<span class="line-num">2608</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span>
<span class="line-num">2609</span>   <span class="ruby-identifier">@@places_without_obscuration_protection</span> <span class="ruby-operator">||=</span>
<span class="line-num">2610</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">fetch</span>( <span class="ruby-string">&quot;places_without_obscuration_protection&quot;</span>, <span class="ruby-value">expires_in:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">2611</span>     [
<span class="line-num">2612</span>       <span class="ruby-value">19126</span>, <span class="ruby-comment"># City Nature Challenge 2018</span>
<span class="line-num">2613</span>       <span class="ruby-value">29625</span>, <span class="ruby-comment"># City Nature Challenge 2019</span>
<span class="line-num">2614</span>       <span class="ruby-value">40364</span>  <span class="ruby-comment"># City Nature Challenge 2020</span>
<span class="line-num">2615</span>     ].<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">umbrella_project_id</span><span class="ruby-operator">|</span>
<span class="line-num">2616</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">umbrella</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">includes</span>( {
<span class="line-num">2617</span>         <span class="ruby-value">project_observation_rules:</span> {
<span class="line-num">2618</span>           <span class="ruby-value">operand:</span> <span class="ruby-value">:project_observation_rules</span>
<span class="line-num">2619</span>         }
<span class="line-num">2620</span>       } ).<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">umbrella_project_id</span> )
<span class="line-num">2621</span>         <span class="ruby-identifier">umbrella</span>.<span class="ruby-identifier">project_observation_rules</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">por</span><span class="ruby-operator">|</span> <span class="ruby-identifier">por</span>.<span class="ruby-identifier">operator</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;in_project?&quot;</span>}.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">por</span><span class="ruby-operator">|</span>
<span class="line-num">2622</span>           <span class="ruby-identifier">por</span>.<span class="ruby-identifier">operand</span>.<span class="ruby-identifier">project_observation_rules</span>.
<span class="line-num">2623</span>             <span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">sub_por</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sub_por</span>.<span class="ruby-identifier">operator</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;observed_in_place?&quot;</span> }.
<span class="line-num">2624</span>             <span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sub_por</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sub_por</span>.<span class="ruby-identifier">operand_id</span> }
<span class="line-num">2625</span>         }
<span class="line-num">2626</span>       <span class="ruby-keyword">else</span>
<span class="line-num">2627</span>         <span class="ruby-keyword">nil</span>
<span class="line-num">2628</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2629</span>     }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2630</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2631</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-preload_for_component">
            
              <b>preload_for_component</b>(observations, logged_in)
            
            <a href="../classes/Observation.html#method-c-preload_for_component" name="method-c-preload_for_component" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-preload_for_component_source')" id="l_method-c-preload_for_component_source">show</a>
                

                

                
              </p>
              <div id="method-c-preload_for_component_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">755</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">preload_for_component</span>(<span class="ruby-identifier">observations</span>, <span class="ruby-identifier">logged_in</span>)
<span class="line-num">756</span>   <span class="ruby-identifier">preloads</span> = [
<span class="line-num">757</span>     { <span class="ruby-value">user:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num">758</span>     { <span class="ruby-value">taxon:</span> { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> } },
<span class="line-num">759</span>     <span class="ruby-value">:iconic_taxon</span>,
<span class="line-num">760</span>     { <span class="ruby-value">identifications:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num">761</span>     { <span class="ruby-value">photos:</span> [ <span class="ruby-value">:flags</span>, <span class="ruby-value">:user</span>, <span class="ruby-value">:file_extension</span>, <span class="ruby-value">:file_prefix</span> ] },
<span class="line-num">762</span>     <span class="ruby-value">:stored_preferences</span>, <span class="ruby-value">:flags</span>, <span class="ruby-value">:quality_metrics</span>,
<span class="line-num">763</span>     <span class="ruby-value">:votes_for</span> ]
<span class="line-num">764</span>   <span class="ruby-comment"># why do we need taxon_descriptions when logged in?</span>
<span class="line-num">765</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in</span>
<span class="line-num">766</span>     <span class="ruby-identifier">preloads</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:iconic_taxon</span>)
<span class="line-num">767</span>     <span class="ruby-identifier">preloads</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">iconic_taxon:</span> <span class="ruby-value">:taxon_descriptions</span> }
<span class="line-num">768</span>     <span class="ruby-identifier">preloads</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:project_observations</span>
<span class="line-num">769</span>   <span class="ruby-keyword">end</span>
<span class="line-num">770</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">observations</span>, <span class="ruby-identifier">preloads</span>)
<span class="line-num">771</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-prepare_batch_for_index">
            
              <b>prepare_batch_for_index</b>(observations, options = {})
            
            <a href="../classes/Observation.html#method-c-prepare_batch_for_index" name="method-c-prepare_batch_for_index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>to quickly fetch observation place_ids when bulk indexing</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-prepare_batch_for_index_source')" id="l_method-c-prepare_batch_for_index_source">show</a>
                

                

                
              </p>
              <div id="method-c-prepare_batch_for_index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/observation_index.rb</span>
<span class="line-num">430</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">prepare_batch_for_index</span>(<span class="ruby-identifier">observations</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">431</span>   <span class="ruby-comment"># make sure we default all caches to empty arrays</span>
<span class="line-num">432</span>   <span class="ruby-comment"># this prevents future lookups for instances with no results</span>
<span class="line-num">433</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">434</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">||=</span> [ ]
<span class="line-num">435</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span> <span class="ruby-operator">||=</span> [ ]
<span class="line-num">436</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span> <span class="ruby-operator">||=</span> [ ]
<span class="line-num">437</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_introduced</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">438</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_native</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">439</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_endemic</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">440</span>   }
<span class="line-num">441</span>   <span class="ruby-identifier">batch_ids_string</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num">442</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">batch_ids_string</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">443</span>   <span class="ruby-comment"># fetch all place_ids store them in `indexed_place_ids`</span>
<span class="line-num">444</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:places</span>]
<span class="line-num">445</span>     <span class="ruby-identifier">observation_private_place_ids</span> = { }
<span class="line-num">446</span>     <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;
<span class="line-num">447</span>       SELECT observation_id, place_id
<span class="line-num">448</span>       FROM observations_places
<span class="line-num">449</span>       WHERE observation_id IN (#{ batch_ids_string })&quot;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
<span class="line-num">450</span>       <span class="ruby-identifier">observation_private_place_ids</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;observation_id&quot;</span>]] <span class="ruby-operator">||=</span> []
<span class="line-num">451</span>       <span class="ruby-identifier">observation_private_place_ids</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;observation_id&quot;</span>]] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;place_id&quot;</span>]
<span class="line-num">452</span>     <span class="ruby-keyword">end</span>
<span class="line-num">453</span>     <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">454</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation_private_place_ids</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>]
<span class="line-num">455</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span> = <span class="ruby-identifier">observation_private_place_ids</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>]
<span class="line-num">456</span>       <span class="ruby-keyword">end</span>
<span class="line-num">457</span>     <span class="ruby-keyword">end</span>
<span class="line-num">458</span>     <span class="ruby-identifier">private_place_ids</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:indexed_private_place_ids</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">459</span>     <span class="ruby-identifier">private_places_by_id</span> = <span class="ruby-constant">Hash</span>[ <span class="ruby-constant">Place</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">private_place_ids</span>).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">p</span> ] } ]
<span class="line-num">460</span>     <span class="ruby-identifier">always_indexed_place_levels</span> = [
<span class="line-num">461</span>       <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>,
<span class="line-num">462</span>       <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>,
<span class="line-num">463</span>       <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>
<span class="line-num">464</span>     ]
<span class="line-num">465</span>     <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">466</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">467</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span> = <span class="ruby-identifier">private_places_by_id</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">468</span>           <span class="ruby-identifier">always_indexed_place_levels</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> ) <span class="ruby-operator">||</span>
<span class="line-num">469</span>           <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">places_without_obscuration_protection</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> ) <span class="ruby-operator">||</span>
<span class="line-num">470</span>           <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_privately_contains_observation?</span>( <span class="ruby-identifier">o</span> )
<span class="line-num">471</span>         <span class="ruby-keyword">end</span>
<span class="line-num">472</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">473</span>         <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">geoprivacy</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_geoprivacy</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span>
<span class="line-num">474</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_place_ids</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">475</span>             <span class="ruby-identifier">always_indexed_place_levels</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> ) <span class="ruby-operator">||</span>
<span class="line-num">476</span>             <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">places_without_obscuration_protection</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> ) <span class="ruby-operator">||</span>
<span class="line-num">477</span>             <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_publicly_contains_observation?</span>( <span class="ruby-identifier">o</span> )
<span class="line-num">478</span>           }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">479</span>         <span class="ruby-keyword">end</span>
<span class="line-num">480</span>       <span class="ruby-keyword">end</span>
<span class="line-num">481</span>     <span class="ruby-keyword">end</span>
<span class="line-num">482</span>   <span class="ruby-keyword">end</span>
<span class="line-num">483</span> 
<span class="line-num">484</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">485</span>     <span class="ruby-identifier">taxon_establishment_places</span> = { }
<span class="line-num">486</span>     <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">487</span>     <span class="ruby-identifier">uniq_obs_place_ids</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span><span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:path_ids</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="line-num">488</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">uniq_obs_place_ids</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">489</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;
<span class="line-num">490</span>       SELECT taxon_id, establishment_means, place_id
<span class="line-num">491</span>       FROM listed_taxa
<span class="line-num">492</span>       WHERE taxon_id IN (#{ taxon_ids.join(&#39;,&#39;) })
<span class="line-num">493</span>       AND place_id IN (#{ uniq_obs_place_ids })
<span class="line-num">494</span>       AND establishment_means IS NOT NULL&quot;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
<span class="line-num">495</span>       <span class="ruby-identifier">taxon_establishment_places</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>]] <span class="ruby-operator">||=</span> {}
<span class="line-num">496</span>       <span class="ruby-identifier">taxon_establishment_places</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>]][<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;establishment_means&quot;</span>]] <span class="ruby-operator">||=</span> []
<span class="line-num">497</span>       <span class="ruby-identifier">taxon_establishment_places</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>]][<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;establishment_means&quot;</span>]] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;place_id&quot;</span>]
<span class="line-num">498</span>     <span class="ruby-keyword">end</span>
<span class="line-num">499</span>     <span class="ruby-identifier">place_ids</span> = <span class="ruby-identifier">taxon_establishment_places</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:values</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
<span class="line-num">500</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_ids</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">501</span>     <span class="ruby-identifier">places</span> = {}
<span class="line-num">502</span>     <span class="ruby-constant">Place</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;
<span class="line-num">503</span>       SELECT id, bbox_area
<span class="line-num">504</span>       FROM places WHERE id IN (#{ place_ids.join(&#39;,&#39;) })&quot;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
<span class="line-num">505</span>       <span class="ruby-identifier">places</span>[<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;id&quot;</span>]] = {
<span class="line-num">506</span>         <span class="ruby-value">id:</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;id&quot;</span>],
<span class="line-num">507</span>         <span class="ruby-value">bbox_area:</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;bbox_area&quot;</span>].<span class="ruby-identifier">to_f</span>
<span class="line-num">508</span>       }
<span class="line-num">509</span>     <span class="ruby-keyword">end</span>
<span class="line-num">510</span>     <span class="ruby-identifier">taxon_places</span> = { }
<span class="line-num">511</span>     <span class="ruby-identifier">taxon_endemic_place_ids</span> = { }
<span class="line-num">512</span>     <span class="ruby-identifier">taxon_establishment_places</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">means_places</span><span class="ruby-operator">|</span>
<span class="line-num">513</span>       <span class="ruby-identifier">taxon_places</span>[<span class="ruby-identifier">taxon_id</span>] <span class="ruby-operator">||=</span> { }
<span class="line-num">514</span>       <span class="ruby-identifier">taxon_endemic_place_ids</span>[<span class="ruby-identifier">taxon_id</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">515</span>       <span class="ruby-identifier">means_places</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">means</span>,<span class="ruby-identifier">place_ids</span><span class="ruby-operator">|</span>
<span class="line-num">516</span>         <span class="ruby-identifier">taxon_establishment_places</span>[<span class="ruby-identifier">taxon_id</span>][<span class="ruby-identifier">means</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">517</span>         <span class="ruby-comment"># keep a hash of all places for each taxon</span>
<span class="line-num">518</span>         <span class="ruby-identifier">place_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">place_id</span><span class="ruby-operator">|</span>
<span class="line-num">519</span>           <span class="ruby-identifier">taxon_places</span>[<span class="ruby-identifier">taxon_id</span>][<span class="ruby-identifier">place_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">places</span>[<span class="ruby-identifier">place_id</span>].<span class="ruby-identifier">dup</span>
<span class="line-num">520</span>           <span class="ruby-identifier">taxon_places</span>[<span class="ruby-identifier">taxon_id</span>][<span class="ruby-identifier">place_id</span>][<span class="ruby-identifier">means</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">521</span>         <span class="ruby-keyword">end</span>
<span class="line-num">522</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">means</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;endemic&quot;</span>
<span class="line-num">523</span>           <span class="ruby-identifier">taxon_endemic_place_ids</span>[<span class="ruby-identifier">taxon_id</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">place_ids</span>
<span class="line-num">524</span>         <span class="ruby-keyword">end</span>
<span class="line-num">525</span>       <span class="ruby-keyword">end</span>
<span class="line-num">526</span>     <span class="ruby-keyword">end</span>
<span class="line-num">527</span>     <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">528</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_places</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>]
<span class="line-num">529</span>         <span class="ruby-identifier">closest</span> = <span class="ruby-identifier">taxon_places</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>].
<span class="line-num">530</span>           <span class="ruby-identifier">slice</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:path_ids</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>).
<span class="line-num">531</span>           <span class="ruby-identifier">values</span>.<span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">:bbox_area</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span> }.<span class="ruby-identifier">first</span>
<span class="line-num">532</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_introduced</span> = <span class="ruby-operator">!</span><span class="ruby-operator">!</span>(<span class="ruby-identifier">closest</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">533</span>           <span class="ruby-identifier">closest</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-operator">*</span><span class="ruby-constant">ListedTaxon</span><span class="ruby-operator">::</span><span class="ruby-constant">INTRODUCED_EQUIVALENTS</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">any?</span>)
<span class="line-num">534</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_native</span> = <span class="ruby-operator">!</span><span class="ruby-operator">!</span>(<span class="ruby-identifier">closest</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">535</span>           <span class="ruby-identifier">closest</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-operator">*</span><span class="ruby-constant">ListedTaxon</span><span class="ruby-operator">::</span><span class="ruby-constant">NATIVE_EQUIVALENTS</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">any?</span>)
<span class="line-num">536</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_endemic</span> = (<span class="ruby-identifier">o</span>.<span class="ruby-identifier">indexed_private_place_ids</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">taxon_endemic_place_ids</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">any?</span>
<span class="line-num">537</span>       <span class="ruby-keyword">end</span>
<span class="line-num">538</span>     <span class="ruby-keyword">end</span>
<span class="line-num">539</span>   <span class="ruby-keyword">end</span>
<span class="line-num">540</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-random_neighbor_lat_lon">
            
              <b>random_neighbor_lat_lon</b>(lat, lon)
            
            <a href="../classes/Observation.html#method-c-random_neighbor_lat_lon" name="method-c-random_neighbor_lat_lon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-random_neighbor_lat_lon_source')" id="l_method-c-random_neighbor_lat_lon_source">show</a>
                

                

                
              </p>
              <div id="method-c-random_neighbor_lat_lon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2470</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">random_neighbor_lat_lon</span>(<span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>)
<span class="line-num">2471</span>   <span class="ruby-identifier">precision</span> = <span class="ruby-value">10</span><span class="ruby-operator">**</span><span class="ruby-value">5.0</span>
<span class="line-num">2472</span>   <span class="ruby-identifier">range</span> = ((<span class="ruby-value">-1</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">precision</span>)<span class="ruby-operator">..</span><span class="ruby-identifier">precision</span>)
<span class="line-num">2473</span>   <span class="ruby-identifier">half_cell</span> = <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">2474</span>   <span class="ruby-identifier">center_lat</span>, <span class="ruby-identifier">center_lon</span> = <span class="ruby-identifier">uncertainty_cell_center_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2475</span>   [ <span class="ruby-identifier">center_lat</span> <span class="ruby-operator">+</span> ((<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">range</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">precision</span>) <span class="ruby-operator">*</span> <span class="ruby-identifier">half_cell</span>),
<span class="line-num">2476</span>     <span class="ruby-identifier">center_lon</span> <span class="ruby-operator">+</span> ((<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">range</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">precision</span>) <span class="ruby-operator">*</span> <span class="ruby-identifier">half_cell</span>)]
<span class="line-num">2477</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reassess_coordinates_for_observations_by">
            
              <b>reassess_coordinates_for_observations_by</b>( user )
            
            <a href="../classes/Observation.html#method-c-reassess_coordinates_for_observations_by" name="method-c-reassess_coordinates_for_observations_by" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reassess_coordinates_for_observations_by_source')" id="l_method-c-reassess_coordinates_for_observations_by_source">show</a>
                

                

                
              </p>
              <div id="method-c-reassess_coordinates_for_observations_by_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1966</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reassess_coordinates_for_observations_by</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1967</span>   <span class="ruby-identifier">batch_size</span> = <span class="ruby-value">500</span>
<span class="line-num">1968</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1969</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_in_batches</span>( <span class="ruby-value">batch_size:</span> <span class="ruby-identifier">batch_size</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">1970</span>     <span class="ruby-identifier">reassess_coordinates_of</span>( <span class="ruby-identifier">batch</span> )
<span class="line-num">1971</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1972</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reassess_coordinates_for_observations_of">
            
              <b>reassess_coordinates_for_observations_of</b>( taxon, options = {} )
            
            <a href="../classes/Observation.html#method-c-reassess_coordinates_for_observations_of" name="method-c-reassess_coordinates_for_observations_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reassess_coordinates_for_observations_of_source')" id="l_method-c-reassess_coordinates_for_observations_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-reassess_coordinates_for_observations_of_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1941</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reassess_coordinates_for_observations_of</span>( <span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1942</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Taxon</span>
<span class="line-num">1943</span>   <span class="ruby-identifier">batch_size</span> = <span class="ruby-value">500</span>
<span class="line-num">1944</span>   <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-value">0</span>
<span class="line-num">1945</span>   <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1946</span>   <span class="ruby-identifier">search_params</span> = {
<span class="line-num">1947</span>     <span class="ruby-value">ident_taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">1948</span>     <span class="ruby-value">per_page:</span> <span class="ruby-identifier">batch_size</span>,
<span class="line-num">1949</span>     <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>,
<span class="line-num">1950</span>     <span class="ruby-value">order:</span> <span class="ruby-string">&quot;asc&quot;</span>
<span class="line-num">1951</span>   }
<span class="line-num">1952</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:place</span>]
<span class="line-num">1953</span>     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:place</span>]
<span class="line-num">1954</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1955</span>   <span class="ruby-keyword">while</span> <span class="ruby-identifier">results_remaining</span>
<span class="line-num">1956</span>     <span class="ruby-identifier">observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>( <span class="ruby-identifier">search_params</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">id_above:</span> <span class="ruby-identifier">batch_start_id</span> ) )
<span class="line-num">1957</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">total_entries</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">1958</span>       <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">false</span>
<span class="line-num">1959</span>       <span class="ruby-keyword">break</span>
<span class="line-num">1960</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1961</span>     <span class="ruby-identifier">reassess_coordinates_of</span>( <span class="ruby-identifier">observations</span> )
<span class="line-num">1962</span>     <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1963</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1964</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reassess_coordinates_of">
            
              <b>reassess_coordinates_of</b>( observations )
            
            <a href="../classes/Observation.html#method-c-reassess_coordinates_of" name="method-c-reassess_coordinates_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reassess_coordinates_of_source')" id="l_method-c-reassess_coordinates_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-reassess_coordinates_of_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1974</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reassess_coordinates_of</span>( <span class="ruby-identifier">observations</span> )
<span class="line-num">1975</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-identifier">observations</span>, [
<span class="line-num">1976</span>     <span class="ruby-value">:taxon</span>,
<span class="line-num">1977</span>     { <span class="ruby-value">user:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num">1978</span>     { <span class="ruby-value">identifications:</span> { <span class="ruby-value">taxon:</span> <span class="ruby-value">:conservation_statuses</span> } }
<span class="line-num">1979</span>   ] )
<span class="line-num">1980</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">1981</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">set_taxon_geoprivacy</span>
<span class="line-num">1982</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">reassess_coordinate_obscuration</span>
<span class="line-num">1983</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">obscure_place_guess</span>
<span class="line-num">1984</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">coordinates_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">place_guess_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_geoprivacy_changed?</span>
<span class="line-num">1985</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>(
<span class="line-num">1986</span>       <span class="ruby-value">latitude:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span>,
<span class="line-num">1987</span>       <span class="ruby-value">longitude:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">longitude</span>,
<span class="line-num">1988</span>       <span class="ruby-value">private_latitude:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_latitude</span>,
<span class="line-num">1989</span>       <span class="ruby-value">private_longitude:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_longitude</span>,
<span class="line-num">1990</span>       <span class="ruby-value">geom:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">geom</span>,
<span class="line-num">1991</span>       <span class="ruby-value">private_geom:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_geom</span>,
<span class="line-num">1992</span>       <span class="ruby-value">place_guess:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">place_guess</span>,
<span class="line-num">1993</span>       <span class="ruby-value">private_place_guess:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_place_guess</span>,
<span class="line-num">1994</span>       <span class="ruby-value">taxon_geoprivacy:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_geoprivacy</span>,
<span class="line-num">1995</span>       <span class="ruby-value">public_positional_accuracy:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">calculate_public_positional_accuracy</span>,
<span class="line-num">1996</span>       <span class="ruby-value">mappable:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">calculate_mappable</span>
<span class="line-num">1997</span>     )
<span class="line-num">1998</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1999</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>), <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">2000</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-set_observations_taxa_for_user">
            
              <b>set_observations_taxa_for_user</b>( user, options = {} )
            
            <a href="../classes/Observation.html#method-c-set_observations_taxa_for_user" name="method-c-set_observations_taxa_for_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-set_observations_taxa_for_user_source')" id="l_method-c-set_observations_taxa_for_user_source">show</a>
                

                

                
              </p>
              <div id="method-c-set_observations_taxa_for_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1860</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">set_observations_taxa_for_user</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1861</span>   <span class="ruby-identifier">logger</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:logger</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>
<span class="line-num">1862</span>   <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">user</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> )
<span class="line-num">1863</span>   <span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">1864</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO #{Time.now}] Starting Observation.set_observations_taxa_for_user #{user.id}, options: #{options.inspect}&quot;</span>
<span class="line-num">1865</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">search_in_batches</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">1866</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-identifier">batch</span>, [
<span class="line-num">1867</span>       { <span class="ruby-value">user:</span> <span class="ruby-value">:stored_preferences</span> },
<span class="line-num">1868</span>       { <span class="ruby-value">identifications:</span> <span class="ruby-value">:taxon</span> }
<span class="line-num">1869</span>     ] )
<span class="line-num">1870</span>     <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">1871</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">prefers_community_taxa?</span>
<span class="line-num">1872</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">set_taxon_from_probable_taxon</span>
<span class="line-num">1873</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">changed?</span>
<span class="line-num">1874</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">save</span>
<span class="line-num">1875</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Failed to set taxon for #{o}: #{o.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">1876</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1877</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1878</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1879</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO #{Time.now}] Finished Observation.set_observations_taxa_for_user in #{Time.now - start_time}s, options: #{options.inspect}&quot;</span>
<span class="line-num">1880</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-set_quality_grade">
            
              <b>set_quality_grade</b>(id)
            
            <a href="../classes/Observation.html#method-c-set_quality_grade" name="method-c-set_quality_grade" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-set_quality_grade_source')" id="l_method-c-set_quality_grade_source">show</a>
                

                

                
              </p>
              <div id="method-c-set_quality_grade_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1454</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">set_quality_grade</span>(<span class="ruby-identifier">id</span>)
<span class="line-num">1455</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>)
<span class="line-num">1456</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_quality_grade</span>(<span class="ruby-value">:force</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">1457</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">save</span>
<span class="line-num">1458</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">quality_grade_changed?</span>
<span class="line-num">1459</span>     <span class="ruby-constant">CheckList</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">1460</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;CheckList::refresh_with_observation&quot;:</span> <span class="ruby-identifier">id</span> }).
<span class="line-num">1461</span>       <span class="ruby-identifier">refresh_with_observation</span>(<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon_id</span>)
<span class="line-num">1462</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1463</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">quality_grade</span>
<span class="line-num">1464</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-system_places_for_latlon">
            
              <b>system_places_for_latlon</b>( lat, lon, options = {} )
            
            <a href="../classes/Observation.html#method-c-system_places_for_latlon" name="method-c-system_places_for_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-system_places_for_latlon_source')" id="l_method-c-system_places_for_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-c-system_places_for_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2654</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">system_places_for_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2655</span>   <span class="ruby-identifier">all_places</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:places</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">places_for_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:acc</span>] )
<span class="line-num">2656</span>   <span class="ruby-identifier">all_places</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">2657</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> (
<span class="line-num">2658</span>       [<span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span>) <span class="ruby-operator">||</span> 
<span class="line-num">2659</span>       <span class="ruby-identifier">p</span>.<span class="ruby-identifier">place_type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">PLACE_TYPE_CODES</span>[<span class="ruby-string">&#39;Open Space&#39;</span>]
<span class="line-num">2660</span>     )
<span class="line-num">2661</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2662</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-uncertainty_cell_center_latlon">
            
              <b>uncertainty_cell_center_latlon</b>( lat, lon )
            
            <a href="../classes/Observation.html#method-c-uncertainty_cell_center_latlon" name="method-c-uncertainty_cell_center_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Coordinates of the southwest corner of the uncertainty cell for any given coordinates</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-uncertainty_cell_center_latlon_source')" id="l_method-c-uncertainty_cell_center_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-c-uncertainty_cell_center_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2482</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">uncertainty_cell_center_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2483</span>   <span class="ruby-identifier">half_cell</span> = <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">2484</span>   <span class="ruby-comment"># how many significant digits in the obscured coordinates (e.g. 5)</span>
<span class="line-num">2485</span>   <span class="ruby-comment"># doing a floor with intervals of 0.2, then adding 0.1</span>
<span class="line-num">2486</span>   <span class="ruby-comment"># so our origin is the center of a 0.2 square</span>
<span class="line-num">2487</span>   <span class="ruby-identifier">center_lat</span> = <span class="ruby-identifier">lat</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">lat</span> <span class="ruby-operator">%</span> <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>
<span class="line-num">2488</span>   <span class="ruby-identifier">center_lon</span> = <span class="ruby-identifier">lon</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">lon</span> <span class="ruby-operator">%</span> <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>
<span class="line-num">2489</span>   [<span class="ruby-identifier">center_lat</span>, <span class="ruby-identifier">center_lon</span>]
<span class="line-num">2490</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-uncertainty_cell_diagonal_meters">
            
              <b>uncertainty_cell_diagonal_meters</b>( lat, lon )
            
            <a href="../classes/Observation.html#method-c-uncertainty_cell_diagonal_meters" name="method-c-uncertainty_cell_diagonal_meters" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Distance of a diagonal from corner to corner across the uncertainty cell for the given coordinates.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-uncertainty_cell_diagonal_meters_source')" id="l_method-c-uncertainty_cell_diagonal_meters_source">show</a>
                

                

                
              </p>
              <div id="method-c-uncertainty_cell_diagonal_meters_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2496</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">uncertainty_cell_diagonal_meters</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2497</span>   <span class="ruby-identifier">half_cell</span> = <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">2498</span>   <span class="ruby-identifier">center_lat</span>, <span class="ruby-identifier">center_lon</span> = <span class="ruby-identifier">uncertainty_cell_center_latlon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2499</span>   <span class="ruby-identifier">lat_lon_distance_in_meters</span>( 
<span class="line-num">2500</span>     <span class="ruby-identifier">center_lat</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">half_cell</span>, 
<span class="line-num">2501</span>     <span class="ruby-identifier">center_lon</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">half_cell</span>, 
<span class="line-num">2502</span>     <span class="ruby-identifier">center_lat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>,
<span class="line-num">2503</span>     <span class="ruby-identifier">center_lon</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>
<span class="line-num">2504</span>   ).<span class="ruby-identifier">ceil</span>
<span class="line-num">2505</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_for_taxon_change">
            
              <b>update_for_taxon_change</b>(taxon_change, options = {}, &amp;block)
            
            <a href="../classes/Observation.html#method-c-update_for_taxon_change" name="method-c-update_for_taxon_change" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_for_taxon_change_source')" id="l_method-c-update_for_taxon_change_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_for_taxon_change_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2925</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_for_taxon_change</span>(<span class="ruby-identifier">taxon_change</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">2926</span>   <span class="ruby-identifier">input_taxon_ids</span> = <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">input_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">2927</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">input_taxon_ids</span>)
<span class="line-num">2928</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">2929</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:records</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">2930</span>     <span class="ruby-identifier">record_ids</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:records</span>].<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Observation</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">to_i</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2931</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations.id IN (?)&quot;</span>, <span class="ruby-identifier">record_ids</span> )
<span class="line-num">2932</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2933</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>( <span class="ruby-value">:user</span>, <span class="ruby-value">:identifications</span>, <span class="ruby-value">:observations_places</span> )
<span class="line-num">2934</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">2935</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">owners_identification</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">input_taxon_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon_id</span> )
<span class="line-num">2936</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">output_taxon</span> = <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">output_taxon_for_record</span>( <span class="ruby-identifier">observation</span> )
<span class="line-num">2937</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">automatable_for_output?</span>( <span class="ruby-identifier">output_taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">2938</span>         <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">create</span>(
<span class="line-num">2939</span>           <span class="ruby-value">user:</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user</span>,
<span class="line-num">2940</span>           <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>,
<span class="line-num">2941</span>           <span class="ruby-value">taxon:</span> <span class="ruby-identifier">output_taxon</span>,
<span class="line-num">2942</span>           <span class="ruby-value">taxon_change:</span> <span class="ruby-identifier">taxon_change</span>
<span class="line-num">2943</span>         )
<span class="line-num">2944</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2945</span>     <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">input_taxon_ids</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">2946</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_community_taxon</span>( <span class="ruby-value">force:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">2947</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_taxon_from_probable_taxon</span>
<span class="line-num">2948</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">save!</span>
<span class="line-num">2949</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2950</span>     <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">observation</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
<span class="line-num">2951</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2952</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_observations_places">
            
              <b>update_observations_places</b>(options = { })
            
            <a href="../classes/Observation.html#method-c-update_observations_places" name="method-c-update_observations_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_observations_places_source')" id="l_method-c-update_observations_places_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_observations_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3069</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_observations_places</span>(<span class="ruby-identifier">options</span> = { })
<span class="line-num">3070</span>   <span class="ruby-identifier">filter_scope</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:scope</span>)
<span class="line-num">3071</span>   <span class="ruby-identifier">scope</span> = (<span class="ruby-identifier">filter_scope</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">filter_scope</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Relation</span>)) <span class="ruby-operator">?</span>
<span class="line-num">3072</span>     <span class="ruby-identifier">filter_scope</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">all</span>
<span class="line-num">3073</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">filter_ids</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:ids</span>)
<span class="line-num">3074</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">filter_ids</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>
<span class="line-num">3075</span>       <span class="ruby-comment"># call again for each batch, then return</span>
<span class="line-num">3076</span>       <span class="ruby-identifier">filter_ids</span>.<span class="ruby-identifier">each_slice</span>(<span class="ruby-value">100</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">slice</span><span class="ruby-operator">|</span>
<span class="line-num">3077</span>         <span class="ruby-identifier">update_observations_places</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">ids:</span> <span class="ruby-identifier">slice</span>))
<span class="line-num">3078</span>       <span class="ruby-keyword">end</span>
<span class="line-num">3079</span>       <span class="ruby-keyword">return</span>
<span class="line-num">3080</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3081</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">filter_ids</span>)
<span class="line-num">3082</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3083</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:batch_size</span>] = <span class="ruby-value">100</span>
<span class="line-num">3084</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">select</span>(<span class="ruby-value">:id</span>).<span class="ruby-identifier">find_in_batches</span>(<span class="ruby-identifier">options</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">3085</span>     <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">3086</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
<span class="line-num">3087</span>       <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;DELETE FROM observations_places
<span class="line-num">3088</span>         WHERE observation_id IN (#{ ids.join(&#39;,&#39;) })&quot;</span>)
<span class="line-num">3089</span>       <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;INSERT INTO observations_places (observation_id, place_id)
<span class="line-num">3090</span>         SELECT DISTINCT o.id, pg.place_id FROM observations o
<span class="line-num">3091</span>         JOIN place_geometries pg ON ST_Intersects(pg.geom, o.private_geom)
<span class="line-num">3092</span>         WHERE o.id IN (#{ ids.join(&#39;,&#39;) })
<span class="line-num">3093</span>         AND pg.place_id IS NOT NULL
<span class="line-num">3094</span>         AND NOT EXISTS (
<span class="line-num">3095</span>           SELECT observation_id FROM observations_places
<span class="line-num">3096</span>           WHERE place_id = pg.place_id AND observation_id = o.id
<span class="line-num">3097</span>         )&quot;</span>)
<span class="line-num">3098</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3099</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3100</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_stats_for_observations_of">
            
              <b>update_stats_for_observations_of</b>( taxon )
            
            <a href="../classes/Observation.html#method-c-update_stats_for_observations_of" name="method-c-update_stats_for_observations_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_stats_for_observations_of_source')" id="l_method-c-update_stats_for_observations_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_stats_for_observations_of_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2431</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_stats_for_observations_of</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">2432</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">taxon</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Taxon</span>)
<span class="line-num">2433</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">2434</span>   <span class="ruby-identifier">search_params</span> = {
<span class="line-num">2435</span>     <span class="ruby-value">ident_taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">2436</span>     <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>,
<span class="line-num">2437</span>     <span class="ruby-value">order:</span> <span class="ruby-string">&quot;asc&quot;</span>,
<span class="line-num">2438</span>     <span class="ruby-value">per_page:</span> <span class="ruby-value">1000</span>
<span class="line-num">2439</span>   }
<span class="line-num">2440</span>   <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">true</span>
<span class="line-num">2441</span>   <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-value">0</span>
<span class="line-num">2442</span>   <span class="ruby-keyword">while</span> <span class="ruby-identifier">results_remaining</span>
<span class="line-num">2443</span>     <span class="ruby-comment"># puts batch_start_id</span>
<span class="line-num">2444</span>     <span class="ruby-identifier">observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>( <span class="ruby-identifier">search_params</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">id_above:</span> <span class="ruby-identifier">batch_start_id</span> ) )
<span class="line-num">2445</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">total_entries</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">2446</span>       <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">false</span>
<span class="line-num">2447</span>       <span class="ruby-keyword">break</span>
<span class="line-num">2448</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2449</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">observations</span>, [
<span class="line-num">2450</span>       <span class="ruby-value">:taxon</span>, <span class="ruby-value">:flags</span>, <span class="ruby-value">:quality_metrics</span>, <span class="ruby-value">:sounds</span>, <span class="ruby-value">:votes_for</span>,
<span class="line-num">2451</span>       { <span class="ruby-value">identifications:</span> <span class="ruby-value">:taxon</span> },
<span class="line-num">2452</span>       { <span class="ruby-value">photos:</span> <span class="ruby-value">:flags</span> }
<span class="line-num">2453</span>     ])
<span class="line-num">2454</span>     <span class="ruby-identifier">changed_ids</span> = []
<span class="line-num">2455</span>     <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">2456</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">set_community_taxon</span>
<span class="line-num">2457</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">update_stats</span>(<span class="ruby-value">skip_save:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">2458</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">changed?</span>
<span class="line-num">2459</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">2460</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">save</span>
<span class="line-num">2461</span>         <span class="ruby-identifier">changed_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2462</span>         <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">update_categories_for_observation</span>( <span class="ruby-identifier">o</span> )
<span class="line-num">2463</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2464</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2465</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(<span class="ruby-value">ids:</span> <span class="ruby-identifier">changed_ids</span>, <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">2466</span>     <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2467</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2468</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-application_id_to_index">
            
              <b>application_id_to_index</b>()
            
            <a href="../classes/Observation.html#method-i-application_id_to_index" name="method-i-application_id_to_index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-application_id_to_index_source')" id="l_method-i-application_id_to_index_source">show</a>
                

                

                
              </p>
              <div id="method-i-application_id_to_index_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3248</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">application_id_to_index</span>
<span class="line-num">3249</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">oauth_application_id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">oauth_application_id</span>
<span class="line-num">3250</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">IPHONE_APP_USER_AGENT_PATTERN</span>
<span class="line-num">3251</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">OauthApplication</span>.<span class="ruby-identifier">inaturalist_iphone_app</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">3252</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3253</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">ANDROID_APP_USER_AGENT_PATTERN</span>
<span class="line-num">3254</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">OauthApplication</span>.<span class="ruby-identifier">inaturalist_android_app</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">3255</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3256</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-appropriate-3F">
            
              <b>appropriate?</b>()
            
            <a href="../classes/Observation.html#method-i-appropriate-3F" name="method-i-appropriate-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-appropriate-3F_source')" id="l_method-i-appropriate-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-appropriate-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1372</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">appropriate?</span>
<span class="line-num">1373</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">flagged?</span>
<span class="line-num">1374</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">flagged?</span> }
<span class="line-num">1375</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">flagged?</span> }
<span class="line-num">1376</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1377</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-as_indexed_json">
            
              <b>as_indexed_json</b>(options={})
            
            <a href="../classes/Observation.html#method-i-as_indexed_json" name="method-i-as_indexed_json" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Obs as a JSON document for indexing in Elastic Search. If you&#39;re going to modify this, make sure you also modify the mapping above and add an explicit type for each new field. That mapping is only used for recreating the index, though, so you should also update the actual index as well (see 20151030205931_add_mappings_to_observations_index.rb for an example)</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-as_indexed_json_source')" id="l_method-i-as_indexed_json_source">show</a>
                

                

                
              </p>
              <div id="method-i-as_indexed_json_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/observation_index.rb</span>
<span class="line-num">317</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">as_indexed_json</span>(<span class="ruby-identifier">options</span>={})
<span class="line-num">318</span>   <span class="ruby-identifier">preload_for_elastic_index</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">319</span>   <span class="ruby-comment"># some timezones are invalid</span>
<span class="line-num">320</span>   <span class="ruby-identifier">created</span> = <span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">timezone_object</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;UTC&quot;</span>)
<span class="line-num">321</span>   <span class="ruby-identifier">t</span> = <span class="ruby-identifier">taxon</span>
<span class="line-num">322</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">323</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">324</span>     <span class="ruby-value">site_id:</span> <span class="ruby-identifier">site_id</span>,
<span class="line-num">325</span>     <span class="ruby-value">created_at:</span> <span class="ruby-identifier">created</span>,
<span class="line-num">326</span>     <span class="ruby-value">created_at_details:</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">date_details</span>(<span class="ruby-identifier">created</span>),
<span class="line-num">327</span>     <span class="ruby-value">observed_on:</span> <span class="ruby-identifier">datetime</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">datetime</span>.<span class="ruby-identifier">to_date</span>,
<span class="line-num">328</span>     <span class="ruby-value">observed_on_details:</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">date_details</span>(<span class="ruby-identifier">datetime</span>),
<span class="line-num">329</span>     <span class="ruby-value">time_observed_at:</span> <span class="ruby-identifier">time_observed_at_in_zone</span>,
<span class="line-num">330</span>     <span class="ruby-value">place_ids:</span> (<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">public_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">331</span>     <span class="ruby-value">quality_grade:</span> <span class="ruby-identifier">quality_grade</span>,
<span class="line-num">332</span>     <span class="ruby-value">taxon:</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">for_observation:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">333</span>       <span class="ruby-value">no_details:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>],
<span class="line-num">334</span>       <span class="ruby-value">for_identification:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:for_identification</span>]) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">335</span>   }
<span class="line-num">336</span> 
<span class="line-num">337</span>   <span class="ruby-identifier">current_ids</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:current?</span>)
<span class="line-num">338</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">339</span>     <span class="ruby-identifier">json</span>.<span class="ruby-identifier">merge!</span>({
<span class="line-num">340</span>       <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">341</span>     })
<span class="line-num">342</span>   <span class="ruby-keyword">else</span>
<span class="line-num">343</span>     <span class="ruby-identifier">json</span>.<span class="ruby-identifier">merge!</span>({
<span class="line-num">344</span>       <span class="ruby-value">uuid:</span> <span class="ruby-identifier">uuid</span>,
<span class="line-num">345</span>       <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">no_details:</span> <span class="ruby-keyword">true</span>).<span class="ruby-identifier">merge</span>( <span class="ruby-value">site_id:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">site_id</span> ) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">346</span>       <span class="ruby-value">captive:</span> <span class="ruby-identifier">captive</span>,
<span class="line-num">347</span>       <span class="ruby-value">created_time_zone:</span> <span class="ruby-identifier">timezone_object</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;UTC&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">timezone_object</span>.<span class="ruby-identifier">tzinfo</span>.<span class="ruby-identifier">name</span>,
<span class="line-num">348</span>       <span class="ruby-value">updated_at:</span> <span class="ruby-identifier">updated_at</span>.<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">timezone_object</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;UTC&quot;</span>),
<span class="line-num">349</span>       <span class="ruby-value">observed_time_zone:</span> <span class="ruby-identifier">timezone_object</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">timezone_object</span>.<span class="ruby-identifier">tzinfo</span>.<span class="ruby-identifier">name</span>,
<span class="line-num">350</span>       <span class="ruby-value">time_zone_offset:</span> <span class="ruby-identifier">timezone_offset</span>,
<span class="line-num">351</span>       <span class="ruby-value">uri:</span> <span class="ruby-identifier">uri</span>,
<span class="line-num">352</span>       <span class="ruby-value">description:</span> <span class="ruby-identifier">description</span>,
<span class="line-num">353</span>       <span class="ruby-value">mappable:</span> <span class="ruby-identifier">mappable</span>,
<span class="line-num">354</span>       <span class="ruby-value">species_guess:</span> <span class="ruby-identifier">species_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">species_guess</span>,
<span class="line-num">355</span>       <span class="ruby-value">place_guess:</span> <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">place_guess</span>,
<span class="line-num">356</span>       <span class="ruby-value">private_place_guess:</span> <span class="ruby-identifier">private_place_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_place_guess</span>,
<span class="line-num">357</span>       <span class="ruby-value">observed_on_string:</span> <span class="ruby-identifier">observed_on_string</span>,
<span class="line-num">358</span>       <span class="ruby-value">license_code:</span> <span class="ruby-identifier">license</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">359</span>       <span class="ruby-value">geoprivacy:</span> <span class="ruby-identifier">geoprivacy</span>,
<span class="line-num">360</span>       <span class="ruby-value">taxon_geoprivacy:</span> <span class="ruby-identifier">taxon_geoprivacy</span>,
<span class="line-num">361</span>       <span class="ruby-value">map_scale:</span> <span class="ruby-identifier">map_scale</span>,
<span class="line-num">362</span>       <span class="ruby-value">oauth_application_id:</span> <span class="ruby-identifier">application_id_to_index</span>,
<span class="line-num">363</span>       <span class="ruby-value">community_taxon_id:</span> <span class="ruby-identifier">community_taxon_id</span>,
<span class="line-num">364</span>       <span class="ruby-value">faves_count:</span> <span class="ruby-identifier">faves_count</span>,
<span class="line-num">365</span>       <span class="ruby-comment"># cached_votes_total is a count of *all* votes on the obs, which</span>
<span class="line-num">366</span>       <span class="ruby-comment"># includes things voting whether the obs still needs an ID, so using</span>
<span class="line-num">367</span>       <span class="ruby-comment"># that actually throws off the sorting when what we really want to do is</span>
<span class="line-num">368</span>       <span class="ruby-comment"># sort by faves. We&#39;re not losing anything performance-wise by loading</span>
<span class="line-num">369</span>       <span class="ruby-comment"># the votes since we&#39;re doing that in the `votes` attribute anyway</span>
<span class="line-num">370</span>       <span class="ruby-value">cached_votes_total:</span> <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_scope</span>.<span class="ruby-identifier">blank?</span>}.<span class="ruby-identifier">size</span>,
<span class="line-num">371</span>       <span class="ruby-value">num_identification_agreements:</span> <span class="ruby-identifier">num_identification_agreements</span>,
<span class="line-num">372</span>       <span class="ruby-value">num_identification_disagreements:</span> <span class="ruby-identifier">num_identification_disagreements</span>,
<span class="line-num">373</span>       <span class="ruby-value">identifications_most_agree:</span>
<span class="line-num">374</span>         (<span class="ruby-identifier">num_identification_agreements</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">num_identification_disagreements</span>),
<span class="line-num">375</span>       <span class="ruby-value">identifications_some_agree:</span>
<span class="line-num">376</span>         (<span class="ruby-identifier">num_identification_agreements</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>),
<span class="line-num">377</span>       <span class="ruby-value">identifications_most_disagree:</span>
<span class="line-num">378</span>         (<span class="ruby-identifier">num_identification_agreements</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">num_identification_disagreements</span>),
<span class="line-num">379</span>       <span class="ruby-value">place_ids:</span> (<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">public_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">380</span>       <span class="ruby-value">private_place_ids:</span> (<span class="ruby-identifier">indexed_private_place_ids</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">381</span>       <span class="ruby-value">project_ids:</span> <span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span> <span class="ruby-identifier">po</span>[<span class="ruby-value">:project_id</span>] }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">382</span>       <span class="ruby-value">project_ids_with_curator_id:</span> <span class="ruby-identifier">project_observations</span>.
<span class="line-num">383</span>         <span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">po</span>.<span class="ruby-identifier">curator_identification_id</span>.<span class="ruby-identifier">nil?</span> }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:project_id</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">384</span>       <span class="ruby-value">project_ids_without_curator_id:</span> <span class="ruby-identifier">project_observations</span>.
<span class="line-num">385</span>         <span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">curator_identification_id</span>.<span class="ruby-identifier">nil?</span> }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:project_id</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">386</span>       <span class="ruby-value">reviewed_by:</span> <span class="ruby-identifier">confirmed_reviews</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:user_id</span>),
<span class="line-num">387</span>       <span class="ruby-value">tags:</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">388</span>       <span class="ruby-value">ofvs:</span> <span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">389</span>       <span class="ruby-value">annotations:</span> <span class="ruby-identifier">annotations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">390</span>       <span class="ruby-value">photos_count:</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">391</span>         <span class="ruby-identifier">p</span>.<span class="ruby-identifier">flags</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">flag</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT_INFRINGEMENT</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span>.<span class="ruby-identifier">resolved?</span>}.<span class="ruby-identifier">blank?</span>
<span class="line-num">392</span>       }.<span class="ruby-identifier">length</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">393</span>       <span class="ruby-value">sounds_count:</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">394</span>       <span class="ruby-value">photo_licenses:</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:index_license_code</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">395</span>       <span class="ruby-value">sound_licenses:</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:index_license_code</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">396</span>       <span class="ruby-value">sounds:</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">397</span>       <span class="ruby-value">identifier_user_ids:</span> <span class="ruby-identifier">current_ids</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:user_id</span>),
<span class="line-num">398</span>       <span class="ruby-value">ident_taxon_ids:</span> <span class="ruby-identifier">current_ids</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">399</span>       <span class="ruby-value">non_owner_identifier_user_ids:</span> <span class="ruby-identifier">current_ids</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:user_id</span>) <span class="ruby-operator">-</span> [<span class="ruby-identifier">user_id</span>],
<span class="line-num">400</span>       <span class="ruby-value">identification_categories:</span> <span class="ruby-identifier">current_ids</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:category</span>).<span class="ruby-identifier">uniq</span>,
<span class="line-num">401</span>       <span class="ruby-value">identifications_count:</span> <span class="ruby-identifier">num_identifications_by_others</span>,
<span class="line-num">402</span>       <span class="ruby-value">comments:</span> <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">403</span>       <span class="ruby-value">comments_count:</span> <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">size</span>,
<span class="line-num">404</span>       <span class="ruby-value">obscured:</span> <span class="ruby-identifier">coordinates_obscured?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">geoprivacy_obscured?</span>,
<span class="line-num">405</span>       <span class="ruby-value">positional_accuracy:</span> <span class="ruby-identifier">positional_accuracy</span>,
<span class="line-num">406</span>       <span class="ruby-value">public_positional_accuracy:</span> <span class="ruby-identifier">public_positional_accuracy</span>,
<span class="line-num">407</span>       <span class="ruby-value">location:</span> (<span class="ruby-identifier">latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>) <span class="ruby-operator">?</span>
<span class="line-num">408</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">point_latlon</span>(<span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">409</span>       <span class="ruby-value">private_location:</span> (<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude</span>) <span class="ruby-operator">?</span>
<span class="line-num">410</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">point_latlon</span>(<span class="ruby-identifier">private_latitude</span>, <span class="ruby-identifier">private_longitude</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">411</span>       <span class="ruby-value">geojson:</span> (<span class="ruby-identifier">latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>) <span class="ruby-operator">?</span>
<span class="line-num">412</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">point_geojson</span>(<span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">413</span>       <span class="ruby-value">private_geojson:</span> (<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude</span>) <span class="ruby-operator">?</span>
<span class="line-num">414</span>         <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">point_geojson</span>(<span class="ruby-identifier">private_latitude</span>, <span class="ruby-identifier">private_longitude</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">415</span>       <span class="ruby-value">votes:</span> <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">416</span>       <span class="ruby-value">outlinks:</span> <span class="ruby-identifier">observation_links</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">417</span>       <span class="ruby-value">owners_identification_from_vision:</span> <span class="ruby-identifier">owners_identification_from_vision</span>,
<span class="line-num">418</span>       <span class="ruby-value">preferences:</span> <span class="ruby-identifier">preferences</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> { <span class="ruby-value">name:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">0</span>], <span class="ruby-value">value:</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] } },
<span class="line-num">419</span>       <span class="ruby-value">flags:</span> <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">420</span>       <span class="ruby-value">quality_metrics:</span> <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">421</span>       <span class="ruby-value">spam:</span> <span class="ruby-identifier">known_spam?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">owned_by_spammer?</span>
<span class="line-num">422</span>     })
<span class="line-num">423</span> 
<span class="line-num">424</span>     <span class="ruby-identifier">add_taxon_statuses</span>(<span class="ruby-identifier">json</span>, <span class="ruby-identifier">t</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">json</span>[<span class="ruby-value">:taxon</span>]
<span class="line-num">425</span>   <span class="ruby-keyword">end</span>
<span class="line-num">426</span>   <span class="ruby-identifier">json</span>
<span class="line-num">427</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-build_observation_fields_from_tags">
            
              <b>build_observation_fields_from_tags</b>(tags)
            
            <a href="../classes/Observation.html#method-i-build_observation_fields_from_tags" name="method-i-build_observation_fields_from_tags" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-build_observation_fields_from_tags_source')" id="l_method-i-build_observation_fields_from_tags_source">show</a>
                

                

                
              </p>
              <div id="method-i-build_observation_fields_from_tags_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2875</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">build_observation_fields_from_tags</span>(<span class="ruby-identifier">tags</span>)
<span class="line-num">2876</span>   <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
<span class="line-num">2877</span>     <span class="ruby-identifier">np</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;=&#39;</span>)
<span class="line-num">2878</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">np</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">value</span>
<span class="line-num">2879</span>     <span class="ruby-identifier">namespace</span>, <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">np</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;:&#39;</span>)
<span class="line-num">2880</span>     <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">namespace</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2881</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2882</span>     <span class="ruby-identifier">of</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(name) = ?&quot;</span>, <span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">first</span>
<span class="line-num">2883</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">of</span>
<span class="line-num">2884</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ofv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">observation_field_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">of</span>.<span class="ruby-identifier">id</span>}
<span class="line-num">2885</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">of</span>.<span class="ruby-identifier">datatype</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ObservationField</span><span class="ruby-operator">::</span><span class="ruby-constant">TAXON</span>
<span class="line-num">2886</span>       <span class="ruby-identifier">t</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>(<span class="ruby-identifier">value</span>)
<span class="line-num">2887</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span>
<span class="line-num">2888</span>       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2889</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2890</span>     <span class="ruby-identifier">ofv</span> = <span class="ruby-constant">ObservationFieldValue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">observation:</span> <span class="ruby-keyword">self</span>, <span class="ruby-value">observation_field:</span> <span class="ruby-identifier">of</span>, <span class="ruby-value">value:</span> <span class="ruby-identifier">value</span>)
<span class="line-num">2891</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">attributes</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">2892</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2893</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-calculate_mappable">
            
              <b>calculate_mappable</b>()
            
            <a href="../classes/Observation.html#method-i-calculate_mappable" name="method-i-calculate_mappable" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-calculate_mappable_source')" id="l_method-i-calculate_mappable_source">show</a>
                

                

                
              </p>
              <div id="method-i-calculate_mappable_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3041</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">calculate_mappable</span>
<span class="line-num">3042</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">3043</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">public_positional_accuracy</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">public_positional_accuracy</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">uncertainty_cell_diagonal_meters</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">3044</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">inaccurate_location?</span>
<span class="line-num">3045</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">passes_quality_metric?</span>( <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">EVIDENCE</span> )
<span class="line-num">3046</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">appropriate?</span>
<span class="line-num">3047</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">3048</span>       <span class="ruby-operator">!</span><span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">3049</span>       <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">3050</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">3051</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3052</span>   <span class="ruby-keyword">true</span>
<span class="line-num">3053</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-calculate_public_positional_accuracy">
            
              <b>calculate_public_positional_accuracy</b>()
            
            <a href="../classes/Observation.html#method-i-calculate_public_positional_accuracy" name="method-i-calculate_public_positional_accuracy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-calculate_public_positional_accuracy_source')" id="l_method-i-calculate_public_positional_accuracy_source">show</a>
                

                

                
              </p>
              <div id="method-i-calculate_public_positional_accuracy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3024</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">calculate_public_positional_accuracy</span>
<span class="line-num">3025</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">3026</span>     [ <span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">uncertainty_cell_diagonal_meters</span>, <span class="ruby-value">0</span> ].<span class="ruby-identifier">max</span>
<span class="line-num">3027</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">3028</span>     <span class="ruby-identifier">positional_accuracy</span>
<span class="line-num">3029</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3030</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-captive_cultivated">
            
              <b>captive_cultivated</b>()
            
            <a href="../classes/Observation.html#method-i-captive_cultivated" name="method-i-captive_cultivated" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          
            <div class="aka">
              Alias for: <a href="Observation.html#method-i-captive_cultivated-3F">captive_cultivated?</a>
            </div>
          

          
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-captive_cultivated-3F">
            
              <b>captive_cultivated?</b>()
            
            <a href="../classes/Observation.html#method-i-captive_cultivated-3F" name="method-i-captive_cultivated-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          
            <div class="aka">
              Also aliased as: <a href="Observation.html#method-i-captive_cultivated">captive_cultivated</a>
            </div>
          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-captive_cultivated-3F_source')" id="l_method-i-captive_cultivated-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-captive_cultivated-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1717</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">captive_cultivated?</span>
<span class="line-num">1718</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">passes_quality_metric?</span>(<span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>)
<span class="line-num">1719</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-captive_flag">
            
              <b>captive_flag</b>()
            
            <a href="../classes/Observation.html#method-i-captive_flag" name="method-i-captive_flag" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-captive_flag_source')" id="l_method-i-captive_flag_source">show</a>
                

                

                
              </p>
              <div id="method-i-captive_flag_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">100</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">captive_flag</span>
<span class="line-num">101</span>   <span class="ruby-ivar">@captive_flag</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">!</span><span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> 
<span class="line-num">102</span>     <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">qm</span>.<span class="ruby-identifier">agree?</span>
<span class="line-num">103</span>   }.<span class="ruby-identifier">nil?</span>
<span class="line-num">104</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-captive_flag-3D">
            
              <b>captive_flag=</b>(v)
            
            <a href="../classes/Observation.html#method-i-captive_flag-3D" name="method-i-captive_flag-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-captive_flag-3D_source')" id="l_method-i-captive_flag-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-captive_flag-3D_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">106</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">captive_flag=</span>(<span class="ruby-identifier">v</span>)
<span class="line-num">107</span>   <span class="ruby-ivar">@captive_flag</span> = <span class="ruby-identifier">v</span>
<span class="line-num">108</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-casual-3F">
            
              <b>casual?</b>()
            
            <a href="../classes/Observation.html#method-i-casual-3F" name="method-i-casual-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-casual-3F_source')" id="l_method-i-casual-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-casual-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3197</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">casual?</span>
<span class="line-num">3198</span>   <span class="ruby-identifier">quality_grade</span> <span class="ruby-operator">==</span> <span class="ruby-constant">CASUAL</span>
<span class="line-num">3199</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-collection_projects">
            
              <b>collection_projects</b>( api_params = {} )
            
            <a href="../classes/Observation.html#method-i-collection_projects" name="method-i-collection_projects" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-collection_projects_source')" id="l_method-i-collection_projects_source">show</a>
                

                

                
              </p>
              <div id="method-i-collection_projects_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3319</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">collection_projects</span>( <span class="ruby-identifier">api_params</span> = {} )
<span class="line-num">3320</span>   <span class="ruby-identifier">r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-node">&quot;/observations/#{id}&quot;</span>, <span class="ruby-identifier">api_params</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">include_new_projects:</span> <span class="ruby-keyword">true</span> ) )
<span class="line-num">3321</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">api_obs</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">results</span>[<span class="ruby-value">0</span>]
<span class="line-num">3322</span>     <span class="ruby-identifier">project_ids</span> = ( <span class="ruby-identifier">api_obs</span>[<span class="ruby-string">&quot;non_traditional_projects&quot;</span>] <span class="ruby-operator">||</span> [] ).<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span>
<span class="line-num">3323</span>       <span class="ruby-identifier">po</span>[<span class="ruby-string">&quot;project&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">3324</span>     <span class="ruby-keyword">end</span>
<span class="line-num">3325</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">Project</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">project_ids</span> ).<span class="ruby-identifier">limit</span>( <span class="ruby-value">500</span> )
<span class="line-num">3326</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3327</span>   []
<span class="line-num">3328</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-common_name">
            
              <b>common_name</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-common_name" name="method-i-common_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-common_name_source')" id="l_method-i-common_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-common_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2376</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">common_name</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">2377</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">localize_locale</span>
<span class="line-num">2378</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:place</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">localize_place</span>
<span class="line-num">2379</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">common_name</span>(<span class="ruby-identifier">options</span>).<span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">common_name</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">2380</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_supported_id-3F">
            
              <b>community_supported_id?</b>()
            
            <a href="../classes/Observation.html#method-i-community_supported_id-3F" name="method-i-community_supported_id-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_supported_id-3F_source')" id="l_method-i-community_supported_id-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_supported_id-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1395</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_supported_id?</span>
<span class="line-num">1396</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">community_taxon_rejected?</span>
<span class="line-num">1397</span>     <span class="ruby-identifier">num_identification_agreements</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">num_identification_agreements</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">num_identification_disagreements</span>
<span class="line-num">1398</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1399</span>     <span class="ruby-operator">!</span><span class="ruby-identifier">community_taxon_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">community_taxon_id</span>
<span class="line-num">1400</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1401</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_at_family_or_lower-3F">
            
              <b>community_taxon_at_family_or_lower?</b>()
            
            <a href="../classes/Observation.html#method-i-community_taxon_at_family_or_lower-3F" name="method-i-community_taxon_at_family_or_lower-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_at_family_or_lower-3F_source')" id="l_method-i-community_taxon_at_family_or_lower-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_at_family_or_lower-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3151</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_at_family_or_lower?</span>
<span class="line-num">3152</span>   <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">FAMILY_LEVEL</span>
<span class="line-num">3153</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_at_species_or_lower-3F">
            
              <b>community_taxon_at_species_or_lower?</b>()
            
            <a href="../classes/Observation.html#method-i-community_taxon_at_species_or_lower-3F" name="method-i-community_taxon_at_species_or_lower-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_at_species_or_lower-3F_source')" id="l_method-i-community_taxon_at_species_or_lower-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_at_species_or_lower-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3147</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_at_species_or_lower?</span>
<span class="line-num">3148</span>   <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">3149</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_below_family-3F">
            
              <b>community_taxon_below_family?</b>()
            
            <a href="../classes/Observation.html#method-i-community_taxon_below_family-3F" name="method-i-community_taxon_below_family-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_below_family-3F_source')" id="l_method-i-community_taxon_below_family-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_below_family-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3155</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_below_family?</span>
<span class="line-num">3156</span>   <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">FAMILY_LEVEL</span>
<span class="line-num">3157</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_nodes">
            
              <b>community_taxon_nodes</b>( options = {} )
            
            <a href="../classes/Observation.html#method-i-community_taxon_nodes" name="method-i-community_taxon_nodes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_nodes_source')" id="l_method-i-community_taxon_nodes_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_nodes_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1774</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_nodes</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1775</span>   <span class="ruby-keyword">return</span> <span class="ruby-ivar">@community_taxon_nodes</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@community_taxon_nodes</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:force</span>]
<span class="line-num">1776</span>   <span class="ruby-comment"># work on current identifications</span>
<span class="line-num">1777</span>   <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span>
<span class="line-num">1778</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:current?</span>).<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:persisted?</span>).<span class="ruby-identifier">uniq</span> <span class="ruby-operator">:</span>
<span class="line-num">1779</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>)
<span class="line-num">1780</span>   <span class="ruby-identifier">working_idents</span> = <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_active</span> }.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1781</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:before</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1782</span>     <span class="ruby-identifier">working_idents</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:before</span>].<span class="ruby-identifier">to_i</span> }
<span class="line-num">1783</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:before</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">DateTime</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:before</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeWithZone</span> )
<span class="line-num">1784</span>     <span class="ruby-identifier">working_idents</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:before</span>] }
<span class="line-num">1785</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1786</span> 
<span class="line-num">1787</span>   <span class="ruby-comment"># load all ancestor taxa implied by identifications</span>
<span class="line-num">1788</span>   <span class="ruby-identifier">ancestor_ids</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestor_ids</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1789</span>   <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestor_ids</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1790</span>   <span class="ruby-identifier">taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">taxon_ids</span>)
<span class="line-num">1791</span>   <span class="ruby-identifier">taxon_ids_count</span> = <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">size</span>
<span class="line-num">1792</span> 
<span class="line-num">1793</span>   <span class="ruby-ivar">@community_taxon_nodes</span> = <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id_taxon</span><span class="ruby-operator">|</span>
<span class="line-num">1794</span>     <span class="ruby-comment"># puts id_taxon.name</span>
<span class="line-num">1795</span>     <span class="ruby-comment"># count all identifications of this taxon and its descendants</span>
<span class="line-num">1796</span>     <span class="ruby-identifier">cumulative_count</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">id</span>)}.<span class="ruby-identifier">size</span>
<span class="line-num">1797</span> 
<span class="line-num">1798</span>     <span class="ruby-comment"># count identifications of taxa that are outside of this taxon&#39;s subtree</span>
<span class="line-num">1799</span>     <span class="ruby-comment"># (i.e. absolute disagreements)</span>
<span class="line-num">1800</span>     <span class="ruby-identifier">disagreement_count</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">reject</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">1801</span>      <span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">1802</span>     }.<span class="ruby-identifier">size</span>
<span class="line-num">1803</span> 
<span class="line-num">1804</span>     <span class="ruby-comment"># Count identifications that explicitly disagreed with an ancestor of this taxon</span>
<span class="line-num">1805</span>     <span class="ruby-identifier">first_ident_of_taxon</span> = <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">id</span>)}
<span class="line-num">1806</span>     <span class="ruby-identifier">conservative_disagreement_count</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">first_ident_of_taxon</span>
<span class="line-num">1807</span>       <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">1808</span>         <span class="ruby-comment"># puts &quot;\tID #{i.id}: #{i.taxon.name}&quot;</span>
<span class="line-num">1809</span>         <span class="ruby-comment"># puts &quot;\t\ti.disagreement?: #{i.disagreement?}&quot;</span>
<span class="line-num">1810</span>         <span class="ruby-comment"># puts &quot;\t\ti.previous_observation_taxon: #{i.previous_observation_taxon}&quot;</span>
<span class="line-num">1811</span>         <span class="ruby-keyword">if</span> (
<span class="line-num">1812</span>           <span class="ruby-identifier">i</span>.<span class="ruby-identifier">disagreement?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1813</span>           <span class="ruby-identifier">i</span>.<span class="ruby-identifier">previous_observation_taxon</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1814</span>           ( <span class="ruby-identifier">base_index</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">index</span>( <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> ) )
<span class="line-num">1815</span>         )
<span class="line-num">1816</span> 
<span class="line-num">1817</span>           <span class="ruby-comment"># If an identification of Homonidae is a disagreement with Homo</span>
<span class="line-num">1818</span>           <span class="ruby-comment"># sapiens, that implies disagreement with everything between</span>
<span class="line-num">1819</span>           <span class="ruby-comment"># Homonidae and Homo sapiens (i.e. genus Homo), otherwise they would</span>
<span class="line-num">1820</span>           <span class="ruby-comment"># have added an ID of genus Homo</span>
<span class="line-num">1821</span>           <span class="ruby-identifier">disagreement_branch_taxon_ids</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>[<span class="ruby-identifier">base_index</span><span class="ruby-value">+1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
<span class="line-num">1822</span>           <span class="ruby-comment"># puts &quot;\t\tdisagreement_branch_taxon_ids: #{disagreement_branch_taxon_ids}&quot;</span>
<span class="line-num">1823</span>           <span class="ruby-comment"># So if the taxon under consideration is any of the taxa this</span>
<span class="line-num">1824</span>           <span class="ruby-comment"># identification disagrees with, count it as a disagreement</span>
<span class="line-num">1825</span>           <span class="ruby-comment"># puts &quot;\t\t( id_taxon.self_and_ancestor_ids &amp; disagreement_branch_taxon_ids ): #{( id_taxon.self_and_ancestor_ids &amp; disagreement_branch_taxon_ids )}&quot;</span>
<span class="line-num">1826</span>           ( <span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">disagreement_branch_taxon_ids</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1827</span>         <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">disagreement</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1828</span>           <span class="ruby-identifier">i</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">first_ident_of_taxon</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> )
<span class="line-num">1829</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1830</span>       }.<span class="ruby-identifier">size</span>
<span class="line-num">1831</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1832</span>       <span class="ruby-value">0</span>
<span class="line-num">1833</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1834</span> 
<span class="line-num">1835</span>     {
<span class="line-num">1836</span>       <span class="ruby-value">taxon:</span> <span class="ruby-identifier">id_taxon</span>,
<span class="line-num">1837</span>       <span class="ruby-value">ident_count:</span> <span class="ruby-identifier">working_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id_taxon</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">size</span>,
<span class="line-num">1838</span>       <span class="ruby-value">cumulative_count:</span> <span class="ruby-identifier">cumulative_count</span>,
<span class="line-num">1839</span>       <span class="ruby-value">disagreement_count:</span> <span class="ruby-identifier">disagreement_count</span>,
<span class="line-num">1840</span>       <span class="ruby-value">conservative_disagreement_count:</span> <span class="ruby-identifier">conservative_disagreement_count</span>,
<span class="line-num">1841</span>       <span class="ruby-value">score:</span> <span class="ruby-identifier">cumulative_count</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">cumulative_count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">disagreement_count</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">conservative_disagreement_count</span>)
<span class="line-num">1842</span>     }
<span class="line-num">1843</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1844</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_rejected-3F">
            
              <b>community_taxon_rejected?</b>()
            
            <a href="../classes/Observation.html#method-i-community_taxon_rejected-3F" name="method-i-community_taxon_rejected-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_rejected-3F_source')" id="l_method-i-community_taxon_rejected-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_rejected-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1882</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_rejected?</span>
<span class="line-num">1883</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">prefers_community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
<span class="line-num">1884</span>   (<span class="ruby-identifier">prefers_community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">prefers_community_taxa</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>)
<span class="line-num">1885</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-component_cache_key">
            
              <b>component_cache_key</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-component_cache_key" name="method-i-component_cache_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-component_cache_key_source')" id="l_method-i-component_cache_key_source">show</a>
                

                

                
              </p>
              <div id="method-i-component_cache_key_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1358</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">component_cache_key</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1359</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">component_cache_key</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">options</span>)
<span class="line-num">1360</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-coordinates_changed-3F">
            
              <b>coordinates_changed?</b>()
            
            <a href="../classes/Observation.html#method-i-coordinates_changed-3F" name="method-i-coordinates_changed-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-coordinates_changed-3F_source')" id="l_method-i-coordinates_changed-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-coordinates_changed-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1515</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">coordinates_changed?</span>
<span class="line-num">1516</span>   <span class="ruby-identifier">latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_longitude_changed?</span>
<span class="line-num">1517</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-coordinates_obscured">
            
              <b>coordinates_obscured</b>()
            
            <a href="../classes/Observation.html#method-i-coordinates_obscured" name="method-i-coordinates_obscured" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          
            <div class="aka">
              Alias for: <a href="Observation.html#method-i-coordinates_obscured-3F">coordinates_obscured?</a>
            </div>
          

          
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-coordinates_obscured-3F">
            
              <b>coordinates_obscured?</b>()
            
            <a href="../classes/Observation.html#method-i-coordinates_obscured-3F" name="method-i-coordinates_obscured-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          
            <div class="aka">
              Also aliased as: <a href="Observation.html#method-i-coordinates_obscured">coordinates_obscured</a>
            </div>
          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-coordinates_obscured-3F_source')" id="l_method-i-coordinates_obscured-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-coordinates_obscured-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1506</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">coordinates_obscured?</span>
<span class="line-num">1507</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1508</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-coordinates_private-3F">
            
              <b>coordinates_private?</b>()
            
            <a href="../classes/Observation.html#method-i-coordinates_private-3F" name="method-i-coordinates_private-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-coordinates_private-3F_source')" id="l_method-i-coordinates_private-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-coordinates_private-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1511</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">coordinates_private?</span>
<span class="line-num">1512</span>   <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_latitude?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude?</span>
<span class="line-num">1513</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-coordinates_viewable_by-3F">
            
              <b>coordinates_viewable_by?</b>( viewer )
            
            <a href="../classes/Observation.html#method-i-coordinates_viewable_by-3F" name="method-i-coordinates_viewable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-coordinates_viewable_by-3F_source')" id="l_method-i-coordinates_viewable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-coordinates_viewable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1527</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">coordinates_viewable_by?</span>( <span class="ruby-identifier">viewer</span> )
<span class="line-num">1528</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">1529</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1530</span>   <span class="ruby-identifier">viewer</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">viewer</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>)
<span class="line-num">1531</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">viewer</span>
<span class="line-num">1532</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1533</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">trust:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1534</span>   <span class="ruby-identifier">project_ids</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">1535</span>     <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1536</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1537</span>     <span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:project_id</span>)
<span class="line-num">1538</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1539</span>   <span class="ruby-identifier">curated_project_ids</span> = <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">pu</span><span class="ruby-operator">|</span>
<span class="line-num">1540</span>     <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">ROLES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">role</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">project_id</span>
<span class="line-num">1541</span>   }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1542</span>   <span class="ruby-identifier">curated_project_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">curated_project_id</span><span class="ruby-operator">|</span>
<span class="line-num">1543</span>     <span class="ruby-identifier">curator_coordinate_access_allowed_for_traditional</span> = <span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span>
<span class="line-num">1544</span>       <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">curated_project_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">prefers_curator_coordinate_access?</span>
<span class="line-num">1545</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1546</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">curator_coordinate_access_allowed_for_traditional</span>
<span class="line-num">1547</span>       <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">1548</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1549</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1550</span>   <span class="ruby-identifier">cps</span> = <span class="ruby-identifier">collection_projects</span>( <span class="ruby-value">authenticate:</span> <span class="ruby-identifier">viewer</span> ).<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cp</span><span class="ruby-operator">|</span>
<span class="line-num">1551</span>     <span class="ruby-identifier">curated_project_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1552</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1553</span>   <span class="ruby-identifier">curator_coordinate_access_allowed_for_collection</span> = <span class="ruby-identifier">cps</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cp</span><span class="ruby-operator">|</span>
<span class="line-num">1554</span>     <span class="ruby-identifier">pu</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">project_id:</span> <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1555</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">observation_requirements_updated_at</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1556</span>       <span class="ruby-comment"># If we don&#39;t know when it was updated, assume no access</span>
<span class="line-num">1557</span>       <span class="ruby-keyword">false</span>
<span class="line-num">1558</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">observation_requirements_updated_at</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR_COORDINATE_ACCESS_WAIT_PERIOD</span>.<span class="ruby-identifier">ago</span>
<span class="line-num">1559</span>       <span class="ruby-comment"># If we&#39;re still in the wait period, no access</span>
<span class="line-num">1560</span>       <span class="ruby-keyword">false</span>
<span class="line-num">1561</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">cp</span>.<span class="ruby-identifier">prefers_user_trust?</span>
<span class="line-num">1562</span>       <span class="ruby-comment"># If the project isn&#39;t configured to support trust, no access</span>
<span class="line-num">1563</span>       <span class="ruby-keyword">false</span>
<span class="line-num">1564</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pu</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">prefers_curator_coordinate_access_for</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1565</span>         <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">prefers_curator_coordinate_access_for</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR_COORDINATE_ACCESS_FOR_NONE</span>
<span class="line-num">1566</span>       <span class="ruby-comment"># Assuming everything else check&#39;s out, we need to look at the project</span>
<span class="line-num">1567</span>       <span class="ruby-comment"># member&#39;s preferences</span>
<span class="line-num">1568</span>       <span class="ruby-keyword">if</span> <span class="ruby-constant">GEOPRIVACIES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">geoprivacy</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1569</span>           <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">prefers_curator_coordinate_access_for</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR_COORDINATE_ACCESS_FOR_ANY</span>
<span class="line-num">1570</span>         <span class="ruby-keyword">false</span>
<span class="line-num">1571</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-constant">GEOPRIVACIES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon_geoprivacy</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1572</span>           <span class="ruby-operator">!</span>[
<span class="line-num">1573</span>             <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR_COORDINATE_ACCESS_FOR_TAXON</span>,
<span class="line-num">1574</span>             <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR_COORDINATE_ACCESS_FOR_ANY</span>
<span class="line-num">1575</span>           ].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">pu</span>.<span class="ruby-identifier">prefers_curator_coordinate_access_for</span> )
<span class="line-num">1576</span>         <span class="ruby-keyword">false</span>
<span class="line-num">1577</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1578</span>         <span class="ruby-keyword">true</span>
<span class="line-num">1579</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1580</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1581</span>       <span class="ruby-keyword">false</span>
<span class="line-num">1582</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1583</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1584</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">curator_coordinate_access_allowed_for_collection</span>
<span class="line-num">1585</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">1586</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1587</span>   <span class="ruby-keyword">false</span>
<span class="line-num">1588</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_deleted_observation">
            
              <b>create_deleted_observation</b>()
            
            <a href="../classes/Observation.html#method-i-create_deleted_observation" name="method-i-create_deleted_observation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_deleted_observation_source')" id="l_method-i-create_deleted_observation_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_deleted_observation_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2867</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_deleted_observation</span>
<span class="line-num">2868</span>   <span class="ruby-constant">DeletedObservation</span>.<span class="ruby-identifier">create</span>(
<span class="line-num">2869</span>     <span class="ruby-value">:observation_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">id</span>,
<span class="line-num">2870</span>     <span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2871</span>   )
<span class="line-num">2872</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2873</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_observation_review">
            
              <b>create_observation_review</b>()
            
            <a href="../classes/Observation.html#method-i-create_observation_review" name="method-i-create_observation_review" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_observation_review_source')" id="l_method-i-create_observation_review_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_observation_review_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2851</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_observation_review</span>
<span class="line-num">2852</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">2853</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_id_before_last_save</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">transaction_include_any_action?</span>( [<span class="ruby-value">:create</span>] )
<span class="line-num">2854</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">editing_user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">editing_user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2855</span>   <span class="ruby-constant">ObservationReview</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">observation_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">first_or_create</span>.<span class="ruby-identifier">touch</span>
<span class="line-num">2856</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2857</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-date_observed_must_be_before_date_created">
            
              <b>date_observed_must_be_before_date_created</b>()
            
            <a href="../classes/Observation.html#method-i-date_observed_must_be_before_date_created" name="method-i-date_observed_must_be_before_date_created" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-date_observed_must_be_before_date_created_source')" id="l_method-i-date_observed_must_be_before_date_created_source">show</a>
                

                

                
              </p>
              <div id="method-i-date_observed_must_be_before_date_created_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2022</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">date_observed_must_be_before_date_created</span>
<span class="line-num">2023</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2024</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2025</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">editing_user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2026</span>   <span class="ruby-identifier">threshold_date</span> = ( <span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">in_time_zone</span>( <span class="ruby-string">&quot;UTC&quot;</span> ) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> ).<span class="ruby-identifier">to_date</span>
<span class="line-num">2027</span>   <span class="ruby-keyword">if</span> (
<span class="line-num">2028</span>     <span class="ruby-identifier">time_observed_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">in_time_zone</span>( <span class="ruby-string">&quot;UTC&quot;</span> ).<span class="ruby-identifier">to_date</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">threshold_date</span>
<span class="line-num">2029</span>   ) <span class="ruby-operator">||</span> (
<span class="line-num">2030</span>     <span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">in_time_zone</span>( <span class="ruby-string">&quot;UTC&quot;</span> ).<span class="ruby-identifier">to_date</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">threshold_date</span>
<span class="line-num">2031</span>   )
<span class="line-num">2032</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:observed_on</span>, <span class="ruby-value">:cannot_be_greater_than_date_created</span>)
<span class="line-num">2033</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2034</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2035</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-datetime">
            
              <b>datetime</b>()
            
            <a href="../classes/Observation.html#method-i-datetime" name="method-i-datetime" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Return a time from observed_on and time_observed_at</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-datetime_source')" id="l_method-i-datetime_source">show</a>
                

                

                
              </p>
              <div id="method-i-datetime_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">897</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">datetime</span>
<span class="line-num">898</span>   <span class="ruby-ivar">@datetime</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">errors</span>[<span class="ruby-value">:observed_on</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">899</span>     <span class="ruby-identifier">time_observed_at_in_zone</span> <span class="ruby-operator">||</span>
<span class="line-num">900</span>     <span class="ruby-constant">Time</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">year</span>,
<span class="line-num">901</span>              <span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">month</span>,
<span class="line-num">902</span>              <span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">day</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>,
<span class="line-num">903</span>              <span class="ruby-identifier">timezone_offset</span>)
<span class="line-num">904</span>   <span class="ruby-keyword">end</span>
<span class="line-num">905</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-delete_observations_places">
            
              <b>delete_observations_places</b>()
            
            <a href="../classes/Observation.html#method-i-delete_observations_places" name="method-i-delete_observations_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-delete_observations_places_source')" id="l_method-i-delete_observations_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-delete_observations_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2305</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">delete_observations_places</span>
<span class="line-num">2306</span>   <span class="ruby-constant">ObservationsPlace</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">delete_all</span>
<span class="line-num">2307</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-device_name">
            
              <b>device_name</b>()
            
            <a href="../classes/Observation.html#method-i-device_name" name="method-i-device_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-device_name_source')" id="l_method-i-device_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-device_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2742</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">device_name</span>
<span class="line-num">2743</span>   <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;unknown&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user_agent</span>
<span class="line-num">2744</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">ANDROID_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2745</span>     <span class="ruby-string">&quot;iNaturalist Android App&quot;</span>
<span class="line-num">2746</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">FISHTAGGER_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2747</span>     <span class="ruby-string">&quot;Fishtagger iPhone App&quot;</span>
<span class="line-num">2748</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">IPHONE_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2749</span>     <span class="ruby-string">&quot;iNaturalist iPhone App&quot;</span>
<span class="line-num">2750</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2751</span>     <span class="ruby-string">&quot;web browser&quot;</span>
<span class="line-num">2752</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2753</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-device_url">
            
              <b>device_url</b>()
            
            <a href="../classes/Observation.html#method-i-device_url" name="method-i-device_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-device_url_source')" id="l_method-i-device_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-device_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2755</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">device_url</span>
<span class="line-num">2756</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user_agent</span>
<span class="line-num">2757</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">FISHTAGGER_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2758</span>     <span class="ruby-string">&quot;http://itunes.apple.com/us/app/fishtagger/id582724178?mt=8&quot;</span>
<span class="line-num">2759</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">IPHONE_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2760</span>     <span class="ruby-string">&quot;http://itunes.apple.com/us/app/inaturalist/id421397028?mt=8&quot;</span>
<span class="line-num">2761</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">ANDROID_APP_USER_AGENT_PATTERN</span>
<span class="line-num">2762</span>     <span class="ruby-string">&quot;https://market.android.com/details?id=org.inaturalist.android&quot;</span>
<span class="line-num">2763</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2764</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-distinct_taxon">
            
              <b>distinct_taxon</b>()
            
            <a href="../classes/Observation.html#method-i-distinct_taxon" name="method-i-distinct_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-distinct_taxon_source')" id="l_method-i-distinct_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-distinct_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">475</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">distinct_taxon</span>
<span class="line-num">476</span>   <span class="ruby-identifier">group</span>(<span class="ruby-string">&quot;taxon_id&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxon_id IS NOT NULL&quot;</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>)
<span class="line-num">477</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-englishize_month_abbrevs_for_locale">
            
              <b>englishize_month_abbrevs_for_locale</b>(date_string, locale)
            
            <a href="../classes/Observation.html#method-i-englishize_month_abbrevs_for_locale" name="method-i-englishize_month_abbrevs_for_locale" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-englishize_month_abbrevs_for_locale_source')" id="l_method-i-englishize_month_abbrevs_for_locale_source">show</a>
                

                

                
              </p>
              <div id="method-i-englishize_month_abbrevs_for_locale_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1137</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">englishize_month_abbrevs_for_locale</span>(<span class="ruby-identifier">date_string</span>, <span class="ruby-identifier">locale</span>)
<span class="line-num">1138</span>   <span class="ruby-comment"># HACK attempt to translate month abbreviations into English.</span>
<span class="line-num">1139</span>   <span class="ruby-comment"># A much better approach would be add Spanish and any other supported</span>
<span class="line-num">1140</span>   <span class="ruby-comment"># locales to https://github.com/olojac/chronic-l10n and switch to the</span>
<span class="line-num">1141</span>   <span class="ruby-comment"># &#39;localized&#39; branch of Chronic, which seems to clear our test suite.</span>
<span class="line-num">1142</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">date_string</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^en/</span>
<span class="line-num">1143</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">date_string</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">I18N_SUPPORTED_LOCALES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">locale</span>)
<span class="line-num">1144</span>   <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-string">&#39;date.abbr_month_names&#39;</span>, <span class="ruby-value">:locale</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:en</span>).<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">en_month_name</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">1145</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">1146</span>     <span class="ruby-identifier">localized_month_name</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-string">&#39;date.abbr_month_names&#39;</span>, <span class="ruby-value">:locale</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">locale</span>)[<span class="ruby-identifier">i</span>]
<span class="line-num">1147</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">localized_month_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">en_month_name</span>
<span class="line-num">1148</span>     <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/#{localized_month_name}([\s\,])/</span>, <span class="ruby-node">&quot;#{en_month_name}\\1&quot;</span>)
<span class="line-num">1149</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1150</span>   <span class="ruby-identifier">date_string</span>
<span class="line-num">1151</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-faves_count">
            
              <b>faves_count</b>()
            
            <a href="../classes/Observation.html#method-i-faves_count" name="method-i-faves_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-faves_count_source')" id="l_method-i-faves_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-faves_count_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3212</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">faves_count</span>
<span class="line-num">3213</span>   <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_scope</span>.<span class="ruby-identifier">blank?</span>}.<span class="ruby-identifier">size</span>
<span class="line-num">3214</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-fields_addable_by-3F">
            
              <b>fields_addable_by?</b>(u)
            
            <a href="../classes/Observation.html#method-i-fields_addable_by-3F" name="method-i-fields_addable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-fields_addable_by-3F_source')" id="l_method-i-fields_addable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-fields_addable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2895</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">fields_addable_by?</span>(<span class="ruby-identifier">u</span>)
<span class="line-num">2896</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>) 
<span class="line-num">2897</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">preferred_observation_fields_by</span> <span class="ruby-operator">==</span> <span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">PREFERRED_OBSERVATION_FIELDS_BY_ANYONE</span>
<span class="line-num">2898</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">preferred_observation_fields_by</span> <span class="ruby-operator">==</span> <span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">PREFERRED_OBSERVATION_FIELDS_BY_CURATORS</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">is_curator?</span>
<span class="line-num">2899</span>   <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2900</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flagged_with">
            
              <b>flagged_with</b>(flag, options)
            
            <a href="../classes/Observation.html#method-i-flagged_with" name="method-i-flagged_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flagged_with_source')" id="l_method-i-flagged_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-flagged_with_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3201</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flagged_with</span>(<span class="ruby-identifier">flag</span>, <span class="ruby-identifier">options</span>)
<span class="line-num">3202</span>   <span class="ruby-identifier">quality_grade_will_change!</span>
<span class="line-num">3203</span>   <span class="ruby-identifier">save</span>
<span class="line-num">3204</span>   <span class="ruby-identifier">evaluate_new_flag_for_spam</span>(<span class="ruby-identifier">flag</span>)
<span class="line-num">3205</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-geoprivacy_obscured-3F">
            
              <b>geoprivacy_obscured?</b>()
            
            <a href="../classes/Observation.html#method-i-geoprivacy_obscured-3F" name="method-i-geoprivacy_obscured-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-geoprivacy_obscured-3F_source')" id="l_method-i-geoprivacy_obscured-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-geoprivacy_obscured-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1523</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">geoprivacy_obscured?</span>
<span class="line-num">1524</span>   <span class="ruby-identifier">geoprivacy</span> <span class="ruby-operator">==</span> <span class="ruby-constant">OBSCURED</span>
<span class="line-num">1525</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-geoprivacy_private-3F">
            
              <b>geoprivacy_private?</b>()
            
            <a href="../classes/Observation.html#method-i-geoprivacy_private-3F" name="method-i-geoprivacy_private-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-geoprivacy_private-3F_source')" id="l_method-i-geoprivacy_private-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-geoprivacy_private-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1519</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">geoprivacy_private?</span>
<span class="line-num">1520</span>   <span class="ruby-identifier">geoprivacy</span> <span class="ruby-operator">==</span> <span class="ruby-constant">PRIVATE</span>
<span class="line-num">1521</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-georeferenced-3F">
            
              <b>georeferenced?</b>()
            
            <a href="../classes/Observation.html#method-i-georeferenced-3F" name="method-i-georeferenced-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-georeferenced-3F_source')" id="l_method-i-georeferenced-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-georeferenced-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1379</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">georeferenced?</span>
<span class="line-num">1380</span>   (<span class="ruby-operator">!</span><span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">||</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">nil?</span>)
<span class="line-num">1381</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_community_taxon">
            
              <b>get_community_taxon</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-get_community_taxon" name="method-i-get_community_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Community <a href="Taxon.html"><code>Taxon</code></a> #########################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_community_taxon_source')" id="l_method-i-get_community_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_community_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1731</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_community_taxon</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1732</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> (
<span class="line-num">1733</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span>
<span class="line-num">1734</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:current?</span>).<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:persisted?</span>).<span class="ruby-identifier">uniq</span> <span class="ruby-operator">:</span>
<span class="line-num">1735</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>
<span class="line-num">1736</span>   ).<span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">1</span>
<span class="line-num">1737</span>   <span class="ruby-identifier">nodes</span> = <span class="ruby-identifier">community_taxon_nodes</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">1738</span>   <span class="ruby-identifier">node</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:cumulative_count</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>}.<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="line-num">1739</span>     [
<span class="line-num">1740</span>       <span class="ruby-identifier">n</span>[<span class="ruby-value">:score</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">COMMUNITY_TAXON_SCORE_CUTOFF</span> <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-comment"># only consider taxa with a score above the cutoff</span>
<span class="line-num">1741</span>       <span class="ruby-value">0</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">||</span> <span class="ruby-value">500</span>) <span class="ruby-comment"># within that set, sort by rank level, i.e. choose lowest rank</span>
<span class="line-num">1742</span>     ]
<span class="line-num">1743</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">last</span>
<span class="line-num">1744</span>   
<span class="line-num">1745</span>   <span class="ruby-comment"># # Visualizing this stuff is pretty useful for testing, so please leave this in</span>
<span class="line-num">1746</span>   <span class="ruby-comment"># print_community_taxon_nodes( nodes )</span>
<span class="line-num">1747</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
<span class="line-num">1748</span>   <span class="ruby-identifier">node</span>[<span class="ruby-value">:taxon</span>]
<span class="line-num">1749</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_quality_grade">
            
              <b>get_quality_grade</b>()
            
            <a href="../classes/Observation.html#method-i-get_quality_grade" name="method-i-get_quality_grade" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_quality_grade_source')" id="l_method-i-get_quality_grade_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_quality_grade_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1466</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_quality_grade</span>
<span class="line-num">1467</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">research_grade_candidate?</span>
<span class="line-num">1468</span>     <span class="ruby-constant">CASUAL</span>
<span class="line-num">1469</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">voted_in_to_needs_id?</span>
<span class="line-num">1470</span>     <span class="ruby-constant">NEEDS_ID</span>
<span class="line-num">1471</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">community_taxon_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">community_taxon_rejected?</span>
<span class="line-num">1472</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">maverick?</span>
<span class="line-num">1473</span>       <span class="ruby-constant">CASUAL</span>
<span class="line-num">1474</span>     <span class="ruby-keyword">elsif</span> (
<span class="line-num">1475</span>       <span class="ruby-identifier">owners_identification</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1476</span>       <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> (
<span class="line-num">1477</span>         (
<span class="line-num">1478</span>           <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES_LEVEL</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1479</span>           <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1480</span>         ) <span class="ruby-operator">||</span> (
<span class="line-num">1481</span>           <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">FAMILY_LEVEL</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1482</span>           <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1483</span>           <span class="ruby-identifier">voted_out_of_needs_id?</span>
<span class="line-num">1484</span>         )
<span class="line-num">1485</span>       )
<span class="line-num">1486</span>     )
<span class="line-num">1487</span>       <span class="ruby-constant">RESEARCH_GRADE</span>
<span class="line-num">1488</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">voted_out_of_needs_id?</span>
<span class="line-num">1489</span>       <span class="ruby-constant">CASUAL</span>
<span class="line-num">1490</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1491</span>       <span class="ruby-constant">NEEDS_ID</span>
<span class="line-num">1492</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1493</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">community_taxon_at_species_or_lower?</span>
<span class="line-num">1494</span>     <span class="ruby-constant">RESEARCH_GRADE</span>
<span class="line-num">1495</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">community_taxon_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">voted_out_of_needs_id?</span>
<span class="line-num">1496</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">community_taxon_below_family?</span>
<span class="line-num">1497</span>       <span class="ruby-constant">RESEARCH_GRADE</span>
<span class="line-num">1498</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1499</span>       <span class="ruby-constant">CASUAL</span>
<span class="line-num">1500</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1501</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1502</span>     <span class="ruby-constant">NEEDS_ID</span>
<span class="line-num">1503</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1504</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-hide_coordinates">
            
              <b>hide_coordinates</b>()
            
            <a href="../classes/Observation.html#method-i-hide_coordinates" name="method-i-hide_coordinates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-hide_coordinates_source')" id="l_method-i-hide_coordinates_source">show</a>
                

                

                
              </p>
              <div id="method-i-hide_coordinates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1606</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">hide_coordinates</span>
<span class="line-num">1607</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( [<span class="ruby-identifier">geoprivacy</span>, <span class="ruby-identifier">taxon_geoprivacy</span>] <span class="ruby-operator">&amp;</span> [<span class="ruby-constant">OBSCURED</span>, <span class="ruby-constant">PRIVATE</span>] ).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">1608</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_private?</span>
<span class="line-num">1609</span>   <span class="ruby-identifier">obscure_coordinates</span>
<span class="line-num">1610</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = [<span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>]
<span class="line-num">1611</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-human-3F">
            
              <b>human?</b>()
            
            <a href="../classes/Observation.html#method-i-human-3F" name="method-i-human-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-human-3F_source')" id="l_method-i-human-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-human-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1425</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">human?</span>
<span class="line-num">1426</span>   <span class="ruby-identifier">t</span> = <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">1427</span>   <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^Homo /</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Homo&quot;</span> )
<span class="line-num">1428</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-iconic_taxon_name">
            
              <b>iconic_taxon_name</b>()
            
            <a href="../classes/Observation.html#method-i-iconic_taxon_name" name="method-i-iconic_taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-iconic_taxon_name_source')" id="l_method-i-iconic_taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-iconic_taxon_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1703</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">iconic_taxon_name</span>
<span class="line-num">1704</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1705</span> 
<span class="line-num">1706</span>   <span class="ruby-keyword">if</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA_BY_ID</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1707</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">association</span>(<span class="ruby-value">:iconic_taxon</span>).<span class="ruby-identifier">loaded?</span>
<span class="line-num">1708</span>       <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">1709</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1710</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;id, name&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon_id</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">1711</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1712</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1713</span>     <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA_BY_ID</span>[<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon_id</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">1714</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1715</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-image_url">
            
              <b>image_url</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-image_url" name="method-i-image_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-image_url_source')" id="l_method-i-image_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-image_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2353</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">image_url</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">2354</span>   <span class="ruby-identifier">url</span> = <span class="ruby-identifier">observation_image_url</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">size:</span> <span class="ruby-string">&quot;medium&quot;</span>))
<span class="line-num">2355</span>   <span class="ruby-identifier">url</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^http/</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">url</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">2356</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-in_collection_projects-3F">
            
              <b>in_collection_projects?</b>( projects, api_params = {} )
            
            <a href="../classes/Observation.html#method-i-in_collection_projects-3F" name="method-i-in_collection_projects-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-in_collection_projects-3F_source')" id="l_method-i-in_collection_projects-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-in_collection_projects-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3310</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">in_collection_projects?</span>( <span class="ruby-identifier">projects</span>, <span class="ruby-identifier">api_params</span> = {} )
<span class="line-num">3311</span>   <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">project</span><span class="ruby-operator">|</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Project</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">project</span>}.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
<span class="line-num">3312</span>   <span class="ruby-identifier">r</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>(<span class="ruby-node">&quot;/observations/#{id}&quot;</span>, <span class="ruby-identifier">api_params</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">include_new_projects:</span> <span class="ruby-keyword">true</span> ) )
<span class="line-num">3313</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">api_obs</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">results</span>[<span class="ruby-value">0</span>]
<span class="line-num">3314</span>     <span class="ruby-keyword">return</span> ( <span class="ruby-identifier">api_obs</span>[<span class="ruby-string">&quot;non_traditional_projects&quot;</span>] <span class="ruby-operator">||</span> [] ).<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span> <span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">po</span>[<span class="ruby-string">&quot;project&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>].<span class="ruby-identifier">to_i</span> )}
<span class="line-num">3315</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3316</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">3317</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-inaccurate_location-3F">
            
              <b>inaccurate_location?</b>()
            
            <a href="../classes/Observation.html#method-i-inaccurate_location-3F" name="method-i-inaccurate_location-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-inaccurate_location-3F_source')" id="l_method-i-inaccurate_location-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-inaccurate_location-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3032</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">inaccurate_location?</span>
<span class="line-num">3033</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">passes_quality_metric?</span>( <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">LOCATION</span> )
<span class="line-num">3034</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-interpolate_coordinates">
            
              <b>interpolate_coordinates</b>()
            
            <a href="../classes/Observation.html#method-i-interpolate_coordinates" name="method-i-interpolate_coordinates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-interpolate_coordinates_source')" id="l_method-i-interpolate_coordinates_source">show</a>
                

                

                
              </p>
              <div id="method-i-interpolate_coordinates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3108</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interpolate_coordinates</span>
<span class="line-num">3109</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_observed_at</span>
<span class="line-num">3110</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;latitude IS NOT NULL or private_latitude IS NOT NULL&quot;</span>)
<span class="line-num">3111</span>   <span class="ruby-identifier">prev_obs</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;time_observed_at &lt; ?&quot;</span>, <span class="ruby-identifier">time_observed_at</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;time_observed_at DESC&quot;</span>).<span class="ruby-identifier">first</span>
<span class="line-num">3112</span>   <span class="ruby-identifier">next_obs</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;time_observed_at &gt; ?&quot;</span>, <span class="ruby-identifier">time_observed_at</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;time_observed_at ASC&quot;</span>).<span class="ruby-identifier">first</span>
<span class="line-num">3113</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">prev_obs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">next_obs</span>
<span class="line-num">3114</span>   <span class="ruby-identifier">prev_lat</span> = <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">latitude</span>
<span class="line-num">3115</span>   <span class="ruby-identifier">prev_lon</span> = <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">longitude</span>
<span class="line-num">3116</span>   <span class="ruby-identifier">next_lat</span> = <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">latitude</span>
<span class="line-num">3117</span>   <span class="ruby-identifier">next_lon</span> = <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">longitude</span>
<span class="line-num">3118</span> 
<span class="line-num">3119</span>   <span class="ruby-comment"># time-weighted interpolation between prev and next observations</span>
<span class="line-num">3120</span>   <span class="ruby-identifier">weight</span> = (<span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">time_observed_at</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">time_observed_at</span>) <span class="ruby-operator">/</span> (<span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">time_observed_at</span><span class="ruby-operator">-</span><span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">time_observed_at</span>)
<span class="line-num">3121</span>   <span class="ruby-identifier">new_lat</span> = (<span class="ruby-value">1</span><span class="ruby-operator">-</span><span class="ruby-identifier">weight</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">next_lat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">*</span><span class="ruby-identifier">prev_lat</span>
<span class="line-num">3122</span>   <span class="ruby-identifier">new_lon</span> = (<span class="ruby-value">1</span><span class="ruby-operator">-</span><span class="ruby-identifier">weight</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">next_lon</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">*</span><span class="ruby-identifier">prev_lon</span>
<span class="line-num">3123</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">new_lat</span>
<span class="line-num">3124</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">new_lon</span>
<span class="line-num">3125</span> 
<span class="line-num">3126</span>   <span class="ruby-comment"># we can only set a new uncertainty if the uncertainty of the two points are known</span>
<span class="line-num">3127</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">positional_accuracy</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">positional_accuracy</span>
<span class="line-num">3128</span>     <span class="ruby-identifier">f</span> = <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">Geographic</span>.<span class="ruby-identifier">simple_mercator_factory</span>
<span class="line-num">3129</span>     <span class="ruby-identifier">prev_point</span> = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">point</span>(<span class="ruby-identifier">prev_lon</span>, <span class="ruby-identifier">prev_lat</span>)
<span class="line-num">3130</span>     <span class="ruby-identifier">next_point</span> = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">point</span>(<span class="ruby-identifier">next_lon</span>, <span class="ruby-identifier">next_lat</span>)
<span class="line-num">3131</span>     <span class="ruby-identifier">interpolation_uncertainty</span> = <span class="ruby-identifier">prev_point</span>.<span class="ruby-identifier">distance</span>(<span class="ruby-identifier">next_point</span>)<span class="ruby-operator">/</span><span class="ruby-value">2.0</span>
<span class="line-num">3132</span>     <span class="ruby-identifier">new_acc</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sqrt</span>(<span class="ruby-identifier">interpolation_uncertainty</span><span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">prev_obs</span>.<span class="ruby-identifier">positional_accuracy</span><span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">next_obs</span>.<span class="ruby-identifier">positional_accuracy</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)
<span class="line-num">3133</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">positional_accuracy</span> = <span class="ruby-identifier">new_acc</span>
<span class="line-num">3134</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3135</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-intersecting_places">
            
              <b>intersecting_places</b>()
            
            <a href="../classes/Observation.html#method-i-intersecting_places" name="method-i-intersecting_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-intersecting_places_source')" id="l_method-i-intersecting_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-intersecting_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2674</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">intersecting_places</span>
<span class="line-num">2675</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2676</span>   <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude</span>
<span class="line-num">2677</span>   <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude</span>
<span class="line-num">2678</span>   <span class="ruby-ivar">@intersecting_places</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Place</span>.<span class="ruby-identifier">containing_lat_lng</span>(<span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>).<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_area</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>}
<span class="line-num">2679</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-keep_old_taxon_id">
            
              <b>keep_old_taxon_id</b>()
            
            <a href="../classes/Observation.html#method-i-keep_old_taxon_id" name="method-i-keep_old_taxon_id" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Preserve the old taxon id if the taxon has changed so we know to update that taxon in the user&#39;s lists after_save</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-keep_old_taxon_id_source')" id="l_method-i-keep_old_taxon_id_source">show</a>
                

                

                
              </p>
              <div id="method-i-keep_old_taxon_id_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1247</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">keep_old_taxon_id</span>
<span class="line-num">1248</span>   <span class="ruby-ivar">@old_observation_taxon_id</span> = <span class="ruby-identifier">taxon_id_was</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id_changed?</span>
<span class="line-num">1249</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1250</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-lat_lon_in_place_guess-3F">
            
              <b>lat_lon_in_place_guess?</b>()
            
            <a href="../classes/Observation.html#method-i-lat_lon_in_place_guess-3F" name="method-i-lat_lon_in_place_guess-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-lat_lon_in_place_guess-3F_source')" id="l_method-i-lat_lon_in_place_guess-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-lat_lon_in_place_guess-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1686</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lat_lon_in_place_guess?</span>
<span class="line-num">1687</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp">/[a-cf-mo-rt-vx-z]/i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-constant">COORDINATE_REGEX</span>).<span class="ruby-identifier">blank?</span>
<span class="line-num">1688</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-license_code-3D">
            
              <b>license_code=</b>( license_code )
            
            <a href="../classes/Observation.html#method-i-license_code-3D" name="method-i-license_code-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-license_code-3D_source')" id="l_method-i-license_code-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-license_code-3D_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2199</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">license_code=</span>( <span class="ruby-identifier">license_code</span> )
<span class="line-num">2200</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">license</span> = <span class="ruby-identifier">license_code</span>
<span class="line-num">2201</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-license_name">
            
              <b>license_name</b>()
            
            <a href="../classes/Observation.html#method-i-license_name" name="method-i-license_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <pre><code># MASS_ASSIGNABLE_ATTRIBUTES.each do |a|
#   self.send(&quot;#{a}=&quot;, attributes.delete(a.to_s)) if attributes.has_key?(a.to_s)
#   self.send(&quot;#{a}=&quot;, attributes.delete(a)) if attributes.has_key?(a)
# end
super(attributes)
</code></pre>

<p>end</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-license_name_source')" id="l_method-i-license_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-license_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2338</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">license_name</span>
<span class="line-num">2339</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2340</span>   <span class="ruby-identifier">s</span> = <span class="ruby-string">&quot;Creative Commons &quot;</span>
<span class="line-num">2341</span>   <span class="ruby-identifier">s</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">LICENSES</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">license</span>}.<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>
<span class="line-num">2342</span>   <span class="ruby-identifier">s</span>
<span class="line-num">2343</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mark_as_updated">
            
              <b>mark_as_updated</b>()
            
            <a href="../classes/Observation.html#method-i-mark_as_updated" name="method-i-mark_as_updated" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>this method will set the updated_at column on this observation to the current time, and re-index only the updated_at attribute of the observation doc in Elasticsearch</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mark_as_updated_source')" id="l_method-i-mark_as_updated_source">show</a>
                

                

                
              </p>
              <div id="method-i-mark_as_updated_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3378</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mark_as_updated</span>
<span class="line-num">3379</span>   <span class="ruby-identifier">updated_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">3380</span>   <span class="ruby-identifier">update_column</span>( <span class="ruby-value">:updated_at</span>, <span class="ruby-identifier">updated_time</span> )
<span class="line-num">3381</span>   <span class="ruby-identifier">try_and_try_again</span>( <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">Conflict</span>, <span class="ruby-value">sleep:</span> <span class="ruby-value">1</span>, <span class="ruby-value">tries:</span> <span class="ruby-value">10</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">3382</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">__elasticsearch__</span>.<span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_by_query</span>(
<span class="line-num">3383</span>       <span class="ruby-value">index:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">index_name</span>,
<span class="line-num">3384</span>       <span class="ruby-value">refresh:</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span>,
<span class="line-num">3385</span>       <span class="ruby-value">body:</span> {
<span class="line-num">3386</span>         <span class="ruby-value">query:</span> {
<span class="line-num">3387</span>           <span class="ruby-value">term:</span> {
<span class="line-num">3388</span>             <span class="ruby-value">&quot;id&quot;:</span> <span class="ruby-identifier">id</span>
<span class="line-num">3389</span>           }
<span class="line-num">3390</span>         },
<span class="line-num">3391</span>         <span class="ruby-value">script:</span> {
<span class="line-num">3392</span>           <span class="ruby-value">source:</span> <span class="ruby-string">&quot;ctx._source.updated_at = params.updated_time&quot;</span>,
<span class="line-num">3393</span>           <span class="ruby-value">params:</span> {
<span class="line-num">3394</span>             <span class="ruby-value">updated_time:</span> <span class="ruby-identifier">updated_time</span>
<span class="line-num">3395</span>           }
<span class="line-num">3396</span>         }
<span class="line-num">3397</span>       }
<span class="line-num">3398</span>     )
<span class="line-num">3399</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3400</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mentioned_users">
            
              <b>mentioned_users</b>()
            
            <a href="../classes/Observation.html#method-i-mentioned_users" name="method-i-mentioned_users" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mentioned_users_source')" id="l_method-i-mentioned_users_source">show</a>
                

                

                
              </p>
              <div id="method-i-mentioned_users_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3207</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mentioned_users</span>
<span class="line-num">3208</span>   <span class="ruby-keyword">return</span> [ ] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">description</span>
<span class="line-num">3209</span>   <span class="ruby-identifier">description</span>.<span class="ruby-identifier">mentioned_users</span>
<span class="line-num">3210</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-merge">
            
              <b>merge</b>(reject, options = {})
            
            <a href="../classes/Observation.html#method-i-merge" name="method-i-merge" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-merge_source')" id="l_method-i-merge_source">show</a>
                

                

                
              </p>
              <div id="method-i-merge_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2830</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">merge</span>(<span class="ruby-identifier">reject</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">2831</span>   <span class="ruby-identifier">mutable_columns</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">column_names</span> <span class="ruby-operator">-</span> <span class="ruby-node">%w(id created_at updated_at uuid)</span>
<span class="line-num">2832</span>   <span class="ruby-identifier">mutable_columns</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">column</span><span class="ruby-operator">|</span>
<span class="line-num">2833</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{column}=&quot;</span>, <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">column</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">send</span>(<span class="ruby-identifier">column</span>).<span class="ruby-identifier">blank?</span>
<span class="line-num">2834</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2835</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_identifications</span>]
<span class="line-num">2836</span>     <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">delete_all</span>
<span class="line-num">2837</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2838</span>     <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-string">&quot;current = false&quot;</span>)
<span class="line-num">2839</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2840</span>   <span class="ruby-identifier">merge_has_many_associations</span>(<span class="ruby-identifier">reject</span>)
<span class="line-num">2841</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">2842</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_identifications</span>]
<span class="line-num">2843</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">group_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">ident</span>.<span class="ruby-identifier">user_id</span>, <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon_id</span>]}.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pair</span>, <span class="ruby-identifier">idents</span><span class="ruby-operator">|</span>
<span class="line-num">2844</span>       <span class="ruby-identifier">c</span> = <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">last</span>
<span class="line-num">2845</span>       <span class="ruby-identifier">c</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:current</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">2846</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2847</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2848</span>   <span class="ruby-identifier">save!</span>
<span class="line-num">2849</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-method_missing">
            
              <b>method_missing</b>(method, *args, &amp;block)
            
            <a href="../classes/Observation.html#method-i-method_missing" name="method-i-method_missing" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-method_missing_source')" id="l_method-i-method_missing_source">show</a>
                

                

                
              </p>
              <div id="method-i-method_missing_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2787</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">2788</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^field:/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^taxon_[^=]+/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^ident_by_/</span>
<span class="line-num">2789</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^field:/</span>
<span class="line-num">2790</span>     <span class="ruby-identifier">of_name</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">normalize_name</span>( <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-regexp">/^field\:(.+)/</span>, <span class="ruby-value">1</span>] )
<span class="line-num">2791</span>     <span class="ruby-identifier">ofv</span> = <span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ofv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">observation_field</span>.<span class="ruby-identifier">normalized_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">of_name</span>}
<span class="line-num">2792</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ofv</span>
<span class="line-num">2793</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">value</span>
<span class="line-num">2794</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2795</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^taxon_/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">instance_methods</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">2796</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^taxon_/</span>, <span class="ruby-string">&#39;&#39;</span>))
<span class="line-num">2797</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^ident_by_/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">instance_methods</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">method</span> )
<span class="line-num">2798</span>     <span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-regexp">/ident_by_([^\:]+)/</span>, <span class="ruby-value">1</span>]
<span class="line-num">2799</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2800</span>     <span class="ruby-identifier">ident</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">2801</span>       <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">to_i</span> }
<span class="line-num">2802</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2803</span>       <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">login</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> }
<span class="line-num">2804</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2805</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>
<span class="line-num">2806</span>     <span class="ruby-identifier">ident_method</span> = <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-regexp">/ident_by_([^\:]+)\:(.+)/</span>, <span class="ruby-value">2</span>]
<span class="line-num">2807</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident_method</span>
<span class="line-num">2808</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">ident_method</span> )
<span class="line-num">2809</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2810</span>   <span class="ruby-keyword">super</span>
<span class="line-num">2811</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mobile-3F">
            
              <b>mobile?</b>()
            
            <a href="../classes/Observation.html#method-i-mobile-3F" name="method-i-mobile-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mobile-3F_source')" id="l_method-i-mobile-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-mobile-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2734</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mobile?</span>
<span class="line-num">2735</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user_agent</span>
<span class="line-num">2736</span>   <span class="ruby-constant">MOBILE_APP_USER_AGENT_PATTERNS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pattern</span><span class="ruby-operator">|</span>
<span class="line-num">2737</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">pattern</span>
<span class="line-num">2738</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2739</span>   <span class="ruby-keyword">false</span>
<span class="line-num">2740</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-munge_observed_on_with_chronic">
            
              <b>munge_observed_on_with_chronic</b>( debug = false )
            
            <a href="../classes/Observation.html#method-i-munge_observed_on_with_chronic" name="method-i-munge_observed_on_with_chronic" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Set all the time fields based on the contents of observed_on_string</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-munge_observed_on_with_chronic_source')" id="l_method-i-munge_observed_on_with_chronic_source">show</a>
                

                

                
              </p>
              <div id="method-i-munge_observed_on_with_chronic_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num"> 928</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">munge_observed_on_with_chronic</span>( <span class="ruby-identifier">debug</span> = <span class="ruby-keyword">false</span> )
<span class="line-num"> 929</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 930</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on</span> = <span class="ruby-keyword">nil</span>
<span class="line-num"> 931</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span> = <span class="ruby-keyword">nil</span>
<span class="line-num"> 932</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num"> 933</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 934</span>   <span class="ruby-comment"># Only re-interpret the date if observed_on_string or time_zone changed</span>
<span class="line-num"> 935</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observed_on_string_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">time_zone_changed?</span>
<span class="line-num"> 936</span>   <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">strip</span>
<span class="line-num"> 937</span>   <span class="ruby-identifier">tz_abbrev_pattern</span> = <span class="ruby-regexp">/\s\(?([A-Z]{3,})\)?$/</span> <span class="ruby-comment"># ends with (PDT)</span>
<span class="line-num"> 938</span>   <span class="ruby-identifier">tz_offset_pattern</span> = <span class="ruby-regexp">/([+-]\d{4})$/</span> <span class="ruby-comment"># contains -0800</span>
<span class="line-num"> 939</span>   <span class="ruby-identifier">tz_js_offset_pattern</span> = <span class="ruby-regexp">/(GMT)?([+-]\d{4})/</span> <span class="ruby-comment"># contains GMT-0800</span>
<span class="line-num"> 940</span>   <span class="ruby-identifier">tz_colon_offset_pattern</span> = <span class="ruby-regexp">/(GMT|HSP)([+-]\d+:\d+)/</span> <span class="ruby-comment"># contains (GMT-08:00)</span>
<span class="line-num"> 941</span>   <span class="ruby-identifier">tz_moment_offset_pattern</span> = <span class="ruby-regexp">/\s([+-]\d{2})$/</span> <span class="ruby-comment"># contains -08, +05, etc.</span>
<span class="line-num"> 942</span>   <span class="ruby-identifier">tz_failed_abbrev_pattern</span> = <span class="ruby-regexp">/\(#{tz_colon_offset_pattern}\)/</span>
<span class="line-num"> 943</span>   
<span class="line-num"> 944</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">date_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/#{tz_js_offset_pattern} #{tz_failed_abbrev_pattern}/</span>
<span class="line-num"> 945</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">tz_failed_abbrev_pattern</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">strip</span>
<span class="line-num"> 946</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 947</span> 
<span class="line-num"> 948</span>   <span class="ruby-identifier">tz_abbrev</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_abbrev_pattern</span>, <span class="ruby-value">1</span>]
<span class="line-num"> 949</span> 
<span class="line-num"> 950</span>   <span class="ruby-comment"># Rails timezone support doesn&#39;t seem to recognize this abbreviation, and</span>
<span class="line-num"> 951</span>   <span class="ruby-comment"># frankly I have no idea where ActiveSupport::TimeZone::CODES comes from.</span>
<span class="line-num"> 952</span>   <span class="ruby-comment"># In case that ever stops working or a less hackish solution is required,</span>
<span class="line-num"> 953</span>   <span class="ruby-comment"># check out https://gist.github.com/kueda/3e6f77f64f792b4f119f</span>
<span class="line-num"> 954</span>   <span class="ruby-identifier">tz_abbrev</span> = <span class="ruby-string">&#39;CET&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tz_abbrev</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;CEST&#39;</span>
<span class="line-num"> 955</span> 
<span class="line-num"> 956</span>   <span class="ruby-comment"># Abbreviations with synonyms at https://en.wikipedia.org/wiki/List_of_time_zone_abbreviations</span>
<span class="line-num"> 957</span>   <span class="ruby-identifier">problem_tz_abbrevs</span> = <span class="ruby-node">%w(
<span class="line-num"> 958</span>     AST
<span class="line-num"> 959</span>     BRT
<span class="line-num"> 960</span>     BST
<span class="line-num"> 961</span>     CDT
<span class="line-num"> 962</span>     CST
<span class="line-num"> 963</span>     ECT
<span class="line-num"> 964</span>     GST
<span class="line-num"> 965</span>     IST
<span class="line-num"> 966</span>   )</span>
<span class="line-num"> 967</span>   
<span class="line-num"> 968</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">iso8601_datetime</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">iso8601</span>( <span class="ruby-identifier">observed_on_string</span> ) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span> )
<span class="line-num"> 969</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">observed_on_string</span>
<span class="line-num"> 970</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[+-]\d{2}:?\d{2}/</span>
<span class="line-num"> 971</span>       <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">iso8601_datetime</span>.<span class="ruby-identifier">offset</span> <span class="ruby-operator">*</span> <span class="ruby-value">24</span>]
<span class="line-num"> 972</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 973</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">CODES</span>[<span class="ruby-identifier">tz_abbrev</span>] <span class="ruby-operator">||</span>
<span class="line-num"> 974</span>       <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">CODES</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tz_abbrev</span>} )
<span class="line-num"> 975</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">tz_abbrev_pattern</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num"> 976</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">tz_js_offset_pattern</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">strip</span>
<span class="line-num"> 977</span>     <span class="ruby-comment"># If the parsed time zone is one of the ambiguous ones where we can&#39;t</span>
<span class="line-num"> 978</span>     <span class="ruby-comment"># really know which one they&#39;re referring too, don&#39;t actually use the zone</span>
<span class="line-num"> 979</span>     <span class="ruby-comment"># code we parsed out of the string</span>
<span class="line-num"> 980</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">problem_tz_abbrevs</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">tz_abbrev</span> )
<span class="line-num"> 981</span>       <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-keyword">nil</span>
<span class="line-num"> 982</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 983</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_abbrev_pattern: #{tz_abbrev}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num"> 984</span>   <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_offset_pattern</span>, <span class="ruby-value">1</span>]) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 985</span>       (<span class="ruby-identifier">n</span> = <span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-value">100</span>) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 986</span>       (<span class="ruby-identifier">key</span> = <span class="ruby-identifier">n</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">floor</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">n</span><span class="ruby-operator">%</span><span class="ruby-identifier">n</span>.<span class="ruby-identifier">floor</span>)<span class="ruby-operator">/</span><span class="ruby-value">0.6</span>) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 987</span>       (<span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">key</span>])
<span class="line-num"> 988</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_offset_pattern: #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num"> 989</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">tz_offset_pattern</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num"> 990</span>   <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_js_offset_pattern</span>, <span class="ruby-value">2</span>]) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 991</span>       (<span class="ruby-identifier">n</span> = <span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-value">100</span>) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 992</span>       (<span class="ruby-identifier">key</span> = <span class="ruby-identifier">n</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">floor</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">n</span><span class="ruby-operator">%</span><span class="ruby-identifier">n</span>.<span class="ruby-identifier">floor</span>)<span class="ruby-operator">/</span><span class="ruby-value">0.6</span>) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num"> 993</span>       (<span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">key</span>])
<span class="line-num"> 994</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">tz_js_offset_pattern</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num"> 995</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+/i</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num"> 996</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_js_offset_pattern: #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num"> 997</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_colon_offset_pattern</span>, <span class="ruby-value">2</span>] ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num"> 998</span>       ( <span class="ruby-identifier">t</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">offset</span> ) ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num"> 999</span>       ( <span class="ruby-identifier">negpos</span> = <span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">-1</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1000</span>       ( <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">negpos</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">hour</span><span class="ruby-operator">+</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">min</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span>] )
<span class="line-num">1001</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/#{tz_colon_offset_pattern}|#{tz_failed_abbrev_pattern}/</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num">1002</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_colon_offset_pattern: #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1003</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_moment_offset_pattern</span>, <span class="ruby-value">1</span>] ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1004</span>       ( <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_i</span>] )
<span class="line-num">1005</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-identifier">tz_moment_offset_pattern</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1006</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_moment_offset_pattern: #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1007</span>   <span class="ruby-comment"># Dumb hack for Adelaide&#39;s half hour time zone offset</span>
<span class="line-num">1008</span>   <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_js_offset_pattern</span>, <span class="ruby-value">2</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-node">%w(+0930 +1030)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">offset</span> )
<span class="line-num">1009</span>     <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-string">&quot;Australia/Adelaide&quot;</span>]
<span class="line-num">1010</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-identifier">tz_js_offset_pattern</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1011</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-regexp">/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+/i</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1012</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\(.+\)/</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1013</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_js_offset_pattern (Adelaide): #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1014</span>   <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">offset</span> = <span class="ruby-identifier">date_string</span>[<span class="ruby-identifier">tz_colon_offset_pattern</span>, <span class="ruby-value">2</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-node">%w(+09:30 +10:30)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">offset</span> )
<span class="line-num">1015</span>     <span class="ruby-identifier">parsed_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-string">&quot;Australia/Adelaide&quot;</span>]
<span class="line-num">1016</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-identifier">tz_colon_offset_pattern</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1017</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-regexp">/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+/i</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1018</span>     <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\(.+\)/</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">1019</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;matched tz_colon_offset_pattern (Adelaide): #{offset}, parsed_time_zone: #{parsed_time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1020</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1021</span>   
<span class="line-num">1022</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">parsed_time_zone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observed_on_string_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">georeferenced?</span>
<span class="line-num">1023</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-identifier">parsed_time_zone</span>.<span class="ruby-identifier">name</span>
<span class="line-num">1024</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">1025</span>       <span class="ruby-keyword">if</span> (
<span class="line-num">1026</span>         ( <span class="ruby-identifier">user_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">user</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:time_zone</span>)] ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1027</span>         <span class="ruby-identifier">user_time_zone</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">parsed_time_zone</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1028</span>         <span class="ruby-identifier">user_time_zone</span>.<span class="ruby-identifier">utc_offset</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">parsed_time_zone</span>.<span class="ruby-identifier">utc_offset</span>
<span class="line-num">1029</span>       )
<span class="line-num">1030</span>         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;assigning user.time_zone: #{user.time_zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1031</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span>
<span class="line-num">1032</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1033</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1034</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/offset/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/invalid argument to TimeZone/</span>
<span class="line-num">1035</span>       <span class="ruby-comment"># This means the user didn&#39;t have a time zone or had a time zone that</span>
<span class="line-num">1036</span>       <span class="ruby-comment"># shouldn&#39;t exist, so just ignore it</span>
<span class="line-num">1037</span>       <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Invalid time zone, ignoring&quot;</span>
<span class="line-num">1038</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1039</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1040</span>   
<span class="line-num">1041</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&#39;T&#39;</span>, <span class="ruby-string">&#39; &#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">date_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\d{4}-\d{2}-\d{2}T/</span>
<span class="line-num">1042</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/(\d{2}:\d{2}:\d{2})\.\d+/</span>, <span class="ruby-string">&#39;\\1&#39;</span>)
<span class="line-num">1043</span>   
<span class="line-num">1044</span>   <span class="ruby-comment"># strip leading month if present</span>
<span class="line-num">1045</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/^[A-z]{3} ([A-z]{3})/</span>, <span class="ruby-string">&#39;\\1&#39;</span>)
<span class="line-num">1046</span> 
<span class="line-num">1047</span>   <span class="ruby-comment"># strip paranthesized stuff</span>
<span class="line-num">1048</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/\(.*\)/</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num">1049</span> 
<span class="line-num">1050</span>   <span class="ruby-comment"># strip noon hour madness</span>
<span class="line-num">1051</span>   <span class="ruby-comment"># this is due to a weird, weird bug in Chronic</span>
<span class="line-num">1052</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">date_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/p\.?m\.?/i</span>
<span class="line-num">1053</span>     <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">gsub!</span>( <span class="ruby-regexp">/( 12:(\d\d)(:\d\d)?)\s+?p\.?m\.?/i</span>, <span class="ruby-string">&#39;\\1&#39;</span>)
<span class="line-num">1054</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">date_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/a\.?m\.?/i</span>
<span class="line-num">1055</span>     <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">gsub!</span>( <span class="ruby-regexp">/( 12:(\d\d)(:\d\d)?)\s+?a\.?m\.?/i</span>, <span class="ruby-string">&#39;\\1&#39;</span>)
<span class="line-num">1056</span>     <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">gsub!</span>( <span class="ruby-regexp">/ 12:/</span>, <span class="ruby-string">&quot; 00:&quot;</span> )
<span class="line-num">1057</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1058</span> 
<span class="line-num">1059</span>   <span class="ruby-comment"># Translate am/pm into English for parsing. This is a pretty conservative</span>
<span class="line-num">1060</span>   <span class="ruby-comment"># solution to a complicated problem. Assumes AM/PM is at the end of the</span>
<span class="line-num">1061</span>   <span class="ruby-comment"># string and preceeded by a space, or in the middle but followed by a space</span>
<span class="line-num">1062</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>( <span class="ruby-regexp">/\s#{I18n.t( &quot;time.am&quot; )}$/i</span>, <span class="ruby-string">&quot; AM&quot;</span> )
<span class="line-num">1063</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>( <span class="ruby-regexp">/\s#{I18n.t( &quot;time.am&quot; )}\s/i</span>, <span class="ruby-string">&quot; AM &quot;</span> )
<span class="line-num">1064</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>( <span class="ruby-regexp">/\s#{I18n.t( &quot;time.pm&quot; )}$/i</span>, <span class="ruby-string">&quot; PM&quot;</span> )
<span class="line-num">1065</span>   <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">sub!</span>( <span class="ruby-regexp">/\s#{I18n.t( &quot;time.pm&quot; )}\s/i</span>, <span class="ruby-string">&quot; PM &quot;</span> )
<span class="line-num">1066</span>   
<span class="line-num">1067</span>   <span class="ruby-comment"># Set the time zone appropriately</span>
<span class="line-num">1068</span>   <span class="ruby-identifier">old_time_zone</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>
<span class="line-num">1069</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1070</span>     <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span> = <span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:time_zone</span>)
<span class="line-num">1071</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span>
<span class="line-num">1072</span>     <span class="ruby-comment"># Usually this would happen b/c of an invalid time zone being specified</span>
<span class="line-num">1073</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-identifier">time_zone_was</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">old_time_zone</span>.<span class="ruby-identifier">name</span>
<span class="line-num">1074</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1075</span>   <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Setting Chronic time_class to #{Time.zone}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1076</span>   <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">time_class</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>
<span class="line-num">1077</span>   
<span class="line-num">1078</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1079</span>     <span class="ruby-comment"># Start parsing...</span>
<span class="line-num">1080</span>     <span class="ruby-identifier">t</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">1081</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Parsing #{date_string}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1082</span>       <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date_string</span>, <span class="ruby-value">context:</span> <span class="ruby-value">:past</span> )
<span class="line-num">1083</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span>
<span class="line-num">1084</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">1085</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1086</span>     <span class="ruby-identifier">t</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">split</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39; &#39;</span>), <span class="ruby-value">context:</span> <span class="ruby-value">:past</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> 
<span class="line-num">1087</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">locale</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">locale</span> <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>)
<span class="line-num">1088</span>       <span class="ruby-identifier">date_string</span> = <span class="ruby-identifier">englishize_month_abbrevs_for_locale</span>(<span class="ruby-identifier">date_string</span>, <span class="ruby-identifier">locale</span>)
<span class="line-num">1089</span>       <span class="ruby-identifier">t</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date_string</span>, <span class="ruby-value">context:</span> <span class="ruby-value">:past</span> )
<span class="line-num">1090</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1091</span> 
<span class="line-num">1092</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>
<span class="line-num">1093</span>       <span class="ruby-constant">I18N_SUPPORTED_LOCALES</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">locale</span><span class="ruby-operator">|</span>
<span class="line-num">1094</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^en.*/</span>
<span class="line-num">1095</span>         <span class="ruby-identifier">new_date_string</span> = <span class="ruby-identifier">englishize_month_abbrevs_for_locale</span>(<span class="ruby-identifier">date_string</span>, <span class="ruby-identifier">locale</span>)
<span class="line-num">1096</span>         <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">new_date_string</span>, <span class="ruby-value">context:</span> <span class="ruby-value">:past</span> )
<span class="line-num">1097</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1098</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1099</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span>
<span class="line-num">1100</span>   
<span class="line-num">1101</span>     <span class="ruby-comment"># Re-interpret future dates as being in the past</span>
<span class="line-num">1102</span>     <span class="ruby-identifier">t</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date_string</span>, <span class="ruby-value">context:</span> <span class="ruby-value">:past</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">1103</span>     
<span class="line-num">1104</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>
<span class="line-num">1105</span>     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Set observed_on to #{observed_on}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1106</span>   
<span class="line-num">1107</span>     <span class="ruby-comment"># try to determine if the user specified a time by ask Chronic to return</span>
<span class="line-num">1108</span>     <span class="ruby-comment"># a time range. Time ranges less than a day probably specified a time.</span>
<span class="line-num">1109</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">tspan</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">date_string</span>, <span class="ruby-value">context:</span> <span class="ruby-value">:past</span>, <span class="ruby-value">guess:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">1110</span>       <span class="ruby-comment"># If tspan is less than a day and the string wasn&#39;t &#39;today&#39;, set time</span>
<span class="line-num">1111</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">tspan</span>.<span class="ruby-identifier">width</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">86400</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date_string</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;today&#39;</span>
<span class="line-num">1112</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span> = <span class="ruby-identifier">t</span>
<span class="line-num">1113</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1114</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1115</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1116</span>       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Set time_observed_at to #{time_observed_at}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
<span class="line-num">1117</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1118</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-constant">ArgumentError</span>
<span class="line-num">1119</span>     <span class="ruby-comment"># ignore these, just don&#39;t set the date</span>
<span class="line-num">1120</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">1121</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1122</span>   
<span class="line-num">1123</span>   <span class="ruby-comment"># don&#39;t store relative observed_on_strings, or they will change</span>
<span class="line-num">1124</span>   <span class="ruby-comment"># every time you save an observation!</span>
<span class="line-num">1125</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">date_string</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/today|yesterday|ago|last|this|now|monday|tuesday|wednesday|thursday|friday|saturday|sunday/i</span>
<span class="line-num">1126</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on_string</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">1127</span>     <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span>
<span class="line-num">1128</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on_string</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)
<span class="line-num">1129</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1130</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1131</span>   
<span class="line-num">1132</span>   <span class="ruby-comment"># Set the time zone back the way it was</span>
<span class="line-num">1133</span>   <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span> = <span class="ruby-identifier">old_time_zone</span>
<span class="line-num">1134</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1135</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-must_be_in_the_past">
            
              <b>must_be_in_the_past</b>()
            
            <a href="../classes/Observation.html#method-i-must_be_in_the_past" name="method-i-must_be_in_the_past" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <pre><code>Validations #########################################################
</code></pre>

<p>Make sure the observation is not in the future.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-must_be_in_the_past_source')" id="l_method-i-must_be_in_the_past_source">show</a>
                

                

                
              </p>
              <div id="method-i-must_be_in_the_past_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2014</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">must_be_in_the_past</span>
<span class="line-num">2015</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2016</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span>).<span class="ruby-identifier">to_date</span>
<span class="line-num">2017</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:observed_on</span>, <span class="ruby-string">&quot;can&#39;t be in the future&quot;</span>)
<span class="line-num">2018</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2019</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2020</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-must_not_be_a_range">
            
              <b>must_not_be_a_range</b>()
            
            <a href="../classes/Observation.html#method-i-must_not_be_a_range" name="method-i-must_not_be_a_range" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Make sure the observation resolves to a single day.  Right now we don&#39;t store ambiguity…</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-must_not_be_a_range_source')" id="l_method-i-must_not_be_a_range_source">show</a>
                

                

                
              </p>
              <div id="method-i-must_not_be_a_range_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2041</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">must_not_be_a_range</span>
<span class="line-num">2042</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2043</span>   
<span class="line-num">2044</span>   <span class="ruby-identifier">is_a_range</span> = <span class="ruby-keyword">false</span>
<span class="line-num">2045</span>   <span class="ruby-keyword">begin</span>  
<span class="line-num">2046</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">tspan</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">observed_on_string</span>, <span class="ruby-value">:context</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:past</span>, <span class="ruby-value">:guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>)
<span class="line-num">2047</span>       <span class="ruby-identifier">is_a_range</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tspan</span>.<span class="ruby-identifier">width</span>.<span class="ruby-identifier">seconds</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">seconds</span>
<span class="line-num">2048</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2049</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-constant">ArgumentError</span>
<span class="line-num">2050</span>     <span class="ruby-comment"># ignore parse errors, assume they&#39;re not spans</span>
<span class="line-num">2051</span>     <span class="ruby-keyword">return</span>
<span class="line-num">2052</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2053</span>   
<span class="line-num">2054</span>   <span class="ruby-comment"># Special case: dates like &#39;2004&#39;, which ordinarily resolve to today at</span>
<span class="line-num">2055</span>   <span class="ruby-comment"># 8:04pm</span>
<span class="line-num">2056</span>   <span class="ruby-identifier">observed_on_int</span> = <span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[^\d]/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">to_i</span>
<span class="line-num">2057</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observed_on_int</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1900</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observed_on_int</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">year</span>
<span class="line-num">2058</span>     <span class="ruby-identifier">is_a_range</span> = <span class="ruby-keyword">true</span>
<span class="line-num">2059</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2060</span>   
<span class="line-num">2061</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_a_range</span>
<span class="line-num">2062</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:observed_on</span>, <span class="ruby-string">&quot;must be a single day, not a range&quot;</span>)
<span class="line-num">2063</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2064</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-must_not_be_on_null_island">
            
              <b>must_not_be_on_null_island</b>()
            
            <a href="../classes/Observation.html#method-i-must_not_be_on_null_island" name="method-i-must_not_be_on_null_island" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-must_not_be_on_null_island_source')" id="l_method-i-must_not_be_on_null_island_source">show</a>
                

                

                
              </p>
              <div id="method-i-must_not_be_on_null_island_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2066</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">must_not_be_on_null_island</span>
<span class="line-num">2067</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">editing_user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2068</span>   <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_latitude</span>
<span class="line-num">2069</span>   <span class="ruby-identifier">lng</span> = <span class="ruby-identifier">longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">2070</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">lng</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">2071</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lng</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">2072</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-value">:coordinates_cannot_be_zero_zero</span> )
<span class="line-num">2073</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2074</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ne_latlon">
            
              <b>ne_latlon</b>()
            
            <a href="../classes/Observation.html#method-i-ne_latlon" name="method-i-ne_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ne_latlon_source')" id="l_method-i-ne_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-ne_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2552</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ne_latlon</span>
<span class="line-num">2553</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2554</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">latitude</span>
<span class="line-num">2555</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">2556</span>     <span class="ruby-identifier">half_cell</span> = <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">2557</span>     <span class="ruby-identifier">positional_accuracy_degrees</span> = <span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-constant">PLANETARY_RADIUS</span>) <span class="ruby-operator">*</span> <span class="ruby-value">360.0</span>
<span class="line-num">2558</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">half_cell</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">positional_accuracy_degrees</span>
<span class="line-num">2559</span>       <span class="ruby-identifier">uncertainty_cell_center_latlon</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">uncertainty_cell_center_latlon</span>( <span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span> )
<span class="line-num">2560</span>       <span class="ruby-keyword">return</span> [
<span class="line-num">2561</span>         <span class="ruby-identifier">uncertainty_cell_center_latlon</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>,
<span class="line-num">2562</span>         <span class="ruby-identifier">uncertainty_cell_center_latlon</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">half_cell</span>
<span class="line-num">2563</span>       ]
<span class="line-num">2564</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2565</span>     <span class="ruby-keyword">return</span> [
<span class="line-num">2566</span>       <span class="ruby-identifier">latitude</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2567</span>       <span class="ruby-identifier">longitude</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">positional_accuracy_degrees</span>
<span class="line-num">2568</span>     ]
<span class="line-num">2569</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2570</span>   <span class="ruby-identifier">private_ne_latlon</span>
<span class="line-num">2571</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-needs_id-3F">
            
              <b>needs_id?</b>()
            
            <a href="../classes/Observation.html#method-i-needs_id-3F" name="method-i-needs_id-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-needs_id-3F_source')" id="l_method-i-needs_id-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-needs_id-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3193</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_id?</span>
<span class="line-num">3194</span>   <span class="ruby-identifier">quality_grade</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NEEDS_ID</span>
<span class="line-num">3195</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-needs_id_downvotes_count">
            
              <b>needs_id_downvotes_count</b>()
            
            <a href="../classes/Observation.html#method-i-needs_id_downvotes_count" name="method-i-needs_id_downvotes_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-needs_id_downvotes_count_source')" id="l_method-i-needs_id_downvotes_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-needs_id_downvotes_count_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3165</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_id_downvotes_count</span>
<span class="line-num">3166</span>   <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span>
<span class="line-num">3167</span>     <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_flag?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_scope</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;needs_id&quot;</span> }.<span class="ruby-identifier">size</span> <span class="ruby-operator">:</span>
<span class="line-num">3168</span>     <span class="ruby-identifier">get_downvotes</span>(<span class="ruby-value">vote_scope:</span> <span class="ruby-string">&quot;needs_id&quot;</span>).<span class="ruby-identifier">size</span>
<span class="line-num">3169</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-needs_id_upvotes_count">
            
              <b>needs_id_upvotes_count</b>()
            
            <a href="../classes/Observation.html#method-i-needs_id_upvotes_count" name="method-i-needs_id_upvotes_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-needs_id_upvotes_count_source')" id="l_method-i-needs_id_upvotes_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-needs_id_upvotes_count_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3159</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_id_upvotes_count</span>
<span class="line-num">3160</span>   <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span>
<span class="line-num">3161</span>    <span class="ruby-identifier">votes_for</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_flag?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">vote_scope</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;needs_id&quot;</span> }.<span class="ruby-identifier">size</span> <span class="ruby-operator">:</span>
<span class="line-num">3162</span>    <span class="ruby-identifier">get_upvotes</span>(<span class="ruby-value">vote_scope:</span> <span class="ruby-string">&quot;needs_id&quot;</span>).<span class="ruby-identifier">size</span>
<span class="line-num">3163</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-needs_id_vote_score">
            
              <b>needs_id_vote_score</b>()
            
            <a href="../classes/Observation.html#method-i-needs_id_vote_score" name="method-i-needs_id_vote_score" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-needs_id_vote_score_source')" id="l_method-i-needs_id_vote_score_source">show</a>
                

                

                
              </p>
              <div id="method-i-needs_id_vote_score_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3171</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_id_vote_score</span>
<span class="line-num">3172</span>   <span class="ruby-identifier">uvotes</span> = <span class="ruby-identifier">needs_id_upvotes_count</span>
<span class="line-num">3173</span>   <span class="ruby-identifier">dvotes</span> = <span class="ruby-identifier">needs_id_downvotes_count</span>
<span class="line-num">3174</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">uvotes</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">dvotes</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">3175</span>     <span class="ruby-keyword">nil</span>
<span class="line-num">3176</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">uvotes</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">3177</span>     <span class="ruby-value">0</span>
<span class="line-num">3178</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">dvotes</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">3179</span>     <span class="ruby-value">1</span>
<span class="line-num">3180</span>   <span class="ruby-keyword">else</span>
<span class="line-num">3181</span>     <span class="ruby-identifier">uvotes</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">uvotes</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dvotes</span>)
<span class="line-num">3182</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3183</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-nilify_positional_accuracy_if_zero">
            
              <b>nilify_positional_accuracy_if_zero</b>()
            
            <a href="../classes/Observation.html#method-i-nilify_positional_accuracy_if_zero" name="method-i-nilify_positional_accuracy_if_zero" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-nilify_positional_accuracy_if_zero_source')" id="l_method-i-nilify_positional_accuracy_if_zero_source">show</a>
                

                

                
              </p>
              <div id="method-i-nilify_positional_accuracy_if_zero_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2920</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">nilify_positional_accuracy_if_zero</span>
<span class="line-num">2921</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">positional_accuracy</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">positional_accuracy</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">2922</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2923</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-normalize_geoprivacy">
            
              <b>normalize_geoprivacy</b>()
            
            <a href="../classes/Observation.html#method-i-normalize_geoprivacy" name="method-i-normalize_geoprivacy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-normalize_geoprivacy_source')" id="l_method-i-normalize_geoprivacy_source">show</a>
                

                

                
              </p>
              <div id="method-i-normalize_geoprivacy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1590</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">normalize_geoprivacy</span>
<span class="line-num">1591</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geoprivacy</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">GEOPRIVACIES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">geoprivacy</span>)
<span class="line-num">1592</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1593</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-num_identifications_by_others">
            
              <b>num_identifications_by_others</b>()
            
            <a href="../classes/Observation.html#method-i-num_identifications_by_others" name="method-i-num_identifications_by_others" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-num_identifications_by_others_source')" id="l_method-i-num_identifications_by_others_source">show</a>
                

                

                
              </p>
              <div id="method-i-num_identifications_by_others_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1368</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">num_identifications_by_others</span>
<span class="line-num">1369</span>   <span class="ruby-identifier">num_identification_agreements</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">num_identification_disagreements</span>
<span class="line-num">1370</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-obs_image_url">
            
              <b>obs_image_url</b>()
            
            <a href="../classes/Observation.html#method-i-obs_image_url" name="method-i-obs_image_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-obs_image_url_source')" id="l_method-i-obs_image_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-obs_image_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2358</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">obs_image_url</span>
<span class="line-num">2359</span>   <span class="ruby-identifier">image_url</span>
<span class="line-num">2360</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-obscure_coordinates">
            
              <b>obscure_coordinates</b>()
            
            <a href="../classes/Observation.html#method-i-obscure_coordinates" name="method-i-obscure_coordinates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-obscure_coordinates_source')" id="l_method-i-obscure_coordinates_source">show</a>
                

                

                
              </p>
              <div id="method-i-obscure_coordinates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1613</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">obscure_coordinates</span>
<span class="line-num">1614</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( [<span class="ruby-identifier">geoprivacy</span>, <span class="ruby-identifier">taxon_geoprivacy</span>] <span class="ruby-operator">&amp;</span> [<span class="ruby-constant">OBSCURED</span>, <span class="ruby-constant">PRIVATE</span>] ).<span class="ruby-identifier">size</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1615</span> 
<span class="line-num">1616</span>   <span class="ruby-identifier">geoprivacy_changed_from_private_to_obscured</span> = <span class="ruby-identifier">latitude_was</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1617</span>     <span class="ruby-operator">!</span>[<span class="ruby-identifier">geoprivacy</span>, <span class="ruby-identifier">taxon_geoprivacy</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-constant">PRIVATE</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1618</span>     [<span class="ruby-identifier">geoprivacy</span>, <span class="ruby-identifier">taxon_geoprivacy</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-constant">OBSCURED</span> )
<span class="line-num">1619</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">geoprivacy_changed_from_private_to_obscured</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span> )
<span class="line-num">1620</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscuration_changed</span> = <span class="ruby-identifier">geoprivacy_changed?</span>
<span class="line-num">1621</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1622</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1623</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude_changed?</span>
<span class="line-num">1624</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_latitude</span> = <span class="ruby-identifier">latitude</span>
<span class="line-num">1625</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_longitude</span> = <span class="ruby-identifier">longitude</span>
<span class="line-num">1626</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1627</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">latitude</span>
<span class="line-num">1628</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">longitude</span>
<span class="line-num">1629</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1630</span>   <span class="ruby-comment"># In this situation, the true coordinates didn&#39;t really change, so just reset them</span>
<span class="line-num">1631</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">latitude</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">private_longitude</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1632</span>       <span class="ruby-operator">!</span>( <span class="ruby-identifier">private_latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_longitude_changed?</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1633</span>       <span class="ruby-operator">!</span><span class="ruby-identifier">geoprivacy_changed_from_private_to_obscured</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">latitude_was</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude_was</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1634</span>       <span class="ruby-operator">!</span>( <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> )
<span class="line-num">1635</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">latitude_was</span>
<span class="line-num">1636</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">longitude_was</span>
<span class="line-num">1637</span>     <span class="ruby-identifier">set_geom_from_latlon</span>
<span class="line-num">1638</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> (
<span class="line-num">1639</span>       <span class="ruby-identifier">private_latitude_changed?</span> <span class="ruby-operator">||</span>
<span class="line-num">1640</span>       <span class="ruby-identifier">private_longitude_changed?</span> <span class="ruby-operator">||</span>
<span class="line-num">1641</span>       <span class="ruby-identifier">geoprivacy_changed_from_private_to_obscured</span>
<span class="line-num">1642</span>     )
<span class="line-num">1643</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">random_neighbor_lat_lon</span>( <span class="ruby-identifier">private_latitude</span>, <span class="ruby-identifier">private_longitude</span> )
<span class="line-num">1644</span>     <span class="ruby-identifier">set_geom_from_latlon</span>
<span class="line-num">1645</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscuration_changed</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1646</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1647</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1648</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-obscure_place_guess">
            
              <b>obscure_place_guess</b>()
            
            <a href="../classes/Observation.html#method-i-obscure_place_guess" name="method-i-obscure_place_guess" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-obscure_place_guess_source')" id="l_method-i-obscure_place_guess_source">show</a>
                

                

                
              </p>
              <div id="method-i-obscure_place_guess_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1650</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">obscure_place_guess</span>
<span class="line-num">1651</span>   <span class="ruby-identifier">public_place_guess</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">place_guess_from_latlon</span>(
<span class="line-num">1652</span>     <span class="ruby-identifier">private_latitude</span>,
<span class="line-num">1653</span>     <span class="ruby-identifier">private_longitude</span>,
<span class="line-num">1654</span>     <span class="ruby-value">acc:</span> <span class="ruby-identifier">calculate_public_positional_accuracy</span>,
<span class="line-num">1655</span>     <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>
<span class="line-num">1656</span>   )
<span class="line-num">1657</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_private?</span>
<span class="line-num">1658</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">public_place_guess</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess_changed?</span>
<span class="line-num">1659</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_place_guess</span> = <span class="ruby-identifier">place_guess</span>
<span class="line-num">1660</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1661</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1662</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">1663</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_guess_changed?</span>
<span class="line-num">1664</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">private_place_guess</span>
<span class="line-num">1665</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">public_place_guess</span>
<span class="line-num">1666</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1667</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_place_guess</span> = <span class="ruby-identifier">place_guess</span>
<span class="line-num">1668</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">public_place_guess</span>
<span class="line-num">1669</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1670</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">private_latitude_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_place_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1671</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_place_guess</span> = <span class="ruby-identifier">place_guess</span>
<span class="line-num">1672</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">public_place_guess</span>
<span class="line-num">1673</span>     <span class="ruby-comment"># This covers the case where the coordinates were hidden but are now obscured</span>
<span class="line-num">1674</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">latitude_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">latitude_was</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1675</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">public_place_guess</span>
<span class="line-num">1676</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1677</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1678</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place_guess_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_place_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1679</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">private_place_guess</span>
<span class="line-num">1680</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1681</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_place_guess</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1682</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1683</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1684</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observation_field_values_attributes-3D">
            
              <b>observation_field_values_attributes=</b>(attributes)
            
            <a href="../classes/Observation.html#method-i-observation_field_values_attributes-3D" name="method-i-observation_field_values_attributes-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Override nested obs field values attributes setter to ensure that field values get added even if existing field values have been destroyed (e.g. two windows). Also updating existing OFV of same OF name if id not  specified</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observation_field_values_attributes-3D_source')" id="l_method-i-observation_field_values_attributes-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-observation_field_values_attributes-3D_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1199</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observation_field_values_attributes=</span>(<span class="ruby-identifier">attributes</span>)
<span class="line-num">1200</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Parameters</span> )
<span class="line-num">1201</span>     <span class="ruby-identifier">attr_array</span> = <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">to_hash</span>.<span class="ruby-identifier">values</span>
<span class="line-num">1202</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1203</span>     <span class="ruby-identifier">attr_array</span> = <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">values</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">attributes</span>
<span class="line-num">1204</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1205</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attr_array</span>
<span class="line-num">1206</span>   <span class="ruby-identifier">attr_array</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">1207</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;id&quot;</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1208</span>       <span class="ruby-identifier">existing</span> = <span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:observation_field_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;observation_field_id&quot;</span>]).<span class="ruby-identifier">first</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;observation_field_id&quot;</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1209</span>       <span class="ruby-identifier">existing</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:observation_fields</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(observation_fields.name) = ?&quot;</span>, <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;name&quot;</span>]).<span class="ruby-identifier">first</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;name&quot;</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1210</span>       <span class="ruby-identifier">attr_array</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&quot;id&quot;</span>] = <span class="ruby-identifier">existing</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing</span>
<span class="line-num">1211</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-constant">ObservationFieldValue</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id = ?&quot;</span>, <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;id&quot;</span>]).<span class="ruby-identifier">exists?</span>
<span class="line-num">1212</span>       <span class="ruby-identifier">attr_array</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;id&quot;</span>)
<span class="line-num">1213</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1214</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1215</span>   <span class="ruby-identifier">assign_nested_attributes_for_collection_association</span>(<span class="ruby-value">:observation_field_values</span>, <span class="ruby-identifier">attr_array</span>)
<span class="line-num">1216</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observation_photos_finished_processing">
            
              <b>observation_photos_finished_processing</b>()
            
            <a href="../classes/Observation.html#method-i-observation_photos_finished_processing" name="method-i-observation_photos_finished_processing" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observation_photos_finished_processing_source')" id="l_method-i-observation_photos_finished_processing_source">show</a>
                

                

                
              </p>
              <div id="method-i-observation_photos_finished_processing_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3102</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observation_photos_finished_processing</span>
<span class="line-num">3103</span>   <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span>
<span class="line-num">3104</span>     <span class="ruby-operator">!</span> (<span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">LocalPhoto</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">processing?</span>)
<span class="line-num">3105</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3106</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-others_identifications">
            
              <b>others_identifications</b>()
            
            <a href="../classes/Observation.html#method-i-others_identifications" name="method-i-others_identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-others_identifications_source')" id="l_method-i-others_identifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-others_identifications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2777</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">others_identifications</span>
<span class="line-num">2778</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">2779</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">2780</span>       <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">2781</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2782</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2783</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">not_by</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">2784</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2785</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-owners_identification">
            
              <b>owners_identification</b>()
            
            <a href="../classes/Observation.html#method-i-owners_identification" name="method-i-owners_identification" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-owners_identification_source')" id="l_method-i-owners_identification_source">show</a>
                

                

                
              </p>
              <div id="method-i-owners_identification_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2766</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">owners_identification</span>
<span class="line-num">2767</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">2768</span>     <span class="ruby-comment"># if idents are loaded, the most recent current identification might be a new record</span>
<span class="line-num">2769</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">||</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>.<span class="ruby-identifier">from_now</span>}.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span> 
<span class="line-num">2770</span>       <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">current?</span>
<span class="line-num">2771</span>     }.<span class="ruby-identifier">last</span>
<span class="line-num">2772</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2773</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">last</span>
<span class="line-num">2774</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2775</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-owners_identification_from_vision">
            
              <b>owners_identification_from_vision</b>()
            
            <a href="../classes/Observation.html#method-i-owners_identification_from_vision" name="method-i-owners_identification_from_vision" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-owners_identification_from_vision_source')" id="l_method-i-owners_identification_from_vision_source">show</a>
                

                

                
              </p>
              <div id="method-i-owners_identification_from_vision_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3258</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">owners_identification_from_vision</span>
<span class="line-num">3259</span>   <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:vision</span>)
<span class="line-num">3260</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-owners_identification_from_vision-3D">
            
              <b>owners_identification_from_vision=</b>( val )
            
            <a href="../classes/Observation.html#method-i-owners_identification_from_vision-3D" name="method-i-owners_identification_from_vision-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-owners_identification_from_vision-3D_source')" id="l_method-i-owners_identification_from_vision-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-owners_identification_from_vision-3D_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3262</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">owners_identification_from_vision=</span>( <span class="ruby-identifier">val</span> )
<span class="line-num">3263</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owners_identification_from_vision_requested</span> = <span class="ruby-identifier">val</span>
<span class="line-num">3264</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-passes_quality_metric-3F">
            
              <b>passes_quality_metric?</b>(metric)
            
            <a href="../classes/Observation.html#method-i-passes_quality_metric-3F" name="method-i-passes_quality_metric-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-passes_quality_metric-3F_source')" id="l_method-i-passes_quality_metric-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-passes_quality_metric-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1410</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">passes_quality_metric?</span>(<span class="ruby-identifier">metric</span>)
<span class="line-num">1411</span>   <span class="ruby-identifier">score</span> = <span class="ruby-identifier">quality_metric_score</span>(<span class="ruby-identifier">metric</span>)
<span class="line-num">1412</span>   <span class="ruby-identifier">score</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">score</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0.5</span>
<span class="line-num">1413</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos-3F">
            
              <b>photos?</b>()
            
            <a href="../classes/Observation.html#method-i-photos-3F" name="method-i-photos-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos-3F_source')" id="l_method-i-photos-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1438</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos?</span>
<span class="line-num">1439</span>   <span class="ruby-comment"># new observations from the uploader may have .photos</span>
<span class="line-num">1440</span>   <span class="ruby-comment"># but may not yet have observation_p</span>
<span class="line-num">1441</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photos</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1442</span>   <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">1443</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-places">
            
              <b>places</b>()
            
            <a href="../classes/Observation.html#method-i-places" name="method-i-places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-places_source')" id="l_method-i-places_source">show</a>
                

                

                
              </p>
              <div id="method-i-places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2633</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">places</span>
<span class="line-num">2634</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2635</span>   <span class="ruby-identifier">candidates</span> = <span class="ruby-identifier">observations_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:place</span>).<span class="ruby-identifier">compact</span>
<span class="line-num">2636</span>   <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">2637</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_privately_contains_observation?</span>( <span class="ruby-keyword">self</span> ) <span class="ruby-operator">||</span>
<span class="line-num">2638</span>     [<span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> ) <span class="ruby-operator">||</span>
<span class="line-num">2639</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">places_without_obscuration_protection</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">2640</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2641</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-print_community_taxon_nodes">
            
              <b>print_community_taxon_nodes</b>( nodes = nil )
            
            <a href="../classes/Observation.html#method-i-print_community_taxon_nodes" name="method-i-print_community_taxon_nodes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-print_community_taxon_nodes_source')" id="l_method-i-print_community_taxon_nodes_source">show</a>
                

                

                
              </p>
              <div id="method-i-print_community_taxon_nodes_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1751</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">print_community_taxon_nodes</span>( <span class="ruby-identifier">nodes</span> = <span class="ruby-keyword">nil</span> )
<span class="line-num">1752</span>   <span class="ruby-identifier">nodes</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">community_taxon_nodes</span>
<span class="line-num">1753</span>   <span class="ruby-identifier">puts</span>
<span class="line-num">1754</span>   <span class="ruby-identifier">width</span> = <span class="ruby-value">15</span>
<span class="line-num">1755</span>   <span class="ruby-node">%w(taxon_id taxon_name cc dc cdc score)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num">1756</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;taxon_name&quot;</span>
<span class="line-num">1757</span>       <span class="ruby-identifier">print</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">ljust</span>( <span class="ruby-identifier">width</span><span class="ruby-operator">*</span><span class="ruby-value">2</span> )
<span class="line-num">1758</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1759</span>       <span class="ruby-identifier">print</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">ljust</span>( <span class="ruby-identifier">width</span> )
<span class="line-num">1760</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1761</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1762</span>   <span class="ruby-identifier">puts</span>
<span class="line-num">1763</span>   <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">ancestry</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>}.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="line-num">1764</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span>)
<span class="line-num">1765</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
<span class="line-num">1766</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:cumulative_count</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span>)
<span class="line-num">1767</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:disagreement_count</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span>)
<span class="line-num">1768</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:conservative_disagreement_count</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span>)
<span class="line-num">1769</span>     <span class="ruby-identifier">print</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:score</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">width</span>)
<span class="line-num">1770</span>     <span class="ruby-identifier">puts</span>
<span class="line-num">1771</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1772</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-private_ne_latlon">
            
              <b>private_ne_latlon</b>()
            
            <a href="../classes/Observation.html#method-i-private_ne_latlon" name="method-i-private_ne_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-private_ne_latlon_source')" id="l_method-i-private_ne_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-private_ne_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2540</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">private_ne_latlon</span>
<span class="line-num">2541</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2542</span>   <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">latitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_latitude</span>
<span class="line-num">2543</span>   <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">longitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">2544</span>   <span class="ruby-keyword">return</span> [<span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2545</span>   <span class="ruby-identifier">positional_accuracy_degrees</span> = <span class="ruby-identifier">positional_accuracy</span> <span class="ruby-operator">/</span> (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-constant">PLANETARY_RADIUS</span>) <span class="ruby-operator">*</span> <span class="ruby-value">360.0</span>
<span class="line-num">2546</span>   [
<span class="line-num">2547</span>     <span class="ruby-identifier">lat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2548</span>     <span class="ruby-identifier">lon</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2549</span>   ]
<span class="line-num">2550</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-private_sw_latlon">
            
              <b>private_sw_latlon</b>()
            
            <a href="../classes/Observation.html#method-i-private_sw_latlon" name="method-i-private_sw_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-private_sw_latlon_source')" id="l_method-i-private_sw_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-private_sw_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2507</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">private_sw_latlon</span>
<span class="line-num">2508</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2509</span>   <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">latitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_latitude</span>
<span class="line-num">2510</span>   <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">longitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">2511</span>   <span class="ruby-keyword">return</span> [<span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2512</span>   <span class="ruby-identifier">positional_accuracy_degrees</span> = <span class="ruby-identifier">positional_accuracy</span> <span class="ruby-operator">/</span> (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-constant">PLANETARY_RADIUS</span>) <span class="ruby-operator">*</span> <span class="ruby-value">360.0</span>
<span class="line-num">2513</span>   [
<span class="line-num">2514</span>     <span class="ruby-identifier">lat</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2515</span>     <span class="ruby-identifier">lon</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2516</span>   ]
<span class="line-num">2517</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-probable_taxon">
            
              <b>probable_taxon</b>( options = {} )
            
            <a href="../classes/Observation.html#method-i-probable_taxon" name="method-i-probable_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>What the system thinks the organism probably is. Current combines the communal opinion with the preferences of individuals (disagreement / not disagreement), and may in the future incorporate modeled identifier skill if there are any disagreements, use the community taxon</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-probable_taxon_source')" id="l_method-i-probable_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-probable_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1891</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">probable_taxon</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1892</span>   <span class="ruby-identifier">nodes</span> = <span class="ruby-identifier">community_taxon_nodes</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">1893</span>   <span class="ruby-identifier">disagreement_count</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">n</span>[<span class="ruby-value">:disagreement_count</span>], <span class="ruby-identifier">n</span>[<span class="ruby-value">:conservative_disagreement_count</span>]] }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">last</span>
<span class="line-num">1894</span>   <span class="ruby-identifier">disagreement_count</span> <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
<span class="line-num">1895</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">disagreement_count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">1896</span>     <span class="ruby-identifier">node</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:score</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">COMMUNITY_TAXON_SCORE_CUTOFF</span> }.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="line-num">1897</span>       <span class="ruby-value">0</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">||</span> <span class="ruby-value">500</span>) <span class="ruby-comment"># within that set, sort by rank level, i.e. choose lowest rank</span>
<span class="line-num">1898</span>     }.<span class="ruby-identifier">last</span>
<span class="line-num">1899</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
<span class="line-num">1900</span>     <span class="ruby-identifier">node</span>[<span class="ruby-value">:taxon</span>]
<span class="line-num">1901</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1902</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">get_community_taxon</span>
<span class="line-num">1903</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1904</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-probably_captive-3F">
            
              <b>probably_captive?</b>()
            
            <a href="../classes/Observation.html#method-i-probably_captive-3F" name="method-i-probably_captive-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-probably_captive-3F_source')" id="l_method-i-probably_captive-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-probably_captive-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3216</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">probably_captive?</span>
<span class="line-num">3217</span>   <span class="ruby-identifier">target_taxon</span> = <span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">3218</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target_taxon</span>
<span class="line-num">3219</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">target_taxon</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">target_taxon</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">GENUS_LEVEL</span>
<span class="line-num">3220</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">3221</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3222</span>   <span class="ruby-identifier">place</span> = <span class="ruby-identifier">system_places</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">3223</span>     [
<span class="line-num">3224</span>       <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>
<span class="line-num">3225</span>     ].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> )
<span class="line-num">3226</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3227</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place</span>
<span class="line-num">3228</span>   <span class="ruby-identifier">base_filters</span> = [
<span class="line-num">3229</span>     { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;taxon.ancestor_ids.keyword&quot;:</span> <span class="ruby-identifier">target_taxon</span>.<span class="ruby-identifier">id</span> } },
<span class="line-num">3230</span>     { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;place_ids.keyword&quot;:</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span> } },
<span class="line-num">3231</span>   ]
<span class="line-num">3232</span>   <span class="ruby-identifier">count_captive</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">3233</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">base_filters</span> <span class="ruby-operator">+</span> [{ <span class="ruby-value">term:</span> { <span class="ruby-value">captive:</span> <span class="ruby-keyword">true</span> } }],
<span class="line-num">3234</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">3235</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">3236</span>   ).<span class="ruby-identifier">results</span>.<span class="ruby-identifier">total_entries</span>
<span class="line-num">3237</span>   <span class="ruby-identifier">count_wild</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">3238</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">base_filters</span> <span class="ruby-operator">+</span> [{ <span class="ruby-value">term:</span> { <span class="ruby-value">captive:</span> <span class="ruby-keyword">false</span> } }],
<span class="line-num">3239</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">3240</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">3241</span>   ).<span class="ruby-identifier">results</span>.<span class="ruby-identifier">total_entries</span>
<span class="line-num">3242</span>   <span class="ruby-identifier">total</span> = <span class="ruby-identifier">count_captive</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">count_wild</span>
<span class="line-num">3243</span>   <span class="ruby-identifier">ratio</span> = <span class="ruby-identifier">count_captive</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">total</span>
<span class="line-num">3244</span>   <span class="ruby-comment"># puts &quot;total: #{total}, ratio: #{ratio}, place: #{place}&quot;</span>
<span class="line-num">3245</span>   <span class="ruby-identifier">total</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">10</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ratio</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0.8</span>
<span class="line-num">3246</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-public_places">
            
              <b>public_places</b>()
            
            <a href="../classes/Observation.html#method-i-public_places" name="method-i-public_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-public_places_source')" id="l_method-i-public_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-public_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2643</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">public_places</span>
<span class="line-num">2644</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2645</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2646</span>   <span class="ruby-identifier">candidates</span> = <span class="ruby-identifier">observations_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:place</span>).<span class="ruby-identifier">compact</span>
<span class="line-num">2647</span>   <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">2648</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_publicly_contains_observation?</span>( <span class="ruby-keyword">self</span> ) <span class="ruby-operator">||</span>
<span class="line-num">2649</span>     [<span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTY_LEVEL</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span> ) <span class="ruby-operator">||</span>
<span class="line-num">2650</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">places_without_obscuration_protection</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">2651</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2652</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-public_positional_accuracy">
            
              <b>public_positional_accuracy</b>()
            
            <a href="../classes/Observation.html#method-i-public_positional_accuracy" name="method-i-public_positional_accuracy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-public_positional_accuracy_source')" id="l_method-i-public_positional_accuracy_source">show</a>
                

                

                
              </p>
              <div id="method-i-public_positional_accuracy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3012</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">public_positional_accuracy</span>
<span class="line-num">3013</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_obscured?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">read_attribute</span>(<span class="ruby-value">:public_positional_accuracy</span>)
<span class="line-num">3014</span>     <span class="ruby-identifier">update_public_positional_accuracy</span>
<span class="line-num">3015</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3016</span>   <span class="ruby-identifier">read_attribute</span>(<span class="ruby-value">:public_positional_accuracy</span>)
<span class="line-num">3017</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-public_system_places">
            
              <b>public_system_places</b>( options = {} )
            
            <a href="../classes/Observation.html#method-i-public_system_places" name="method-i-public_system_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-public_system_places_source')" id="l_method-i-public_system_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-public_system_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2669</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">public_system_places</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2670</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">system_places_for_latlon</span>( <span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">acc:</span> <span class="ruby-identifier">positional_accuracy</span> ) )
<span class="line-num">2671</span>   <span class="ruby-identifier">public_places</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">admin_level</span>.<span class="ruby-identifier">blank?</span> }
<span class="line-num">2672</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-quality_metric_score">
            
              <b>quality_metric_score</b>(metric)
            
            <a href="../classes/Observation.html#method-i-quality_metric_score" name="method-i-quality_metric_score" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-quality_metric_score_source')" id="l_method-i-quality_metric_score_source">show</a>
                

                

                
              </p>
              <div id="method-i-quality_metric_score_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1388</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">quality_metric_score</span>(<span class="ruby-identifier">metric</span>)
<span class="line-num">1389</span>   <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">all</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">1390</span>   <span class="ruby-identifier">metrics</span> = <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">qm</span>.<span class="ruby-identifier">frozen?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">metric</span>}
<span class="line-num">1391</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">metrics</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1392</span>   <span class="ruby-identifier">metrics</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">agree?</span>}.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">metrics</span>.<span class="ruby-identifier">size</span>
<span class="line-num">1393</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-quality_metrics_pass-3F">
            
              <b>quality_metrics_pass?</b>( metrics = QualityMetric::METRICS )
            
            <a href="../classes/Observation.html#method-i-quality_metrics_pass-3F" name="method-i-quality_metrics_pass-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-quality_metrics_pass-3F_source')" id="l_method-i-quality_metrics_pass-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-quality_metrics_pass-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1403</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">quality_metrics_pass?</span>( <span class="ruby-identifier">metrics</span> = <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">METRICS</span> )
<span class="line-num">1404</span>   <span class="ruby-identifier">metrics</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">metric</span><span class="ruby-operator">|</span>
<span class="line-num">1405</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">passes_quality_metric?</span>(<span class="ruby-identifier">metric</span>)
<span class="line-num">1406</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1407</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1408</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reassess_annotations">
            
              <b>reassess_annotations</b>()
            
            <a href="../classes/Observation.html#method-i-reassess_annotations" name="method-i-reassess_annotations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reassess_annotations_source')" id="l_method-i-reassess_annotations_source">show</a>
                

                

                
              </p>
              <div id="method-i-reassess_annotations_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2859</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reassess_annotations</span>
<span class="line-num">2860</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">saved_change_to_taxon_id?</span>
<span class="line-num">2861</span>   <span class="ruby-identifier">annotations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">2862</span>     <span class="ruby-identifier">a</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">2863</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2864</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2865</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reassess_coordinate_obscuration">
            
              <b>reassess_coordinate_obscuration</b>()
            
            <a href="../classes/Observation.html#method-i-reassess_coordinate_obscuration" name="method-i-reassess_coordinate_obscuration" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reassess_coordinate_obscuration_source')" id="l_method-i-reassess_coordinate_obscuration_source">show</a>
                

                

                
              </p>
              <div id="method-i-reassess_coordinate_obscuration_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1595</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reassess_coordinate_obscuration</span>
<span class="line-num">1596</span>   <span class="ruby-identifier">geoprivacies</span> = [<span class="ruby-identifier">geoprivacy</span>, <span class="ruby-identifier">taxon_geoprivacy</span>]
<span class="line-num">1597</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">PRIVATE</span> )
<span class="line-num">1598</span>     <span class="ruby-identifier">hide_coordinates</span>
<span class="line-num">1599</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">OBSCURED</span> )
<span class="line-num">1600</span>     <span class="ruby-identifier">obscure_coordinates</span>
<span class="line-num">1601</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1602</span>     <span class="ruby-identifier">unobscure_coordinates</span>
<span class="line-num">1603</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1604</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-refresh_check_lists">
            
              <b>refresh_check_lists</b>()
            
            <a href="../classes/Observation.html#method-i-refresh_check_lists" name="method-i-refresh_check_lists" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-refresh_check_lists_source')" id="l_method-i-refresh_check_lists_source">show</a>
                

                

                
              </p>
              <div id="method-i-refresh_check_lists_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1218</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">refresh_check_lists</span>
<span class="line-num">1219</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_refresh_check_lists</span>
<span class="line-num">1220</span>   <span class="ruby-identifier">changing_quality_grade</span> = <span class="ruby-identifier">will_save_change_to_quality_grade?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_quality_grade?</span>
<span class="line-num">1221</span>   <span class="ruby-identifier">changing_taxon_id</span> = <span class="ruby-identifier">will_save_change_to_taxon_id?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_taxon_id?</span>
<span class="line-num">1222</span>   <span class="ruby-identifier">changing_latitude</span> = <span class="ruby-identifier">will_save_change_to_latitude?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_latitude?</span>
<span class="line-num">1223</span>   <span class="ruby-identifier">changing_longitude</span> = <span class="ruby-identifier">will_save_change_to_longitude?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_longitude?</span>
<span class="line-num">1224</span>   <span class="ruby-identifier">changing_observed_on</span> = <span class="ruby-identifier">will_save_change_to_observed_on?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_observed_on?</span>
<span class="line-num">1225</span>   <span class="ruby-identifier">refresh_needed</span> = (<span class="ruby-identifier">georeferenced?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">was_georeferenced?</span>) <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num">1226</span>     ( <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_id_before_last_save</span>) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1227</span>     ( <span class="ruby-identifier">changing_quality_grade</span> <span class="ruby-operator">||</span>
<span class="line-num">1228</span>       <span class="ruby-identifier">changing_taxon_id</span> <span class="ruby-operator">||</span>
<span class="line-num">1229</span>       <span class="ruby-identifier">changing_latitude</span> <span class="ruby-operator">||</span>
<span class="line-num">1230</span>       <span class="ruby-identifier">changing_longitude</span> <span class="ruby-operator">||</span>
<span class="line-num">1231</span>       <span class="ruby-identifier">changing_observed_on</span> )
<span class="line-num">1232</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">refresh_needed</span>
<span class="line-num">1233</span>   <span class="ruby-constant">CheckList</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">1234</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;CheckList::refresh_with_observation&quot;:</span> <span class="ruby-identifier">id</span> }).
<span class="line-num">1235</span>     <span class="ruby-identifier">refresh_with_observation</span>(<span class="ruby-identifier">id</span>, <span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon_id</span>,
<span class="line-num">1236</span>       <span class="ruby-value">:taxon_id_was</span>  <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">saved_change_to_taxon_id?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">taxon_id_before_last_save</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">1237</span>       <span class="ruby-value">:latitude_was</span>  <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">saved_change_to_latitude?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">latitude_before_last_save</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">1238</span>       <span class="ruby-value">:longitude_was</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">saved_change_to_longitude?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">longitude_before_last_save</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">1239</span>       <span class="ruby-value">:new</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">saved_change_to_id?</span> )
<span class="line-num">1240</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1241</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reindex_identifications">
            
              <b>reindex_identifications</b>()
            
            <a href="../classes/Observation.html#method-i-reindex_identifications" name="method-i-reindex_identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reindex_identifications_source')" id="l_method-i-reindex_identifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-reindex_identifications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3266</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reindex_identifications</span>
<span class="line-num">3267</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_indexing</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">skip_identification_indexing</span>
<span class="line-num">3268</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">identification_ids</span> )
<span class="line-num">3269</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reindex_places">
            
              <b>reindex_places</b>()
            
            <a href="../classes/Observation.html#method-i-reindex_places" name="method-i-reindex_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>The intent here is to keep the observations_count in the Places index <strong>roughly</strong> up-to-date. So these jobs probably won&#39;t be queued after observation creation b/c the <a href="ObservationsPlace.html"><code>ObservationsPlace</code></a> records won&#39;t have been made, and no place should be re-indexed more than once a day.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reindex_places_source')" id="l_method-i-reindex_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-reindex_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3275</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reindex_places</span>
<span class="line-num">3276</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_indexing</span>
<span class="line-num">3277</span>   <span class="ruby-identifier">places</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">3278</span>     <span class="ruby-comment"># Queue jobs with a little offset we don&#39;t end up running intense API</span>
<span class="line-num">3279</span>     <span class="ruby-comment"># calls at the same time</span>
<span class="line-num">3280</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">3281</span>       <span class="ruby-value">run_at:</span> ( <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">minutes</span> ).<span class="ruby-identifier">from_now</span>,
<span class="line-num">3282</span>       <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">3283</span>       <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">3284</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Place::elastic_index&quot;:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">3285</span>     ).<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">3286</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3287</span>   <span class="ruby-keyword">true</span>
<span class="line-num">3288</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reindex_projects">
            
              <b>reindex_projects</b>()
            
            <a href="../classes/Observation.html#method-i-reindex_projects" name="method-i-reindex_projects" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reindex_projects_source')" id="l_method-i-reindex_projects_source">show</a>
                

                

                
              </p>
              <div id="method-i-reindex_projects_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3290</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reindex_projects</span>
<span class="line-num">3291</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_indexing</span>
<span class="line-num">3292</span>   <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">3293</span>     <span class="ruby-comment"># Queue jobs with a little offset we don&#39;t end up running intense API</span>
<span class="line-num">3294</span>     <span class="ruby-comment"># calls at the same time</span>
<span class="line-num">3295</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">3296</span>       <span class="ruby-value">run_at:</span> ( <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">minutes</span> ).<span class="ruby-identifier">from_now</span>,
<span class="line-num">3297</span>       <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">3298</span>       <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">3299</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Project::elastic_index&quot;:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">3300</span>     ).<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">3301</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3302</span>   <span class="ruby-keyword">true</span>
<span class="line-num">3303</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-replace_inactive_taxon">
            
              <b>replace_inactive_taxon</b>()
            
            <a href="../classes/Observation.html#method-i-replace_inactive_taxon" name="method-i-replace_inactive_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-replace_inactive_taxon_source')" id="l_method-i-replace_inactive_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-replace_inactive_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1264</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">replace_inactive_taxon</span>
<span class="line-num">1265</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> ( <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_active?</span> )
<span class="line-num">1266</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">candidate</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">current_synonymous_taxon</span>
<span class="line-num">1267</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">candidate</span>
<span class="line-num">1268</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1269</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-research_grade-3F">
            
              <b>research_grade?</b>()
            
            <a href="../classes/Observation.html#method-i-research_grade-3F" name="method-i-research_grade-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-research_grade-3F_source')" id="l_method-i-research_grade-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-research_grade-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1430</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">research_grade?</span>
<span class="line-num">1431</span>   <span class="ruby-identifier">quality_grade</span> <span class="ruby-operator">==</span> <span class="ruby-constant">RESEARCH_GRADE</span>
<span class="line-num">1432</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-research_grade_candidate-3F">
            
              <b>research_grade_candidate?</b>()
            
            <a href="../classes/Observation.html#method-i-research_grade_candidate-3F" name="method-i-research_grade_candidate-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-research_grade_candidate-3F_source')" id="l_method-i-research_grade_candidate-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-research_grade_candidate-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1415</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">research_grade_candidate?</span>
<span class="line-num">1416</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">human?</span>
<span class="line-num">1417</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">1418</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quality_metrics_pass?</span>
<span class="line-num">1419</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observed_on?</span>
<span class="line-num">1420</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">photos?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">sounds?</span>)
<span class="line-num">1421</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">appropriate?</span>
<span class="line-num">1422</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1423</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-respond_to-3F">
            
              <b>respond_to?</b>(method, include_private = false)
            
            <a href="../classes/Observation.html#method-i-respond_to-3F" name="method-i-respond_to-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-respond_to-3F_source')" id="l_method-i-respond_to-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-respond_to-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2813</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">respond_to?</span>(<span class="ruby-identifier">method</span>, <span class="ruby-identifier">include_private</span> = <span class="ruby-keyword">false</span>)
<span class="line-num">2814</span>   <span class="ruby-identifier">@@class_methods_hash</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Hash</span>[ <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">instance_methods</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-keyword">true</span> ] } ]
<span class="line-num">2815</span>   <span class="ruby-identifier">@@class_columns_hash</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Hash</span>[ <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-keyword">true</span> ] } ]
<span class="line-num">2816</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">@@class_methods_hash</span>[<span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">@@class_columns_hash</span>[<span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_sym</span>]
<span class="line-num">2817</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span>
<span class="line-num">2818</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2819</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^field:/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^taxon_[^=]+/</span>
<span class="line-num">2820</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^field:/</span>
<span class="line-num">2821</span>     <span class="ruby-identifier">of_name</span> = <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;:&#39;</span>).<span class="ruby-identifier">last</span>
<span class="line-num">2822</span>     <span class="ruby-identifier">ofv</span> = <span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ofv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">observation_field</span>.<span class="ruby-identifier">normalized_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">of_name</span>}
<span class="line-num">2823</span>     <span class="ruby-keyword">return</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2824</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^taxon_/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">2825</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^taxon_/</span>, <span class="ruby-string">&#39;&#39;</span>), <span class="ruby-identifier">include_private</span>)
<span class="line-num">2826</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2827</span>   <span class="ruby-keyword">super</span>
<span class="line-num">2828</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reviewed_by-3F">
            
              <b>reviewed_by?</b>(viewer)
            
            <a href="../classes/Observation.html#method-i-reviewed_by-3F" name="method-i-reviewed_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reviewed_by-3F_source')" id="l_method-i-reviewed_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-reviewed_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1722</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reviewed_by?</span>(<span class="ruby-identifier">viewer</span>)
<span class="line-num">1723</span>   <span class="ruby-identifier">viewer</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">viewer</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>)
<span class="line-num">1724</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">viewer</span>
<span class="line-num">1725</span>   <span class="ruby-constant">ObservationReview</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">1726</span>     <span class="ruby-value">user_id:</span> <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">reviewed:</span> <span class="ruby-keyword">true</span>).<span class="ruby-identifier">exists?</span>
<span class="line-num">1727</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-scientific_name">
            
              <b>scientific_name</b>()
            
            <a href="../classes/Observation.html#method-i-scientific_name" name="method-i-scientific_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-scientific_name_source')" id="l_method-i-scientific_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-scientific_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2372</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">scientific_name</span>
<span class="line-num">2373</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">scientific_name</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">scientific_name</span>
<span class="line-num">2374</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-serializable_hash">
            
              <b>serializable_hash</b>(opts = nil)
            
            <a href="../classes/Observation.html#method-i-serializable_hash" name="method-i-serializable_hash" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-serializable_hash_source')" id="l_method-i-serializable_hash_source">show</a>
                

                

                
              </p>
              <div id="method-i-serializable_hash_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">858</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">serializable_hash</span>(<span class="ruby-identifier">opts</span> = <span class="ruby-keyword">nil</span>)
<span class="line-num">859</span>   <span class="ruby-comment"># for some reason, in some cases options was still nil</span>
<span class="line-num">860</span>   <span class="ruby-identifier">options</span> = <span class="ruby-identifier">opts</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">clone</span> <span class="ruby-operator">:</span> { }
<span class="line-num">861</span>   <span class="ruby-comment"># making a deep copy of the options so they don&#39;t get modified</span>
<span class="line-num">862</span>   <span class="ruby-comment"># This was more effective than options.deep_dup</span>
<span class="line-num">863</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>))
<span class="line-num">864</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">marshal_copy</span>
<span class="line-num">865</span>   <span class="ruby-keyword">end</span>
<span class="line-num">866</span>   <span class="ruby-comment"># don&#39;t use delete here, it will just remove the option for all</span>
<span class="line-num">867</span>   <span class="ruby-comment"># subsequent records in an array</span>
<span class="line-num">868</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
<span class="line-num">869</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">k</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">v</span>}}
<span class="line-num">870</span>   <span class="ruby-keyword">else</span>
<span class="line-num">871</span>     [<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">872</span>   <span class="ruby-keyword">end</span>
<span class="line-num">873</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">874</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:created_at_utc</span>, <span class="ruby-value">:updated_at_utc</span>,
<span class="line-num">875</span>     <span class="ruby-value">:time_observed_at_utc</span>, <span class="ruby-value">:faves_count</span>, <span class="ruby-value">:owners_identification_from_vision</span>]
<span class="line-num">876</span>   <span class="ruby-identifier">viewer</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:viewer</span>]
<span class="line-num">877</span>   <span class="ruby-identifier">viewer</span> = <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">viewer</span> <span class="ruby-operator">:</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">viewer</span>.<span class="ruby-identifier">to_i</span> )
<span class="line-num">878</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">879</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:user_agent</span>]
<span class="line-num">880</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:force_coordinate_visibility</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">coordinates_viewable_by?</span>( <span class="ruby-identifier">viewer</span> )
<span class="line-num">881</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:private_latitude</span>, <span class="ruby-value">:private_longitude</span>, <span class="ruby-value">:geom</span>, <span class="ruby-value">:private_geom</span>, <span class="ruby-value">:private_place_guess</span>]
<span class="line-num">882</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:coordinates_obscured</span>
<span class="line-num">883</span>   <span class="ruby-keyword">end</span>
<span class="line-num">884</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:cached_tag_list</span>, <span class="ruby-value">:geom</span>, <span class="ruby-value">:private_geom</span>]
<span class="line-num">885</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>].<span class="ruby-identifier">uniq!</span>
<span class="line-num">886</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>].<span class="ruby-identifier">uniq!</span>
<span class="line-num">887</span>   <span class="ruby-identifier">h</span> = <span class="ruby-keyword">super</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">888</span>   <span class="ruby-identifier">h</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">889</span>     <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/&lt;script.*script&gt;/i</span>, <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num">890</span>   <span class="ruby-keyword">end</span>
<span class="line-num">891</span>   <span class="ruby-identifier">h</span>.<span class="ruby-identifier">force_utf8</span>
<span class="line-num">892</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_captive">
            
              <b>set_captive</b>()
            
            <a href="../classes/Observation.html#method-i-set_captive" name="method-i-set_captive" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_captive_source')" id="l_method-i-set_captive_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_captive_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1354</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_captive</span>
<span class="line-num">1355</span>   <span class="ruby-identifier">update_column</span>(<span class="ruby-value">:captive</span>, <span class="ruby-identifier">captive_cultivated</span>)
<span class="line-num">1356</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_community_taxon">
            
              <b>set_community_taxon</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-set_community_taxon" name="method-i-set_community_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_community_taxon_source')" id="l_method-i-set_community_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_community_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1846</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_community_taxon</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1847</span>   <span class="ruby-identifier">community_taxon</span> = <span class="ruby-identifier">get_community_taxon</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">1848</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community_taxon</span> = <span class="ruby-identifier">community_taxon</span>
<span class="line-num">1849</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">community_taxon_rejected?</span>
<span class="line-num">1850</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">species_guess</span> = (<span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">name</span>)
<span class="line-num">1851</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1852</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1853</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_community_taxon_before_save">
            
              <b>set_community_taxon_before_save</b>()
            
            <a href="../classes/Observation.html#method-i-set_community_taxon_before_save" name="method-i-set_community_taxon_before_save" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_community_taxon_before_save_source')" id="l_method-i-set_community_taxon_before_save_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_community_taxon_before_save_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1855</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_community_taxon_before_save</span>
<span class="line-num">1856</span>   <span class="ruby-identifier">set_community_taxon</span>(<span class="ruby-value">:force</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">prefers_community_taxon_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_id_changed?</span>
<span class="line-num">1857</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1858</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_coordinates">
            
              <b>set_coordinates</b>()
            
            <a href="../classes/Observation.html#method-i-set_coordinates" name="method-i-set_coordinates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_coordinates_source')" id="l_method-i-set_coordinates_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_coordinates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2902</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_coordinates</span>
<span class="line-num">2903</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geo_x</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geo_y</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">coordinate_system</span>.<span class="ruby-identifier">present?</span>
<span class="line-num">2904</span>     <span class="ruby-comment"># Perform the transformation</span>
<span class="line-num">2905</span>     <span class="ruby-comment"># transfrom from `self.coordinate_system`</span>
<span class="line-num">2906</span>     <span class="ruby-identifier">from</span> = <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">CoordSys</span><span class="ruby-operator">::</span><span class="ruby-constant">Proj4</span>.<span class="ruby-identifier">new</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">coordinate_system</span> )
<span class="line-num">2907</span> 
<span class="line-num">2908</span>     <span class="ruby-comment"># ... to WGS84</span>
<span class="line-num">2909</span>     <span class="ruby-identifier">to</span> = <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">CoordSys</span><span class="ruby-operator">::</span><span class="ruby-constant">Proj4</span>.<span class="ruby-identifier">new</span>( <span class="ruby-constant">WGS84_PROJ4</span> )
<span class="line-num">2910</span> 
<span class="line-num">2911</span>     <span class="ruby-comment"># Returns an array of lat, lon</span>
<span class="line-num">2912</span>     <span class="ruby-identifier">transform</span> = <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">CoordSys</span><span class="ruby-operator">::</span><span class="ruby-constant">Proj4</span>.<span class="ruby-identifier">transform_coords</span>( <span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geo_x</span>.<span class="ruby-identifier">to_d</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geo_y</span>.<span class="ruby-identifier">to_d</span> )
<span class="line-num">2913</span> 
<span class="line-num">2914</span>     <span class="ruby-comment"># Set the transform</span>
<span class="line-num">2915</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">transform</span>
<span class="line-num">2916</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2917</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2918</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_geom_from_latlon">
            
              <b>set_geom_from_latlon</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-set_geom_from_latlon" name="method-i-set_geom_from_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_geom_from_latlon_source')" id="l_method-i-set_geom_from_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_geom_from_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2134</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_geom_from_latlon</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">2135</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2136</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geom</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">2137</span>     <span class="ruby-comment"># If the coordinates are blank because they&#39;ve changed *and* not because</span>
<span class="line-num">2138</span>     <span class="ruby-comment"># the geoprivacy is PRIVATE, assume the user intended to remove the</span>
<span class="line-num">2139</span>     <span class="ruby-comment"># coordinates and remove both public and private values</span>
<span class="line-num">2140</span>     <span class="ruby-identifier">coordinates_removed_in_update</span> = <span class="ruby-identifier">persisted?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude_changed?</span> )
<span class="line-num">2141</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_removed_in_update</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">geoprivacy</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PRIVATE</span>
<span class="line-num">2142</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_latitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">2143</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_longitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">2144</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2145</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:force</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude_changed?</span>
<span class="line-num">2146</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geom</span> = <span class="ruby-node">&quot;POINT(#{longitude} #{latitude})&quot;</span>
<span class="line-num">2147</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2148</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">2149</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_geom</span> = <span class="ruby-node">&quot;POINT(#{private_longitude} #{private_latitude})&quot;</span>
<span class="line-num">2150</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geom</span>
<span class="line-num">2151</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_geom</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">geom</span>
<span class="line-num">2152</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2153</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_geom</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">2154</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2155</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_iconic_taxon">
            
              <b>set_iconic_taxon</b>()
            
            <a href="../classes/Observation.html#method-i-set_iconic_taxon" name="method-i-set_iconic_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Set the iconic taxon if it hasn&#39;t been set</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_iconic_taxon_source')" id="l_method-i-set_iconic_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_iconic_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1255</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_iconic_taxon</span>
<span class="line-num">1256</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">1257</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">iconic_taxon_id</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon_id</span>
<span class="line-num">1258</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1259</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">iconic_taxon_id</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1260</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1261</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1262</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_latlon_from_place_guess">
            
              <b>set_latlon_from_place_guess</b>()
            
            <a href="../classes/Observation.html#method-i-set_latlon_from_place_guess" name="method-i-set_latlon_from_place_guess" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_latlon_from_place_guess_source')" id="l_method-i-set_latlon_from_place_guess_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_latlon_from_place_guess_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2112</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_latlon_from_place_guess</span>
<span class="line-num">2113</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2114</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2115</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[a-cf-mo-rt-vx-z]/i</span> <span class="ruby-comment"># ignore anything with word chars other than NSEW</span>
<span class="line-num">2116</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[.+,\s.+]/</span> <span class="ruby-comment"># ignore anything without a legit separator</span>
<span class="line-num">2117</span>   <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-constant">COORDINATE_REGEX</span>).<span class="ruby-identifier">flatten</span>
<span class="line-num">2118</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2119</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">size</span>
<span class="line-num">2120</span>   <span class="ruby-keyword">when</span> <span class="ruby-value">2</span> <span class="ruby-comment"># decimal degrees</span>
<span class="line-num">2121</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">matches</span>
<span class="line-num">2122</span>   <span class="ruby-keyword">when</span> <span class="ruby-value">4</span> <span class="ruby-comment"># decimal minutes</span>
<span class="line-num">2123</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">matches</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span>
<span class="line-num">2124</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">matches</span>[<span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">4</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span>
<span class="line-num">2125</span>   <span class="ruby-keyword">when</span> <span class="ruby-value">6</span> <span class="ruby-comment"># degrees / minutes / seconds</span>
<span class="line-num">2126</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">matches</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">60</span><span class="ruby-operator">/</span><span class="ruby-value">60</span>
<span class="line-num">2127</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">matches</span>[<span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">matches</span>[<span class="ruby-value">5</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">60</span><span class="ruby-operator">/</span><span class="ruby-value">60</span>
<span class="line-num">2128</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2129</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> <span class="ruby-operator">*=</span> <span class="ruby-value">-1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/s/i</span>
<span class="line-num">2130</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> <span class="ruby-operator">*=</span> <span class="ruby-value">-1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_guess</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/w/i</span>
<span class="line-num">2131</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2132</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_license">
            
              <b>set_license</b>()
            
            <a href="../classes/Observation.html#method-i-set_license" name="method-i-set_license" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_license_source')" id="l_method-i-set_license_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_license_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2191</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_license</span>
<span class="line-num">2192</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">license_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">license</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2193</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">license</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">preferred_observation_license</span>
<span class="line-num">2194</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">license</span> = <span class="ruby-constant">Shared</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseModule</span>.<span class="ruby-identifier">normalize_license_code</span>( <span class="ruby-identifier">license</span> )
<span class="line-num">2195</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">license</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">LICENSE_CODES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">license</span> )
<span class="line-num">2196</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2197</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_place_guess_from_latlon">
            
              <b>set_place_guess_from_latlon</b>()
            
            <a href="../classes/Observation.html#method-i-set_place_guess_from_latlon" name="method-i-set_place_guess_from_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_place_guess_from_latlon_source')" id="l_method-i-set_place_guess_from_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_place_guess_from_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2182</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_place_guess_from_latlon</span>
<span class="line-num">2183</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2184</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_private?</span>
<span class="line-num">2185</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">guess</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">place_guess_from_latlon</span>( <span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span>, { <span class="ruby-value">acc:</span> <span class="ruby-identifier">calculate_public_positional_accuracy</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> } )
<span class="line-num">2186</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">guess</span>
<span class="line-num">2187</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2188</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2189</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_quality_grade">
            
              <b>set_quality_grade</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-set_quality_grade" name="method-i-set_quality_grade" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_quality_grade_source')" id="l_method-i-set_quality_grade_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_quality_grade_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1449</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_quality_grade</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1450</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">quality_grade</span> = <span class="ruby-identifier">get_quality_grade</span>
<span class="line-num">1451</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1452</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_taxon_from_probable_taxon">
            
              <b>set_taxon_from_probable_taxon</b>()
            
            <a href="../classes/Observation.html#method-i-set_taxon_from_probable_taxon" name="method-i-set_taxon_from_probable_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_taxon_from_probable_taxon_source')" id="l_method-i-set_taxon_from_probable_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_taxon_from_probable_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1906</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_taxon_from_probable_taxon</span>
<span class="line-num">1907</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_id</span>
<span class="line-num">1908</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1909</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">species_guess</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1910</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">1911</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1912</span>   <span class="ruby-identifier">prob_taxon</span> = <span class="ruby-identifier">probable_taxon</span>( <span class="ruby-value">force:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1913</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_id</span> = <span class="ruby-keyword">if</span> ( <span class="ruby-operator">!</span><span class="ruby-identifier">user</span>.<span class="ruby-identifier">prefers_community_taxa?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">prefers_community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">prefers_community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="line-num">1914</span>     <span class="ruby-comment"># obs opted out or user opted out</span>
<span class="line-num">1915</span>     <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>)
<span class="line-num">1916</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">ct</span> = <span class="ruby-identifier">community_taxon</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">prob_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">prob_taxon</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES_LEVEL</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">prob_taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ct</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1917</span>     <span class="ruby-identifier">first_id_of_prob_taxon</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">prob_taxon</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span>}.<span class="ruby-identifier">first</span>
<span class="line-num">1918</span>     <span class="ruby-identifier">first_id_of_community_taxon</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ct</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span>}.<span class="ruby-identifier">first</span>
<span class="line-num">1919</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">first_id_of_prob_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">first_id_of_community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">first_id_of_prob_taxon</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">first_id_of_community_taxon</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1920</span>       <span class="ruby-comment"># prob_taxon was subspecific but first</span>
<span class="line-num">1921</span>       <span class="ruby-identifier">prob_taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">others_identifications</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>)
<span class="line-num">1922</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1923</span>       <span class="ruby-comment"># prob_taxon was subspecific and not first, using CID</span>
<span class="line-num">1924</span>       <span class="ruby-identifier">ct</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1925</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1926</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1927</span>     <span class="ruby-comment"># opted in</span>
<span class="line-num">1928</span>     <span class="ruby-identifier">prob_taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">owners_identification</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">others_identifications</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>)
<span class="line-num">1929</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1930</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id_changed?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">community_taxon_id_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">prefers_community_taxon_changed?</span>)
<span class="line-num">1931</span>     <span class="ruby-identifier">update_stats</span>( <span class="ruby-value">skip_save:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1932</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">species_guess</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">1933</span>       <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">1934</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1935</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">1936</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1937</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1938</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1939</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_taxon_from_species_guess">
            
              <b>set_taxon_from_species_guess</b>()
            
            <a href="../classes/Observation.html#method-i-set_taxon_from_species_guess" name="method-i-set_taxon_from_species_guess" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_taxon_from_species_guess_source')" id="l_method-i-set_taxon_from_species_guess_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_taxon_from_species_guess_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2083</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_taxon_from_species_guess</span>
<span class="line-num">2084</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">species_guess</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\?$/</span>
<span class="line-num">2085</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">species_guess_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2086</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">species_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2087</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">single_taxon_id_for_name</span>(<span class="ruby-identifier">species_guess</span>)
<span class="line-num">2088</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2089</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_taxon_from_taxon_name">
            
              <b>set_taxon_from_taxon_name</b>()
            
            <a href="../classes/Observation.html#method-i-set_taxon_from_taxon_name" name="method-i-set_taxon_from_taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_taxon_from_taxon_name_source')" id="l_method-i-set_taxon_from_taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_taxon_from_taxon_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2076</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_taxon_from_taxon_name</span>
<span class="line-num">2077</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2078</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span>
<span class="line-num">2079</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">single_taxon_id_for_name</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_name</span>)
<span class="line-num">2080</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2081</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_taxon_geoprivacy">
            
              <b>set_taxon_geoprivacy</b>()
            
            <a href="../classes/Observation.html#method-i-set_taxon_geoprivacy" name="method-i-set_taxon_geoprivacy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_taxon_geoprivacy_source')" id="l_method-i-set_taxon_geoprivacy_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_taxon_geoprivacy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2091</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_taxon_geoprivacy</span>
<span class="line-num">2092</span>   <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">loaded?</span> 
<span class="line-num">2093</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current?</span> }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>)
<span class="line-num">2094</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2095</span>     <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:taxon_id</span>)
<span class="line-num">2096</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2097</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_geoprivacy</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">max_geoprivacy</span>(
<span class="line-num">2098</span>     <span class="ruby-identifier">taxon_ids</span>,
<span class="line-num">2099</span>     <span class="ruby-value">latitude:</span> <span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">latitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_latitude</span>,
<span class="line-num">2100</span>     <span class="ruby-value">longitude:</span> <span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">longitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">2101</span>   )
<span class="line-num">2102</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_taxon_photo">
            
              <b>set_taxon_photo</b>()
            
            <a href="../classes/Observation.html#method-i-set_taxon_photo" name="method-i-set_taxon_photo" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_taxon_photo_source')" id="l_method-i-set_taxon_photo_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_taxon_photo_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3061</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_taxon_photo</span>
<span class="line-num">3062</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">research_grade?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">saved_change_to_quality_grade?</span>
<span class="line-num">3063</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">3064</span>     <span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">run_at:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">from_now</span> ).<span class="ruby-identifier">set_photo_from_observations</span>
<span class="line-num">3065</span>   <span class="ruby-keyword">end</span>
<span class="line-num">3066</span>   <span class="ruby-keyword">true</span>
<span class="line-num">3067</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_time_in_time_zone">
            
              <b>set_time_in_time_zone</b>()
            
            <a href="../classes/Observation.html#method-i-set_time_in_time_zone" name="method-i-set_time_in_time_zone" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Force time_observed_at into the time zone</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_time_in_time_zone_source')" id="l_method-i-set_time_in_time_zone_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_time_in_time_zone_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1336</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_time_in_time_zone</span>
<span class="line-num">1337</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1338</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_observed_at_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">time_zone_changed?</span>
<span class="line-num">1339</span>   
<span class="line-num">1340</span>   <span class="ruby-comment"># Render the time as a string</span>
<span class="line-num">1341</span>   <span class="ruby-identifier">time_s</span> = <span class="ruby-identifier">time_observed_at_before_type_cast</span>
<span class="line-num">1342</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_s</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">String</span>
<span class="line-num">1343</span>     <span class="ruby-identifier">time_s</span> = <span class="ruby-identifier">time_observed_at_before_type_cast</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)
<span class="line-num">1344</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1345</span>   
<span class="line-num">1346</span>   <span class="ruby-comment"># Get the time zone offset as a string and append it</span>
<span class="line-num">1347</span>   <span class="ruby-identifier">offset_s</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">time_s</span>).<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">time_zone</span>).<span class="ruby-identifier">formatted_offset</span>(<span class="ruby-keyword">false</span>)
<span class="line-num">1348</span>   <span class="ruby-identifier">time_s</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; #{offset_s}&quot;</span>
<span class="line-num">1349</span>   
<span class="line-num">1350</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">time_s</span>)
<span class="line-num">1351</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1352</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_time_zone">
            
              <b>set_time_zone</b>()
            
            <a href="../classes/Observation.html#method-i-set_time_zone" name="method-i-set_time_zone" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Set the time_zone of this observation if coordinates changes or zone not already set</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_time_zone_source')" id="l_method-i-set_time_zone_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_time_zone_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1282</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_time_zone</span>
<span class="line-num">1283</span>   <span class="ruby-comment"># Make sure blank is always nil</span>
<span class="line-num">1284</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1285</span>   <span class="ruby-comment"># If there are coordinates, use them to set the time zone, and reject</span>
<span class="line-num">1286</span>   <span class="ruby-comment"># changes to the time zone if the coordinates have not changed</span>
<span class="line-num">1287</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">1288</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_changed?</span>
<span class="line-num">1289</span>       <span class="ruby-identifier">lat</span> = ( <span class="ruby-identifier">latitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_latitude</span>.<span class="ruby-identifier">blank?</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">latitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_latitude</span>
<span class="line-num">1290</span>       <span class="ruby-identifier">lng</span> = ( <span class="ruby-identifier">longitude_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">private_longitude</span>.<span class="ruby-identifier">blank?</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">longitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">private_longitude</span>
<span class="line-num">1291</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-constant">TimeZoneGeometry</span>.<span class="ruby-identifier">time_zone_from_lat_lng</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lng</span> ).<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">1292</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">zic_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>[<span class="ruby-identifier">time_zone</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1293</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">time_zone_changed?</span>
<span class="line-num">1294</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-identifier">time_zone_was</span>
<span class="line-num">1295</span>       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">zic_time_zone</span> = <span class="ruby-identifier">zic_time_zone_was</span>
<span class="line-num">1296</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1297</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1298</span>   <span class="ruby-comment"># Try to assign a reasonable default time zone</span>
<span class="line-num">1299</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1300</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1301</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1302</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1303</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&#39;UTC&#39;</span>
<span class="line-num">1304</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1305</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>[<span class="ruby-identifier">time_zone</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">time_zone</span>]
<span class="line-num">1306</span>     <span class="ruby-comment"># We&#39;ve got a zic time zone</span>
<span class="line-num">1307</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">zic_time_zone</span> = <span class="ruby-identifier">time_zone</span>
<span class="line-num">1308</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">rails_tz</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-identifier">time_zone</span>]
<span class="line-num">1309</span>       <span class="ruby-identifier">rails_tz</span>
<span class="line-num">1310</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">INAT_MAPPING</span>[<span class="ruby-identifier">time_zone</span>]
<span class="line-num">1311</span>       <span class="ruby-comment"># Now we&#39;re in trouble, b/c the client specified a valid IANA time</span>
<span class="line-num">1312</span>       <span class="ruby-comment"># zone that TZInfo knows about, but it&#39;s one Rails chooses to ignore</span>
<span class="line-num">1313</span>       <span class="ruby-comment"># and doesn&#39;t provide any mapping for so... we have to map it</span>
<span class="line-num">1314</span>       <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">INAT_MAPPING</span>[<span class="ruby-identifier">time_zone</span>]
<span class="line-num">1315</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">time_zone</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^Etc\//</span>
<span class="line-num">1316</span>       <span class="ruby-comment"># If we don&#39;t have custom mapping and there&#39;s no fancy Rails wrapper</span>
<span class="line-num">1317</span>       <span class="ruby-comment"># and it&#39;s one of these weird oceanic Etc zones, use that as the</span>
<span class="line-num">1318</span>       <span class="ruby-comment"># time_zone. Rails can use that to cast times into other zones, even</span>
<span class="line-num">1319</span>       <span class="ruby-comment"># if it doesn&#39;t recognize it as its own zone</span>
<span class="line-num">1320</span>       <span class="ruby-identifier">time_zone</span>
<span class="line-num">1321</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1322</span>       <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">time_zone</span>].<span class="ruby-identifier">name</span>
<span class="line-num">1323</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1324</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1325</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">user</span>.<span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1326</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">zic_time_zone</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>[<span class="ruby-identifier">time_zone</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1327</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">zic_time_zone</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>[<span class="ruby-identifier">zic_time_zone</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>[<span class="ruby-identifier">zic_time_zone</span>]
<span class="line-num">1328</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">zic_time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>[<span class="ruby-identifier">zic_time_zone</span>]
<span class="line-num">1329</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1330</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1331</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_uri">
            
              <b>set_uri</b>()
            
            <a href="../classes/Observation.html#method-i-set_uri" name="method-i-set_uri" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_uri_source')" id="l_method-i-set_uri_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_uri_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2209</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_uri</span>
<span class="line-num">2210</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2211</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-value">uri:</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">observation_url</span>(<span class="ruby-identifier">id</span>))
<span class="line-num">2212</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2213</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2214</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-short_description">
            
              <b>short_description</b>()
            
            <a href="../classes/Observation.html#method-i-short_description" name="method-i-short_description" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-short_description_source')" id="l_method-i-short_description_source">show</a>
                

                

                
              </p>
              <div id="method-i-short_description_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2368</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">short_description</span>
<span class="line-num">2369</span>   <span class="ruby-identifier">short_observation_description</span>(<span class="ruby-keyword">self</span>)
<span class="line-num">2370</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-single_taxon_for_name">
            
              <b>single_taxon_for_name</b>(name)
            
            <a href="../classes/Observation.html#method-i-single_taxon_for_name" name="method-i-single_taxon_for_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-single_taxon_for_name_source')" id="l_method-i-single_taxon_for_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-single_taxon_for_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2104</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">single_taxon_for_name</span>(<span class="ruby-identifier">name</span>)
<span class="line-num">2105</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>(<span class="ruby-identifier">name</span>)
<span class="line-num">2106</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-single_taxon_id_for_name">
            
              <b>single_taxon_id_for_name</b>(name)
            
            <a href="../classes/Observation.html#method-i-single_taxon_id_for_name" name="method-i-single_taxon_id_for_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-single_taxon_id_for_name_source')" id="l_method-i-single_taxon_id_for_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-single_taxon_id_for_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2108</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">single_taxon_id_for_name</span>(<span class="ruby-identifier">name</span>)
<span class="line-num">2109</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>(<span class="ruby-identifier">name</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">2110</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sound_url">
            
              <b>sound_url</b>()
            
            <a href="../classes/Observation.html#method-i-sound_url" name="method-i-sound_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sound_url_source')" id="l_method-i-sound_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-sound_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2362</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sound_url</span>
<span class="line-num">2363</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span> = <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">LocalSound</span> ) }
<span class="line-num">2364</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>
<span class="line-num">2365</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2366</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sounds-3F">
            
              <b>sounds?</b>()
            
            <a href="../classes/Observation.html#method-i-sounds-3F" name="method-i-sounds-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sounds-3F_source')" id="l_method-i-sounds-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-sounds-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1445</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sounds?</span>
<span class="line-num">1446</span>   <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">?</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">1447</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-strip_species_guess">
            
              <b>strip_species_guess</b>()
            
            <a href="../classes/Observation.html#method-i-strip_species_guess" name="method-i-strip_species_guess" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Trim whitespace around species guess</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-strip_species_guess_source')" id="l_method-i-strip_species_guess_source">show</a>
                

                

                
              </p>
              <div id="method-i-strip_species_guess_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1274</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">strip_species_guess</span>
<span class="line-num">1275</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">species_guess</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip!</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">species_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1276</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1277</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-sw_latlon">
            
              <b>sw_latlon</b>()
            
            <a href="../classes/Observation.html#method-i-sw_latlon" name="method-i-sw_latlon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-sw_latlon_source')" id="l_method-i-sw_latlon_source">show</a>
                

                

                
              </p>
              <div id="method-i-sw_latlon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2519</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sw_latlon</span>
<span class="line-num">2520</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2521</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">latitude</span>
<span class="line-num">2522</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">2523</span>     <span class="ruby-identifier">half_cell</span> = <span class="ruby-constant">COORDINATE_UNCERTAINTY_CELL_SIZE</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
<span class="line-num">2524</span>     <span class="ruby-identifier">positional_accuracy_degrees</span> = <span class="ruby-identifier">positional_accuracy</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-constant">PLANETARY_RADIUS</span>) <span class="ruby-operator">*</span> <span class="ruby-value">360.0</span>
<span class="line-num">2525</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">half_cell</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">positional_accuracy_degrees</span>
<span class="line-num">2526</span>       <span class="ruby-identifier">uncertainty_cell_center_latlon</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">uncertainty_cell_center_latlon</span>( <span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span> )
<span class="line-num">2527</span>       <span class="ruby-keyword">return</span> [
<span class="line-num">2528</span>         <span class="ruby-identifier">uncertainty_cell_center_latlon</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">half_cell</span>,
<span class="line-num">2529</span>         <span class="ruby-identifier">uncertainty_cell_center_latlon</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">half_cell</span>
<span class="line-num">2530</span>       ]
<span class="line-num">2531</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2532</span>     <span class="ruby-keyword">return</span> [
<span class="line-num">2533</span>       <span class="ruby-identifier">latitude</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">positional_accuracy_degrees</span>,
<span class="line-num">2534</span>       <span class="ruby-identifier">longitude</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">positional_accuracy_degrees</span>
<span class="line-num">2535</span>     ]
<span class="line-num">2536</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2537</span>   <span class="ruby-identifier">private_sw_latlon</span>
<span class="line-num">2538</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-system_places">
            
              <b>system_places</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-system_places" name="method-i-system_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>The places that are theoretically controlled by site admins</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-system_places_source')" id="l_method-i-system_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-system_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2665</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">system_places</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">2666</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">system_places_for_latlon</span>( <span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">longitude</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">acc:</span> <span class="ruby-identifier">positional_accuracy</span> ) )
<span class="line-num">2667</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_and_ancestors">
            
              <b>taxon_and_ancestors</b>()
            
            <a href="../classes/Observation.html#method-i-taxon_and_ancestors" name="method-i-taxon_and_ancestors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_and_ancestors_source')" id="l_method-i-taxon_and_ancestors_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_and_ancestors_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2730</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_and_ancestors</span>
<span class="line-num">2731</span>   <span class="ruby-identifier">taxon</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestors</span>.<span class="ruby-identifier">to_a</span> <span class="ruby-operator">:</span> []
<span class="line-num">2732</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-time_observed_at_in_zone">
            
              <b>time_observed_at_in_zone</b>()
            
            <a href="../classes/Observation.html#method-i-time_observed_at_in_zone" name="method-i-time_observed_at_in_zone" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Return time_observed_at in the observation&#39;s time zone</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-time_observed_at_in_zone_source')" id="l_method-i-time_observed_at_in_zone_source">show</a>
                

                

                
              </p>
              <div id="method-i-time_observed_at_in_zone_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">919</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">time_observed_at_in_zone</span>
<span class="line-num">920</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span>
<span class="line-num">921</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_zone</span>)
<span class="line-num">922</span>   <span class="ruby-keyword">end</span>
<span class="line-num">923</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-time_observed_at_utc">
            
              <b>time_observed_at_utc</b>()
            
            <a href="../classes/Observation.html#method-i-time_observed_at_utc" name="method-i-time_observed_at_utc" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-time_observed_at_utc_source')" id="l_method-i-time_observed_at_utc_source">show</a>
                

                

                
              </p>
              <div id="method-i-time_observed_at_utc_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">854</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">time_observed_at_utc</span>
<span class="line-num">855</span>   <span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:utc</span>)
<span class="line-num">856</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-timezone_object">
            
              <b>timezone_object</b>()
            
            <a href="../classes/Observation.html#method-i-timezone_object" name="method-i-timezone_object" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-timezone_object_source')" id="l_method-i-timezone_object_source">show</a>
                

                

                
              </p>
              <div id="method-i-timezone_object_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">907</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">timezone_object</span>
<span class="line-num">908</span>   <span class="ruby-comment"># returns nil if the time_zone has an invalid value</span>
<span class="line-num">909</span>   (<span class="ruby-identifier">time_zone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">time_zone</span>)) <span class="ruby-operator">||</span>
<span class="line-num">910</span>     (<span class="ruby-identifier">zic_time_zone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">zic_time_zone</span>))
<span class="line-num">911</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-timezone_offset">
            
              <b>timezone_offset</b>()
            
            <a href="../classes/Observation.html#method-i-timezone_offset" name="method-i-timezone_offset" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-timezone_offset_source')" id="l_method-i-timezone_offset_source">show</a>
                

                

                
              </p>
              <div id="method-i-timezone_offset_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">913</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">timezone_offset</span>
<span class="line-num">914</span>   <span class="ruby-comment"># returns nil if the time_zone has an invalid value</span>
<span class="line-num">915</span>   (<span class="ruby-identifier">timezone_object</span> <span class="ruby-operator">||</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;UTC&quot;</span>)).<span class="ruby-identifier">formatted_offset</span>
<span class="line-num">916</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_plain_s">
            
              <b>to_plain_s</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-to_plain_s" name="method-i-to_plain_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_plain_s_source')" id="l_method-i-to_plain_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_plain_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">789</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_plain_s</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">790</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_by_user )</span>
<span class="line-num">791</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place )</span>
<span class="line-num">792</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_by_user )</span>
<span class="line-num">793</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_in_month_year_by_user )</span>
<span class="line-num">794</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_on_day )</span>
<span class="line-num">795</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_on_day_at_time )</span>
<span class="line-num">796</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_on_day_at_time_by_user )</span>
<span class="line-num">797</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_from_place_on_day_by_user )</span>
<span class="line-num">798</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_on_day )</span>
<span class="line-num">799</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_on_day_at_time )</span>
<span class="line-num">800</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_on_day_at_time_by_user )</span>
<span class="line-num">801</span>   <span class="ruby-comment"># I18n.t( :observation_brief_something_on_day_by_user )</span>
<span class="line-num">802</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_by_user )</span>
<span class="line-num">803</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place )</span>
<span class="line-num">804</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_by_user )</span>
<span class="line-num">805</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_in_month_year_by_user )</span>
<span class="line-num">806</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_on_day )</span>
<span class="line-num">807</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_on_day_at_time )</span>
<span class="line-num">808</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_on_day_at_time_by_user )</span>
<span class="line-num">809</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_from_place_on_day_by_user )</span>
<span class="line-num">810</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_on_day )</span>
<span class="line-num">811</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_on_day_at_time )</span>
<span class="line-num">812</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_on_day_at_time_by_user )</span>
<span class="line-num">813</span>   <span class="ruby-comment"># I18n.t( :observation_brief_taxon_on_day_by_user )</span>
<span class="line-num">814</span>   <span class="ruby-identifier">i18n_vars</span> = {}
<span class="line-num">815</span>   <span class="ruby-identifier">key</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">816</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:taxon</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:viewer</span>]
<span class="line-num">817</span>       <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">render</span>( <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;taxa/taxon.txt&quot;</span>, <span class="ruby-value">locals:</span> { <span class="ruby-value">taxon:</span> <span class="ruby-identifier">taxon</span>, <span class="ruby-value">viewer:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:viewer</span>] } )
<span class="line-num">818</span>     <span class="ruby-keyword">else</span>
<span class="line-num">819</span>       <span class="ruby-identifier">common_name</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">820</span>     <span class="ruby-keyword">end</span>
<span class="line-num">821</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:taxon</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">822</span>     <span class="ruby-string">&quot;taxon&quot;</span>
<span class="line-num">823</span>   <span class="ruby-keyword">else</span>
<span class="line-num">824</span>     <span class="ruby-string">&quot;something&quot;</span>
<span class="line-num">825</span>   <span class="ruby-keyword">end</span>
<span class="line-num">826</span>   <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">place_guess</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_place_guess</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">827</span>     <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_from_place&quot;</span>
<span class="line-num">828</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:place</span>] = <span class="ruby-identifier">place_guess</span>
<span class="line-num">829</span>   <span class="ruby-keyword">end</span>
<span class="line-num">830</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinates_viewable_by?</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:viewer</span>] )
<span class="line-num">831</span>     <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">832</span>       <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_on_day&quot;</span>
<span class="line-num">833</span>       <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:day</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">l</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observed_on</span>, <span class="ruby-value">format:</span> <span class="ruby-value">:long</span> )
<span class="line-num">834</span>     <span class="ruby-keyword">end</span>
<span class="line-num">835</span>     <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_observed_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_time</span>]
<span class="line-num">836</span>       <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_at_time&quot;</span>
<span class="line-num">837</span>       <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:time</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">l</span>( <span class="ruby-identifier">time_observed_at_in_zone</span>, <span class="ruby-value">format:</span> <span class="ruby-value">:compact</span> )
<span class="line-num">838</span>     <span class="ruby-keyword">end</span>
<span class="line-num">839</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">840</span>     <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_in_month_year&quot;</span>
<span class="line-num">841</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:month</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">l</span>( <span class="ruby-identifier">observed_on</span>, <span class="ruby-value">format:</span> <span class="ruby-string">&quot;%B&quot;</span> )
<span class="line-num">842</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:year</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">l</span>( <span class="ruby-identifier">observed_on</span>, <span class="ruby-value">format:</span> <span class="ruby-string">&quot;%Y&quot;</span> )
<span class="line-num">843</span>   <span class="ruby-keyword">end</span>
<span class="line-num">844</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_user</span>]
<span class="line-num">845</span>     <span class="ruby-identifier">key</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;_by_user&quot;</span>
<span class="line-num">846</span>     <span class="ruby-identifier">i18n_vars</span>[<span class="ruby-value">:user</span>] = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">try_methods</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>)
<span class="line-num">847</span>   <span class="ruby-keyword">end</span>
<span class="line-num">848</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;something&quot;</span>
<span class="line-num">849</span>     <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;observation_brief_#{key}&quot;</span>
<span class="line-num">850</span>   <span class="ruby-keyword">end</span>
<span class="line-num">851</span>   <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-identifier">key</span>, <span class="ruby-identifier">i18n_vars</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">default:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:something</span> ) ) )
<span class="line-num">852</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../classes/Observation.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>help_txt_for :species_guess, &lt;&lt;-DESC</p>

<pre><code>Type a name for what you saw.  It can be common or scientific, accurate 
or just a placeholder. When you enter it, we&#39;ll try to look it up and find
the matching species of higher level taxon.
</code></pre>

<p>DESC</p>

<p>instruction_for :place_guess, “Type the name of a place” help_txt_for :place_guess, &lt;&lt;-DESC</p>

<pre><code>Enter the name of a place and we&#39;ll try to find where it is. If we find
it, you can drag the map marker around to get more specific.
</code></pre>

<p>DESC</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">785</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">786</span>   <span class="ruby-node">&quot;&lt;Observation #{self.id}: #{to_plain_s}&gt;&quot;</span>
<span class="line-num">787</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-trim_user_agent">
            
              <b>trim_user_agent</b>()
            
            <a href="../classes/Observation.html#method-i-trim_user_agent" name="method-i-trim_user_agent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-trim_user_agent_source')" id="l_method-i-trim_user_agent_source">show</a>
                

                

                
              </p>
              <div id="method-i-trim_user_agent_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2203</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">trim_user_agent</span>
<span class="line-num">2204</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_agent</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2205</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user_agent</span> = <span class="ruby-identifier">user_agent</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">254</span>]
<span class="line-num">2206</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2207</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-uncertainty_cell_diagonal_meters">
            
              <b>uncertainty_cell_diagonal_meters</b>()
            
            <a href="../classes/Observation.html#method-i-uncertainty_cell_diagonal_meters" name="method-i-uncertainty_cell_diagonal_meters" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Distance of a diagonal from corner to corner across the uncertainty cell for this observation&#39;s coordinates.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-uncertainty_cell_diagonal_meters_source')" id="l_method-i-uncertainty_cell_diagonal_meters_source">show</a>
                

                

                
              </p>
              <div id="method-i-uncertainty_cell_diagonal_meters_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2577</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">uncertainty_cell_diagonal_meters</span>
<span class="line-num">2578</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">georeferenced?</span>
<span class="line-num">2579</span>   <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude</span>
<span class="line-num">2580</span>   <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">longitude</span>
<span class="line-num">2581</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">uncertainty_cell_diagonal_meters</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">2582</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unobscure_coordinates">
            
              <b>unobscure_coordinates</b>()
            
            <a href="../classes/Observation.html#method-i-unobscure_coordinates" name="method-i-unobscure_coordinates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unobscure_coordinates_source')" id="l_method-i-unobscure_coordinates_source">show</a>
                

                

                
              </p>
              <div id="method-i-unobscure_coordinates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1690</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unobscure_coordinates</span>
<span class="line-num">1691</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">coordinates_obscured?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">coordinates_private?</span>
<span class="line-num">1692</span> 
<span class="line-num">1693</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">geoprivacy</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1694</span> 
<span class="line-num">1695</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">private_latitude</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">latitude_changed?</span>
<span class="line-num">1696</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">private_longitude</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">longitude_changed?</span>
<span class="line-num">1697</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_latitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1698</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">private_longitude</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1699</span>   <span class="ruby-identifier">set_geom_from_latlon</span>
<span class="line-num">1700</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">obscuration_changed</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1701</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_all_licenses">
            
              <b>update_all_licenses</b>()
            
            <a href="../classes/Observation.html#method-i-update_all_licenses" name="method-i-update_all_licenses" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_all_licenses_source')" id="l_method-i-update_all_licenses_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_all_licenses_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2222</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_all_licenses</span>
<span class="line-num">2223</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">make_licenses_same</span>.<span class="ruby-identifier">yesish?</span>
<span class="line-num">2224</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-value">license:</span> <span class="ruby-identifier">license</span>)
<span class="line-num">2225</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">index_observations_later</span>
<span class="line-num">2226</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2227</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_default_license">
            
              <b>update_default_license</b>()
            
            <a href="../classes/Observation.html#method-i-update_default_license" name="method-i-update_default_license" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_default_license_source')" id="l_method-i-update_default_license_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_default_license_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2216</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_default_license</span>
<span class="line-num">2217</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">make_license_default</span>.<span class="ruby-identifier">yesish?</span>
<span class="line-num">2218</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">update_attribute</span>( <span class="ruby-value">:preferred_observation_license</span>, <span class="ruby-identifier">license</span> )
<span class="line-num">2219</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2220</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_identifications">
            
              <b>update_identifications</b>()
            
            <a href="../classes/Observation.html#method-i-update_identifications" name="method-i-update_identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Adds, updates, or destroys the identification corresponding to the taxon the user selected.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_identifications_source')" id="l_method-i-update_identifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_identifications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1157</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_identifications</span>
<span class="line-num">1158</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@skip_identifications</span>
<span class="line-num">1159</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_id_changed?</span>
<span class="line-num">1160</span>   <span class="ruby-identifier">owners_ident</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id asc&quot;</span> ).<span class="ruby-identifier">last</span>
<span class="line-num">1161</span>   <span class="ruby-identifier">owner_editing_own_obs</span> = <span class="ruby-identifier">editing_user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">1162</span>   
<span class="line-num">1163</span>   <span class="ruby-comment"># Don&#39;t mess with the owner&#39;s ident if they owner didn&#39;t change anything</span>
<span class="line-num">1164</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">owner_editing_own_obs</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1165</span>     <span class="ruby-comment"># If there&#39;s a taxon we need to make sure the owner&#39;s ident agrees</span>
<span class="line-num">1166</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1167</span>       <span class="ruby-comment"># If the owner doesn&#39;t have an identification for this obs, make one</span>
<span class="line-num">1168</span>       <span class="ruby-identifier">attrs</span> = {
<span class="line-num">1169</span>         <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span>,
<span class="line-num">1170</span>         <span class="ruby-value">taxon:</span> <span class="ruby-identifier">taxon</span>,
<span class="line-num">1171</span>         <span class="ruby-value">observation:</span> <span class="ruby-keyword">self</span>,
<span class="line-num">1172</span>         <span class="ruby-value">skip_observation:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1173</span>         <span class="ruby-value">vision:</span> <span class="ruby-identifier">owners_identification_from_vision_requested</span>
<span class="line-num">1174</span>       }
<span class="line-num">1175</span>       <span class="ruby-identifier">owners_ident</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1176</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">build</span>( <span class="ruby-identifier">attrs</span> )
<span class="line-num">1177</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1178</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">create</span>( <span class="ruby-identifier">attrs</span> )
<span class="line-num">1179</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1180</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">owners_ident</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">current?</span>
<span class="line-num">1181</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">1182</span>         <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">current:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">skip_observation:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1183</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1184</span>         <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">skip_observation</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1185</span>         <span class="ruby-identifier">owners_ident</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1186</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1187</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1188</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1189</span>   
<span class="line-num">1190</span>   <span class="ruby-identifier">update_stats</span>( <span class="ruby-value">skip_save:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1191</span>   
<span class="line-num">1192</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1193</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_mappable">
            
              <b>update_mappable</b>()
            
            <a href="../classes/Observation.html#method-i-update_mappable" name="method-i-update_mappable" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_mappable_source')" id="l_method-i-update_mappable_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_mappable_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3036</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_mappable</span>
<span class="line-num">3037</span>   <span class="ruby-identifier">update_column</span>(<span class="ruby-value">:mappable</span>, <span class="ruby-identifier">calculate_mappable</span>)
<span class="line-num">3038</span>   <span class="ruby-keyword">true</span>
<span class="line-num">3039</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observations_places">
            
              <b>update_observations_places</b>()
            
            <a href="../classes/Observation.html#method-i-update_observations_places" name="method-i-update_observations_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observations_places_source')" id="l_method-i-update_observations_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observations_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3055</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observations_places</span>
<span class="line-num">3056</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">update_observations_places</span>(<span class="ruby-value">ids:</span> [ <span class="ruby-identifier">id</span> ])
<span class="line-num">3057</span>   <span class="ruby-comment"># reload the association since we added the records using SQL</span>
<span class="line-num">3058</span>   <span class="ruby-identifier">observations_places</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">3059</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_public_positional_accuracy">
            
              <b>update_public_positional_accuracy</b>()
            
            <a href="../classes/Observation.html#method-i-update_public_positional_accuracy" name="method-i-update_public_positional_accuracy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_public_positional_accuracy_source')" id="l_method-i-update_public_positional_accuracy_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_public_positional_accuracy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3019</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_public_positional_accuracy</span>
<span class="line-num">3020</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">public_positional_accuracy</span> = <span class="ruby-identifier">calculate_public_positional_accuracy</span>
<span class="line-num">3021</span>   <span class="ruby-identifier">update_column</span>(<span class="ruby-value">:public_positional_accuracy</span>, <span class="ruby-identifier">public_positional_accuracy</span>)
<span class="line-num">3022</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_quality_metrics">
            
              <b>update_quality_metrics</b>()
            
            <a href="../classes/Observation.html#method-i-update_quality_metrics" name="method-i-update_quality_metrics" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_quality_metrics_source')" id="l_method-i-update_quality_metrics_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_quality_metrics_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2309</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_quality_metrics</span>
<span class="line-num">2310</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_quality_metrics</span>
<span class="line-num">2311</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">captive_flag</span>.<span class="ruby-identifier">yesish?</span>
<span class="line-num">2312</span>     <span class="ruby-constant">QualityMetric</span>.<span class="ruby-identifier">vote</span>( <span class="ruby-identifier">user</span>, <span class="ruby-keyword">self</span>, <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>, <span class="ruby-keyword">false</span> )
<span class="line-num">2313</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">captive_flag</span>.<span class="ruby-identifier">noish?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">qm</span> = <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>} )
<span class="line-num">2314</span>     <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">agree:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">2315</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">force_quality_metrics</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">qm</span> = <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>} )
<span class="line-num">2316</span>     <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">2317</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2318</span>   <span class="ruby-identifier">system_captive_vote</span> = <span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span> }
<span class="line-num">2319</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">probably_captive?</span>
<span class="line-num">2320</span>     <span class="ruby-constant">QualityMetric</span>.<span class="ruby-identifier">vote</span>( <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">self</span>, <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>, <span class="ruby-keyword">false</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">system_captive_vote</span>
<span class="line-num">2321</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">system_captive_vote</span>
<span class="line-num">2322</span>     <span class="ruby-identifier">system_captive_vote</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">2323</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2324</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2325</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_stats">
            
              <b>update_stats</b>(options = {})
            
            <a href="../classes/Observation.html#method-i-update_stats" name="method-i-update_stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_stats_source')" id="l_method-i-update_stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_stats_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2390</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_stats</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">2391</span>   <span class="ruby-identifier">idents</span> = [<span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">to_a</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2392</span>   <span class="ruby-identifier">current_idents</span> = <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:current?</span>)
<span class="line-num">2393</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2394</span>     <span class="ruby-identifier">num_agreements</span>    = <span class="ruby-value">0</span>
<span class="line-num">2395</span>     <span class="ruby-identifier">num_disagreements</span> = <span class="ruby-value">0</span>
<span class="line-num">2396</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2397</span>     <span class="ruby-identifier">nodes</span> = <span class="ruby-identifier">community_taxon_nodes</span>
<span class="line-num">2398</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> = <span class="ruby-identifier">nodes</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_id</span>}
<span class="line-num">2399</span>       <span class="ruby-identifier">num_agreements</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">:cumulative_count</span>]
<span class="line-num">2400</span>       <span class="ruby-identifier">num_disagreements</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">:disagreement_count</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">:conservative_disagreement_count</span>]
<span class="line-num">2401</span>       <span class="ruby-identifier">num_agreements</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_idents</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>}
<span class="line-num">2402</span>       <span class="ruby-identifier">num_agreements</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_idents</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">1</span>
<span class="line-num">2403</span>       <span class="ruby-identifier">num_disagreements</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_idents</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">1</span>
<span class="line-num">2404</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2405</span>       <span class="ruby-identifier">num_agreements</span>    = <span class="ruby-identifier">current_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">is_agreement?</span>(<span class="ruby-value">:observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">self</span>)}.<span class="ruby-identifier">size</span>
<span class="line-num">2406</span>       <span class="ruby-identifier">num_disagreements</span> = <span class="ruby-identifier">current_idents</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">is_disagreement?</span>(<span class="ruby-value">:observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">self</span>)}.<span class="ruby-identifier">size</span>
<span class="line-num">2407</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2408</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2409</span>   
<span class="line-num">2410</span>   <span class="ruby-comment"># Kinda lame, but Observation#get_quality_grade relies on these numbers</span>
<span class="line-num">2411</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">num_identification_agreements</span> = <span class="ruby-identifier">num_agreements</span>
<span class="line-num">2412</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">num_identification_disagreements</span> = <span class="ruby-identifier">num_disagreements</span>
<span class="line-num">2413</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifications_count</span> = <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">size</span>
<span class="line-num">2414</span>   <span class="ruby-identifier">new_quality_grade</span> = <span class="ruby-identifier">get_quality_grade</span>
<span class="line-num">2415</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">quality_grade</span> = <span class="ruby-identifier">new_quality_grade</span>
<span class="line-num">2416</span>   
<span class="line-num">2417</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_save</span>] <span class="ruby-operator">&amp;&amp;</span> (
<span class="line-num">2418</span>       <span class="ruby-identifier">num_identification_agreements_changed?</span> <span class="ruby-operator">||</span>
<span class="line-num">2419</span>       <span class="ruby-identifier">num_identification_disagreements_changed?</span> <span class="ruby-operator">||</span>
<span class="line-num">2420</span>       <span class="ruby-identifier">quality_grade_changed?</span> <span class="ruby-operator">||</span>
<span class="line-num">2421</span>       <span class="ruby-identifier">identifications_count_changed?</span>)
<span class="line-num">2422</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">update_all</span>(
<span class="line-num">2423</span>       <span class="ruby-value">num_identification_agreements:</span> <span class="ruby-identifier">num_agreements</span>,
<span class="line-num">2424</span>       <span class="ruby-value">num_identification_disagreements:</span> <span class="ruby-identifier">num_disagreements</span>,
<span class="line-num">2425</span>       <span class="ruby-value">quality_grade:</span> <span class="ruby-identifier">new_quality_grade</span>,
<span class="line-num">2426</span>       <span class="ruby-value">identifications_count:</span> <span class="ruby-identifier">identifications_count</span>)
<span class="line-num">2427</span>     <span class="ruby-identifier">refresh_check_lists</span>
<span class="line-num">2428</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2429</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_taxon_counter_caches">
            
              <b>update_taxon_counter_caches</b>()
            
            <a href="../classes/Observation.html#method-i-update_taxon_counter_caches" name="method-i-update_taxon_counter_caches" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_taxon_counter_caches_source')" id="l_method-i-update_taxon_counter_caches_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_taxon_counter_caches_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2229</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_taxon_counter_caches</span>
<span class="line-num">2230</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">destroyed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_taxon_id?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">transaction_include_any_action?</span>( [<span class="ruby-value">:create</span>] )
<span class="line-num">2231</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">2232</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2233</span> 
<span class="line-num">2234</span>   <span class="ruby-identifier">taxon_ids</span> = [<span class="ruby-identifier">taxon_id_before_last_save</span>, <span class="ruby-identifier">taxon_id</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2235</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2236</span>     <span class="ruby-identifier">taxon_ids_including_ancestors</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">taxon_ids</span>).
<span class="line-num">2237</span>       <span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:self_and_ancestor_ids</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2238</span>     <span class="ruby-identifier">taxon_ids_including_ancestors</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tid</span><span class="ruby-operator">|</span>
<span class="line-num">2239</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">2240</span>         <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">2241</span>         <span class="ruby-value">run_at:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">hour</span>.<span class="ruby-identifier">from_now</span>,
<span class="line-num">2242</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Taxon::update_observation_counts&quot;:</span> <span class="ruby-identifier">tid</span> }
<span class="line-num">2243</span>       ).<span class="ruby-identifier">update_observation_counts</span>( <span class="ruby-value">taxon_ids:</span> [<span class="ruby-identifier">tid</span>] )
<span class="line-num">2244</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2245</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2246</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2247</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_counter_caches">
            
              <b>update_user_counter_caches</b>()
            
            <a href="../classes/Observation.html#method-i-update_user_counter_caches" name="method-i-update_user_counter_caches" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_counter_caches_source')" id="l_method-i-update_user_counter_caches_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_counter_caches_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2283</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_counter_caches</span>
<span class="line-num">2284</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">2285</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">2286</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::update_observations_counter_cache&quot;:</span> <span class="ruby-identifier">user_id</span> },
<span class="line-num">2287</span>     <span class="ruby-value">run_at:</span> <span class="ruby-value">15</span>.<span class="ruby-identifier">minutes</span>.<span class="ruby-identifier">from_now</span>
<span class="line-num">2288</span>   ).<span class="ruby-identifier">update_observations_counter_cache</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">2289</span>   <span class="ruby-comment"># this is only called on create and delete. Run a species count if this is</span>
<span class="line-num">2290</span>   <span class="ruby-comment"># the first obs of this taxon on create or last obs of this taxon on delete</span>
<span class="line-num">2291</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2292</span>     <span class="ruby-operator">!</span><span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon_id</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id != ?&quot;</span>, <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">2293</span>     <span class="ruby-identifier">update_user_species_counter_cache_later</span>
<span class="line-num">2294</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2295</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2296</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_counter_caches_after_create">
            
              <b>update_user_counter_caches_after_create</b>()
            
            <a href="../classes/Observation.html#method-i-update_user_counter_caches_after_create" name="method-i-update_user_counter_caches_after_create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_counter_caches_after_create_source')" id="l_method-i-update_user_counter_caches_after_create_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_counter_caches_after_create_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2249</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_counter_caches_after_create</span>
<span class="line-num">2250</span>   <span class="ruby-comment"># For immediate gratification</span>
<span class="line-num">2251</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">observations_count:</span> [<span class="ruby-identifier">user</span>.<span class="ruby-identifier">observations_count</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span> )
<span class="line-num">2252</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">2253</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">2254</span>   <span class="ruby-comment"># For accuracy</span>
<span class="line-num">2255</span>   <span class="ruby-identifier">update_user_counter_caches</span>
<span class="line-num">2256</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2257</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_counter_caches_after_destroy">
            
              <b>update_user_counter_caches_after_destroy</b>()
            
            <a href="../classes/Observation.html#method-i-update_user_counter_caches_after_destroy" name="method-i-update_user_counter_caches_after_destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_counter_caches_after_destroy_source')" id="l_method-i-update_user_counter_caches_after_destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_counter_caches_after_destroy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2259</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_counter_caches_after_destroy</span>
<span class="line-num">2260</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">2261</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">any?</span>
<span class="line-num">2262</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">observations_count:</span> [<span class="ruby-identifier">user</span>.<span class="ruby-identifier">observations_count</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span> )
<span class="line-num">2263</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">2264</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">2265</span>   <span class="ruby-identifier">update_user_counter_caches</span>
<span class="line-num">2266</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2267</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_counter_caches_after_update">
            
              <b>update_user_counter_caches_after_update</b>()
            
            <a href="../classes/Observation.html#method-i-update_user_counter_caches_after_update" name="method-i-update_user_counter_caches_after_update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_counter_caches_after_update_source')" id="l_method-i-update_user_counter_caches_after_update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_counter_caches_after_update_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2269</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_counter_caches_after_update</span>
<span class="line-num">2270</span>   <span class="ruby-comment"># run a species count if this is a new taxon to the user,</span>
<span class="line-num">2271</span>   <span class="ruby-comment"># or the previous taxon no longer exists</span>
<span class="line-num">2272</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id_changed?</span> <span class="ruby-operator">&amp;&amp;</span> (
<span class="line-num">2273</span>     ( <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2274</span>       <span class="ruby-operator">!</span><span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon_id</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id != ?&quot;</span>, <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">exists?</span> ) <span class="ruby-operator">||</span>
<span class="line-num">2275</span>     ( <span class="ruby-identifier">taxon_id_was</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2276</span>       <span class="ruby-operator">!</span><span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon_id_was</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id != ?&quot;</span>, <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">exists?</span> )
<span class="line-num">2277</span>   )
<span class="line-num">2278</span>     <span class="ruby-identifier">update_user_species_counter_cache_later</span>
<span class="line-num">2279</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2280</span>   <span class="ruby-keyword">true</span>
<span class="line-num">2281</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_species_counter_cache_later">
            
              <b>update_user_species_counter_cache_later</b>()
            
            <a href="../classes/Observation.html#method-i-update_user_species_counter_cache_later" name="method-i-update_user_species_counter_cache_later" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_species_counter_cache_later_source')" id="l_method-i-update_user_species_counter_cache_later_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_species_counter_cache_later_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2298</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_species_counter_cache_later</span>
<span class="line-num">2299</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">2300</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::update_species_counter_cache&quot;:</span> <span class="ruby-identifier">user_id</span> },
<span class="line-num">2301</span>     <span class="ruby-value">run_at:</span> <span class="ruby-value">15</span>.<span class="ruby-identifier">minutes</span>.<span class="ruby-identifier">from_now</span>
<span class="line-num">2302</span>   ).<span class="ruby-identifier">update_species_counter_cache</span>( <span class="ruby-identifier">user_id</span> )
<span class="line-num">2303</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-url">
            
              <b>url</b>()
            
            <a href="../classes/Observation.html#method-i-url" name="method-i-url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-url_source')" id="l_method-i-url_source">show</a>
                

                

                
              </p>
              <div id="method-i-url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2382</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">url</span>
<span class="line-num">2383</span>   <span class="ruby-identifier">uri</span>
<span class="line-num">2384</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user_login">
            
              <b>user_login</b>()
            
            <a href="../classes/Observation.html#method-i-user_login" name="method-i-user_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_login_source')" id="l_method-i-user_login_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_login_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">2386</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user_login</span>
<span class="line-num">2387</span>   <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login</span>
<span class="line-num">2388</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user_viewed_updates">
            
              <b>user_viewed_updates</b>(user_id)
            
            <a href="../classes/Observation.html#method-i-user_viewed_updates" name="method-i-user_viewed_updates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_viewed_updates_source')" id="l_method-i-user_viewed_updates_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_viewed_updates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3305</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user_viewed_updates</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">3306</span>   <span class="ruby-identifier">obs_updates</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">resource:</span> <span class="ruby-keyword">self</span>)
<span class="line-num">3307</span>   <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">user_viewed_updates</span>(<span class="ruby-identifier">obs_updates</span>, <span class="ruby-identifier">user_id</span>)
<span class="line-num">3308</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-verifiable-3F">
            
              <b>verifiable?</b>()
            
            <a href="../classes/Observation.html#method-i-verifiable-3F" name="method-i-verifiable-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-verifiable-3F_source')" id="l_method-i-verifiable-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-verifiable-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1434</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifiable?</span>
<span class="line-num">1435</span>   [ <span class="ruby-constant">NEEDS_ID</span>, <span class="ruby-constant">RESEARCH_GRADE</span> ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">quality_grade</span>)
<span class="line-num">1436</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-voted_in_to_needs_id-3F">
            
              <b>voted_in_to_needs_id?</b>()
            
            <a href="../classes/Observation.html#method-i-voted_in_to_needs_id-3F" name="method-i-voted_in_to_needs_id-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-voted_in_to_needs_id-3F_source')" id="l_method-i-voted_in_to_needs_id-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-voted_in_to_needs_id-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3189</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">voted_in_to_needs_id?</span>
<span class="line-num">3190</span>   <span class="ruby-identifier">needs_id_upvotes_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">needs_id_downvotes_count</span>
<span class="line-num">3191</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-voted_out_of_needs_id-3F">
            
              <b>voted_out_of_needs_id?</b>()
            
            <a href="../classes/Observation.html#method-i-voted_out_of_needs_id-3F" name="method-i-voted_out_of_needs_id-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-voted_out_of_needs_id-3F_source')" id="l_method-i-voted_out_of_needs_id-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-voted_out_of_needs_id-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">3185</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">voted_out_of_needs_id?</span>
<span class="line-num">3186</span>   <span class="ruby-identifier">needs_id_downvotes_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">needs_id_upvotes_count</span>
<span class="line-num">3187</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-was_georeferenced-3F">
            
              <b>was_georeferenced?</b>()
            
            <a href="../classes/Observation.html#method-i-was_georeferenced-3F" name="method-i-was_georeferenced-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-was_georeferenced-3F_source')" id="l_method-i-was_georeferenced-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-was_georeferenced-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/observation.rb</span>
<span class="line-num">1383</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">was_georeferenced?</span>
<span class="line-num">1384</span>   ( <span class="ruby-identifier">latitude_before_last_save</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">longitude_before_last_save</span> ) <span class="ruby-operator">||</span>
<span class="line-num">1385</span>     ( <span class="ruby-identifier">private_latitude_before_last_save</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">private_longitude_before_last_save</span> )
<span class="line-num">1386</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
