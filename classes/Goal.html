<!DOCTYPE html>
<html lang="en">
<head>
    <title>Goal</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Goal"]'>


    <meta property="og:title" value="Goal">

  

    <meta name="keywords" content="Goal class, check_for_completion!, create_community_goal_participants, ended?, must_end_in_the_future, rules_validate_against?, validate_and_add_contribution">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Goal
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/models/goal_rb.html">app/models/goal.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-check_for_completion-21">check_for_completion!</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_community_goal_participants">create_community_goal_participants</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-ended-3F">ended?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-must_end_in_the_future">must_end_in_the_future</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-rules_validate_against-3F">rules_validate_against?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-validate_and_add_contribution">validate_and_add_contribution</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-check_for_completion-21">
            
              <b>check_for_completion!</b>(goal_participant=nil)
            
            <a href="../classes/Goal.html#method-i-check_for_completion-21" name="method-i-check_for_completion-21" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Most goals will be individual goals, however some, like our initial goal of 5,000 observations can be community based.  Because of that, the goal should be able to check for itself to see if it is completed, and if it is, and it&#39;s a community goal, it notes it to itself.  If it is completed and it is an individual goal, it notes it to the  goal_participant object</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-check_for_completion-21_source')" id="l_method-i-check_for_completion-21_source">show</a>
                

                

                
              </p>
              <div id="method-i-check_for_completion-21_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">33</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_for_completion!</span>(<span class="ruby-identifier">goal_participant</span>=<span class="ruby-keyword">nil</span>)
<span class="line-num">34</span>   <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">goal_type</span>
<span class="line-num">35</span>     <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;community&#39;</span>
<span class="line-num">36</span>       <span class="ruby-identifier">contribution_count</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">goal_contributions</span>.<span class="ruby-identifier">count</span>
<span class="line-num">37</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">contribution_count</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">number_of_contributions_required</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">38</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">completed</span> = <span class="ruby-keyword">true</span>
<span class="line-num">39</span>         <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
<span class="line-num">40</span>       <span class="ruby-keyword">end</span>
<span class="line-num">41</span>     <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;individual&#39;</span>
<span class="line-num">42</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">goal_participant</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">43</span>         <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Must provide a goal contribution object when checking individual goal completions&quot;</span>
<span class="line-num">44</span>       <span class="ruby-keyword">end</span>
<span class="line-num">45</span>       <span class="ruby-identifier">completed</span> = <span class="ruby-identifier">goal_participant</span>.<span class="ruby-identifier">goal_contributions</span>.<span class="ruby-identifier">count</span>
<span class="line-num">46</span>       <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">number_of_contributions_required</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">completed</span>
<span class="line-num">47</span>         <span class="ruby-identifier">goal_participant</span>.<span class="ruby-identifier">goal_completed</span> = <span class="ruby-keyword">true</span>
<span class="line-num">48</span>         <span class="ruby-identifier">goal_participant</span>.<span class="ruby-identifier">save</span>
<span class="line-num">49</span>       <span class="ruby-keyword">end</span>
<span class="line-num">50</span>   <span class="ruby-keyword">end</span>
<span class="line-num">51</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_community_goal_participants">
            
              <b>create_community_goal_participants</b>()
            
            <a href="../classes/Goal.html#method-i-create_community_goal_participants" name="method-i-create_community_goal_participants" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Watch out for this! This might run very slowly when there are a bazzillion inaturaslits, but it should work for now.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_community_goal_participants_source')" id="l_method-i-create_community_goal_participants_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_community_goal_participants_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">56</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_community_goal_participants</span>
<span class="line-num">57</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">goal_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;community&#39;</span>
<span class="line-num">58</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">users</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:all</span>)
<span class="line-num">59</span>   <span class="ruby-keyword">end</span>
<span class="line-num">60</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ended-3F">
            
              <b>ended?</b>()
            
            <a href="../classes/Goal.html#method-i-ended-3F" name="method-i-ended-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>checks to see if the goal has ended __NOT__ completed!</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ended-3F_source')" id="l_method-i-ended-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-ended-3F_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">63</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ended?</span>
<span class="line-num">64</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ends_at</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">65</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ends_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">66</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-must_end_in_the_future">
            
              <b>must_end_in_the_future</b>()
            
            <a href="../classes/Goal.html#method-i-must_end_in_the_future" name="method-i-must_end_in_the_future" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-must_end_in_the_future_source')" id="l_method-i-must_end_in_the_future_source">show</a>
                

                

                
              </p>
              <div id="method-i-must_end_in_the_future_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">68</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">must_end_in_the_future</span>
<span class="line-num">69</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ended?</span>
<span class="line-num">70</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:ends_at</span>, <span class="ruby-string">&quot;must be in the future&quot;</span>)
<span class="line-num">71</span>   <span class="ruby-keyword">end</span>
<span class="line-num">72</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rules_validate_against-3F">
            
              <b>rules_validate_against?</b>(thing)
            
            <a href="../classes/Goal.html#method-i-rules_validate_against-3F" name="method-i-rules_validate_against-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Receives thing, marshals all of the rules associated with itself, and runs through them one by one.  If thing passes all the rules, passes_all_rules? returns true.</p>

<p>Right now this represents a simple model whereby each object is tested against each rule.  It might make more sense to only test each object against the rules which share the same class.  Otherwise each rule must handle all types of objects for them to be reusable.</p>

<p>For example, we test an observation against 2 rules, one in the  <a href="Observation.html"><code>Observation</code></a> class that sees if the observation was recorded before a certain date, an another in the <a href="Taxon.html"><code>Taxon</code></a> class that sees if a species is found in a taxon. The rule within the <a href="Taxon.html"><code>Taxon</code></a> class might expect to be passed a <a href="Taxon.html"><code>Taxon</code></a> object, but will receive an <a href="Observation.html"><code>Observation</code></a> object.  This means that either the method will return false, the method should return nothing (nil) or the method should handle <a href="Observation.html"><code>Observation</code></a> objects as well as <a href="Taxon.html"><code>Taxon</code></a> objects.  For now I think we should let this play out and keep an eye on it.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-rules_validate_against-3F_source')" id="l_method-i-rules_validate_against-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-rules_validate_against-3F_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">92</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rules_validate_against?</span>(<span class="ruby-identifier">thing</span>)
<span class="line-num">93</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">goal_rules</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">94</span>   <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">goal_rules</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">rule</span><span class="ruby-operator">|</span> <span class="ruby-identifier">rule</span>.<span class="ruby-identifier">validates?</span>(<span class="ruby-identifier">thing</span>) }.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword">false</span>)
<span class="line-num">95</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-validate_and_add_contribution">
            
              <b>validate_and_add_contribution</b>(thing, goal_participant)
            
            <a href="../classes/Goal.html#method-i-validate_and_add_contribution" name="method-i-validate_and_add_contribution" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>This method is built up upon the rules_validate_against? method and records a <a href="GoalContribution.html"><code>GoalContribution</code></a> if it is valid. This assumes that &#39;thing&#39; has a polymorphic relationship to <a href="GoalContribution.html"><code>GoalContribution</code></a>..</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-validate_and_add_contribution_source')" id="l_method-i-validate_and_add_contribution_source">show</a>
                

                

                
              </p>
              <div id="method-i-validate_and_add_contribution_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/goal.rb</span>
<span class="line-num">100</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate_and_add_contribution</span>(<span class="ruby-identifier">thing</span>, <span class="ruby-identifier">goal_participant</span>)
<span class="line-num">101</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">rules_validate_against?</span>(<span class="ruby-identifier">thing</span>)
<span class="line-num">102</span>     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] #{self} rules validates against #{thing}&quot;</span>
<span class="line-num">103</span>     <span class="ruby-identifier">gc</span> = <span class="ruby-constant">GoalContribution</span>.<span class="ruby-identifier">new</span>({
<span class="line-num">104</span>       <span class="ruby-value">:goal_id</span>             <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">105</span>       <span class="ruby-value">:goal_participant_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">goal_participant</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">106</span>       <span class="ruby-value">:contribution</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">thing</span>
<span class="line-num">107</span>     })
<span class="line-num">108</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">gc</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">109</span>       <span class="ruby-identifier">thing</span>.<span class="ruby-identifier">goal_contributions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gc</span>
<span class="line-num">110</span>     <span class="ruby-keyword">else</span>
<span class="line-num">111</span>       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] Failed to save goal contribution #{gc}: #{gc.errors.full_messages}&quot;</span>
<span class="line-num">112</span>     <span class="ruby-keyword">end</span>
<span class="line-num">113</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">thing</span>
<span class="line-num">114</span>   <span class="ruby-keyword">end</span>
<span class="line-num">115</span>   <span class="ruby-keyword">false</span>
<span class="line-num">116</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
