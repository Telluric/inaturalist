<!DOCTYPE html>
<html lang="en">
<head>
    <title>Taxon</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Taxon"]'>


    <meta property="og:title" value="Taxon">

  

    <meta name="keywords" content="Taxon class, as_indexed_json, prepare_batch_for_index, set_uuid, reset_iconic_taxa_constants_for_tests, cannot_edit_parent_during_content_freeze, reindex_identifications_after_save, handle_after_move, handle_after_activate, get_internal_taxa_covered_by, reindex_taxa_covered_by, reindex_descendants_of, update_taxon_framework_relationship, complete_species_count, index_observations, normalize_rank, set_rank_level, remove_rank_from_name, set_iconic_taxon, set_wikipedia_summary_later, capitalize_name, capitalize_scientific_name, strip_name, create_matching_taxon_name, update_ancestor_photos, to_s, to_param, to_plain_s, to_styled_s, leading_name, observations_count_with_descendents, descendants_count, subtree_conditions, taxon_changes_count, taxon_schemes_count, in_taxon?, graft, graft_silently, grafted?, self_and_ancestors, self_and_ancestor_ids, root?, move_to_child_of, default_name, scientific_name, common_name, common_name_string, name_with_rank, set_scientific_taxon_name, set_photo_from_observations, set_photo_from_external, photos=, taxon_photos_with_backfill, photos_with_backfill, photos_cache_key, photos_with_external_cache_key, observation_photos, phylum, taxon_cant_be_its_own_ancestor, rank_level_for_taxon_and_parent_must_not_be_nil, rank_level_must_be_finer_than_parent, rank_level_must_be_coarser_than_children, only_inactive_children_if_inactive, active_parent_if_active, can_only_be_featured_if_photos, validate_locked, get_upstream_taxon_framework, ancestry_and_active_if_taxon_framework, graftable_destination_relative_to_taxon_framework_coverage, can_be_grafted_to, reasess_taxon_framework_relationship_after_move, upstream_taxon_framework, get_complete_taxon_framework_for_internode_or_root, graftable_relative_to_taxon_framework_coverage, user_can_edit_attributes, curated_taxon_framework?, current_user_curates_taxon?, observose_branch?, observose_warning_branch?, protected_attributes_editable_by?, activated_protected_attributes_editable_by?, species_or_lower?, infraspecies?, update_obs_iconic_taxa, wikipedia_summary, set_wikipedia_summary, remove_wikipedia_summary_unless_auto_description, wikipedia_attribution, ensure_parent_ancestry_in_ancestry, unfeature_inactive, auto_summary, merge, to_tags, parent_id=, ancestor_of?, descendant_of?, descendant_conditions, global_conservation_status, conservation_status_name, conservation_status_code, threatened?, establishment_means_in_place?, globally_threatened?, threatened_in_place?, threatened_status, threatened_in_lat_lon?, max_geoprivacy, geoprivacy, add_to_intersecting_places, iconic_taxon_name, update_descendants_with_new_ancestry, default_photo, update_descendants_with_new_ancestry, apply_orphan_strategy, apply_orphan_strategy, view_context, image_url, photo_url, taxon_range_kml_url, all_names, import, editable_by?, mergeable_by?, deleteable_by?, match_descendants, preferred_uninomial_ancestor, get_gbif_id, has_ancestor_taxon_id, atlased?, cached_atlas_presence_places, current_synonymous_taxon, current_synonymous_taxa_from_split, current_synonymous_taxa, flagged_with, clash_analysis, detect_clashes, match_descendants_of_id, import_or_create, count_taxa_in_rank, normalize_rank, remove_rank_from_name, normalize_name, tags_to_taxa, find_duplicates, rebuild_without_callbacks, without_callbacks, set_iconic_taxon_for_observations_of, occurs_in, search_query, single_taxon_for_name, default_json_options, update_observation_counts, index_taxa">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Taxon
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/es_indices/taxon_index_rb.html">app/es_indices/taxon_index.rb</a></li>
            
            <li><a href="../files/app/helpers/application_helper_rb.html">app/helpers/application_helper.rb</a></li>
            
            <li><a href="../files/app/helpers/conservation_statuses_helper_rb.html">app/helpers/conservation_statuses_helper.rb</a></li>
            
            <li><a href="../files/app/helpers/guides_helper_rb.html">app/helpers/guides_helper.rb</a></li>
            
            <li><a href="../files/app/helpers/taxa_helper_rb.html">app/helpers/taxa_helper.rb</a></li>
            
            <li><a href="../files/app/models/check_list_rb.html">app/models/check_list.rb</a></li>
            
            <li><a href="../files/app/models/complete_set_rb.html">app/models/complete_set.rb</a></li>
            
            <li><a href="../files/app/models/conservation_status_rb.html">app/models/conservation_status.rb</a></li>
            
            <li><a href="../files/app/models/guide_rb.html">app/models/guide.rb</a></li>
            
            <li><a href="../files/app/models/list_rb.html">app/models/list.rb</a></li>
            
            <li><a href="../files/app/models/mushroom_observer_import_flow_task_rb.html">app/models/mushroom_observer_import_flow_task.rb</a></li>
            
            <li><a href="../files/app/models/observation_rb.html">app/models/observation.rb</a></li>
            
            <li><a href="../files/app/models/photo_rb.html">app/models/photo.rb</a></li>
            
            <li><a href="../files/app/models/project_rb.html">app/models/project.rb</a></li>
            
            <li><a href="../files/app/models/sound_rb.html">app/models/sound.rb</a></li>
            
            <li><a href="../files/app/models/taxon_rb.html">app/models/taxon.rb</a></li>
            
            <li><a href="../files/app/models/taxon_change_rb.html">app/models/taxon_change.rb</a></li>
            
            <li><a href="../files/app/models/taxon_link_rb.html">app/models/taxon_link.rb</a></li>
            
            <li><a href="../files/app/models/taxon_name_rb.html">app/models/taxon_name.rb</a></li>
            
            <li><a href="../files/app/models/taxon_split_rb.html">app/models/taxon_split.rb</a></li>
            
            <li><a href="../files/app/models/year_statistic_rb.html">app/models/year_statistic.rb</a></li>
            
            <li><a href="../files/lib/darwin_core/archive_rb.html">lib/darwin_core/archive.rb</a></li>
            
            <li><a href="../files/lib/observation_search_rb.html">lib/observation_search.rb</a></li>
            
            <li><a href="../files/lib/ratatosk/lib/ratatosk_rb.html">lib/ratatosk/lib/ratatosk.rb</a></li>
            
            <li><a href="../files/lib/ratatosk/spec/bug_guide_name_provider_spec_rb.html">lib/ratatosk/spec/bug_guide_name_provider_spec.rb</a></li>
            
            <li><a href="../files/lib/ratatosk/spec/ratatosk_spec_rb.html">lib/ratatosk/spec/ratatosk_spec.rb</a></li>
            
            <li><a href="../files/lib/taxon_describers/spec/conabio_spec_rb.html">lib/taxon_describers/spec/conabio_spec.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-activated_protected_attributes_editable_by-3F">activated_protected_attributes_editable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-active_parent_if_active">active_parent_if_active</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_to_intersecting_places">add_to_intersecting_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-all_names">all_names</a>,
              </li>
            
              
              <li>
                <a href="#method-i-ancestor_of-3F">ancestor_of?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-ancestry_and_active_if_taxon_framework">ancestry_and_active_if_taxon_framework</a>,
              </li>
            
              
              <li>
                <a href="#method-i-apply_orphan_strategy">apply_orphan_strategy</a>,
              </li>
            
              
              <li>
                <a href="#method-c-apply_orphan_strategy">apply_orphan_strategy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-as_indexed_json">as_indexed_json</a>,
              </li>
            
              
              <li>
                <a href="#method-i-atlased-3F">atlased?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-auto_summary">auto_summary</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-cached_atlas_presence_places">cached_atlas_presence_places</a>,
              </li>
            
              
              <li>
                <a href="#method-i-can_be_grafted_to">can_be_grafted_to</a>,
              </li>
            
              
              <li>
                <a href="#method-i-can_only_be_featured_if_photos">can_only_be_featured_if_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-cannot_edit_parent_during_content_freeze">cannot_edit_parent_during_content_freeze</a>,
              </li>
            
              
              <li>
                <a href="#method-i-capitalize_name">capitalize_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-capitalize_scientific_name">capitalize_scientific_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-clash_analysis">clash_analysis</a>,
              </li>
            
              
              <li>
                <a href="#method-i-common_name">common_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-common_name_string">common_name_string</a>,
              </li>
            
              
              <li>
                <a href="#method-i-complete_species_count">complete_species_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-conservation_status_code">conservation_status_code</a>,
              </li>
            
              
              <li>
                <a href="#method-i-conservation_status_name">conservation_status_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-count_taxa_in_rank">count_taxa_in_rank</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_matching_taxon_name">create_matching_taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-curated_taxon_framework-3F">curated_taxon_framework?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-current_synonymous_taxa">current_synonymous_taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-i-current_synonymous_taxa_from_split">current_synonymous_taxa_from_split</a>,
              </li>
            
              
              <li>
                <a href="#method-i-current_synonymous_taxon">current_synonymous_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-current_user_curates_taxon-3F">current_user_curates_taxon?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-default_json_options">default_json_options</a>,
              </li>
            
              
              <li>
                <a href="#method-i-default_name">default_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-default_photo">default_photo</a>,
              </li>
            
              
              <li>
                <a href="#method-i-deleteable_by-3F">deleteable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-descendant_conditions">descendant_conditions</a>,
              </li>
            
              
              <li>
                <a href="#method-i-descendant_of-3F">descendant_of?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-descendants_count">descendants_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-detect_clashes">detect_clashes</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-editable_by-3F">editable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-ensure_parent_ancestry_in_ancestry">ensure_parent_ancestry_in_ancestry</a>,
              </li>
            
              
              <li>
                <a href="#method-i-establishment_means_in_place-3F">establishment_means_in_place?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-find_duplicates">find_duplicates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-flagged_with">flagged_with</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-geoprivacy">geoprivacy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_complete_taxon_framework_for_internode_or_root">get_complete_taxon_framework_for_internode_or_root</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_gbif_id">get_gbif_id</a>,
              </li>
            
              
              <li>
                <a href="#method-c-get_internal_taxa_covered_by">get_internal_taxa_covered_by</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_upstream_taxon_framework">get_upstream_taxon_framework</a>,
              </li>
            
              
              <li>
                <a href="#method-i-global_conservation_status">global_conservation_status</a>,
              </li>
            
              
              <li>
                <a href="#method-i-globally_threatened-3F">globally_threatened?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graft">graft</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graft_silently">graft_silently</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graftable_destination_relative_to_taxon_framework_coverage">graftable_destination_relative_to_taxon_framework_coverage</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graftable_relative_to_taxon_framework_coverage">graftable_relative_to_taxon_framework_coverage</a>,
              </li>
            
              
              <li>
                <a href="#method-i-grafted-3F">grafted?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-handle_after_activate">handle_after_activate</a>,
              </li>
            
              
              <li>
                <a href="#method-i-handle_after_move">handle_after_move</a>,
              </li>
            
              
              <li>
                <a href="#method-i-has_ancestor_taxon_id">has_ancestor_taxon_id</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-iconic_taxon_name">iconic_taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-image_url">image_url</a>,
              </li>
            
              
              <li>
                <a href="#method-c-import">import</a>,
              </li>
            
              
              <li>
                <a href="#method-c-import_or_create">import_or_create</a>,
              </li>
            
              
              <li>
                <a href="#method-i-in_taxon-3F">in_taxon?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index_observations">index_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-c-index_taxa">index_taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-i-infraspecies-3F">infraspecies?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-leading_name">leading_name</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-match_descendants">match_descendants</a>,
              </li>
            
              
              <li>
                <a href="#method-c-match_descendants_of_id">match_descendants_of_id</a>,
              </li>
            
              
              <li>
                <a href="#method-c-max_geoprivacy">max_geoprivacy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-merge">merge</a>,
              </li>
            
              
              <li>
                <a href="#method-i-mergeable_by-3F">mergeable_by?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-move_to_child_of">move_to_child_of</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-name_with_rank">name_with_rank</a>,
              </li>
            
              
              <li>
                <a href="#method-c-normalize_name">normalize_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-normalize_rank">normalize_rank</a>,
              </li>
            
              
              <li>
                <a href="#method-c-normalize_rank">normalize_rank</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-observation_photos">observation_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observations_count_with_descendents">observations_count_with_descendents</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observose_branch-3F">observose_branch?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observose_warning_branch-3F">observose_warning_branch?</a>,
              </li>
            
              
              <li>
                <a href="#method-c-occurs_in">occurs_in</a>,
              </li>
            
              
              <li>
                <a href="#method-i-only_inactive_children_if_inactive">only_inactive_children_if_inactive</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-parent_id-3D">parent_id=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photo_url">photo_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photos-3D">photos=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photos_cache_key">photos_cache_key</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photos_with_backfill">photos_with_backfill</a>,
              </li>
            
              
              <li>
                <a href="#method-i-photos_with_external_cache_key">photos_with_external_cache_key</a>,
              </li>
            
              
              <li>
                <a href="#method-i-phylum">phylum</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preferred_uninomial_ancestor">preferred_uninomial_ancestor</a>,
              </li>
            
              
              <li>
                <a href="#method-c-prepare_batch_for_index">prepare_batch_for_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-protected_attributes_editable_by-3F">protected_attributes_editable_by?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-rank_level_for_taxon_and_parent_must_not_be_nil">rank_level_for_taxon_and_parent_must_not_be_nil</a>,
              </li>
            
              
              <li>
                <a href="#method-i-rank_level_must_be_coarser_than_children">rank_level_must_be_coarser_than_children</a>,
              </li>
            
              
              <li>
                <a href="#method-i-rank_level_must_be_finer_than_parent">rank_level_must_be_finer_than_parent</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reasess_taxon_framework_relationship_after_move">reasess_taxon_framework_relationship_after_move</a>,
              </li>
            
              
              <li>
                <a href="#method-c-rebuild_without_callbacks">rebuild_without_callbacks</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reindex_descendants_of">reindex_descendants_of</a>,
              </li>
            
              
              <li>
                <a href="#method-i-reindex_identifications_after_save">reindex_identifications_after_save</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reindex_taxa_covered_by">reindex_taxa_covered_by</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_rank_from_name">remove_rank_from_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-remove_rank_from_name">remove_rank_from_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_wikipedia_summary_unless_auto_description">remove_wikipedia_summary_unless_auto_description</a>,
              </li>
            
              
              <li>
                <a href="#method-c-reset_iconic_taxa_constants_for_tests">reset_iconic_taxa_constants_for_tests</a>,
              </li>
            
              
              <li>
                <a href="#method-i-root-3F">root?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-scientific_name">scientific_name</a>,
              </li>
            
              
              <li>
                <a href="#method-c-search_query">search_query</a>,
              </li>
            
              
              <li>
                <a href="#method-i-self_and_ancestor_ids">self_and_ancestor_ids</a>,
              </li>
            
              
              <li>
                <a href="#method-i-self_and_ancestors">self_and_ancestors</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_iconic_taxon">set_iconic_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-set_iconic_taxon_for_observations_of">set_iconic_taxon_for_observations_of</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_photo_from_external">set_photo_from_external</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_photo_from_observations">set_photo_from_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_rank_level">set_rank_level</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_scientific_taxon_name">set_scientific_taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_uuid">set_uuid</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_wikipedia_summary">set_wikipedia_summary</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_wikipedia_summary_later">set_wikipedia_summary_later</a>,
              </li>
            
              
              <li>
                <a href="#method-c-single_taxon_for_name">single_taxon_for_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-species_or_lower-3F">species_or_lower?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-strip_name">strip_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-subtree_conditions">subtree_conditions</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-tags_to_taxa">tags_to_taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_cant_be_its_own_ancestor">taxon_cant_be_its_own_ancestor</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_changes_count">taxon_changes_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_photos_with_backfill">taxon_photos_with_backfill</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_range_kml_url">taxon_range_kml_url</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_schemes_count">taxon_schemes_count</a>,
              </li>
            
              
              <li>
                <a href="#method-i-threatened-3F">threatened?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-threatened_in_lat_lon-3F">threatened_in_lat_lon?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-threatened_in_place-3F">threatened_in_place?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-threatened_status">threatened_status</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_param">to_param</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_plain_s">to_plain_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_styled_s">to_styled_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_tags">to_tags</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-unfeature_inactive">unfeature_inactive</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_ancestor_photos">update_ancestor_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_descendants_with_new_ancestry">update_descendants_with_new_ancestry</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_descendants_with_new_ancestry">update_descendants_with_new_ancestry</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_obs_iconic_taxa">update_obs_iconic_taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_observation_counts">update_observation_counts</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_taxon_framework_relationship">update_taxon_framework_relationship</a>,
              </li>
            
              
              <li>
                <a href="#method-i-upstream_taxon_framework">upstream_taxon_framework</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user_can_edit_attributes">user_can_edit_attributes</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-validate_locked">validate_locked</a>,
              </li>
            
              
              <li>
                <a href="#method-i-view_context">view_context</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-wikipedia_attribution">wikipedia_attribution</a>,
              </li>
            
              
              <li>
                <a href="#method-i-wikipedia_summary">wikipedia_summary</a>,
              </li>
            
              
              <li>
                <a href="#method-c-without_callbacks">without_callbacks</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="ActsAsElasticModel.html">
              ActsAsElasticModel
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_ES_BATCH_SIZE</td>
            <td>=</td>
            <td class="attr-value">500</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ICONIC_TAXA</td>
            <td>=</td>
            <td class="attr-value">Taxon.sort_by_ancestry( iconic_taxa.arrange )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ICONIC_TAXA_BY_ID</td>
            <td>=</td>
            <td class="attr-value">ICONIC_TAXA.index_by( &amp;:id )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ICONIC_TAXA_BY_NAME</td>
            <td>=</td>
            <td class="attr-value">ICONIC_TAXA.index_by( &amp;:name )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ICONIC_TAXON_DISPLAY_NAMES</td>
            <td>=</td>
            <td class="attr-value">ICONIC_TAXON_NAMES.merge(
&quot;Animalia&quot; =&gt; &quot;Other Animals&quot;
)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ICONIC_TAXON_NAMES</td>
            <td>=</td>
            <td class="attr-value">{
&quot;Animalia&quot; =&gt; &quot;Animals&quot;,
&quot;Actinopterygii&quot; =&gt; &quot;Ray-finned Fishes&quot;,
&quot;Aves&quot; =&gt; &quot;Birds&quot;,
&quot;Reptilia&quot; =&gt; &quot;Reptiles&quot;,
&quot;Amphibia&quot; =&gt; &quot;Amphibians&quot;,
&quot;Mammalia&quot; =&gt; &quot;Mammals&quot;,
&quot;Arachnida&quot; =&gt; &quot;Arachnids&quot;,
&quot;Insecta&quot; =&gt; &quot;Insects&quot;,
&quot;Plantae&quot; =&gt; &quot;Plants&quot;,
&quot;Fungi&quot; =&gt; &quot;Fungi&quot;,
&quot;Protozoa&quot; =&gt; &quot;Protozoans&quot;,
&quot;Mollusca&quot; =&gt; &quot;Mollusks&quot;,
&quot;Chromista&quot; =&gt; &quot;Chromista&quot;
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>In case you don&#39;t feel like looking up TaxonNames</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_CODE_VALUES</td>
            <td>=</td>
            <td class="attr-value">IUCN_STATUS_VALUES.transform_keys do | name |
IUCN_STATUS_CODES[name]
end</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_CRITICALLY_ENDANGERED</td>
            <td>=</td>
            <td class="attr-value">50</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_DATA_DEFICIENT</td>
            <td>=</td>
            <td class="attr-value">5</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_ENDANGERED</td>
            <td>=</td>
            <td class="attr-value">40</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_EXTINCT</td>
            <td>=</td>
            <td class="attr-value">70</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_EXTINCT_IN_THE_WILD</td>
            <td>=</td>
            <td class="attr-value">60</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_LEAST_CONCERN</td>
            <td>=</td>
            <td class="attr-value">10</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_NEAR_THREATENED</td>
            <td>=</td>
            <td class="attr-value">20</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_NOT_EVALUATED</td>
            <td>=</td>
            <td class="attr-value">0</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_STATUSES</td>
            <td>=</td>
            <td class="attr-value">IUCN_STATUS_NAMES.map do | status_name |
[const_get( &quot;IUCN_#{status_name.upcase}&quot; ), status_name]
end.to_h</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_STATUSES_SELECT</td>
            <td>=</td>
            <td class="attr-value">IUCN_STATUS_NAMES.map do | status_name |
[&quot;#{I18n.t( status_name, default: status_name ).humanize} (#{IUCN_STATUS_CODES[status_name]})&quot;,
const_get( &quot;IUCN_#{status_name.upcase}&quot; )]
end</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_STATUS_CODES</td>
            <td>=</td>
            <td class="attr-value">{
&quot;not_evaluated&quot; =&gt; &quot;NE&quot;,
&quot;data_deficient&quot; =&gt; &quot;DD&quot;,
&quot;least_concern&quot; =&gt; &quot;LC&quot;,
&quot;near_threatened&quot; =&gt; &quot;NT&quot;,
&quot;vulnerable&quot; =&gt; &quot;VU&quot;,
&quot;endangered&quot; =&gt; &quot;EN&quot;,
&quot;critically_endangered&quot; =&gt; &quot;CR&quot;,
&quot;extinct_in_the_wild&quot; =&gt; &quot;EW&quot;,
&quot;extinct&quot; =&gt; &quot;EX&quot;
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_STATUS_NAMES</td>
            <td>=</td>
            <td class="attr-value">%w(not_evaluated data_deficient least_concern
near_threatened vulnerable endangered critically_endangered
extinct_in_the_wild extinct).freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_STATUS_VALUES</td>
            <td>=</td>
            <td class="attr-value">IUCN_STATUS_NAMES.map do | status_name |
[status_name, const_get( &quot;IUCN_#{status_name.upcase}&quot; )]
end.to_h</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">IUCN_VULNERABLE</td>
            <td>=</td>
            <td class="attr-value">30</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LIFE</td>
            <td>=</td>
            <td class="attr-value">Taxon.roots.find_by_name( &quot;Life&quot; )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NAME_PROVIDER_TITLES</td>
            <td>=</td>
            <td class="attr-value">{
&quot;ColNameProvider&quot; =&gt; &quot;Catalogue of Life&quot;,
&quot;NZORNameProvider&quot; =&gt; &quot;New Zealand Organisms Register&quot;,
&quot;UBioNameProvider&quot; =&gt; &quot;uBio&quot;
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NUM_OBSERVATIONS_REQUIRING_CURATOR_TO_EDIT</td>
            <td>=</td>
            <td class="attr-value">200_000</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NUM_OBSERVATIONS_TRIGGERING_WARNING</td>
            <td>=</td>
            <td class="attr-value">1000</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PREFERRED_RANKS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;kingdom&quot;,
&quot;phylum&quot;,
&quot;class&quot;,
&quot;order&quot;,
&quot;superfamily&quot;,
&quot;family&quot;,
&quot;genus&quot;,
&quot;species&quot;,
&quot;subspecies&quot;,
&quot;variety&quot;
].freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PROBLEM_NAMES</td>
            <td>=</td>
            <td class="attr-value">[
&quot;aba&quot;,
&quot;america&quot;,
&quot;asa&quot;,
&quot;bee hive&quot;,
&quot;canon&quot;,
&quot;caterpillar&quot;,
&quot;caterpillars&quot;,
&quot;chiton&quot;,
&quot;cicada&quot;,
&quot;creeper&quot;,
&quot;eos&quot;,
&quot;gall&quot;,
&quot;hong kong&quot;,
&quot;larva&quot;,
&quot;lichen&quot;,
&quot;lizard&quot;,
&quot;pinecone&quot;,
&quot;pupa&quot;,
&quot;pupae&quot;,
&quot;sea&quot;,
&quot;winged insect&quot;
] + place_names_that_are_taxon_names + abbr_date_names</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PROTECTED_ATTRIBUTES_FOR_CURATED_TAXA</td>
            <td>=</td>
            <td class="attr-value">%w(
ancestry
is_active
rank
rank_level
).freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">RANKS</td>
            <td>=</td>
            <td class="attr-value">RANK_LEVELS.keys</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">RANK_EQUIVALENTS</td>
            <td>=</td>
            <td class="attr-value">{
&quot;division&quot; =&gt; &quot;phylum&quot;,
&quot;sub-class&quot; =&gt; &quot;subclass&quot;,
&quot;super-order&quot; =&gt; &quot;superorder&quot;,
&quot;sub-order&quot; =&gt; &quot;suborder&quot;,
&quot;super-family&quot; =&gt; &quot;superfamily&quot;,
&quot;sub-family&quot; =&gt; &quot;subfamily&quot;,
&quot;gen&quot; =&gt; &quot;genus&quot;,
&quot;sp&quot; =&gt; &quot;species&quot;,
&quot;spp&quot; =&gt; &quot;species&quot;,
&quot;infraspecies&quot; =&gt; &quot;subspecies&quot;,
&quot;ssp&quot; =&gt; &quot;subspecies&quot;,
&quot;sub-species&quot; =&gt; &quot;subspecies&quot;,
&quot;subsp&quot; =&gt; &quot;subspecies&quot;,
&quot;trinomial&quot; =&gt; &quot;subspecies&quot;,
&quot;var&quot; =&gt; &quot;variety&quot;,
&quot;unranked&quot; =&gt; nil
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">RANK_FOR_RANK_LEVEL</td>
            <td>=</td>
            <td class="attr-value">RANK_LEVELS.reject do | k, _v |
[&quot;variety&quot;, &quot;form&quot;, &quot;infrahybrid&quot;, &quot;hybrid&quot;, &quot;genushybrid&quot;].include? k
end.invert</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">RANK_LEVELS</td>
            <td>=</td>
            <td class="attr-value">{
&quot;stateofmatter&quot; =&gt; 100,
&quot;kingdom&quot; =&gt; 70,
&quot;phylum&quot; =&gt; 60,
&quot;subphylum&quot; =&gt; 57,
&quot;superclass&quot; =&gt; 53,
&quot;class&quot; =&gt; 50,
&quot;subclass&quot; =&gt; 47,
&quot;infraclass&quot; =&gt; 45,
&quot;subterclass&quot; =&gt; 44,
&quot;superorder&quot; =&gt; 43,
&quot;order&quot; =&gt; 40,
&quot;suborder&quot; =&gt; 37,
&quot;infraorder&quot; =&gt; 35,
&quot;parvorder&quot; =&gt; 34.5,
&quot;zoosection&quot; =&gt; 34,
&quot;zoosubsection&quot; =&gt; 33.5,
&quot;superfamily&quot; =&gt; 33,
&quot;epifamily&quot; =&gt; 32,
&quot;family&quot; =&gt; 30,
&quot;subfamily&quot; =&gt; 27,
&quot;supertribe&quot; =&gt; 26,
&quot;tribe&quot; =&gt; 25,
&quot;subtribe&quot; =&gt; 24,
&quot;genus&quot; =&gt; 20,
&quot;genushybrid&quot; =&gt; 20,
&quot;subgenus&quot; =&gt; 15,
&quot;section&quot; =&gt; 13,
&quot;subsection&quot; =&gt; 12,
&quot;complex&quot; =&gt; 11,
&quot;species&quot; =&gt; 10,
&quot;hybrid&quot; =&gt; 10,
&quot;subspecies&quot; =&gt; 5,
&quot;variety&quot; =&gt; 5,
&quot;form&quot; =&gt; 5,
&quot;infrahybrid&quot; =&gt; 5
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ROOT_LEVEL</td>
            <td>=</td>
            <td class="attr-value">STATEOFMATTER_LEVEL</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">VISIBLE_RANKS</td>
            <td>=</td>
            <td class="attr-value">RANKS - [&quot;stateofmatter&quot;]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">WIKIPEDIA_RANKS</td>
            <td>=</td>
            <td class="attr-value">{
&quot;infratribe&quot; =&gt; &quot;infratribus&quot;,
&quot;infraphylum&quot; =&gt; &quot;infraphylum&quot;,
&quot;infraorder&quot; =&gt; &quot;infraordo&quot;,
&quot;cohort&quot; =&gt; &quot;cohort&quot;,
&quot;microrder&quot; =&gt; &quot;micrordo&quot;,
&quot;genus&quot; =&gt; &quot;genus&quot;,
&quot;grandorder&quot; =&gt; &quot;grandordo&quot;,
&quot;microphylum&quot; =&gt; &quot;microphylum&quot;,
&quot;sublegion&quot; =&gt; &quot;sublegio&quot;,
&quot;parvclass&quot; =&gt; &quot;parvclassis&quot;,
&quot;supercohort&quot; =&gt; &quot;supercohort&quot;,
&quot;nanorder&quot; =&gt; &quot;nanordo&quot;,
&quot;parafamily&quot; =&gt; &quot;parafamilia&quot;,
&quot;superdivision&quot; =&gt; &quot;superdivisio&quot;,
&quot;superlegion&quot; =&gt; &quot;superlegio&quot;,
&quot;magnorder&quot; =&gt; &quot;magnordo&quot;,
&quot;variety&quot; =&gt; &quot;varietas&quot;,
&quot;tribe&quot; =&gt; &quot;tribus&quot;,
&quot;parvorder&quot; =&gt; &quot;parvordo&quot;,
&quot;superfamily&quot; =&gt; &quot;superfamilia&quot;,
&quot;subphylum&quot; =&gt; &quot;subphylum&quot;,
&quot;superphylum&quot; =&gt; &quot;superphylum&quot;,
&quot;infrakingdom&quot; =&gt; &quot;infraregnum&quot;,
&quot;mb&quot; =&gt; &quot;grandordo&quot;,
&quot;supertribe&quot; =&gt; &quot;supertribus&quot;,
&quot;hyperfamily&quot; =&gt; &quot;hyperfamilia&quot;,
&quot;superclass&quot; =&gt; &quot;superclassis&quot;,
&quot;subtribe&quot; =&gt; &quot;subtribus&quot;,
&quot;subterclass&quot; =&gt; &quot;subterclassis&quot;,
&quot;division&quot; =&gt; &quot;divisio&quot;,
&quot;subspecies&quot; =&gt; &quot;subspecies&quot;,
&quot;class&quot; =&gt; &quot;classis&quot;,
&quot;subsection&quot; =&gt; &quot;subsectio&quot;,
&quot;infraclass&quot; =&gt; &quot;infraclassis&quot;,
&quot;subcohort&quot; =&gt; &quot;subcohort&quot;,
&quot;subfamily&quot; =&gt; &quot;subfamilia&quot;,
&quot;subkingdom&quot; =&gt; &quot;subregnum&quot;,
&quot;superkingdom&quot; =&gt; &quot;superregnum&quot;,
&quot;species&quot; =&gt; &quot;species&quot;,
&quot;suborder&quot; =&gt; &quot;subordo&quot;,
&quot;subgenus&quot; =&gt; &quot;subgenus&quot;,
&quot;subdivision&quot; =&gt; &quot;subdivisio&quot;,
&quot;order&quot; =&gt; &quot;ordo&quot;,
&quot;subclass&quot; =&gt; &quot;subclassis&quot;,
&quot;section&quot; =&gt; &quot;sectio&quot;,
&quot;legion&quot; =&gt; &quot;legio&quot;,
&quot;kingdom&quot; =&gt; &quot;regnum&quot;,
&quot;domain&quot; =&gt; &quot;domain&quot;,
&quot;superdomain&quot; =&gt; &quot;superdomain&quot;,
&quot;superorder&quot; =&gt; &quot;superordo&quot;,
&quot;nanophylum&quot; =&gt; &quot;nanophylum&quot;,
&quot;family&quot; =&gt; &quot;familia&quot;,
&quot;mirordo&quot; =&gt; &quot;mirordo-mb&quot;,
&quot;infralegion&quot; =&gt; &quot;infralegio&quot;,
&quot;form&quot; =&gt; &quot;forma&quot;,
&quot;mirorder&quot; =&gt; &quot;mirordo&quot;,
&quot;phylum&quot; =&gt; &quot;phylum&quot;
}.freeze</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>current_user</td>
            <td class='attr-desc'><p>set this when you want methods to respond with user-specific content</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>html</td>
            <td class='attr-desc'><p>If you want to shove some HTML in there before creating some JSON</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>indexed_place_ids</td>
            <td class='attr-desc'><p>used to cache place_ids when bulk indexing</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>locale</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_after_move</td>
            <td class='attr-desc'><p>Skip the more onerous callbacks that happen after grafting a taxon somewhere else</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_locks</td>
            <td class='attr-desc'><p>Allow this taxon to be grafted to locked subtrees</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_new_taxon_name</td>
            <td class='attr-desc'><p>Sometimes you don&#39;t want to make a new taxon name with a taxon, like when you&#39;re saving a new taxon name with a new associated taxon. Hence, this.</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_observation_indexing</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_only_inactive_children_if_inactive</td>
            <td class='attr-desc'><p>Allow this taxon to be inactivated despite having active children</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_taxon_framework_checks</td>
            <td class='attr-desc'><p>Allow this taxon to be grafted to curated subtrees</p></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-apply_orphan_strategy">
            
              <b>apply_orphan_strategy</b>( child_ancestry_was )
            
            <a href="../classes/Taxon.html#method-c-apply_orphan_strategy" name="method-c-apply_orphan_strategy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-apply_orphan_strategy_source')" id="l_method-c-apply_orphan_strategy_source">show</a>
                

                

                
              </p>
              <div id="method-c-apply_orphan_strategy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1904</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">apply_orphan_strategy</span>( <span class="ruby-identifier">child_ancestry_was</span> )
<span class="line-num">1905</span>   <span class="ruby-comment"># return unless taxon</span>
<span class="line-num">1906</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO #{Time.now}] applying orphan strategy to #{child_ancestry_was}&quot;</span>
<span class="line-num">1907</span>   <span class="ruby-identifier">descendant_conditions</span> = [
<span class="line-num">1908</span>     <span class="ruby-string">&quot;ancestry = ? OR ancestry LIKE ?&quot;</span>,
<span class="line-num">1909</span>     <span class="ruby-identifier">child_ancestry_was</span>, <span class="ruby-node">&quot;#{child_ancestry_was}/%&quot;</span>
<span class="line-num">1910</span>   ]
<span class="line-num">1911</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">descendant_conditions</span> ).<span class="ruby-identifier">find_in_batches</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">batch</span> <span class="ruby-operator">|</span>
<span class="line-num">1912</span>     <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">1913</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">without_ancestry_callbacks</span> <span class="ruby-keyword">do</span>
<span class="line-num">1914</span>         <span class="ruby-identifier">t</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1915</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1916</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1917</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1918</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-capitalize_scientific_name">
            
              <b>capitalize_scientific_name</b>( name, rank )
            
            <a href="../classes/Taxon.html#method-c-capitalize_scientific_name" name="method-c-capitalize_scientific_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-capitalize_scientific_name_source')" id="l_method-c-capitalize_scientific_name_source">show</a>
                

                

                
              </p>
              <div id="method-c-capitalize_scientific_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">758</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">capitalize_scientific_name</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">rank</span> )
<span class="line-num">759</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">capitalize</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">760</span> 
<span class="line-num">761</span>   <span class="ruby-keyword">if</span> [<span class="ruby-constant">GENUS</span>, <span class="ruby-constant">GENUSHYBRID</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(x|)\s+?(.+)/</span>
<span class="line-num">762</span>     <span class="ruby-identifier">_full_name</span>, <span class="ruby-identifier">x</span>, <span class="ruby-identifier">genus_name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^(x|)\s+?(.+)/</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">763</span>     <span class="ruby-node">&quot;#{x} #{genus_name.capitalize}&quot;</span>
<span class="line-num">764</span>   <span class="ruby-keyword">elsif</span> [<span class="ruby-constant">GENUS</span>, <span class="ruby-constant">GENUSHYBRID</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^\w+\s+(x|)\s+\w+$/</span>
<span class="line-num">765</span>     <span class="ruby-identifier">_full_name</span>, <span class="ruby-identifier">name1</span>, <span class="ruby-identifier">x</span>, <span class="ruby-identifier">name2</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^(\w+)\s+(x|)\s+(\w+)/</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">766</span>     <span class="ruby-node">&quot;#{name1.capitalize} #{x} #{name2.capitalize}&quot;</span>
<span class="line-num">767</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-constant">HYBRID</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/(x|)\s+\w+\s+\w+/</span>
<span class="line-num">768</span>     <span class="ruby-identifier">_full_name</span>, <span class="ruby-identifier">name1</span>, <span class="ruby-identifier">x</span>, <span class="ruby-identifier">name2</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^(.+)\s+(x|)\s+(.+)/</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">769</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">name1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">name2</span>
<span class="line-num">770</span>       <span class="ruby-node">&quot;#{name1.capitalize} #{x} #{name2.capitalize}&quot;</span>
<span class="line-num">771</span>     <span class="ruby-keyword">else</span>
<span class="line-num">772</span>       <span class="ruby-identifier">name</span>.<span class="ruby-identifier">capitalize</span>
<span class="line-num">773</span>     <span class="ruby-keyword">end</span>
<span class="line-num">774</span>   <span class="ruby-keyword">else</span>
<span class="line-num">775</span>     <span class="ruby-identifier">name</span>.<span class="ruby-identifier">capitalize</span>
<span class="line-num">776</span>   <span class="ruby-keyword">end</span>
<span class="line-num">777</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-count_taxa_in_rank">
            
              <b>count_taxa_in_rank</b>( rank )
            
            <a href="../classes/Taxon.html#method-c-count_taxa_in_rank" name="method-c-count_taxa_in_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Count the number of taxa in the given rank.</p>

<p>I don&#39;t like hard-coding it like this, so if you know an abstract way of getting at the column name associated with an attribute, or an aliased attribute like &#39;rank&#39;, please tell me.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-count_taxa_in_rank_source')" id="l_method-c-count_taxa_in_rank_source">show</a>
                

                

                
              </p>
              <div id="method-c-count_taxa_in_rank_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2272</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">count_taxa_in_rank</span>( <span class="ruby-identifier">rank</span> )
<span class="line-num">2273</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">count_by_sql</span>(
<span class="line-num">2274</span>     <span class="ruby-node">&quot;SELECT COUNT(*) from #{Taxon.table_name} WHERE (rank = &#39;#{rank.downcase}&#39;)&quot;</span>
<span class="line-num">2275</span>   )
<span class="line-num">2276</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-default_json_options">
            
              <b>default_json_options</b>()
            
            <a href="../classes/Taxon.html#method-c-default_json_options" name="method-c-default_json_options" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-default_json_options_source')" id="l_method-c-default_json_options_source">show</a>
                

                

                
              </p>
              <div id="method-c-default_json_options_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2520</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">default_json_options</span>
<span class="line-num">2521</span>   {
<span class="line-num">2522</span>     <span class="ruby-value">methods:</span> [<span class="ruby-value">:default_name</span>, <span class="ruby-value">:photo_url</span>, <span class="ruby-value">:iconic_taxon_name</span>, <span class="ruby-value">:conservation_status_name</span>],
<span class="line-num">2523</span>     <span class="ruby-value">except:</span> [<span class="ruby-value">:delta</span>, <span class="ruby-value">:auto_description</span>, <span class="ruby-value">:source_url</span>,
<span class="line-num">2524</span>              <span class="ruby-value">:source_identifier</span>, <span class="ruby-value">:creator_id</span>, <span class="ruby-value">:updater_id</span>, <span class="ruby-value">:version</span>,
<span class="line-num">2525</span>              <span class="ruby-value">:featured_at</span>, <span class="ruby-value">:auto_photos</span>, <span class="ruby-value">:locked</span>],
<span class="line-num">2526</span>     <span class="ruby-value">include:</span> {
<span class="line-num">2527</span>       <span class="ruby-value">taxon_photos:</span> {
<span class="line-num">2528</span>         <span class="ruby-value">include:</span> {
<span class="line-num">2529</span>           <span class="ruby-value">photo:</span> {
<span class="line-num">2530</span>             <span class="ruby-value">methods:</span> [<span class="ruby-value">:license_code</span>, <span class="ruby-value">:attribution</span>, <span class="ruby-value">:square_url</span>,
<span class="line-num">2531</span>                       <span class="ruby-value">:thumb_url</span>, <span class="ruby-value">:small_url</span>, <span class="ruby-value">:medium_url</span>, <span class="ruby-value">:large_url</span>],
<span class="line-num">2532</span>             <span class="ruby-value">except:</span> [<span class="ruby-value">:file_processing</span>, <span class="ruby-value">:file_file_size</span>,
<span class="line-num">2533</span>                      <span class="ruby-value">:file_content_type</span>, <span class="ruby-value">:file_file_name</span>, <span class="ruby-value">:mobile</span>, <span class="ruby-value">:metadata</span>]
<span class="line-num">2534</span>           }
<span class="line-num">2535</span>         }
<span class="line-num">2536</span>       }
<span class="line-num">2537</span>     }
<span class="line-num">2538</span>   }
<span class="line-num">2539</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-find_duplicates">
            
              <b>find_duplicates</b>()
            
            <a href="../classes/Taxon.html#method-c-find_duplicates" name="method-c-find_duplicates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-find_duplicates_source')" id="l_method-c-find_duplicates_source">show</a>
                

                

                
              </p>
              <div id="method-c-find_duplicates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2345</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">find_duplicates</span>
<span class="line-num">2346</span>   <span class="ruby-identifier">duplicate_counts</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">group</span>( <span class="ruby-value">:name</span> ).<span class="ruby-identifier">having</span>( <span class="ruby-string">&quot;count(*) &gt; 1&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">2347</span>   <span class="ruby-identifier">num_keepers</span> = <span class="ruby-value">0</span>
<span class="line-num">2348</span>   <span class="ruby-identifier">num_rejects</span> = <span class="ruby-value">0</span>
<span class="line-num">2349</span>   <span class="ruby-identifier">duplicate_counts</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">|</span>
<span class="line-num">2350</span>     <span class="ruby-identifier">taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span> )
<span class="line-num">2351</span>     <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">group_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:parent_id</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">_parent_id</span>, <span class="ruby-identifier">child_taxa</span> <span class="ruby-operator">|</span>
<span class="line-num">2352</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">child_taxa</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">2353</span> 
<span class="line-num">2354</span>       <span class="ruby-identifier">child_taxa</span> = <span class="ruby-identifier">child_taxa</span>.<span class="ruby-identifier">sort_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> )
<span class="line-num">2355</span>       <span class="ruby-identifier">keeper</span> = <span class="ruby-identifier">child_taxa</span>.<span class="ruby-identifier">shift</span>
<span class="line-num">2356</span>       <span class="ruby-identifier">child_taxa</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">keeper</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">t</span> ) }
<span class="line-num">2357</span>       <span class="ruby-identifier">num_keepers</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">2358</span>       <span class="ruby-identifier">num_rejects</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">child_taxa</span>.<span class="ruby-identifier">size</span>
<span class="line-num">2359</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2360</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2361</span> 
<span class="line-num">2362</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO] Finished Taxon.find_duplicates.  Kept #{num_keepers}, removed #{num_rejects}.&quot;</span>
<span class="line-num">2363</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-get_internal_taxa_covered_by">
            
              <b>get_internal_taxa_covered_by</b>( taxon_framework )
            
            <a href="../classes/Taxon.html#method-c-get_internal_taxa_covered_by" name="method-c-get_internal_taxa_covered_by" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-get_internal_taxa_covered_by_source')" id="l_method-c-get_internal_taxa_covered_by_source">show</a>
                

                

                
              </p>
              <div id="method-c-get_internal_taxa_covered_by_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">622</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">get_internal_taxa_covered_by</span>( <span class="ruby-identifier">taxon_framework</span> )
<span class="line-num">623</span>   <span class="ruby-identifier">ancestry_string</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-constant">STATEOFMATTER</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">624</span>     <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">625</span>   <span class="ruby-keyword">else</span>
<span class="line-num">626</span>     <span class="ruby-node">&quot;#{taxon_framework.taxon.ancestry}/#{taxon_framework.taxon.id}&quot;</span>
<span class="line-num">627</span>   <span class="ruby-keyword">end</span>
<span class="line-num">628</span>   <span class="ruby-identifier">other_taxon_frameworks</span> = <span class="ruby-constant">TaxonFramework</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> ).
<span class="line-num">629</span>     <span class="ruby-identifier">where</span>( <span class="ruby-node">&quot;( taxa.ancestry LIKE ( &#39;#{ancestry_string}/%&#39; ) OR taxa.ancestry LIKE ( &#39;#{ancestry_string}&#39; ) )&quot;</span> ).
<span class="line-num">630</span>     <span class="ruby-identifier">where</span>( <span class="ruby-node">&quot;taxa.rank_level &gt; #{taxon_framework.rank_level} AND taxon_frameworks.rank_level IS NOT NULL&quot;</span> )
<span class="line-num">631</span>   <span class="ruby-identifier">other_taxon_frameworks_taxa</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">other_taxon_frameworks</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">632</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">other_taxon_frameworks</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span> ) )
<span class="line-num">633</span>   <span class="ruby-keyword">else</span>
<span class="line-num">634</span>     []
<span class="line-num">635</span>   <span class="ruby-keyword">end</span>
<span class="line-num">636</span> 
<span class="line-num">637</span>   <span class="ruby-identifier">internal_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;ancestry = ? OR ancestry LIKE ?&quot;</span>, <span class="ruby-identifier">ancestry_string</span>, <span class="ruby-node">&quot;#{ancestry_string}/%&quot;</span> ).
<span class="line-num">638</span>     <span class="ruby-identifier">where</span>( <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> ).
<span class="line-num">639</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;rank_level &gt;= ? &quot;</span>, <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">rank_level</span> ).
<span class="line-num">640</span>     <span class="ruby-identifier">where</span>(
<span class="line-num">641</span>       <span class="ruby-string">&quot;( select count(*) from conservation_statuses ct &quot;</span> \
<span class="line-num">642</span>         <span class="ruby-string">&quot;where ct.taxon_id=taxa.id AND ct.iucn=70 AND ct.place_id IS NULL ) = 0&quot;</span>
<span class="line-num">643</span>     )
<span class="line-num">644</span> 
<span class="line-num">645</span>   <span class="ruby-identifier">other_taxon_frameworks_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">646</span>     <span class="ruby-identifier">internal_taxa</span> = <span class="ruby-identifier">internal_taxa</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;ancestry != ? AND ancestry NOT LIKE ?&quot;</span>, <span class="ruby-node">&quot;#{t.ancestry}/#{t.id}&quot;</span>,
<span class="line-num">647</span>       <span class="ruby-node">&quot;#{t.ancestry}/#{t.id}/%&quot;</span> )
<span class="line-num">648</span>   <span class="ruby-keyword">end</span>
<span class="line-num">649</span> 
<span class="line-num">650</span>   <span class="ruby-identifier">internal_taxa</span>
<span class="line-num">651</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-import">
            
              <b>import</b>( name, options = {} )
            
            <a href="../classes/Taxon.html#method-c-import" name="method-c-import" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-import_source')" id="l_method-c-import_source">show</a>
                

                

                
              </p>
              <div id="method-c-import_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1946</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">import</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1947</span>   <span class="ruby-identifier">skip_grafting</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:skip_grafting</span> )
<span class="line-num">1948</span>   <span class="ruby-identifier">name</span> = <span class="ruby-identifier">normalize_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">1949</span>   <span class="ruby-identifier">ancestor</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:ancestor</span> )
<span class="line-num">1950</span>   <span class="ruby-identifier">ratatosk_instance</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:ratatosk</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">ratatosk</span>
<span class="line-num">1951</span>   <span class="ruby-identifier">external_names</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">1952</span>     <span class="ruby-identifier">ratatosk_instance</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">1953</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
<span class="line-num">1954</span>     []
<span class="line-num">1955</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1956</span>   <span class="ruby-identifier">external_names</span>.<span class="ruby-identifier">select!</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">en</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">en</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:exact</span>]
<span class="line-num">1957</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">external_names</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1958</span> 
<span class="line-num">1959</span>   <span class="ruby-identifier">external_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">en</span> <span class="ruby-operator">|</span>
<span class="line-num">1960</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">en</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">skip_grafting</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">en</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">grafted?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">en</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">persisted?</span>
<span class="line-num">1961</span>       <span class="ruby-identifier">en</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">graft_silently</span>
<span class="line-num">1962</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1963</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1964</span>   <span class="ruby-identifier">external_taxa</span> = <span class="ruby-identifier">external_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon</span> )
<span class="line-num">1965</span>   <span class="ruby-identifier">external_taxa</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">1966</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestor</span>
<span class="line-num">1967</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1968</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1969</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">1970</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1971</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1972</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-import_or_create">
            
              <b>import_or_create</b>( name, options = {} )
            
            <a href="../classes/Taxon.html#method-c-import_or_create" name="method-c-import_or_create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-import_or_create_source')" id="l_method-c-import_or_create_source">show</a>
                

                

                
              </p>
              <div id="method-c-import_or_create_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2255</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">import_or_create</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2256</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">import</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">2257</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">taxon</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2258</span> 
<span class="line-num">2259</span>   <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:ancestor</span> )
<span class="line-num">2260</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">create</span>( <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span> ) )
<span class="line-num">2261</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">graft_silently</span>
<span class="line-num">2262</span>   <span class="ruby-identifier">taxon</span>
<span class="line-num">2263</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-index_taxa">
            
              <b>index_taxa</b>( taxa )
            
            <a href="../classes/Taxon.html#method-c-index_taxa" name="method-c-index_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-index_taxa_source')" id="l_method-c-index_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-c-index_taxa_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2577</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">index_taxa</span>( <span class="ruby-identifier">taxa</span> )
<span class="line-num">2578</span>   <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span> }
<span class="line-num">2579</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">taxon_ids</span> )
<span class="line-num">2580</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-match_descendants_of_id">
            
              <b>match_descendants_of_id</b>( id, taxon_hash )
            
            <a href="../classes/Taxon.html#method-c-match_descendants_of_id" name="method-c-match_descendants_of_id" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Static ##################################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-match_descendants_of_id_source')" id="l_method-c-match_descendants_of_id_source">show</a>
                

                

                
              </p>
              <div id="method-c-match_descendants_of_id_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2248</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">match_descendants_of_id</span>( <span class="ruby-identifier">id</span>, <span class="ruby-identifier">taxon_hash</span> )
<span class="line-num">2249</span>   <span class="ruby-identifier">taxon_hash</span>[<span class="ruby-string">&quot;ancestry&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">ancestor</span> <span class="ruby-operator">|</span>
<span class="line-num">2250</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">2251</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2252</span>   <span class="ruby-keyword">false</span>
<span class="line-num">2253</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-max_geoprivacy">
            
              <b>max_geoprivacy</b>( taxon_ids, options = {} )
            
            <a href="../classes/Taxon.html#method-c-max_geoprivacy" name="method-c-max_geoprivacy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-max_geoprivacy_source')" id="l_method-c-max_geoprivacy_source">show</a>
                

                

                
              </p>
              <div id="method-c-max_geoprivacy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1767</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">max_geoprivacy</span>( <span class="ruby-identifier">taxon_ids</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1768</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1769</span> 
<span class="line-num">1770</span>   <span class="ruby-identifier">target_taxon_ids</span> = [
<span class="line-num">1771</span>     <span class="ruby-identifier">taxon_ids</span>,
<span class="line-num">1772</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">taxon_ids</span> ).<span class="ruby-identifier">pluck</span>( <span class="ruby-value">:ancestry</span> ).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> ) }
<span class="line-num">1773</span>   ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1774</span>   <span class="ruby-identifier">global_statuses</span> = <span class="ruby-constant">ConservationStatus</span>.
<span class="line-num">1775</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;place_id IS NULL AND taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">target_taxon_ids</span> ).
<span class="line-num">1776</span>     <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;iucn ASC&quot;</span> )
<span class="line-num">1777</span>   <span class="ruby-identifier">place_statuses</span> = <span class="ruby-constant">ConservationStatus</span>.
<span class="line-num">1778</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">target_taxon_ids</span> ).
<span class="line-num">1779</span>     <span class="ruby-identifier">for_lat_lon</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:latitude</span>], <span class="ruby-identifier">options</span>[<span class="ruby-value">:longitude</span>] ).
<span class="line-num">1780</span>     <span class="ruby-identifier">includes</span>( <span class="ruby-value">:place</span> )
<span class="line-num">1781</span>   <span class="ruby-comment"># If it&#39;s just global statuses, just choose the most conservative one</span>
<span class="line-num">1782</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_statuses</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">global_statuses</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1783</span>     <span class="ruby-identifier">geoprivacies</span> = <span class="ruby-identifier">global_statuses</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:geoprivacy</span> )
<span class="line-num">1784</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> )
<span class="line-num">1785</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span> )
<span class="line-num">1786</span> 
<span class="line-num">1787</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1788</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1789</span>   <span class="ruby-comment"># We have some place-based statuses, so now things get complicated</span>
<span class="line-num">1790</span>   <span class="ruby-comment"># Some admin levels can override a global status or a coarser admin level</span>
<span class="line-num">1791</span>   <span class="ruby-identifier">override_admin_levels</span> = [
<span class="line-num">1792</span>     <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTINENT_LEVEL</span>,
<span class="line-num">1793</span>     <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>,
<span class="line-num">1794</span>     <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>
<span class="line-num">1795</span>   ]
<span class="line-num">1796</span>   <span class="ruby-comment"># Since overrides only apply within a taxon, we need to assess the geoprivacy for each taxon</span>
<span class="line-num">1797</span>   <span class="ruby-identifier">geoprivacies</span> = <span class="ruby-identifier">target_taxon_ids</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">|</span>
<span class="line-num">1798</span>     <span class="ruby-identifier">global_statuses_for_taxon</span> = <span class="ruby-identifier">global_statuses</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_id</span> }
<span class="line-num">1799</span>     <span class="ruby-identifier">place_statuses_for_taxon</span> = <span class="ruby-identifier">place_statuses</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_id</span> }
<span class="line-num">1800</span>     <span class="ruby-identifier">override_statuses</span> = <span class="ruby-identifier">place_statuses_for_taxon</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1801</span>       <span class="ruby-identifier">override_admin_levels</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">admin_level</span> )
<span class="line-num">1802</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1803</span>     <span class="ruby-identifier">non_override_statuses</span> = <span class="ruby-identifier">place_statuses_for_taxon</span>.<span class="ruby-identifier">reject</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1804</span>       <span class="ruby-identifier">override_admin_levels</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">admin_level</span> )
<span class="line-num">1805</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1806</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">non_override_statuses</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">override_statuses</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1807</span>       <span class="ruby-comment"># If an override status exists, and there are no other kinds of statuses</span>
<span class="line-num">1808</span>       <span class="ruby-comment"># to consider, use the geoprivacy from the finest admin level status</span>
<span class="line-num">1809</span>       <span class="ruby-identifier">finest_status</span> = <span class="ruby-identifier">override_statuses</span>.<span class="ruby-identifier">max_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">admin_level</span> }
<span class="line-num">1810</span>       <span class="ruby-identifier">finest_status</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:geoprivacy</span> )
<span class="line-num">1811</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1812</span>       <span class="ruby-comment"># Otherwise it&#39;s a free-for-all and we need to choose the most</span>
<span class="line-num">1813</span>       <span class="ruby-comment"># conservative geoprivacy available from all statuses</span>
<span class="line-num">1814</span>       <span class="ruby-identifier">status_geoprivacies</span> = (
<span class="line-num">1815</span>         <span class="ruby-identifier">global_statuses_for_taxon</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:geoprivacy</span> ) <span class="ruby-operator">+</span> <span class="ruby-identifier">place_statuses_for_taxon</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:geoprivacy</span> )
<span class="line-num">1816</span>       ).<span class="ruby-identifier">compact</span>
<span class="line-num">1817</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">status_geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> )
<span class="line-num">1818</span>         <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span>
<span class="line-num">1819</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">status_geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span> )
<span class="line-num">1820</span>         <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span>
<span class="line-num">1821</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">status_geoprivacies</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1822</span>         <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1823</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1824</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1825</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1826</span>   <span class="ruby-comment"># So now that we have geoprivacies for each of the taxa under consideration,</span>
<span class="line-num">1827</span>   <span class="ruby-comment"># choose the most conservative geoprivacy among them</span>
<span class="line-num">1828</span>   <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">PRIVATE</span> )
<span class="line-num">1829</span>   <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OBSCURED</span> )
<span class="line-num">1830</span> 
<span class="line-num">1831</span>   <span class="ruby-identifier">geoprivacies</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1832</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-normalize_name">
            
              <b>normalize_name</b>( name )
            
            <a href="../classes/Taxon.html#method-c-normalize_name" name="method-c-normalize_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-normalize_name_source')" id="l_method-c-normalize_name_source">show</a>
                

                

                
              </p>
              <div id="method-c-normalize_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2297</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">normalize_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">2298</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">name</span>
<span class="line-num">2299</span>   <span class="ruby-keyword">when</span> <span class="ruby-regexp">/.+ \(=.+?\) .+/</span>
<span class="line-num">2300</span>     <span class="ruby-identifier">pieces</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/(.+) \(=.+?\) (.+)/</span> )
<span class="line-num">2301</span>     <span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{pieces[1]} #{pieces[2]}&quot;</span>
<span class="line-num">2302</span>   <span class="ruby-keyword">when</span> <span class="ruby-regexp">/.+\(.+?\)/</span>
<span class="line-num">2303</span>     <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>[<span class="ruby-regexp">/.+\((.+?)\)/</span>, <span class="ruby-value">1</span>]
<span class="line-num">2304</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2305</span>   <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/[()?]/</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">2306</span>   <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/^\W$/</span>, <span class="ruby-string">&quot;&quot;</span> )
<span class="line-num">2307</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">remove_rank_from_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">2308</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-normalize_rank">
            
              <b>normalize_rank</b>( rank )
            
            <a href="../classes/Taxon.html#method-c-normalize_rank" name="method-c-normalize_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-normalize_rank_source')" id="l_method-c-normalize_rank_source">show</a>
                

                

                
              </p>
              <div id="method-c-normalize_rank_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2278</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">normalize_rank</span>( <span class="ruby-identifier">rank</span> )
<span class="line-num">2279</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">rank</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">2280</span> 
<span class="line-num">2281</span>   <span class="ruby-identifier">rank</span> = <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/[^\w]/</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">downcase</span>
<span class="line-num">2282</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">rank</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">RANKS</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> )
<span class="line-num">2283</span>   <span class="ruby-keyword">return</span> <span class="ruby-constant">RANK_EQUIVALENTS</span>[<span class="ruby-identifier">rank</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">RANK_EQUIVALENTS</span>[<span class="ruby-identifier">rank</span>]
<span class="line-num">2284</span> 
<span class="line-num">2285</span>   <span class="ruby-identifier">rank</span>
<span class="line-num">2286</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-occurs_in">
            
              <b>occurs_in</b>( minx, miny, maxx, maxy, startdate = nil, enddate = nil )
            
            <a href="../classes/Taxon.html#method-c-occurs_in" name="method-c-occurs_in" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>rubocop:disable Metrics/ParameterLists</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-occurs_in_source')" id="l_method-c-occurs_in_source">show</a>
                

                

                
              </p>
              <div id="method-c-occurs_in_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2408</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">occurs_in</span>( <span class="ruby-identifier">minx</span>, <span class="ruby-identifier">miny</span>, <span class="ruby-identifier">maxx</span>, <span class="ruby-identifier">maxy</span>, <span class="ruby-identifier">startdate</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">enddate</span> = <span class="ruby-keyword">nil</span> )
<span class="line-num">2409</span>   <span class="ruby-identifier">startdate</span> = <span class="ruby-identifier">startdate</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-value">100</span>.<span class="ruby-identifier">years</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">startdate</span> ) <span class="ruby-comment"># wtf, only 100 years?!</span>
<span class="line-num">2410</span>   <span class="ruby-identifier">enddate</span> = <span class="ruby-identifier">enddate</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">enddate</span> )
<span class="line-num">2411</span>   <span class="ruby-identifier">startdate</span> = <span class="ruby-identifier">startdate</span>.<span class="ruby-identifier">to_param</span>
<span class="line-num">2412</span>   <span class="ruby-identifier">enddate</span> = <span class="ruby-identifier">enddate</span>.<span class="ruby-identifier">to_param</span>
<span class="line-num">2413</span>   <span class="ruby-identifier">sql</span> = <span class="ruby-node">&quot;
<span class="line-num">2414</span>     SELECT
<span class="line-num">2415</span>       t.*,
<span class="line-num">2416</span>       o.count as count
<span class="line-num">2417</span>     FROM
<span class="line-num">2418</span>       col_taxa t
<span class="line-num">2419</span>         JOIN
<span class="line-num">2420</span>           (SELECT
<span class="line-num">2421</span>               taxon_id, count(*) as count
<span class="line-num">2422</span>             FROM observations
<span class="line-num">2423</span>             WHERE
<span class="line-num">2424</span>               observed_on &gt; &#39;#{startdate}&#39; AND observed_on &lt; &#39;#{enddate}&#39; AND
<span class="line-num">2425</span>               latitude &gt; &#39;#{miny}&#39; AND
<span class="line-num">2426</span>               longitude &gt; &#39;#{minx}&#39; AND
<span class="line-num">2427</span>               latitude &lt; &#39;#{maxy}&#39; AND
<span class="line-num">2428</span>               longitude &lt; &#39;#{maxx}&#39;
<span class="line-num">2429</span>             GROUP BY taxon_id) o
<span class="line-num">2430</span>           ON o.taxon_id=t.record_id
<span class="line-num">2431</span>   &quot;</span>
<span class="line-num">2432</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_sql</span>( <span class="ruby-identifier">sql</span> )
<span class="line-num">2433</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-prepare_batch_for_index">
            
              <b>prepare_batch_for_index</b>(taxa)
            
            <a href="../classes/Taxon.html#method-c-prepare_batch_for_index" name="method-c-prepare_batch_for_index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>This custom prepare_for_index is used to preload place_ids using a SQL call to avoid loading all the listed_taxa into AR objects. This saves a lot of time when bulk indexing</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-prepare_batch_for_index_source')" id="l_method-c-prepare_batch_for_index_source">show</a>
                

                

                
              </p>
              <div id="method-c-prepare_batch_for_index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/taxon_index.rb</span>
<span class="line-num">240</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">prepare_batch_for_index</span>(<span class="ruby-identifier">taxa</span>)
<span class="line-num">241</span>   <span class="ruby-comment"># make sure we default all caches to empty arrays</span>
<span class="line-num">242</span>   <span class="ruby-comment"># this prevents future lookups for instances with no results</span>
<span class="line-num">243</span>   <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">||=</span> [ ] }
<span class="line-num">244</span>   <span class="ruby-identifier">taxa_by_id</span> = <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">t</span> ] } ]
<span class="line-num">245</span>   <span class="ruby-identifier">batch_ids_string</span> = <span class="ruby-identifier">taxa_by_id</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num">246</span>   <span class="ruby-comment"># fetch all place_ids store them in `indexed_place_ids`</span>
<span class="line-num">247</span>   <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;
<span class="line-num">248</span>     SELECT taxon_id, place_id
<span class="line-num">249</span>     FROM listed_taxa lt
<span class="line-num">250</span>     JOIN places p ON (lt.place_id = p.id)
<span class="line-num">251</span>     WHERE lt.taxon_id IN (#{ batch_ids_string })&quot;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
<span class="line-num">252</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> = <span class="ruby-identifier">taxa_by_id</span>[ <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>].<span class="ruby-identifier">to_i</span> ]
<span class="line-num">253</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;place_id&quot;</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">254</span>     <span class="ruby-keyword">end</span>
<span class="line-num">255</span>   <span class="ruby-keyword">end</span>
<span class="line-num">256</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-rebuild_without_callbacks">
            
              <b>rebuild_without_callbacks</b>()
            
            <a href="../classes/Taxon.html#method-c-rebuild_without_callbacks" name="method-c-rebuild_without_callbacks" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-rebuild_without_callbacks_source')" id="l_method-c-rebuild_without_callbacks_source">show</a>
                

                

                
              </p>
              <div id="method-c-rebuild_without_callbacks_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2365</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">rebuild_without_callbacks</span>
<span class="line-num">2366</span>   <span class="ruby-identifier">before_validation</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2367</span>   <span class="ruby-identifier">before_save</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2368</span>   <span class="ruby-identifier">after_save</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2369</span>   <span class="ruby-identifier">validates_associated</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2370</span>   <span class="ruby-identifier">validates_presence_of</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2371</span>   <span class="ruby-identifier">validates_uniqueness_of</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2372</span>   <span class="ruby-identifier">restore_ancestry_integrity!</span>
<span class="line-num">2373</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reindex_descendants_of">
            
              <b>reindex_descendants_of</b>( taxon )
            
            <a href="../classes/Taxon.html#method-c-reindex_descendants_of" name="method-c-reindex_descendants_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reindex_descendants_of_source')" id="l_method-c-reindex_descendants_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-reindex_descendants_of_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">657</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reindex_descendants_of</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">658</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">659</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">660</span> 
<span class="line-num">661</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendants</span> )
<span class="line-num">662</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reindex_taxa_covered_by">
            
              <b>reindex_taxa_covered_by</b>( taxon_framework )
            
            <a href="../classes/Taxon.html#method-c-reindex_taxa_covered_by" name="method-c-reindex_taxa_covered_by" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reindex_taxa_covered_by_source')" id="l_method-c-reindex_taxa_covered_by_source">show</a>
                

                

                
              </p>
              <div id="method-c-reindex_taxa_covered_by_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">653</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reindex_taxa_covered_by</span>( <span class="ruby-identifier">taxon_framework</span> )
<span class="line-num">654</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">get_internal_taxa_covered_by</span>( <span class="ruby-identifier">taxon_framework</span> ) )
<span class="line-num">655</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-remove_rank_from_name">
            
              <b>remove_rank_from_name</b>( name )
            
            <a href="../classes/Taxon.html#method-c-remove_rank_from_name" name="method-c-remove_rank_from_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-remove_rank_from_name_source')" id="l_method-c-remove_rank_from_name_source">show</a>
                

                

                
              </p>
              <div id="method-c-remove_rank_from_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2288</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">remove_rank_from_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">2289</span>   <span class="ruby-identifier">pieces</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>
<span class="line-num">2290</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pieces</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2291</span> 
<span class="line-num">2292</span>   <span class="ruby-identifier">pieces</span>.<span class="ruby-identifier">map!</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-string">&quot;.&quot;</span>, <span class="ruby-string">&quot;&quot;</span> ) }
<span class="line-num">2293</span>   <span class="ruby-identifier">pieces</span>.<span class="ruby-identifier">reject!</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> ( <span class="ruby-constant">RANKS</span> <span class="ruby-operator">+</span> <span class="ruby-constant">RANK_EQUIVALENTS</span>.<span class="ruby-identifier">keys</span> ).<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">p</span>.<span class="ruby-identifier">downcase</span> ) }
<span class="line-num">2294</span>   <span class="ruby-identifier">pieces</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot; &quot;</span> )
<span class="line-num">2295</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reset_iconic_taxa_constants_for_tests">
            
              <b>reset_iconic_taxa_constants_for_tests</b>()
            
            <a href="../classes/Taxon.html#method-c-reset_iconic_taxa_constants_for_tests" name="method-c-reset_iconic_taxa_constants_for_tests" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reset_iconic_taxa_constants_for_tests_source')" id="l_method-c-reset_iconic_taxa_constants_for_tests_source">show</a>
                

                

                
              </p>
              <div id="method-c-reset_iconic_taxa_constants_for_tests_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">544</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reset_iconic_taxa_constants_for_tests</span>
<span class="line-num">545</span>   <span class="ruby-identifier">remove_const</span>( <span class="ruby-string">&quot;ICONIC_TAXA&quot;</span> )
<span class="line-num">546</span>   <span class="ruby-identifier">remove_const</span>( <span class="ruby-string">&quot;ICONIC_TAXA_BY_ID&quot;</span> )
<span class="line-num">547</span>   <span class="ruby-identifier">remove_const</span>( <span class="ruby-string">&quot;ICONIC_TAXA_BY_NAME&quot;</span> )
<span class="line-num">548</span>   <span class="ruby-identifier">const_set</span>( <span class="ruby-string">&quot;ICONIC_TAXA&quot;</span>, <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">sort_by_ancestry</span>( <span class="ruby-identifier">iconic_taxa</span>.<span class="ruby-identifier">arrange</span> ) )
<span class="line-num">549</span>   <span class="ruby-identifier">const_set</span>( <span class="ruby-string">&quot;ICONIC_TAXA_BY_ID&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>.<span class="ruby-identifier">index_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) )
<span class="line-num">550</span>   <span class="ruby-identifier">const_set</span>( <span class="ruby-string">&quot;ICONIC_TAXA_BY_NAME&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>.<span class="ruby-identifier">index_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span> ) )
<span class="line-num">551</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-search_query">
            
              <b>search_query</b>( query )
            
            <a href="../classes/Taxon.html#method-c-search_query" name="method-c-search_query" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>rubocop:enable Metrics/ParameterLists</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-search_query_source')" id="l_method-c-search_query_source">show</a>
                

                

                
              </p>
              <div id="method-c-search_query_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2436</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">search_query</span>( <span class="ruby-identifier">query</span> )
<span class="line-num">2437</span>   <span class="ruby-identifier">q</span> = <span class="ruby-identifier">sanitize_query</span>( <span class="ruby-identifier">query</span> )
<span class="line-num">2438</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2439</span>     <span class="ruby-identifier">q</span> = <span class="ruby-identifier">query</span>
<span class="line-num">2440</span>     <span class="ruby-keyword">return</span> [<span class="ruby-identifier">q</span>, <span class="ruby-value">:all</span>]
<span class="line-num">2441</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2442</span> 
<span class="line-num">2443</span>   <span class="ruby-comment"># for some reason 1-term queries don&#39;t return an exact match first if enclosed</span>
<span class="line-num">2444</span>   <span class="ruby-comment"># in quotes, so we only use them for multi-term queries</span>
<span class="line-num">2445</span>   <span class="ruby-identifier">q</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">q</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\s/</span>
<span class="line-num">2446</span>     <span class="ruby-node">&quot;\&quot;^#{q}$\&quot; | #{q}&quot;</span>
<span class="line-num">2447</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2448</span>     <span class="ruby-node">&quot;^#{q}$ | #{q}&quot;</span>
<span class="line-num">2449</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2450</span>   [<span class="ruby-identifier">q</span>, <span class="ruby-value">:extended</span>]
<span class="line-num">2451</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-set_iconic_taxon_for_observations_of">
            
              <b>set_iconic_taxon_for_observations_of</b>( taxon )
            
            <a href="../classes/Taxon.html#method-c-set_iconic_taxon_for_observations_of" name="method-c-set_iconic_taxon_for_observations_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-set_iconic_taxon_for_observations_of_source')" id="l_method-c-set_iconic_taxon_for_observations_of_source">show</a>
                

                

                
              </p>
              <div id="method-c-set_iconic_taxon_for_observations_of_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2388</span>   <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">set_iconic_taxon_for_observations_of</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">2389</span>     <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">2390</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">2391</span> 
<span class="line-num">2392</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">iconic_taxon_id</span> )
<span class="line-num">2393</span>     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">2394</span> <span class="ruby-value">      UPDATE observations SET iconic_taxon_id = #{taxon.iconic_taxon_id || &#39;NULL&#39;}
<span class="line-num">2395</span>       FROM taxa
<span class="line-num">2396</span>       WHERE#{&#39; &#39;}
<span class="line-num">2397</span>         observations.taxon_id = taxa.id AND#{&#39; &#39;}
<span class="line-num">2398</span>         (#{Taxon.send :sanitize_sql, taxon.descendant_conditions.to_sql})
<span class="line-num">2399</span> </span><span class="ruby-identifier">    SQL</span>
<span class="line-num">2400</span>     <span class="ruby-identifier">descendant_iconic_taxon_ids</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendants</span>.<span class="ruby-identifier">iconic_taxa</span>.<span class="ruby-identifier">select</span>( <span class="ruby-value">:id</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> )
<span class="line-num">2401</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">descendant_iconic_taxon_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2402</span>       <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; AND observations.iconic_taxon_id NOT IN (#{descendant_iconic_taxon_ids.join( &#39;,&#39; )})&quot;</span>
<span class="line-num">2403</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2404</span>     <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span> <span class="ruby-identifier">sql</span>
<span class="line-num">2405</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-single_taxon_for_name">
            
              <b>single_taxon_for_name</b>( name, options = {} )
            
            <a href="../classes/Taxon.html#method-c-single_taxon_for_name" name="method-c-single_taxon_for_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-single_taxon_for_name_source')" id="l_method-c-single_taxon_for_name_source">show</a>
                

                

                
              </p>
              <div id="method-c-single_taxon_for_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2453</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">single_taxon_for_name</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2454</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2455</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">PROBLEM_NAMES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> )
<span class="line-num">2456</span> 
<span class="line-num">2457</span>   <span class="ruby-identifier">name</span> = <span class="ruby-identifier">normalize_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">2458</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">limit</span>( <span class="ruby-value">10</span> ).<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> ).
<span class="line-num">2459</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;lower(taxon_names.name) = ?&quot;</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp">/[\s_]+/</span>, <span class="ruby-string">&quot; &quot;</span> ).<span class="ruby-identifier">downcase</span> )
<span class="line-num">2460</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>].<span class="ruby-identifier">descendant_conditions</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>]
<span class="line-num">2461</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:iconic_taxa</span>]
<span class="line-num">2462</span>     <span class="ruby-identifier">iconic_taxon_ids</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:iconic_taxa</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">it</span> <span class="ruby-operator">|</span>
<span class="line-num">2463</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">it</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">2464</span>         <span class="ruby-identifier">it</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2465</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">it</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">2466</span>         <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA_BY_NAME</span>[<span class="ruby-identifier">it</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:id</span> )
<span class="line-num">2467</span>       <span class="ruby-keyword">else</span>
<span class="line-num">2468</span>         <span class="ruby-identifier">it</span>
<span class="line-num">2469</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2470</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">2471</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxa.iconic_taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">iconic_taxon_ids</span> )
<span class="line-num">2472</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2473</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">2474</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2475</span> 
<span class="line-num">2476</span>   <span class="ruby-identifier">taxa</span> = <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">compact</span>
<span class="line-num">2477</span>   <span class="ruby-comment"># TODO: search elasticsearch?</span>
<span class="line-num">2478</span>   <span class="ruby-comment"># if taxa.blank?</span>
<span class="line-num">2479</span>   <span class="ruby-comment">#   ...</span>
<span class="line-num">2480</span>   <span class="ruby-comment"># end</span>
<span class="line-num">2481</span>   <span class="ruby-identifier">sorted</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">sort_by_ancestry</span>( <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">compact</span> )
<span class="line-num">2482</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2483</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2484</span> 
<span class="line-num">2485</span>   <span class="ruby-comment"># if there&#39;s a single branch of matches, e.g. Homo and Homo sapiens,</span>
<span class="line-num">2486</span>   <span class="ruby-comment"># choose the most conservative, highest rank taxon</span>
<span class="line-num">2487</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">ancestor_of?</span>( <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">last</span> )
<span class="line-num">2488</span>     <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">first</span>
<span class="line-num">2489</span> 
<span class="line-num">2490</span>   <span class="ruby-comment"># if only one result is grafted, choose that</span>
<span class="line-num">2491</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:grafted?</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2492</span>     <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">detect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:grafted?</span> )
<span class="line-num">2493</span> 
<span class="line-num">2494</span>   <span class="ruby-comment"># if none are grafted, choose the first</span>
<span class="line-num">2495</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:grafted?</span> ).<span class="ruby-identifier">size</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">2496</span>     <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> } }
<span class="line-num">2497</span>     <span class="ruby-identifier">taxon</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">first</span>
<span class="line-num">2498</span> 
<span class="line-num">2499</span>   <span class="ruby-comment"># if only one is active, choose the active one</span>
<span class="line-num">2500</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_active?</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2501</span>     <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">detect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_active?</span> )
<span class="line-num">2502</span> 
<span class="line-num">2503</span>   <span class="ruby-comment"># if the names are synonymous and share the same parent and only one is active, choose the active concept</span>
<span class="line-num">2504</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span> ).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2505</span>       <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:parent_id</span> ).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2506</span>       <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_active?</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2507</span>     <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">2508</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">is_active?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> }
<span class="line-num">2509</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2510</span>     <span class="ruby-identifier">taxon</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">sorted</span>.<span class="ruby-identifier">detect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_active?</span> )
<span class="line-num">2511</span> 
<span class="line-num">2512</span>   <span class="ruby-comment"># if names are synonymous but only one is valid, choose the valid one</span>
<span class="line-num">2513</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span> ).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_valid?</span> ).<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2514</span>     <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">detect</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_valid?</span> ).<span class="ruby-identifier">taxon</span>
<span class="line-num">2515</span> 
<span class="line-num">2516</span>     <span class="ruby-comment"># else assume there are &gt; 1 legit synonyms and refuse to make a decision</span>
<span class="line-num">2517</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2518</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-tags_to_taxa">
            
              <b>tags_to_taxa</b>( tags, options = {} )
            
            <a href="../classes/Taxon.html#method-c-tags_to_taxa" name="method-c-tags_to_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Convert an array of strings to taxa</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-tags_to_taxa_source')" id="l_method-c-tags_to_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-c-tags_to_taxa_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2311</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">tags_to_taxa</span>( <span class="ruby-identifier">tags</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2312</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> )
<span class="line-num">2313</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:lexicon</span>]
<span class="line-num">2314</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(
<span class="line-num">2315</span>       <span class="ruby-value">lexicon:</span> [<span class="ruby-identifier">options</span>[<span class="ruby-value">:lexicon</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">|</span> [<span class="ruby-identifier">l</span>, <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">normalize_lexicon</span>( <span class="ruby-identifier">l</span> )] }.<span class="ruby-identifier">flatten</span>
<span class="line-num">2316</span>     )
<span class="line-num">2317</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2318</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_names.is_valid = ?&quot;</span>, <span class="ruby-keyword">true</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:valid</span>]
<span class="line-num">2319</span>   <span class="ruby-identifier">names</span> = <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tag</span> <span class="ruby-operator">|</span>
<span class="line-num">2320</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2321</span> 
<span class="line-num">2322</span>     <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">name</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^taxonomy:\w+=(.*)/</span> ).<span class="ruby-identifier">try</span>( <span class="ruby-value">:[]</span>, <span class="ruby-value">1</span> ) )
<span class="line-num">2323</span>       <span class="ruby-identifier">name</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">normalize_name</span>( <span class="ruby-identifier">tag</span> )
<span class="line-num">2324</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">PROBLEM_NAMES</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> )
<span class="line-num">2325</span> 
<span class="line-num">2326</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2327</span>     <span class="ruby-identifier">name</span>
<span class="line-num">2328</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">2329</span>   <span class="ruby-identifier">lower_names</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span> )
<span class="line-num">2330</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;lower(taxon_names.name) IN (?)&quot;</span>, <span class="ruby-identifier">lower_names</span> )
<span class="line-num">2331</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxa.is_active = ?&quot;</span>, <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">all</span>
<span class="line-num">2332</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">all</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:active</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">true</span>
<span class="line-num">2333</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">|</span>
<span class="line-num">2334</span>     <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^([A-Z]|\d)+$/</span> )
<span class="line-num">2335</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2336</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tn</span>.<span class="ruby-identifier">scientific?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span> }
<span class="line-num">2337</span>   <span class="ruby-identifier">taxon_names</span> = <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tn1</span>, <span class="ruby-identifier">tn2</span> <span class="ruby-operator">|</span>
<span class="line-num">2338</span>     <span class="ruby-identifier">tn1_exact</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">tn1</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">2339</span>     <span class="ruby-identifier">tn2_exact</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">tn2</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">2340</span>     [<span class="ruby-identifier">tn2_exact</span>, <span class="ruby-identifier">tn2</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">size</span>] <span class="ruby-operator">&lt;=&gt;</span> [<span class="ruby-identifier">tn1_exact</span>, <span class="ruby-identifier">tn1</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">size</span>]
<span class="line-num">2341</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2342</span>   <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2343</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_ancestor_photos">
            
              <b>update_ancestor_photos</b>( taxon, photo )
            
            <a href="../classes/Taxon.html#method-c-update_ancestor_photos" name="method-c-update_ancestor_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_ancestor_photos_source')" id="l_method-c-update_ancestor_photos_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_ancestor_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">806</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_ancestor_photos</span>( <span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">photo</span> )
<span class="line-num">807</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">808</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">809</span> 
<span class="line-num">810</span>   <span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">photo</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Photo</span> )
<span class="line-num">811</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo</span>
<span class="line-num">812</span> 
<span class="line-num">813</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">anc</span> <span class="ruby-operator">|</span>
<span class="line-num">814</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">815</span>       <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">photos</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">photo</span>
<span class="line-num">816</span>     <span class="ruby-keyword">end</span>
<span class="line-num">817</span>   <span class="ruby-keyword">end</span>
<span class="line-num">818</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_descendants_with_new_ancestry">
            
              <b>update_descendants_with_new_ancestry</b>( taxon, _child_ancestry_was )
            
            <a href="../classes/Taxon.html#method-c-update_descendants_with_new_ancestry" name="method-c-update_descendants_with_new_ancestry" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_descendants_with_new_ancestry_source')" id="l_method-c-update_descendants_with_new_ancestry_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_descendants_with_new_ancestry_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1882</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_descendants_with_new_ancestry</span>( <span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">_child_ancestry_was</span> )
<span class="line-num">1883</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">1884</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">1885</span> 
<span class="line-num">1886</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO #{Time.now}] updating descendants of #{taxon}&quot;</span>
<span class="line-num">1887</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendant_conditions</span> ).<span class="ruby-identifier">find_in_batches</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">batch</span> <span class="ruby-operator">|</span>
<span class="line-num">1888</span>     <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">1889</span>       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">without_ancestry_callbacks</span> <span class="ruby-keyword">do</span>
<span class="line-num">1890</span>         <span class="ruby-identifier">t</span>.<span class="ruby-identifier">set_iconic_taxon</span>
<span class="line-num">1891</span>         <span class="ruby-identifier">t</span>.<span class="ruby-identifier">update_obs_iconic_taxa</span>
<span class="line-num">1892</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1893</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1894</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1895</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_observation_counts">
            
              <b>update_observation_counts</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-c-update_observation_counts" name="method-c-update_observation_counts" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_observation_counts_source')" id="l_method-c-update_observation_counts_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_observation_counts_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2541</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_observation_counts</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2542</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>]
<span class="line-num">2543</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">taxon</span> = ( <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>] <span class="ruby-operator">:</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>] ) ) )
<span class="line-num">2544</span>       <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendants</span>
<span class="line-num">2545</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2546</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:taxon_ids</span>]
<span class="line-num">2547</span>     <span class="ruby-identifier">taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:taxon_ids</span>] )
<span class="line-num">2548</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:count_ancestors</span>]
<span class="line-num">2549</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:self_and_ancestor_ids</span> ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span> )
<span class="line-num">2550</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2551</span>       <span class="ruby-identifier">taxa</span>
<span class="line-num">2552</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2553</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:scope</span>]
<span class="line-num">2554</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:scope</span>]
<span class="line-num">2555</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2556</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">all</span>
<span class="line-num">2557</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2558</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">2559</span> 
<span class="line-num">2560</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">select</span>( <span class="ruby-string">&quot;id, ancestry&quot;</span> )
<span class="line-num">2561</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">select</span>( <span class="ruby-value">:id</span> ).<span class="ruby-identifier">find_in_batches</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">batch</span> <span class="ruby-operator">|</span>
<span class="line-num">2562</span>     <span class="ruby-identifier">taxon_ids</span> = []
<span class="line-num">2563</span>     <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">2564</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>(
<span class="line-num">2565</span>         <span class="ruby-value">observations_count:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">2566</span>           <span class="ruby-value">filters:</span> [{ <span class="ruby-value">term:</span> { <span class="ruby-string">&quot;taxon.ancestor_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> } }],
<span class="line-num">2567</span>           <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">2568</span>           <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">2569</span>         ).<span class="ruby-identifier">total_entries</span>
<span class="line-num">2570</span>       )
<span class="line-num">2571</span>       <span class="ruby-identifier">taxon_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2572</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2573</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">taxon_ids</span> )
<span class="line-num">2574</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2575</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-without_callbacks">
            
              <b>without_callbacks</b>()
            
            <a href="../classes/Taxon.html#method-c-without_callbacks" name="method-c-without_callbacks" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Do something without all the callbacks.  This disables all callbacks and validations and doesn&#39;t restore them, so IT SHOULD NEVER BE CALLED BY THE APP!  The process should end after this is done.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-without_callbacks_source')" id="l_method-c-without_callbacks_source">show</a>
                

                

                
              </p>
              <div id="method-c-without_callbacks_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2378</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">without_callbacks</span>
<span class="line-num">2379</span>   <span class="ruby-identifier">before_validation</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2380</span>   <span class="ruby-identifier">before_save</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2381</span>   <span class="ruby-identifier">after_save</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2382</span>   <span class="ruby-identifier">validates_associated</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2383</span>   <span class="ruby-identifier">validates_presence_of</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2384</span>   <span class="ruby-identifier">validates_uniqueness_of</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">2385</span>   <span class="ruby-keyword">yield</span>
<span class="line-num">2386</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-activated_protected_attributes_editable_by-3F">
            
              <b>activated_protected_attributes_editable_by?</b>( user )
            
            <a href="../classes/Taxon.html#method-i-activated_protected_attributes_editable_by-3F" name="method-i-activated_protected_attributes_editable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-activated_protected_attributes_editable_by-3F_source')" id="l_method-i-activated_protected_attributes_editable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-activated_protected_attributes_editable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1369</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">activated_protected_attributes_editable_by?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1370</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>&amp;.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1371</span> 
<span class="line-num">1372</span>   <span class="ruby-identifier">upstream_taxon_framework</span> = <span class="ruby-identifier">get_upstream_taxon_framework</span>
<span class="line-num">1373</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">curated_taxon_framework?</span>( <span class="ruby-identifier">upstream_taxon_framework</span> )
<span class="line-num">1374</span> 
<span class="line-num">1375</span>   <span class="ruby-identifier">current_user_curates_taxon?</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">upstream_taxon_framework</span> )
<span class="line-num">1376</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-active_parent_if_active">
            
              <b>active_parent_if_active</b>()
            
            <a href="../classes/Taxon.html#method-i-active_parent_if_active" name="method-i-active_parent_if_active" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-active_parent_if_active_source')" id="l_method-i-active_parent_if_active_source">show</a>
                

                

                
              </p>
              <div id="method-i-active_parent_if_active_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1147</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">active_parent_if_active</span>
<span class="line-num">1148</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_active</span>
<span class="line-num">1149</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_active</span>
<span class="line-num">1150</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">uncommitted</span>.<span class="ruby-identifier">output_taxon</span>( <span class="ruby-identifier">parent</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1151</span> 
<span class="line-num">1152</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-identifier">name</span>,
<span class="line-num">1153</span>     <span class="ruby-string">&quot;must have a parent that is active or the output of a draft taxon change to be active itself&quot;</span> )
<span class="line-num">1154</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-add_to_intersecting_places">
            
              <b>add_to_intersecting_places</b>()
            
            <a href="../classes/Taxon.html#method-i-add_to_intersecting_places" name="method-i-add_to_intersecting_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_to_intersecting_places_source')" id="l_method-i-add_to_intersecting_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_to_intersecting_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1838</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_to_intersecting_places</span>
<span class="line-num">1839</span>   <span class="ruby-constant">Place</span>.
<span class="line-num">1840</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;places.admin_level IN (?)&quot;</span>, [<span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>, <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">COUNTRY_LEVEL</span>] ).
<span class="line-num">1841</span>     <span class="ruby-identifier">intersecting_taxon</span>( <span class="ruby-keyword">self</span> ).
<span class="line-num">1842</span>     <span class="ruby-identifier">find_each</span>(
<span class="line-num">1843</span>       <span class="ruby-value">select:</span> <span class="ruby-string">&quot;places.id, admin_level, check_list_id, taxon_ranges.id AS taxon_range_id&quot;</span>,
<span class="line-num">1844</span>       <span class="ruby-value">include:</span> <span class="ruby-value">:check_list</span>
<span class="line-num">1845</span>     ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">place</span> <span class="ruby-operator">|</span>
<span class="line-num">1846</span>     <span class="ruby-identifier">place</span>.<span class="ruby-identifier">check_list</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:add_taxon</span>, <span class="ruby-keyword">self</span>, <span class="ruby-value">taxon_range_id:</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">taxon_range_id</span> )
<span class="line-num">1847</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1848</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-all_names">
            
              <b>all_names</b>()
            
            <a href="../classes/Taxon.html#method-i-all_names" name="method-i-all_names" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-all_names_source')" id="l_method-i-all_names_source">show</a>
                

                

                
              </p>
              <div id="method-i-all_names_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1942</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">all_names</span>
<span class="line-num">1943</span>   <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span> )
<span class="line-num">1944</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ancestor_of-3F">
            
              <b>ancestor_of?</b>( taxon )
            
            <a href="../classes/Taxon.html#method-i-ancestor_of-3F" name="method-i-ancestor_of-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ancestor_of-3F_source')" id="l_method-i-ancestor_of-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-ancestor_of-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1638</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ancestor_of?</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">1639</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">1640</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ancestry_and_active_if_taxon_framework">
            
              <b>ancestry_and_active_if_taxon_framework</b>()
            
            <a href="../classes/Taxon.html#method-i-ancestry_and_active_if_taxon_framework" name="method-i-ancestry_and_active_if_taxon_framework" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ancestry_and_active_if_taxon_framework_source')" id="l_method-i-ancestry_and_active_if_taxon_framework_source">show</a>
                

                

                
              </p>
              <div id="method-i-ancestry_and_active_if_taxon_framework_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1189</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ancestry_and_active_if_taxon_framework</span>
<span class="line-num">1190</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_framework</span>&amp;.<span class="ruby-identifier">covers?</span>
<span class="line-num">1191</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ancestry_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">is_active_changed?</span>
<span class="line-num">1192</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">is_active</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="line-num">1193</span> 
<span class="line-num">1194</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:base</span>,
<span class="line-num">1195</span>     <span class="ruby-string">&quot;taxa with attached taxon frameworks must have ancestries and be active. Remove the taxon framework first&quot;</span> )
<span class="line-num">1196</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1197</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-apply_orphan_strategy">
            
              <b>apply_orphan_strategy</b>()
            
            <a href="../classes/Taxon.html#method-i-apply_orphan_strategy" name="method-i-apply_orphan_strategy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-apply_orphan_strategy_source')" id="l_method-i-apply_orphan_strategy_source">show</a>
                

                

                
              </p>
              <div id="method-i-apply_orphan_strategy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1897</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">apply_orphan_strategy</span>
<span class="line-num">1898</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestry_callbacks_disabled?</span>
<span class="line-num">1899</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1900</span> 
<span class="line-num">1901</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">apply_orphan_strategy</span>( <span class="ruby-identifier">child_ancestry</span> )
<span class="line-num">1902</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-as_indexed_json">
            
              <b>as_indexed_json</b>(options={})
            
            <a href="../classes/Taxon.html#method-i-as_indexed_json" name="method-i-as_indexed_json" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-as_indexed_json_source')" id="l_method-i-as_indexed_json_source">show</a>
                

                

                
              </p>
              <div id="method-i-as_indexed_json_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/taxon_index.rb</span>
<span class="line-num">158</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">as_indexed_json</span>(<span class="ruby-identifier">options</span>={})
<span class="line-num">159</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">indexed_place_ids</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:for_observation</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">160</span>     <span class="ruby-comment"># make sure taxon names are up-to-date</span>
<span class="line-num">161</span>     <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">reload</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">length</span>
<span class="line-num">162</span>   <span class="ruby-keyword">end</span>
<span class="line-num">163</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">164</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">165</span>     <span class="ruby-value">rank:</span> <span class="ruby-identifier">rank</span>,
<span class="line-num">166</span>     <span class="ruby-value">rank_level:</span> <span class="ruby-identifier">rank_level</span>,
<span class="line-num">167</span>     <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-identifier">iconic_taxon_id</span>,
<span class="line-num">168</span>     <span class="ruby-value">ancestor_ids:</span> ((<span class="ruby-identifier">ancestry</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;/&quot;</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>) <span class="ruby-operator">:</span> [ ]) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">id</span> ),
<span class="line-num">169</span>     <span class="ruby-value">is_active:</span> <span class="ruby-identifier">is_active</span>,
<span class="line-num">170</span>     <span class="ruby-value">min_species_taxon_id:</span> (<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-string">&quot;species&quot;</span>]) <span class="ruby-operator">?</span>
<span class="line-num">171</span>       <span class="ruby-identifier">parent_id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">id</span>
<span class="line-num">172</span>   }
<span class="line-num">173</span>   <span class="ruby-comment"># min_species_* below means don&#39;t consider any ranks more specific than species.</span>
<span class="line-num">174</span>   <span class="ruby-comment"># If the taxon is a subspecies, its min_species_ancestry stops at species</span>
<span class="line-num">175</span>   <span class="ruby-comment"># and its min_species_taxon_id is the ID of its parent, the species.</span>
<span class="line-num">176</span>   <span class="ruby-comment"># These are used in Elasticsearch aggregations, for example leaf counts</span>
<span class="line-num">177</span> 
<span class="line-num">178</span>   <span class="ruby-comment"># indexing originating from Identifications</span>
<span class="line-num">179</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:for_identification</span>]
<span class="line-num">180</span>     <span class="ruby-keyword">if</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span>
<span class="line-num">181</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestor_ids</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">182</span>     <span class="ruby-keyword">end</span>
<span class="line-num">183</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:min_species_ancestry</span>] = (<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-string">&quot;species&quot;</span>]) <span class="ruby-operator">?</span>
<span class="line-num">184</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestor_ids</span>][<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestor_ids</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num">185</span>   <span class="ruby-keyword">else</span>
<span class="line-num">186</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:name</span>] = <span class="ruby-identifier">name</span>
<span class="line-num">187</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:parent_id</span>] = <span class="ruby-identifier">parent_id</span>
<span class="line-num">188</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestry</span>] = <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestor_ids</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num">189</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:min_species_ancestry</span>] = (<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-string">&quot;species&quot;</span>]) <span class="ruby-operator">?</span>
<span class="line-num">190</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestor_ids</span>][<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">json</span>[<span class="ruby-value">:ancestry</span>]
<span class="line-num">191</span>   <span class="ruby-keyword">end</span>
<span class="line-num">192</span>   <span class="ruby-comment"># indexing originating Observations, not via another model</span>
<span class="line-num">193</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">194</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:for_observation</span>]
<span class="line-num">195</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:names</span>] = <span class="ruby-identifier">taxon_names</span>.
<span class="line-num">196</span>         <span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">position</span>, <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">id</span> ] }.
<span class="line-num">197</span>         <span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">autocomplete:</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:for_observation</span>]) }
<span class="line-num">198</span>     <span class="ruby-keyword">end</span>
<span class="line-num">199</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:statuses</span>] = <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>)
<span class="line-num">200</span>     <span class="ruby-identifier">json</span>[<span class="ruby-value">:extinct</span>] = <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">cs</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">IUCN_EXTINCT</span> }.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">201</span>   <span class="ruby-keyword">end</span>
<span class="line-num">202</span>   <span class="ruby-comment"># indexing originating from Taxa</span>
<span class="line-num">203</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:for_observation</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">204</span>     <span class="ruby-identifier">flag_counts</span> = <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">group</span>( <span class="ruby-value">:resolved</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">205</span>     <span class="ruby-identifier">json</span>.<span class="ruby-identifier">merge!</span>({
<span class="line-num">206</span>       <span class="ruby-value">created_at:</span> <span class="ruby-identifier">created_at</span>,
<span class="line-num">207</span>       <span class="ruby-value">default_photo:</span> <span class="ruby-identifier">default_photo</span> <span class="ruby-operator">?</span>
<span class="line-num">208</span>         <span class="ruby-identifier">default_photo</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">sizes:</span> [ <span class="ruby-value">:square</span>, <span class="ruby-value">:medium</span> ]) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">209</span>       <span class="ruby-value">colors:</span> <span class="ruby-identifier">colors</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">210</span>       <span class="ruby-value">ancestry:</span> <span class="ruby-identifier">ancestry</span>,
<span class="line-num">211</span>       <span class="ruby-value">taxon_changes_count:</span> <span class="ruby-identifier">taxon_changes_count</span>,
<span class="line-num">212</span>       <span class="ruby-value">taxon_schemes_count:</span> <span class="ruby-identifier">taxon_schemes_count</span>,
<span class="line-num">213</span>       <span class="ruby-value">observations_count:</span> <span class="ruby-identifier">observations_count</span>,
<span class="line-num">214</span>       <span class="ruby-value">photos_locked:</span> <span class="ruby-identifier">photos_locked</span>,
<span class="line-num">215</span>       <span class="ruby-value">universal_search_rank:</span> <span class="ruby-identifier">observations_count</span>,
<span class="line-num">216</span>       <span class="ruby-value">flag_counts:</span> {
<span class="line-num">217</span>         <span class="ruby-value">resolved:</span> <span class="ruby-identifier">flag_counts</span>[<span class="ruby-keyword">true</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>,
<span class="line-num">218</span>         <span class="ruby-value">unresolved:</span> <span class="ruby-identifier">flag_counts</span>[<span class="ruby-keyword">false</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
<span class="line-num">219</span>       },
<span class="line-num">220</span>       <span class="ruby-value">current_synonymous_taxon_ids:</span> <span class="ruby-identifier">is_active?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">current_synonymous_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>),
<span class="line-num">221</span>       <span class="ruby-comment"># see prepare_for_index. Basicaly indexed_place_ids may be set</span>
<span class="line-num">222</span>       <span class="ruby-comment"># when using Taxon.elasticindex! to bulk import</span>
<span class="line-num">223</span>       <span class="ruby-value">place_ids:</span> (<span class="ruby-identifier">indexed_place_ids</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:place_id</span>)).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>,
<span class="line-num">224</span>       <span class="ruby-value">listed_taxa:</span> <span class="ruby-identifier">listed_taxa_with_means_or_statuses</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">225</span>       <span class="ruby-value">taxon_photos:</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tp</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tp</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">blank?</span> }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">226</span>       <span class="ruby-value">atlas_id:</span> <span class="ruby-identifier">atlas</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:id</span> ),
<span class="line-num">227</span>       <span class="ruby-value">complete_species_count:</span> <span class="ruby-identifier">complete_species_count</span>,
<span class="line-num">228</span>       <span class="ruby-value">wikipedia_url:</span> <span class="ruby-identifier">en_wikipedia_description</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">en_wikipedia_description</span>.<span class="ruby-identifier">url</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">229</span>     })
<span class="line-num">230</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_framework</span> = <span class="ruby-identifier">get_complete_taxon_framework_for_internode_or_root</span>
<span class="line-num">231</span>       <span class="ruby-identifier">json</span>[<span class="ruby-value">:complete_rank</span>] = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_FOR_RANK_LEVEL</span>[<span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">rank_level</span>]
<span class="line-num">232</span>     <span class="ruby-keyword">end</span>
<span class="line-num">233</span>   <span class="ruby-keyword">end</span>
<span class="line-num">234</span>   <span class="ruby-identifier">json</span>
<span class="line-num">235</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-atlased-3F">
            
              <b>atlased?</b>()
            
            <a href="../classes/Taxon.html#method-i-atlased-3F" name="method-i-atlased-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>rubocop:enable Naming/PredicateName</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-atlased-3F_source')" id="l_method-i-atlased-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-atlased-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2095</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">atlased?</span>
<span class="line-num">2096</span>   <span class="ruby-keyword">return</span> <span class="ruby-ivar">@atlased</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@atlased</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">2097</span> 
<span class="line-num">2098</span>   <span class="ruby-ivar">@atlased</span> = <span class="ruby-identifier">atlas</span>&amp;.<span class="ruby-identifier">is_active?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">atlas</span>.<span class="ruby-identifier">presence_places</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">2099</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-auto_summary">
            
              <b>auto_summary</b>()
            
            <a href="../classes/Taxon.html#method-i-auto_summary" name="method-i-auto_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-auto_summary_source')" id="l_method-i-auto_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-auto_summary_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1497</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">auto_summary</span>
<span class="line-num">1498</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">LIFE</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">LIFE</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1499</span> 
<span class="line-num">1500</span>   <span class="ruby-identifier">translated_rank</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1501</span>     <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:rank</span>, <span class="ruby-value">default:</span> <span class="ruby-string">&quot;rank&quot;</span> ).<span class="ruby-identifier">downcase</span>
<span class="line-num">1502</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1503</span>     <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-node">&quot;ranks.#{rank}&quot;</span>, <span class="ruby-value">default:</span> <span class="ruby-identifier">rank</span> ).<span class="ruby-identifier">downcase</span>
<span class="line-num">1504</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1505</span>   <span class="ruby-identifier">summary</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">kingdom?</span>
<span class="line-num">1506</span>     <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:taxon_is_kingdom_of_life_with_x_observations</span>, <span class="ruby-value">taxon:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">count:</span> <span class="ruby-identifier">observations_count</span> )
<span class="line-num">1507</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">iconic_taxon_id</span>
<span class="line-num">1508</span>     <span class="ruby-identifier">iconic_name</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">iconic_taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span>
<span class="line-num">1509</span>       <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">iconic_taxon_name</span>
<span class="line-num">1510</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1511</span>       <span class="ruby-identifier">iconic_taxon_name</span>
<span class="line-num">1512</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1513</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">iconic_taxon_name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1514</span>       <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(
<span class="line-num">1515</span>         <span class="ruby-node">&quot;taxon_is_a_rank_of_#{iconic_name.downcase.underscore}_with_x_observations&quot;</span>,
<span class="line-num">1516</span>         <span class="ruby-value">taxon:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">1517</span>         <span class="ruby-value">rank:</span> <span class="ruby-identifier">translated_rank</span>,
<span class="line-num">1518</span>         <span class="ruby-value">count:</span> <span class="ruby-identifier">observations_count</span>,
<span class="line-num">1519</span>         <span class="ruby-value">default:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(
<span class="line-num">1520</span>           <span class="ruby-value">:taxon_is_a_rank_in_iconic_taxon_with_x_observations</span>,
<span class="line-num">1521</span>           <span class="ruby-value">taxon:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">1522</span>           <span class="ruby-value">rank:</span> <span class="ruby-identifier">translated_rank</span>,
<span class="line-num">1523</span>           <span class="ruby-value">iconic_taxon:</span> <span class="ruby-identifier">iconic_name</span>,
<span class="line-num">1524</span>           <span class="ruby-value">count:</span> <span class="ruby-identifier">observations_count</span>
<span class="line-num">1525</span>         )
<span class="line-num">1526</span>       )
<span class="line-num">1527</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1528</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1529</span>   <span class="ruby-identifier">summary</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:taxon_is_a_rank</span>, <span class="ruby-value">taxon:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">rank:</span> <span class="ruby-identifier">translated_rank</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1530</span>   <span class="ruby-identifier">summary</span>
<span class="line-num">1531</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-cached_atlas_presence_places">
            
              <b>cached_atlas_presence_places</b>()
            
            <a href="../classes/Taxon.html#method-i-cached_atlas_presence_places" name="method-i-cached_atlas_presence_places" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-cached_atlas_presence_places_source')" id="l_method-i-cached_atlas_presence_places_source">show</a>
                

                

                
              </p>
              <div id="method-i-cached_atlas_presence_places_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2101</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cached_atlas_presence_places</span>
<span class="line-num">2102</span>   <span class="ruby-ivar">@cached_atlas_presence_places</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">atlas</span>.<span class="ruby-identifier">presence_places</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">atlas</span>
<span class="line-num">2103</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-can_be_grafted_to">
            
              <b>can_be_grafted_to</b>()
            
            <a href="../classes/Taxon.html#method-i-can_be_grafted_to" name="method-i-can_be_grafted_to" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-can_be_grafted_to_source')" id="l_method-i-can_be_grafted_to_source">show</a>
                

                

                
              </p>
              <div id="method-i-can_be_grafted_to_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1240</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">can_be_grafted_to</span>
<span class="line-num">1241</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">skip_taxon_framework_checks</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1242</span>       <span class="ruby-identifier">taxon_framework</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1243</span>       <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">covers?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1244</span>       <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1245</span>       (
<span class="line-num">1246</span>         <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (
<span class="line-num">1247</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1248</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1249</span>         )
<span class="line-num">1250</span>       )
<span class="line-num">1251</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">1252</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1253</span> 
<span class="line-num">1254</span>   <span class="ruby-identifier">upstream_taxon_framework</span> = <span class="ruby-identifier">get_upstream_taxon_framework</span>
<span class="line-num">1255</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">skip_taxon_framework_checks</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1256</span>       <span class="ruby-identifier">upstream_taxon_framework</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1257</span>       <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">upstream_taxon_framework</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1258</span>       <span class="ruby-identifier">upstream_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1259</span>       (
<span class="line-num">1260</span>         <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (
<span class="line-num">1261</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1262</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">upstream_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1263</span>         )
<span class="line-num">1264</span>       )
<span class="line-num">1265</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">1266</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1267</span> 
<span class="line-num">1268</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1269</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-can_only_be_featured_if_photos">
            
              <b>can_only_be_featured_if_photos</b>()
            
            <a href="../classes/Taxon.html#method-i-can_only_be_featured_if_photos" name="method-i-can_only_be_featured_if_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-can_only_be_featured_if_photos_source')" id="l_method-i-can_only_be_featured_if_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-can_only_be_featured_if_photos_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1156</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">can_only_be_featured_if_photos</span>
<span class="line-num">1157</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-operator">!</span><span class="ruby-identifier">featured_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1158</span> 
<span class="line-num">1159</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:featured_at</span>, <span class="ruby-string">&quot;can only be set if the taxon has photos&quot;</span> )
<span class="line-num">1160</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-cannot_edit_parent_during_content_freeze">
            
              <b>cannot_edit_parent_during_content_freeze</b>()
            
            <a href="../classes/Taxon.html#method-i-cannot_edit_parent_during_content_freeze" name="method-i-cannot_edit_parent_during_content_freeze" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Callbacks ###############################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-cannot_edit_parent_during_content_freeze_source')" id="l_method-i-cannot_edit_parent_during_content_freeze_source">show</a>
                

                

                
              </p>
              <div id="method-i-cannot_edit_parent_during_content_freeze_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">555</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cannot_edit_parent_during_content_freeze</span>
<span class="line-num">556</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">content_freeze_enabled</span>
<span class="line-num">557</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">558</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ancestry_changed?</span>
<span class="line-num">559</span> 
<span class="line-num">560</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:parent_id</span>, <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;cannot_be_changed_during_a_content_freeze&quot;</span> ) )
<span class="line-num">561</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-capitalize_name">
            
              <b>capitalize_name</b>()
            
            <a href="../classes/Taxon.html#method-i-capitalize_name" name="method-i-capitalize_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-capitalize_name_source')" id="l_method-i-capitalize_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-capitalize_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">753</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">capitalize_name</span>
<span class="line-num">754</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">capitalize_scientific_name</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">rank</span> )
<span class="line-num">755</span>   <span class="ruby-keyword">true</span>
<span class="line-num">756</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-clash_analysis">
            
              <b>clash_analysis</b>( new_parent_id )
            
            <a href="../classes/Taxon.html#method-i-clash_analysis" name="method-i-clash_analysis" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-clash_analysis_source')" id="l_method-i-clash_analysis_source">show</a>
                

                

                
              </p>
              <div id="method-i-clash_analysis_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2160</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clash_analysis</span>( <span class="ruby-identifier">new_parent_id</span> )
<span class="line-num">2161</span>   <span class="ruby-keyword">if</span> <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/identifications&quot;</span>, { <span class="ruby-value">current:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">exact_taxon_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">0</span> } ).<span class="ruby-identifier">total_results</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">2162</span>     <span class="ruby-keyword">return</span> []
<span class="line-num">2163</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2164</span> 
<span class="line-num">2165</span>   <span class="ruby-identifier">new_parent</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">new_parent_id</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">2166</span>   <span class="ruby-identifier">child_ids</span> = [<span class="ruby-identifier">id</span>]
<span class="line-num">2167</span>   <span class="ruby-identifier">old_parent_ancestor_ids</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>
<span class="line-num">2168</span>   <span class="ruby-identifier">new_parent_ancestor_ids</span> = <span class="ruby-identifier">new_parent</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>
<span class="line-num">2169</span>   <span class="ruby-identifier">narrowed_parents</span> = <span class="ruby-identifier">old_parent_ancestor_ids</span>.<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tid</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">new_parent_ancestor_ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">tid</span> }
<span class="line-num">2170</span>   <span class="ruby-identifier">detect_clashes</span>( <span class="ruby-identifier">narrowed_parents</span>, <span class="ruby-identifier">child_ids</span> )
<span class="line-num">2171</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-common_name">
            
              <b>common_name</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-common_name" name="method-i-common_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Return just one common name.  Defaults to the first English common name, then first name of unspecified language (not-not-English), then the first common name of any language failing that</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-common_name_source')" id="l_method-i-common_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-common_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">956</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">common_name</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">957</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">958</span>   <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">choose_common_name</span>( <span class="ruby-identifier">taxon_names</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">959</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-common_name_string">
            
              <b>common_name_string</b>()
            
            <a href="../classes/Taxon.html#method-i-common_name_string" name="method-i-common_name_string" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-common_name_string_source')" id="l_method-i-common_name_string_source">show</a>
                

                

                
              </p>
              <div id="method-i-common_name_string_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">961</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">common_name_string</span>
<span class="line-num">962</span>   <span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:name</span> )
<span class="line-num">963</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-complete_species_count">
            
              <b>complete_species_count</b>()
            
            <a href="../classes/Taxon.html#method-i-complete_species_count" name="method-i-complete_species_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-complete_species_count_source')" id="l_method-i-complete_species_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-complete_species_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">676</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">complete_species_count</span>
<span class="line-num">677</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">678</span> 
<span class="line-num">679</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_framework</span>&amp;.<span class="ruby-identifier">covers?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_framework</span>&amp;.<span class="ruby-identifier">complete</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">680</span>     <span class="ruby-identifier">upstream_framework</span> = <span class="ruby-identifier">upstream_taxon_framework</span>
<span class="line-num">681</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span>  <span class="ruby-identifier">upstream_framework</span>&amp;.<span class="ruby-identifier">complete</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">upstream_framework</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">682</span>   <span class="ruby-keyword">end</span>
<span class="line-num">683</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">descendants</span>.
<span class="line-num">684</span>     <span class="ruby-identifier">select</span>( <span class="ruby-value">:id</span> ).<span class="ruby-identifier">distinct</span>.
<span class="line-num">685</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;rank = ? AND is_active&quot;</span>, <span class="ruby-constant">SPECIES</span> ).
<span class="line-num">686</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;(select count(*) from conservation_statuses cs
<span class="line-num">687</span>       WHERE cs.taxon_id = taxa.id AND cs.place_id IS NULL AND cs.iucn = ?) = 0&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">IUCN_EXTINCT</span> )
<span class="line-num">688</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">count</span>
<span class="line-num">689</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-conservation_status_code">
            
              <b>conservation_status_code</b>()
            
            <a href="../classes/Taxon.html#method-i-conservation_status_code" name="method-i-conservation_status_code" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-conservation_status_code_source')" id="l_method-i-conservation_status_code_source">show</a>
                

                

                
              </p>
              <div id="method-i-conservation_status_code_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1661</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">conservation_status_code</span>
<span class="line-num">1662</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">global_conservation_status</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1663</span> 
<span class="line-num">1664</span>   <span class="ruby-constant">IUCN_STATUS_CODES</span>[<span class="ruby-identifier">conservation_status_name</span>]
<span class="line-num">1665</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-conservation_status_name">
            
              <b>conservation_status_name</b>()
            
            <a href="../classes/Taxon.html#method-i-conservation_status_name" name="method-i-conservation_status_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>TODO: make this work for different conservation status sources</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-conservation_status_name_source')" id="l_method-i-conservation_status_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-conservation_status_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1655</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">conservation_status_name</span>
<span class="line-num">1656</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">global_conservation_status</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1657</span> 
<span class="line-num">1658</span>   <span class="ruby-constant">IUCN_STATUSES</span>[<span class="ruby-identifier">global_conservation_status</span>.<span class="ruby-identifier">iucn</span>]
<span class="line-num">1659</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_matching_taxon_name">
            
              <b>create_matching_taxon_name</b>()
            
            <a href="../classes/Taxon.html#method-i-create_matching_taxon_name" name="method-i-create_matching_taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a taxon name with the same name as this taxon</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_matching_taxon_name_source')" id="l_method-i-create_matching_taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_matching_taxon_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">785</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_matching_taxon_name</span>
<span class="line-num">786</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@skip_new_taxon_name</span>
<span class="line-num">787</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scientific_name</span>
<span class="line-num">788</span> 
<span class="line-num">789</span>   <span class="ruby-identifier">taxon_attributes</span> = <span class="ruby-identifier">attributes</span>
<span class="line-num">790</span>   <span class="ruby-identifier">taxon_attributes</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&quot;id&quot;</span> )
<span class="line-num">791</span>   <span class="ruby-identifier">tn</span> = <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">new</span>
<span class="line-num">792</span>   <span class="ruby-identifier">taxon_attributes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span>
<span class="line-num">793</span>     <span class="ruby-identifier">tn</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">k</span> )
<span class="line-num">794</span>   <span class="ruby-keyword">end</span>
<span class="line-num">795</span>   <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">lexicon</span> = <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">LEXICONS</span>[<span class="ruby-value">:SCIENTIFIC_NAMES</span>]
<span class="line-num">796</span>   <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid</span> = <span class="ruby-keyword">true</span>
<span class="line-num">797</span> 
<span class="line-num">798</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tn</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tn</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:source_identifier</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">799</span>     <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">source_identifier</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">800</span>   <span class="ruby-keyword">end</span>
<span class="line-num">801</span> 
<span class="line-num">802</span>   <span class="ruby-identifier">taxon_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tn</span>
<span class="line-num">803</span>   <span class="ruby-keyword">true</span>
<span class="line-num">804</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-curated_taxon_framework-3F">
            
              <b>curated_taxon_framework?</b>( taxon_framework )
            
            <a href="../classes/Taxon.html#method-i-curated_taxon_framework-3F" name="method-i-curated_taxon_framework-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-curated_taxon_framework-3F_source')" id="l_method-i-curated_taxon_framework-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-curated_taxon_framework-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1327</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">curated_taxon_framework?</span>( <span class="ruby-identifier">taxon_framework</span> )
<span class="line-num">1328</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_framework</span>
<span class="line-num">1329</span> 
<span class="line-num">1330</span>   <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">1331</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-current_synonymous_taxa">
            
              <b>current_synonymous_taxa</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-current_synonymous_taxa" name="method-i-current_synonymous_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-current_synonymous_taxa_source')" id="l_method-i-current_synonymous_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-i-current_synonymous_taxa_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2134</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_synonymous_taxa</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2135</span>   <span class="ruby-identifier">without_taxon_ids</span> = [<span class="ruby-identifier">options</span>[<span class="ruby-value">:without_taxon_ids</span>] <span class="ruby-operator">||</span> [], <span class="ruby-identifier">id</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2136</span>   <span class="ruby-identifier">synonymous_taxa</span> = <span class="ruby-identifier">current_synonymous_taxa_from_split</span>( <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span> )
<span class="line-num">2137</span>   <span class="ruby-identifier">taxon_from_swaps_and_merge</span> = <span class="ruby-identifier">current_synonymous_taxon</span>( <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span> )
<span class="line-num">2138</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_from_swaps_and_merge</span>
<span class="line-num">2139</span>     <span class="ruby-identifier">synonymous_taxa</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">taxon_from_swaps_and_merge</span>
<span class="line-num">2140</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2141</span>   <span class="ruby-identifier">inactive_synonym_from_swaps_and_merge</span> = <span class="ruby-identifier">current_synonymous_taxon</span>(
<span class="line-num">2142</span>     <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span>,
<span class="line-num">2143</span>     <span class="ruby-value">inactive:</span> <span class="ruby-keyword">true</span>
<span class="line-num">2144</span>   )
<span class="line-num">2145</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">inactive_synonym_from_swaps_and_merge</span>
<span class="line-num">2146</span>     <span class="ruby-identifier">inactive_synonym_synonyms</span> = <span class="ruby-identifier">inactive_synonym_from_swaps_and_merge</span>.<span class="ruby-identifier">current_synonymous_taxa</span>(
<span class="line-num">2147</span>       <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span>
<span class="line-num">2148</span>     )
<span class="line-num">2149</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">inactive_synonym_synonyms</span>
<span class="line-num">2150</span>       <span class="ruby-identifier">synonymous_taxa</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">inactive_synonym_synonyms</span>
<span class="line-num">2151</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2152</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2153</span>   <span class="ruby-identifier">synonymous_taxa</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2154</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-current_synonymous_taxa_from_split">
            
              <b>current_synonymous_taxa_from_split</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-current_synonymous_taxa_from_split" name="method-i-current_synonymous_taxa_from_split" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-current_synonymous_taxa_from_split_source')" id="l_method-i-current_synonymous_taxa_from_split_source">show</a>
                

                

                
              </p>
              <div id="method-i-current_synonymous_taxa_from_split_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2124</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_synonymous_taxa_from_split</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2125</span>   <span class="ruby-identifier">without_taxon_ids</span> = [<span class="ruby-identifier">options</span>[<span class="ruby-value">:without_taxon_ids</span>] <span class="ruby-operator">||</span> [], <span class="ruby-identifier">id</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2126</span>   <span class="ruby-identifier">last_committed_split</span> = <span class="ruby-constant">TaxonSplit</span>.<span class="ruby-identifier">committed</span>.<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;taxon_changes.id desc&quot;</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">2127</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_committed_split</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2128</span> 
<span class="line-num">2129</span>   <span class="ruby-identifier">last_committed_split</span>.<span class="ruby-identifier">output_taxa</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">2130</span>     <span class="ruby-identifier">t</span>.<span class="ruby-identifier">is_active?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">current_synonymous_taxa</span>( <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span> )
<span class="line-num">2131</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2132</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-current_synonymous_taxon">
            
              <b>current_synonymous_taxon</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-current_synonymous_taxon" name="method-i-current_synonymous_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-current_synonymous_taxon_source')" id="l_method-i-current_synonymous_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-current_synonymous_taxon_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2105</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_synonymous_taxon</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">2106</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_active?</span>
<span class="line-num">2107</span> 
<span class="line-num">2108</span>   <span class="ruby-identifier">without_taxon_ids</span> = [<span class="ruby-identifier">options</span>[<span class="ruby-value">:without_taxon_ids</span>] <span class="ruby-operator">||</span> [], <span class="ruby-identifier">id</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2109</span>   <span class="ruby-identifier">synonymous_taxon</span> = <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">committed</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;type IN (&#39;TaxonSwap&#39;, &#39;TaxonMerge&#39;)&quot;</span> ).
<span class="line-num">2110</span>     <span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon_change_taxa</span> ).
<span class="line-num">2111</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_change_taxa.taxon_id = ?&quot;</span>, <span class="ruby-keyword">self</span> ).
<span class="line-num">2112</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_changes.taxon_id NOT IN (?)&quot;</span>, <span class="ruby-identifier">without_taxon_ids</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-value">:id</span> ).<span class="ruby-identifier">last</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:output_taxon</span> )
<span class="line-num">2113</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">synonymous_taxon</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">synonymous_taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2114</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">synonymous_taxon</span>.<span class="ruby-identifier">is_active?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:inactive</span>]
<span class="line-num">2115</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">synonymous_taxon</span>
<span class="line-num">2116</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2117</span> 
<span class="line-num">2118</span>   <span class="ruby-identifier">candidates</span> = <span class="ruby-identifier">synonymous_taxon</span>.<span class="ruby-identifier">current_synonymous_taxa</span>( <span class="ruby-value">without_taxon_ids:</span> <span class="ruby-identifier">without_taxon_ids</span> )
<span class="line-num">2119</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">2120</span> 
<span class="line-num">2121</span>   <span class="ruby-identifier">candidates</span>.<span class="ruby-identifier">first</span>
<span class="line-num">2122</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-current_user_curates_taxon-3F">
            
              <b>current_user_curates_taxon?</b>( user, taxon_framework )
            
            <a href="../classes/Taxon.html#method-i-current_user_curates_taxon-3F" name="method-i-current_user_curates_taxon-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-current_user_curates_taxon-3F_source')" id="l_method-i-current_user_curates_taxon-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-current_user_curates_taxon-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1333</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_user_curates_taxon?</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">taxon_framework</span> )
<span class="line-num">1334</span>   <span class="ruby-identifier">current_user_curates_taxon</span> = <span class="ruby-keyword">false</span>
<span class="line-num">1335</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_framework</span>
<span class="line-num">1336</span>     <span class="ruby-identifier">current_user_curates_taxon</span> = <span class="ruby-identifier">taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1337</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1338</span>   <span class="ruby-identifier">current_user_curates_taxon</span>
<span class="line-num">1339</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-default_name">
            
              <b>default_name</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-default_name" name="method-i-default_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-default_name_source')" id="l_method-i-default_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-default_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">941</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">default_name</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">942</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">locale</span>
<span class="line-num">943</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">944</span>   <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">choose_default_name</span>( <span class="ruby-identifier">taxon_names</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">945</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-default_photo">
            
              <b>default_photo</b>()
            
            <a href="../classes/Taxon.html#method-i-default_photo" name="method-i-default_photo" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-default_photo_source')" id="l_method-i-default_photo_source">show</a>
                

                

                
              </p>
              <div id="method-i-default_photo_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1873</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">default_photo</span>
<span class="line-num">1874</span>   <span class="ruby-ivar">@default_photo</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">1875</span>     <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tp</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tp</span>.<span class="ruby-identifier">position</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tp</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:photo</span> )
<span class="line-num">1876</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1877</span>     <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">includes</span>( <span class="ruby-value">:photo</span> ).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:photo</span> )
<span class="line-num">1878</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1879</span>   <span class="ruby-ivar">@default_photo</span>
<span class="line-num">1880</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-deleteable_by-3F">
            
              <b>deleteable_by?</b>( user )
            
            <a href="../classes/Taxon.html#method-i-deleteable_by-3F" name="method-i-deleteable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-deleteable_by-3F_source')" id="l_method-i-deleteable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-deleteable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1996</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">deleteable_by?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1997</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1998</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1999</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_changes</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_change_taxa</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">2000</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">children</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">2001</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">2002</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">controlled_term_taxa</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">2003</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ProjectObservationRule</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">operand_type:</span> <span class="ruby-string">&quot;Taxon&quot;</span>, <span class="ruby-value">operand_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">2004</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ObservationFieldValue</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:observation_field</span> ).<span class="ruby-identifier">where</span>(
<span class="line-num">2005</span>     <span class="ruby-string">&quot;observation_fields.datatype = &#39;taxon&#39; AND value = ?&quot;</span>, <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">2006</span>   ).<span class="ruby-identifier">exists?</span>
<span class="line-num">2007</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">subtree_conditions</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">2008</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">TaxonChangeTaxon</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">subtree_conditions</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">2009</span> 
<span class="line-num">2010</span>   <span class="ruby-identifier">creator_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">2011</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-descendant_conditions">
            
              <b>descendant_conditions</b>()
            
            <a href="../classes/Taxon.html#method-i-descendant_conditions" name="method-i-descendant_conditions" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-descendant_conditions_source')" id="l_method-i-descendant_conditions_source">show</a>
                

                

                
              </p>
              <div id="method-i-descendant_conditions_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1646</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">descendant_conditions</span>
<span class="line-num">1647</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">descendant_conditions</span>( <span class="ruby-keyword">self</span> )
<span class="line-num">1648</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-descendant_of-3F">
            
              <b>descendant_of?</b>( taxon )
            
            <a href="../classes/Taxon.html#method-i-descendant_of-3F" name="method-i-descendant_of-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-descendant_of-3F_source')" id="l_method-i-descendant_of-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-descendant_of-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1642</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">descendant_of?</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">1643</span>   <span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1644</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-descendants_count">
            
              <b>descendants_count</b>()
            
            <a href="../classes/Taxon.html#method-i-descendants_count" name="method-i-descendants_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-descendants_count_source')" id="l_method-i-descendants_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-descendants_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">868</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">descendants_count</span>
<span class="line-num">869</span>   <span class="ruby-identifier">subtree</span>.<span class="ruby-identifier">count</span>
<span class="line-num">870</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-detect_clashes">
            
              <b>detect_clashes</b>( narrowed_parents, child_ids )
            
            <a href="../classes/Taxon.html#method-i-detect_clashes" name="method-i-detect_clashes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-detect_clashes_source')" id="l_method-i-detect_clashes_source">show</a>
                

                

                
              </p>
              <div id="method-i-detect_clashes_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2173</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">detect_clashes</span>( <span class="ruby-identifier">narrowed_parents</span>, <span class="ruby-identifier">child_ids</span> )
<span class="line-num">2174</span>   <span class="ruby-identifier">results</span> = []
<span class="line-num">2175</span>   <span class="ruby-identifier">narrowed_parents</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">parent_id</span> <span class="ruby-operator">|</span>
<span class="line-num">2176</span>     <span class="ruby-identifier">result</span> = {
<span class="line-num">2177</span>       <span class="ruby-value">parent_id:</span> <span class="ruby-identifier">parent_id</span>,
<span class="line-num">2178</span>       <span class="ruby-value">id_count:</span> <span class="ruby-value">0</span>,
<span class="line-num">2179</span>       <span class="ruby-value">percent:</span> <span class="ruby-value">100</span>,
<span class="line-num">2180</span>       <span class="ruby-value">num_clashes:</span> <span class="ruby-value">0</span>,
<span class="line-num">2181</span>       <span class="ruby-value">sample:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">2182</span>     }
<span class="line-num">2183</span>     <span class="ruby-identifier">params</span> = { <span class="ruby-value">current:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">exact_taxon_id:</span> <span class="ruby-identifier">parent_id</span> }
<span class="line-num">2184</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>] = <span class="ruby-value">0</span>
<span class="line-num">2185</span>     <span class="ruby-identifier">id_count</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/identifications&quot;</span>, <span class="ruby-identifier">params</span> ).<span class="ruby-identifier">total_results</span>
<span class="line-num">2186</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">id_count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">2187</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">id_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">200</span>
<span class="line-num">2188</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>] = <span class="ruby-value">200</span>
<span class="line-num">2189</span>         <span class="ruby-identifier">id_obs</span> = []
<span class="line-num">2190</span>         <span class="ruby-identifier">ceil</span> = [( <span class="ruby-identifier">id_count</span> <span class="ruby-operator">/</span> <span class="ruby-value">200</span> ), <span class="ruby-value">5</span>].<span class="ruby-identifier">min</span>
<span class="line-num">2191</span>         ( <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">ceil</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span>
<span class="line-num">2192</span>           <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] = <span class="ruby-identifier">p</span>
<span class="line-num">2193</span>           <span class="ruby-identifier">id_obs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/identifications&quot;</span>, <span class="ruby-identifier">params</span> ).<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;observation&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>] }.<span class="ruby-identifier">uniq</span>
<span class="line-num">2194</span>         <span class="ruby-keyword">end</span>
<span class="line-num">2195</span>         <span class="ruby-identifier">id_obs</span> = <span class="ruby-identifier">id_obs</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2196</span>       <span class="ruby-keyword">else</span>
<span class="line-num">2197</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>] = <span class="ruby-identifier">id_count</span>
<span class="line-num">2198</span>         <span class="ruby-identifier">id_obs</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/identifications&quot;</span>, <span class="ruby-identifier">params</span> ).<span class="ruby-identifier">results</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;observation&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>] }.<span class="ruby-identifier">uniq</span>
<span class="line-num">2199</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2200</span>       <span class="ruby-identifier">params</span> = { <span class="ruby-value">id:</span> <span class="ruby-identifier">id_obs</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">499</span>] }
<span class="line-num">2201</span>       <span class="ruby-identifier">obs</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/observations&quot;</span>, <span class="ruby-identifier">params</span> ).<span class="ruby-identifier">results</span>
<span class="line-num">2202</span>       <span class="ruby-identifier">id_taxa</span> = []
<span class="line-num">2203</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span>
<span class="line-num">2204</span>         <span class="ruby-identifier">id_taxa</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;identifications&quot;</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&quot;current&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> }.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num">2205</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2206</span>       <span class="ruby-identifier">id_taxa</span> = <span class="ruby-identifier">id_taxa</span>.<span class="ruby-identifier">flatten</span>
<span class="line-num">2207</span>       <span class="ruby-identifier">id_taxon_array</span> = []
<span class="line-num">2208</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span>
<span class="line-num">2209</span>         <span class="ruby-identifier">id_taxon_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;identifications&quot;</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&quot;current&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> }.
<span class="line-num">2210</span>           <span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span> { <span class="ruby-value">id:</span> <span class="ruby-identifier">i</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>], <span class="ruby-value">ancestor_ids:</span> <span class="ruby-identifier">i</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;ancestor_ids&quot;</span>] } }
<span class="line-num">2211</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2212</span>       <span class="ruby-identifier">id_taxon_array</span> = <span class="ruby-identifier">id_taxon_array</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">2213</span>       <span class="ruby-identifier">id_taxon_hash</span> = <span class="ruby-identifier">id_taxon_array</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> [<span class="ruby-identifier">a</span>[<span class="ruby-value">:id</span>], <span class="ruby-identifier">a</span>[<span class="ruby-value">:ancestor_ids</span>]] }.<span class="ruby-identifier">to_h</span>
<span class="line-num">2214</span>       <span class="ruby-identifier">child_desc_ids</span> = <span class="ruby-identifier">id_taxon_hash</span>.
<span class="line-num">2215</span>         <span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">ancestors</span> <span class="ruby-operator">|</span> ( <span class="ruby-identifier">child_ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">taxon</span> ) <span class="ruby-operator">||</span> ( <span class="ruby-identifier">child_ids</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">ancestors</span> ).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span> }.<span class="ruby-identifier">keys</span>
<span class="line-num">2216</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_desc_ids</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">2217</span>         <span class="ruby-identifier">freq</span> = <span class="ruby-identifier">id_taxa</span>.<span class="ruby-identifier">group_by</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:itself</span> ).<span class="ruby-identifier">transform_values!</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:size</span> ).<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">_k</span>, <span class="ruby-identifier">v</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">v</span> }.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">to_h</span>
<span class="line-num">2218</span>         <span class="ruby-identifier">sampled_ids</span> = <span class="ruby-identifier">freq</span>[<span class="ruby-identifier">parent_id</span>]
<span class="line-num">2219</span>         <span class="ruby-identifier">clash_frac</span> = <span class="ruby-identifier">child_desc_ids</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> ( <span class="ruby-identifier">freq</span>[<span class="ruby-identifier">a</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">freq</span>[<span class="ruby-identifier">a</span>] ) }.<span class="ruby-identifier">sum</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">freq</span>[<span class="ruby-identifier">parent_id</span>].<span class="ruby-identifier">to_f</span>
<span class="line-num">2220</span>         <span class="ruby-identifier">sample</span> = []
<span class="line-num">2221</span>         <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span>
<span class="line-num">2222</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;identifications&quot;</span>].
<span class="line-num">2223</span>             <span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>[<span class="ruby-string">&quot;current&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">child_desc_ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">i</span>[<span class="ruby-string">&quot;taxon&quot;</span>][<span class="ruby-string">&quot;id&quot;</span>] ) }.<span class="ruby-identifier">any?</span>
<span class="line-num">2224</span> 
<span class="line-num">2225</span>           <span class="ruby-identifier">sample</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>
<span class="line-num">2226</span>         <span class="ruby-keyword">end</span>
<span class="line-num">2227</span>         <span class="ruby-identifier">sample</span> = <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;id&quot;</span>] }
<span class="line-num">2228</span>         <span class="ruby-identifier">result</span>[<span class="ruby-value">:num_clashes</span>] = ( <span class="ruby-identifier">id_count</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">clash_frac</span> ).<span class="ruby-identifier">round</span>
<span class="line-num">2229</span>         <span class="ruby-identifier">result</span>[<span class="ruby-value">:sample</span>] = <span class="ruby-identifier">sample</span>
<span class="line-num">2230</span>       <span class="ruby-keyword">else</span>
<span class="line-num">2231</span>         <span class="ruby-identifier">sampled_ids</span> = []
<span class="line-num">2232</span>         <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">|</span>
<span class="line-num">2233</span>           <span class="ruby-identifier">sampled_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>[<span class="ruby-string">&quot;identifications&quot;</span>].<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&quot;current&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">parent_id</span> }.<span class="ruby-identifier">count</span>
<span class="line-num">2234</span>         <span class="ruby-keyword">end</span>
<span class="line-num">2235</span>         <span class="ruby-identifier">sampled_ids</span> = <span class="ruby-identifier">sampled_ids</span>.<span class="ruby-identifier">sum</span>
<span class="line-num">2236</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2237</span>       <span class="ruby-identifier">result</span>[<span class="ruby-value">:id_count</span>] = <span class="ruby-identifier">id_count</span>
<span class="line-num">2238</span>       <span class="ruby-identifier">percent</span> = <span class="ruby-identifier">id_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sampled_ids</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">id_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">200</span> <span class="ruby-operator">?</span> ( <span class="ruby-identifier">sampled_ids</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">id_count</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">*</span> <span class="ruby-value">100</span> ).<span class="ruby-identifier">round</span> <span class="ruby-operator">:</span> <span class="ruby-value">100</span>
<span class="line-num">2239</span>       <span class="ruby-identifier">result</span>[<span class="ruby-value">:percent</span>] = <span class="ruby-identifier">percent</span>
<span class="line-num">2240</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2241</span>     <span class="ruby-identifier">results</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">result</span>
<span class="line-num">2242</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2243</span>   <span class="ruby-identifier">results</span>
<span class="line-num">2244</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-editable_by-3F">
            
              <b>editable_by?</b>( user )
            
            <a href="../classes/Taxon.html#method-i-editable_by-3F" name="method-i-editable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-editable_by-3F_source')" id="l_method-i-editable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-editable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1974</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">editable_by?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1975</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> )
<span class="line-num">1976</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1977</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_curator?</span>
<span class="line-num">1978</span> 
<span class="line-num">1979</span>   <span class="ruby-keyword">false</span>
<span class="line-num">1980</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ensure_parent_ancestry_in_ancestry">
            
              <b>ensure_parent_ancestry_in_ancestry</b>()
            
            <a href="../classes/Taxon.html#method-i-ensure_parent_ancestry_in_ancestry" name="method-i-ensure_parent_ancestry_in_ancestry" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ensure_parent_ancestry_in_ancestry_source')" id="l_method-i-ensure_parent_ancestry_in_ancestry_source">show</a>
                

                

                
              </p>
              <div id="method-i-ensure_parent_ancestry_in_ancestry_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1485</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ensure_parent_ancestry_in_ancestry</span>
<span class="line-num">1486</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>&amp;.<span class="ruby-identifier">ancestry</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestry</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">index</span>( <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">ancestry</span> ) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
<span class="line-num">1487</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ancestry</span> = [<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/ &quot;</span> ), <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;/&quot;</span> )
<span class="line-num">1488</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1489</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1490</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-establishment_means_in_place-3F">
            
              <b>establishment_means_in_place?</b>( means, place, options = {} )
            
            <a href="../classes/Taxon.html#method-i-establishment_means_in_place-3F" name="method-i-establishment_means_in_place-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-establishment_means_in_place-3F_source')" id="l_method-i-establishment_means_in_place-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-establishment_means_in_place-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1675</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">establishment_means_in_place?</span>( <span class="ruby-identifier">means</span>, <span class="ruby-identifier">place</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1676</span>   <span class="ruby-identifier">means</span> = [<span class="ruby-identifier">means</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">means</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Array</span> )
<span class="line-num">1677</span>   <span class="ruby-identifier">places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">param_to_array</span>( <span class="ruby-identifier">place</span> )
<span class="line-num">1678</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">places</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1679</span> 
<span class="line-num">1680</span>   <span class="ruby-identifier">lt</span> = <span class="ruby-identifier">listed_taxa_with_establishment_means</span>
<span class="line-num">1681</span>   <span class="ruby-identifier">place_ancestor_ids</span> = ( <span class="ruby-identifier">places</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) <span class="ruby-operator">+</span>
<span class="line-num">1682</span>     <span class="ruby-identifier">places</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> ) } ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1683</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:closest</span>]
<span class="line-num">1684</span>     <span class="ruby-identifier">most_specific_lt</span> = <span class="ruby-identifier">lt</span>.
<span class="line-num">1685</span>       <span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">establishment_means</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">l</span>.<span class="ruby-identifier">place_id</span> ) }.
<span class="line-num">1686</span>       <span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">bbox_area</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> }.<span class="ruby-identifier">first</span>
<span class="line-num">1687</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">most_specific_lt</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1688</span> 
<span class="line-num">1689</span>     <span class="ruby-identifier">means</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">most_specific_lt</span>.<span class="ruby-identifier">establishment_means</span> )
<span class="line-num">1690</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1691</span>     <span class="ruby-operator">!</span><span class="ruby-identifier">lt</span>.
<span class="line-num">1692</span>       <span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">establishment_means</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">place_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">l</span>.<span class="ruby-identifier">place_id</span> ) }.
<span class="line-num">1693</span>       <span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">means</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">l</span>.<span class="ruby-identifier">establishment_means</span> ) }.<span class="ruby-identifier">nil?</span>
<span class="line-num">1694</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1695</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flagged_with">
            
              <b>flagged_with</b>( _flag, _options = {} )
            
            <a href="../classes/Taxon.html#method-i-flagged_with" name="method-i-flagged_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flagged_with_source')" id="l_method-i-flagged_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-flagged_with_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2156</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flagged_with</span>( <span class="ruby-identifier">_flag</span>, <span class="ruby-identifier">_options</span> = {} )
<span class="line-num">2157</span>   <span class="ruby-identifier">elastic_index!</span>
<span class="line-num">2158</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-geoprivacy">
            
              <b>geoprivacy</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-geoprivacy" name="method-i-geoprivacy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-geoprivacy_source')" id="l_method-i-geoprivacy_source">show</a>
                

                

                
              </p>
              <div id="method-i-geoprivacy_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1834</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">geoprivacy</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1835</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">max_geoprivacy</span>( [<span class="ruby-identifier">id</span>], <span class="ruby-identifier">options</span> )
<span class="line-num">1836</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_complete_taxon_framework_for_internode_or_root">
            
              <b>get_complete_taxon_framework_for_internode_or_root</b>()
            
            <a href="../classes/Taxon.html#method-i-get_complete_taxon_framework_for_internode_or_root" name="method-i-get_complete_taxon_framework_for_internode_or_root" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_complete_taxon_framework_for_internode_or_root_source')" id="l_method-i-get_complete_taxon_framework_for_internode_or_root_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_complete_taxon_framework_for_internode_or_root_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1286</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_complete_taxon_framework_for_internode_or_root</span>
<span class="line-num">1287</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_framework</span>&amp;.<span class="ruby-identifier">covers?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_framework</span>&amp;.<span class="ruby-identifier">complete</span>
<span class="line-num">1288</span>     <span class="ruby-identifier">upstream_taxon_framework_including_root</span> = <span class="ruby-identifier">taxon_framework</span>
<span class="line-num">1289</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1290</span>     <span class="ruby-identifier">upstream_taxon_framework_including_root</span> = <span class="ruby-identifier">upstream_taxon_framework</span>
<span class="line-num">1291</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">upstream_taxon_framework_including_root</span>&amp;.<span class="ruby-identifier">complete</span>
<span class="line-num">1292</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">upstream_taxon_framework_including_root</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">rank_level</span>
<span class="line-num">1293</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1294</span>   <span class="ruby-identifier">upstream_taxon_framework_including_root</span>
<span class="line-num">1295</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_gbif_id">
            
              <b>get_gbif_id</b>()
            
            <a href="../classes/Taxon.html#method-i-get_gbif_id" name="method-i-get_gbif_id" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_gbif_id_source')" id="l_method-i-get_gbif_id_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_gbif_id_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2037</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_gbif_id</span>
<span class="line-num">2038</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_scheme_taxa</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">tst</span> = <span class="ruby-identifier">taxon_scheme_taxa</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">taxon_scheme</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;GBIF&quot;</span> } )
<span class="line-num">2039</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">tst</span>.<span class="ruby-identifier">source_identifier</span>
<span class="line-num">2040</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2041</span> 
<span class="line-num">2042</span>   <span class="ruby-comment"># make sure the GBIF TaxonScheme exists</span>
<span class="line-num">2043</span>   <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">gbif</span> = <span class="ruby-constant">TaxonScheme</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">title:</span> <span class="ruby-string">&quot;GBIF&quot;</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">2044</span>     <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">gbif_source</span> = <span class="ruby-constant">Source</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">url:</span> <span class="ruby-string">&quot;http://www.gbif.org&quot;</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">2045</span>       <span class="ruby-identifier">gbif_source</span> = <span class="ruby-constant">Source</span>.<span class="ruby-identifier">create!</span>(
<span class="line-num">2046</span>         <span class="ruby-value">title:</span> <span class="ruby-string">&quot;Global Biodiversity Information Facility&quot;</span>,
<span class="line-num">2047</span>         <span class="ruby-value">in_text:</span> <span class="ruby-string">&quot;GBIF&quot;</span>,
<span class="line-num">2048</span>         <span class="ruby-value">url:</span> <span class="ruby-string">&quot;http://www.gbif.org&quot;</span>
<span class="line-num">2049</span>       )
<span class="line-num">2050</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2051</span>     <span class="ruby-identifier">gbif</span> = <span class="ruby-constant">TaxonScheme</span>.<span class="ruby-identifier">create!</span>( <span class="ruby-value">title:</span> <span class="ruby-string">&quot;GBIF&quot;</span>, <span class="ruby-value">source:</span> <span class="ruby-identifier">gbif_source</span> )
<span class="line-num">2052</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2053</span>   <span class="ruby-comment"># return their ID if we know it</span>
<span class="line-num">2054</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scheme</span> = <span class="ruby-constant">TaxonSchemeTaxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_scheme:</span> <span class="ruby-identifier">gbif</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">2055</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">source_identifier</span>
<span class="line-num">2056</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2057</span> 
<span class="line-num">2058</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span> }
<span class="line-num">2059</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">ancestor</span> = <span class="ruby-identifier">preferred_uninomial_ancestor</span> )
<span class="line-num">2060</span>     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">rank</span>] = <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">name</span>
<span class="line-num">2061</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2062</span>   <span class="ruby-identifier">json</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">2063</span>     <span class="ruby-constant">GbifService</span>.<span class="ruby-identifier">species_match</span>( <span class="ruby-value">params:</span> <span class="ruby-identifier">params</span> )
<span class="line-num">2064</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">SocketError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">2065</span>     <span class="ruby-comment"># probably GBIF is down or throttling us</span>
<span class="line-num">2066</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] #{e}&quot;</span>
<span class="line-num">2067</span>     <span class="ruby-keyword">nil</span>
<span class="line-num">2068</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2069</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">json</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">json</span>[<span class="ruby-string">&quot;canonicalName&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>
<span class="line-num">2070</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">json</span>[<span class="ruby-string">&quot;usageKey&quot;</span>]
<span class="line-num">2071</span>       <span class="ruby-keyword">begin</span>
<span class="line-num">2072</span>         <span class="ruby-constant">TaxonSchemeTaxon</span>.<span class="ruby-identifier">create!</span>( <span class="ruby-value">taxon_scheme:</span> <span class="ruby-identifier">gbif</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">source_identifier:</span> <span class="ruby-identifier">json</span>[<span class="ruby-string">&quot;usageKey&quot;</span>] )
<span class="line-num">2073</span>       <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordInvalid</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">2074</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Failed to add GBIF taxon #{name}, ID:#{json[&#39;usageKey&#39;]}: #{e}&quot;</span>
<span class="line-num">2075</span>       <span class="ruby-keyword">end</span>
<span class="line-num">2076</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">json</span>[<span class="ruby-string">&quot;usageKey&quot;</span>]
<span class="line-num">2077</span>     <span class="ruby-keyword">else</span>
<span class="line-num">2078</span>       <span class="ruby-constant">TaxonSchemeTaxon</span>.<span class="ruby-identifier">create</span>( <span class="ruby-value">taxon_scheme:</span> <span class="ruby-identifier">gbif</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">source_identifier:</span> <span class="ruby-keyword">nil</span> )
<span class="line-num">2079</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2080</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2081</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">2082</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_upstream_taxon_framework">
            
              <b>get_upstream_taxon_framework</b>( supplied_ancestor_ids = ancestor_ids )
            
            <a href="../classes/Taxon.html#method-i-get_upstream_taxon_framework" name="method-i-get_upstream_taxon_framework" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_upstream_taxon_framework_source')" id="l_method-i-get_upstream_taxon_framework_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_upstream_taxon_framework_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1170</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_upstream_taxon_framework</span>( <span class="ruby-identifier">supplied_ancestor_ids</span> = <span class="ruby-identifier">ancestor_ids</span> )
<span class="line-num">1171</span>   <span class="ruby-identifier">candidate</span> = <span class="ruby-constant">TaxonFramework</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN taxa t ON t.id = taxon_frameworks.taxon_id&quot;</span> ).
<span class="line-num">1172</span>     <span class="ruby-identifier">where</span>(
<span class="line-num">1173</span>       <span class="ruby-string">&quot;taxon_id IN (?) AND taxon_frameworks.rank_level IS NOT NULL AND taxon_frameworks.rank_level &lt;= ?&quot;</span>,
<span class="line-num">1174</span>       <span class="ruby-identifier">supplied_ancestor_ids</span>, <span class="ruby-identifier">rank_level</span>
<span class="line-num">1175</span>     ).
<span class="line-num">1176</span>     <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;t.rank_level ASC&quot;</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1177</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">candidate</span>
<span class="line-num">1178</span> 
<span class="line-num">1179</span>   <span class="ruby-identifier">blocker</span> = <span class="ruby-constant">TaxonFramework</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN taxa t ON t.id = taxon_frameworks.taxon_id&quot;</span> ).
<span class="line-num">1180</span>     <span class="ruby-identifier">where</span>(
<span class="line-num">1181</span>       <span class="ruby-string">&quot;taxon_id IN (?) AND taxon_frameworks.rank_level IS NOT NULL AND t.rank_level &lt; ?&quot;</span>,
<span class="line-num">1182</span>       <span class="ruby-identifier">supplied_ancestor_ids</span>, <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank_level</span>
<span class="line-num">1183</span>     ).<span class="ruby-identifier">first</span>
<span class="line-num">1184</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">candidate</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">blocker</span>
<span class="line-num">1185</span> 
<span class="line-num">1186</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">1187</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-global_conservation_status">
            
              <b>global_conservation_status</b>()
            
            <a href="../classes/Taxon.html#method-i-global_conservation_status" name="method-i-global_conservation_status" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-global_conservation_status_source')" id="l_method-i-global_conservation_status_source">show</a>
                

                

                
              </p>
              <div id="method-i-global_conservation_status_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1650</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">global_conservation_status</span>
<span class="line-num">1651</span>   <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> }.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> }.<span class="ruby-identifier">last</span>
<span class="line-num">1652</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-globally_threatened-3F">
            
              <b>globally_threatened?</b>()
            
            <a href="../classes/Taxon.html#method-i-globally_threatened-3F" name="method-i-globally_threatened-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-globally_threatened-3F_source')" id="l_method-i-globally_threatened-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-globally_threatened-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1697</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">globally_threatened?</span>
<span class="line-num">1698</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">association</span>( <span class="ruby-value">:conservation_statuses</span> ).<span class="ruby-identifier">loaded?</span>
<span class="line-num">1699</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-constant">IUCN_NEAR_THREATENED</span> }
<span class="line-num">1700</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1701</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;place_id IS NULL AND iucn &gt;= ?&quot;</span>, <span class="ruby-constant">IUCN_NEAR_THREATENED</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1702</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1703</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graft">
            
              <b>graft</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-graft" name="method-i-graft" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graft_source')" id="l_method-i-graft_source">show</a>
                

                

                
              </p>
              <div id="method-i-graft_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">895</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graft</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">896</span>   <span class="ruby-identifier">ratatosk</span>.<span class="ruby-identifier">graft</span>( <span class="ruby-keyword">self</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">897</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">NameProviderError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">898</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">species_or_lower?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">899</span>     <span class="ruby-identifier">parent_name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot; &quot;</span> )
<span class="line-num">900</span>     <span class="ruby-identifier">parent</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>( <span class="ruby-identifier">parent_name</span> )
<span class="line-num">901</span>     <span class="ruby-identifier">parent</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">import</span>( <span class="ruby-identifier">parent_name</span>, <span class="ruby-value">exact:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">902</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>&amp;.<span class="ruby-identifier">can_be_grafted_to</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">parent</span>&amp;.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> [
<span class="line-num">903</span>       <span class="ruby-constant">GENUS</span>, <span class="ruby-constant">SPECIES</span>
<span class="line-num">904</span>     ].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">rank</span> )
<span class="line-num">905</span>       <span class="ruby-identifier">update</span>( <span class="ruby-value">parent:</span> <span class="ruby-identifier">parent</span> )
<span class="line-num">906</span>     <span class="ruby-keyword">end</span>
<span class="line-num">907</span>   <span class="ruby-keyword">end</span>
<span class="line-num">908</span>   <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">grafted?</span>
<span class="line-num">909</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graft_silently">
            
              <b>graft_silently</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-graft_silently" name="method-i-graft_silently" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graft_silently_source')" id="l_method-i-graft_silently_source">show</a>
                

                

                
              </p>
              <div id="method-i-graft_silently_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">911</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graft_silently</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">912</span>   <span class="ruby-identifier">graft</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">913</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">NameProviderError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">914</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Failed to graft #{self}: #{e}&quot;</span>
<span class="line-num">915</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graftable_destination_relative_to_taxon_framework_coverage">
            
              <b>graftable_destination_relative_to_taxon_framework_coverage</b>()
            
            <a href="../classes/Taxon.html#method-i-graftable_destination_relative_to_taxon_framework_coverage" name="method-i-graftable_destination_relative_to_taxon_framework_coverage" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graftable_destination_relative_to_taxon_framework_coverage_source')" id="l_method-i-graftable_destination_relative_to_taxon_framework_coverage_source">show</a>
                

                

                
              </p>
              <div id="method-i-graftable_destination_relative_to_taxon_framework_coverage_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1199</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graftable_destination_relative_to_taxon_framework_coverage</span>
<span class="line-num">1200</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ancestry_changed?</span>
<span class="line-num">1201</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_active</span>
<span class="line-num">1202</span> 
<span class="line-num">1203</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">destination_taxon_framework</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">taxon_framework</span> )
<span class="line-num">1204</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">skip_taxon_framework_checks</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1205</span>         <span class="ruby-identifier">destination_taxon_framework</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1206</span>         <span class="ruby-identifier">destination_taxon_framework</span>.<span class="ruby-identifier">covers?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1207</span>         <span class="ruby-identifier">destination_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1208</span>         (
<span class="line-num">1209</span>           <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span>
<span class="line-num">1210</span>           (
<span class="line-num">1211</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1212</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">destination_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1213</span>           )
<span class="line-num">1214</span>         )
<span class="line-num">1215</span>       <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:ancestry</span>,
<span class="line-num">1216</span>         <span class="ruby-node">&quot;destination #{destination_taxon_framework.taxon} has a curated &quot;</span> \
<span class="line-num">1217</span>           <span class="ruby-string">&quot;taxon framework attached to it. Contact the curators of that taxon &quot;</span> \
<span class="line-num">1218</span>           <span class="ruby-string">&quot;to request changes.&quot;</span> )
<span class="line-num">1219</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1220</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">destination_upstream_taxon_framework</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">get_upstream_taxon_framework</span> )
<span class="line-num">1221</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">skip_taxon_framework_checks</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1222</span>         <span class="ruby-identifier">destination_upstream_taxon_framework</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1223</span>         <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">destination_upstream_taxon_framework</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1224</span>         <span class="ruby-identifier">destination_upstream_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1225</span>         (
<span class="line-num">1226</span>           <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (
<span class="line-num">1227</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1228</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">destination_upstream_taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1229</span>           )
<span class="line-num">1230</span>         )
<span class="line-num">1231</span>       <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:ancestry</span>,
<span class="line-num">1232</span>         <span class="ruby-node">&quot;destination #{destination_upstream_taxon_framework.taxon} covered &quot;</span> \
<span class="line-num">1233</span>           <span class="ruby-string">&quot;by a curated taxon framework. Contact the curators of that &quot;</span> \
<span class="line-num">1234</span>           <span class="ruby-string">&quot;taxon to request changes.&quot;</span> )
<span class="line-num">1235</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1236</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1237</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1238</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graftable_relative_to_taxon_framework_coverage">
            
              <b>graftable_relative_to_taxon_framework_coverage</b>()
            
            <a href="../classes/Taxon.html#method-i-graftable_relative_to_taxon_framework_coverage" name="method-i-graftable_relative_to_taxon_framework_coverage" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graftable_relative_to_taxon_framework_coverage_source')" id="l_method-i-graftable_relative_to_taxon_framework_coverage_source">show</a>
                

                

                
              </p>
              <div id="method-i-graftable_relative_to_taxon_framework_coverage_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1297</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graftable_relative_to_taxon_framework_coverage</span>
<span class="line-num">1298</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ancestry_changed?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ancestry_was</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1299</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_taxon_framework_checks</span>
<span class="line-num">1300</span> 
<span class="line-num">1301</span>   <span class="ruby-identifier">upstream_taxon_framework</span> = <span class="ruby-identifier">get_upstream_taxon_framework</span>( <span class="ruby-identifier">ancestry_was</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> ) )
<span class="line-num">1302</span>   <span class="ruby-identifier">upstream_taxon_framework_curated_by_current_user</span> =
<span class="line-num">1303</span>     <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1304</span>     <span class="ruby-operator">!</span><span class="ruby-identifier">upstream_taxon_framework</span>&amp;.<span class="ruby-identifier">taxon_curators</span>&amp;.<span class="ruby-identifier">where</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> )&amp;.<span class="ruby-identifier">exists?</span>
<span class="line-num">1305</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">upstream_taxon_framework</span>&amp;.<span class="ruby-identifier">taxon_curators</span>&amp;.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1306</span>       ( <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">upstream_taxon_framework_curated_by_current_user</span> )
<span class="line-num">1307</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:ancestry</span>,
<span class="line-num">1308</span>       <span class="ruby-node">&quot;covered by a curated taxon framework attached to #{upstream_taxon_framework.taxon}. &quot;</span> \
<span class="line-num">1309</span>         <span class="ruby-string">&quot;Contact the curators of that taxon to request changes.&quot;</span> )
<span class="line-num">1310</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1311</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1312</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-grafted-3F">
            
              <b>grafted?</b>()
            
            <a href="../classes/Taxon.html#method-i-grafted-3F" name="method-i-grafted-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-grafted-3F_source')" id="l_method-i-grafted-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-grafted-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">917</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">grafted?</span>
<span class="line-num">918</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span> <span class="ruby-comment"># New records haven&#39;t been grafted</span>
<span class="line-num">919</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Life&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">920</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">kingdom?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">parent_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span>.<span class="ruby-identifier">id</span>
<span class="line-num">921</span> 
<span class="line-num">922</span>   <span class="ruby-keyword">true</span>
<span class="line-num">923</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-handle_after_activate">
            
              <b>handle_after_activate</b>()
            
            <a href="../classes/Taxon.html#method-i-handle_after_activate" name="method-i-handle_after_activate" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-handle_after_activate_source')" id="l_method-i-handle_after_activate_source">show</a>
                

                

                
              </p>
              <div id="method-i-handle_after_activate_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">613</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">handle_after_activate</span>
<span class="line-num">614</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">saved_change_to_is_active?</span>
<span class="line-num">615</span> 
<span class="line-num">616</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">617</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Observation::update_stats_for_observations_of&quot;:</span> <span class="ruby-identifier">id</span> } ).
<span class="line-num">618</span>     <span class="ruby-identifier">update_stats_for_observations_of</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">619</span>   <span class="ruby-keyword">true</span>
<span class="line-num">620</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-handle_after_move">
            
              <b>handle_after_move</b>()
            
            <a href="../classes/Taxon.html#method-i-handle_after_move" name="method-i-handle_after_move" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-handle_after_move_source')" id="l_method-i-handle_after_move_source">show</a>
                

                

                
              </p>
              <div id="method-i-handle_after_move_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">578</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">handle_after_move</span>
<span class="line-num">579</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">saved_change_to_ancestry?</span>
<span class="line-num">580</span> 
<span class="line-num">581</span>   <span class="ruby-identifier">set_iconic_taxon</span>
<span class="line-num">582</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_after_move</span>
<span class="line-num">583</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_change_to_id?</span>
<span class="line-num">584</span> 
<span class="line-num">585</span>   <span class="ruby-identifier">update_obs_iconic_taxa</span>
<span class="line-num">586</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">587</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Observation::update_stats_for_observations_of&quot;:</span> <span class="ruby-identifier">id</span> } ).
<span class="line-num">588</span>     <span class="ruby-identifier">update_stats_for_observations_of</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">589</span>   <span class="ruby-identifier">elastic_index!</span>
<span class="line-num">590</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">refresh_es_index</span>
<span class="line-num">591</span>   <span class="ruby-comment"># This will create a long-running job for higher level, but we need to reset</span>
<span class="line-num">592</span>   <span class="ruby-comment"># the ancestry field on descendants when the taxon moves</span>
<span class="line-num">593</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">594</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">595</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">596</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Taxon::reindex_descendants_of&quot;:</span> <span class="ruby-identifier">id</span> }
<span class="line-num">597</span>   ).<span class="ruby-identifier">reindex_descendants_of</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">598</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>, <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">599</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Identification::update_disagreement_identifications_for_taxon&quot;:</span> <span class="ruby-identifier">id</span> } ).
<span class="line-num">600</span>     <span class="ruby-identifier">update_disagreement_identifications_for_taxon</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">601</span>   <span class="ruby-constant">Annotation</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">602</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">603</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;slow&quot;</span>,
<span class="line-num">604</span>     <span class="ruby-value">run_at:</span> <span class="ruby-value">3</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">from_now</span>,
<span class="line-num">605</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Annotation::reassess_annotations_for_taxon_ids&quot;:</span> [<span class="ruby-identifier">id</span>] }
<span class="line-num">606</span>   ).<span class="ruby-identifier">reassess_annotations_for_taxon_ids</span>( [<span class="ruby-identifier">id</span>] )
<span class="line-num">607</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_framework_relationship_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">608</span>     <span class="ruby-identifier">reasess_taxon_framework_relationship_after_move</span>
<span class="line-num">609</span>   <span class="ruby-keyword">end</span>
<span class="line-num">610</span>   <span class="ruby-keyword">true</span>
<span class="line-num">611</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-has_ancestor_taxon_id">
            
              <b>has_ancestor_taxon_id</b>( ancestor_id )
            
            <a href="../classes/Taxon.html#method-i-has_ancestor_taxon_id" name="method-i-has_ancestor_taxon_id" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>rubocop:disable Naming/PredicateName FWIW, we <strong>should</strong> rename this, but I&#39;m trying to reduce the impact of this compliace change to just this file and its spec</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-has_ancestor_taxon_id_source')" id="l_method-i-has_ancestor_taxon_id_source">show</a>
                

                

                
              </p>
              <div id="method-i-has_ancestor_taxon_id_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2087</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">has_ancestor_taxon_id</span>( <span class="ruby-identifier">ancestor_id</span> )
<span class="line-num">2088</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ancestor_id</span>
<span class="line-num">2089</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">2090</span> 
<span class="line-num">2091</span>   <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">%r{(^|/)#{ancestor_id}(/|$)}</span> )
<span class="line-num">2092</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-iconic_taxon_name">
            
              <b>iconic_taxon_name</b>()
            
            <a href="../classes/Taxon.html#method-i-iconic_taxon_name" name="method-i-iconic_taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-iconic_taxon_name_source')" id="l_method-i-iconic_taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-iconic_taxon_name_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1850</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">iconic_taxon_name</span>
<span class="line-num">1851</span>   <span class="ruby-constant">ICONIC_TAXA_BY_ID</span>[<span class="ruby-identifier">iconic_taxon_id</span>].<span class="ruby-identifier">try</span>( <span class="ruby-value">:name</span> )
<span class="line-num">1852</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-image_url">
            
              <b>image_url</b>()
            
            <a href="../classes/Taxon.html#method-i-image_url" name="method-i-image_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-image_url_source')" id="l_method-i-image_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-image_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1924</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">image_url</span>
<span class="line-num">1925</span>   <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">taxon_image_url</span>( <span class="ruby-keyword">self</span> )
<span class="line-num">1926</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-in_taxon-3F">
            
              <b>in_taxon?</b>( taxon )
            
            <a href="../classes/Taxon.html#method-i-in_taxon-3F" name="method-i-in_taxon-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Test whether this taxon is in another taxon (e.g. Anna&#39;s Humminbird is in Class Aves)</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-in_taxon-3F_source')" id="l_method-i-in_taxon-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-in_taxon-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">889</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">in_taxon?</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">890</span>   <span class="ruby-comment"># self.lft &gt; taxon.lft &amp;&amp; self.rgt &lt; taxon.rgt</span>
<span class="line-num">891</span>   <span class="ruby-identifier">target_id</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">892</span>   <span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">target_id</span> )
<span class="line-num">893</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index_observations">
            
              <b>index_observations</b>()
            
            <a href="../classes/Taxon.html#method-i-index_observations" name="method-i-index_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_observations_source')" id="l_method-i-index_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">691</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index_observations</span>
<span class="line-num">692</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation_indexing</span>
<span class="line-num">693</span>   <span class="ruby-comment"># changing some fields doesn&#39;t require reindexing observations</span>
<span class="line-num">694</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">saved_changes</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">-</span> [
<span class="line-num">695</span>     <span class="ruby-string">&quot;photos_locked&quot;</span>,
<span class="line-num">696</span>     <span class="ruby-string">&quot;taxon_framework_relationship_id&quot;</span>,
<span class="line-num">697</span>     <span class="ruby-string">&quot;updater_id&quot;</span>,
<span class="line-num">698</span>     <span class="ruby-string">&quot;updated_at&quot;</span>
<span class="line-num">699</span>   ] ).<span class="ruby-identifier">empty?</span>
<span class="line-num">700</span> 
<span class="line-num">701</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_changes</span>[<span class="ruby-value">:ancestry</span>]
<span class="line-num">702</span>     <span class="ruby-comment"># using Taxon.find since the ancestry gem uses the before save</span>
<span class="line-num">703</span>     <span class="ruby-comment"># ancestry and descendants&#39; ancestries have already been updated</span>
<span class="line-num">704</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">of</span>( <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">id</span> ) ), <span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">705</span>   <span class="ruby-keyword">else</span>
<span class="line-num">706</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">scope:</span> <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">select</span>( <span class="ruby-value">:id</span> ), <span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">707</span>   <span class="ruby-keyword">end</span>
<span class="line-num">708</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-infraspecies-3F">
            
              <b>infraspecies?</b>()
            
            <a href="../classes/Taxon.html#method-i-infraspecies-3F" name="method-i-infraspecies-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-infraspecies-3F_source')" id="l_method-i-infraspecies-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-infraspecies-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1387</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">infraspecies?</span>
<span class="line-num">1388</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1389</span> 
<span class="line-num">1390</span>   <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">1391</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-leading_name">
            
              <b>leading_name</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-leading_name" name="method-i-leading_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-leading_name_source')" id="l_method-i-leading_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-leading_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">856</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">leading_name</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">857</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">c</span> = <span class="ruby-identifier">common_name</span>( <span class="ruby-identifier">options</span> ) )
<span class="line-num">858</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span>
<span class="line-num">859</span>   <span class="ruby-keyword">end</span>
<span class="line-num">860</span> 
<span class="line-num">861</span>   <span class="ruby-identifier">name</span>
<span class="line-num">862</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-match_descendants">
            
              <b>match_descendants</b>( taxon_hash )
            
            <a href="../classes/Taxon.html#method-i-match_descendants" name="method-i-match_descendants" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-match_descendants_source')" id="l_method-i-match_descendants_source">show</a>
                

                

                
              </p>
              <div id="method-i-match_descendants_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2013</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">match_descendants</span>( <span class="ruby-identifier">taxon_hash</span> )
<span class="line-num">2014</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">match_descendants_of_id</span>( <span class="ruby-identifier">id</span>, <span class="ruby-identifier">taxon_hash</span> )
<span class="line-num">2015</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-merge">
            
              <b>merge</b>( reject )
            
            <a href="../classes/Taxon.html#method-i-merge" name="method-i-merge" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-merge_source')" id="l_method-i-merge_source">show</a>
                

                

                
              </p>
              <div id="method-i-merge_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1533</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">merge</span>( <span class="ruby-identifier">reject</span> )
<span class="line-num">1534</span>   <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Can&#39;t merge a taxon with itself&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span>
<span class="line-num">1535</span> 
<span class="line-num">1536</span>   <span class="ruby-identifier">reject_taxon_names</span> = <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">1537</span>   <span class="ruby-identifier">reject_taxon_scheme_taxa</span> = <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">taxon_scheme_taxa</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">1538</span>   <span class="ruby-comment"># otherwise it will screw up merge_has_many_associations</span>
<span class="line-num">1539</span>   <span class="ruby-identifier">merge_has_many_associations</span>( <span class="ruby-identifier">reject</span> )
<span class="line-num">1540</span> 
<span class="line-num">1541</span>   <span class="ruby-comment"># Merge ListRules and other polymorphic assocs</span>
<span class="line-num">1542</span>   <span class="ruby-constant">ListRule</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">operand_id:</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">operand_type:</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">to_s</span> ).
<span class="line-num">1543</span>     <span class="ruby-identifier">update_all</span>( <span class="ruby-value">operand_id:</span> <span class="ruby-identifier">id</span> )
<span class="line-num">1544</span> 
<span class="line-num">1545</span>   <span class="ruby-comment"># Keep reject colors if keeper has none</span>
<span class="line-num">1546</span>   <span class="ruby-identifier">colors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">colors</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">colors</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1547</span> 
<span class="line-num">1548</span>   <span class="ruby-comment"># Move reject child taxa to the keeper</span>
<span class="line-num">1549</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">child</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">child</span>.<span class="ruby-identifier">move_to_child_of</span>( <span class="ruby-keyword">self</span> ) }
<span class="line-num">1550</span> 
<span class="line-num">1551</span>   <span class="ruby-comment"># Update or destroy merged taxon scheme taxa</span>
<span class="line-num">1552</span>   <span class="ruby-identifier">reject_taxon_scheme_taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">reject_tst</span> <span class="ruby-operator">|</span>
<span class="line-num">1553</span>     <span class="ruby-identifier">reject_tst</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1554</span>     <span class="ruby-identifier">reject_tst_name</span> = <span class="ruby-identifier">reject_tst</span>.<span class="ruby-identifier">taxon_name</span>
<span class="line-num">1555</span>     <span class="ruby-identifier">taxon_name</span> = <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">lexicon:</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">SCIENTIFIC_NAMES</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">reject_tst_name</span>.<span class="ruby-identifier">name</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1556</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_name</span>
<span class="line-num">1557</span>       <span class="ruby-identifier">reject_tst</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">taxon_name_id:</span> <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1558</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1559</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject_tst</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">1560</span> 
<span class="line-num">1561</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO] Destroying #{reject_tst} while merging taxon &quot;</span> \
<span class="line-num">1562</span>       <span class="ruby-node">&quot;#{reject.id} into taxon #{id}: #{reject_tst.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">1563</span>     <span class="ruby-identifier">reject_tst</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1564</span>     <span class="ruby-keyword">next</span>
<span class="line-num">1565</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1566</span> 
<span class="line-num">1567</span>   <span class="ruby-comment"># Update or destroy merged taxon_names</span>
<span class="line-num">1568</span>   <span class="ruby-identifier">reject_taxon_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_name</span> <span class="ruby-operator">|</span>
<span class="line-num">1569</span>     <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1570</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">is_scientific_names?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">is_valid?</span>
<span class="line-num">1571</span>       <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">is_valid:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">1572</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1573</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">1574</span> 
<span class="line-num">1575</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO] Destroying #{taxon_name} while merging taxon &quot;</span> \
<span class="line-num">1576</span>       <span class="ruby-node">&quot;#{reject.id} into taxon #{id}: #{taxon_name.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">1577</span>     <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1578</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1579</span> 
<span class="line-num">1580</span>   <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1581</span>   <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">flag</span> <span class="ruby-operator">|</span>
<span class="line-num">1582</span>     <span class="ruby-identifier">flag</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">flag</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">1583</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1584</span> 
<span class="line-num">1585</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">set_iconic_taxon_for_observations_of</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">1586</span> 
<span class="line-num">1587</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1588</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;[INFO] Merged #{reject} into #{self}&quot;</span>
<span class="line-num">1589</span>   <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">persisted?</span> <span class="ruby-comment"># not sure why it wouldn&#39;t be...</span>
<span class="line-num">1590</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mergeable_by-3F">
            
              <b>mergeable_by?</b>( user, reject )
            
            <a href="../classes/Taxon.html#method-i-mergeable_by-3F" name="method-i-mergeable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mergeable_by-3F_source')" id="l_method-i-mergeable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-mergeable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1982</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mergeable_by?</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">reject</span> )
<span class="line-num">1983</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1984</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">name</span>
<span class="line-num">1985</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">creator_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">creator_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1986</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1987</span>       <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1988</span>       <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1989</span>       <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">taxon_scheme_taxa</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span>
<span class="line-num">1990</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">1991</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1992</span> 
<span class="line-num">1993</span>   <span class="ruby-keyword">false</span>
<span class="line-num">1994</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-move_to_child_of">
            
              <b>move_to_child_of</b>( taxon )
            
            <a href="../classes/Taxon.html#method-i-move_to_child_of" name="method-i-move_to_child_of" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-move_to_child_of_source')" id="l_method-i-move_to_child_of_source">show</a>
                

                

                
              </p>
              <div id="method-i-move_to_child_of_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">937</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">move_to_child_of</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">938</span>   <span class="ruby-identifier">update</span>( <span class="ruby-value">parent:</span> <span class="ruby-identifier">taxon</span> )
<span class="line-num">939</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-name_with_rank">
            
              <b>name_with_rank</b>()
            
            <a href="../classes/Taxon.html#method-i-name_with_rank" name="method-i-name_with_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-name_with_rank_source')" id="l_method-i-name_with_rank_source">show</a>
                

                

                
              </p>
              <div id="method-i-name_with_rank_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">965</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">name_with_rank</span>
<span class="line-num">966</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">967</span>     <span class="ruby-identifier">r</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">rank</span>
<span class="line-num">968</span>     <span class="ruby-keyword">when</span> <span class="ruby-constant">SUBSPECIES</span> <span class="ruby-keyword">then</span> <span class="ruby-string">&quot;ssp.&quot;</span>
<span class="line-num">969</span>     <span class="ruby-keyword">when</span> <span class="ruby-constant">VARIETY</span> <span class="ruby-keyword">then</span> <span class="ruby-string">&quot;var.&quot;</span>
<span class="line-num">970</span>     <span class="ruby-keyword">when</span> <span class="ruby-constant">FORM</span> <span class="ruby-keyword">then</span> <span class="ruby-string">&quot;f.&quot;</span>
<span class="line-num">971</span>     <span class="ruby-keyword">else</span> <span class="ruby-identifier">rank</span>
<span class="line-num">972</span>     <span class="ruby-keyword">end</span>
<span class="line-num">973</span>     <span class="ruby-identifier">pieces</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>
<span class="line-num">974</span>     <span class="ruby-node">&quot;#{pieces[0..-2].join( &#39; &#39; )} #{r} #{pieces.last}&quot;</span>
<span class="line-num">975</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">species?</span>
<span class="line-num">976</span>     <span class="ruby-identifier">name</span>
<span class="line-num">977</span>   <span class="ruby-keyword">else</span>
<span class="line-num">978</span>     <span class="ruby-node">&quot;#{rank.capitalize} #{name}&quot;</span>
<span class="line-num">979</span>   <span class="ruby-keyword">end</span>
<span class="line-num">980</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-normalize_rank">
            
              <b>normalize_rank</b>()
            
            <a href="../classes/Taxon.html#method-i-normalize_rank" name="method-i-normalize_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-normalize_rank_source')" id="l_method-i-normalize_rank_source">show</a>
                

                

                
              </p>
              <div id="method-i-normalize_rank_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">710</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">normalize_rank</span>
<span class="line-num">711</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">rank</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">normalize_rank</span>( <span class="ruby-identifier">rank</span> )
<span class="line-num">712</span>   <span class="ruby-keyword">true</span>
<span class="line-num">713</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observation_photos">
            
              <b>observation_photos</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-observation_photos" name="method-i-observation_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observation_photos_source')" id="l_method-i-observation_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-observation_photos_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1093</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observation_photos</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1094</span>   <span class="ruby-identifier">options</span> = { <span class="ruby-value">page:</span> <span class="ruby-value">1</span> }.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">options</span> ).<span class="ruby-identifier">merge</span>(
<span class="line-num">1095</span>     <span class="ruby-value">conditions:</span> [<span class="ruby-string">&quot;taxa.id = ?&quot;</span>, <span class="ruby-identifier">id</span>]
<span class="line-num">1096</span>   )
<span class="line-num">1097</span>   <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">observations:</span> <span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] ).
<span class="line-num">1098</span>     <span class="ruby-identifier">paginate</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">1099</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observations_count_with_descendents">
            
              <b>observations_count_with_descendents</b>()
            
            <a href="../classes/Taxon.html#method-i-observations_count_with_descendents" name="method-i-observations_count_with_descendents" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observations_count_with_descendents_source')" id="l_method-i-observations_count_with_descendents_source">show</a>
                

                

                
              </p>
              <div id="method-i-observations_count_with_descendents_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">864</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observations_count_with_descendents</span>
<span class="line-num">865</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">of</span>( <span class="ruby-keyword">self</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">866</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observose_branch-3F">
            
              <b>observose_branch?</b>()
            
            <a href="../classes/Taxon.html#method-i-observose_branch-3F" name="method-i-observose_branch-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observose_branch-3F_source')" id="l_method-i-observose_branch-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-observose_branch-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1341</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observose_branch?</span>
<span class="line-num">1342</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observations_count</span>
<span class="line-num">1343</span> 
<span class="line-num">1344</span>   <span class="ruby-identifier">observations_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">NUM_OBSERVATIONS_REQUIRING_CURATOR_TO_EDIT</span>
<span class="line-num">1345</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observose_warning_branch-3F">
            
              <b>observose_warning_branch?</b>()
            
            <a href="../classes/Taxon.html#method-i-observose_warning_branch-3F" name="method-i-observose_warning_branch-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observose_warning_branch-3F_source')" id="l_method-i-observose_warning_branch-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-observose_warning_branch-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1347</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observose_warning_branch?</span>
<span class="line-num">1348</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1349</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observations_count</span>
<span class="line-num">1350</span> 
<span class="line-num">1351</span>   <span class="ruby-identifier">observations_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">NUM_OBSERVATIONS_TRIGGERING_WARNING</span>
<span class="line-num">1352</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-only_inactive_children_if_inactive">
            
              <b>only_inactive_children_if_inactive</b>()
            
            <a href="../classes/Taxon.html#method-i-only_inactive_children_if_inactive" name="method-i-only_inactive_children_if_inactive" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-only_inactive_children_if_inactive_source')" id="l_method-i-only_inactive_children_if_inactive_source">show</a>
                

                

                
              </p>
              <div id="method-i-only_inactive_children_if_inactive_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1140</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">only_inactive_children_if_inactive</span>
<span class="line-num">1141</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">is_active</span>
<span class="line-num">1142</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@skip_only_inactive_children_if_inactive</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">children</span>.<span class="ruby-identifier">any?</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_active</span> )
<span class="line-num">1143</span> 
<span class="line-num">1144</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-identifier">name</span>, <span class="ruby-string">&quot;must only have inactive children to be inactive itself&quot;</span> )
<span class="line-num">1145</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-parent_id-3D">
            
              <b>parent_id=</b>( parent_id )
            
            <a href="../classes/Taxon.html#method-i-parent_id-3D" name="method-i-parent_id-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-parent_id-3D_source')" id="l_method-i-parent_id-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-parent_id-3D_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1632</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parent_id=</span>( <span class="ruby-identifier">parent_id</span> )
<span class="line-num">1633</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-operator">!</span><span class="ruby-identifier">parent_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">parent_id</span> )
<span class="line-num">1634</span> 
<span class="line-num">1635</span>   <span class="ruby-keyword">super</span>
<span class="line-num">1636</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photo_url">
            
              <b>photo_url</b>()
            
            <a href="../classes/Taxon.html#method-i-photo_url" name="method-i-photo_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photo_url_source')" id="l_method-i-photo_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-photo_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1928</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photo_url</span>
<span class="line-num">1929</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@default_photo</span> <span class="ruby-operator">||</span> ( <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">loaded?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">positive?</span> )
<span class="line-num">1930</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">image_url</span>
<span class="line-num">1931</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1932</span> 
<span class="line-num">1933</span>   <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">image_url</span>
<span class="line-num">1934</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos-3D">
            
              <b>photos=</b>( new_photos )
            
            <a href="../classes/Taxon.html#method-i-photos-3D" name="method-i-photos-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Override assignment method provided by has_many to ensure that all callbacks on photos and taxon_photos get called, including after_destroy</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos-3D_source')" id="l_method-i-photos-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos-3D_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1022</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos=</span>( <span class="ruby-identifier">new_photos</span> )
<span class="line-num">1023</span>   <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_photo</span> <span class="ruby-operator">|</span>
<span class="line-num">1024</span>     <span class="ruby-identifier">taxon_photo</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_photos</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_photo</span>.<span class="ruby-identifier">photo_id</span> }
<span class="line-num">1025</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1026</span>   <span class="ruby-identifier">new_photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">photo</span> <span class="ruby-operator">|</span>
<span class="line-num">1027</span>     <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">photo:</span> <span class="ruby-identifier">photo</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">1028</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1029</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos_cache_key">
            
              <b>photos_cache_key</b>()
            
            <a href="../classes/Taxon.html#method-i-photos_cache_key" name="method-i-photos_cache_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos_cache_key_source')" id="l_method-i-photos_cache_key_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos_cache_key_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1085</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos_cache_key</span>
<span class="line-num">1086</span>   <span class="ruby-node">&quot;taxon_photos_#{id}&quot;</span>
<span class="line-num">1087</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos_with_backfill">
            
              <b>photos_with_backfill</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-photos_with_backfill" name="method-i-photos_with_backfill" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Fetches associated user-selected FlickrPhotos if they exist, otherwise gets the the first :limit Create Commons-licensed photos tagged with the taxon&#39;s scientific name from Flickr.  So this will return a heterogeneous array: part FlickrPhotos, part api responses</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos_with_backfill_source')" id="l_method-i-photos_with_backfill_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos_with_backfill_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1058</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos_with_backfill</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1059</span>   <span class="ruby-identifier">chosen_taxon_photos</span> = <span class="ruby-identifier">taxon_photos_with_backfill</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">1060</span>   <span class="ruby-identifier">chosen_photos</span> = <span class="ruby-identifier">chosen_taxon_photos</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:photo</span> )
<span class="line-num">1061</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_external</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">chosen_photos</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">auto_photos</span>
<span class="line-num">1062</span>     <span class="ruby-identifier">search_params</span> = {
<span class="line-num">1063</span>       <span class="ruby-value">tags:</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-string">&quot; &quot;</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">strip</span>,
<span class="line-num">1064</span>       <span class="ruby-value">per_page:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">chosen_photos</span>.<span class="ruby-identifier">size</span>,
<span class="line-num">1065</span>       <span class="ruby-value">license:</span> <span class="ruby-string">&quot;1,2,3,4,5,6&quot;</span>, <span class="ruby-comment"># CC licenses</span>
<span class="line-num">1066</span>       <span class="ruby-value">extras:</span> <span class="ruby-constant">FlickrCache</span><span class="ruby-operator">::</span><span class="ruby-constant">EXTRAS</span>,
<span class="line-num">1067</span>       <span class="ruby-value">sort:</span> <span class="ruby-string">&quot;relevance&quot;</span>,
<span class="line-num">1068</span>       <span class="ruby-value">safe_search:</span> <span class="ruby-string">&quot;1&quot;</span>
<span class="line-num">1069</span>     }
<span class="line-num">1070</span>     <span class="ruby-identifier">r</span> = <span class="ruby-constant">FlickrCache</span>.<span class="ruby-identifier">fetch</span>( <span class="ruby-identifier">flickr</span>, <span class="ruby-string">&quot;photos&quot;</span>, <span class="ruby-string">&quot;search&quot;</span>, <span class="ruby-identifier">search_params</span> )
<span class="line-num">1071</span>     <span class="ruby-identifier">r</span> = [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1072</span>     <span class="ruby-identifier">flickr_chosen_photos</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">respond_to?</span>( <span class="ruby-value">:map</span> )
<span class="line-num">1073</span>       <span class="ruby-identifier">r</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">fp</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">fp</span>.<span class="ruby-identifier">respond_to?</span>( <span class="ruby-value">:url_s</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fp</span>.<span class="ruby-identifier">url_s</span> <span class="ruby-operator">?</span> <span class="ruby-constant">FlickrPhoto</span>.<span class="ruby-identifier">new_from_api_response</span>( <span class="ruby-identifier">fp</span> ) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span> }.<span class="ruby-identifier">compact</span>
<span class="line-num">1074</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1075</span>       []
<span class="line-num">1076</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1077</span>     <span class="ruby-identifier">flickr_ids</span> = <span class="ruby-identifier">chosen_photos</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:native_photo_id</span> )
<span class="line-num">1078</span>     <span class="ruby-identifier">chosen_photos</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">flickr_chosen_photos</span>.<span class="ruby-identifier">reject</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">fp</span> <span class="ruby-operator">|</span>
<span class="line-num">1079</span>       <span class="ruby-identifier">flickr_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">fp</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1080</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1081</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1082</span>   <span class="ruby-identifier">chosen_photos</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">1083</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos_with_external_cache_key">
            
              <b>photos_with_external_cache_key</b>()
            
            <a href="../classes/Taxon.html#method-i-photos_with_external_cache_key" name="method-i-photos_with_external_cache_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos_with_external_cache_key_source')" id="l_method-i-photos_with_external_cache_key_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos_with_external_cache_key_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1089</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos_with_external_cache_key</span>
<span class="line-num">1090</span>   <span class="ruby-node">&quot;taxon_photos_external_#{id}&quot;</span>
<span class="line-num">1091</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-phylum">
            
              <b>phylum</b>()
            
            <a href="../classes/Taxon.html#method-i-phylum" name="method-i-phylum" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-phylum_source')" id="l_method-i-phylum_source">show</a>
                

                

                
              </p>
              <div id="method-i-phylum_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1101</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">phylum</span>
<span class="line-num">1102</span>   <span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">rank:</span> <span class="ruby-string">&quot;phylum&quot;</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1103</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-preferred_uninomial_ancestor">
            
              <b>preferred_uninomial_ancestor</b>()
            
            <a href="../classes/Taxon.html#method-i-preferred_uninomial_ancestor" name="method-i-preferred_uninomial_ancestor" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Used primarily in get_gbif_id. For that particular API, it is useful to know the ancestor of a taxon that fits one of the major ranks, rather than a sibtribe or infrafamily which may nto be as common. This &#39;preferred&#39; ancestor (term borrowed from <a href="Taxon.html#PREFERRED_RANKS"><code>Taxon::PREFERRED_RANKS</code></a>) can be used to give extra context when searching taxa (e.g. the Aotus in Fabaceae)</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-preferred_uninomial_ancestor_source')" id="l_method-i-preferred_uninomial_ancestor_source">show</a>
                

                

                
              </p>
              <div id="method-i-preferred_uninomial_ancestor_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">2022</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">preferred_uninomial_ancestor</span>
<span class="line-num">2023</span>   <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">PREFERRED_RANKS</span>.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span>
<span class="line-num">2024</span>     <span class="ruby-comment"># don&#39;t use binomials as preferred ancestors, use genera or above</span>
<span class="line-num">2025</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> [<span class="ruby-string">&quot;species&quot;</span>, <span class="ruby-string">&quot;subspecies&quot;</span>, <span class="ruby-string">&quot;variety&quot;</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">r</span> )
<span class="line-num">2026</span>     <span class="ruby-comment"># the rank_level of the ancestor will be higher than its own rank_level</span>
<span class="line-num">2027</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-identifier">r</span>]
<span class="line-num">2028</span> 
<span class="line-num">2029</span>     <span class="ruby-comment"># if the taxon has an ancestor at this next rank, return it</span>
<span class="line-num">2030</span>     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">ancestor</span> = <span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;find_#{r}&quot;</span> ) ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestor</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>
<span class="line-num">2031</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">ancestor</span>
<span class="line-num">2032</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2033</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2034</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">2035</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-protected_attributes_editable_by-3F">
            
              <b>protected_attributes_editable_by?</b>( user )
            
            <a href="../classes/Taxon.html#method-i-protected_attributes_editable_by-3F" name="method-i-protected_attributes_editable_by-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-protected_attributes_editable_by-3F_source')" id="l_method-i-protected_attributes_editable_by-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-protected_attributes_editable_by-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1354</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">protected_attributes_editable_by?</span>( <span class="ruby-identifier">user</span> )
<span class="line-num">1355</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_active</span>
<span class="line-num">1356</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>&amp;.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">1357</span> 
<span class="line-num">1358</span>   <span class="ruby-identifier">upstream_taxon_framework</span> = <span class="ruby-identifier">get_upstream_taxon_framework</span>
<span class="line-num">1359</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observose_branch?</span>
<span class="line-num">1360</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">curated_taxon_framework?</span>( <span class="ruby-identifier">upstream_taxon_framework</span> )
<span class="line-num">1361</span> 
<span class="line-num">1362</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1363</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">curated_taxon_framework?</span>( <span class="ruby-identifier">upstream_taxon_framework</span> )
<span class="line-num">1364</span> 
<span class="line-num">1365</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1366</span>   <span class="ruby-identifier">current_user_curates_taxon?</span>( <span class="ruby-identifier">user</span>, <span class="ruby-identifier">upstream_taxon_framework</span> )
<span class="line-num">1367</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rank_level_for_taxon_and_parent_must_not_be_nil">
            
              <b>rank_level_for_taxon_and_parent_must_not_be_nil</b>()
            
            <a href="../classes/Taxon.html#method-i-rank_level_for_taxon_and_parent_must_not_be_nil" name="method-i-rank_level_for_taxon_and_parent_must_not_be_nil" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-rank_level_for_taxon_and_parent_must_not_be_nil_source')" id="l_method-i-rank_level_for_taxon_and_parent_must_not_be_nil_source">show</a>
                

                

                
              </p>
              <div id="method-i-rank_level_for_taxon_and_parent_must_not_be_nil_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1111</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rank_level_for_taxon_and_parent_must_not_be_nil</span>
<span class="line-num">1112</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1113</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1114</span> 
<span class="line-num">1115</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:rank_level</span>, <span class="ruby-string">&quot;for taxon and parent must not be nil&quot;</span> )
<span class="line-num">1116</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rank_level_must_be_coarser_than_children">
            
              <b>rank_level_must_be_coarser_than_children</b>()
            
            <a href="../classes/Taxon.html#method-i-rank_level_must_be_coarser_than_children" name="method-i-rank_level_must_be_coarser_than_children" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-rank_level_must_be_coarser_than_children_source')" id="l_method-i-rank_level_must_be_coarser_than_children_source">show</a>
                

                

                
              </p>
              <div id="method-i-rank_level_must_be_coarser_than_children_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1126</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rank_level_must_be_coarser_than_children</span>
<span class="line-num">1127</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">1128</span> 
<span class="line-num">1129</span>   <span class="ruby-identifier">active_children_with_blank_rank_exist</span> = <span class="ruby-identifier">children</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">any?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">|</span>
<span class="line-num">1130</span>     <span class="ruby-identifier">e</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1131</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1132</span>   <span class="ruby-identifier">active_children_with_higher_rank_exist</span> = <span class="ruby-identifier">children</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">any?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">|</span>
<span class="line-num">1133</span>     <span class="ruby-identifier">e</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_f</span>
<span class="line-num">1134</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1135</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">active_children_with_blank_rank_exist</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">active_children_with_higher_rank_exist</span>
<span class="line-num">1136</span> 
<span class="line-num">1137</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:rank_level</span>, <span class="ruby-string">&quot;must be coarser than children&quot;</span> )
<span class="line-num">1138</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rank_level_must_be_finer_than_parent">
            
              <b>rank_level_must_be_finer_than_parent</b>()
            
            <a href="../classes/Taxon.html#method-i-rank_level_must_be_finer_than_parent" name="method-i-rank_level_must_be_finer_than_parent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-rank_level_must_be_finer_than_parent_source')" id="l_method-i-rank_level_must_be_finer_than_parent_source">show</a>
                

                

                
              </p>
              <div id="method-i-rank_level_must_be_finer_than_parent_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1118</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rank_level_must_be_finer_than_parent</span>
<span class="line-num">1119</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1120</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_active</span>
<span class="line-num">1121</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">to_f</span>
<span class="line-num">1122</span> 
<span class="line-num">1123</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:rank_level</span>, <span class="ruby-string">&quot;must be finer than parent&quot;</span> )
<span class="line-num">1124</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reasess_taxon_framework_relationship_after_move">
            
              <b>reasess_taxon_framework_relationship_after_move</b>()
            
            <a href="../classes/Taxon.html#method-i-reasess_taxon_framework_relationship_after_move" name="method-i-reasess_taxon_framework_relationship_after_move" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reasess_taxon_framework_relationship_after_move_source')" id="l_method-i-reasess_taxon_framework_relationship_after_move_source">show</a>
                

                

                
              </p>
              <div id="method-i-reasess_taxon_framework_relationship_after_move_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1271</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reasess_taxon_framework_relationship_after_move</span>
<span class="line-num">1272</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">tfr</span> = <span class="ruby-identifier">taxon_framework_relationship</span> )
<span class="line-num">1273</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">tf</span> = <span class="ruby-identifier">tfr</span>.<span class="ruby-identifier">taxon_framework</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">upstream_taxon_framework</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tf</span>
<span class="line-num">1274</span> 
<span class="line-num">1275</span>   <span class="ruby-identifier">tfr</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1276</span>   <span class="ruby-identifier">update</span>( <span class="ruby-value">taxon_framework_relationship_id:</span> <span class="ruby-keyword">nil</span> )
<span class="line-num">1277</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-reindex_identifications_after_save">
            
              <b>reindex_identifications_after_save</b>()
            
            <a href="../classes/Taxon.html#method-i-reindex_identifications_after_save" name="method-i-reindex_identifications_after_save" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-reindex_identifications_after_save_source')" id="l_method-i-reindex_identifications_after_save_source">show</a>
                

                

                
              </p>
              <div id="method-i-reindex_identifications_after_save_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">563</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reindex_identifications_after_save</span>
<span class="line-num">564</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">565</span> 
<span class="line-num">566</span>   <span class="ruby-identifier">reindex_needed</span> = <span class="ruby-node">%w(rank rank_level iconic_taxon_id ancestry)</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span>
<span class="line-num">567</span>     <span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;saved_change_to_#{a}?&quot;</span> )
<span class="line-num">568</span>   <span class="ruby-keyword">end</span>
<span class="line-num">569</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">reindex_needed</span>
<span class="line-num">570</span> 
<span class="line-num">571</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">572</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">573</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;throttled&quot;</span>,
<span class="line-num">574</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Identification::reindex_for_taxon&quot;:</span> <span class="ruby-identifier">id</span> }
<span class="line-num">575</span>   ).<span class="ruby-identifier">reindex_for_taxon</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">576</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_rank_from_name">
            
              <b>remove_rank_from_name</b>()
            
            <a href="../classes/Taxon.html#method-i-remove_rank_from_name" name="method-i-remove_rank_from_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_rank_from_name_source')" id="l_method-i-remove_rank_from_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_rank_from_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">720</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_rank_from_name</span>
<span class="line-num">721</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">remove_rank_from_name</span>( <span class="ruby-identifier">name</span> )
<span class="line-num">722</span>   <span class="ruby-keyword">true</span>
<span class="line-num">723</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_wikipedia_summary_unless_auto_description">
            
              <b>remove_wikipedia_summary_unless_auto_description</b>()
            
            <a href="../classes/Taxon.html#method-i-remove_wikipedia_summary_unless_auto_description" name="method-i-remove_wikipedia_summary_unless_auto_description" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_wikipedia_summary_unless_auto_description_source')" id="l_method-i-remove_wikipedia_summary_unless_auto_description_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_wikipedia_summary_unless_auto_description_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1467</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_wikipedia_summary_unless_auto_description</span>
<span class="line-num">1468</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">wikipedia_summary</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">auto_description?</span>
<span class="line-num">1469</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1470</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-root-3F">
            
              <b>root?</b>()
            
            <a href="../classes/Taxon.html#method-i-root-3F" name="method-i-root-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-root-3F_source')" id="l_method-i-root-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-root-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">933</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">root?</span>
<span class="line-num">934</span>   <span class="ruby-identifier">parent_id</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">935</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-scientific_name">
            
              <b>scientific_name</b>()
            
            <a href="../classes/Taxon.html#method-i-scientific_name" name="method-i-scientific_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-scientific_name_source')" id="l_method-i-scientific_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-scientific_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">947</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">scientific_name</span>
<span class="line-num">948</span>   <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">choose_scientific_name</span>( <span class="ruby-identifier">taxon_names</span> )
<span class="line-num">949</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-self_and_ancestor_ids">
            
              <b>self_and_ancestor_ids</b>()
            
            <a href="../classes/Taxon.html#method-i-self_and_ancestor_ids" name="method-i-self_and_ancestor_ids" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-self_and_ancestor_ids_source')" id="l_method-i-self_and_ancestor_ids_source">show</a>
                

                

                
              </p>
              <div id="method-i-self_and_ancestor_ids_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">929</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">self_and_ancestor_ids</span>
<span class="line-num">930</span>   [<span class="ruby-identifier">ancestor_ids</span>, <span class="ruby-identifier">id</span>].<span class="ruby-identifier">flatten</span>
<span class="line-num">931</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-self_and_ancestors">
            
              <b>self_and_ancestors</b>()
            
            <a href="../classes/Taxon.html#method-i-self_and_ancestors" name="method-i-self_and_ancestors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-self_and_ancestors_source')" id="l_method-i-self_and_ancestors_source">show</a>
                

                

                
              </p>
              <div id="method-i-self_and_ancestors_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">925</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">self_and_ancestors</span>
<span class="line-num">926</span>   [<span class="ruby-identifier">ancestors</span>, <span class="ruby-keyword">self</span>].<span class="ruby-identifier">flatten</span>
<span class="line-num">927</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_iconic_taxon">
            
              <b>set_iconic_taxon</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-set_iconic_taxon" name="method-i-set_iconic_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Set the iconic taxon if it hasn&#39;t been set</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_iconic_taxon_source')" id="l_method-i-set_iconic_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_iconic_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">728</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_iconic_taxon</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">729</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">will_save_change_to_iconic_taxon_id?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_iconic_taxon_id?</span>
<span class="line-num">730</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">iconic_taxon</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_iconic?</span>
<span class="line-num">731</span>       <span class="ruby-keyword">self</span>
<span class="line-num">732</span>     <span class="ruby-keyword">else</span>
<span class="line-num">733</span>       <span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">select</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:is_iconic?</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">734</span>     <span class="ruby-keyword">end</span>
<span class="line-num">735</span>   <span class="ruby-keyword">end</span>
<span class="line-num">736</span> 
<span class="line-num">737</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">new_record?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">will_save_change_to_iconic_taxon_id?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_iconic_taxon_id?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:force</span>] )
<span class="line-num">738</span>     <span class="ruby-identifier">new_child_ancestry</span> = <span class="ruby-node">&quot;#{ancestry}/#{id}&quot;</span>
<span class="line-num">739</span>     <span class="ruby-identifier">conditions</span> = [<span class="ruby-string">&quot;(ancestry LIKE ? OR ancestry = ?)&quot;</span>, <span class="ruby-node">&quot;#{new_child_ancestry}/%&quot;</span>, <span class="ruby-identifier">new_child_ancestry</span>]
<span class="line-num">740</span>     <span class="ruby-identifier">conditions</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; AND (iconic_taxon_id IN (?) OR iconic_taxon_id IS NULL)&quot;</span>
<span class="line-num">741</span>     <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ancestry_was</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> )
<span class="line-num">742</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">conditions</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-identifier">iconic_taxon_id</span> )
<span class="line-num">743</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">set_iconic_taxon_for_observations_of</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">744</span>   <span class="ruby-keyword">end</span>
<span class="line-num">745</span>   <span class="ruby-keyword">true</span>
<span class="line-num">746</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_photo_from_external">
            
              <b>set_photo_from_external</b>()
            
            <a href="../classes/Taxon.html#method-i-set_photo_from_external" name="method-i-set_photo_from_external" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>mostly just a convenience for populating an empty database</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_photo_from_external_source')" id="l_method-i-set_photo_from_external_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_photo_from_external_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1012</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_photo_from_external</span>
<span class="line-num">1013</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1014</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">photos_with_backfill</span>.<span class="ruby-identifier">first</span> )
<span class="line-num">1015</span> 
<span class="line-num">1016</span>   <span class="ruby-identifier">photos</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">photo</span>
<span class="line-num">1017</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">update_ancestor_photos</span>( <span class="ruby-keyword">self</span>, <span class="ruby-identifier">photo</span> )
<span class="line-num">1018</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_photo_from_observations">
            
              <b>set_photo_from_observations</b>()
            
            <a href="../classes/Taxon.html#method-i-set_photo_from_observations" name="method-i-set_photo_from_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_photo_from_observations_source')" id="l_method-i-set_photo_from_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_photo_from_observations_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1000</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_photo_from_observations</span>
<span class="line-num">1001</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">positive?</span>
<span class="line-num">1002</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">has_quality_grade</span>( <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">1003</span> 
<span class="line-num">1004</span>   <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">op</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">position</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:photo</span> )
<span class="line-num">1005</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo</span>
<span class="line-num">1006</span> 
<span class="line-num">1007</span>   <span class="ruby-identifier">photos</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">photo</span>
<span class="line-num">1008</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">update_ancestor_photos</span>( <span class="ruby-keyword">self</span>, <span class="ruby-identifier">photo</span> )
<span class="line-num">1009</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_rank_level">
            
              <b>set_rank_level</b>()
            
            <a href="../classes/Taxon.html#method-i-set_rank_level" name="method-i-set_rank_level" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_rank_level_source')" id="l_method-i-set_rank_level_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_rank_level_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">715</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_rank_level</span>
<span class="line-num">716</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">rank_level</span> = <span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-identifier">rank</span>]
<span class="line-num">717</span>   <span class="ruby-keyword">true</span>
<span class="line-num">718</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_scientific_taxon_name">
            
              <b>set_scientific_taxon_name</b>()
            
            <a href="../classes/Taxon.html#method-i-set_scientific_taxon_name" name="method-i-set_scientific_taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a scientific taxon name matching this taxon&#39;s name if one doesn&#39;t already exist.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_scientific_taxon_name_source')" id="l_method-i-set_scientific_taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_scientific_taxon_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">986</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_scientific_taxon_name</span>
<span class="line-num">987</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">exists?</span>( [<span class="ruby-string">&quot;name = ?&quot;</span>, <span class="ruby-identifier">name</span>] )
<span class="line-num">988</span> 
<span class="line-num">989</span>   <span class="ruby-identifier">taxon_names</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">990</span>     <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">991</span>     <span class="ruby-value">source:</span> <span class="ruby-identifier">source</span>,
<span class="line-num">992</span>     <span class="ruby-value">source_identifier:</span> <span class="ruby-identifier">source_identifier</span>,
<span class="line-num">993</span>     <span class="ruby-value">source_url:</span> <span class="ruby-identifier">source_url</span>,
<span class="line-num">994</span>     <span class="ruby-value">name_provider:</span> <span class="ruby-identifier">name_provider</span>,
<span class="line-num">995</span>     <span class="ruby-value">lexicon:</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">LEXICONS</span>[<span class="ruby-value">:SCIENTIFIC_NAMES</span>],
<span class="line-num">996</span>     <span class="ruby-value">is_valid:</span> <span class="ruby-keyword">true</span>
<span class="line-num">997</span>   )
<span class="line-num">998</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_uuid">
            
              <b>set_uuid</b>()
            
            <a href="../classes/Taxon.html#method-i-set_uuid" name="method-i-set_uuid" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_uuid_source')" id="l_method-i-set_uuid_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_uuid_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">31</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_uuid</span>
<span class="line-num">32</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">uuid</span>
<span class="line-num">33</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">uuid</span> = <span class="ruby-identifier">uuid</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">34</span>   <span class="ruby-keyword">true</span>
<span class="line-num">35</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_wikipedia_summary">
            
              <b>set_wikipedia_summary</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-set_wikipedia_summary" name="method-i-set_wikipedia_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_wikipedia_summary_source')" id="l_method-i-set_wikipedia_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_wikipedia_summary_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1427</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_wikipedia_summary</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1428</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">auto_description?</span>
<span class="line-num">1429</span>     <span class="ruby-identifier">update</span>( <span class="ruby-value">wikipedia_summary:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">1430</span>     <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">destroy_all</span>
<span class="line-num">1431</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1432</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1433</span>   <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">1434</span>   <span class="ruby-identifier">w</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:wikipedia</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">WikipediaService</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">1435</span>   <span class="ruby-identifier">wname</span> = <span class="ruby-identifier">wikipedia_title</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">wikipedia_title</span>
<span class="line-num">1436</span>   <span class="ruby-identifier">provider</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1437</span> 
<span class="line-num">1438</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">details</span> = <span class="ruby-identifier">w</span>.<span class="ruby-identifier">page_details</span>( <span class="ruby-identifier">wname</span>, <span class="ruby-identifier">options</span> ) )
<span class="line-num">1439</span>     <span class="ruby-identifier">pre_trunc</span> = <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>]
<span class="line-num">1440</span>     <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>] = <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>].<span class="ruby-identifier">split</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">75</span>].<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot; &quot;</span> )
<span class="line-num">1441</span>     <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pre_trunc</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>]
<span class="line-num">1442</span>     <span class="ruby-identifier">provider</span> = <span class="ruby-string">&quot;Wikipedia&quot;</span>
<span class="line-num">1443</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1444</span> 
<span class="line-num">1445</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">details</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1446</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-keyword">self</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">wikipedia_summary:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^en-?/</span>
<span class="line-num">1447</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1448</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1449</span> 
<span class="line-num">1450</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^en-?/</span>
<span class="line-num">1451</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-keyword">self</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">wikipedia_summary:</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>] )
<span class="line-num">1452</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1453</span>   <span class="ruby-identifier">td</span> = <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1454</span>   <span class="ruby-identifier">td</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">1455</span>   <span class="ruby-identifier">td</span>&amp;.<span class="ruby-identifier">update</span>(
<span class="line-num">1456</span>     <span class="ruby-value">title:</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:title</span>],
<span class="line-num">1457</span>     <span class="ruby-value">body:</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>],
<span class="line-num">1458</span>     <span class="ruby-value">provider_taxon_id:</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:id</span>],
<span class="line-num">1459</span>     <span class="ruby-value">url:</span> <span class="ruby-identifier">details</span>[<span class="ruby-value">:url</span>],
<span class="line-num">1460</span>     <span class="ruby-value">provider:</span> <span class="ruby-identifier">provider</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">td</span>.<span class="ruby-identifier">provider</span>
<span class="line-num">1461</span>   )
<span class="line-num">1462</span>   <span class="ruby-comment"># the update_all above skips callbacks, and the wikipedia URL may have changes</span>
<span class="line-num">1463</span>   <span class="ruby-identifier">elastic_index!</span>
<span class="line-num">1464</span>   <span class="ruby-identifier">details</span>[<span class="ruby-value">:summary</span>]
<span class="line-num">1465</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_wikipedia_summary_later">
            
              <b>set_wikipedia_summary_later</b>()
            
            <a href="../classes/Taxon.html#method-i-set_wikipedia_summary_later" name="method-i-set_wikipedia_summary_later" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_wikipedia_summary_later_source')" id="l_method-i-set_wikipedia_summary_later_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_wikipedia_summary_later_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">748</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_wikipedia_summary_later</span>
<span class="line-num">749</span>   <span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">OPTIONAL_PRIORITY</span> ).<span class="ruby-identifier">set_wikipedia_summary</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved_change_to_wikipedia_title?</span>
<span class="line-num">750</span>   <span class="ruby-keyword">true</span>
<span class="line-num">751</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-species_or_lower-3F">
            
              <b>species_or_lower?</b>()
            
            <a href="../classes/Taxon.html#method-i-species_or_lower-3F" name="method-i-species_or_lower-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Determine whether this taxon is at or below the rank of species</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-species_or_lower-3F_source')" id="l_method-i-species_or_lower-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-species_or_lower-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1381</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">species_or_lower?</span>
<span class="line-num">1382</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rank_level</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1383</span> 
<span class="line-num">1384</span>   <span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">SPECIES_LEVEL</span>
<span class="line-num">1385</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-strip_name">
            
              <b>strip_name</b>()
            
            <a href="../classes/Taxon.html#method-i-strip_name" name="method-i-strip_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-strip_name_source')" id="l_method-i-strip_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-strip_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">779</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">strip_name</span>
<span class="line-num">780</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>
<span class="line-num">781</span>   <span class="ruby-keyword">true</span>
<span class="line-num">782</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-subtree_conditions">
            
              <b>subtree_conditions</b>()
            
            <a href="../classes/Taxon.html#method-i-subtree_conditions" name="method-i-subtree_conditions" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-subtree_conditions_source')" id="l_method-i-subtree_conditions_source">show</a>
                

                

                
              </p>
              <div id="method-i-subtree_conditions_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">872</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">subtree_conditions</span>
<span class="line-num">873</span>   <span class="ruby-identifier">descendant_conditions</span>.<span class="ruby-identifier">or</span>( <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">arel_table</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">eq</span>( <span class="ruby-identifier">id</span> ) )
<span class="line-num">874</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_cant_be_its_own_ancestor">
            
              <b>taxon_cant_be_its_own_ancestor</b>()
            
            <a href="../classes/Taxon.html#method-i-taxon_cant_be_its_own_ancestor" name="method-i-taxon_cant_be_its_own_ancestor" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_cant_be_its_own_ancestor_source')" id="l_method-i-taxon_cant_be_its_own_ancestor_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_cant_be_its_own_ancestor_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1105</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_cant_be_its_own_ancestor</span>
<span class="line-num">1106</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">1107</span> 
<span class="line-num">1108</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:base</span>, <span class="ruby-string">&quot;can&#39;t be its own ancestor&quot;</span> )
<span class="line-num">1109</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_changes_count">
            
              <b>taxon_changes_count</b>()
            
            <a href="../classes/Taxon.html#method-i-taxon_changes_count" name="method-i-taxon_changes_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_changes_count_source')" id="l_method-i-taxon_changes_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_changes_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">876</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_changes_count</span>
<span class="line-num">877</span>   ( <span class="ruby-identifier">taxon_changes</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) <span class="ruby-operator">+</span>
<span class="line-num">878</span>    <span class="ruby-identifier">taxon_change_taxa</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_change_id</span> ) ).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">length</span>
<span class="line-num">879</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_photos_with_backfill">
            
              <b>taxon_photos_with_backfill</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-taxon_photos_with_backfill" name="method-i-taxon_photos_with_backfill" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_photos_with_backfill_source')" id="l_method-i-taxon_photos_with_backfill_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_photos_with_backfill_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1031</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_photos_with_backfill</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1032</span>   <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">9</span>
<span class="line-num">1033</span>   <span class="ruby-identifier">chosen_taxon_photos</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">loaded?</span>
<span class="line-num">1034</span>     <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tp</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tp</span>.<span class="ruby-identifier">position</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tp</span>.<span class="ruby-identifier">id</span> }[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>]]
<span class="line-num">1035</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1036</span>     <span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">includes</span>( { <span class="ruby-value">photo:</span> <span class="ruby-value">:flags</span> } ).
<span class="line-num">1037</span>       <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;taxon_photos.position ASC NULLS LAST, taxon_photos.id ASC&quot;</span> ).
<span class="line-num">1038</span>       <span class="ruby-identifier">limit</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>] )
<span class="line-num">1039</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1040</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">chosen_taxon_photos</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>]
<span class="line-num">1041</span>     <span class="ruby-identifier">descendant_taxon_photos</span> = <span class="ruby-constant">TaxonPhoto</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-value">:taxon</span> ).<span class="ruby-identifier">includes</span>( { <span class="ruby-value">photo:</span> <span class="ruby-value">:flags</span> } ).
<span class="line-num">1042</span>       <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;taxon_photos.id ASC&quot;</span> ).
<span class="line-num">1043</span>       <span class="ruby-identifier">limit</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">chosen_taxon_photos</span>.<span class="ruby-identifier">size</span> ).
<span class="line-num">1044</span>       <span class="ruby-identifier">where</span>( <span class="ruby-node">&quot;taxa.ancestry LIKE &#39;#{ancestry}/#{id}%&#39;&quot;</span> ).
<span class="line-num">1045</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxa.is_active = ?&quot;</span>, <span class="ruby-keyword">true</span> ).
<span class="line-num">1046</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_photos.id NOT IN (?)&quot;</span>, <span class="ruby-identifier">chosen_taxon_photos</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) )
<span class="line-num">1047</span>     <span class="ruby-identifier">chosen_taxon_photos</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">descendant_taxon_photos</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">1048</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1049</span>   <span class="ruby-identifier">chosen_taxon_photos</span>
<span class="line-num">1050</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_range_kml_url">
            
              <b>taxon_range_kml_url</b>()
            
            <a href="../classes/Taxon.html#method-i-taxon_range_kml_url" name="method-i-taxon_range_kml_url" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_range_kml_url_source')" id="l_method-i-taxon_range_kml_url_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_range_kml_url_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1936</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_range_kml_url</span>
<span class="line-num">1937</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">tr</span> = <span class="ruby-identifier">taxon_range_without_geom</span> )
<span class="line-num">1938</span> 
<span class="line-num">1939</span>   <span class="ruby-identifier">tr</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">tr</span>.<span class="ruby-identifier">kml_url</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1940</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_schemes_count">
            
              <b>taxon_schemes_count</b>()
            
            <a href="../classes/Taxon.html#method-i-taxon_schemes_count" name="method-i-taxon_schemes_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_schemes_count_source')" id="l_method-i-taxon_schemes_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_schemes_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">881</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_schemes_count</span>
<span class="line-num">882</span>   <span class="ruby-identifier">taxon_schemes</span>.<span class="ruby-identifier">size</span>
<span class="line-num">883</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-threatened-3F">
            
              <b>threatened?</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-threatened-3F" name="method-i-threatened-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-threatened-3F_source')" id="l_method-i-threatened-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-threatened-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1667</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">threatened?</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1668</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">globally_threatened?</span>
<span class="line-num">1669</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">threatened_in_place?</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:place</span>] ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:place</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1670</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">threatened_in_lat_lon?</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:latitude</span>], <span class="ruby-identifier">options</span>[<span class="ruby-value">:longitude</span>] ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:latitude</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1671</span> 
<span class="line-num">1672</span>   <span class="ruby-keyword">false</span>
<span class="line-num">1673</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-threatened_in_lat_lon-3F">
            
              <b>threatened_in_lat_lon?</b>( lat, lon )
            
            <a href="../classes/Taxon.html#method-i-threatened_in_lat_lon-3F" name="method-i-threatened_in_lat_lon-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-threatened_in_lat_lon-3F_source')" id="l_method-i-threatened_in_lat_lon-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-threatened_in_lat_lon-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1759</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">threatened_in_lat_lon?</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> )
<span class="line-num">1760</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1761</span> 
<span class="line-num">1762</span>   <span class="ruby-identifier">log_timer</span> <span class="ruby-keyword">do</span>
<span class="line-num">1763</span>     <span class="ruby-constant">ConservationStatus</span>.<span class="ruby-identifier">for_taxon</span>( <span class="ruby-keyword">self</span> ).<span class="ruby-identifier">for_lat_lon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1764</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1765</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-threatened_in_place-3F">
            
              <b>threatened_in_place?</b>( place )
            
            <a href="../classes/Taxon.html#method-i-threatened_in_place-3F" name="method-i-threatened_in_place-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-threatened_in_place-3F_source')" id="l_method-i-threatened_in_place-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-threatened_in_place-3F_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1705</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">threatened_in_place?</span>( <span class="ruby-identifier">place</span> )
<span class="line-num">1706</span>   <span class="ruby-identifier">places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">param_to_array</span>( <span class="ruby-identifier">place</span> )
<span class="line-num">1707</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">places</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1708</span> 
<span class="line-num">1709</span>   <span class="ruby-identifier">cs</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">association</span>( <span class="ruby-value">:conservation_statuses</span> ).<span class="ruby-identifier">loaded?</span>
<span class="line-num">1710</span>     <span class="ruby-identifier">place_ancestor_ids</span> = ( <span class="ruby-identifier">places</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ) <span class="ruby-operator">+</span>
<span class="line-num">1711</span>       <span class="ruby-identifier">places</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> ) } ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1712</span>     <span class="ruby-identifier">place_ancestor_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1713</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">|</span>
<span class="line-num">1714</span>       <span class="ruby-identifier">place_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">c</span>.<span class="ruby-identifier">place_id</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">IUCN_LEAST_CONCERN</span>
<span class="line-num">1715</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1716</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1717</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">where</span>( <span class="ruby-node">&quot;place_id IN (#{places.map( &amp;:id ).join( &#39;,&#39; )}) OR
<span class="line-num">1718</span>       place_id::text IN (#{ListedTaxon.place_ancestor_ids_sql( places.map( &amp;:id ) )})
<span class="line-num">1719</span>       OR place_id IS NULL&quot;</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;iucn &gt; ?&quot;</span>, <span class="ruby-constant">IUCN_LEAST_CONCERN</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1720</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1721</span>   <span class="ruby-operator">!</span><span class="ruby-identifier">cs</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">1722</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-threatened_status">
            
              <b>threatened_status</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-threatened_status" name="method-i-threatened_status" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-threatened_status_source')" id="l_method-i-threatened_status_source">show</a>
                

                

                
              </p>
              <div id="method-i-threatened_status_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1724</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">threatened_status</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1725</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:place_id</span>] )
<span class="line-num">1726</span>     <span class="ruby-identifier">place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">place_id</span> )
<span class="line-num">1727</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">association</span>( <span class="ruby-value">:conservation_statuses</span> ).<span class="ruby-identifier">loaded?</span>
<span class="line-num">1728</span>       <span class="ruby-identifier">statuses</span> = <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1729</span>         ( [<span class="ruby-keyword">nil</span>,
<span class="line-num">1730</span>            <span class="ruby-identifier">place</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> )].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">to_s</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">IUCN_LEAST_CONCERN</span>
<span class="line-num">1731</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1732</span>       <span class="ruby-identifier">statuses</span>.<span class="ruby-identifier">max_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> }
<span class="line-num">1733</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1734</span>       <span class="ruby-identifier">conservation_statuses</span>.
<span class="line-num">1735</span>         <span class="ruby-identifier">where</span>(
<span class="line-num">1736</span>           <span class="ruby-node">&quot;place_id::text IN (#{ListedTaxon.place_ancestor_ids_sql( place_id )}) OR place_id IS NULL&quot;</span>
<span class="line-num">1737</span>         ).
<span class="line-num">1738</span>         <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;iucn &gt; ?&quot;</span>, <span class="ruby-constant">IUCN_LEAST_CONCERN</span> ).
<span class="line-num">1739</span>         <span class="ruby-identifier">max_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1740</span>         <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">1741</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1742</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1743</span>   <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:latitude</span>] ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:longitude</span>] )
<span class="line-num">1744</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">for_lat_lon</span>( <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">lon</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;iucn &gt; ?&quot;</span>, <span class="ruby-constant">IUCN_LEAST_CONCERN</span> ).<span class="ruby-identifier">max_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1745</span>       <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">1746</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1747</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">association</span>( <span class="ruby-value">:conservation_statuses</span> ).<span class="ruby-identifier">loaded?</span>
<span class="line-num">1748</span>     <span class="ruby-identifier">statuses</span> = <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1749</span>       <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">IUCN_LEAST_CONCERN</span>
<span class="line-num">1750</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1751</span>     <span class="ruby-identifier">statuses</span>.<span class="ruby-identifier">max_by</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span> }
<span class="line-num">1752</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1753</span>     <span class="ruby-identifier">conservation_statuses</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;place_id IS NULL&quot;</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;iucn &gt; ?&quot;</span>, <span class="ruby-constant">IUCN_LEAST_CONCERN</span> ).<span class="ruby-identifier">max_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cs</span> <span class="ruby-operator">|</span>
<span class="line-num">1754</span>       <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">1755</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1756</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1757</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_param">
            
              <b>to_param</b>()
            
            <a href="../classes/Taxon.html#method-i-to_param" name="method-i-to_param" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_param_source')" id="l_method-i-to_param_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_param_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">827</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_param</span>
<span class="line-num">828</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">829</span> 
<span class="line-num">830</span>   <span class="ruby-node">&quot;#{id}-#{name.gsub( /\W/, &#39;-&#39; )}&quot;</span>
<span class="line-num">831</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_plain_s">
            
              <b>to_plain_s</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-to_plain_s" name="method-i-to_plain_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_plain_s_source')" id="l_method-i-to_plain_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_plain_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">833</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_plain_s</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">834</span>   <span class="ruby-identifier">comname</span> = <span class="ruby-identifier">common_name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_common</span>]
<span class="line-num">835</span>   <span class="ruby-identifier">sciname</span> = <span class="ruby-keyword">if</span> <span class="ruby-node">%w(species infraspecies)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">836</span>     <span class="ruby-identifier">name</span>
<span class="line-num">837</span>   <span class="ruby-keyword">else</span>
<span class="line-num">838</span>     <span class="ruby-node">&quot;#{rank.capitalize} #{name}&quot;</span>
<span class="line-num">839</span>   <span class="ruby-keyword">end</span>
<span class="line-num">840</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">sciname</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">comname</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">841</span> 
<span class="line-num">842</span>   <span class="ruby-node">&quot;#{comname.name} (#{sciname})&quot;</span>
<span class="line-num">843</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../classes/Taxon.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>see the end for the validate method</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">823</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">824</span>   <span class="ruby-node">&quot;&lt;Taxon #{id}: #{to_plain_s( skip_common: true )}&gt;&quot;</span>
<span class="line-num">825</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_styled_s">
            
              <b>to_styled_s</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-to_styled_s" name="method-i-to_styled_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_styled_s_source')" id="l_method-i-to_styled_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_styled_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">845</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_styled_s</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">846</span>   <span class="ruby-identifier">comname</span> = <span class="ruby-identifier">common_name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_common</span>]
<span class="line-num">847</span>   <span class="ruby-identifier">sciname</span> = <span class="ruby-node">%w(genus species infraspecies)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> ) <span class="ruby-operator">?</span> <span class="ruby-node">&quot;&lt;i&gt;#{name}&lt;/i&gt;&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">name</span>
<span class="line-num">848</span>   <span class="ruby-keyword">unless</span> <span class="ruby-node">%w(species infraspecies)</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">rank</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">rank</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">849</span>     <span class="ruby-identifier">sciname</span> = <span class="ruby-node">&quot;#{rank.capitalize} #{sciname}&quot;</span>
<span class="line-num">850</span>   <span class="ruby-keyword">end</span>
<span class="line-num">851</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">sciname</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">comname</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">852</span> 
<span class="line-num">853</span>   <span class="ruby-node">&quot;#{comname.name} (#{sciname})&quot;</span>
<span class="line-num">854</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_tags">
            
              <b>to_tags</b>()
            
            <a href="../classes/Taxon.html#method-i-to_tags" name="method-i-to_tags" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_tags_source')" id="l_method-i-to_tags_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_tags_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1592</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_tags</span>
<span class="line-num">1593</span>   <span class="ruby-identifier">tags</span> = []
<span class="line-num">1594</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">grafted?</span>
<span class="line-num">1595</span>     <span class="ruby-identifier">tags</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">self_and_ancestors</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">|</span>
<span class="line-num">1596</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">root?</span>
<span class="line-num">1597</span> 
<span class="line-num">1598</span>       <span class="ruby-identifier">name_pieces</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>
<span class="line-num">1599</span>       <span class="ruby-identifier">name_pieces</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&quot;subsp.&quot;</span> )
<span class="line-num">1600</span>       <span class="ruby-keyword">case</span> <span class="ruby-identifier">name_pieces</span>.<span class="ruby-identifier">size</span>
<span class="line-num">1601</span>       <span class="ruby-keyword">when</span> <span class="ruby-value">3</span>
<span class="line-num">1602</span>         [<span class="ruby-node">&quot;taxonomy:species=#{name_pieces[1]}&quot;</span>, <span class="ruby-node">&quot;taxonomy:trinomial=#{name_pieces.join( &#39; &#39; )}&quot;</span>]
<span class="line-num">1603</span>       <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
<span class="line-num">1604</span>         [<span class="ruby-node">&quot;taxonomy:species=#{name_pieces[1]}&quot;</span>, <span class="ruby-node">&quot;taxonomy:binomial=#{taxon.name.strip}&quot;</span>]
<span class="line-num">1605</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1606</span>         [<span class="ruby-node">&quot;taxonomy:#{taxon.rank}=#{taxon.name.strip}&quot;</span>, <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>]
<span class="line-num">1607</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1608</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1609</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1610</span>     <span class="ruby-identifier">name_pieces</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>
<span class="line-num">1611</span>     <span class="ruby-identifier">name_pieces</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&quot;subsp.&quot;</span> )
<span class="line-num">1612</span>     <span class="ruby-keyword">case</span> <span class="ruby-identifier">name_pieces</span>.<span class="ruby-identifier">size</span>
<span class="line-num">1613</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">3</span>
<span class="line-num">1614</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;taxonomy:trinomial=#{name_pieces.join( &#39; &#39; )}&quot;</span>
<span class="line-num">1615</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;taxonomy:binomial=#{name_pieces[0]} #{name_pieces[1]}&quot;</span>
<span class="line-num">1616</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
<span class="line-num">1617</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;taxonomy:binomial=#{name.strip}&quot;</span>
<span class="line-num">1618</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1619</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;taxonomy:#{rank}=#{name.strip}&quot;</span>
<span class="line-num">1620</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1621</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1622</span>   <span class="ruby-identifier">tags</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_valid?</span> }.<span class="ruby-identifier">compact</span>
<span class="line-num">1623</span>   <span class="ruby-identifier">tags</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">taxon_name</span> <span class="ruby-operator">|</span>
<span class="line-num">1624</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_name</span>.<span class="ruby-identifier">lexicon</span> <span class="ruby-operator">==</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">LEXICONS</span>[<span class="ruby-value">:SCIENTIFIC_NAMES</span>]
<span class="line-num">1625</span>       <span class="ruby-node">&quot;taxonomy:common=#{taxon_name.name.strip}&quot;</span>
<span class="line-num">1626</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1627</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">flatten</span>
<span class="line-num">1628</span> 
<span class="line-num">1629</span>   <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1630</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unfeature_inactive">
            
              <b>unfeature_inactive</b>()
            
            <a href="../classes/Taxon.html#method-i-unfeature_inactive" name="method-i-unfeature_inactive" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unfeature_inactive_source')" id="l_method-i-unfeature_inactive_source">show</a>
                

                

                
              </p>
              <div id="method-i-unfeature_inactive_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1492</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unfeature_inactive</span>
<span class="line-num">1493</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">featured_at</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_active?</span>
<span class="line-num">1494</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1495</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_descendants_with_new_ancestry">
            
              <b>update_descendants_with_new_ancestry</b>()
            
            <a href="../classes/Taxon.html#method-i-update_descendants_with_new_ancestry" name="method-i-update_descendants_with_new_ancestry" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>ancestry overrides - some ancestry methods iterate over ALL descendants in memory.  It&#39;s database agnostic but massively ineffecient</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_descendants_with_new_ancestry_source')" id="l_method-i-update_descendants_with_new_ancestry_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_descendants_with_new_ancestry_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1856</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_descendants_with_new_ancestry</span>
<span class="line-num">1857</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestry_callbacks_disabled?</span>
<span class="line-num">1858</span> 
<span class="line-num">1859</span>   <span class="ruby-identifier">ancestry_column</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">base_class</span>.<span class="ruby-identifier">ancestry_column</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">1860</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">changed</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ancestry_column</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">new_record?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">valid?</span>
<span class="line-num">1861</span> 
<span class="line-num">1862</span>   <span class="ruby-identifier">old_ancestry</span> = <span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;#{ancestry_column}_was&quot;</span> )
<span class="line-num">1863</span>   <span class="ruby-identifier">old_ancestry</span> = <span class="ruby-identifier">old_ancestry</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot;#{old_ancestry}/#{id}&quot;</span>
<span class="line-num">1864</span>   <span class="ruby-identifier">new_ancestry</span> = <span class="ruby-identifier">send</span>( <span class="ruby-identifier">ancestry_column</span> )
<span class="line-num">1865</span>   <span class="ruby-identifier">new_ancestry</span> = <span class="ruby-identifier">new_ancestry</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot;#{new_ancestry}/#{id}&quot;</span>
<span class="line-num">1866</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">base_class</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">descendant_conditions</span> ).<span class="ruby-identifier">update_all</span>(
<span class="line-num">1867</span>     <span class="ruby-node">&quot;#{ancestry_column} = regexp_replace(#{ancestry_column}, &#39;^#{old_ancestry}&#39;, &#39;#{new_ancestry}&#39;)&quot;</span>
<span class="line-num">1868</span>   )
<span class="line-num">1869</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">update_descendants_with_new_ancestry</span>( <span class="ruby-identifier">id</span>, <span class="ruby-identifier">child_ancestry</span> )
<span class="line-num">1870</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1871</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_obs_iconic_taxa">
            
              <b>update_obs_iconic_taxa</b>()
            
            <a href="../classes/Taxon.html#method-i-update_obs_iconic_taxa" name="method-i-update_obs_iconic_taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_obs_iconic_taxa_source')" id="l_method-i-update_obs_iconic_taxa_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_obs_iconic_taxa_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1393</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_obs_iconic_taxa</span>
<span class="line-num">1394</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">id</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-identifier">iconic_taxon_id</span> )
<span class="line-num">1395</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1396</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_taxon_framework_relationship">
            
              <b>update_taxon_framework_relationship</b>()
            
            <a href="../classes/Taxon.html#method-i-update_taxon_framework_relationship" name="method-i-update_taxon_framework_relationship" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_taxon_framework_relationship_source')" id="l_method-i-update_taxon_framework_relationship_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_taxon_framework_relationship_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">664</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_taxon_framework_relationship</span>
<span class="line-num">665</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_framework_relationship</span>
<span class="line-num">666</span> 
<span class="line-num">667</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">destroyed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_name?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_rank?</span> <span class="ruby-operator">||</span>
<span class="line-num">668</span>       <span class="ruby-identifier">saved_change_to_ancestry?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved_change_to_taxon_framework_relationship_id?</span>
<span class="line-num">669</span>     <span class="ruby-identifier">taxon_framework_relationship</span>.<span class="ruby-identifier">set_relationship</span>
<span class="line-num">670</span>   <span class="ruby-keyword">end</span>
<span class="line-num">671</span>   <span class="ruby-identifier">attrs</span> = {}
<span class="line-num">672</span>   <span class="ruby-identifier">attrs</span>[<span class="ruby-value">:relationship</span>] = <span class="ruby-identifier">taxon_framework_relationship</span>.<span class="ruby-identifier">relationship</span>
<span class="line-num">673</span>   <span class="ruby-identifier">taxon_framework_relationship</span>.<span class="ruby-identifier">update</span>( <span class="ruby-identifier">attrs</span> )
<span class="line-num">674</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-upstream_taxon_framework">
            
              <b>upstream_taxon_framework</b>()
            
            <a href="../classes/Taxon.html#method-i-upstream_taxon_framework" name="method-i-upstream_taxon_framework" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-upstream_taxon_framework_source')" id="l_method-i-upstream_taxon_framework_source">show</a>
                

                

                
              </p>
              <div id="method-i-upstream_taxon_framework_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1279</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">upstream_taxon_framework</span>
<span class="line-num">1280</span>   <span class="ruby-keyword">return</span> <span class="ruby-ivar">@upstream_taxon_framework</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@upstream_taxon_framework</span>
<span class="line-num">1281</span> 
<span class="line-num">1282</span>   <span class="ruby-ivar">@upstream_taxon_framework</span> = <span class="ruby-identifier">get_upstream_taxon_framework</span>
<span class="line-num">1283</span>   <span class="ruby-ivar">@upstream_taxon_framework</span>
<span class="line-num">1284</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user_can_edit_attributes">
            
              <b>user_can_edit_attributes</b>()
            
            <a href="../classes/Taxon.html#method-i-user_can_edit_attributes" name="method-i-user_can_edit_attributes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_can_edit_attributes_source')" id="l_method-i-user_can_edit_attributes_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_can_edit_attributes_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1314</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user_can_edit_attributes</span>
<span class="line-num">1315</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_active</span>
<span class="line-num">1316</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1317</span> 
<span class="line-num">1318</span>   <span class="ruby-identifier">current_user_curates_taxon</span> = <span class="ruby-identifier">protected_attributes_editable_by?</span>( <span class="ruby-identifier">current_user</span> )
<span class="line-num">1319</span>   <span class="ruby-constant">PROTECTED_ATTRIBUTES_FOR_CURATED_TAXA</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span>
<span class="line-num">1320</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">changes</span>[<span class="ruby-identifier">a</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user_curates_taxon</span>
<span class="line-num">1321</span>       <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-identifier">a</span>, <span class="ruby-value">:can_only_be_changed_by_a_curator_of_this_taxon</span> )
<span class="line-num">1322</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1323</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1324</span>   <span class="ruby-keyword">true</span>
<span class="line-num">1325</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-validate_locked">
            
              <b>validate_locked</b>()
            
            <a href="../classes/Taxon.html#method-i-validate_locked" name="method-i-validate_locked" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-validate_locked_source')" id="l_method-i-validate_locked_source">show</a>
                

                

                
              </p>
              <div id="method-i-validate_locked_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1162</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate_locked</span>
<span class="line-num">1163</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@skip_locks</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestry_changed?</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">locked_ancestor</span> = <span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">is_locked</span>.<span class="ruby-identifier">first</span> )
<span class="line-num">1164</span> 
<span class="line-num">1165</span>   <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>( <span class="ruby-value">:ancestry</span>, <span class="ruby-node">&quot;includes a locked taxon (#{locked_ancestor}), &quot;</span> \
<span class="line-num">1166</span>     <span class="ruby-string">&quot;so this cannot be added as a descendent.  Either unlock the &quot;</span> \
<span class="line-num">1167</span>     <span class="ruby-string">&quot;locked taxon or merge this taxon with an existing one.&quot;</span> )
<span class="line-num">1168</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-view_context">
            
              <b>view_context</b>()
            
            <a href="../classes/Taxon.html#method-i-view_context" name="method-i-view_context" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-view_context_source')" id="l_method-i-view_context_source">show</a>
                

                

                
              </p>
              <div id="method-i-view_context_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1920</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">view_context</span>
<span class="line-num">1921</span>   <span class="ruby-constant">FakeView</span>
<span class="line-num">1922</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-wikipedia_attribution">
            
              <b>wikipedia_attribution</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-wikipedia_attribution" name="method-i-wikipedia_attribution" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-wikipedia_attribution_source')" id="l_method-i-wikipedia_attribution_source">show</a>
                

                

                
              </p>
              <div id="method-i-wikipedia_attribution_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1472</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">wikipedia_attribution</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1473</span>   <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">1474</span>   <span class="ruby-identifier">locale_lang</span> = <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;-&quot;</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1475</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">td</span> = <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale_lang</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">1476</span>     <span class="ruby-identifier">title</span> = <span class="ruby-identifier">td</span>.<span class="ruby-identifier">title</span>
<span class="line-num">1477</span>     <span class="ruby-identifier">url</span> = <span class="ruby-identifier">td</span>.<span class="ruby-identifier">url</span>
<span class="line-num">1478</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1479</span>     <span class="ruby-identifier">title</span> = <span class="ruby-identifier">wikipedia_title</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>
<span class="line-num">1480</span>     <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;https://wikipedia.org/wiki/#{title.underscore}&quot;</span>
<span class="line-num">1481</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1482</span>   <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;wikipedia_attribution_cc_by_sa_3&quot;</span>, <span class="ruby-value">title:</span> <span class="ruby-identifier">title</span>, <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span>, <span class="ruby-value">url:</span> <span class="ruby-identifier">url</span> )
<span class="line-num">1483</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-wikipedia_summary">
            
              <b>wikipedia_summary</b>( options = {} )
            
            <a href="../classes/Taxon.html#method-i-wikipedia_summary" name="method-i-wikipedia_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-wikipedia_summary_source')" id="l_method-i-wikipedia_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-wikipedia_summary_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/models/taxon.rb</span>
<span class="line-num">1398</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">wikipedia_summary</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">1399</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">auto_description?</span>
<span class="line-num">1400</span> 
<span class="line-num">1401</span>   <span class="ruby-identifier">locale</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:locale</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">1402</span>   <span class="ruby-identifier">td</span> = <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">desc</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">desc</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> }
<span class="line-num">1403</span>   <span class="ruby-identifier">td</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon_descriptions</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">desc</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">desc</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^#{locale.to_s.split( &#39;-&#39; ).first}/</span> }
<span class="line-num">1404</span>   <span class="ruby-identifier">sum</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">td</span>
<span class="line-num">1405</span>     <span class="ruby-identifier">td</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">500</span>]
<span class="line-num">1406</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^en-?/</span>
<span class="line-num">1407</span>     <span class="ruby-identifier">read_attribute</span>( <span class="ruby-value">:wikipedia_summary</span> )
<span class="line-num">1408</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1409</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">sum</span>&amp;.<span class="ruby-identifier">match</span>( <span class="ruby-regexp">/^\d\d\d\d-\d\d-\d\d$/</span> )
<span class="line-num">1410</span>     <span class="ruby-identifier">last_try_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">sum</span> )
<span class="line-num">1411</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_try_date</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">week</span>.<span class="ruby-identifier">ago</span>
<span class="line-num">1412</span> 
<span class="line-num">1413</span>     <span class="ruby-identifier">options</span>[<span class="ruby-value">:reload</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1414</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1415</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:reload</span>]
<span class="line-num">1416</span>     <span class="ruby-keyword">return</span> <span class="ruby-constant">Nokogiri</span><span class="ruby-operator">::</span><span class="ruby-constant">HTML</span><span class="ruby-operator">::</span><span class="ruby-constant">DocumentFragment</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">sum</span> ).<span class="ruby-identifier">to_s</span>
<span class="line-num">1417</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1418</span> 
<span class="line-num">1419</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">new_record?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:refresh_if_blank</span>]
<span class="line-num">1420</span>     <span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">OPTIONAL_PRIORITY</span>,
<span class="line-num">1421</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Taxon::set_wikipedia_summary&quot;:</span> <span class="ruby-identifier">id</span> } ).
<span class="line-num">1422</span>       <span class="ruby-identifier">set_wikipedia_summary</span>( <span class="ruby-value">locale:</span> <span class="ruby-identifier">locale</span> )
<span class="line-num">1423</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1424</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">1425</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
