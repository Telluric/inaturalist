<!DOCTYPE html>
<html lang="en">
<head>
    <title>ObservationsController</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["ObservationsController"]'>


    <meta property="og:title" value="ObservationsController">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="ObservationsController class, index, taxon_summary, lifelist_by_login, show, new, edit, create, update, edit_photos, update_photos, destroy, curation, new_batch, new_bulk_csv, edit_batch, delete_batch, import, import_photos, import_sounds, export, add_from_list, new_from_list, by_login, by_login_all, selector, widget, project, project_all, identify, upload, identotron, fields, update_fields, stats, taxa, taxon_stats, user_stats, moimport, torquemap, compare, accumulation, phylogram, viewed_updates, review, email_export, community_taxon_summary, map, observation_links">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            ObservationsController
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationController.html">ApplicationController</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/controllers/observations_controller_rb.html">app/controllers/observations_controller.rb</a></li>
            
            <li><a href="../files/app/helpers/observations_helper_rb.html">app/helpers/observations_helper.rb</a></li>
            
            <li><a href="../files/lib/observation_search_rb.html">lib/observation_search.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-accumulation">accumulation</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_from_list">add_from_list</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-by_login">by_login</a>,
              </li>
            
              
              <li>
                <a href="#method-i-by_login_all">by_login_all</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-community_taxon_summary">community_taxon_summary</a>,
              </li>
            
              
              <li>
                <a href="#method-i-compare">compare</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create">create</a>,
              </li>
            
              
              <li>
                <a href="#method-i-curation">curation</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-delete_batch">delete_batch</a>,
              </li>
            
              
              <li>
                <a href="#method-i-destroy">destroy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-edit">edit</a>,
              </li>
            
              
              <li>
                <a href="#method-i-edit_batch">edit_batch</a>,
              </li>
            
              
              <li>
                <a href="#method-i-edit_photos">edit_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-email_export">email_export</a>,
              </li>
            
              
              <li>
                <a href="#method-i-export">export</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-fields">fields</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-identify">identify</a>,
              </li>
            
              
              <li>
                <a href="#method-i-identotron">identotron</a>,
              </li>
            
              
              <li>
                <a href="#method-i-import">import</a>,
              </li>
            
              
              <li>
                <a href="#method-i-import_photos">import_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-import_sounds">import_sounds</a>,
              </li>
            
              
              <li>
                <a href="#method-i-index">index</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-lifelist_by_login">lifelist_by_login</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-map">map</a>,
              </li>
            
              
              <li>
                <a href="#method-i-moimport">moimport</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-new">new</a>,
              </li>
            
              
              <li>
                <a href="#method-i-new_batch">new_batch</a>,
              </li>
            
              
              <li>
                <a href="#method-i-new_bulk_csv">new_bulk_csv</a>,
              </li>
            
              
              <li>
                <a href="#method-i-new_from_list">new_from_list</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-observation_links">observation_links</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-phylogram">phylogram</a>,
              </li>
            
              
              <li>
                <a href="#method-i-project">project</a>,
              </li>
            
              
              <li>
                <a href="#method-i-project_all">project_all</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-review">review</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-selector">selector</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show">show</a>,
              </li>
            
              
              <li>
                <a href="#method-i-stats">stats</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-taxa">taxa</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_stats">taxon_stats</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_summary">taxon_summary</a>,
              </li>
            
              
              <li>
                <a href="#method-i-torquemap">torquemap</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-update">update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_fields">update_fields</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_photos">update_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-upload">upload</a>,
              </li>
            
              
              <li>
                <a href="#method-i-user_stats">user_stats</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-viewed_updates">viewed_updates</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-widget">widget</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">DISPLAY_ORDER_BY_FIELDS</td>
            <td>=</td>
            <td class="attr-value">{
&#39;created_at&#39; =&gt; &#39;date added&#39;,
&#39;observations.id&#39; =&gt; &#39;date added&#39;,
&#39;id&#39; =&gt; &#39;date added&#39;,
&#39;observed_on&#39; =&gt; &#39;date observed&#39;,
&#39;species_guess&#39; =&gt; &#39;species name&#39;,
&#39;project&#39; =&gt; &quot;date added to project&quot;,
&#39;votes&#39; =&gt; &#39;faves&#39;
}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">EDIT_PARTIALS</td>
            <td>=</td>
            <td class="attr-value">%w(add_photos)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAP_GRID_PARAMS_TO_CONSIDER</td>
            <td>=</td>
            <td class="attr-value">REJECTED_KML_FEED_PARAMS +
%w( order order_by taxon_id taxon_name projects user_id place_id utf8
d1 d2 )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ORDER_BY_FIELDS</td>
            <td>=</td>
            <td class="attr-value">%w&quot;created_at observed_on project species_guess votes id&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PARTIALS</td>
            <td>=</td>
            <td class="attr-value">%w(cached_component observation_component observation mini project_observation)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PHOTO_SYNC_ATTRS</td>
            <td>=</td>
            <td class="attr-value">[:description, :species_guess, :taxon_id, :observed_on,
:observed_on_string, :latitude, :longitude, :place_guess]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">REJECTED_FEED_PARAMS</td>
            <td>=</td>
            <td class="attr-value">%w&quot;page view filters_open partial action id locale&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">REJECTED_KML_FEED_PARAMS</td>
            <td>=</td>
            <td class="attr-value">REJECTED_FEED_PARAMS + %w&quot;swlat swlng nelat nelng BBOX&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">WIDGET_CACHE_EXPIRATION</td>
            <td>=</td>
            <td class="attr-value">15.minutes</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-accumulation">
            
              <b>accumulation</b>()
            
            <a href="../classes/ObservationsController.html#method-i-accumulation" name="method-i-accumulation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-accumulation_source')" id="l_method-i-accumulation_source">show</a>
                

                

                
              </p>
              <div id="method-i-accumulation_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1892</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">accumulation</span>
<span class="line-num">1893</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:order_by</span>] = <span class="ruby-string">&quot;observed_on&quot;</span>
<span class="line-num">1894</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] = <span class="ruby-string">&quot;asc&quot;</span>
<span class="line-num">1895</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1896</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1897</span>   <span class="ruby-identifier">set_up_instance_variables</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1898</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">query</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1899</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;1 = 2&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">stats_adequately_scoped?</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1900</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">1901</span>     <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;observations.id, observations.user_id, observations.created_at, observations.observed_on, observations.time_observed_at, observations.time_zone, taxa.ancestry, taxon_id&quot;</span>).
<span class="line-num">1902</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;time_observed_at IS NOT NULL&quot;</span>)
<span class="line-num">1903</span>   <span class="ruby-identifier">rows</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_sql</span>)
<span class="line-num">1904</span>   <span class="ruby-identifier">row</span> = <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">first</span>
<span class="line-num">1905</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">1906</span>     {
<span class="line-num">1907</span>       <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;id&#39;</span>].<span class="ruby-identifier">to_i</span>,
<span class="line-num">1908</span>       <span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;user_id&#39;</span>].<span class="ruby-identifier">to_i</span>,
<span class="line-num">1909</span>       <span class="ruby-value">:created_at</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;created_at&#39;</span>]),
<span class="line-num">1910</span>       <span class="ruby-value">:observed_on</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;observed_on&#39;</span>] <span class="ruby-operator">?</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;observed_on&#39;</span>]) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">1911</span>       <span class="ruby-value">:time_observed_at</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;time_observed_at&#39;</span>] <span class="ruby-operator">?</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;time_observed_at&#39;</span>]).<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;time_zone&#39;</span>]) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">1912</span>       <span class="ruby-value">:offset_hours</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;time_observed_at&#39;</span>]).<span class="ruby-identifier">in_time_zone</span>(<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;time_zone&#39;</span>]).<span class="ruby-identifier">utc_offset</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>,
<span class="line-num">1913</span>       <span class="ruby-value">:ancestry</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;ancestry&#39;</span>],
<span class="line-num">1914</span>       <span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;taxon_id&#39;</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;taxon_id&#39;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1915</span>     }
<span class="line-num">1916</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1917</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1918</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1919</span>       <span class="ruby-ivar">@headless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1920</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1921</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1922</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1923</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1924</span>         <span class="ruby-value">:observations</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>
<span class="line-num">1925</span>       }
<span class="line-num">1926</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1927</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1928</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-add_from_list">
            
              <b>add_from_list</b>()
            
            <a href="../classes/ObservationsController.html#method-i-add_from_list" name="method-i-add_from_list" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_from_list_source')" id="l_method-i-add_from_list_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_from_list_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1203</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_from_list</span>
<span class="line-num">1204</span>   <span class="ruby-ivar">@order</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;alphabetical&quot;</span>
<span class="line-num">1205</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@list</span> = <span class="ruby-constant">List</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">1206</span>     <span class="ruby-ivar">@cache_key</span> = {<span class="ruby-value">:controller</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;observations&quot;</span>, <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;add_from_list&quot;</span>, <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@list</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:order</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@order</span>}
<span class="line-num">1207</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@cache_key</span>)
<span class="line-num">1208</span>       <span class="ruby-ivar">@listed_taxa</span> = <span class="ruby-ivar">@list</span>.<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">order_by</span>(<span class="ruby-ivar">@order</span>).<span class="ruby-identifier">includes</span>(
<span class="line-num">1209</span>         <span class="ruby-value">taxon:</span> [<span class="ruby-value">:photos</span>, { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> } ]).<span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">1000</span>)
<span class="line-num">1210</span>       <span class="ruby-ivar">@listed_taxa_alphabetical</span> = <span class="ruby-ivar">@listed_taxa</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">sort!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">default_name</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">default_name</span>.<span class="ruby-identifier">name</span>}
<span class="line-num">1211</span>       <span class="ruby-ivar">@listed_taxa</span> = <span class="ruby-ivar">@listed_taxa_alphabetical</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@order</span> <span class="ruby-operator">==</span> <span class="ruby-constant">ListedTaxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ALPHABETICAL_ORDER</span>
<span class="line-num">1212</span>       <span class="ruby-ivar">@taxon_ids_by_name</span> = {}
<span class="line-num">1213</span>       <span class="ruby-identifier">ancestor_ids</span> = <span class="ruby-ivar">@listed_taxa</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">lt</span><span class="ruby-operator">|</span> <span class="ruby-identifier">lt</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;/&#39;</span>)}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1214</span>       <span class="ruby-ivar">@orders</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">rank:</span> <span class="ruby-string">&quot;order&quot;</span>, <span class="ruby-value">id:</span> <span class="ruby-identifier">ancestor_ids</span>).<span class="ruby-identifier">order</span>(<span class="ruby-value">:ancestry</span>)
<span class="line-num">1215</span>       <span class="ruby-ivar">@families</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">rank:</span> <span class="ruby-string">&quot;family&quot;</span>, <span class="ruby-value">id:</span> <span class="ruby-identifier">ancestor_ids</span>).<span class="ruby-identifier">order</span>(<span class="ruby-value">:ancestry</span>)
<span class="line-num">1216</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1217</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1218</span>   <span class="ruby-ivar">@user_lists</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">lists</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">1219</span>   
<span class="line-num">1220</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1221</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1222</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> <span class="ruby-keyword">do</span>
<span class="line-num">1223</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@cache_key</span>)
<span class="line-num">1224</span>         <span class="ruby-identifier">render</span> <span class="ruby-identifier">read_fragment</span>(<span class="ruby-ivar">@cache_key</span>)
<span class="line-num">1225</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1226</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;add_from_list.html.erb&#39;</span>
<span class="line-num">1227</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1228</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1229</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1230</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-by_login">
            
              <b>by_login</b>()
            
            <a href="../classes/ObservationsController.html#method-i-by_login" name="method-i-by_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>gets observations by user login</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-by_login_source')" id="l_method-i-by_login_source">show</a>
                

                

                
              </p>
              <div id="method-i-by_login_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1248</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">by_login</span>
<span class="line-num">1249</span>   <span class="ruby-identifier">block_if_spammer</span>(<span class="ruby-ivar">@selected_user</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">return</span>
<span class="line-num">1250</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1251</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:viewer</span>] = <span class="ruby-identifier">current_user</span>
<span class="line-num">1252</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:filter_spam</span>] = (<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@selected_user</span>)
<span class="line-num">1253</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:order_by</span>] <span class="ruby-operator">||=</span> <span class="ruby-ivar">@prefs</span>[<span class="ruby-string">&quot;edit_observations_order&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@prefs</span>[<span class="ruby-string">&quot;edit_observations_order&quot;</span>]
<span class="line-num">1254</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||=</span> <span class="ruby-ivar">@prefs</span>[<span class="ruby-string">&quot;edit_observations_sort&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@prefs</span>[<span class="ruby-string">&quot;edit_observations_sort&quot;</span>]
<span class="line-num">1255</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1256</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1257</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">apply_pagination_options</span>(<span class="ruby-identifier">search_params</span>,
<span class="line-num">1258</span>     <span class="ruby-value">user_preferences:</span> <span class="ruby-ivar">@prefs</span>)
<span class="line-num">1259</span>   <span class="ruby-comment"># Since this page is really only intended for the observer, omit obscured</span>
<span class="line-num">1260</span>   <span class="ruby-comment"># observations unless the viewer is trusted</span>
<span class="line-num">1261</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">trusts?</span>( <span class="ruby-identifier">current_user</span> )
<span class="line-num">1262</span>     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:geoprivacy</span>] = <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1263</span>     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:taxon_geoprivacy</span>] = <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>
<span class="line-num">1264</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1265</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1266</span>   <span class="ruby-identifier">set_up_instance_variables</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1267</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>)
<span class="line-num">1268</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1269</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1270</span>       <span class="ruby-identifier">prepare_map</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1271</span>       <span class="ruby-ivar">@observer_provider_authorizations</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">provider_authorizations</span>
<span class="line-num">1272</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1273</span>         <span class="ruby-ivar">@project_users</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;projects.title&quot;</span>)
<span class="line-num">1274</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@proj_obs_errors</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">read</span>(<span class="ruby-node">&quot;proj_obs_errors_#{current_user.id}&quot;</span>) 
<span class="line-num">1275</span>           <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-ivar">@proj_obs_errors</span>[<span class="ruby-value">:project_id</span>])
<span class="line-num">1276</span>           <span class="ruby-ivar">@proj_obs_errors_obs</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.
<span class="line-num">1277</span>             <span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@proj_obs_errors</span>[<span class="ruby-value">:errors</span>].<span class="ruby-identifier">keys</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:photos</span>, <span class="ruby-value">:taxon</span>)
<span class="line-num">1278</span>           <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-node">&quot;proj_obs_errors_#{current_user.id}&quot;</span>)
<span class="line-num">1279</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1280</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1281</span>       
<span class="line-num">1282</span>       <span class="ruby-keyword">if</span> (<span class="ruby-identifier">partial</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">PARTIALS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">partial</span>)
<span class="line-num">1283</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">render_observations_partial</span>(<span class="ruby-identifier">partial</span>)
<span class="line-num">1284</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1285</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1286</span>     
<span class="line-num">1287</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1288</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">timestamp</span> = <span class="ruby-constant">Chronic</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:updated_since</span>])
<span class="line-num">1289</span>         <span class="ruby-identifier">deleted_observation_ids</span> = <span class="ruby-constant">DeletedObservation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;user_id = ? AND created_at &gt;= ?&quot;</span>, <span class="ruby-ivar">@selected_user</span>, <span class="ruby-identifier">timestamp</span>).
<span class="line-num">1290</span>           <span class="ruby-identifier">select</span>(<span class="ruby-value">:observation_id</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:observation_id</span>)
<span class="line-num">1291</span>         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&#39;X-Deleted-Observations&#39;</span>] = <span class="ruby-identifier">deleted_observation_ids</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="line-num">1292</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1293</span>       <span class="ruby-identifier">render_observations_to_json</span>
<span class="line-num">1294</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1295</span>     
<span class="line-num">1296</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">kml</span> <span class="ruby-keyword">do</span>
<span class="line-num">1297</span>       <span class="ruby-identifier">render_observations_to_kml</span>(
<span class="line-num">1298</span>         <span class="ruby-value">:snippet</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for User: #{@selected_user.login}&quot;</span>,
<span class="line-num">1299</span>         <span class="ruby-value">:description</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for User: #{@selected_user.login}&quot;</span>,
<span class="line-num">1300</span>         <span class="ruby-value">:name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for User: #{@selected_user.login}&quot;</span>
<span class="line-num">1301</span>       )
<span class="line-num">1302</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1303</span> 
<span class="line-num">1304</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">atom</span>
<span class="line-num">1305</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span>
<span class="line-num">1306</span>       <span class="ruby-identifier">render_observations_to_csv</span>(<span class="ruby-value">:show_private</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">1307</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1308</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">widget</span> <span class="ruby-keyword">do</span>
<span class="line-num">1309</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:markup_only</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;true&#39;</span>
<span class="line-num">1310</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget.html.erb&quot;</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1311</span>           <span class="ruby-value">:show_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:target</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:target</span>], <span class="ruby-value">:default_image</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:default_image</span>], <span class="ruby-value">:silence</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:silence</span>]
<span class="line-num">1312</span>         })
<span class="line-num">1313</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1314</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget.js.erb&quot;</span>)
<span class="line-num">1315</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1316</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1317</span>     
<span class="line-num">1318</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1319</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalServerError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1320</span>   <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/window is too large/</span>
<span class="line-num">1321</span>   <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Too many results. Try using smaller searches or the id_above parameter.&quot;</span>
<span class="line-num">1322</span>   <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Error&quot;</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1323</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1324</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1325</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1326</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observations_by_login_path</span>( <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">login</span> )
<span class="line-num">1327</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1328</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> } }
<span class="line-num">1329</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">all</span> { <span class="ruby-ivar">@observations</span> = [] }
<span class="line-num">1330</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1331</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-by_login_all">
            
              <b>by_login_all</b>()
            
            <a href="../classes/ObservationsController.html#method-i-by_login_all" name="method-i-by_login_all" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-by_login_all_source')" id="l_method-i-by_login_all_source">show</a>
                

                

                
              </p>
              <div id="method-i-by_login_all_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1333</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">by_login_all</span>
<span class="line-num">1334</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1335</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>)
<span class="line-num">1336</span>     <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">root_url</span>)
<span class="line-num">1337</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1338</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1339</span>   <span class="ruby-identifier">path_for_csv</span> = <span class="ruby-identifier">private_page_cache_path</span>(<span class="ruby-node">&quot;observations/#{@selected_user.login}.all.csv&quot;</span>)
<span class="line-num">1340</span>   <span class="ruby-identifier">delayed_csv</span>(<span class="ruby-identifier">path_for_csv</span>, <span class="ruby-ivar">@selected_user</span>)
<span class="line-num">1341</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-community_taxon_summary">
            
              <b>community_taxon_summary</b>()
            
            <a href="../classes/ObservationsController.html#method-i-community_taxon_summary" name="method-i-community_taxon_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-community_taxon_summary_source')" id="l_method-i-community_taxon_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-community_taxon_summary_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">2012</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">community_taxon_summary</span>
<span class="line-num">2013</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;community_taxon_summary&quot;</span>
<span class="line-num">2014</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-compare">
            
              <b>compare</b>()
            
            <a href="../classes/ObservationsController.html#method-i-compare" name="method-i-compare" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-compare_source')" id="l_method-i-compare_source">show</a>
                

                

                
              </p>
              <div id="method-i-compare_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1810</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">compare</span>
<span class="line-num">1811</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1812</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create">
            
              <b>create</b>()
            
            <a href="../classes/ObservationsController.html#method-i-create" name="method-i-create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>POST /observations POST /observations.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_source')" id="l_method-i-create_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">529</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create</span>
<span class="line-num">530</span>   <span class="ruby-comment"># Handle the case of a single obs</span>
<span class="line-num">531</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>] = [[<span class="ruby-string">&#39;0&#39;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>]]] <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>]
<span class="line-num">532</span>   
<span class="line-num">533</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">534</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">535</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">536</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:no_observations_submitted</span>)
<span class="line-num">537</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">new_observation_path</span>
<span class="line-num">538</span>       <span class="ruby-keyword">end</span>
<span class="line-num">539</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;No observations submitted!&quot;</span> }
<span class="line-num">540</span>     <span class="ruby-keyword">end</span>
<span class="line-num">541</span>     <span class="ruby-keyword">return</span>
<span class="line-num">542</span>   <span class="ruby-keyword">end</span>
<span class="line-num">543</span>   
<span class="line-num">544</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>].<span class="ruby-identifier">to_h</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fieldset_index</span>, <span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">545</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">546</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&#39;fieldset_index&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>[<span class="ruby-value">:fieldset_index</span>]
<span class="line-num">547</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Parameters</span> )
<span class="line-num">548</span>       <span class="ruby-identifier">observation</span> = <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Parameters</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">observation</span> )
<span class="line-num">549</span>     <span class="ruby-keyword">end</span>
<span class="line-num">550</span> 
<span class="line-num">551</span>     <span class="ruby-comment"># If the client is trying to create an observation that already exists,</span>
<span class="line-num">552</span>     <span class="ruby-comment"># update that observation instead of returning an error. This is meant to</span>
<span class="line-num">553</span>     <span class="ruby-comment"># handle cases where the client submits a create request, the server</span>
<span class="line-num">554</span>     <span class="ruby-comment"># receives it, but the client loses its connection before receiving a</span>
<span class="line-num">555</span>     <span class="ruby-comment"># response. The client then thinks the request was not successful and</span>
<span class="line-num">556</span>     <span class="ruby-comment"># tries to submit a create request again when it has network. We are not</span>
<span class="line-num">557</span>     <span class="ruby-comment"># simply returning the existing state of the observation here because the</span>
<span class="line-num">558</span>     <span class="ruby-comment"># client might have changed its copy of the observation in the interim.</span>
<span class="line-num">559</span>     <span class="ruby-identifier">o</span> = <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>[<span class="ruby-value">:uuid</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">560</span>       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">uuid:</span> <span class="ruby-identifier">observation</span>[<span class="ruby-value">:uuid</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">561</span>     <span class="ruby-keyword">end</span>
<span class="line-num">562</span>     <span class="ruby-comment"># when we add UUIDs to everything and either stop using strings or</span>
<span class="line-num">563</span>     <span class="ruby-comment"># ensure that everything is lowercase, we can stop doing this</span>
<span class="line-num">564</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation</span>[<span class="ruby-value">:uuid</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">565</span>       <span class="ruby-identifier">o</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">uuid:</span> <span class="ruby-identifier">observation</span>[<span class="ruby-value">:uuid</span>].<span class="ruby-identifier">downcase</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">566</span>     <span class="ruby-keyword">end</span>
<span class="line-num">567</span> 
<span class="line-num">568</span>     <span class="ruby-identifier">o</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">new</span>
<span class="line-num">569</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">assign_attributes</span>(<span class="ruby-identifier">observation_params</span>(<span class="ruby-identifier">observation</span>))
<span class="line-num">570</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">571</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">editing_user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">572</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user_agent</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">user_agent</span>
<span class="line-num">573</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">site_id</span>
<span class="line-num">574</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">site</span> = <span class="ruby-ivar">@site</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">site</span>
<span class="line-num">575</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">site</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">site</span>.<span class="ruby-identifier">becomes</span>(<span class="ruby-constant">Site</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">site</span>
<span class="line-num">576</span>     <span class="ruby-keyword">end</span>
<span class="line-num">577</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">doorkeeper_token</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">a</span> = <span class="ruby-identifier">doorkeeper_token</span>.<span class="ruby-identifier">application</span>)
<span class="line-num">578</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">oauth_application</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">becomes</span>(<span class="ruby-constant">OauthApplication</span>)
<span class="line-num">579</span>     <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">auth_header</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;Authorization&quot;</span>] ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">token</span> = <span class="ruby-identifier">auth_header</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot; &quot;</span>).<span class="ruby-identifier">last</span> )
<span class="line-num">580</span>       <span class="ruby-identifier">jwt_claims</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">581</span>         <span class="ruby-operator">::</span><span class="ruby-constant">JsonWebToken</span>.<span class="ruby-identifier">decode</span>(<span class="ruby-identifier">token</span>)
<span class="line-num">582</span>       <span class="ruby-keyword">rescue</span> <span class="ruby-constant">JWT</span><span class="ruby-operator">::</span><span class="ruby-constant">DecodeError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">583</span>         <span class="ruby-keyword">nil</span>
<span class="line-num">584</span>       <span class="ruby-keyword">end</span>
<span class="line-num">585</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">jwt_claims</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">oauth_application_id</span> = <span class="ruby-identifier">jwt_claims</span>[<span class="ruby-string">&quot;oauth_application_id&quot;</span>] )
<span class="line-num">586</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">oauth_application_id</span> = <span class="ruby-identifier">oauth_application_id</span>
<span class="line-num">587</span>       <span class="ruby-keyword">end</span>
<span class="line-num">588</span>     <span class="ruby-keyword">end</span>
<span class="line-num">589</span> 
<span class="line-num">590</span>     <span class="ruby-comment"># We will process the photos if this is really a new observation or if the</span>
<span class="line-num">591</span>     <span class="ruby-comment"># client actually specified some photos. Without this, there&#39;s a</span>
<span class="line-num">592</span>     <span class="ruby-comment"># significant risk clients will resubmit photos without the local_photos</span>
<span class="line-num">593</span>     <span class="ruby-comment"># param and we&#39;ll assume its absence means the client wants to remove</span>
<span class="line-num">594</span>     <span class="ruby-comment"># existing photos</span>
<span class="line-num">595</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:local_photos</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">596</span>       <span class="ruby-comment"># Get photos</span>
<span class="line-num">597</span>       <span class="ruby-comment"># This is kind of double-protection against deleting existing photos</span>
<span class="line-num">598</span>       <span class="ruby-identifier">photos</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">photos</span>
<span class="line-num">599</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">subclasses</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">600</span>         <span class="ruby-identifier">klass_key</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>
<span class="line-num">601</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>][<span class="ruby-identifier">fieldset_index</span>]
<span class="line-num">602</span>           <span class="ruby-identifier">photos</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">retrieve_photos</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>][<span class="ruby-identifier">fieldset_index</span>],
<span class="line-num">603</span>             <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-value">:photo_class</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">klass</span>)
<span class="line-num">604</span>         <span class="ruby-keyword">end</span>
<span class="line-num">605</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;#{klass_key}_to_sync&quot;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;#{klass_key}_to_sync&quot;</span>][<span class="ruby-identifier">fieldset_index</span>]
<span class="line-num">606</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">last</span>
<span class="line-num">607</span>             <span class="ruby-identifier">photo_o</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">to_observation</span>
<span class="line-num">608</span>             <span class="ruby-constant">PHOTO_SYNC_ATTRS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">609</span>               <span class="ruby-identifier">o</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{a}=&quot;</span>, <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>).<span class="ruby-identifier">blank?</span>
<span class="line-num">610</span>             <span class="ruby-keyword">end</span>
<span class="line-num">611</span>           <span class="ruby-keyword">end</span>
<span class="line-num">612</span>         <span class="ruby-keyword">end</span>
<span class="line-num">613</span>       <span class="ruby-keyword">end</span>
<span class="line-num">614</span>       <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">last</span>
<span class="line-num">615</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">photo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_observation</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:uploader</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">616</span>           (<span class="ruby-identifier">o</span>.<span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span>)
<span class="line-num">617</span>         <span class="ruby-identifier">photo_o</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">to_observation</span>
<span class="line-num">618</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">observed_on_string</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">619</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">observed_on_string</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">observed_on_string</span>
<span class="line-num">620</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">observed_on</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">observed_on</span>
<span class="line-num">621</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">time_observed_at</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">time_observed_at</span>
<span class="line-num">622</span>         <span class="ruby-keyword">end</span>
<span class="line-num">623</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">624</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">latitude</span>
<span class="line-num">625</span>           <span class="ruby-identifier">o</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">longitude</span>
<span class="line-num">626</span>         <span class="ruby-keyword">end</span>
<span class="line-num">627</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">628</span>         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">species_guess</span> = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">species_guess</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">species_guess</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">629</span>       <span class="ruby-keyword">end</span>
<span class="line-num">630</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">photos</span> = <span class="ruby-identifier">ensure_photos_are_local_photos</span>( <span class="ruby-identifier">photos</span> )
<span class="line-num">631</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">will_be_saved_with_photos</span> = <span class="ruby-keyword">true</span>
<span class="line-num">632</span>     <span class="ruby-keyword">end</span>
<span class="line-num">633</span> 
<span class="line-num">634</span>     <span class="ruby-comment"># Same logic we use for photos: try to avoid deleting sounds if they</span>
<span class="line-num">635</span>     <span class="ruby-comment"># weren&#39;t specified, but make sure we add them for new reocrds</span>
<span class="line-num">636</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:local_sounds</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">637</span>       <span class="ruby-identifier">new_sounds</span> = <span class="ruby-constant">Sound</span>.<span class="ruby-identifier">from_observation_params</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">fieldset_index</span>, <span class="ruby-identifier">current_user</span>)
<span class="line-num">638</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">sounds</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ensure_sounds_are_local_sounds</span>( <span class="ruby-identifier">new_sounds</span> )
<span class="line-num">639</span>     <span class="ruby-keyword">end</span>
<span class="line-num">640</span> 
<span class="line-num">641</span>     <span class="ruby-comment"># make sure the obs get a valid observed_on, needed to determine research grade</span>
<span class="line-num">642</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">munge_observed_on_with_chronic</span>
<span class="line-num">643</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">set_quality_grade</span>
<span class="line-num">644</span>     <span class="ruby-identifier">o</span>
<span class="line-num">645</span>   <span class="ruby-keyword">end</span>
<span class="line-num">646</span>   
<span class="line-num">647</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">648</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">649</span>     <span class="ruby-comment"># all observations will be indexed later, after all associated records</span>
<span class="line-num">650</span>     <span class="ruby-comment"># have been created, just before responding</span>
<span class="line-num">651</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">652</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">save</span>
<span class="line-num">653</span>   <span class="ruby-keyword">end</span>
<span class="line-num">654</span>   <span class="ruby-identifier">create_project_observations</span>
<span class="line-num">655</span>   <span class="ruby-identifier">update_user_account</span>
<span class="line-num">656</span> 
<span class="line-num">657</span>   <span class="ruby-comment"># check for errors</span>
<span class="line-num">658</span>   <span class="ruby-identifier">errors</span> = <span class="ruby-keyword">false</span>
<span class="line-num">659</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:uploader</span>]
<span class="line-num">660</span>     <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">obs</span><span class="ruby-operator">|</span>
<span class="line-num">661</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:project_observations</span>)
<span class="line-num">662</span>       <span class="ruby-identifier">errors</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">663</span>     }
<span class="line-num">664</span>   <span class="ruby-keyword">else</span>
<span class="line-num">665</span>     <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">obs</span><span class="ruby-operator">|</span> <span class="ruby-identifier">errors</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">valid?</span> }
<span class="line-num">666</span>   <span class="ruby-keyword">end</span>
<span class="line-num">667</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">668</span>     <span class="ruby-value">ids:</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> ),
<span class="line-num">669</span>     <span class="ruby-value">wait_for_index_refresh:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:force_refresh</span>]
<span class="line-num">670</span>   )
<span class="line-num">671</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">672</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">673</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">errors</span>
<span class="line-num">674</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:success_msg</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:observations_saved</span>)
<span class="line-num">675</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:save_and_add_another</span>)
<span class="line-num">676</span>           <span class="ruby-identifier">o</span> = <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">first</span>
<span class="line-num">677</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;new&#39;</span>, 
<span class="line-num">678</span>             <span class="ruby-value">:latitude</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">coordinates_obscured?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span>, 
<span class="line-num">679</span>             <span class="ruby-value">:longitude</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">coordinates_obscured?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">longitude</span>, 
<span class="line-num">680</span>             <span class="ruby-value">:place_guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">place_guess</span>, 
<span class="line-num">681</span>             <span class="ruby-value">:observed_on_string</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">observed_on_string</span>,
<span class="line-num">682</span>             <span class="ruby-value">:location_is_exact</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">location_is_exact</span>,
<span class="line-num">683</span>             <span class="ruby-value">:map_scale</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">map_scale</span>,
<span class="line-num">684</span>             <span class="ruby-value">:positional_accuracy</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">positional_accuracy</span>,
<span class="line-num">685</span>             <span class="ruby-value">:positioning_method</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">positioning_method</span>,
<span class="line-num">686</span>             <span class="ruby-value">:positioning_device</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">positioning_device</span>,
<span class="line-num">687</span>             <span class="ruby-value">:project_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]
<span class="line-num">688</span>         <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">689</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observation_path</span>(<span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">first</span>)
<span class="line-num">690</span>         <span class="ruby-keyword">else</span>
<span class="line-num">691</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observations_by_login_path</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span> )
<span class="line-num">692</span>         <span class="ruby-keyword">end</span>
<span class="line-num">693</span>       <span class="ruby-keyword">else</span>
<span class="line-num">694</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">695</span>           <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>
<span class="line-num">696</span>             <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">place</span>
<span class="line-num">697</span>             <span class="ruby-ivar">@project_curators</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;role IN (?)&quot;</span>, [<span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>])
<span class="line-num">698</span>             <span class="ruby-ivar">@tracking_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tracking_code</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">tracking_code_allowed?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:tracking_code</span>])
<span class="line-num">699</span>             <span class="ruby-ivar">@kml_assets</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_assets</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">asset_file_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\.km[lz]$/</span>}
<span class="line-num">700</span>           <span class="ruby-keyword">end</span>
<span class="line-num">701</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;new&#39;</span>
<span class="line-num">702</span>         <span class="ruby-keyword">else</span>
<span class="line-num">703</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;edit_batch&#39;</span>
<span class="line-num">704</span>         <span class="ruby-keyword">end</span>
<span class="line-num">705</span>       <span class="ruby-keyword">end</span>
<span class="line-num">706</span>     <span class="ruby-keyword">end</span>
<span class="line-num">707</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">708</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>
<span class="line-num">709</span>         <span class="ruby-identifier">json</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_iphone_app_2?</span>
<span class="line-num">710</span>           {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">to_sentence</span>}
<span class="line-num">711</span>         <span class="ruby-keyword">else</span>
<span class="line-num">712</span>           {<span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>}}
<span class="line-num">713</span>         <span class="ruby-keyword">end</span>
<span class="line-num">714</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">json</span>, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>
<span class="line-num">715</span>       <span class="ruby-keyword">else</span>
<span class="line-num">716</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_iphone_app_2?</span>
<span class="line-num">717</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_json</span>(
<span class="line-num">718</span>             <span class="ruby-value">:viewer</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">719</span>             <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_login</span>, <span class="ruby-value">:iconic_taxon_name</span>],
<span class="line-num">720</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">721</span>               <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">722</span>             }
<span class="line-num">723</span>           )
<span class="line-num">724</span>         <span class="ruby-keyword">else</span>
<span class="line-num">725</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-value">viewer:</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">726</span>             <span class="ruby-value">methods:</span> [ <span class="ruby-value">:user_login</span>, <span class="ruby-value">:iconic_taxon_name</span>, <span class="ruby-value">:project_observations</span> ])
<span class="line-num">727</span>         <span class="ruby-keyword">end</span>
<span class="line-num">728</span>       <span class="ruby-keyword">end</span>
<span class="line-num">729</span>     <span class="ruby-keyword">end</span>
<span class="line-num">730</span>   <span class="ruby-keyword">end</span>
<span class="line-num">731</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-curation">
            
              <b>curation</b>()
            
            <a href="../classes/ObservationsController.html#method-i-curation" name="method-i-curation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Custom actions ############################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-curation_source')" id="l_method-i-curation_source">show</a>
                

                

                
              </p>
              <div id="method-i-curation_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">986</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">curation</span>
<span class="line-num">987</span>   <span class="ruby-ivar">@flags</span> = <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">resolved:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">flaggable_type:</span> <span class="ruby-string">&quot;Observation&quot;</span>).
<span class="line-num">988</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>, <span class="ruby-value">:flaggable</span>).
<span class="line-num">989</span>     <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>])
<span class="line-num">990</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-delete_batch">
            
              <b>delete_batch</b>()
            
            <a href="../classes/ObservationsController.html#method-i-delete_batch" name="method-i-delete_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-delete_batch_source')" id="l_method-i-delete_batch_source">show</a>
                

                

                
              </p>
              <div id="method-i-delete_batch_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1094</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">delete_batch</span>
<span class="line-num">1095</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:o</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>), <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1096</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">1097</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">1098</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1099</span>   
<span class="line-num">1100</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1101</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1102</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:observations_deleted</span>)
<span class="line-num">1103</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observations_by_login_path</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">1104</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1105</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Observations deleted.&quot;</span>, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">200</span> }
<span class="line-num">1106</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1107</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy">
            
              <b>destroy</b>()
            
            <a href="../classes/ObservationsController.html#method-i-destroy" name="method-i-destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>DELETE /observations/1 DELETE /observations/1.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_source')" id="l_method-i-destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">969</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
<span class="line-num">970</span>   <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">wait_for_index_refresh</span> = <span class="ruby-keyword">true</span>
<span class="line-num">971</span>   <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">972</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">973</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">974</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:observation_was_deleted</span>)
<span class="line-num">975</span>       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">observations_by_login_path</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">976</span>     <span class="ruby-keyword">end</span>
<span class="line-num">977</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">head</span> <span class="ruby-value">:ok</span> }
<span class="line-num">978</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">979</span>       <span class="ruby-identifier">head</span> <span class="ruby-value">:ok</span>
<span class="line-num">980</span>     <span class="ruby-keyword">end</span>
<span class="line-num">981</span>   <span class="ruby-keyword">end</span>
<span class="line-num">982</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit">
            
              <b>edit</b>()
            
            <a href="../classes/ObservationsController.html#method-i-edit" name="method-i-edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /observations/1/edit</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_source')" id="l_method-i-edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">475</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit</span>
<span class="line-num">476</span>   <span class="ruby-comment"># Only the owner should be able to see this.</span>
<span class="line-num">477</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">478</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observation_path</span>(<span class="ruby-ivar">@observation</span>)
<span class="line-num">479</span>     <span class="ruby-keyword">return</span>
<span class="line-num">480</span>   <span class="ruby-keyword">end</span>
<span class="line-num">481</span>   
<span class="line-num">482</span>   <span class="ruby-comment"># Make sure user is editing the REAL coordinates</span>
<span class="line-num">483</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">484</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">private_latitude</span>
<span class="line-num">485</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">private_longitude</span>
<span class="line-num">486</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">private_place_guess</span>
<span class="line-num">487</span>   <span class="ruby-keyword">end</span>
<span class="line-num">488</span>   
<span class="line-num">489</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:facebook_photo_id</span>]
<span class="line-num">490</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">491</span>       <span class="ruby-identifier">sync_facebook_photo</span>
<span class="line-num">492</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">APIError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">493</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/OAuthException/</span>
<span class="line-num">494</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">url_for</span>( <span class="ruby-value">controller:</span> <span class="ruby-string">&quot;facebook&quot;</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;options&quot;</span> )
<span class="line-num">495</span>       <span class="ruby-keyword">return</span>
<span class="line-num">496</span>     <span class="ruby-keyword">end</span>
<span class="line-num">497</span>   <span class="ruby-keyword">end</span>
<span class="line-num">498</span>   <span class="ruby-identifier">sync_flickr_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photo_id</span>]
<span class="line-num">499</span>   <span class="ruby-identifier">sync_picasa_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:picasa_photo_id</span>]
<span class="line-num">500</span>   <span class="ruby-identifier">sync_local_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:local_photo_id</span>]
<span class="line-num">501</span>   <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">recently_used_by</span>(<span class="ruby-identifier">current_user</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="line-num">502</span> 
<span class="line-num">503</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">qm</span>.<span class="ruby-identifier">agree?</span>}
<span class="line-num">504</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">captive_flag</span> = <span class="ruby-keyword">true</span>
<span class="line-num">505</span>   <span class="ruby-keyword">end</span>
<span class="line-num">506</span> 
<span class="line-num">507</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:interpolate_coordinates</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">508</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">interpolate_coordinates</span>
<span class="line-num">509</span>   <span class="ruby-keyword">end</span>
<span class="line-num">510</span> 
<span class="line-num">511</span>   <span class="ruby-comment"># If the value of time_zone is actually the zic or IANA time zone, make sure</span>
<span class="line-num">512</span>   <span class="ruby-comment"># it gets set to the Rails time zone name for editing purposes</span>
<span class="line-num">513</span>   <span class="ruby-keyword">if</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">time_zone</span>]
<span class="line-num">514</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">time_zone</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeZone</span><span class="ruby-operator">::</span><span class="ruby-constant">MAPPING</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">time_zone</span>]
<span class="line-num">515</span>   <span class="ruby-keyword">end</span>
<span class="line-num">516</span> 
<span class="line-num">517</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">518</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">519</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">EDIT_PARTIALS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>])
<span class="line-num">520</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>], <span class="ruby-value">:object</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>,
<span class="line-num">521</span>           <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>)
<span class="line-num">522</span>       <span class="ruby-keyword">end</span>
<span class="line-num">523</span>     <span class="ruby-keyword">end</span>
<span class="line-num">524</span>   <span class="ruby-keyword">end</span>
<span class="line-num">525</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit_batch">
            
              <b>edit_batch</b>()
            
            <a href="../classes/ObservationsController.html#method-i-edit_batch" name="method-i-edit_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Edit a batch of observations</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_batch_source')" id="l_method-i-edit_batch_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_batch_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1071</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit_batch</span>
<span class="line-num">1072</span>   <span class="ruby-identifier">observation_ids</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:o</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:o</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>) <span class="ruby-operator">:</span> []
<span class="line-num">1073</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id in (?) AND user_id = ?&quot;</span>, <span class="ruby-identifier">observation_ids</span>, <span class="ruby-identifier">current_user</span>).
<span class="line-num">1074</span>     <span class="ruby-identifier">includes</span>(
<span class="line-num">1075</span>       <span class="ruby-value">:quality_metrics</span>, <span class="ruby-value">:observation_field_values</span>, <span class="ruby-value">:sounds</span>, <span class="ruby-value">:taggings</span>,
<span class="line-num">1076</span>       { <span class="ruby-value">observation_photos:</span> <span class="ruby-value">:photo</span> },
<span class="line-num">1077</span>       { <span class="ruby-value">taxon:</span> { <span class="ruby-value">taxon_photos:</span> <span class="ruby-value">:photo</span> } },
<span class="line-num">1078</span>     )
<span class="line-num">1079</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">1080</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">coordinates_obscured?</span>
<span class="line-num">1081</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_latitude</span>
<span class="line-num">1082</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_longitude</span>
<span class="line-num">1083</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">place_guess</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">private_place_guess</span>
<span class="line-num">1084</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1085</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">qm</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user_id</span>}
<span class="line-num">1086</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">captive_flag</span> = <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">metric</span> <span class="ruby-operator">==</span> <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">qm</span>.<span class="ruby-identifier">agree?</span> <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
<span class="line-num">1087</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1088</span>       <span class="ruby-identifier">o</span>.<span class="ruby-identifier">captive_flag</span> = <span class="ruby-string">&quot;unknown&quot;</span>
<span class="line-num">1089</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1090</span>     <span class="ruby-identifier">o</span>
<span class="line-num">1091</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1092</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit_photos">
            
              <b>edit_photos</b>()
            
            <a href="../classes/ObservationsController.html#method-i-edit_photos" name="method-i-edit_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_photos_source')" id="l_method-i-edit_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">948</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit_photos</span>
<span class="line-num">949</span>   <span class="ruby-ivar">@observation_photos</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_photos</span>
<span class="line-num">950</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation_photos</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">951</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_observation_doesnt_have_any_photos</span>)
<span class="line-num">952</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_observation_path</span>(<span class="ruby-ivar">@observation</span>)
<span class="line-num">953</span>   <span class="ruby-keyword">end</span>
<span class="line-num">954</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-email_export">
            
              <b>email_export</b>()
            
            <a href="../classes/ObservationsController.html#method-i-email_export" name="method-i-email_export" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-email_export_source')" id="l_method-i-email_export_source">show</a>
                

                

                
              </p>
              <div id="method-i-email_export_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1986</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">email_export</span>
<span class="line-num">1987</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">flow_task</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">flow_tasks</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">1988</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">plain:</span> <span class="ruby-string">&quot;Flow task doesn&#39;t exist&quot;</span>
<span class="line-num">1989</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1990</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1991</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1992</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">plain:</span> <span class="ruby-string">&quot;You don&#39;t have permission to do that&quot;</span>
<span class="line-num">1993</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1994</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1995</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">outputs</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">1996</span>     <span class="ruby-constant">Emailer</span>.<span class="ruby-identifier">observations_export_notification</span>(<span class="ruby-identifier">flow_task</span>).<span class="ruby-identifier">deliver_now</span>
<span class="line-num">1997</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">plain:</span> <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">1998</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1999</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">error</span>
<span class="line-num">2000</span>     <span class="ruby-constant">Emailer</span>.<span class="ruby-identifier">observations_export_failed_notification</span>(<span class="ruby-identifier">flow_task</span>).<span class="ruby-identifier">deliver_now</span>
<span class="line-num">2001</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">plain:</span> <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">2002</span>     <span class="ruby-keyword">return</span>
<span class="line-num">2003</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2004</span>   <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">options</span> = <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:email</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">2005</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">save</span>
<span class="line-num">2006</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:ok</span>, <span class="ruby-value">plain:</span> <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">2007</span>   <span class="ruby-keyword">else</span>
<span class="line-num">2008</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">plain:</span> <span class="ruby-identifier">flow_task</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>
<span class="line-num">2009</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2010</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-export">
            
              <b>export</b>()
            
            <a href="../classes/ObservationsController.html#method-i-export" name="method-i-export" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-export_source')" id="l_method-i-export_source">show</a>
                

                

                
              </p>
              <div id="method-i-export_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1165</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">export</span>
<span class="line-num">1166</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flow_task_id</span>]
<span class="line-num">1167</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@flow_task</span> = <span class="ruby-constant">ObservationsExportFlowTask</span>.
<span class="line-num">1168</span>         <span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flow_task_id</span>], <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1169</span>       <span class="ruby-identifier">output</span> = <span class="ruby-ivar">@flow_task</span>.<span class="ruby-identifier">outputs</span>.<span class="ruby-identifier">first</span>
<span class="line-num">1170</span>       <span class="ruby-ivar">@export_url</span> = <span class="ruby-identifier">output</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">uri_join</span>(<span class="ruby-identifier">root_url</span>, <span class="ruby-identifier">output</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">url</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1171</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1172</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1173</span>   <span class="ruby-ivar">@recent_exports</span> = <span class="ruby-constant">ObservationsExportFlowTask</span>.
<span class="line-num">1174</span>     <span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-value">id:</span> <span class="ruby-value">:desc</span> ).<span class="ruby-identifier">limit</span>( <span class="ruby-value">20</span> ).<span class="ruby-identifier">includes</span>( <span class="ruby-value">:outputs</span> )
<span class="line-num">1175</span>   <span class="ruby-ivar">@recent_export_jobs_by_flow_task_id</span> = <span class="ruby-ivar">@recent_exports</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ft</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ft</span>.<span class="ruby-identifier">outputs</span>.<span class="ruby-identifier">blank?</span>}.<span class="ruby-identifier">inject</span>( {} ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">memo</span>, <span class="ruby-identifier">ft</span><span class="ruby-operator">|</span>
<span class="line-num">1176</span>     <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">ft</span>.<span class="ruby-identifier">id</span>] = <span class="ruby-constant">Delayed</span><span class="ruby-operator">::</span><span class="ruby-constant">Job</span>.<span class="ruby-identifier">find_by_unique_hash</span>( <span class="ruby-identifier">ft</span>.<span class="ruby-identifier">enqueue_options</span>[<span class="ruby-value">:unique_hash</span>].<span class="ruby-identifier">to_s</span> )
<span class="line-num">1177</span>     <span class="ruby-identifier">memo</span>
<span class="line-num">1178</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1179</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">String</span> )
<span class="line-num">1180</span>     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">id</span> ) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>}.<span class="ruby-identifier">compact</span>
<span class="line-num">1181</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Array</span> )
<span class="line-num">1182</span>     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>].<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">id</span> ) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>}.<span class="ruby-identifier">compact</span>
<span class="line-num">1183</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1184</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@projects</span>
<span class="line-num">1185</span>     <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">proj</span><span class="ruby-operator">|</span>
<span class="line-num">1186</span>       <span class="ruby-identifier">proj</span>.<span class="ruby-identifier">project_observation_fields</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:observation_field</span>)
<span class="line-num">1187</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>
<span class="line-num">1188</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1189</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation_fields</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1190</span>     <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">recently_used_by</span>(<span class="ruby-identifier">current_user</span>).
<span class="line-num">1191</span>       <span class="ruby-identifier">limit</span>(<span class="ruby-value">50</span>).<span class="ruby-identifier">sort_by</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">of</span><span class="ruby-operator">|</span> <span class="ruby-identifier">of</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num">1192</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1193</span>   <span class="ruby-identifier">set_up_instance_variables</span>(<span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>, <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-value">site:</span> <span class="ruby-ivar">@site</span>))
<span class="line-num">1194</span>   <span class="ruby-ivar">@identification_fields</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@ident_user</span>
<span class="line-num">1195</span>     <span class="ruby-node">%w(taxon_id taxon_name taxon_rank category)</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;ident_by_#{@ident_user.login}:#{a}&quot;</span>}
<span class="line-num">1196</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1197</span>   <span class="ruby-ivar">@hide_spam</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1198</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1199</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1200</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1201</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-fields">
            
              <b>fields</b>()
            
            <a href="../classes/ObservationsController.html#method-i-fields" name="method-i-fields" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-fields_source')" id="l_method-i-fields_source">show</a>
                

                

                
              </p>
              <div id="method-i-fields_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1495</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">fields</span>
<span class="line-num">1496</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1497</span>   <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1498</span>     <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">observation_fields</span>
<span class="line-num">1499</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_fields</span>]
<span class="line-num">1500</span>     <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_fields</span>])
<span class="line-num">1501</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1502</span>     <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">recently_used_by</span>(<span class="ruby-identifier">current_user</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="line-num">1503</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1504</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>
<span class="line-num">1505</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-identify">
            
              <b>identify</b>()
            
            <a href="../classes/ObservationsController.html#method-i-identify" name="method-i-identify" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-identify_source')" id="l_method-i-identify_source">show</a>
                

                

                
              </p>
              <div id="method-i-identify_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1456</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">identify</span>
<span class="line-num">1457</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1458</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-identotron">
            
              <b>identotron</b>()
            
            <a href="../classes/ObservationsController.html#method-i-identotron" name="method-i-identotron" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-identotron_source')" id="l_method-i-identotron_source">show</a>
                

                

                
              </p>
              <div id="method-i-identotron_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1464</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">identotron</span>
<span class="line-num">1465</span>   <span class="ruby-ivar">@observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>((<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>]).<span class="ruby-identifier">to_i</span>)
<span class="line-num">1466</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">1467</span>   <span class="ruby-ivar">@q</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1468</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">1469</span>     <span class="ruby-ivar">@places</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">coordinates_viewable_by?</span>( <span class="ruby-identifier">current_user</span> )
<span class="line-num">1470</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">places</span>
<span class="line-num">1471</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1472</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">public_places</span>
<span class="line-num">1473</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1474</span>     <span class="ruby-ivar">@places</span> = <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">bbox_area</span> }
<span class="line-num">1475</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">species_or_lower?</span>
<span class="line-num">1476</span>       <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">genus</span>
<span class="line-num">1477</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1478</span>       <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">1479</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1480</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@places</span>
<span class="line-num">1481</span>       <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">self_and_descendants_of</span>(<span class="ruby-ivar">@taxon</span>).<span class="ruby-identifier">exists?</span>}
<span class="line-num">1482</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1483</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1484</span>   <span class="ruby-ivar">@place</span> <span class="ruby-operator">||=</span> (<span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>) <span class="ruby-operator">||</span> <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:first</span>)
<span class="line-num">1485</span>   <span class="ruby-ivar">@default_taxa</span> = <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">ancestors</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>
<span class="line-num">1486</span>   <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">LIFE</span>
<span class="line-num">1487</span>   <span class="ruby-ivar">@default_taxa</span> = [<span class="ruby-ivar">@default_taxa</span>, <span class="ruby-ivar">@taxon</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1488</span>   <span class="ruby-ivar">@establishment_means</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:establishment_means</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ListedTaxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ESTABLISHMENT_MEANS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:establishment_means</span>])
<span class="line-num">1489</span> 
<span class="line-num">1490</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1491</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1492</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1493</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import">
            
              <b>import</b>()
            
            <a href="../classes/ObservationsController.html#method-i-import" name="method-i-import" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Import observations from external sources</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_source')" id="l_method-i-import_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1110</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import</span>
<span class="line-num">1111</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@default_photo_identity</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@photo_identities</span>.<span class="ruby-identifier">first</span>
<span class="line-num">1112</span>     <span class="ruby-identifier">provider_name</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@default_photo_identity</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">ProviderAuthorization</span>)
<span class="line-num">1113</span>       <span class="ruby-ivar">@default_photo_identity</span>.<span class="ruby-identifier">photo_source_name</span>
<span class="line-num">1114</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1115</span>       <span class="ruby-ivar">@default_photo_identity</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;_&#39;</span>).<span class="ruby-identifier">first</span>
<span class="line-num">1116</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1117</span>     <span class="ruby-ivar">@default_photo_identity_url</span> = <span class="ruby-node">&quot;/#{provider_name.downcase}/photo_fields?context=user&quot;</span>
<span class="line-num">1118</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1119</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]
<span class="line-num">1120</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">1121</span>     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:project</span>).
<span class="line-num">1122</span>       <span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;lower(projects.title)&quot;</span> ) ).<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:project</span>)
<span class="line-num">1123</span>     <span class="ruby-ivar">@project_templates</span> = {}
<span class="line-num">1124</span>     <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">1125</span>       <span class="ruby-ivar">@project_templates</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">title</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">observation_fields</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:position</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1126</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1127</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1128</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import_photos">
            
              <b>import_photos</b>()
            
            <a href="../classes/ObservationsController.html#method-i-import_photos" name="method-i-import_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_photos_source')" id="l_method-i-import_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_photos_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1130</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_photos</span>
<span class="line-num">1131</span>   <span class="ruby-identifier">photos</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">subclasses</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">1132</span>     <span class="ruby-identifier">retrieve_photos</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>], 
<span class="line-num">1133</span>       <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-value">:photo_class</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">klass</span>)
<span class="line-num">1134</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1135</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">1136</span>     <span class="ruby-identifier">photo_obs</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">to_observation</span>
<span class="line-num">1137</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">PicasaPhoto</span> )
<span class="line-num">1138</span>       <span class="ruby-comment"># Sometimes Google doesn&#39;t return all the metadata for undetermined</span>
<span class="line-num">1139</span>       <span class="ruby-comment"># reasons. See https://github.com/inaturalist/inaturalist/issues/1408</span>
<span class="line-num">1140</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo_obs</span>.<span class="ruby-identifier">observed_on</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">photo_obs</span>.<span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1141</span>         <span class="ruby-identifier">local_photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">local_photo_from_remote_photo</span>( <span class="ruby-identifier">p</span> )
<span class="line-num">1142</span>         <span class="ruby-identifier">photo_obs</span> = <span class="ruby-identifier">local_photo</span>.<span class="ruby-identifier">to_observation</span>
<span class="line-num">1143</span>         <span class="ruby-identifier">photo_obs</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">photo:</span> <span class="ruby-identifier">p</span> )
<span class="line-num">1144</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1145</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1146</span>     <span class="ruby-identifier">photo_obs</span>
<span class="line-num">1147</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1148</span>   <span class="ruby-ivar">@observation_photos</span> = <span class="ruby-constant">ObservationPhoto</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:photo</span>, <span class="ruby-value">:observation</span>).
<span class="line-num">1149</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;photos.native_photo_id IN (?)&quot;</span>, <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:native_photo_id</span>))
<span class="line-num">1150</span>   <span class="ruby-ivar">@step</span> = <span class="ruby-value">2</span>
<span class="line-num">1151</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:template</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;observations/new_batch&#39;</span>
<span class="line-num">1152</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1153</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_that_photo_provider_isnt_responding</span>)
<span class="line-num">1154</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Timeout: #{e}&quot;</span>
<span class="line-num">1155</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;import&quot;</span>
<span class="line-num">1156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-import_sounds">
            
              <b>import_sounds</b>()
            
            <a href="../classes/ObservationsController.html#method-i-import_sounds" name="method-i-import_sounds" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-import_sounds_source')" id="l_method-i-import_sounds_source">show</a>
                

                

                
              </p>
              <div id="method-i-import_sounds_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1158</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_sounds</span>
<span class="line-num">1159</span>   <span class="ruby-identifier">sounds</span> = <span class="ruby-constant">Sound</span>.<span class="ruby-identifier">from_observation_params</span>(<span class="ruby-identifier">params</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">current_user</span>)
<span class="line-num">1160</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">sounds</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_observation</span>}
<span class="line-num">1161</span>   <span class="ruby-ivar">@step</span> = <span class="ruby-value">2</span>
<span class="line-num">1162</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:template</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;observations/new_batch&#39;</span>
<span class="line-num">1163</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index">
            
              <b>index</b>()
            
            <a href="../classes/ObservationsController.html#method-i-index" name="method-i-index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /observations GET /observations.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_source')" id="l_method-i-index_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">101</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
<span class="line-num">102</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>
<span class="line-num">103</span>     <span class="ruby-identifier">authenticate_user!</span>
<span class="line-num">104</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">105</span>   <span class="ruby-keyword">end</span>
<span class="line-num">106</span>   <span class="ruby-identifier">params</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>
<span class="line-num">107</span>   <span class="ruby-identifier">showing_partial</span> = (<span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">PARTIALS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]))
<span class="line-num">108</span>   <span class="ruby-comment"># Humans should see this, but scrapers like social media sites and curls</span>
<span class="line-num">109</span>   <span class="ruby-comment"># will set Accept: */*</span>
<span class="line-num">110</span>   <span class="ruby-identifier">human_or_scraper</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">html?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;*/*&quot;</span>
<span class="line-num">111</span>   <span class="ruby-comment"># the new default /observations doesn&#39;t need any observations</span>
<span class="line-num">112</span>   <span class="ruby-comment"># looked up now as it will use Angular/Node. This is for legacy</span>
<span class="line-num">113</span>   <span class="ruby-comment"># API methods, and HTML/views and partials</span>
<span class="line-num">114</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">human_or_scraper</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">showing_partial</span>
<span class="line-num">115</span>     <span class="ruby-ivar">@shareable_description</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">116</span>       <span class="ruby-identifier">generate_shareable_description</span>
<span class="line-num">117</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">118</span>       <span class="ruby-constant">Logstasher</span>.<span class="ruby-identifier">write_exception</span>( <span class="ruby-identifier">e</span>, <span class="ruby-value">request:</span> <span class="ruby-identifier">request</span>, <span class="ruby-value">session:</span> <span class="ruby-identifier">session</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> )
<span class="line-num">119</span>       <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">120</span>     <span class="ruby-keyword">end</span>
<span class="line-num">121</span>   <span class="ruby-keyword">else</span>
<span class="line-num">122</span>     <span class="ruby-identifier">h</span> = <span class="ruby-identifier">observations_index_search</span>(<span class="ruby-identifier">params</span>)
<span class="line-num">123</span>     <span class="ruby-identifier">params</span> = <span class="ruby-identifier">h</span>[<span class="ruby-value">:params</span>]
<span class="line-num">124</span>     <span class="ruby-identifier">search_params</span> = <span class="ruby-identifier">h</span>[<span class="ruby-value">:search_params</span>]
<span class="line-num">125</span>     <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">h</span>[<span class="ruby-value">:observations</span>]
<span class="line-num">126</span>   <span class="ruby-keyword">end</span>
<span class="line-num">127</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">128</span> 
<span class="line-num">129</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">130</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">showing_partial</span>
<span class="line-num">131</span>         <span class="ruby-identifier">pagination_headers_for</span>(<span class="ruby-ivar">@observations</span>)
<span class="line-num">132</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">render_observations_partial</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>])
<span class="line-num">133</span>       <span class="ruby-keyword">end</span>
<span class="line-num">134</span>       <span class="ruby-comment"># one of the few things we do in Rails. Look up the taxon_name param</span>
<span class="line-num">135</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">136</span>         <span class="ruby-identifier">sn</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[\s_]+/</span>, <span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">downcase</span>
<span class="line-num">137</span>         <span class="ruby-identifier">t</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">sn</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">138</span>         <span class="ruby-identifier">t</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">sn</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">139</span>         <span class="ruby-identifier">t</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa.is_active AND lower(taxon_names.name) = ?&quot;</span>, <span class="ruby-identifier">sn</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon</span>)
<span class="line-num">140</span>         <span class="ruby-identifier">t</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(taxon_names.name) = ?&quot;</span>, <span class="ruby-identifier">sn</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon</span>)
<span class="line-num">141</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>
<span class="line-num">142</span>           <span class="ruby-identifier">t</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">current_synonymous_taxon</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">is_active?</span>
<span class="line-num">143</span>           <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>] = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>
<span class="line-num">144</span>         <span class="ruby-keyword">end</span>
<span class="line-num">145</span>       <span class="ruby-keyword">end</span>
<span class="line-num">146</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>, <span class="ruby-value">locals:</span> { <span class="ruby-value">params:</span> <span class="ruby-identifier">params</span> }
<span class="line-num">147</span>     <span class="ruby-keyword">end</span>
<span class="line-num">148</span> 
<span class="line-num">149</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">150</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-identifier">logged_in?</span>)
<span class="line-num">151</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">:tags</span>)
<span class="line-num">152</span>       <span class="ruby-identifier">render_observations_to_json</span>
<span class="line-num">153</span>     <span class="ruby-keyword">end</span>
<span class="line-num">154</span>     
<span class="line-num">155</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">geojson</span> <span class="ruby-keyword">do</span>
<span class="line-num">156</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">to_geojson</span>(<span class="ruby-value">:except</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">157</span>         <span class="ruby-value">:geom</span>, <span class="ruby-value">:latitude</span>, <span class="ruby-value">:longitude</span>, <span class="ruby-value">:map_scale</span>, 
<span class="line-num">158</span>         <span class="ruby-value">:num_identification_agreements</span>, <span class="ruby-value">:num_identification_disagreements</span>, 
<span class="line-num">159</span>         <span class="ruby-value">:delta</span>, <span class="ruby-value">:location_is_exact</span>])
<span class="line-num">160</span>     <span class="ruby-keyword">end</span>
<span class="line-num">161</span>     
<span class="line-num">162</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">atom</span> <span class="ruby-keyword">do</span>
<span class="line-num">163</span>       <span class="ruby-ivar">@updated_at</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">updated_at</span>
<span class="line-num">164</span>     <span class="ruby-keyword">end</span>
<span class="line-num">165</span>     
<span class="line-num">166</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">dwc</span> <span class="ruby-keyword">do</span>
<span class="line-num">167</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-identifier">logged_in?</span>)
<span class="line-num">168</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@observations</span>, [ <span class="ruby-value">:identifications</span> ])
<span class="line-num">169</span>     <span class="ruby-keyword">end</span>
<span class="line-num">170</span> 
<span class="line-num">171</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span>
<span class="line-num">172</span>       <span class="ruby-identifier">render_observations_to_csv</span>
<span class="line-num">173</span>     <span class="ruby-keyword">end</span>
<span class="line-num">174</span>     
<span class="line-num">175</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">kml</span> <span class="ruby-keyword">do</span>
<span class="line-num">176</span>       <span class="ruby-identifier">render_observations_to_kml</span>(
<span class="line-num">177</span>         <span class="ruby-value">:snippet</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for Everyone&quot;</span>,
<span class="line-num">178</span>         <span class="ruby-value">:description</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for Everyone&quot;</span>,
<span class="line-num">179</span>         <span class="ruby-value">:name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{@site.name} Feed for Everyone&quot;</span>
<span class="line-num">180</span>       )
<span class="line-num">181</span>     <span class="ruby-keyword">end</span>
<span class="line-num">182</span>     
<span class="line-num">183</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">widget</span> <span class="ruby-keyword">do</span>
<span class="line-num">184</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:markup_only</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;true&#39;</span>
<span class="line-num">185</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget.html.erb&quot;</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">186</span>           <span class="ruby-value">:show_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:target</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:target</span>], <span class="ruby-value">:default_image</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:default_image</span>], <span class="ruby-value">:silence</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:silence</span>]
<span class="line-num">187</span>         })
<span class="line-num">188</span>       <span class="ruby-keyword">else</span>
<span class="line-num">189</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget.js.erb&quot;</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">190</span>           <span class="ruby-value">:show_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>
<span class="line-num">191</span>         })
<span class="line-num">192</span>       <span class="ruby-keyword">end</span>
<span class="line-num">193</span>     <span class="ruby-keyword">end</span>
<span class="line-num">194</span>   <span class="ruby-keyword">end</span>
<span class="line-num">195</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalServerError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">196</span>   <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/window is too large/</span>
<span class="line-num">197</span>   <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;Too many results. Try using smaller searches or the id_above parameter.&quot;</span>
<span class="line-num">198</span>   <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Error&quot;</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">199</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">200</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">201</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">202</span>       <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">observations_path</span> )
<span class="line-num">203</span>     <span class="ruby-keyword">end</span>
<span class="line-num">204</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> } }
<span class="line-num">205</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">all</span> { <span class="ruby-ivar">@observations</span> = [] }
<span class="line-num">206</span>   <span class="ruby-keyword">end</span>
<span class="line-num">207</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-lifelist_by_login">
            
              <b>lifelist_by_login</b>()
            
            <a href="../classes/ObservationsController.html#method-i-lifelist_by_login" name="method-i-lifelist_by_login" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-lifelist_by_login_source')" id="l_method-i-lifelist_by_login_source">show</a>
                

                

                
              </p>
              <div id="method-i-lifelist_by_login_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">259</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lifelist_by_login</span>
<span class="line-num">260</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">261</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-map">
            
              <b>map</b>()
            
            <a href="../classes/ObservationsController.html#method-i-map" name="method-i-map" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-map_source')" id="l_method-i-map_source">show</a>
                

                

                
              </p>
              <div id="method-i-map_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">2016</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">map</span>
<span class="line-num">2017</span>   <span class="ruby-ivar">@taxa</span> = [ ]
<span class="line-num">2018</span>   <span class="ruby-ivar">@places</span> = [ ]
<span class="line-num">2019</span>   <span class="ruby-ivar">@user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>])
<span class="line-num">2020</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">2021</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>]
<span class="line-num">2022</span>     <span class="ruby-ivar">@taxa</span> = [ <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>) ]
<span class="line-num">2023</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_ids</span>]
<span class="line-num">2024</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_ids</span>])
<span class="line-num">2025</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2026</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]
<span class="line-num">2027</span>     <span class="ruby-ivar">@places</span> = [ <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">to_i</span>) ]
<span class="line-num">2028</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_ids</span>]
<span class="line-num">2029</span>     <span class="ruby-ivar">@places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_ids</span>])
<span class="line-num">2030</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2031</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:render_place_id</span>]
<span class="line-num">2032</span>     <span class="ruby-ivar">@render_place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:render_place_id</span>])
<span class="line-num">2033</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2034</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">2035</span>     <span class="ruby-ivar">@taxon</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">first</span>
<span class="line-num">2036</span>     <span class="ruby-ivar">@taxon_hash</span> = { }
<span class="line-num">2037</span>     <span class="ruby-identifier">common_name</span> = <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">common_taxon_name</span>( <span class="ruby-ivar">@taxon</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> ).<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">2038</span>     <span class="ruby-identifier">rank_label</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">t</span>(<span class="ruby-string">&#39;ranks.#{ @taxon.rank.downcase }&#39;</span>,
<span class="line-num">2039</span>       <span class="ruby-value">default:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">rank</span>).<span class="ruby-identifier">capitalize</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:unknown_rank</span>)
<span class="line-num">2040</span>     <span class="ruby-identifier">display_name</span> = <span class="ruby-identifier">common_name</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">rank_label</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>)
<span class="line-num">2041</span>     <span class="ruby-ivar">@taxon_hash</span>[<span class="ruby-value">:display_label</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-value">:observations_of_taxon</span>,
<span class="line-num">2042</span>       <span class="ruby-value">taxon_name:</span> <span class="ruby-identifier">display_name</span>)
<span class="line-num">2043</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">iconic_taxon</span>
<span class="line-num">2044</span>       <span class="ruby-ivar">@taxon_hash</span>[<span class="ruby-value">:iconic_taxon_name</span>] = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">iconic_taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">2045</span>     <span class="ruby-keyword">end</span>
<span class="line-num">2046</span>   <span class="ruby-keyword">end</span>
<span class="line-num">2047</span>   <span class="ruby-ivar">@elastic_params</span> = <span class="ruby-identifier">valid_map_params</span>
<span class="line-num">2048</span>   <span class="ruby-ivar">@default_color</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:color</span>] <span class="ruby-operator">||</span> (<span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;heatmap&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
<span class="line-num">2049</span>   <span class="ruby-ivar">@map_style</span> = (( <span class="ruby-identifier">params</span>[<span class="ruby-value">:color</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">any?</span> ) <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">2050</span>                   <span class="ruby-identifier">params</span>[<span class="ruby-value">:color</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;heatmap&quot;</span> ) <span class="ruby-operator">?</span> <span class="ruby-string">&quot;grid&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;heatmap&quot;</span>
<span class="line-num">2051</span>   <span class="ruby-ivar">@map_type</span> = ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;map&quot;</span> ) <span class="ruby-operator">?</span> <span class="ruby-string">&quot;MAP&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;SATELLITE&quot;</span>
<span class="line-num">2052</span>   <span class="ruby-ivar">@default_color</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:heatmap_colors</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@map_style</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;heatmap&quot;</span>
<span class="line-num">2053</span>   <span class="ruby-ivar">@about_url</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">map_about_url</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">wiki_page_url</span>(<span class="ruby-string">&#39;help&#39;</span>, <span class="ruby-value">anchor:</span> <span class="ruby-string">&#39;mapsymbols&#39;</span>) <span class="ruby-operator">:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">map_about_url</span>
<span class="line-num">2054</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-moimport">
            
              <b>moimport</b>()
            
            <a href="../classes/ObservationsController.html#method-i-moimport" name="method-i-moimport" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-moimport_source')" id="l_method-i-moimport_source">show</a>
                

                

                
              </p>
              <div id="method-i-moimport_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1768</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">moimport</span>
<span class="line-num">1769</span>   <span class="ruby-ivar">@removal_date</span> = <span class="ruby-constant">MushroomObserverImportFlowTask</span><span class="ruby-operator">::</span><span class="ruby-constant">REMOVAL_DATE</span>
<span class="line-num">1770</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">render_404</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@removal_date</span>
<span class="line-num">1771</span> 
<span class="line-num">1772</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@api_key</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:api_key</span>]&amp;.<span class="ruby-identifier">strip</span> )
<span class="line-num">1773</span>     <span class="ruby-ivar">@mo_import_task</span> = <span class="ruby-constant">MushroomObserverImportFlowTask</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span> )
<span class="line-num">1774</span>     <span class="ruby-ivar">@mo_url_field</span> = <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">mo_url_observation_field</span>
<span class="line-num">1775</span>     <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">inputs</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">extra:</span> { <span class="ruby-value">api_key:</span> <span class="ruby-ivar">@api_key</span> } )
<span class="line-num">1776</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">1777</span>       <span class="ruby-ivar">@mo_user_id</span> = <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">mo_user_id</span>
<span class="line-num">1778</span>       <span class="ruby-ivar">@mo_user_name</span> = <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">mo_user_name</span>
<span class="line-num">1779</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@mo_user_id</span>
<span class="line-num">1780</span>         <span class="ruby-keyword">begin</span>
<span class="line-num">1781</span>           <span class="ruby-ivar">@results</span> = <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">get_results_xml</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">9</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">|</span>
<span class="line-num">1782</span>             [<span class="ruby-identifier">r</span>, <span class="ruby-ivar">@mo_import_task</span>.<span class="ruby-identifier">observation_from_result</span>( <span class="ruby-identifier">r</span>, <span class="ruby-value">skip_images:</span> <span class="ruby-keyword">true</span> )]
<span class="line-num">1783</span>           <span class="ruby-keyword">end</span>
<span class="line-num">1784</span>         <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">BadGateway</span>
<span class="line-num">1785</span>           <span class="ruby-ivar">@errors</span> <span class="ruby-operator">||=</span> []
<span class="line-num">1786</span>           <span class="ruby-ivar">@errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;Failed to connect to Mushroom Observer&quot;</span>
<span class="line-num">1787</span>         <span class="ruby-keyword">rescue</span> <span class="ruby-constant">MushroomObserverImportFlowTask</span><span class="ruby-operator">::</span><span class="ruby-constant">MushroomObserverImportFlowTaskError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1788</span>           <span class="ruby-ivar">@errors</span> <span class="ruby-operator">||=</span> []
<span class="line-num">1789</span>           <span class="ruby-ivar">@errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">1790</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1791</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1792</span>         <span class="ruby-ivar">@errors</span> <span class="ruby-operator">||=</span> []
<span class="line-num">1793</span>         <span class="ruby-ivar">@errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;No Mushroom Observer use associated with that API key&quot;</span>
<span class="line-num">1794</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1795</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">MushroomObserverImportFlowTask</span><span class="ruby-operator">::</span><span class="ruby-constant">MushroomObserverImportFlowTaskError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1796</span>       <span class="ruby-ivar">@errors</span> <span class="ruby-operator">||=</span> []
<span class="line-num">1797</span>       <span class="ruby-ivar">@errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">1798</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1799</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1800</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">format</span> <span class="ruby-operator">|</span>
<span class="line-num">1801</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span> }
<span class="line-num">1802</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1803</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new">
            
              <b>new</b>()
            
            <a href="../classes/ObservationsController.html#method-i-new" name="method-i-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /observations/new GET /observations/new.xml An attempt at creating a simple new page for batch add</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_source')" id="l_method-i-new_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">379</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new</span>
<span class="line-num">380</span>   <span class="ruby-ivar">@observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">381</span> 
<span class="line-num">382</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:copy</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">copy_obs</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:copy</span>])) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">383</span>     <span class="ruby-node">%w(observed_on_string time_zone zic_time_zone place_guess geoprivacy map_scale positional_accuracy)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">384</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{a}=&quot;</span>, <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>))
<span class="line-num">385</span>     <span class="ruby-keyword">end</span>
<span class="line-num">386</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">private_latitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">latitude</span>
<span class="line-num">387</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">private_longitude</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">longitude</span>
<span class="line-num">388</span>     <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span>
<span class="line-num">389</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">build</span>(<span class="ruby-value">:photo</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>)
<span class="line-num">390</span>     <span class="ruby-keyword">end</span>
<span class="line-num">391</span>     <span class="ruby-identifier">copy_obs</span>.<span class="ruby-identifier">observation_sounds</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">os</span><span class="ruby-operator">|</span>
<span class="line-num">392</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_sounds</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">sound:</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span> )
<span class="line-num">393</span>     <span class="ruby-keyword">end</span>
<span class="line-num">394</span>   <span class="ruby-keyword">end</span>
<span class="line-num">395</span>   
<span class="line-num">396</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">397</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">398</span>     <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(name) = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[\s_]+/</span>, <span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">downcase</span>).
<span class="line-num">399</span>       <span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon</span>)
<span class="line-num">400</span>   <span class="ruby-keyword">end</span>
<span class="line-num">401</span>   
<span class="line-num">402</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">403</span>     <span class="ruby-ivar">@project</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">404</span>       <span class="ruby-constant">Project</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:observation_field</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>])
<span class="line-num">405</span>     <span class="ruby-keyword">else</span>
<span class="line-num">406</span>       <span class="ruby-constant">Project</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:project_observation_fields</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:observation_field</span>).<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">407</span>     <span class="ruby-keyword">end</span>
<span class="line-num">408</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>
<span class="line-num">409</span>       <span class="ruby-ivar">@place</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">place</span>
<span class="line-num">410</span>       <span class="ruby-ivar">@project_curators</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;role IN (?)&quot;</span>, [<span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>])
<span class="line-num">411</span>       <span class="ruby-ivar">@tracking_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tracking_code</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">tracking_code_allowed?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:tracking_code</span>])
<span class="line-num">412</span>       <span class="ruby-ivar">@kml_assets</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_assets</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pa</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pa</span>.<span class="ruby-identifier">asset_file_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\.km[lz]$/</span>}
<span class="line-num">413</span>     <span class="ruby-keyword">end</span>
<span class="line-num">414</span>   <span class="ruby-keyword">end</span>
<span class="line-num">415</span> 
<span class="line-num">416</span>   <span class="ruby-ivar">@place</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">417</span> 
<span class="line-num">418</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">419</span>     <span class="ruby-ivar">@place_geometry</span> = <span class="ruby-constant">PlaceGeometry</span>.<span class="ruby-identifier">without_geom</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">place_id:</span> <span class="ruby-ivar">@place</span>).<span class="ruby-identifier">first</span>
<span class="line-num">420</span>   <span class="ruby-keyword">end</span>
<span class="line-num">421</span>   
<span class="line-num">422</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:facebook_photo_id</span>]
<span class="line-num">423</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">424</span>       <span class="ruby-identifier">sync_facebook_photo</span>
<span class="line-num">425</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">APIError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">426</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/OAuthException/</span>
<span class="line-num">427</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">url_for</span>( <span class="ruby-value">controller:</span> <span class="ruby-string">&quot;facebook&quot;</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;options&quot;</span> )
<span class="line-num">428</span>       <span class="ruby-keyword">return</span>
<span class="line-num">429</span>     <span class="ruby-keyword">end</span>
<span class="line-num">430</span>   <span class="ruby-keyword">end</span>
<span class="line-num">431</span>   <span class="ruby-identifier">sync_flickr_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photo_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">flickr_identity</span>
<span class="line-num">432</span>   <span class="ruby-identifier">sync_picasa_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:picasa_photo_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">picasa_identity</span>
<span class="line-num">433</span>   <span class="ruby-identifier">sync_local_photo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:local_photo_id</span>]
<span class="line-num">434</span>     
<span class="line-num">435</span>   <span class="ruby-ivar">@welcome</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:welcome</span>]
<span class="line-num">436</span>   
<span class="line-num">437</span>   <span class="ruby-comment"># this should happen AFTER photo syncing so params can override attrs</span>
<span class="line-num">438</span>   <span class="ruby-comment"># from the photo</span>
<span class="line-num">439</span>   [<span class="ruby-value">:latitude</span>, <span class="ruby-value">:longitude</span>, <span class="ruby-value">:place_guess</span>, <span class="ruby-value">:location_is_exact</span>, <span class="ruby-value">:map_scale</span>,
<span class="line-num">440</span>       <span class="ruby-value">:positional_accuracy</span>, <span class="ruby-value">:positioning_device</span>, <span class="ruby-value">:positioning_method</span>,
<span class="line-num">441</span>       <span class="ruby-value">:observed_on_string</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obs_attr</span><span class="ruby-operator">|</span>
<span class="line-num">442</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">obs_attr</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">443</span>     <span class="ruby-comment"># sync_photo indicates that the user clicked sync photo, so presumably they&#39;d</span>
<span class="line-num">444</span>     <span class="ruby-comment"># like the photo attrs to override the URL</span>
<span class="line-num">445</span>     <span class="ruby-comment"># invite links are the other case, in which URL params *should* override the</span>
<span class="line-num">446</span>     <span class="ruby-comment"># photo attrs b/c the person who made the invite link chose a taxon or something</span>
<span class="line-num">447</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sync_photo</span>]
<span class="line-num">448</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{obs_attr}=&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">obs_attr</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">obs_attr</span>).<span class="ruby-identifier">blank?</span>
<span class="line-num">449</span>     <span class="ruby-keyword">else</span>
<span class="line-num">450</span>       <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{obs_attr}=&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">obs_attr</span>])
<span class="line-num">451</span>     <span class="ruby-keyword">end</span>
<span class="line-num">452</span>   <span class="ruby-keyword">end</span>
<span class="line-num">453</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">454</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-ivar">@taxon</span>
<span class="line-num">455</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">species_guess</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">common_name</span>
<span class="line-num">456</span>       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">name</span>
<span class="line-num">457</span>     <span class="ruby-keyword">else</span> 
<span class="line-num">458</span>       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">459</span>     <span class="ruby-keyword">end</span>
<span class="line-num">460</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">461</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">species_guess</span> =  <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_name</span>]
<span class="line-num">462</span>   <span class="ruby-keyword">end</span>
<span class="line-num">463</span>   
<span class="line-num">464</span>   <span class="ruby-ivar">@observation_fields</span> = <span class="ruby-constant">ObservationField</span>.<span class="ruby-identifier">recently_used_by</span>(<span class="ruby-identifier">current_user</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="line-num">465</span>   <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">set_time_zone</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">time_zone</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">466</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">467</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">468</span>       <span class="ruby-ivar">@observations</span> = [<span class="ruby-ivar">@observation</span>]
<span class="line-num">469</span>     <span class="ruby-keyword">end</span>
<span class="line-num">470</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span>  { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span> }
<span class="line-num">471</span>   <span class="ruby-keyword">end</span>
<span class="line-num">472</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new_batch">
            
              <b>new_batch</b>()
            
            <a href="../classes/ObservationsController.html#method-i-new_batch" name="method-i-new_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_batch_source')" id="l_method-i-new_batch_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_batch_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num"> 992</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_batch</span>
<span class="line-num"> 993</span>   <span class="ruby-ivar">@step</span> = <span class="ruby-value">1</span>
<span class="line-num"> 994</span>   <span class="ruby-ivar">@observations</span> = []
<span class="line-num"> 995</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>]
<span class="line-num"> 996</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:taxa</span>].<span class="ruby-identifier">each_line</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon_name_str</span><span class="ruby-operator">|</span>
<span class="line-num"> 997</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_name_str</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 998</span>       <span class="ruby-identifier">latitude</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:latitude</span>]
<span class="line-num"> 999</span>       <span class="ruby-identifier">longitude</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:longitude</span>]
<span class="line-num">1000</span>       <span class="ruby-ivar">@observations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1001</span>         <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">1002</span>         <span class="ruby-value">:species_guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon_name_str</span>,
<span class="line-num">1003</span>         <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>(<span class="ruby-identifier">taxon_name_str</span>.<span class="ruby-identifier">strip</span>),
<span class="line-num">1004</span>         <span class="ruby-value">:place_guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:place_guess</span>],
<span class="line-num">1005</span>         <span class="ruby-value">:longitude</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">longitude</span>,
<span class="line-num">1006</span>         <span class="ruby-value">:latitude</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">latitude</span>,
<span class="line-num">1007</span>         <span class="ruby-value">:map_scale</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:map_scale</span>],
<span class="line-num">1008</span>         <span class="ruby-value">:positional_accuracy</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:positional_accuracy</span>],
<span class="line-num">1009</span>         <span class="ruby-value">:positioning_method</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:positioning_method</span>],
<span class="line-num">1010</span>         <span class="ruby-value">:positioning_device</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:positioning_device</span>],
<span class="line-num">1011</span>         <span class="ruby-value">:location_is_exact</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:location_is_exact</span>],
<span class="line-num">1012</span>         <span class="ruby-value">:observed_on_string</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:batch</span>][<span class="ruby-value">:observed_on_string</span>],
<span class="line-num">1013</span>         <span class="ruby-value">:time_zone</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">time_zone</span>)
<span class="line-num">1014</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1015</span>     <span class="ruby-ivar">@step</span> = <span class="ruby-value">2</span>
<span class="line-num">1016</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1017</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new_bulk_csv">
            
              <b>new_bulk_csv</b>()
            
            <a href="../classes/ObservationsController.html#method-i-new_bulk_csv" name="method-i-new_bulk_csv" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_bulk_csv_source')" id="l_method-i-new_bulk_csv_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_bulk_csv_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1019</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_bulk_csv</span>
<span class="line-num">1020</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:datafile</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1021</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-string">&quot;You must select a CSV file to upload.&quot;</span>
<span class="line-num">1022</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;import&quot;</span>
<span class="line-num">1023</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1024</span> 
<span class="line-num">1025</span>   <span class="ruby-identifier">unique_hash</span> = {
<span class="line-num">1026</span>     <span class="ruby-value">:class</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;BulkObservationFile&#39;</span>,
<span class="line-num">1027</span>     <span class="ruby-value">:user_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">1028</span>     <span class="ruby-value">:filename</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-string">&#39;datafile&#39;</span>].<span class="ruby-identifier">original_filename</span>,
<span class="line-num">1029</span>     <span class="ruby-value">:project_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:project_id</span>]
<span class="line-num">1030</span>   }
<span class="line-num">1031</span> 
<span class="line-num">1032</span>   <span class="ruby-comment"># Copy to a temp directory</span>
<span class="line-num">1033</span>   <span class="ruby-identifier">path</span> = <span class="ruby-identifier">private_page_cache_path</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(
<span class="line-num">1034</span>     <span class="ruby-string">&quot;bulk_observation_files&quot;</span>, 
<span class="line-num">1035</span>     <span class="ruby-node">&quot;#{unique_hash.to_s.parameterize}-#{Time.now}.csv&quot;</span>
<span class="line-num">1036</span>   ))
<span class="line-num">1037</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">path</span>), <span class="ruby-value">:mode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0755</span>
<span class="line-num">1038</span>   <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">path</span>, <span class="ruby-string">&#39;wb&#39;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-string">&#39;datafile&#39;</span>].<span class="ruby-identifier">read</span>) }
<span class="line-num">1039</span> 
<span class="line-num">1040</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:coordinate_system</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">coordinate_systems</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1041</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">coordinate_system</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">coordinate_systems</span>[<span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:coordinate_system</span>]]
<span class="line-num">1042</span>       <span class="ruby-identifier">proj4</span> = <span class="ruby-identifier">coordinate_system</span>[<span class="ruby-string">&quot;proj4&quot;</span>]
<span class="line-num">1043</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1044</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1045</span> 
<span class="line-num">1046</span>   <span class="ruby-comment"># Send the filename to a background processor</span>
<span class="line-num">1047</span>   <span class="ruby-identifier">bof</span> = <span class="ruby-constant">BulkObservationFile</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">1048</span>     <span class="ruby-identifier">path</span>,
<span class="line-num">1049</span>     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">1050</span>     <span class="ruby-value">project_id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:project_id</span>], 
<span class="line-num">1051</span>     <span class="ruby-value">coord_system:</span> <span class="ruby-identifier">proj4</span>
<span class="line-num">1052</span>   )
<span class="line-num">1053</span>   <span class="ruby-constant">Delayed</span><span class="ruby-operator">::</span><span class="ruby-constant">Job</span>.<span class="ruby-identifier">enqueue</span>(
<span class="line-num">1054</span>     <span class="ruby-identifier">bof</span>, 
<span class="line-num">1055</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">USER_PRIORITY</span>,
<span class="line-num">1056</span>     <span class="ruby-value">unique_hash:</span> <span class="ruby-identifier">unique_hash</span>,
<span class="line-num">1057</span>     <span class="ruby-value">queue:</span> <span class="ruby-string">&quot;csv&quot;</span>
<span class="line-num">1058</span>   )
<span class="line-num">1059</span> 
<span class="line-num">1060</span>   <span class="ruby-comment"># Notify the user that it&#39;s getting processed and return them to the upload screen.</span>
<span class="line-num">1061</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-string">&#39;Observation file has been queued for import.&#39;</span>
<span class="line-num">1062</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1063</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">import_observations_path</span>
<span class="line-num">1064</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1065</span>     <span class="ruby-identifier">project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:upload</span>][<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">1066</span>     <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">project_path</span>(<span class="ruby-identifier">project</span>))
<span class="line-num">1067</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1068</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new_from_list">
            
              <b>new_from_list</b>()
            
            <a href="../classes/ObservationsController.html#method-i-new_from_list" name="method-i-new_from_list" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_from_list_source')" id="l_method-i-new_from_list_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_from_list_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1232</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_from_list</span>
<span class="line-num">1233</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxa</span>]).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>)
<span class="line-num">1234</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1235</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:no_taxa_selected</span>)
<span class="line-num">1236</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:add_from_list</span>
<span class="line-num">1237</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1238</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">1239</span>     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">build</span>(<span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon</span>, 
<span class="line-num">1240</span>       <span class="ruby-value">:species_guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">default_name</span>.<span class="ruby-identifier">name</span>,
<span class="line-num">1241</span>       <span class="ruby-value">:time_zone</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">time_zone</span>)
<span class="line-num">1242</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1243</span>   <span class="ruby-ivar">@step</span> = <span class="ruby-value">2</span>
<span class="line-num">1244</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:new_batch</span>
<span class="line-num">1245</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observation_links">
            
              <b>observation_links</b>()
            
            <a href="../classes/ObservationsController.html#method-i-observation_links" name="method-i-observation_links" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observation_links_source')" id="l_method-i-observation_links_source">show</a>
                

                

                
              </p>
              <div id="method-i-observation_links_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">2056</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observation_links</span>
<span class="line-num">2057</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_links</span>
<span class="line-num">2058</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-phylogram">
            
              <b>phylogram</b>()
            
            <a href="../classes/ObservationsController.html#method-i-phylogram" name="method-i-phylogram" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-phylogram_source')" id="l_method-i-phylogram_source">show</a>
                

                

                
              </p>
              <div id="method-i-phylogram_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1930</span>   <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">phylogram</span>
<span class="line-num">1931</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:skip_order</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1932</span>     <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1933</span>       <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1934</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">query</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1935</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;1 = 2&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">stats_adequately_scoped?</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1936</span>     <span class="ruby-identifier">ancestor_ids_sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">1937</span> <span class="ruby-value">      SELECT DISTINCT regexp_split_to_table(ancestry, &#39;/&#39;) AS ancestor_id
<span class="line-num">1938</span>       FROM taxa
<span class="line-num">1939</span>         JOIN (
<span class="line-num">1940</span>           #{scope.to_sql}
<span class="line-num">1941</span>         ) AS observations ON observations.taxon_id = taxa.id
<span class="line-num">1942</span> </span><span class="ruby-identifier">    SQL</span>
<span class="line-num">1943</span>     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">1944</span> <span class="ruby-value">      SELECT taxa.id, name, ancestry
<span class="line-num">1945</span>       FROM taxa
<span class="line-num">1946</span>         LEFT OUTER JOIN (
<span class="line-num">1947</span>           #{ancestor_ids_sql}
<span class="line-num">1948</span>         ) AS ancestor_ids ON taxa.id::text = ancestor_ids.ancestor_id
<span class="line-num">1949</span>         JOIN (
<span class="line-num">1950</span>           #{scope.to_sql}
<span class="line-num">1951</span>         ) AS observations ON observations.taxon_id = taxa.id
<span class="line-num">1952</span>       WHERE ancestor_ids.ancestor_id IS NULL
<span class="line-num">1953</span> </span><span class="ruby-identifier">    SQL</span>
<span class="line-num">1954</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">sql</span>)
<span class="line-num">1955</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1956</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1957</span>         <span class="ruby-ivar">@headless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1958</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1959</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1960</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1961</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1962</span>           <span class="ruby-value">:taxa</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>
<span class="line-num">1963</span>         }
<span class="line-num">1964</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1965</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1966</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-project">
            
              <b>project</b>()
            
            <a href="../classes/ObservationsController.html#method-i-project" name="method-i-project" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-project_source')" id="l_method-i-project_source">show</a>
                

                

                
              </p>
              <div id="method-i-project_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1395</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">project</span>
<span class="line-num">1396</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1397</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1398</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_project_doesnt_exist</span>)
<span class="line-num">1399</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&quot;HTTP_REFERER&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">projects_path</span>
<span class="line-num">1400</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1401</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1402</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>] = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1403</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1404</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1405</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">apply_pagination_options</span>(<span class="ruby-identifier">search_params</span>,
<span class="line-num">1406</span>     <span class="ruby-value">user_preferences:</span> <span class="ruby-ivar">@prefs</span>)
<span class="line-num">1407</span>   <span class="ruby-identifier">search_params</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:id</span>)
<span class="line-num">1408</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1409</span>   <span class="ruby-identifier">set_up_instance_variables</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1410</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>)
<span class="line-num">1411</span>   <span class="ruby-ivar">@project_observations</span> = <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation:</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)).
<span class="line-num">1412</span>     <span class="ruby-identifier">includes</span>([ { <span class="ruby-value">:curator_identification</span> <span class="ruby-operator">=&gt;</span> [ <span class="ruby-value">:taxon</span>, <span class="ruby-value">:user</span> ] } ])
<span class="line-num">1413</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1414</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1415</span>       <span class="ruby-identifier">render_observations_to_json</span>
<span class="line-num">1416</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1417</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span>
<span class="line-num">1418</span>       <span class="ruby-identifier">pagination_headers_for</span>(<span class="ruby-ivar">@observations</span>)
<span class="line-num">1419</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">to_csv</span>(<span class="ruby-ivar">@project_observations</span>, <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1420</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1421</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">widget</span> <span class="ruby-keyword">do</span>
<span class="line-num">1422</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:markup_only</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;true&quot;</span>
<span class="line-num">1423</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">js:</span> <span class="ruby-identifier">render_to_string</span>( <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;widget.html.erb&quot;</span>, <span class="ruby-value">locals:</span> {
<span class="line-num">1424</span>           <span class="ruby-value">show_user:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">1425</span>           <span class="ruby-value">target:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:target</span>],
<span class="line-num">1426</span>           <span class="ruby-value">default_image:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:default_image</span>],
<span class="line-num">1427</span>           <span class="ruby-value">silence:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:silence</span>]
<span class="line-num">1428</span>         })
<span class="line-num">1429</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1430</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">js:</span> <span class="ruby-identifier">render_to_string</span>( <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;widget.js.erb&quot;</span>, <span class="ruby-value">locals:</span> {
<span class="line-num">1431</span>           <span class="ruby-value">show_user:</span> <span class="ruby-keyword">true</span>
<span class="line-num">1432</span>         } )
<span class="line-num">1433</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1434</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1435</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1436</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-project_all">
            
              <b>project_all</b>()
            
            <a href="../classes/ObservationsController.html#method-i-project_all" name="method-i-project_all" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-project_all_source')" id="l_method-i-project_all_source">show</a>
                

                

                
              </p>
              <div id="method-i-project_all_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1438</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">project_all</span>
<span class="line-num">1439</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">1440</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1441</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_project_doesnt_exist</span>)
<span class="line-num">1442</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&quot;HTTP_REFERER&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">projects_path</span>
<span class="line-num">1443</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1444</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1445</span>   
<span class="line-num">1446</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">curated_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">1447</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_project_curators_can_do_that</span>)
<span class="line-num">1448</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&quot;HTTP_REFERER&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1449</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1450</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1451</span> 
<span class="line-num">1452</span>   <span class="ruby-identifier">path_for_csv</span> = <span class="ruby-identifier">private_page_cache_path</span>(<span class="ruby-node">&quot;observations/project/#{@project.slug}.all.csv&quot;</span>)
<span class="line-num">1453</span>   <span class="ruby-identifier">delayed_csv</span>(<span class="ruby-identifier">path_for_csv</span>, <span class="ruby-ivar">@project</span>)
<span class="line-num">1454</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-review">
            
              <b>review</b>()
            
            <a href="../classes/ObservationsController.html#method-i-review" name="method-i-review" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-review_source')" id="l_method-i-review_source">show</a>
                

                

                
              </p>
              <div id="method-i-review_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1976</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">review</span>
<span class="line-num">1977</span>   <span class="ruby-identifier">user_reviewed</span>
<span class="line-num">1978</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1979</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@observation</span> }
<span class="line-num">1980</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1981</span>       <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">1982</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1983</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1984</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-selector">
            
              <b>selector</b>()
            
            <a href="../classes/ObservationsController.html#method-i-selector" name="method-i-selector" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Renders observation components as form fields for inclusion in  observation-picking form widgets</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-selector_source')" id="l_method-i-selector_source">show</a>
                

                

                
              </p>
              <div id="method-i-selector_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1345</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">selector</span>
<span class="line-num">1346</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1347</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1348</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">apply_pagination_options</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1349</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">latest</span>.<span class="ruby-identifier">query</span>(<span class="ruby-identifier">search_params</span>).<span class="ruby-identifier">paginate</span>(
<span class="line-num">1350</span>     <span class="ruby-value">page:</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:page</span>], <span class="ruby-value">per_page:</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:per_page</span>])
<span class="line-num">1351</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_for_component</span>(<span class="ruby-ivar">@observations</span>, <span class="ruby-value">logged_in:</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>)
<span class="line-num">1352</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1353</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;selector&#39;</span>}
<span class="line-num">1354</span>     <span class="ruby-comment"># format.js</span>
<span class="line-num">1355</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1356</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show">
            
              <b>show</b>()
            
            <a href="../classes/ObservationsController.html#method-i-show" name="method-i-show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /observations/1 GET /observations/1.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_source')" id="l_method-i-show_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">265</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show</span>
<span class="line-num">266</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@skipping_preloading</span>
<span class="line-num">267</span>     <span class="ruby-ivar">@quality_metrics</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>)
<span class="line-num">268</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">269</span>       <span class="ruby-ivar">@previous</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>({ <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">270</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">max_id:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-value">order:</span> <span class="ruby-string">&quot;desc&quot;</span> }).<span class="ruby-identifier">first</span>
<span class="line-num">271</span>       <span class="ruby-ivar">@prev</span> = <span class="ruby-ivar">@previous</span>
<span class="line-num">272</span>       <span class="ruby-ivar">@next</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>({ <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">273</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">min_id:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-value">order:</span> <span class="ruby-string">&quot;asc&quot;</span> }).<span class="ruby-identifier">first</span>
<span class="line-num">274</span>       <span class="ruby-ivar">@user_quality_metrics</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">quality_metrics</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">qm</span><span class="ruby-operator">|</span> <span class="ruby-identifier">qm</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>}
<span class="line-num">275</span>     <span class="ruby-keyword">end</span>
<span class="line-num">276</span>   <span class="ruby-keyword">end</span>
<span class="line-num">277</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">278</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">279</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;cached_component&quot;</span>
<span class="line-num">280</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-value">partial:</span> <span class="ruby-string">&quot;cached_component&quot;</span>,
<span class="line-num">281</span>           <span class="ruby-value">object:</span> <span class="ruby-ivar">@observation</span>, <span class="ruby-value">layout:</span> <span class="ruby-keyword">false</span>)
<span class="line-num">282</span>       <span class="ruby-keyword">end</span>
<span class="line-num">283</span>       <span class="ruby-ivar">@coordinates_viewable</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">coordinates_viewable_by?</span>( <span class="ruby-identifier">current_user</span> )
<span class="line-num">284</span>       <span class="ruby-identifier">user_viewed_updates</span>(<span class="ruby-value">delay:</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">285</span>       <span class="ruby-ivar">@observer_provider_authorizations</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">provider_authorizations</span>
<span class="line-num">286</span>       <span class="ruby-ivar">@shareable_image_url</span> = <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">iconic_taxon_image_url</span>( <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>, <span class="ruby-value">size:</span> <span class="ruby-value">200</span> )
<span class="line-num">287</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">op</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">position</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">first</span>
<span class="line-num">288</span>         <span class="ruby-ivar">@shareable_image_url</span> = <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">image_url</span>( <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">best_url</span>(<span class="ruby-value">:large</span>) )
<span class="line-num">289</span>       <span class="ruby-keyword">end</span>
<span class="line-num">290</span>       <span class="ruby-ivar">@shareable_title</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">291</span>         <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>, { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> } )
<span class="line-num">292</span>         <span class="ruby-identifier">render_to_string</span>( <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;taxa/taxon.txt&quot;</span>, <span class="ruby-value">locals:</span> { <span class="ruby-value">taxon:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span> } )
<span class="line-num">293</span>       <span class="ruby-keyword">else</span>
<span class="line-num">294</span>         <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;something&quot;</span> )
<span class="line-num">295</span>       <span class="ruby-keyword">end</span>
<span class="line-num">296</span>       <span class="ruby-ivar">@shareable_description</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">to_plain_s</span>(
<span class="line-num">297</span>         <span class="ruby-value">no_place_guess:</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@coordinates_viewable</span>,
<span class="line-num">298</span>         <span class="ruby-value">viewer:</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">299</span>       )
<span class="line-num">300</span>       <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">description</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">301</span>         <span class="ruby-ivar">@shareable_description</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;.\n\n#{helpers.truncate( @observation.description, length: 100 )}&quot;</span>
<span class="line-num">302</span>       <span class="ruby-keyword">end</span>
<span class="line-num">303</span> 
<span class="line-num">304</span>       <span class="ruby-ivar">@skip_application_js</span> = <span class="ruby-keyword">true</span>
<span class="line-num">305</span>       <span class="ruby-ivar">@flash_js</span> = <span class="ruby-keyword">true</span>
<span class="line-num">306</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">307</span>     <span class="ruby-keyword">end</span>
<span class="line-num">308</span>      
<span class="line-num">309</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:xml</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span> }
<span class="line-num">310</span>     
<span class="line-num">311</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">312</span>       <span class="ruby-identifier">taxon_options</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">313</span>       <span class="ruby-identifier">taxon_options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:iconic_taxon_name</span>, <span class="ruby-value">:image_url</span>, <span class="ruby-value">:common_name</span>, <span class="ruby-value">:default_name</span>]
<span class="line-num">314</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">to_json</span>(
<span class="line-num">315</span>         <span class="ruby-value">:viewer</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">316</span>         <span class="ruby-value">force_coordinate_visibility:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">coordinates_viewable_by?</span>( <span class="ruby-identifier">current_user</span> ),
<span class="line-num">317</span>         <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_login</span>, <span class="ruby-value">:iconic_taxon_name</span>, <span class="ruby-value">:captive_flag</span>],
<span class="line-num">318</span>         <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">319</span>           <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">default_json_options</span>,
<span class="line-num">320</span>           <span class="ruby-value">:observation_field_values</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:observation_field</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:name</span>]}}},
<span class="line-num">321</span>           <span class="ruby-value">:project_observations</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">322</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">323</span>               <span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">324</span>                 <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:title</span>, <span class="ruby-value">:description</span>],
<span class="line-num">325</span>                 <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:icon_url</span>]
<span class="line-num">326</span>               }
<span class="line-num">327</span>             }
<span class="line-num">328</span>           },
<span class="line-num">329</span>           <span class="ruby-value">:observation_photos</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">330</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">331</span>               <span class="ruby-value">:photo</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">332</span>                 <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:license_code</span>, <span class="ruby-value">:attribution</span>, <span class="ruby-value">:square_url</span>,
<span class="line-num">333</span>                   <span class="ruby-value">:thumb_url</span>, <span class="ruby-value">:small_url</span>, <span class="ruby-value">:medium_url</span>, <span class="ruby-value">:large_url</span>],
<span class="line-num">334</span>                 <span class="ruby-value">:except</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:file_processing</span>, <span class="ruby-value">:file_file_size</span>,
<span class="line-num">335</span>                   <span class="ruby-value">:file_content_type</span>, <span class="ruby-value">:file_file_name</span>, <span class="ruby-value">:mobile</span>, <span class="ruby-value">:metadata</span>, <span class="ruby-value">:user_id</span>, 
<span class="line-num">336</span>                   <span class="ruby-value">:native_realname</span>, <span class="ruby-value">:native_photo_id</span>]
<span class="line-num">337</span>               }
<span class="line-num">338</span>             }
<span class="line-num">339</span>           },
<span class="line-num">340</span>           <span class="ruby-value">:comments</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">341</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">342</span>               <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">343</span>                 <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>, <span class="ruby-value">:id</span>],
<span class="line-num">344</span>                 <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_icon_url</span>]
<span class="line-num">345</span>               }
<span class="line-num">346</span>             }
<span class="line-num">347</span>           },
<span class="line-num">348</span>           <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon_options</span>,
<span class="line-num">349</span>           <span class="ruby-value">:identifications</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">350</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">351</span>               <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">352</span>                 <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>, <span class="ruby-value">:id</span>],
<span class="line-num">353</span>                 <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_icon_url</span>]
<span class="line-num">354</span>               },
<span class="line-num">355</span>               <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon_options</span>
<span class="line-num">356</span>             }
<span class="line-num">357</span>           },
<span class="line-num">358</span>           <span class="ruby-value">:faves</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">359</span>             <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:created_at</span>],
<span class="line-num">360</span>             <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">361</span>               <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">362</span>                 <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>, <span class="ruby-value">:id</span>],
<span class="line-num">363</span>                 <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_icon_url</span>]
<span class="line-num">364</span>               }
<span class="line-num">365</span>             }
<span class="line-num">366</span>           }
<span class="line-num">367</span>         })
<span class="line-num">368</span>     <span class="ruby-keyword">end</span>
<span class="line-num">369</span>     
<span class="line-num">370</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">atom</span> <span class="ruby-keyword">do</span>
<span class="line-num">371</span>       <span class="ruby-identifier">cache</span>
<span class="line-num">372</span>     <span class="ruby-keyword">end</span>
<span class="line-num">373</span>   <span class="ruby-keyword">end</span>
<span class="line-num">374</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-stats">
            
              <b>stats</b>()
            
            <a href="../classes/ObservationsController.html#method-i-stats" name="method-i-stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-stats_source')" id="l_method-i-stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-stats_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1574</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">stats</span>
<span class="line-num">1575</span>   <span class="ruby-ivar">@headless</span> = <span class="ruby-ivar">@footless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1576</span>   <span class="ruby-identifier">stats_adequately_scoped?</span>
<span class="line-num">1577</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1578</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1579</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1580</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxa">
            
              <b>taxa</b>()
            
            <a href="../classes/ObservationsController.html#method-i-taxa" name="method-i-taxa" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxa_source')" id="l_method-i-taxa_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxa_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1582</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxa</span>
<span class="line-num">1583</span>   <span class="ruby-identifier">can_view_leaves</span> = <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_curator?</span>
<span class="line-num">1584</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:rank</span>] = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">can_view_leaves</span>
<span class="line-num">1585</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:skip_order</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1586</span>   <span class="ruby-identifier">html_taxon_render_limit</span> = <span class="ruby-value">5000</span>
<span class="line-num">1587</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1588</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1589</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">stats_adequately_scoped?</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1590</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:rank</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;leaves&quot;</span>
<span class="line-num">1591</span>       <span class="ruby-identifier">search_params</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:rank</span>)
<span class="line-num">1592</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1593</span>     <span class="ruby-identifier">elastic_params</span> = <span class="ruby-identifier">prepare_counts_elastic_query</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1594</span>     <span class="ruby-comment"># using 0 for the aggregation count to get all results</span>
<span class="line-num">1595</span>     <span class="ruby-identifier">limit</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">html?</span> <span class="ruby-operator">?</span> ( <span class="ruby-identifier">html_taxon_render_limit</span> <span class="ruby-operator">+</span> <span class="ruby-value">10</span> ) <span class="ruby-operator">:</span> <span class="ruby-value">120000</span>
<span class="line-num">1596</span>     <span class="ruby-identifier">distinct_taxa</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(<span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1597</span>       <span class="ruby-value">aggregate:</span> { <span class="ruby-value">species:</span> { <span class="ruby-value">&quot;taxon.id&quot;:</span> <span class="ruby-identifier">limit</span> } })).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>
<span class="line-num">1598</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">html?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">distinct_taxa</span>.<span class="ruby-identifier">species</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">html_taxon_render_limit</span>
<span class="line-num">1599</span>       <span class="ruby-ivar">@error</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:too_many_taxa_to_render</span> )
<span class="line-num">1600</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1601</span>       <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">distinct_taxa</span>.<span class="ruby-identifier">species</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>] })
<span class="line-num">1602</span>       <span class="ruby-comment"># if `leaves` were requested, remove any taxon in another&#39;s ancestry</span>
<span class="line-num">1603</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:rank</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;leaves&quot;</span>
<span class="line-num">1604</span>         <span class="ruby-identifier">ancestors</span> = { }
<span class="line-num">1605</span>         <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">1606</span>           <span class="ruby-identifier">t</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">aid</span><span class="ruby-operator">|</span>
<span class="line-num">1607</span>             <span class="ruby-identifier">ancestors</span>[<span class="ruby-identifier">aid</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
<span class="line-num">1608</span>             <span class="ruby-identifier">ancestors</span>[<span class="ruby-identifier">aid</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">1609</span>           <span class="ruby-keyword">end</span>
<span class="line-num">1610</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1611</span>         <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ancestors</span>[<span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>] }
<span class="line-num">1612</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1613</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1614</span>     <span class="ruby-comment"># hack to test what this would look like</span>
<span class="line-num">1615</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>]
<span class="line-num">1616</span>     <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;observations_count&quot;</span>
<span class="line-num">1617</span>       <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">1618</span>         <span class="ruby-identifier">c</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:place</span>]
<span class="line-num">1619</span>           <span class="ruby-comment"># this is a dumb hack. if i was smarter, i would have tried tp pull</span>
<span class="line-num">1620</span>           <span class="ruby-comment"># this out of the sql with GROUP and COUNT, but I couldn&#39;t figure it</span>
<span class="line-num">1621</span>           <span class="ruby-comment"># out --kueda 20150430</span>
<span class="line-num">1622</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:place</span>].<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">primary_listing:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">1623</span>             <span class="ruby-identifier">lt</span>.<span class="ruby-identifier">observations_count</span>
<span class="line-num">1624</span>           <span class="ruby-keyword">else</span>
<span class="line-num">1625</span>             <span class="ruby-comment"># if there&#39;s no listed taxon assume it&#39;s been observed once</span>
<span class="line-num">1626</span>             <span class="ruby-value">1</span>
<span class="line-num">1627</span>           <span class="ruby-keyword">end</span>
<span class="line-num">1628</span>         <span class="ruby-keyword">else</span>
<span class="line-num">1629</span>           <span class="ruby-identifier">t</span>.<span class="ruby-identifier">observations_count</span>
<span class="line-num">1630</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1631</span>         <span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">-1</span>
<span class="line-num">1632</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1633</span>     <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;name&quot;</span>
<span class="line-num">1634</span>       <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>)
<span class="line-num">1635</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1636</span>       <span class="ruby-ivar">@taxa</span>
<span class="line-num">1637</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1638</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1639</span>     <span class="ruby-ivar">@taxa</span> = [ ]
<span class="line-num">1640</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1641</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1642</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1643</span>       <span class="ruby-ivar">@headless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1644</span>       <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@error</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">html_taxon_render_limit</span>
<span class="line-num">1645</span>         <span class="ruby-ivar">@error</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-value">:too_many_taxa_to_render</span> )
<span class="line-num">1646</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@error</span>
<span class="line-num">1647</span>         <span class="ruby-identifier">ancestor_ids</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">ancestor_ids</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">1648</span>         <span class="ruby-identifier">ancestors</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">ancestor_ids</span>)
<span class="line-num">1649</span>         <span class="ruby-identifier">taxa_to_arrange</span> = (<span class="ruby-identifier">ancestors</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@taxa</span>).<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{t.ancestry}/#{t.id}&quot;</span>}
<span class="line-num">1650</span>         <span class="ruby-ivar">@arranged_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">arrange_nodes</span>(<span class="ruby-identifier">taxa_to_arrange</span>)
<span class="line-num">1651</span>         <span class="ruby-ivar">@taxon_names_by_taxon_id</span> = <span class="ruby-constant">TaxonName</span>.
<span class="line-num">1652</span>           <span class="ruby-identifier">where</span>(<span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxa_to_arrange</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">uniq</span>).
<span class="line-num">1653</span>           <span class="ruby-identifier">includes</span>(<span class="ruby-value">:place_taxon_names</span>).
<span class="line-num">1654</span>           <span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>)
<span class="line-num">1655</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1656</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@error</span>
<span class="line-num">1657</span>         <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-ivar">@error</span>
<span class="line-num">1658</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1659</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1660</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1661</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">csv</span> <span class="ruby-keyword">do</span>
<span class="line-num">1662</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxa</span>, { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> })
<span class="line-num">1663</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_csv</span>(
<span class="line-num">1664</span>         <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:rank</span>, <span class="ruby-value">:rank_level</span>, <span class="ruby-value">:ancestry</span>, <span class="ruby-value">:is_active</span>],
<span class="line-num">1665</span>         <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:common_name_string</span>, <span class="ruby-value">:iconic_taxon_name</span>, 
<span class="line-num">1666</span>           <span class="ruby-value">:taxonomic_kingdom_name</span>,
<span class="line-num">1667</span>           <span class="ruby-value">:taxonomic_phylum_name</span>, <span class="ruby-value">:taxonomic_class_name</span>,
<span class="line-num">1668</span>           <span class="ruby-value">:taxonomic_order_name</span>, <span class="ruby-value">:taxonomic_family_name</span>,
<span class="line-num">1669</span>           <span class="ruby-value">:taxonomic_genus_name</span>, <span class="ruby-value">:taxonomic_species_name</span>]
<span class="line-num">1670</span>       )
<span class="line-num">1671</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1672</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1673</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxa</span>, <span class="ruby-value">:taxon_descriptions</span>)
<span class="line-num">1674</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1675</span>         <span class="ruby-value">:taxa</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>
<span class="line-num">1676</span>       }
<span class="line-num">1677</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1678</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1679</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_stats">
            
              <b>taxon_stats</b>()
            
            <a href="../classes/ObservationsController.html#method-i-taxon_stats" name="method-i-taxon_stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_stats_source')" id="l_method-i-taxon_stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_stats_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1681</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_stats</span>
<span class="line-num">1682</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:skip_order</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1683</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1684</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1685</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">stats_adequately_scoped?</span>(<span class="ruby-identifier">search_params</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">json?</span>
<span class="line-num">1686</span>     <span class="ruby-identifier">elastic_taxon_stats</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1687</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1688</span>     <span class="ruby-ivar">@species_counts</span> = [ ]
<span class="line-num">1689</span>     <span class="ruby-ivar">@rank_counts</span> = { }
<span class="line-num">1690</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1691</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@species_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;taxon_id&quot;</span>] }).
<span class="line-num">1692</span>     <span class="ruby-identifier">includes</span>({ <span class="ruby-value">taxon_photos:</span> <span class="ruby-value">:photo</span> }, <span class="ruby-value">:taxon_names</span>)
<span class="line-num">1693</span>   <span class="ruby-ivar">@taxa_by_taxon_id</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1694</span>   <span class="ruby-ivar">@species_counts_json</span> = <span class="ruby-ivar">@species_counts</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">1695</span>     <span class="ruby-identifier">taxon</span> = <span class="ruby-ivar">@taxa_by_taxon_id</span>[<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;taxon_id&#39;</span>].<span class="ruby-identifier">to_i</span>]
<span class="line-num">1696</span>     <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">locale</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">1697</span>     {
<span class="line-num">1698</span>       <span class="ruby-value">:count</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;count_all&#39;</span>],
<span class="line-num">1699</span>       <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">as_json</span>(
<span class="line-num">1700</span>         <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:default_name</span>, <span class="ruby-value">:image_url</span>, <span class="ruby-value">:iconic_taxon_name</span>, <span class="ruby-value">:conservation_status_name</span>],
<span class="line-num">1701</span>         <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:rank</span>, <span class="ruby-value">:rank_level</span>]
<span class="line-num">1702</span>       )
<span class="line-num">1703</span>     }
<span class="line-num">1704</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1705</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1706</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1707</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1708</span>         <span class="ruby-value">:total</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@total</span>,
<span class="line-num">1709</span>         <span class="ruby-value">:species_counts</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@species_counts_json</span>,
<span class="line-num">1710</span>         <span class="ruby-value">:rank_counts</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@rank_counts</span>
<span class="line-num">1711</span>       }
<span class="line-num">1712</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1713</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1714</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_summary">
            
              <b>taxon_summary</b>()
            
            <a href="../classes/ObservationsController.html#method-i-taxon_summary" name="method-i-taxon_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_summary_source')" id="l_method-i-taxon_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_summary_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">209</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_summary</span>
<span class="line-num">210</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-ivar">@observation</span>, { <span class="ruby-value">observations_places:</span> <span class="ruby-value">:place</span> } )
<span class="line-num">211</span>   <span class="ruby-ivar">@coordinates_viewable</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">coordinates_viewable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">212</span>   <span class="ruby-ivar">@places</span> = <span class="ruby-ivar">@coordinates_viewable</span> <span class="ruby-operator">?</span>
<span class="line-num">213</span>     <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observations_places</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:place</span>) <span class="ruby-operator">:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">public_places</span>
<span class="line-num">214</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:community</span>] <span class="ruby-operator">?</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">215</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">216</span>     <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">217</span>       <span class="ruby-ivar">@listed_taxon</span> = <span class="ruby-constant">ListedTaxon</span>.
<span class="line-num">218</span>         <span class="ruby-identifier">joins</span>(<span class="ruby-value">:place</span>).
<span class="line-num">219</span>         <span class="ruby-identifier">where</span>([ <span class="ruby-string">&quot;taxon_id = ? AND place_id IN (?) AND establishment_means IS NOT NULL&quot;</span>,
<span class="line-num">220</span>           <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@places</span> ]).
<span class="line-num">221</span>         <span class="ruby-identifier">order</span>( <span class="ruby-constant">Arel</span>.<span class="ruby-identifier">sql</span>( <span class="ruby-string">&quot;establishment_means IN (&#39;endemic&#39;, &#39;introduced&#39;) DESC, places.bbox_area ASC&quot;</span> ) ).
<span class="line-num">222</span>         <span class="ruby-identifier">first</span>
<span class="line-num">223</span>       <span class="ruby-identifier">conservation_status_in_place_scope</span> = <span class="ruby-constant">ConservationStatus</span>.
<span class="line-num">224</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;place_id IN (?)&quot;</span>, <span class="ruby-ivar">@places</span>).
<span class="line-num">225</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;iucn &gt;= ?&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">IUCN_NEAR_THREATENED</span>).
<span class="line-num">226</span>         <span class="ruby-identifier">includes</span>(<span class="ruby-value">:place</span>)
<span class="line-num">227</span>       <span class="ruby-ivar">@conservation_status</span> = <span class="ruby-identifier">conservation_status_in_place_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">228</span>       <span class="ruby-ivar">@conservation_status</span> = <span class="ruby-identifier">conservation_status_in_place_scope</span>.
<span class="line-num">229</span>         <span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span> ).
<span class="line-num">230</span>         <span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">231</span>         <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;taxa.rank_level ASC&quot;</span> ).
<span class="line-num">232</span>         <span class="ruby-identifier">first</span>
<span class="line-num">233</span>     <span class="ruby-keyword">end</span>
<span class="line-num">234</span>     <span class="ruby-identifier">global_conservation_status_scope</span> = <span class="ruby-constant">ConservationStatus</span>.
<span class="line-num">235</span>       <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;place_id IS NULL&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;iucn &gt;= ?&quot;</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">IUCN_NEAR_THREATENED</span>)
<span class="line-num">236</span>     <span class="ruby-ivar">@conservation_status</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">global_conservation_status_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">237</span>     <span class="ruby-ivar">@conservation_status</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">global_conservation_status_scope</span>.
<span class="line-num">238</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span> ).
<span class="line-num">239</span>       <span class="ruby-identifier">joins</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">240</span>       <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;taxa.rank_level ASC&quot;</span> ).
<span class="line-num">241</span>       <span class="ruby-identifier">first</span>
<span class="line-num">242</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@listed_taxon</span>
<span class="line-num">243</span>       <span class="ruby-ivar">@conservation_status</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">threatened_status</span>(<span class="ruby-value">place_id:</span> <span class="ruby-ivar">@listed_taxon</span>.<span class="ruby-identifier">place_id</span>)
<span class="line-num">244</span>     <span class="ruby-keyword">end</span>
<span class="line-num">245</span>     <span class="ruby-ivar">@conservation_status</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">threatened_status</span>
<span class="line-num">246</span>   <span class="ruby-keyword">end</span>
<span class="line-num">247</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> {
<span class="line-num">248</span>     <span class="ruby-value">conservation_status:</span> <span class="ruby-ivar">@conservation_status</span> <span class="ruby-operator">?</span>
<span class="line-num">249</span>       <span class="ruby-ivar">@conservation_status</span>.<span class="ruby-identifier">as_json</span>( <span class="ruby-value">methods:</span> [ <span class="ruby-value">:status_name</span>, <span class="ruby-value">:iucn_status</span>, <span class="ruby-value">:iucn_status_code</span> ],
<span class="line-num">250</span>         <span class="ruby-value">include:</span> { <span class="ruby-value">place:</span> { <span class="ruby-value">only:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:display_name</span>] } } ) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">251</span>     <span class="ruby-value">listed_taxon:</span> <span class="ruby-ivar">@listed_taxon</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-ivar">@listed_taxon</span>.<span class="ruby-identifier">endemic?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@listed_taxon</span>.<span class="ruby-identifier">introduced?</span> ) <span class="ruby-operator">?</span>
<span class="line-num">252</span>       <span class="ruby-ivar">@listed_taxon</span>.<span class="ruby-identifier">as_json</span>(
<span class="line-num">253</span>         <span class="ruby-value">methods:</span> [ <span class="ruby-value">:establishment_means_label</span>, <span class="ruby-value">:establishment_means_description</span> ],
<span class="line-num">254</span>         <span class="ruby-value">include:</span> { <span class="ruby-value">place:</span> { <span class="ruby-value">only:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:display_name</span>] } } ) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">255</span>     <span class="ruby-value">wikipedia_summary:</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">wikipedia_summary</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> ) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">256</span>   }
<span class="line-num">257</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-torquemap">
            
              <b>torquemap</b>()
            
            <a href="../classes/ObservationsController.html#method-i-torquemap" name="method-i-torquemap" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-torquemap_source')" id="l_method-i-torquemap_source">show</a>
                

                

                
              </p>
              <div id="method-i-torquemap_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1805</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">torquemap</span>
<span class="line-num">1806</span>   <span class="ruby-ivar">@params</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">except</span>(<span class="ruby-value">:controller</span>, <span class="ruby-value">:action</span>)
<span class="line-num">1807</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1808</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>()
            
            <a href="../classes/ObservationsController.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>PUT /observations/1 PUT /observations/1.xml</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">735</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>
<span class="line-num">736</span>   <span class="ruby-identifier">observation_user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">737</span>   
<span class="line-num">738</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:admin_action</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">739</span>     <span class="ruby-identifier">observation_user</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]).<span class="ruby-identifier">user</span>
<span class="line-num">740</span>   <span class="ruby-keyword">end</span>
<span class="line-num">741</span>   
<span class="line-num">742</span>   <span class="ruby-comment"># Handle the case of a single obs</span>
<span class="line-num">743</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>]
<span class="line-num">744</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>] = [[<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>]]]
<span class="line-num">745</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>]
<span class="line-num">746</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>] = [[<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>][<span class="ruby-value">0</span>]]]
<span class="line-num">747</span>   <span class="ruby-keyword">end</span>
<span class="line-num">748</span>   
<span class="line-num">749</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">750</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">751</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">752</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:no_observations_submitted</span>)
<span class="line-num">753</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">new_observation_path</span>
<span class="line-num">754</span>       <span class="ruby-keyword">end</span>
<span class="line-num">755</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;No observations submitted!&quot;</span> }
<span class="line-num">756</span>     <span class="ruby-keyword">end</span>
<span class="line-num">757</span>     <span class="ruby-keyword">return</span>
<span class="line-num">758</span>   <span class="ruby-keyword">end</span>
<span class="line-num">759</span> 
<span class="line-num">760</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>].<span class="ruby-identifier">to_h</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>, <span class="ruby-identifier">obs</span><span class="ruby-operator">|</span>
<span class="line-num">761</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">uuid:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">observation_user</span> ).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
<span class="line-num">762</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">observation_user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">763</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">764</span>   
<span class="line-num">765</span>   <span class="ruby-comment"># Make sure there&#39;s no evil going on</span>
<span class="line-num">766</span>   <span class="ruby-identifier">unique_user_ids</span> = <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:user_id</span>).<span class="ruby-identifier">uniq</span>
<span class="line-num">767</span>   <span class="ruby-identifier">more_than_one_observer</span> = <span class="ruby-identifier">unique_user_ids</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">768</span>   <span class="ruby-identifier">admin_action</span> = <span class="ruby-identifier">unique_user_ids</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">observation_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">has_role?</span>(<span class="ruby-value">:admin</span>)
<span class="line-num">769</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">more_than_one_observer</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">admin_action</span>
<span class="line-num">770</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_edit_that_observation</span>)
<span class="line-num">771</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">772</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">773</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">774</span>         <span class="ruby-identifier">redirect_to</span>(<span class="ruby-ivar">@observation</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">observations_path</span>)
<span class="line-num">775</span>       <span class="ruby-keyword">end</span>
<span class="line-num">776</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">777</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">778</span>       <span class="ruby-keyword">end</span>
<span class="line-num">779</span>     <span class="ruby-keyword">end</span>
<span class="line-num">780</span>     <span class="ruby-keyword">return</span>
<span class="line-num">781</span>   <span class="ruby-keyword">end</span>
<span class="line-num">782</span>   
<span class="line-num">783</span>   <span class="ruby-comment"># Convert the params to a hash keyed by ID.  Yes, it&#39;s weird</span>
<span class="line-num">784</span>   <span class="ruby-identifier">hashed_params</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">params</span>[<span class="ruby-value">:observations</span>].<span class="ruby-identifier">to_h</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>, <span class="ruby-identifier">obs</span><span class="ruby-operator">|</span>
<span class="line-num">785</span>     <span class="ruby-identifier">instance</span> = <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">uuid</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span> }
<span class="line-num">786</span>     <span class="ruby-identifier">instance</span> <span class="ruby-operator">?</span> [<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">obs</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">787</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>]
<span class="line-num">788</span>   <span class="ruby-identifier">errors</span> = <span class="ruby-keyword">false</span>
<span class="line-num">789</span>   <span class="ruby-identifier">extra_msg</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">790</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">791</span>     <span class="ruby-identifier">fieldset_index</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
<span class="line-num">792</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">793</span>     
<span class="line-num">794</span>     <span class="ruby-comment"># Note: this ignore photos thing is a total hack and should only be</span>
<span class="line-num">795</span>     <span class="ruby-comment"># included if you are updating observations but aren&#39;t including flickr</span>
<span class="line-num">796</span>     <span class="ruby-comment"># fields, e.g. when removing something from ID please</span>
<span class="line-num">797</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:ignore_photos</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_mobile_app?</span>
<span class="line-num">798</span>       <span class="ruby-comment"># Get photos</span>
<span class="line-num">799</span>       <span class="ruby-identifier">keeper_photos</span> = []
<span class="line-num">800</span>       <span class="ruby-identifier">old_photo_ids</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">photo_ids</span>
<span class="line-num">801</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">subclasses</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">802</span>         <span class="ruby-identifier">klass_key</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>
<span class="line-num">803</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">klass_key</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">804</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>][<span class="ruby-identifier">fieldset_index</span>]
<span class="line-num">805</span>           <span class="ruby-identifier">keeper_photos</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">retrieve_photos</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">klass_key</span>][<span class="ruby-identifier">fieldset_index</span>],
<span class="line-num">806</span>             <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-value">:photo_class</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">klass</span>, <span class="ruby-value">:sync</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">807</span>         <span class="ruby-keyword">end</span>
<span class="line-num">808</span>       <span class="ruby-keyword">end</span>
<span class="line-num">809</span> 
<span class="line-num">810</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">keeper_photos</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">811</span>         <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">destroy_all</span>
<span class="line-num">812</span>       <span class="ruby-keyword">else</span>
<span class="line-num">813</span>         <span class="ruby-identifier">keeper_photos</span> = <span class="ruby-identifier">ensure_photos_are_local_photos</span>( <span class="ruby-identifier">keeper_photos</span> )
<span class="line-num">814</span>         <span class="ruby-identifier">reject_obs_photos</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">keeper_photos</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo_id</span> )}
<span class="line-num">815</span>         <span class="ruby-identifier">reject_obs_photos</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:destroy</span>)
<span class="line-num">816</span>         <span class="ruby-identifier">keeper_photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">817</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">818</span>             <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">build</span>( <span class="ruby-value">photo:</span> <span class="ruby-identifier">p</span> )
<span class="line-num">819</span>           <span class="ruby-keyword">end</span>
<span class="line-num">820</span>         <span class="ruby-keyword">end</span>
<span class="line-num">821</span>       <span class="ruby-keyword">end</span>
<span class="line-num">822</span> 
<span class="line-num">823</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">subclasses</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">824</span>         <span class="ruby-identifier">klass_key</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>
<span class="line-num">825</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;#{klass_key}_to_sync&quot;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;#{klass_key}_to_sync&quot;</span>][<span class="ruby-identifier">fieldset_index</span>]
<span class="line-num">826</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:photo</span>)
<span class="line-num">827</span>         <span class="ruby-identifier">photo_o</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">to_observation</span>
<span class="line-num">828</span>         <span class="ruby-constant">PHOTO_SYNC_ATTRS</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
<span class="line-num">829</span>           <span class="ruby-identifier">hashed_params</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> {}
<span class="line-num">830</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">hashed_params</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">a</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>).<span class="ruby-identifier">blank?</span>
<span class="line-num">831</span>             <span class="ruby-identifier">hashed_params</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-identifier">a</span>] = <span class="ruby-identifier">photo_o</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>)
<span class="line-num">832</span>           <span class="ruby-keyword">end</span>
<span class="line-num">833</span>         <span class="ruby-keyword">end</span>
<span class="line-num">834</span>       <span class="ruby-keyword">end</span>
<span class="line-num">835</span>     <span class="ruby-keyword">end</span>
<span class="line-num">836</span> 
<span class="line-num">837</span>     <span class="ruby-comment"># Kind of like :ignore_photos, but :editing_sounds makes it opt-in rather than opt-out</span>
<span class="line-num">838</span>     <span class="ruby-comment"># If editing sounds and no sound parameters are present, assign to an empty array</span>
<span class="line-num">839</span>     <span class="ruby-comment"># This way, sounds will be removed</span>
<span class="line-num">840</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:editing_sounds</span>]
<span class="line-num">841</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:soundcloud_sounds</span>] <span class="ruby-operator">||=</span> {<span class="ruby-identifier">fieldset_index</span> <span class="ruby-operator">=&gt;</span> []} 
<span class="line-num">842</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:soundcloud_sounds</span>][<span class="ruby-identifier">fieldset_index</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">843</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:local_sounds</span>] <span class="ruby-operator">||=</span> {<span class="ruby-identifier">fieldset_index</span> <span class="ruby-operator">=&gt;</span> []} 
<span class="line-num">844</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:local_sounds</span>][<span class="ruby-identifier">fieldset_index</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">845</span>       <span class="ruby-identifier">sounds</span> = <span class="ruby-constant">Sound</span>.<span class="ruby-identifier">from_observation_params</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">fieldset_index</span>, <span class="ruby-identifier">current_user</span>)
<span class="line-num">846</span>       <span class="ruby-identifier">ensured_sounds</span> = <span class="ruby-identifier">ensure_sounds_are_local_sounds</span>( <span class="ruby-identifier">sounds</span> )
<span class="line-num">847</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">sounds</span> = <span class="ruby-identifier">ensured_sounds</span>
<span class="line-num">848</span>     <span class="ruby-keyword">end</span>
<span class="line-num">849</span>     
<span class="line-num">850</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">editing_user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">851</span> 
<span class="line-num">852</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">force_quality_metrics</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">hashed_params</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>][<span class="ruby-value">:captive_flag</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">853</span>     <span class="ruby-identifier">permitted_params</span> = <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Parameters</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">hashed_params</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>].<span class="ruby-identifier">to_h</span> )
<span class="line-num">854</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">update</span>( <span class="ruby-identifier">observation_params</span>( <span class="ruby-identifier">permitted_params</span> ) )
<span class="line-num">855</span>       <span class="ruby-identifier">errors</span> = <span class="ruby-keyword">true</span>
<span class="line-num">856</span>     <span class="ruby-keyword">end</span>
<span class="line-num">857</span> 
<span class="line-num">858</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">errors</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:project_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]).<span class="ruby-identifier">exists?</span>
<span class="line-num">859</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>])
<span class="line-num">860</span>         <span class="ruby-identifier">project_observation</span> = <span class="ruby-constant">ProjectObservation</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:project</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project</span>, <span class="ruby-value">:observation</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">observation</span>)
<span class="line-num">861</span>         <span class="ruby-identifier">extra_msg</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">project_observation</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">862</span>           <span class="ruby-node">&quot;Successfully added to #{@project.title}&quot;</span>
<span class="line-num">863</span>         <span class="ruby-keyword">else</span>
<span class="line-num">864</span>           <span class="ruby-node">&quot;Failed to add to #{@project.title}: #{project_observation.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">865</span>         <span class="ruby-keyword">end</span>
<span class="line-num">866</span>       <span class="ruby-keyword">end</span>
<span class="line-num">867</span>     <span class="ruby-keyword">end</span>
<span class="line-num">868</span>   <span class="ruby-keyword">end</span>
<span class="line-num">869</span> 
<span class="line-num">870</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>(
<span class="line-num">871</span>     <span class="ruby-value">ids:</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span> )
<span class="line-num">872</span>   )
<span class="line-num">873</span> 
<span class="line-num">874</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">875</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>
<span class="line-num">876</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">877</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">878</span>           <span class="ruby-ivar">@observation</span> = <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">first</span>
<span class="line-num">879</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;edit&#39;</span>
<span class="line-num">880</span>         <span class="ruby-keyword">else</span>
<span class="line-num">881</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;edit_batch&#39;</span>
<span class="line-num">882</span>         <span class="ruby-keyword">end</span>
<span class="line-num">883</span>       <span class="ruby-keyword">end</span>
<span class="line-num">884</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-value">:xml</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:errors</span>), <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">885</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">886</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">887</span>           <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>}.<span class="ruby-identifier">to_sentence</span>,
<span class="line-num">888</span>           <span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:errors</span>)
<span class="line-num">889</span>         }
<span class="line-num">890</span>       <span class="ruby-keyword">end</span>
<span class="line-num">891</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">892</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]
<span class="line-num">893</span>         <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_observation_no_longer_exists</span>)
<span class="line-num">894</span>       <span class="ruby-keyword">else</span>
<span class="line-num">895</span>         <span class="ruby-identifier">t</span>(<span class="ruby-value">:those_observations_no_longer_exist</span>)
<span class="line-num">896</span>       <span class="ruby-keyword">end</span>
<span class="line-num">897</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">898</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">899</span>         <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">observations_by_login_path</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">900</span>       <span class="ruby-keyword">end</span>
<span class="line-num">901</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:gone</span> }
<span class="line-num">902</span>     <span class="ruby-keyword">else</span>
<span class="line-num">903</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">904</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;#{t(:observations_was_successfully_updated)} #{extra_msg}&quot;</span>
<span class="line-num">905</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">906</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observation_path</span>(<span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">first</span>)
<span class="line-num">907</span>         <span class="ruby-keyword">else</span>
<span class="line-num">908</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">observations_by_login_path</span>(<span class="ruby-identifier">observation_user</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">909</span>         <span class="ruby-keyword">end</span>
<span class="line-num">910</span>       <span class="ruby-keyword">end</span>
<span class="line-num">911</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">head</span> <span class="ruby-value">:ok</span> }
<span class="line-num">912</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span> }
<span class="line-num">913</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">914</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_iphone_app_2?</span>
<span class="line-num">915</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observations</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_json</span>(
<span class="line-num">916</span>             <span class="ruby-value">viewer:</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">917</span>             <span class="ruby-value">methods:</span> [<span class="ruby-value">:user_login</span>, <span class="ruby-value">:iconic_taxon_name</span>],
<span class="line-num">918</span>             <span class="ruby-value">include:</span> {
<span class="line-num">919</span>               <span class="ruby-value">taxon:</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>,
<span class="line-num">920</span>               <span class="ruby-value">observation_field_values:</span> {},
<span class="line-num">921</span>               <span class="ruby-value">project_observations:</span> {
<span class="line-num">922</span>                 <span class="ruby-value">include:</span> {
<span class="line-num">923</span>                   <span class="ruby-value">project:</span> {
<span class="line-num">924</span>                     <span class="ruby-value">only:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:title</span>, <span class="ruby-value">:description</span>],
<span class="line-num">925</span>                     <span class="ruby-value">methods:</span> [<span class="ruby-value">:icon_url</span>]
<span class="line-num">926</span>                   }
<span class="line-num">927</span>                 }
<span class="line-num">928</span>               },
<span class="line-num">929</span>               <span class="ruby-value">observation_photos:</span> {
<span class="line-num">930</span>                 <span class="ruby-value">include:</span> {
<span class="line-num">931</span>                   <span class="ruby-value">photo:</span> {
<span class="line-num">932</span>                     <span class="ruby-value">methods:</span> [<span class="ruby-value">:license_code</span>, <span class="ruby-value">:attribution</span>],
<span class="line-num">933</span>                     <span class="ruby-value">except:</span> [<span class="ruby-value">:original_url</span>, <span class="ruby-value">:file_processing</span>, <span class="ruby-value">:file_file_size</span>, 
<span class="line-num">934</span>                       <span class="ruby-value">:file_content_type</span>, <span class="ruby-value">:file_file_name</span>, <span class="ruby-value">:mobile</span>, <span class="ruby-value">:metadata</span>, <span class="ruby-value">:user_id</span>, 
<span class="line-num">935</span>                       <span class="ruby-value">:native_realname</span>, <span class="ruby-value">:native_photo_id</span>]
<span class="line-num">936</span>                   }
<span class="line-num">937</span>                 }
<span class="line-num">938</span>               },
<span class="line-num">939</span>             } )
<span class="line-num">940</span>         <span class="ruby-keyword">else</span>
<span class="line-num">941</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">to_json</span>( <span class="ruby-value">methods:</span> [<span class="ruby-value">:user_login</span>, <span class="ruby-value">:iconic_taxon_name</span>], <span class="ruby-value">viewer:</span> <span class="ruby-identifier">current_user</span> )
<span class="line-num">942</span>         <span class="ruby-keyword">end</span>
<span class="line-num">943</span>       <span class="ruby-keyword">end</span>
<span class="line-num">944</span>     <span class="ruby-keyword">end</span>
<span class="line-num">945</span>   <span class="ruby-keyword">end</span>
<span class="line-num">946</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_fields">
            
              <b>update_fields</b>()
            
            <a href="../classes/ObservationsController.html#method-i-update_fields" name="method-i-update_fields" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_fields_source')" id="l_method-i-update_fields_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_fields_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1507</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_fields</span>
<span class="line-num">1508</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">fields_addable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">1509</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1510</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>)
<span class="line-num">1511</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1512</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1513</span>         <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">1514</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1515</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1516</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">1517</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1518</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1519</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1520</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1521</span> 
<span class="line-num">1522</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1523</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1524</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_must_choose_an_observation_field</span>)
<span class="line-num">1525</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1526</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1527</span>         <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">1528</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1529</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1530</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">1531</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1532</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1533</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1534</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1535</span> 
<span class="line-num">1536</span>   <span class="ruby-identifier">ofv_attrs</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation</span>][<span class="ruby-value">:observation_field_values_attributes</span>]
<span class="line-num">1537</span>   <span class="ruby-identifier">ofv_attrs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">1538</span>     <span class="ruby-identifier">ofv_attrs</span>[<span class="ruby-identifier">k</span>][<span class="ruby-value">:updater_id</span>] = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1539</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1540</span>   <span class="ruby-identifier">o</span> = { <span class="ruby-value">:observation_field_values_attributes</span> <span class="ruby-operator">=&gt;</span>  <span class="ruby-identifier">ofv_attrs</span>}
<span class="line-num">1541</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1542</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">o</span>)
<span class="line-num">1543</span>       <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>)
<span class="line-num">1544</span>         <span class="ruby-ivar">@project_observation</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">project:</span> <span class="ruby-ivar">@project</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1545</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1546</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1547</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-value">:observations_was_successfully_updated</span>)
<span class="line-num">1548</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project_observation</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">1549</span>           <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-value">:however_there_were_some_issues</span>, <span class="ruby-value">:issues</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@project_observation</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">to_sentence</span>)
<span class="line-num">1550</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1551</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">1552</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1553</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1554</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">to_json</span>(
<span class="line-num">1555</span>           <span class="ruby-value">:viewer</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">1556</span>           <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1557</span>             <span class="ruby-value">:observation_field_values</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:observation_field</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:name</span>]}}}
<span class="line-num">1558</span>           }
<span class="line-num">1559</span>         )
<span class="line-num">1560</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1561</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1562</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;Failed update observation: #{@observation.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">1563</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1564</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1565</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">1566</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1567</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1568</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}
<span class="line-num">1569</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1570</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1571</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1572</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_photos">
            
              <b>update_photos</b>()
            
            <a href="../classes/ObservationsController.html#method-i-update_photos" name="method-i-update_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_photos_source')" id="l_method-i-update_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">956</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_photos</span>
<span class="line-num">957</span>   <span class="ruby-ivar">@observation_photos</span> = <span class="ruby-constant">ObservationPhoto</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_photos</span>].<span class="ruby-identifier">to_h</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>})
<span class="line-num">958</span>   <span class="ruby-ivar">@observation_photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span>
<span class="line-num">959</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">observation_photo_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">op</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">960</span>     <span class="ruby-identifier">op</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_photos</span>][<span class="ruby-identifier">op</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>])
<span class="line-num">961</span>   <span class="ruby-keyword">end</span>
<span class="line-num">962</span>   
<span class="line-num">963</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:photos_updated</span>)
<span class="line-num">964</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_observation_path</span>(<span class="ruby-ivar">@observation</span>)
<span class="line-num">965</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-upload">
            
              <b>upload</b>()
            
            <a href="../classes/ObservationsController.html#method-i-upload" name="method-i-upload" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-upload_source')" id="l_method-i-upload_source">show</a>
                

                

                
              </p>
              <div id="method-i-upload_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1460</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">upload</span>
<span class="line-num">1461</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;basic&quot;</span>
<span class="line-num">1462</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-user_stats">
            
              <b>user_stats</b>()
            
            <a href="../classes/ObservationsController.html#method-i-user_stats" name="method-i-user_stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-user_stats_source')" id="l_method-i-user_stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-user_stats_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1716</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">user_stats</span>
<span class="line-num">1717</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:skip_order</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1718</span>   <span class="ruby-identifier">search_params</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">get_search_params</span>(<span class="ruby-identifier">params</span>,
<span class="line-num">1719</span>     <span class="ruby-value">current_user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1720</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:limit</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">1721</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-value">500</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">500</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
<span class="line-num">1722</span>   <span class="ruby-identifier">stats_adequately_scoped?</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">1723</span>   <span class="ruby-comment"># all the HTML view needs to know is stats_adequately_scoped?</span>
<span class="line-num">1724</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">json?</span>
<span class="line-num">1725</span>     <span class="ruby-identifier">elastic_user_stats</span>(<span class="ruby-identifier">search_params</span>, <span class="ruby-identifier">limit</span>)
<span class="line-num">1726</span>     <span class="ruby-ivar">@user_ids</span> = <span class="ruby-ivar">@user_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;user_id&quot;</span>] } <span class="ruby-operator">|</span>
<span class="line-num">1727</span>       <span class="ruby-ivar">@user_taxon_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;user_id&quot;</span>] }
<span class="line-num">1728</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@user_ids</span>).
<span class="line-num">1729</span>       <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;id, login, name, icon_file_name, icon_updated_at, icon_content_type&quot;</span>)
<span class="line-num">1730</span>     <span class="ruby-ivar">@users_by_id</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1731</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1732</span>     <span class="ruby-ivar">@user_counts</span> = [ ]
<span class="line-num">1733</span>     <span class="ruby-ivar">@user_taxon_counts</span> = [ ]
<span class="line-num">1734</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1735</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1736</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1737</span>       <span class="ruby-ivar">@headless</span> = <span class="ruby-keyword">true</span>
<span class="line-num">1738</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">1739</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1740</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1741</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">1742</span>         <span class="ruby-value">:total</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@total</span>,
<span class="line-num">1743</span>         <span class="ruby-value">:most_observations</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@user_counts</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">1744</span>           <span class="ruby-ivar">@users_by_id</span>[<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;user_id&#39;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span>
<span class="line-num">1745</span>           {
<span class="line-num">1746</span>             <span class="ruby-value">:count</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;count_all&#39;</span>].<span class="ruby-identifier">to_i</span>,
<span class="line-num">1747</span>             <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@users_by_id</span>[<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;user_id&#39;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">as_json</span>(
<span class="line-num">1748</span>               <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>],
<span class="line-num">1749</span>               <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_icon_url</span>]
<span class="line-num">1750</span>             )
<span class="line-num">1751</span>           }
<span class="line-num">1752</span>         }.<span class="ruby-identifier">compact</span>,
<span class="line-num">1753</span>         <span class="ruby-value">:most_species</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@user_taxon_counts</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">1754</span>           <span class="ruby-ivar">@users_by_id</span>[<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;user_id&#39;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span>
<span class="line-num">1755</span>           {
<span class="line-num">1756</span>             <span class="ruby-value">:count</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;count_all&#39;</span>].<span class="ruby-identifier">to_i</span>,
<span class="line-num">1757</span>             <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@users_by_id</span>[<span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;user_id&#39;</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">as_json</span>(
<span class="line-num">1758</span>               <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:login</span>],
<span class="line-num">1759</span>               <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:user_icon_url</span>]
<span class="line-num">1760</span>             )
<span class="line-num">1761</span>           }
<span class="line-num">1762</span>         }.<span class="ruby-identifier">compact</span>
<span class="line-num">1763</span>       }
<span class="line-num">1764</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1765</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1766</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-viewed_updates">
            
              <b>viewed_updates</b>()
            
            <a href="../classes/ObservationsController.html#method-i-viewed_updates" name="method-i-viewed_updates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-viewed_updates_source')" id="l_method-i-viewed_updates_source">show</a>
                

                

                
              </p>
              <div id="method-i-viewed_updates_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1968</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">viewed_updates</span>
<span class="line-num">1969</span>   <span class="ruby-identifier">user_viewed_updates</span>
<span class="line-num">1970</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1971</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@observation</span> }
<span class="line-num">1972</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
<span class="line-num">1973</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1974</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-widget">
            
              <b>widget</b>()
            
            <a href="../classes/ObservationsController.html#method-i-widget" name="method-i-widget" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-widget_source')" id="l_method-i-widget_source">show</a>
                

                

                
              </p>
              <div id="method-i-widget_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/observations_controller.rb</span>
<span class="line-num">1358</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">widget</span>
<span class="line-num">1359</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:project_id</span>]
<span class="line-num">1360</span>   <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>]
<span class="line-num">1361</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>]
<span class="line-num">1362</span>   <span class="ruby-ivar">@order_by</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:order_by</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;observed_on&quot;</span>
<span class="line-num">1363</span>   <span class="ruby-ivar">@order</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;desc&quot;</span>
<span class="line-num">1364</span>   <span class="ruby-ivar">@limit</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:limit</span>] <span class="ruby-operator">||</span> <span class="ruby-value">5</span>
<span class="line-num">1365</span>   <span class="ruby-ivar">@limit</span> = <span class="ruby-ivar">@limit</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">1366</span>   <span class="ruby-keyword">if</span> <span class="ruby-node">%w&quot;logo-small.gif logo-small.png logo-small-white.png none&quot;</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:logo</span>])
<span class="line-num">1367</span>     <span class="ruby-ivar">@logo</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:logo</span>] 
<span class="line-num">1368</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1369</span>   <span class="ruby-ivar">@logo</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;logo-small.gif&quot;</span>
<span class="line-num">1370</span>   <span class="ruby-ivar">@layout</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:layout</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;large&quot;</span>
<span class="line-num">1371</span>   <span class="ruby-identifier">url_params</span> = {
<span class="line-num">1372</span>     <span class="ruby-value">:format</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;widget&quot;</span>, 
<span class="line-num">1373</span>     <span class="ruby-value">:limit</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@limit</span>, 
<span class="line-num">1374</span>     <span class="ruby-value">:order</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@order</span>, 
<span class="line-num">1375</span>     <span class="ruby-value">:order_by</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@order_by</span>,
<span class="line-num">1376</span>     <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@layout</span>,
<span class="line-num">1377</span>   }
<span class="line-num">1378</span>   <span class="ruby-ivar">@widget_url</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">1379</span>     <span class="ruby-identifier">observations_url</span>(<span class="ruby-identifier">url_params</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:place_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">id</span>))
<span class="line-num">1380</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1381</span>     <span class="ruby-identifier">observations_url</span>(<span class="ruby-identifier">url_params</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>))
<span class="line-num">1382</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@project</span>
<span class="line-num">1383</span>     <span class="ruby-identifier">observations_for_project_url</span>( <span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">url_params</span> )
<span class="line-num">1384</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">1385</span>     <span class="ruby-identifier">observations_by_login_feed_url</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>, <span class="ruby-identifier">url_params</span>)
<span class="line-num">1386</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1387</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@widget_url</span>
<span class="line-num">1388</span>     <span class="ruby-ivar">@widget_url</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-string">&#39;http:&#39;</span>, <span class="ruby-string">&#39;&#39;</span>)
<span class="line-num">1389</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1390</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1391</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1392</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1393</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
