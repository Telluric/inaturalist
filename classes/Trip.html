<!DOCTYPE html>
<html lang="en">
<head>
    <title>Trip</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Trip"]'>


    <meta property="og:title" value="Trip">

  

    <meta name="keywords" content="Trip class, set_parent, observations, add_taxa_from_observations, obs_search_elastic_params, presence_absence">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Trip
            
                <span class="parent">&lt;
                    
                    <a href="Post.html">Post</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/models/trip_rb.html">app/models/trip.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add_taxa_from_observations">add_taxa_from_observations</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-obs_search_elastic_params">obs_search_elastic_params</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observations">observations</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-presence_absence">presence_absence</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-set_parent">set_parent</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">TRIP_PURPOSE_JOINS</td>
            <td>=</td>
            <td class="attr-value">[
&quot;JOIN trip_purposes tp ON tp.trip_id = posts.id&quot;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-presence_absence">
            
              <b>presence_absence</b>( trips, taxon_id, place_id, year, month )
            
            <a href="../classes/Trip.html#method-c-presence_absence" name="method-c-presence_absence" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-presence_absence_source')" id="l_method-c-presence_absence_source">show</a>
                

                

                
              </p>
              <div id="method-c-presence_absence_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/trip.rb</span>
<span class="line-num">72</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">presence_absence</span>( <span class="ruby-identifier">trips</span>, <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">place_id</span>, <span class="ruby-identifier">year</span>, <span class="ruby-identifier">month</span> )
<span class="line-num">73</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">trips</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">trips</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">74</span>   <span class="ruby-identifier">potential_trips</span> = <span class="ruby-identifier">trips</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">obs_search_elastic_params</span> }
<span class="line-num">75</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">potential_trips</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">76</span>   <span class="ruby-identifier">query</span> = {
<span class="line-num">77</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">78</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;taxon.ancestor_ids.keyword&quot;:</span> <span class="ruby-identifier">taxon_id</span> } },
<span class="line-num">79</span>     ],
<span class="line-num">80</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">81</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">82</span>       <span class="ruby-value">trips:</span> {
<span class="line-num">83</span>         <span class="ruby-value">filters:</span> {
<span class="line-num">84</span>           <span class="ruby-value">filters:</span> <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">potential_trips</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">trip</span><span class="ruby-operator">|</span>
<span class="line-num">85</span>             [ <span class="ruby-node">&quot;trip_#{trip.id}&quot;</span>, { <span class="ruby-value">bool:</span> { <span class="ruby-value">must:</span> <span class="ruby-identifier">trip</span>.<span class="ruby-identifier">obs_search_elastic_params</span> } } ]
<span class="line-num">86</span>           } ]
<span class="line-num">87</span>         }
<span class="line-num">88</span>       }
<span class="line-num">89</span>     }
<span class="line-num">90</span>   }
<span class="line-num">91</span>   <span class="ruby-identifier">query</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;place_ids.keyword&quot;:</span> <span class="ruby-identifier">place_id</span> } } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">92</span>   <span class="ruby-identifier">query</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;observed_on_details.year&quot;:</span> <span class="ruby-identifier">year</span> } } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">year</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">93</span>   <span class="ruby-identifier">query</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;observed_on_details.month&quot;:</span> <span class="ruby-identifier">month</span> } } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">month</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">94</span> 
<span class="line-num">95</span>   <span class="ruby-identifier">results</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>( <span class="ruby-identifier">query</span> )
<span class="line-num">96</span>   <span class="ruby-keyword">return</span> <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">results</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">trips</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">97</span>     [<span class="ruby-identifier">k</span>.<span class="ruby-identifier">sub</span>( <span class="ruby-string">&quot;trip_&quot;</span>, <span class="ruby-string">&quot;&quot;</span> ).<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">v</span>.<span class="ruby-identifier">doc_count</span>]
<span class="line-num">98</span>   }]
<span class="line-num">99</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-add_taxa_from_observations">
            
              <b>add_taxa_from_observations</b>()
            
            <a href="../classes/Trip.html#method-i-add_taxa_from_observations" name="method-i-add_taxa_from_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_taxa_from_observations_source')" id="l_method-i-add_taxa_from_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_taxa_from_observations_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/trip.rb</span>
<span class="line-num">38</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_taxa_from_observations</span>
<span class="line-num">39</span>   <span class="ruby-identifier">candidates</span> = []
<span class="line-num">40</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;DISTINCT ON (observations.taxon_id) observations.*&quot;</span>).
<span class="line-num">41</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.taxon_id IS NOT NULL&quot;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">42</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">trip_taxa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span>).<span class="ruby-identifier">exists?</span>
<span class="line-num">43</span>     <span class="ruby-identifier">tt</span> = <span class="ruby-constant">TripTaxon</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:trip</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">self</span>, <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>, <span class="ruby-value">:observed</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)
<span class="line-num">44</span>     <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">save</span>
<span class="line-num">45</span>     <span class="ruby-identifier">candidates</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tt</span>
<span class="line-num">46</span>   <span class="ruby-keyword">end</span>
<span class="line-num">47</span>   <span class="ruby-identifier">candidates</span>
<span class="line-num">48</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-obs_search_elastic_params">
            
              <b>obs_search_elastic_params</b>()
            
            <a href="../classes/Trip.html#method-i-obs_search_elastic_params" name="method-i-obs_search_elastic_params" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-obs_search_elastic_params_source')" id="l_method-i-obs_search_elastic_params_source">show</a>
                

                

                
              </p>
              <div id="method-i-obs_search_elastic_params_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/trip.rb</span>
<span class="line-num">50</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">obs_search_elastic_params</span>
<span class="line-num">51</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">start_time</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">stop_time</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span>
<span class="line-num">52</span>     <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">radius</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">radius</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">trip_purposes</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">53</span>   [
<span class="line-num">54</span>     {
<span class="line-num">55</span>       <span class="ruby-value">geo_distance:</span> {
<span class="line-num">56</span>         <span class="ruby-value">distance:</span> <span class="ruby-identifier">radius</span>, <span class="ruby-comment"># meters</span>
<span class="line-num">57</span>         <span class="ruby-value">location:</span> {
<span class="line-num">58</span>           <span class="ruby-value">lat:</span> <span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">to_f</span>,
<span class="line-num">59</span>           <span class="ruby-value">lon:</span> <span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">to_f</span>
<span class="line-num">60</span>         }
<span class="line-num">61</span>       }
<span class="line-num">62</span>     },
<span class="line-num">63</span>     { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;user.id&quot;:</span> <span class="ruby-identifier">user_id</span> } },
<span class="line-num">64</span>     { <span class="ruby-value">terms:</span> { <span class="ruby-value">&quot;taxon.ancestor_ids&quot;:</span> <span class="ruby-identifier">trip_purposes</span>.<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:resource_id</span> ) } },
<span class="line-num">65</span>     { <span class="ruby-value">range:</span> { <span class="ruby-value">&quot;time_observed_at&quot;:</span> {
<span class="line-num">66</span>       <span class="ruby-value">gte:</span> <span class="ruby-identifier">start_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%FT%T%:z&quot;</span>),
<span class="line-num">67</span>       <span class="ruby-value">lte:</span> <span class="ruby-identifier">stop_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%FT%T%:z&quot;</span>)
<span class="line-num">68</span>     } } }
<span class="line-num">69</span>   ]
<span class="line-num">70</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observations">
            
              <b>observations</b>()
            
            <a href="../classes/Trip.html#method-i-observations" name="method-i-observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observations_source')" id="l_method-i-observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-observations_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/trip.rb</span>
<span class="line-num">31</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observations</span>
<span class="line-num">32</span>   <span class="ruby-keyword">return</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;1 = 2&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">start_time</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">stop_time</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">33</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">user</span>).<span class="ruby-identifier">between_dates</span>(<span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">stop_time</span>)
<span class="line-num">34</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">in_place</span>(<span class="ruby-identifier">place_id</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">35</span>   <span class="ruby-identifier">scope</span>
<span class="line-num">36</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_parent">
            
              <b>set_parent</b>()
            
            <a href="../classes/Trip.html#method-i-set_parent" name="method-i-set_parent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_parent_source')" id="l_method-i-set_parent_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_parent_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/models/trip.rb</span>
<span class="line-num">27</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_parent</span>
<span class="line-num">28</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user</span>
<span class="line-num">29</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
