<!DOCTYPE html>
<html lang="en">
<head>
    <title>Identification</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["Identification"]'>


    <meta property="og:title" value="Identification">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="Identification class, as_indexed_json, prepare_batch_for_index, to_s, to_plain_s, uniqueness_of_current, replace_inactive_taxon, update_other_identifications, set_previous_observation_taxon, set_disagreement, update_observation_if_test_env, update_observation, update_observation_after_destroy, update_obs_stats, update_obs_stats_after_destroy, update_curator_identification, update_user_counter_cache, set_last_identification_as_current, revisit_curator_identification, create_observation_review, remove_automated_observation_reviews, flagged_with, is_agreement?, is_disagreement?, in_agreement_with?, update_quality_metrics, update_categories_for_observation, update_categories, mentioned_users, vision, vision=, taxon_name, taxon_rank, run_update_curator_identification, run_revisit_curator_identification, update_for_taxon_change, update_disagreement_identifications_for_taxon, reindex_for_taxon, merge_future_duplicates">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Identification
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationRecord.html">ApplicationRecord</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/es_indices/identification_index_rb.html">app/es_indices/identification_index.rb</a></li>
            
            <li><a href="../files/app/models/identification_rb.html">app/models/identification.rb</a></li>
            
            <li><a href="../files/lib/darwin_core/occurrence_rb.html">lib/darwin_core/occurrence.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-as_indexed_json">as_indexed_json</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-create_observation_review">create_observation_review</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-flagged_with">flagged_with</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-in_agreement_with-3F">in_agreement_with?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_agreement-3F">is_agreement?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-is_disagreement-3F">is_disagreement?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-mentioned_users">mentioned_users</a>,
              </li>
            
              
              <li>
                <a href="#method-c-merge_future_duplicates">merge_future_duplicates</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-prepare_batch_for_index">prepare_batch_for_index</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-reindex_for_taxon">reindex_for_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_automated_observation_reviews">remove_automated_observation_reviews</a>,
              </li>
            
              
              <li>
                <a href="#method-i-replace_inactive_taxon">replace_inactive_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-i-revisit_curator_identification">revisit_curator_identification</a>,
              </li>
            
              
              <li>
                <a href="#method-c-run_revisit_curator_identification">run_revisit_curator_identification</a>,
              </li>
            
              
              <li>
                <a href="#method-c-run_update_curator_identification">run_update_curator_identification</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-set_disagreement">set_disagreement</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_last_identification_as_current">set_last_identification_as_current</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_previous_observation_taxon">set_previous_observation_taxon</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-taxon_name">taxon_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxon_rank">taxon_rank</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_plain_s">to_plain_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-uniqueness_of_current">uniqueness_of_current</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_categories">update_categories</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_categories_for_observation">update_categories_for_observation</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_curator_identification">update_curator_identification</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_disagreement_identifications_for_taxon">update_disagreement_identifications_for_taxon</a>,
              </li>
            
              
              <li>
                <a href="#method-c-update_for_taxon_change">update_for_taxon_change</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_obs_stats">update_obs_stats</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_obs_stats_after_destroy">update_obs_stats_after_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation">update_observation</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation_after_destroy">update_observation_after_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_observation_if_test_env">update_observation_if_test_env</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_other_identifications">update_other_identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_quality_metrics">update_quality_metrics</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_user_counter_cache">update_user_counter_cache</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-vision">vision</a>,
              </li>
            
              
              <li>
                <a href="#method-i-vision-3D">vision=</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="ActsAsElasticModel.html">
              ActsAsElasticModel
            </a>
          
        </li>
      
        <li>
          
            <a href="Shared/TouchesObservationModule.html">
              Shared::TouchesObservationModule
            </a>
          
        </li>
      
        <li>
          
            <a href="ActsAsUUIDable.html">
              ActsAsUUIDable
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">CATEGORIES</td>
            <td>=</td>
            <td class="attr-value">[
IMPROVING,
SUPPORTING,
LEADING,
MAVERICK
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_ES_BATCH_SIZE</td>
            <td>=</td>
            <td class="attr-value">500</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SUBSCRIBABLE</td>
            <td>=</td>
            <td class="attr-value">false</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>bulk_delete</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>captive_flag</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>html</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_observation</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_set_disagreement</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>skip_set_previous_observation_taxon</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>wait_for_obs_index_refresh</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-merge_future_duplicates">
            
              <b>merge_future_duplicates</b>( reject, keeper )
            
            <a href="../classes/Identification.html#method-c-merge_future_duplicates" name="method-c-merge_future_duplicates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-merge_future_duplicates_source')" id="l_method-c-merge_future_duplicates_source">show</a>
                

                

                
              </p>
              <div id="method-c-merge_future_duplicates_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">738</span>   <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">merge_future_duplicates</span>( <span class="ruby-identifier">reject</span>, <span class="ruby-identifier">keeper</span> )
<span class="line-num">739</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] Identification.merge_future_duplicates, reject: #{reject}, keeper: #{keeper}&quot;</span>
<span class="line-num">740</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-identifier">keeper</span>.<span class="ruby-identifier">class</span> )
<span class="line-num">741</span>       <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;reject and keeper must by of the same class&quot;</span>
<span class="line-num">742</span>     <span class="ruby-keyword">end</span>
<span class="line-num">743</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">User</span> )
<span class="line-num">744</span>       <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Identification.merge_future_duplicates only works for observations right now&quot;</span>
<span class="line-num">745</span>     <span class="ruby-keyword">end</span>
<span class="line-num">746</span>     <span class="ruby-identifier">k</span>, <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">reflections</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">klass</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:belongs_to</span> }
<span class="line-num">747</span>     <span class="ruby-identifier">sql</span> = <span class="ruby-identifier">&lt;&lt;-SQL</span>
<span class="line-num">748</span> <span class="ruby-value">      SELECT
<span class="line-num">749</span>         observation_id,
<span class="line-num">750</span>         array_agg(id) AS ids
<span class="line-num">751</span>       FROM
<span class="line-num">752</span>         identifications
<span class="line-num">753</span>       WHERE
<span class="line-num">754</span>         current
<span class="line-num">755</span>         AND #{reflection.foreign_key} IN (#{reject.id},#{keeper.id})
<span class="line-num">756</span>       GROUP BY
<span class="line-num">757</span>         observation_id
<span class="line-num">758</span>       HAVING
<span class="line-num">759</span>         count(*) &gt; 1
<span class="line-num">760</span> </span><span class="ruby-identifier">    SQL</span>
<span class="line-num">761</span>     <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>( <span class="ruby-identifier">sql</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\s+/</span>, <span class="ruby-string">&quot; &quot;</span> ).<span class="ruby-identifier">strip</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">762</span>       <span class="ruby-identifier">to_merge_ids</span> = <span class="ruby-identifier">row</span>[<span class="ruby-string">&#39;ids&#39;</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[\{\}]/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>).<span class="ruby-identifier">sort</span>
<span class="line-num">763</span>       <span class="ruby-identifier">idents</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">to_merge_ids</span> )
<span class="line-num">764</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">reject_ident</span> = <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">foreign_key</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">reject</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">765</span>         <span class="ruby-identifier">reject_ident</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">current:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">766</span>       <span class="ruby-keyword">end</span>
<span class="line-num">767</span>     <span class="ruby-keyword">end</span>
<span class="line-num">768</span>   <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-prepare_batch_for_index">
            
              <b>prepare_batch_for_index</b>(identifications)
            
            <a href="../classes/Identification.html#method-c-prepare_batch_for_index" name="method-c-prepare_batch_for_index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-prepare_batch_for_index_source')" id="l_method-c-prepare_batch_for_index_source">show</a>
                

                

                
              </p>
              <div id="method-c-prepare_batch_for_index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/identification_index.rb</span>
<span class="line-num">183</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">prepare_batch_for_index</span>(<span class="ruby-identifier">identifications</span>)
<span class="line-num">184</span>   <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:observation</span>).<span class="ruby-identifier">compact</span>
<span class="line-num">185</span>   <span class="ruby-comment"># bulk load the IDs&#39; observations&#39; places</span>
<span class="line-num">186</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">prepare_batch_for_index</span>(<span class="ruby-identifier">obs</span>, { <span class="ruby-value">places:</span> <span class="ruby-keyword">true</span> })
<span class="line-num">187</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-reindex_for_taxon">
            
              <b>reindex_for_taxon</b>( taxon_id )
            
            <a href="../classes/Identification.html#method-c-reindex_for_taxon" name="method-c-reindex_for_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-reindex_for_taxon_source')" id="l_method-c-reindex_for_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-c-reindex_for_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">714</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">reindex_for_taxon</span>( <span class="ruby-identifier">taxon_id</span> )
<span class="line-num">715</span>   <span class="ruby-identifier">ident_ids</span> = []
<span class="line-num">716</span>   <span class="ruby-identifier">last_id</span> = <span class="ruby-value">0</span>
<span class="line-num">717</span>   <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
<span class="line-num">718</span>     <span class="ruby-identifier">r</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">719</span>       <span class="ruby-value">source:</span> {
<span class="line-num">720</span>         <span class="ruby-value">includes:</span> [<span class="ruby-string">&quot;id&quot;</span>],
<span class="line-num">721</span>       },
<span class="line-num">722</span>       <span class="ruby-value">filters:</span> [
<span class="line-num">723</span>         { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">gt:</span> <span class="ruby-identifier">last_id</span> } } },
<span class="line-num">724</span>         { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;taxon.ancestor_ids.keyword&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">taxon_id</span>] } }
<span class="line-num">725</span>       ],
<span class="line-num">726</span>       <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">727</span>       <span class="ruby-value">sort:</span> { <span class="ruby-value">id:</span> <span class="ruby-value">:asc</span> }
<span class="line-num">728</span>     ).<span class="ruby-identifier">per_page</span>( <span class="ruby-value">1000</span> )
<span class="line-num">729</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">response</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">hits</span>
<span class="line-num">730</span>     <span class="ruby-identifier">new_ident_ids</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:_id</span>)
<span class="line-num">731</span>     <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_ident_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">732</span>     <span class="ruby-identifier">last_id</span> = <span class="ruby-identifier">new_ident_ids</span>.<span class="ruby-identifier">last</span>
<span class="line-num">733</span>     <span class="ruby-identifier">ident_ids</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">new_ident_ids</span>
<span class="line-num">734</span>   <span class="ruby-keyword">end</span>
<span class="line-num">735</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">ident_ids</span> )
<span class="line-num">736</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-run_revisit_curator_identification">
            
              <b>run_revisit_curator_identification</b>(observation_id, user_id)
            
            <a href="../classes/Identification.html#method-c-run_revisit_curator_identification" name="method-c-run_revisit_curator_identification" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-run_revisit_curator_identification_source')" id="l_method-c-run_revisit_curator_identification_source">show</a>
                

                

                
              </p>
              <div id="method-c-run_revisit_curator_identification_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">559</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">run_revisit_curator_identification</span>(<span class="ruby-identifier">observation_id</span>, <span class="ruby-identifier">user_id</span>)
<span class="line-num">560</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">obs</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">observation_id</span>)
<span class="line-num">561</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">usr</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">562</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span>
<span class="line-num">563</span>     <span class="ruby-identifier">other_curator_conditions</span> = [<span class="ruby-string">&quot;project_id = ? AND role IN (?)&quot;</span>, <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, [<span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>]]
<span class="line-num">564</span>     <span class="ruby-comment"># The ident that was deleted is owned by user who is a curator of a project that that obs belongs to</span>
<span class="line-num">565</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">usr</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">other_curator_conditions</span>)
<span class="line-num">566</span>       <span class="ruby-identifier">other_curator_ident</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">567</span> 
<span class="line-num">568</span>       <span class="ruby-comment"># that project observation has other identifications that belong to users who are curators use those</span>
<span class="line-num">569</span>       <span class="ruby-identifier">po</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">other_ident</span><span class="ruby-operator">|</span>
<span class="line-num">570</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">other_curator_ident</span> = <span class="ruby-identifier">other_ident</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">other_curator_conditions</span>)
<span class="line-num">571</span>           <span class="ruby-identifier">po</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:curator_identification_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">other_ident</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">572</span>           <span class="ruby-keyword">break</span>
<span class="line-num">573</span>         <span class="ruby-keyword">end</span>
<span class="line-num">574</span>       <span class="ruby-keyword">end</span>
<span class="line-num">575</span> 
<span class="line-num">576</span>       <span class="ruby-identifier">po</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:curator_identification_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">other_curator_ident</span>
<span class="line-num">577</span>       <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">578</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_observations_counter_cache_from_project_and_user&quot;:</span>
<span class="line-num">579</span>           [ <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">580</span>       ).<span class="ruby-identifier">update_observations_counter_cache_from_project_and_user</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">581</span>       <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">582</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_taxa_counter_cache_from_project_and_user&quot;:</span>
<span class="line-num">583</span>           [ <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">584</span>       ).<span class="ruby-identifier">update_taxa_counter_cache_from_project_and_user</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">585</span>       <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">586</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Project::update_observed_taxa_count&quot;:</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span> }
<span class="line-num">587</span>       ).<span class="ruby-identifier">update_observed_taxa_count</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>)
<span class="line-num">588</span>     <span class="ruby-keyword">end</span>
<span class="line-num">589</span>   <span class="ruby-keyword">end</span>
<span class="line-num">590</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">591</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">592</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-run_update_curator_identification">
            
              <b>run_update_curator_identification</b>(ident)
            
            <a href="../classes/Identification.html#method-c-run_update_curator_identification" name="method-c-run_update_curator_identification" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Static ##################################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-run_update_curator_identification_source')" id="l_method-c-run_update_curator_identification_source">show</a>
                

                

                
              </p>
              <div id="method-c-run_update_curator_identification_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">528</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">run_update_curator_identification</span>(<span class="ruby-identifier">ident</span>)
<span class="line-num">529</span>   <span class="ruby-identifier">ident</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">ident</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Identification</span>)
<span class="line-num">530</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>
<span class="line-num">531</span>   <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">observation</span>
<span class="line-num">532</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">obs</span>
<span class="line-num">533</span>   <span class="ruby-identifier">current_ident</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">current?</span>
<span class="line-num">534</span>     <span class="ruby-identifier">ident</span>
<span class="line-num">535</span>   <span class="ruby-keyword">else</span>
<span class="line-num">536</span>     <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">ident</span>.<span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">current</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id asc&quot;</span>).<span class="ruby-identifier">last</span>
<span class="line-num">537</span>   <span class="ruby-keyword">end</span>
<span class="line-num">538</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_ident</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">539</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span>
<span class="line-num">540</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_ident</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">project_users</span>.<span class="ruby-identifier">exists?</span>([<span class="ruby-string">&quot;project_id = ? AND role IN (?)&quot;</span>, <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, [<span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span>, <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>]])
<span class="line-num">541</span>       <span class="ruby-identifier">po</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:curator_identification_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_ident</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">542</span>       <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">543</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_observations_counter_cache_from_project_and_user&quot;:</span>
<span class="line-num">544</span>           [ <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">545</span>       ).<span class="ruby-identifier">update_observations_counter_cache_from_project_and_user</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">546</span>       <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">547</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_taxa_counter_cache_from_project_and_user&quot;:</span>
<span class="line-num">548</span>           [ <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">549</span>       ).<span class="ruby-identifier">update_taxa_counter_cache_from_project_and_user</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">550</span>       <span class="ruby-constant">Project</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">551</span>         <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Project::update_observed_taxa_count&quot;:</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span> }
<span class="line-num">552</span>       ).<span class="ruby-identifier">update_observed_taxa_count</span>(<span class="ruby-identifier">po</span>.<span class="ruby-identifier">project_id</span>)
<span class="line-num">553</span>     <span class="ruby-keyword">end</span>
<span class="line-num">554</span>   <span class="ruby-keyword">end</span>
<span class="line-num">555</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">556</span>   <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">557</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_categories_for_observation">
            
              <b>update_categories_for_observation</b>( o, options = {} )
            
            <a href="../classes/Identification.html#method-c-update_categories_for_observation" name="method-c-update_categories_for_observation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_categories_for_observation_source')" id="l_method-c-update_categories_for_observation_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_categories_for_observation_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">439</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_categories_for_observation</span>( <span class="ruby-identifier">o</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">440</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_reload</span>]
<span class="line-num">441</span>     <span class="ruby-identifier">o</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">o</span> ).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:community_taxon</span>).<span class="ruby-identifier">first</span>
<span class="line-num">442</span>   <span class="ruby-keyword">end</span>
<span class="line-num">443</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span>
<span class="line-num">444</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_reload</span>]
<span class="line-num">445</span>     <span class="ruby-identifier">idents</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">identifications</span>
<span class="line-num">446</span>   <span class="ruby-keyword">else</span>
<span class="line-num">447</span>     <span class="ruby-identifier">idents</span> = <span class="ruby-constant">Identification</span>.
<span class="line-num">448</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon</span>).
<span class="line-num">449</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">observation_id:</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">450</span>   <span class="ruby-keyword">end</span>
<span class="line-num">451</span>   <span class="ruby-identifier">categories</span> = {
<span class="line-num">452</span>     <span class="ruby-value">improving:</span> [],
<span class="line-num">453</span>     <span class="ruby-value">leading:</span> [],
<span class="line-num">454</span>     <span class="ruby-value">supporting:</span> [],
<span class="line-num">455</span>     <span class="ruby-value">maverick:</span> [],
<span class="line-num">456</span>     <span class="ruby-value">removed:</span> []
<span class="line-num">457</span>   }
<span class="line-num">458</span>   <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span>
<span class="line-num">459</span>     <span class="ruby-identifier">ancestor_of_community_taxon</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon_id</span> )
<span class="line-num">460</span>     <span class="ruby-identifier">descendant_of_community_taxon</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon_id</span> )
<span class="line-num">461</span>     <span class="ruby-identifier">matches_community_taxon</span> = <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon_id</span> )
<span class="line-num">462</span>     <span class="ruby-identifier">progressive</span> = ( <span class="ruby-identifier">categories</span>[<span class="ruby-value">:improving</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">categories</span>[<span class="ruby-value">:supporting</span>] ).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">463</span>       <span class="ruby-identifier">i</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon_id</span> )
<span class="line-num">464</span>     }.<span class="ruby-identifier">blank?</span>
<span class="line-num">465</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">descendant_of_community_taxon</span>
<span class="line-num">466</span>       <span class="ruby-identifier">categories</span>[<span class="ruby-value">:leading</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>
<span class="line-num">467</span>     <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">ancestor_of_community_taxon</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">matches_community_taxon</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">progressive</span>
<span class="line-num">468</span>       <span class="ruby-identifier">categories</span>[<span class="ruby-value">:improving</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>
<span class="line-num">469</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ancestor_of_community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">descendant_of_community_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">matches_community_taxon</span>
<span class="line-num">470</span>       <span class="ruby-identifier">categories</span>[<span class="ruby-value">:maverick</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>
<span class="line-num">471</span>     <span class="ruby-keyword">else</span>
<span class="line-num">472</span>       <span class="ruby-identifier">categories</span>[<span class="ruby-value">:supporting</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>
<span class="line-num">473</span>     <span class="ruby-keyword">end</span>
<span class="line-num">474</span>   <span class="ruby-keyword">end</span>
<span class="line-num">475</span>   <span class="ruby-identifier">categories</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">category</span>, <span class="ruby-identifier">idents</span><span class="ruby-operator">|</span>
<span class="line-num">476</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">477</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">category:</span> <span class="ruby-identifier">category</span> )
<span class="line-num">478</span>   <span class="ruby-keyword">end</span>
<span class="line-num">479</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:skip_indexing</span>]
<span class="line-num">480</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) )
<span class="line-num">481</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">482</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">wait_for_index_refresh</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:wait_for_obs_index_refresh</span>]
<span class="line-num">483</span>     <span class="ruby-identifier">o</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">484</span>   <span class="ruby-keyword">end</span>
<span class="line-num">485</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_disagreement_identifications_for_taxon">
            
              <b>update_disagreement_identifications_for_taxon</b>( taxon )
            
            <a href="../classes/Identification.html#method-c-update_disagreement_identifications_for_taxon" name="method-c-update_disagreement_identifications_for_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_disagreement_identifications_for_taxon_source')" id="l_method-c-update_disagreement_identifications_for_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_disagreement_identifications_for_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">677</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_disagreement_identifications_for_taxon</span>( <span class="ruby-identifier">taxon</span> )
<span class="line-num">678</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">taxon</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Taxon</span> )
<span class="line-num">679</span>   <span class="ruby-identifier">block</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span>
<span class="line-num">680</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">previous_observation_taxon_id</span> )
<span class="line-num">681</span>       <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">disagreement:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">682</span>     <span class="ruby-keyword">end</span>
<span class="line-num">683</span>   }
<span class="line-num">684</span>   <span class="ruby-identifier">batch_size</span> = <span class="ruby-value">200</span>
<span class="line-num">685</span>   <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-value">0</span>
<span class="line-num">686</span>   <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">true</span>
<span class="line-num">687</span>   <span class="ruby-keyword">while</span> <span class="ruby-identifier">results_remaining</span>
<span class="line-num">688</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">689</span>       <span class="ruby-identifier">ident_response</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">690</span>         <span class="ruby-value">size:</span> <span class="ruby-identifier">batch_size</span>,
<span class="line-num">691</span>         <span class="ruby-value">filters:</span> [
<span class="line-num">692</span>           { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;taxon.ancestor_ids.keyword&quot;:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> } },
<span class="line-num">693</span>           { <span class="ruby-value">term:</span> { <span class="ruby-value">disagreement:</span> <span class="ruby-keyword">true</span> } },
<span class="line-num">694</span>           { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">gt:</span> <span class="ruby-identifier">batch_start_id</span> } } }
<span class="line-num">695</span>         ],
<span class="line-num">696</span>         <span class="ruby-value">sort:</span> { <span class="ruby-value">id:</span> <span class="ruby-value">:asc</span> },
<span class="line-num">697</span>         <span class="ruby-value">source:</span> [<span class="ruby-value">:id</span>]
<span class="line-num">698</span>       )
<span class="line-num">699</span>       <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ident_response</span>.<span class="ruby-identifier">response</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ident_response</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">total</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">batch_size</span>
<span class="line-num">700</span>         <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">false</span>
<span class="line-num">701</span>       <span class="ruby-keyword">end</span>
<span class="line-num">702</span>       <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">ident_response</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">_source</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">703</span>       <span class="ruby-constant">Identification</span>.
<span class="line-num">704</span>         <span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">ids</span> ).
<span class="line-num">705</span>         <span class="ruby-identifier">includes</span>( <span class="ruby-value">:taxon</span> ).
<span class="line-num">706</span>         <span class="ruby-identifier">find_each</span>( <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span> )
<span class="line-num">707</span>       <span class="ruby-identifier">batch_start_id</span> = <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">last</span>
<span class="line-num">708</span>     <span class="ruby-keyword">rescue</span>
<span class="line-num">709</span>       <span class="ruby-identifier">results_remaining</span> = <span class="ruby-keyword">false</span>
<span class="line-num">710</span>     <span class="ruby-keyword">end</span>
<span class="line-num">711</span>   <span class="ruby-keyword">end</span>
<span class="line-num">712</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-update_for_taxon_change">
            
              <b>update_for_taxon_change</b>( taxon_change, options = {} )
            
            <a href="../classes/Identification.html#method-c-update_for_taxon_change" name="method-c-update_for_taxon_change" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-update_for_taxon_change_source')" id="l_method-c-update_for_taxon_change_source">show</a>
                

                

                
              </p>
              <div id="method-c-update_for_taxon_change_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">594</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">update_for_taxon_change</span>( <span class="ruby-identifier">taxon_change</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">595</span>   <span class="ruby-identifier">input_taxon_ids</span> = <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">input_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">596</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications.taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">input_taxon_ids</span> )
<span class="line-num">597</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>]
<span class="line-num">598</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications.id IN (?)&quot;</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:records</span>] ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:records</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">599</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>]
<span class="line-num">600</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]
<span class="line-num">601</span>   <span class="ruby-comment"># these are involved in validations, so it helps to load them</span>
<span class="line-num">602</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">includes</span>( { <span class="ruby-value">observation:</span> <span class="ruby-value">:observations_places</span> }, <span class="ruby-value">:user</span> )
<span class="line-num">603</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications.created_at &lt; ?&quot;</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">604</span>   <span class="ruby-identifier">observation_ids</span> = []
<span class="line-num">605</span>   <span class="ruby-identifier">ident_ids</span> = []
<span class="line-num">606</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span>
<span class="line-num">607</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">output_taxon</span> = <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">output_taxon_for_record</span>( <span class="ruby-identifier">ident</span> )
<span class="line-num">608</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">automatable_for_output?</span>( <span class="ruby-identifier">output_taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">609</span>     <span class="ruby-identifier">new_ident</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">610</span>       <span class="ruby-value">observation_id:</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">observation_id</span>,
<span class="line-num">611</span>       <span class="ruby-value">taxon:</span> <span class="ruby-identifier">output_taxon</span>, 
<span class="line-num">612</span>       <span class="ruby-value">user_id:</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">user_id</span>,
<span class="line-num">613</span>       <span class="ruby-value">taxon_change:</span> <span class="ruby-identifier">taxon_change</span>,
<span class="line-num">614</span>       <span class="ruby-value">disagreement:</span> <span class="ruby-keyword">false</span>,
<span class="line-num">615</span>       <span class="ruby-value">skip_set_disagreement:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">616</span>       <span class="ruby-value">skip_indexing:</span> <span class="ruby-keyword">true</span>
<span class="line-num">617</span>     )
<span class="line-num">618</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">disagreement</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">previous_observation_taxon</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">current_synonym</span> = <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">current_synonymous_taxon</span> )
<span class="line-num">619</span>       <span class="ruby-identifier">new_ident</span>.<span class="ruby-identifier">disagreement</span> = <span class="ruby-keyword">true</span>
<span class="line-num">620</span>       <span class="ruby-identifier">new_ident</span>.<span class="ruby-identifier">skip_set_previous_observation_taxon</span> = <span class="ruby-keyword">true</span>
<span class="line-num">621</span>       <span class="ruby-identifier">new_ident</span>.<span class="ruby-identifier">previous_observation_taxon</span> = <span class="ruby-identifier">current_synonym</span>
<span class="line-num">622</span>     <span class="ruby-keyword">end</span>
<span class="line-num">623</span>     <span class="ruby-identifier">new_ident</span>.<span class="ruby-identifier">skip_observation</span> = <span class="ruby-keyword">true</span>
<span class="line-num">624</span>     <span class="ruby-identifier">new_ident</span>.<span class="ruby-identifier">save</span>
<span class="line-num">625</span>     <span class="ruby-identifier">observation_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">observation_id</span>
<span class="line-num">626</span>     <span class="ruby-identifier">ident_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">id</span>
<span class="line-num">627</span>     <span class="ruby-keyword">yield</span>( <span class="ruby-identifier">new_ident</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
<span class="line-num">628</span>   <span class="ruby-keyword">end</span>
<span class="line-num">629</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;disagreement AND previous_observation_taxon_id IN (?)&quot;</span>, <span class="ruby-identifier">input_taxon_ids</span> ).<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ident</span><span class="ruby-operator">|</span>
<span class="line-num">630</span>     <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">skip_observation</span> = <span class="ruby-keyword">true</span>
<span class="line-num">631</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">TaxonMerge</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">TaxonSwap</span> )
<span class="line-num">632</span>       <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">update</span>(
<span class="line-num">633</span>         <span class="ruby-value">skip_set_previous_observation_taxon:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">634</span>         <span class="ruby-value">previous_observation_taxon:</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">output_taxon</span>,
<span class="line-num">635</span>         <span class="ruby-value">skip_indexing:</span> <span class="ruby-keyword">true</span>
<span class="line-num">636</span>       )
<span class="line-num">637</span>       <span class="ruby-identifier">observation_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">observation_id</span>
<span class="line-num">638</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">TaxonSplit</span> )
<span class="line-num">639</span>       <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">disagreement:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">skip_indexing:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">640</span>       <span class="ruby-identifier">observation_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">observation_id</span>
<span class="line-num">641</span>     <span class="ruby-keyword">end</span>
<span class="line-num">642</span>     <span class="ruby-identifier">ident_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">id</span>
<span class="line-num">643</span>   <span class="ruby-keyword">end</span>
<span class="line-num">644</span>   <span class="ruby-identifier">observation_ids</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">in_groups_of</span>( <span class="ruby-value">100</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obs_ids</span><span class="ruby-operator">|</span>
<span class="line-num">645</span>     <span class="ruby-identifier">obs_ids</span>.<span class="ruby-identifier">compact!</span>
<span class="line-num">646</span>     <span class="ruby-identifier">batch</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">obs_ids</span> )
<span class="line-num">647</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>( <span class="ruby-identifier">batch</span>, [{ <span class="ruby-value">identifications:</span> <span class="ruby-value">:taxon</span> }, <span class="ruby-value">:community_taxon</span>] )
<span class="line-num">648</span>     <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obs</span><span class="ruby-operator">|</span>
<span class="line-num">649</span>       <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">650</span>         <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">651</span>         <span class="ruby-value">unique_hash:</span> {
<span class="line-num">652</span>           <span class="ruby-value">&quot;ProjectUser::update_taxa_obs_and_observed_taxa_count_after_update_observation&quot;:</span> [ <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> ]
<span class="line-num">653</span>         }
<span class="line-num">654</span>       ).<span class="ruby-identifier">update_taxa_obs_and_observed_taxa_count_after_update_observation</span>( <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">user_id</span> )
<span class="line-num">655</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">set_community_taxon</span>( <span class="ruby-value">force:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">656</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">657</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">skip_refresh_check_lists</span> = <span class="ruby-keyword">true</span>
<span class="line-num">658</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">skip_identifications</span> = <span class="ruby-keyword">true</span>
<span class="line-num">659</span>       <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">save</span>
<span class="line-num">660</span>       <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">update_categories_for_observation</span>( <span class="ruby-identifier">obs</span>, <span class="ruby-value">skip_reload:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">skip_indexing:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">661</span>       <span class="ruby-identifier">ident_ids</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">identification_ids</span>
<span class="line-num">662</span>     <span class="ruby-keyword">end</span>
<span class="line-num">663</span>   <span class="ruby-keyword">end</span>
<span class="line-num">664</span>   <span class="ruby-comment"># Get observations that may have received new identifications from this</span>
<span class="line-num">665</span>   <span class="ruby-comment"># change from a previous attempt to commit records for this change, in case</span>
<span class="line-num">666</span>   <span class="ruby-comment"># a previous attempt hit an error and stopped before indexing some records</span>
<span class="line-num">667</span>   <span class="ruby-identifier">observation_ids</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(
<span class="line-num">668</span>     <span class="ruby-node">&quot;SELECT DISTINCT observation_id FROM identifications WHERE taxon_change_id = #{taxon_change.id}&quot;</span>
<span class="line-num">669</span>   ).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;observation_id&quot;</span>].<span class="ruby-identifier">to_i</span> }
<span class="line-num">670</span>   <span class="ruby-identifier">observation_ids</span>.<span class="ruby-identifier">uniq!</span>
<span class="line-num">671</span>   <span class="ruby-identifier">ident_ids</span>.<span class="ruby-identifier">uniq!</span>
<span class="line-num">672</span>   
<span class="line-num">673</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">ident_ids</span> )
<span class="line-num">674</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> <span class="ruby-identifier">observation_ids</span> )
<span class="line-num">675</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-as_indexed_json">
            
              <b>as_indexed_json</b>(options={})
            
            <a href="../classes/Identification.html#method-i-as_indexed_json" name="method-i-as_indexed_json" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-as_indexed_json_source')" id="l_method-i-as_indexed_json_source">show</a>
                

                

                
              </p>
              <div id="method-i-as_indexed_json_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/es_indices/identification_index.rb</span>
<span class="line-num">149</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">as_indexed_json</span>(<span class="ruby-identifier">options</span>={})
<span class="line-num">150</span>   <span class="ruby-identifier">json</span> = {
<span class="line-num">151</span>     <span class="ruby-value">id:</span> <span class="ruby-identifier">id</span>,
<span class="line-num">152</span>     <span class="ruby-value">uuid:</span> <span class="ruby-identifier">uuid</span>,
<span class="line-num">153</span>     <span class="ruby-value">user:</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">no_details:</span> <span class="ruby-keyword">true</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">154</span>     <span class="ruby-value">created_at:</span> <span class="ruby-identifier">created_at</span>,
<span class="line-num">155</span>     <span class="ruby-value">created_at_details:</span> <span class="ruby-constant">ElasticModel</span>.<span class="ruby-identifier">date_details</span>(<span class="ruby-identifier">created_at</span>),
<span class="line-num">156</span>     <span class="ruby-value">body:</span> <span class="ruby-identifier">body</span>,
<span class="line-num">157</span>     <span class="ruby-value">category:</span> <span class="ruby-identifier">category</span>,
<span class="line-num">158</span>     <span class="ruby-value">current:</span> <span class="ruby-identifier">current</span>,
<span class="line-num">159</span>     <span class="ruby-value">flags:</span> <span class="ruby-identifier">flags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>),
<span class="line-num">160</span>     <span class="ruby-value">own_observation:</span> <span class="ruby-identifier">observation</span> <span class="ruby-operator">?</span> (<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>,
<span class="line-num">161</span>     <span class="ruby-value">taxon_change:</span> <span class="ruby-identifier">taxon_change</span> <span class="ruby-operator">?</span> {
<span class="line-num">162</span>       <span class="ruby-value">id:</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">163</span>       <span class="ruby-value">type:</span> <span class="ruby-identifier">taxon_change</span>.<span class="ruby-identifier">type</span>
<span class="line-num">164</span>     } <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>,
<span class="line-num">165</span>     <span class="ruby-value">vision:</span> <span class="ruby-identifier">vision</span>,
<span class="line-num">166</span>     <span class="ruby-value">disagreement:</span> <span class="ruby-identifier">disagreement</span>,
<span class="line-num">167</span>     <span class="ruby-value">previous_observation_taxon_id:</span> <span class="ruby-identifier">previous_observation_taxon_id</span>,
<span class="line-num">168</span>     <span class="ruby-value">spam:</span> <span class="ruby-identifier">known_spam?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">owned_by_spammer?</span>,
<span class="line-num">169</span>     <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon_id</span>,
<span class="line-num">170</span>     <span class="ruby-value">hidden:</span> <span class="ruby-identifier">hidden?</span>
<span class="line-num">171</span>   }
<span class="line-num">172</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:no_details</span>]
<span class="line-num">173</span>     <span class="ruby-identifier">json</span>.<span class="ruby-identifier">merge!</span>({
<span class="line-num">174</span>       <span class="ruby-value">current_taxon:</span> (<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon_id</span>),
<span class="line-num">175</span>       <span class="ruby-value">taxon:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">no_details:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">for_identification:</span> <span class="ruby-keyword">true</span>),
<span class="line-num">176</span>       <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">as_indexed_json</span>(<span class="ruby-value">no_details:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">for_identification:</span> <span class="ruby-keyword">true</span>),
<span class="line-num">177</span>       <span class="ruby-value">moderator_actions:</span> <span class="ruby-identifier">moderator_actions</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>)
<span class="line-num">178</span>     })
<span class="line-num">179</span>   <span class="ruby-keyword">end</span>
<span class="line-num">180</span>   <span class="ruby-identifier">json</span>
<span class="line-num">181</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create_observation_review">
            
              <b>create_observation_review</b>()
            
            <a href="../classes/Identification.html#method-i-create_observation_review" name="method-i-create_observation_review" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_observation_review_source')" id="l_method-i-create_observation_review_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_observation_review_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">369</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_observation_review</span>
<span class="line-num">370</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">371</span>   <span class="ruby-constant">ObservationReview</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-identifier">observation_id</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>).
<span class="line-num">372</span>     <span class="ruby-identifier">first_or_create</span>.
<span class="line-num">373</span>     <span class="ruby-identifier">update</span>( <span class="ruby-value">reviewed:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">374</span>   <span class="ruby-keyword">true</span>
<span class="line-num">375</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flagged_with">
            
              <b>flagged_with</b>(flag, options)
            
            <a href="../classes/Identification.html#method-i-flagged_with" name="method-i-flagged_with" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flagged_with_source')" id="l_method-i-flagged_with_source">show</a>
                

                

                
              </p>
              <div id="method-i-flagged_with_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">383</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flagged_with</span>(<span class="ruby-identifier">flag</span>, <span class="ruby-identifier">options</span>)
<span class="line-num">384</span>   <span class="ruby-identifier">evaluate_new_flag_for_spam</span>(<span class="ruby-identifier">flag</span>)
<span class="line-num">385</span>   <span class="ruby-identifier">elastic_index!</span>
<span class="line-num">386</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>
<span class="line-num">387</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">388</span>   <span class="ruby-keyword">end</span>
<span class="line-num">389</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-in_agreement_with-3F">
            
              <b>in_agreement_with?</b>(identification)
            
            <a href="../classes/Identification.html#method-i-in_agreement_with-3F" name="method-i-in_agreement_with-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Tests whether this identification should be considered an agreement with another identification.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-in_agreement_with-3F_source')" id="l_method-i-in_agreement_with-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-in_agreement_with-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">425</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">in_agreement_with?</span>(<span class="ruby-identifier">identification</span>)
<span class="line-num">426</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">identification</span>
<span class="line-num">427</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">identification</span>.<span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">428</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">identification</span>.<span class="ruby-identifier">taxon_id</span>
<span class="line-num">429</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">in_taxon?</span> <span class="ruby-identifier">identification</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">430</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_agreement-3F">
            
              <b>is_agreement?</b>(options = {})
            
            <a href="../classes/Identification.html#method-i-is_agreement-3F" name="method-i-is_agreement-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Tests whether this identification should be considered an agreement with the observation&#39;s taxon.  If this identification has the same taxon or a descendant taxon of the observation&#39;s taxon, then they agree.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_agreement-3F_source')" id="l_method-i-is_agreement-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_agreement-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">398</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_agreement?</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">399</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">frozen?</span>
<span class="line-num">400</span>   <span class="ruby-identifier">o</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:observation</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">observation</span>
<span class="line-num">401</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">402</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">403</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">404</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span>
<span class="line-num">405</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">in_taxon?</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span>
<span class="line-num">406</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-is_disagreement-3F">
            
              <b>is_disagreement?</b>( options = {} )
            
            <a href="../classes/Identification.html#method-i-is_disagreement-3F" name="method-i-is_disagreement-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>def old_is_disagreement?(options = {})</p>

<pre><code>return false if frozen?
o = options[:observation] || observation
return false if o.user_id == user_id
return false if o.identifications.count == 1
prior_community_taxon = o.get_community_taxon( before: id, force: true )
!prior_community_taxon.self_and_ancestor_ids.include?( taxon.id ) &amp;&amp; !taxon.self_and_ancestor_ids.include?( prior_community_taxon.id )
</code></pre>

<p>end</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-is_disagreement-3F_source')" id="l_method-i-is_disagreement-3F_source">show</a>
                

                

                
              </p>
              <div id="method-i-is_disagreement-3F_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">417</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">is_disagreement?</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">418</span>   <span class="ruby-identifier">disagreement</span>
<span class="line-num">419</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mentioned_users">
            
              <b>mentioned_users</b>()
            
            <a href="../classes/Identification.html#method-i-mentioned_users" name="method-i-mentioned_users" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mentioned_users_source')" id="l_method-i-mentioned_users_source">show</a>
                

                

                
              </p>
              <div id="method-i-mentioned_users_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">505</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mentioned_users</span>
<span class="line-num">506</span>   <span class="ruby-keyword">return</span> [ ] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">body</span>
<span class="line-num">507</span>   <span class="ruby-identifier">body</span>.<span class="ruby-identifier">mentioned_users</span>
<span class="line-num">508</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_automated_observation_reviews">
            
              <b>remove_automated_observation_reviews</b>()
            
            <a href="../classes/Identification.html#method-i-remove_automated_observation_reviews" name="method-i-remove_automated_observation_reviews" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_automated_observation_reviews_source')" id="l_method-i-remove_automated_observation_reviews_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_automated_observation_reviews_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">377</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_automated_observation_reviews</span>
<span class="line-num">378</span>   <span class="ruby-constant">ObservationReview</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">observation_id:</span> <span class="ruby-identifier">observation_id</span>,
<span class="line-num">379</span>     <span class="ruby-value">user_id:</span> <span class="ruby-identifier">user_id</span>, <span class="ruby-value">user_added:</span> <span class="ruby-keyword">false</span>).<span class="ruby-identifier">destroy_all</span>
<span class="line-num">380</span>   <span class="ruby-keyword">true</span>
<span class="line-num">381</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-replace_inactive_taxon">
            
              <b>replace_inactive_taxon</b>()
            
            <a href="../classes/Identification.html#method-i-replace_inactive_taxon" name="method-i-replace_inactive_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Callbacks ###############################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-replace_inactive_taxon_source')" id="l_method-i-replace_inactive_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-replace_inactive_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">150</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">replace_inactive_taxon</span>
<span class="line-num">151</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_active?</span>
<span class="line-num">152</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">candidate</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">current_synonymous_taxon</span>
<span class="line-num">153</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">candidate</span>
<span class="line-num">154</span>   <span class="ruby-keyword">true</span>
<span class="line-num">155</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-revisit_curator_identification">
            
              <b>revisit_curator_identification</b>()
            
            <a href="../classes/Identification.html#method-i-revisit_curator_identification" name="method-i-revisit_curator_identification" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Revise the project_observation curator_identification_id if the a curator&#39;s identification is deleted to be nil or that of another curator</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-revisit_curator_identification_source')" id="l_method-i-revisit_curator_identification_source">show</a>
                

                

                
              </p>
              <div id="method-i-revisit_curator_identification_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">359</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">revisit_curator_identification</span>
<span class="line-num">360</span>   <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">361</span>     <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">362</span>     <span class="ruby-value">unique_hash:</span> {
<span class="line-num">363</span>       <span class="ruby-value">&quot;Identification::revisit_curator_identification&quot;:</span> [ <span class="ruby-identifier">observation_id</span>, <span class="ruby-identifier">user_id</span> ]
<span class="line-num">364</span>     }
<span class="line-num">365</span>   ).<span class="ruby-identifier">run_revisit_curator_identification</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation_id</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user_id</span> )
<span class="line-num">366</span>   <span class="ruby-keyword">true</span>
<span class="line-num">367</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_disagreement">
            
              <b>set_disagreement</b>( options = {} )
            
            <a href="../classes/Identification.html#method-i-set_disagreement" name="method-i-set_disagreement" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_disagreement_source')" id="l_method-i-set_disagreement_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_disagreement_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">193</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_disagreement</span>( <span class="ruby-identifier">options</span> = {} )
<span class="line-num">194</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_set_disagreement</span>
<span class="line-num">195</span> 
<span class="line-num">196</span>   <span class="ruby-comment"># Can&#39;t disagree with nothing or roots</span>
<span class="line-num">197</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">previous_observation_taxon</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">grafted?</span>
<span class="line-num">198</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">disagreement</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">199</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">200</span>   <span class="ruby-keyword">end</span>
<span class="line-num">201</span> 
<span class="line-num">202</span>   <span class="ruby-comment"># Can&#39;t disagree if no current identifications</span>
<span class="line-num">203</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">204</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">disagreement</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">205</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">206</span>   <span class="ruby-keyword">end</span>
<span class="line-num">207</span> 
<span class="line-num">208</span>   <span class="ruby-comment"># Can&#39;t disagree when suggesting an ungrafted taxon</span>
<span class="line-num">209</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">grafted?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">210</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">disagreement</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">211</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">212</span>   <span class="ruby-keyword">end</span>
<span class="line-num">213</span> 
<span class="line-num">214</span>   <span class="ruby-comment"># Explicit disagreement can only happen when suggesting a taxon that is an</span>
<span class="line-num">215</span>   <span class="ruby-comment"># ancestor of the previous taxon</span>
<span class="line-num">216</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">disagreement?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">217</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">218</span>   <span class="ruby-keyword">end</span>
<span class="line-num">219</span> 
<span class="line-num">220</span>   <span class="ruby-comment"># Implicit disagreement</span>
<span class="line-num">221</span>   <span class="ruby-identifier">ancestor_of_previous_observation_taxon</span> = <span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">taxon_id</span> )
<span class="line-num">222</span>   <span class="ruby-identifier">descendant_of_previous_observation_taxon</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">self_and_ancestor_ids</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">223</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">disagreement</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">ancestor_of_previous_observation_taxon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">descendant_of_previous_observation_taxon</span>
<span class="line-num">224</span> 
<span class="line-num">225</span>   <span class="ruby-keyword">true</span>
<span class="line-num">226</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_last_identification_as_current">
            
              <b>set_last_identification_as_current</b>()
            
            <a href="../classes/Identification.html#method-i-set_last_identification_as_current" name="method-i-set_last_identification_as_current" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_last_identification_as_current_source')" id="l_method-i-set_last_identification_as_current_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_last_identification_as_current_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">341</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_last_identification_as_current</span>
<span class="line-num">342</span>   <span class="ruby-identifier">last_current</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id ASC&quot;</span> ).<span class="ruby-identifier">last</span>
<span class="line-num">343</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_current</span>
<span class="line-num">344</span>   <span class="ruby-identifier">last_outdated</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">outdated</span>.<span class="ruby-identifier">by</span>( <span class="ruby-identifier">user_id</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id ASC&quot;</span> ).<span class="ruby-identifier">last</span>
<span class="line-num">345</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_outdated</span>
<span class="line-num">346</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">347</span>       <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">last_outdated</span> ).<span class="ruby-identifier">update_all</span>( <span class="ruby-value">current:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">348</span>       <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_index!</span>( <span class="ruby-value">ids:</span> [<span class="ruby-identifier">last_outdated</span>] )
<span class="line-num">349</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotUnique</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">350</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/index_identifications_on_current/</span>
<span class="line-num">351</span>       <span class="ruby-comment"># assume that if the unique key constraint complained, then there&#39;s already a current ident</span>
<span class="line-num">352</span>     <span class="ruby-keyword">end</span>
<span class="line-num">353</span>   <span class="ruby-keyword">end</span>
<span class="line-num">354</span>   <span class="ruby-keyword">true</span>
<span class="line-num">355</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_previous_observation_taxon">
            
              <b>set_previous_observation_taxon</b>()
            
            <a href="../classes/Identification.html#method-i-set_previous_observation_taxon" name="method-i-set_previous_observation_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_previous_observation_taxon_source')" id="l_method-i-set_previous_observation_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_previous_observation_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">168</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_previous_observation_taxon</span>
<span class="line-num">169</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_set_previous_observation_taxon</span>
<span class="line-num">170</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">previous_observation_taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">171</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">previous_observation_taxon_id</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
<span class="line-num">172</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">probable_taxon</span>( <span class="ruby-value">force:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">173</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">previous_probable_taxon</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">probable_taxon</span>( <span class="ruby-value">force:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">before:</span> <span class="ruby-identifier">id</span> )
<span class="line-num">174</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">prefers_community_taxon</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">prefers_community_taxa?</span>
<span class="line-num">175</span>       <span class="ruby-identifier">previous_probable_taxon</span>.<span class="ruby-identifier">id</span>
<span class="line-num">176</span>     <span class="ruby-keyword">else</span>
<span class="line-num">177</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">178</span>     <span class="ruby-keyword">end</span>
<span class="line-num">179</span>   <span class="ruby-keyword">end</span>
<span class="line-num">180</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">previous_observation_taxon_id</span>
<span class="line-num">181</span>     <span class="ruby-identifier">working_created_at</span> = <span class="ruby-identifier">created_at</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">182</span>     <span class="ruby-identifier">previous_ident</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">183</span>       <span class="ruby-identifier">i</span>.<span class="ruby-identifier">persisted?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">working_created_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">184</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">last</span>
<span class="line-num">185</span>     <span class="ruby-identifier">previous_ident</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">186</span>       <span class="ruby-identifier">i</span>.<span class="ruby-identifier">persisted?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">working_created_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">187</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">last</span>
<span class="line-num">188</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">previous_observation_taxon_id</span> = <span class="ruby-identifier">previous_ident</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:taxon_id</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon_id</span>
<span class="line-num">189</span>   <span class="ruby-keyword">end</span>
<span class="line-num">190</span>   <span class="ruby-keyword">true</span>
<span class="line-num">191</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_name">
            
              <b>taxon_name</b>()
            
            <a href="../classes/Identification.html#method-i-taxon_name" name="method-i-taxon_name" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_name_source')" id="l_method-i-taxon_name_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_name_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">518</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_name</span>
<span class="line-num">519</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>)
<span class="line-num">520</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxon_rank">
            
              <b>taxon_rank</b>()
            
            <a href="../classes/Identification.html#method-i-taxon_rank" name="method-i-taxon_rank" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxon_rank_source')" id="l_method-i-taxon_rank_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxon_rank_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">522</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxon_rank</span>
<span class="line-num">523</span>   <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:rank</span>)
<span class="line-num">524</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_plain_s">
            
              <b>to_plain_s</b>(options = {})
            
            <a href="../classes/Identification.html#method-i-to_plain_s" name="method-i-to_plain_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_plain_s_source')" id="l_method-i-to_plain_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_plain_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">132</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_plain_s</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">133</span>   <span class="ruby-node">&quot;Identification #{id} by #{user.login}&quot;</span>
<span class="line-num">134</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../classes/Identification.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">128</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">129</span>   <span class="ruby-node">&quot;&lt;Identification #{id} observation_id: #{observation_id} taxon_id: #{taxon_id} user_id: #{user_id} current: #{current?}&gt;&quot;</span>
<span class="line-num">130</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-uniqueness_of_current">
            
              <b>uniqueness_of_current</b>()
            
            <a href="../classes/Identification.html#method-i-uniqueness_of_current" name="method-i-uniqueness_of_current" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Validations ###############################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-uniqueness_of_current_source')" id="l_method-i-uniqueness_of_current_source">show</a>
                

                

                
              </p>
              <div id="method-i-uniqueness_of_current_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">138</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">uniqueness_of_current</span>
<span class="line-num">139</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">user_id</span>
<span class="line-num">140</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current?</span>
<span class="line-num">141</span>   <span class="ruby-identifier">current_ident</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">current</span>.<span class="ruby-identifier">last</span>
<span class="line-num">142</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_ident</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_ident</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_ident</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">created_at</span>
<span class="line-num">143</span>     <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:current</span>, <span class="ruby-string">&quot;can&#39;t be set when a newer current identification exists for this user&quot;</span>)
<span class="line-num">144</span>   <span class="ruby-keyword">end</span>
<span class="line-num">145</span>   <span class="ruby-keyword">true</span>
<span class="line-num">146</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_categories">
            
              <b>update_categories</b>()
            
            <a href="../classes/Identification.html#method-i-update_categories" name="method-i-update_categories" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_categories_source')" id="l_method-i-update_categories_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_categories_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">487</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_categories</span>
<span class="line-num">488</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">489</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation</span>
<span class="line-num">490</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">run_at:</span> <span class="ruby-value">5</span>.<span class="ruby-identifier">seconds</span>.<span class="ruby-identifier">from_now</span> ).
<span class="line-num">491</span>       <span class="ruby-identifier">update_categories_for_observation</span>( <span class="ruby-identifier">observation_id</span> )
<span class="line-num">492</span>   <span class="ruby-keyword">else</span>
<span class="line-num">493</span>     <span class="ruby-comment"># update_categories_for_observation will reindex all the observation&#39;s</span>
<span class="line-num">494</span>     <span class="ruby-comment"># identifications, so we both do not need to re-index this individual</span>
<span class="line-num">495</span>     <span class="ruby-comment"># identification after that happens, and in fact that may result in</span>
<span class="line-num">496</span>     <span class="ruby-comment"># indexing stale data, e.g. a blank category</span>
<span class="line-num">497</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">498</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">update_categories_for_observation</span>( <span class="ruby-identifier">observation</span>, {
<span class="line-num">499</span>       <span class="ruby-value">wait_for_obs_index_refresh:</span> <span class="ruby-identifier">wait_for_obs_index_refresh</span>
<span class="line-num">500</span>     } )
<span class="line-num">501</span>   <span class="ruby-keyword">end</span>
<span class="line-num">502</span>   <span class="ruby-keyword">true</span>
<span class="line-num">503</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_curator_identification">
            
              <b>update_curator_identification</b>()
            
            <a href="../classes/Identification.html#method-i-update_curator_identification" name="method-i-update_curator_identification" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Set the project_observation curator_identification_id if the identifier is a curator of a project that the observation is submitted to</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_curator_identification_source')" id="l_method-i-update_curator_identification_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_curator_identification_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">314</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_curator_identification</span>
<span class="line-num">315</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">316</span>   <span class="ruby-constant">Identification</span>.
<span class="line-num">317</span>     <span class="ruby-identifier">delay</span>(
<span class="line-num">318</span>       <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">319</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;Identification::run_update_curator_identification&quot;:</span> <span class="ruby-identifier">id</span> },
<span class="line-num">320</span>       <span class="ruby-value">run_at:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>.<span class="ruby-identifier">from_now</span>
<span class="line-num">321</span>     ).
<span class="line-num">322</span>     <span class="ruby-identifier">run_update_curator_identification</span>( <span class="ruby-identifier">id</span> )
<span class="line-num">323</span>   <span class="ruby-keyword">true</span>
<span class="line-num">324</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_obs_stats">
            
              <b>update_obs_stats</b>()
            
            <a href="../classes/Identification.html#method-i-update_obs_stats" name="method-i-update_obs_stats" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Update the identification stats in the observation.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_obs_stats_source')" id="l_method-i-update_obs_stats_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_obs_stats_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">301</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_obs_stats</span>
<span class="line-num">302</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>
<span class="line-num">303</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">304</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">update_stats</span>(<span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">self</span>)
<span class="line-num">305</span>   <span class="ruby-keyword">true</span>
<span class="line-num">306</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_obs_stats_after_destroy">
            
              <b>update_obs_stats_after_destroy</b>()
            
            <a href="../classes/Identification.html#method-i-update_obs_stats_after_destroy" name="method-i-update_obs_stats_after_destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_obs_stats_after_destroy_source')" id="l_method-i-update_obs_stats_after_destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_obs_stats_after_destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">308</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_obs_stats_after_destroy</span>
<span class="line-num">309</span>   <span class="ruby-identifier">update_obs_stats</span>
<span class="line-num">310</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation">
            
              <b>update_observation</b>()
            
            <a href="../classes/Identification.html#method-i-update_observation" name="method-i-update_observation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Update the observation</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_source')" id="l_method-i-update_observation_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">237</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation</span>
<span class="line-num">238</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>
<span class="line-num">239</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation</span>
<span class="line-num">240</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">destroyed?</span>
<span class="line-num">241</span>   <span class="ruby-identifier">attrs</span> = {}
<span class="line-num">242</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation</span>.<span class="ruby-identifier">community_taxon_rejected?</span>
<span class="line-num">243</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_identifications</span> = <span class="ruby-keyword">true</span>
<span class="line-num">244</span>     <span class="ruby-identifier">attrs</span> = {}
<span class="line-num">245</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span>
<span class="line-num">246</span>       <span class="ruby-identifier">species_guess</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">species_guess</span>
<span class="line-num">247</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">species_guess</span>)
<span class="line-num">248</span>         <span class="ruby-identifier">species_guess</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:name</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">249</span>       <span class="ruby-keyword">end</span>
<span class="line-num">250</span>       <span class="ruby-identifier">attrs</span>[<span class="ruby-value">:species_guess</span>] = <span class="ruby-identifier">species_guess</span>
<span class="line-num">251</span>     <span class="ruby-keyword">end</span>
<span class="line-num">252</span>     <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">253</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_taxa_obs_and_observed_taxa_count_after_update_observation&quot;:</span> [
<span class="line-num">254</span>         <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">255</span>     ).<span class="ruby-identifier">update_taxa_obs_and_observed_taxa_count_after_update_observation</span>(<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">256</span>   <span class="ruby-keyword">end</span>
<span class="line-num">257</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">wait_for_index_refresh</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">!</span><span class="ruby-operator">!</span><span class="ruby-identifier">wait_for_obs_index_refresh</span>
<span class="line-num">258</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">259</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_community_taxon</span>(<span class="ruby-value">force:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">260</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_taxon_geoprivacy</span>
<span class="line-num">261</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_identification_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">262</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num">263</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">attrs</span>)
<span class="line-num">264</span>   <span class="ruby-keyword">true</span>
<span class="line-num">265</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation_after_destroy">
            
              <b>update_observation_after_destroy</b>()
            
            <a href="../classes/Identification.html#method-i-update_observation_after_destroy" name="method-i-update_observation_after_destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_after_destroy_source')" id="l_method-i-update_observation_after_destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_after_destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">267</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation_after_destroy</span>
<span class="line-num">268</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation</span>
<span class="line-num">269</span>   <span class="ruby-comment"># return true unless self.observation.user_id == self.user_id</span>
<span class="line-num">270</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_observation</span>
<span class="line-num">271</span> 
<span class="line-num">272</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_current</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">current</span>.<span class="ruby-identifier">by</span>(<span class="ruby-identifier">user_id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id ASC&quot;</span>).<span class="ruby-identifier">last</span>
<span class="line-num">273</span>     <span class="ruby-identifier">last_current</span>.<span class="ruby-identifier">update_observation</span>
<span class="line-num">274</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="line-num">275</span>   <span class="ruby-keyword">end</span>
<span class="line-num">276</span>   
<span class="line-num">277</span>   <span class="ruby-identifier">attrs</span> = {}
<span class="line-num">278</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span>
<span class="line-num">279</span>     <span class="ruby-comment"># update the species_guess</span>
<span class="line-num">280</span>     <span class="ruby-identifier">species_guess</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">species_guess</span>
<span class="line-num">281</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-value">:name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">species_guess</span>)
<span class="line-num">282</span>       <span class="ruby-identifier">species_guess</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">283</span>     <span class="ruby-keyword">end</span>
<span class="line-num">284</span>     <span class="ruby-identifier">attrs</span> = {<span class="ruby-value">:species_guess</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">species_guess</span>, <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">:iconic_taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">nil</span>}
<span class="line-num">285</span>     <span class="ruby-constant">ProjectUser</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span>,
<span class="line-num">286</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;ProjectUser::update_taxa_obs_and_observed_taxa_count_after_update_observation&quot;:</span> [
<span class="line-num">287</span>         <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user_id</span> ] }
<span class="line-num">288</span>     ).<span class="ruby-identifier">update_taxa_obs_and_observed_taxa_count_after_update_observation</span>(<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user_id</span>)
<span class="line-num">289</span>   <span class="ruby-keyword">end</span>
<span class="line-num">290</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">skip_identifications</span> = <span class="ruby-keyword">true</span>
<span class="line-num">291</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">identifications</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">292</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_community_taxon</span>
<span class="line-num">293</span>   <span class="ruby-identifier">attrs</span>[<span class="ruby-value">:community_taxon</span>] = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">community_taxon</span>
<span class="line-num">294</span>   <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">attrs</span>)
<span class="line-num">295</span>   <span class="ruby-keyword">true</span>
<span class="line-num">296</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_observation_if_test_env">
            
              <b>update_observation_if_test_env</b>()
            
            <a href="../classes/Identification.html#method-i-update_observation_if_test_env" name="method-i-update_observation_if_test_env" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_observation_if_test_env_source')" id="l_method-i-update_observation_if_test_env_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_observation_if_test_env_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">228</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_observation_if_test_env</span>
<span class="line-num">229</span>   <span class="ruby-comment"># this model uses an after_commit callback for method update_observation to keep</span>
<span class="line-num">230</span>   <span class="ruby-comment"># the obs ES index in sync. But in the test env when running specs there are no</span>
<span class="line-num">231</span>   <span class="ruby-comment"># commits with the transactional db cleaning strategy. Use this method to run</span>
<span class="line-num">232</span>   <span class="ruby-comment"># update_observation for specs</span>
<span class="line-num">233</span>   <span class="ruby-identifier">update_observation</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span>
<span class="line-num">234</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_other_identifications">
            
              <b>update_other_identifications</b>()
            
            <a href="../classes/Identification.html#method-i-update_other_identifications" name="method-i-update_other_identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_other_identifications_source')" id="l_method-i-update_other_identifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_other_identifications_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">157</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_other_identifications</span>
<span class="line-num">158</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">will_save_change_to_current?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">new_record?</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current?</span>
<span class="line-num">159</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span>
<span class="line-num">160</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observation_id = ? AND user_id = ? AND id != ?&quot;</span>, <span class="ruby-identifier">observation_id</span>, <span class="ruby-identifier">user_id</span>, <span class="ruby-identifier">id</span>)
<span class="line-num">161</span>   <span class="ruby-keyword">else</span>
<span class="line-num">162</span>     <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observation_id = ? AND user_id = ?&quot;</span>, <span class="ruby-identifier">observation_id</span>, <span class="ruby-identifier">user_id</span>)
<span class="line-num">163</span>   <span class="ruby-keyword">end</span>
<span class="line-num">164</span>   <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">update_all</span>( <span class="ruby-value">current:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">165</span>   <span class="ruby-keyword">true</span>
<span class="line-num">166</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_quality_metrics">
            
              <b>update_quality_metrics</b>()
            
            <a href="../classes/Identification.html#method-i-update_quality_metrics" name="method-i-update_quality_metrics" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_quality_metrics_source')" id="l_method-i-update_quality_metrics_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_quality_metrics_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">432</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_quality_metrics</span>
<span class="line-num">433</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">captive_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;1&quot;</span>
<span class="line-num">434</span>     <span class="ruby-constant">QualityMetric</span>.<span class="ruby-identifier">vote</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">observation</span>, <span class="ruby-constant">QualityMetric</span><span class="ruby-operator">::</span><span class="ruby-constant">WILD</span>, <span class="ruby-keyword">false</span>)
<span class="line-num">435</span>   <span class="ruby-keyword">end</span>
<span class="line-num">436</span>   <span class="ruby-keyword">true</span>
<span class="line-num">437</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_user_counter_cache">
            
              <b>update_user_counter_cache</b>()
            
            <a href="../classes/Identification.html#method-i-update_user_counter_cache" name="method-i-update_user_counter_cache" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Update the counter cache in users.  That cache ONLY tracks observations  made for others.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_user_counter_cache_source')" id="l_method-i-update_user_counter_cache_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_user_counter_cache_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">328</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_user_counter_cache</span>
<span class="line-num">329</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation</span>
<span class="line-num">330</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">destroyed?</span>
<span class="line-num">331</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bulk_delete</span>
<span class="line-num">332</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span>
<span class="line-num">333</span>     <span class="ruby-constant">User</span>.<span class="ruby-identifier">delay</span>(
<span class="line-num">334</span>       <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::update_identifications_counter_cache&quot;:</span> <span class="ruby-identifier">user_id</span> },
<span class="line-num">335</span>       <span class="ruby-value">run_at:</span> <span class="ruby-value">5</span>.<span class="ruby-identifier">minutes</span>.<span class="ruby-identifier">from_now</span>
<span class="line-num">336</span>     ).<span class="ruby-identifier">update_identifications_counter_cache</span>(<span class="ruby-identifier">user_id</span>)
<span class="line-num">337</span>   <span class="ruby-keyword">end</span>
<span class="line-num">338</span>   <span class="ruby-keyword">true</span>
<span class="line-num">339</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-vision">
            
              <b>vision</b>()
            
            <a href="../classes/Identification.html#method-i-vision" name="method-i-vision" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-vision_source')" id="l_method-i-vision_source">show</a>
                

                

                
              </p>
              <div id="method-i-vision_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">510</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">vision</span>
<span class="line-num">511</span>   <span class="ruby-identifier">prefers_vision?</span>
<span class="line-num">512</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-vision-3D">
            
              <b>vision=</b>( val )
            
            <a href="../classes/Identification.html#method-i-vision-3D" name="method-i-vision-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-vision-3D_source')" id="l_method-i-vision-3D_source">show</a>
                

                

                
              </p>
              <div id="method-i-vision-3D_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/models/identification.rb</span>
<span class="line-num">514</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">vision=</span>( <span class="ruby-identifier">val</span> )
<span class="line-num">515</span>   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preferred_vision</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">yesish?</span>
<span class="line-num">516</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
