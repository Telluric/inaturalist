<!DOCTYPE html>
<html lang="en">
<head>
    <title>DarwinCore::Archive</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../../">
<meta name="data-tree-keys" content='["DarwinCore", "Archive"]'>


    <meta property="og:title" value="DarwinCore::Archive">

  

    <meta name="keywords" content="DarwinCore::Archive class, generate, new, logger, extension_paths, generate, make_metadata, make_descriptor, make_data, observations_params, benchmark, make_occurrence_file, write_occurrence_data, make_taxon_data, make_eol_media_data, make_simple_multimedia_file, write_simple_multimedia_data, make_observation_fields_file, write_observation_fields_data, make_project_observations_file, write_project_observations_data, make_user_file, write_user_data, make_vernacular_names_data, make_api_all_taxon_data, partition_range, process_observations, observations_in_batches, make_archive, lookup_taxa_for_obs_batch, generate_ranked_ancestors, upload_to_aws_s3">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            DarwinCore::Archive
            
                <span class="parent">&lt;
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../files/lib/darwin_core/archive_rb.html">lib/darwin_core/archive.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-benchmark">benchmark</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-extension_paths">extension_paths</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-generate">generate</a>,
              </li>
            
              
              <li>
                <a href="#method-i-generate">generate</a>,
              </li>
            
              
              <li>
                <a href="#method-c-generate_ranked_ancestors">generate_ranked_ancestors</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-logger">logger</a>,
              </li>
            
              
              <li>
                <a href="#method-c-lookup_taxa_for_obs_batch">lookup_taxa_for_obs_batch</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-make_api_all_taxon_data">make_api_all_taxon_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_archive">make_archive</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_data">make_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_descriptor">make_descriptor</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_eol_media_data">make_eol_media_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_metadata">make_metadata</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_observation_fields_file">make_observation_fields_file</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_occurrence_file">make_occurrence_file</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_project_observations_file">make_project_observations_file</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_simple_multimedia_file">make_simple_multimedia_file</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_taxon_data">make_taxon_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_user_file">make_user_file</a>,
              </li>
            
              
              <li>
                <a href="#method-i-make_vernacular_names_data">make_vernacular_names_data</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-observations_in_batches">observations_in_batches</a>,
              </li>
            
              
              <li>
                <a href="#method-i-observations_params">observations_params</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-partition_range">partition_range</a>,
              </li>
            
              
              <li>
                <a href="#method-i-process_observations">process_observations</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-upload_to_aws_s3">upload_to_aws_s3</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-write_observation_fields_data">write_observation_fields_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-write_occurrence_data">write_occurrence_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-write_project_observations_data">write_project_observations_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-write_simple_multimedia_data">write_simple_multimedia_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-write_user_data">write_user_data</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">OBS_BASED_EXTENSIONS</td>
            <td>=</td>
            <td class="attr-value">[
:occurrence,
:simple_multimedia,
:observation_fields,
:project_observations,
:user
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-generate">
            
              <b>generate</b>(opts = {})
            
            <a href="../../classes/DarwinCore/Archive.html#method-c-generate" name="method-c-generate" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_source')" id="l_method-c-generate_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">12</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate</span>(<span class="ruby-identifier">opts</span> = {})
<span class="line-num">13</span>   <span class="ruby-identifier">new</span>(<span class="ruby-identifier">opts</span>).<span class="ruby-identifier">generate</span>
<span class="line-num">14</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-generate_ranked_ancestors">
            
              <b>generate_ranked_ancestors</b>( taxon_id, cached_taxa = { } )
            
            <a href="../../classes/DarwinCore/Archive.html#method-c-generate_ranked_ancestors" name="method-c-generate_ranked_ancestors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>given a taxon_id and cached taxon information from lookup_taxa_for_obs_batch, return a hash of each rank and taxon name in the taxon&#39;s ancestry</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-generate_ranked_ancestors_source')" id="l_method-c-generate_ranked_ancestors_source">show</a>
                

                

                
              </p>
              <div id="method-c-generate_ranked_ancestors_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">729</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">generate_ranked_ancestors</span>( <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">cached_taxa</span> = { } )
<span class="line-num">730</span>   <span class="ruby-identifier">ranked_ancestors</span> = { }
<span class="line-num">731</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">cached_taxa</span>[<span class="ruby-identifier">taxon_id</span>]
<span class="line-num">732</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">ranked_ancestors</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>
<span class="line-num">733</span>   <span class="ruby-identifier">taxon</span>[<span class="ruby-value">:ancestor_ids</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ancestor_id</span><span class="ruby-operator">|</span>
<span class="line-num">734</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestor</span> = <span class="ruby-identifier">cached_taxa</span>[<span class="ruby-identifier">ancestor_id</span>]
<span class="line-num">735</span>       <span class="ruby-comment"># first instance of rank takes priority</span>
<span class="line-num">736</span>       <span class="ruby-identifier">ranked_ancestors</span>[( <span class="ruby-identifier">ancestor</span>[<span class="ruby-value">:rank</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;_name&quot;</span> ).<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">ancestor</span>[<span class="ruby-value">:name</span>]
<span class="line-num">737</span>     <span class="ruby-keyword">end</span>
<span class="line-num">738</span>   <span class="ruby-keyword">end</span>
<span class="line-num">739</span>   <span class="ruby-comment"># include itself</span>
<span class="line-num">740</span>   <span class="ruby-identifier">ranked_ancestors</span>[( <span class="ruby-identifier">taxon</span>[<span class="ruby-value">:rank</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;_name&quot;</span> ).<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon</span>[<span class="ruby-value">:name</span>]
<span class="line-num">741</span>   <span class="ruby-identifier">ranked_ancestors</span>
<span class="line-num">742</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-lookup_taxa_for_obs_batch">
            
              <b>lookup_taxa_for_obs_batch</b>( observations )
            
            <a href="../../classes/DarwinCore/Archive.html#method-c-lookup_taxa_for_obs_batch" name="method-c-lookup_taxa_for_obs_batch" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>given an array of observations, return a hash containing name and ancestry information about the observations&#39; taxa</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-lookup_taxa_for_obs_batch_source')" id="l_method-c-lookup_taxa_for_obs_batch_source">show</a>
                

                

                
              </p>
              <div id="method-c-lookup_taxa_for_obs_batch_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">705</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">lookup_taxa_for_obs_batch</span>( <span class="ruby-identifier">observations</span> )
<span class="line-num">706</span>   <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">o</span>.<span class="ruby-identifier">community_taxon_id</span>] }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">707</span>   <span class="ruby-identifier">ancestor_taxon_ids</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">taxon_ids</span> ).<span class="ruby-identifier">pluck</span>( <span class="ruby-value">:ancestry</span> ).
<span class="line-num">708</span>     <span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:split</span>, <span class="ruby-string">&quot;/&quot;</span> ) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">709</span>   <span class="ruby-identifier">cached_taxa</span> = { }
<span class="line-num">710</span>   <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> ( <span class="ruby-identifier">taxon_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ancestor_taxon_ids</span> ).<span class="ruby-identifier">uniq</span> ).
<span class="line-num">711</span>     <span class="ruby-identifier">pluck</span>( <span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:rank</span>, <span class="ruby-value">:ancestry</span> ).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
<span class="line-num">712</span>     ( <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">rank</span>, <span class="ruby-identifier">ancestry</span> ) = <span class="ruby-identifier">row</span>
<span class="line-num">713</span>     <span class="ruby-identifier">ancestor_ids</span> = <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> [] <span class="ruby-operator">:</span> <span class="ruby-identifier">ancestry</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;/&quot;</span> ).<span class="ruby-identifier">map</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span> )
<span class="line-num">714</span>     <span class="ruby-identifier">cached_taxa</span>[<span class="ruby-identifier">taxon_id</span>] = {
<span class="line-num">715</span>       <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>,
<span class="line-num">716</span>       <span class="ruby-value">rank:</span> <span class="ruby-identifier">rank</span>,
<span class="line-num">717</span>       <span class="ruby-value">parent_id:</span> <span class="ruby-identifier">ancestor_ids</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>,
<span class="line-num">718</span>       <span class="ruby-value">ancestor_ids:</span> <span class="ruby-identifier">ancestor_ids</span>
<span class="line-num">719</span>      }
<span class="line-num">720</span>   <span class="ruby-keyword">end</span>
<span class="line-num">721</span>   <span class="ruby-identifier">taxa_ranked_ancestors</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon_id</span><span class="ruby-operator">|</span>
<span class="line-num">722</span>     [<span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">generate_ranked_ancestors</span>( <span class="ruby-identifier">taxon_id</span>, <span class="ruby-identifier">cached_taxa</span> )]
<span class="line-num">723</span>   <span class="ruby-keyword">end</span>]
<span class="line-num">724</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">taxa_ranked_ancestors</span>
<span class="line-num">725</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-new">
            
              <b>new</b>(opts = {})
            
            <a href="../../classes/DarwinCore/Archive.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                

                

                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">16</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">opts</span> = {})
<span class="line-num">17</span>   <span class="ruby-ivar">@opts</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">symbolize_keys</span>
<span class="line-num">18</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:path</span>] <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;dwca.zip&quot;</span>
<span class="line-num">19</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Cores</span><span class="ruby-operator">::</span><span class="ruby-constant">OCCURRENCE</span>
<span class="line-num">20</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:extensions</span>] = [<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:extensions</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">21</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:metadata</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Cores</span><span class="ruby-operator">::</span><span class="ruby-constant">OCCURRENCE</span>
<span class="line-num">22</span>     <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;observations&quot;</span>, <span class="ruby-string">&quot;dwc.eml.erb&quot;</span> )
<span class="line-num">23</span>   <span class="ruby-keyword">else</span>
<span class="line-num">24</span>     <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;taxa&quot;</span>, <span class="ruby-string">&quot;dwc.eml.erb&quot;</span> )
<span class="line-num">25</span>   <span class="ruby-keyword">end</span>
<span class="line-num">26</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:descriptor</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;observations&quot;</span>, <span class="ruby-string">&quot;dwc.descriptor.builder&quot;</span>)
<span class="line-num">27</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">||=</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality_grade</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;research&quot;</span>
<span class="line-num">28</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photo_licenses</span>] <span class="ruby-operator">||=</span> [<span class="ruby-string">&quot;CC0&quot;</span>, <span class="ruby-string">&quot;CC-BY&quot;</span>, <span class="ruby-string">&quot;CC-BY-NC&quot;</span>, <span class="ruby-string">&quot;CC-BY-SA&quot;</span>, <span class="ruby-string">&quot;CC-BY-ND&quot;</span>, <span class="ruby-string">&quot;CC-BY-NC-SA&quot;</span>, <span class="ruby-string">&quot;CC-BY-NC-ND&quot;</span>]
<span class="line-num">29</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:media_licenses</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photo_licenses</span>].<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span>)
<span class="line-num">30</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>] <span class="ruby-operator">||=</span> [<span class="ruby-string">&quot;any&quot;</span>]
<span class="line-num">31</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>].<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">32</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:private_coordinates</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">33</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:taxon_private_coordinates</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">34</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photographed_taxa</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="line-num">35</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:processes</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">1</span>
<span class="line-num">36</span>   <span class="ruby-ivar">@logger</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:logger</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>
<span class="line-num">37</span>   <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">level</span> = <span class="ruby-constant">Logger</span><span class="ruby-operator">::</span><span class="ruby-constant">DEBUG</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:debug</span>]
<span class="line-num">38</span> 
<span class="line-num">39</span>   <span class="ruby-comment"># Make a unique dir to put our files</span>
<span class="line-num">40</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>] = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mktmpdir</span>
<span class="line-num">41</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-value">:mode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">0755</span>
<span class="line-num">42</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Using working directory: #{@opts[:work_path]}&quot;</span>
<span class="line-num">43</span> 
<span class="line-num">44</span>   <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:place</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:place</span>])
<span class="line-num">45</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Found place: #{@place}&quot;</span>
<span class="line-num">46</span>   <span class="ruby-ivar">@taxa</span> = [<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:taxon</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">47</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span> )
<span class="line-num">48</span>       <span class="ruby-identifier">taxon</span>
<span class="line-num">49</span>     <span class="ruby-keyword">else</span>
<span class="line-num">50</span>       <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> ).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">51</span>         <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span> ) <span class="ruby-operator">||</span> <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">find_by_name</span>( <span class="ruby-identifier">t</span> )
<span class="line-num">52</span>       <span class="ruby-keyword">end</span>
<span class="line-num">53</span>     <span class="ruby-keyword">end</span>
<span class="line-num">54</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">55</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;Found taxa: &quot;</span>
<span class="line-num">56</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">57</span>     <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">58</span>       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;\t#{t}&quot;</span>
<span class="line-num">59</span>     <span class="ruby-keyword">end</span>
<span class="line-num">60</span>   <span class="ruby-keyword">end</span>
<span class="line-num">61</span>   <span class="ruby-ivar">@project</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:project</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Project</span>)
<span class="line-num">62</span>     <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:project</span>]
<span class="line-num">63</span>   <span class="ruby-keyword">else</span>
<span class="line-num">64</span>     <span class="ruby-operator">::</span><span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:project</span>] ) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">65</span>   <span class="ruby-keyword">end</span>
<span class="line-num">66</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Found project: #{@project}&quot;</span>
<span class="line-num">67</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Photo licenses: #{@opts[:photo_licenses].inspect}&quot;</span>
<span class="line-num">68</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-partition_range">
            
              <b>partition_range</b>( start_id, max_id, partitions = 1 )
            
            <a href="../../classes/DarwinCore/Archive.html#method-c-partition_range" name="method-c-partition_range" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-partition_range_source')" id="l_method-c-partition_range_source">show</a>
                

                

                
              </p>
              <div id="method-c-partition_range_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">592</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">partition_range</span>( <span class="ruby-identifier">start_id</span>, <span class="ruby-identifier">max_id</span>, <span class="ruby-identifier">partitions</span> = <span class="ruby-value">1</span> )
<span class="line-num">593</span>   <span class="ruby-identifier">partition_start_id</span> = <span class="ruby-identifier">start_id</span>
<span class="line-num">594</span>   <span class="ruby-identifier">partition_ranges</span> = []
<span class="line-num">595</span>   (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">partitions</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">596</span>     <span class="ruby-identifier">partition_end_id</span> = ( <span class="ruby-identifier">max_id</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">i</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">partitions</span>
<span class="line-num">597</span>     <span class="ruby-identifier">partition_ranges</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">start_id:</span> <span class="ruby-identifier">partition_start_id</span>, <span class="ruby-value">end_id:</span> <span class="ruby-identifier">partition_end_id</span> }
<span class="line-num">598</span>     <span class="ruby-identifier">partition_start_id</span> = <span class="ruby-identifier">partition_end_id</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
<span class="line-num">599</span>   <span class="ruby-keyword">end</span>
<span class="line-num">600</span>   <span class="ruby-identifier">partition_ranges</span>
<span class="line-num">601</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-benchmark">
            
              <b>benchmark</b>( key )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-benchmark" name="method-i-benchmark" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-benchmark_source')" id="l_method-i-benchmark_source">show</a>
                

                

                
              </p>
              <div id="method-i-benchmark_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">249</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">benchmark</span>( <span class="ruby-identifier">key</span> )
<span class="line-num">250</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:benchmark</span>]
<span class="line-num">251</span>     <span class="ruby-ivar">@benchmarks</span> <span class="ruby-operator">||=</span> {}
<span class="line-num">252</span>     <span class="ruby-ivar">@benchmarks</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">253</span>     <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">254</span>     <span class="ruby-keyword">yield</span>
<span class="line-num">255</span>     <span class="ruby-ivar">@benchmarks</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start</span>
<span class="line-num">256</span>   <span class="ruby-keyword">else</span>
<span class="line-num">257</span>     <span class="ruby-keyword">yield</span>
<span class="line-num">258</span>   <span class="ruby-keyword">end</span>
<span class="line-num">259</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-extension_paths">
            
              <b>extension_paths</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-extension_paths" name="method-i-extension_paths" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-extension_paths_source')" id="l_method-i-extension_paths_source">show</a>
                

                

                
              </p>
              <div id="method-i-extension_paths_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">74</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">extension_paths</span>
<span class="line-num">75</span>   <span class="ruby-ivar">@extension_paths</span> <span class="ruby-operator">||</span> { }
<span class="line-num">76</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-generate">
            
              <b>generate</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-generate" name="method-i-generate" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-generate_source')" id="l_method-i-generate_source">show</a>
                

                

                
              </p>
              <div id="method-i-generate_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num"> 78</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate</span>
<span class="line-num"> 79</span>   <span class="ruby-ivar">@generate_started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num"> 80</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] Generating archive, options: #{@opts}&quot;</span>
<span class="line-num"> 81</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:metadata</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;skip&quot;</span>
<span class="line-num"> 82</span>     <span class="ruby-identifier">metadata_path</span> = <span class="ruby-identifier">make_metadata</span>
<span class="line-num"> 83</span>     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Metadata: #{metadata_path}&quot;</span>
<span class="line-num"> 84</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 85</span>   <span class="ruby-identifier">descriptor_path</span> = <span class="ruby-identifier">make_descriptor</span>
<span class="line-num"> 86</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Descriptor: #{descriptor_path}&quot;</span>
<span class="line-num"> 87</span>   <span class="ruby-identifier">data_paths</span> = <span class="ruby-identifier">make_data</span>
<span class="line-num"> 88</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Data: #{data_paths.inspect}&quot;</span>
<span class="line-num"> 89</span>   <span class="ruby-identifier">paths</span> = [<span class="ruby-identifier">metadata_path</span>, <span class="ruby-identifier">descriptor_path</span>, <span class="ruby-identifier">data_paths</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num"> 90</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:with_taxa</span>]
<span class="line-num"> 91</span>     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;Making taxa extension...&quot;</span>
<span class="line-num"> 92</span>     <span class="ruby-identifier">paths</span> <span class="ruby-operator">+=</span> [<span class="ruby-identifier">make_api_all_taxon_data</span>]
<span class="line-num"> 93</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 94</span>   <span class="ruby-identifier">archive_path</span> = <span class="ruby-identifier">make_archive</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">paths</span> )
<span class="line-num"> 95</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Archive: #{archive_path}&quot;</span>
<span class="line-num"> 96</span>   <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>( <span class="ruby-identifier">archive_path</span>, <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:path</span>] )
<span class="line-num"> 97</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Archive generated: #{@opts[:path]}&quot;</span>
<span class="line-num"> 98</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@benchmarks</span>
<span class="line-num"> 99</span>     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">%w(BENCHMARK TOTAL AVG)</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">ljust</span>( <span class="ruby-value">30</span> )}.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot; &quot;</span> )
<span class="line-num">100</span>     <span class="ruby-ivar">@benchmarks</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">times</span><span class="ruby-operator">|</span>
<span class="line-num">101</span>       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> [<span class="ruby-identifier">key</span>, <span class="ruby-identifier">times</span>.<span class="ruby-identifier">sum</span>.<span class="ruby-identifier">round</span>(<span class="ruby-value">5</span>), (<span class="ruby-identifier">times</span>.<span class="ruby-identifier">sum</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">times</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">5</span>)].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">ljust</span>( <span class="ruby-value">30</span> )}.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot; &quot;</span> )
<span class="line-num">102</span>     <span class="ruby-keyword">end</span>
<span class="line-num">103</span>   <span class="ruby-keyword">end</span>
<span class="line-num">104</span>   <span class="ruby-identifier">upload_to_aws_s3</span>
<span class="line-num">105</span>   <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:path</span>]
<span class="line-num">106</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-logger">
            
              <b>logger</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-logger" name="method-i-logger" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-logger_source')" id="l_method-i-logger_source">show</a>
                

                

                
              </p>
              <div id="method-i-logger_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">70</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">logger</span>
<span class="line-num">71</span>   <span class="ruby-ivar">@logger</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>
<span class="line-num">72</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_api_all_taxon_data">
            
              <b>make_api_all_taxon_data</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_api_all_taxon_data" name="method-i-make_api_all_taxon_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_api_all_taxon_data_source')" id="l_method-i-make_api_all_taxon_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_api_all_taxon_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">537</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_api_all_taxon_data</span>
<span class="line-num">538</span>   <span class="ruby-identifier">headers</span> = [ <span class="ruby-string">&quot;taxonID&quot;</span>, <span class="ruby-string">&quot;scientificName&quot;</span>, <span class="ruby-string">&quot;parentNameUsageID&quot;</span>, <span class="ruby-string">&quot;taxonRank&quot;</span> , <span class="ruby-string">&quot;vernacularName&quot;</span>, <span class="ruby-string">&quot;wikipedia_url&quot;</span> ]
<span class="line-num">539</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;taxa.csv&quot;</span>
<span class="line-num">540</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">541</span> 
<span class="line-num">542</span>   <span class="ruby-identifier">params</span> = { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> }
<span class="line-num">543</span>   <span class="ruby-identifier">last_id</span> = <span class="ruby-value">0</span>
<span class="line-num">544</span>   <span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">545</span>   <span class="ruby-identifier">rows_written</span> = <span class="ruby-value">0</span>
<span class="line-num">546</span>   <span class="ruby-identifier">total_results</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">547</span>   <span class="ruby-identifier">localization_place_id</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-string">&quot;United States&quot;</span>).<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>)
<span class="line-num">548</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">549</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">550</span>     <span class="ruby-identifier">beginning_or_more_results</span> = <span class="ruby-keyword">true</span>
<span class="line-num">551</span>     <span class="ruby-keyword">while</span> <span class="ruby-identifier">beginning_or_more_results</span>
<span class="line-num">552</span>       <span class="ruby-keyword">begin</span>
<span class="line-num">553</span>         <span class="ruby-identifier">response</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">taxa</span>( <span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge</span>({
<span class="line-num">554</span>           <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>,
<span class="line-num">555</span>           <span class="ruby-value">order:</span> <span class="ruby-string">&quot;asc&quot;</span>,
<span class="line-num">556</span>           <span class="ruby-value">per_page:</span> <span class="ruby-value">500</span>,
<span class="line-num">557</span>           <span class="ruby-value">id_above:</span> <span class="ruby-identifier">last_id</span>,
<span class="line-num">558</span>           <span class="ruby-value">preferred_place_id:</span> <span class="ruby-identifier">localization_place_id</span>,
<span class="line-num">559</span>           <span class="ruby-value">locale:</span> <span class="ruby-string">&quot;en&quot;</span>
<span class="line-num">560</span>         }), { <span class="ruby-value">retry_delay:</span> <span class="ruby-value">2.0</span>, <span class="ruby-value">retries:</span> <span class="ruby-value">30</span> })
<span class="line-num">561</span>         <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">response</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">562</span>           <span class="ruby-identifier">beginning_or_more_results</span> = <span class="ruby-keyword">false</span>
<span class="line-num">563</span>           <span class="ruby-keyword">break</span>
<span class="line-num">564</span>         <span class="ruby-keyword">end</span>
<span class="line-num">565</span>         <span class="ruby-identifier">total_results</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">total_results</span>
<span class="line-num">566</span>         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">567</span>           <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [
<span class="line-num">568</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;id&quot;</span>],
<span class="line-num">569</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;name&quot;</span>],
<span class="line-num">570</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;parent_id&quot;</span>],
<span class="line-num">571</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;rank&quot;</span>],
<span class="line-num">572</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;preferred_common_name&quot;</span>],
<span class="line-num">573</span>             <span class="ruby-identifier">taxon</span>[<span class="ruby-string">&quot;wikipedia_url&quot;</span>]
<span class="line-num">574</span>           ]
<span class="line-num">575</span>         <span class="ruby-keyword">end</span>
<span class="line-num">576</span>         <span class="ruby-identifier">last_id</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">last</span>[<span class="ruby-string">&quot;id&quot;</span>]
<span class="line-num">577</span>         <span class="ruby-identifier">rows_written</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">length</span>
<span class="line-num">578</span>         <span class="ruby-identifier">running_seconds</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start_time</span>
<span class="line-num">579</span>         <span class="ruby-identifier">rows_per_second</span> = ( <span class="ruby-identifier">rows_written</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">running_seconds</span> ).<span class="ruby-identifier">round</span>( <span class="ruby-value">2</span> )
<span class="line-num">580</span>         <span class="ruby-identifier">estimated_remaining_time</span> = ( ( <span class="ruby-identifier">total_results</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">rows_written</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">rows_per_second</span> ).<span class="ruby-identifier">round</span>( <span class="ruby-value">2</span> )
<span class="line-num">581</span>         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Taxa: #{rows_written} rows, #{rows_per_second}r/s, estimated #{estimated_remaining_time}s left&quot;</span>
<span class="line-num">582</span>       <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">583</span>         <span class="ruby-identifier">pp</span> <span class="ruby-identifier">e</span>
<span class="line-num">584</span>         <span class="ruby-identifier">beginning_or_more_results</span> = <span class="ruby-keyword">false</span>
<span class="line-num">585</span>         <span class="ruby-keyword">break</span>
<span class="line-num">586</span>       <span class="ruby-keyword">end</span>
<span class="line-num">587</span>     <span class="ruby-keyword">end</span>
<span class="line-num">588</span>   <span class="ruby-keyword">end</span>
<span class="line-num">589</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">590</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_archive">
            
              <b>make_archive</b>( *args )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_archive" name="method-i-make_archive" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_archive_source')" id="l_method-i-make_archive_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_archive_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">693</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_archive</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">args</span> )
<span class="line-num">694</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;dwca.zip&quot;</span>
<span class="line-num">695</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span> )
<span class="line-num">696</span>   <span class="ruby-identifier">fnames</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>( <span class="ruby-identifier">f</span> ) }
<span class="line-num">697</span>   <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;cd #{@opts[:work_path]} &amp;&amp; zip -D #{tmp_path} #{fnames.join( &#39; &#39; )}&quot;</span>
<span class="line-num">698</span>   <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>( <span class="ruby-node">&quot;Running #{cmd}&quot;</span>)
<span class="line-num">699</span>   <span class="ruby-identifier">system</span> <span class="ruby-identifier">cmd</span>
<span class="line-num">700</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">701</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_data">
            
              <b>make_data</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_data" name="method-i-make_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_data_source')" id="l_method-i-make_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">177</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_data</span>
<span class="line-num">178</span>   <span class="ruby-ivar">@generate_started_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">179</span>   <span class="ruby-ivar">@extension_paths</span> = { }
<span class="line-num">180</span>   <span class="ruby-identifier">core_and_extensions</span> = [<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>]] <span class="ruby-operator">+</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:extensions</span>]
<span class="line-num">181</span>   <span class="ruby-identifier">core_and_extensions</span>.<span class="ruby-identifier">map!</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ext</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">to_sym</span> }
<span class="line-num">182</span>   ( <span class="ruby-identifier">obs_based_extensions</span>, <span class="ruby-identifier">custom_extensions</span> ) = <span class="ruby-identifier">core_and_extensions</span>.<span class="ruby-identifier">partition</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
<span class="line-num">183</span>     <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Archive</span><span class="ruby-operator">::</span><span class="ruby-constant">OBS_BASED_EXTENSIONS</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">ext</span> )
<span class="line-num">184</span>   <span class="ruby-keyword">end</span>
<span class="line-num">185</span> 
<span class="line-num">186</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">obs_based_extensions</span>.<span class="ruby-identifier">any?</span>
<span class="line-num">187</span>     <span class="ruby-identifier">obs_based_extension_info</span> = { }
<span class="line-num">188</span>     <span class="ruby-identifier">preloads</span> = []
<span class="line-num">189</span>     <span class="ruby-identifier">obs_based_extensions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
<span class="line-num">190</span>       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Preparing #{ext} extension...&quot;</span>
<span class="line-num">191</span>       <span class="ruby-identifier">obs_based_extension_info</span>[<span class="ruby-identifier">ext</span>] = <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;make_#{ext}_file&quot;</span>)
<span class="line-num">192</span>       <span class="ruby-identifier">preloads</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">obs_based_extension_info</span>[<span class="ruby-identifier">ext</span>][<span class="ruby-value">:preloads</span>]
<span class="line-num">193</span>       <span class="ruby-ivar">@extension_paths</span>[<span class="ruby-identifier">ext</span>] = <span class="ruby-identifier">obs_based_extension_info</span>[<span class="ruby-identifier">ext</span>][<span class="ruby-value">:path</span>]
<span class="line-num">194</span>     <span class="ruby-keyword">end</span>
<span class="line-num">195</span>     <span class="ruby-identifier">observation_ids_written</span> = { }
<span class="line-num">196</span>     <span class="ruby-identifier">process_observations</span>(
<span class="line-num">197</span>       <span class="ruby-identifier">observations_params</span>,
<span class="line-num">198</span>       <span class="ruby-identifier">preloads</span>,
<span class="line-num">199</span>       <span class="ruby-ivar">@opts</span>.<span class="ruby-identifier">merge</span>( {
<span class="line-num">200</span>         <span class="ruby-value">label:</span> <span class="ruby-string">&quot;obs_based_extensions&quot;</span>
<span class="line-num">201</span>       } )
<span class="line-num">202</span>     ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">203</span>       <span class="ruby-identifier">batch</span> = <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">filter</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">observation_ids_written</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>] }
<span class="line-num">204</span>       <span class="ruby-identifier">obs_based_extensions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
<span class="line-num">205</span>         <span class="ruby-identifier">extension_file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-ivar">@extension_paths</span>[<span class="ruby-identifier">ext</span>], <span class="ruby-string">&quot;a&quot;</span> )
<span class="line-num">206</span>         <span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;write_#{ext}_data&quot;</span>, <span class="ruby-identifier">batch</span>, <span class="ruby-identifier">extension_file</span> )
<span class="line-num">207</span>         <span class="ruby-identifier">extension_file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">208</span>       <span class="ruby-keyword">end</span>
<span class="line-num">209</span>       <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
<span class="line-num">210</span>         <span class="ruby-identifier">observation_ids_written</span>[<span class="ruby-identifier">o</span>.<span class="ruby-identifier">id</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">211</span>       <span class="ruby-keyword">end</span>
<span class="line-num">212</span>     <span class="ruby-keyword">end</span>
<span class="line-num">213</span>   <span class="ruby-keyword">end</span>
<span class="line-num">214</span> 
<span class="line-num">215</span>   <span class="ruby-identifier">custom_extensions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
<span class="line-num">216</span>     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Making #{ext} extension...&quot;</span>
<span class="line-num">217</span>     <span class="ruby-ivar">@extension_paths</span>[<span class="ruby-identifier">ext</span>] = <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;make_#{ext}_data&quot;</span>)
<span class="line-num">218</span>   <span class="ruby-keyword">end</span>
<span class="line-num">219</span>   <span class="ruby-ivar">@extension_paths</span>.<span class="ruby-identifier">values</span>
<span class="line-num">220</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_descriptor">
            
              <b>make_descriptor</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_descriptor" name="method-i-make_descriptor" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_descriptor_source')" id="l_method-i-make_descriptor_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_descriptor_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">124</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_descriptor</span>
<span class="line-num">125</span>   <span class="ruby-identifier">extensions</span> = []
<span class="line-num">126</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:extensions</span>]
<span class="line-num">127</span>     <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:extensions</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span>
<span class="line-num">128</span>       <span class="ruby-keyword">case</span> <span class="ruby-identifier">e</span>
<span class="line-num">129</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;EolMedia&quot;</span>
<span class="line-num">130</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">131</span>           <span class="ruby-value">:row_type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;http://eol.org/schema/media/Document&quot;</span>,
<span class="line-num">132</span>           <span class="ruby-value">:files</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-string">&quot;media.csv&quot;</span>],
<span class="line-num">133</span>           <span class="ruby-value">:terms</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">134</span>         }
<span class="line-num">135</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;SimpleMultimedia&quot;</span>
<span class="line-num">136</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">137</span>           <span class="ruby-value">row_type:</span> <span class="ruby-string">&quot;http://rs.gbif.org/terms/1.0/Multimedia&quot;</span>,
<span class="line-num">138</span>           <span class="ruby-value">files:</span> [<span class="ruby-string">&quot;media.csv&quot;</span>],
<span class="line-num">139</span>           <span class="ruby-value">terms:</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">140</span>         }
<span class="line-num">141</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;ObservationFields&quot;</span>
<span class="line-num">142</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">143</span>           <span class="ruby-value">row_type:</span> <span class="ruby-string">&quot;http://www.inaturalist.org/observation_fields&quot;</span>,
<span class="line-num">144</span>           <span class="ruby-value">files:</span> [<span class="ruby-string">&quot;observation_fields.csv&quot;</span>],
<span class="line-num">145</span>           <span class="ruby-value">terms:</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ObservationFields</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">146</span>         }
<span class="line-num">147</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;ProjectObservations&quot;</span>
<span class="line-num">148</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">149</span>           <span class="ruby-value">row_type:</span> <span class="ruby-string">&quot;http://www.inaturalist.org/project_observations&quot;</span>,
<span class="line-num">150</span>           <span class="ruby-value">files:</span> [<span class="ruby-string">&quot;project_observations.csv&quot;</span>],
<span class="line-num">151</span>           <span class="ruby-value">terms:</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ProjectObservations</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">152</span>         }
<span class="line-num">153</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;User&quot;</span>
<span class="line-num">154</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">155</span>           <span class="ruby-value">row_type:</span> <span class="ruby-string">&quot;http://www.inaturalist.org/user&quot;</span>,
<span class="line-num">156</span>           <span class="ruby-value">files:</span> [<span class="ruby-string">&quot;users.csv&quot;</span>],
<span class="line-num">157</span>           <span class="ruby-value">terms:</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">158</span>         }
<span class="line-num">159</span>       <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;VernacularNames&quot;</span>
<span class="line-num">160</span>         <span class="ruby-identifier">extensions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">VernacularName</span>.<span class="ruby-identifier">descriptor</span>
<span class="line-num">161</span>       <span class="ruby-keyword">end</span>
<span class="line-num">162</span>     <span class="ruby-keyword">end</span>
<span class="line-num">163</span>   <span class="ruby-keyword">end</span>
<span class="line-num">164</span>   <span class="ruby-identifier">d</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Descriptor</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">165</span>     <span class="ruby-value">template:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:descriptor</span>],
<span class="line-num">166</span>     <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>],
<span class="line-num">167</span>     <span class="ruby-value">extensions:</span> <span class="ruby-identifier">extensions</span>,
<span class="line-num">168</span>     <span class="ruby-value">ala:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:ala</span>]
<span class="line-num">169</span>   )
<span class="line-num">170</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-string">&quot;meta.xml&quot;</span> )
<span class="line-num">171</span>   <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span> , <span class="ruby-string">&quot;w&quot;</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
<span class="line-num">172</span>     <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">render</span>
<span class="line-num">173</span>   <span class="ruby-keyword">end</span>
<span class="line-num">174</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">175</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_eol_media_data">
            
              <b>make_eol_media_data</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_eol_media_data" name="method-i-make_eol_media_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_eol_media_data_source')" id="l_method-i-make_eol_media_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_eol_media_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">364</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_eol_media_data</span>
<span class="line-num">365</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">366</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;media.csv&quot;</span>
<span class="line-num">367</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">368</span>   <span class="ruby-identifier">licenses</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photo_licenses</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">license_code</span><span class="ruby-operator">|</span>
<span class="line-num">369</span>     <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">license_number_for_code</span>(<span class="ruby-identifier">license_code</span>)
<span class="line-num">370</span>   <span class="ruby-keyword">end</span>
<span class="line-num">371</span>   
<span class="line-num">372</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Photo</span>.
<span class="line-num">373</span>     <span class="ruby-identifier">joins</span>(<span class="ruby-value">:user</span>, {<span class="ruby-value">observation_photos:</span> {<span class="ruby-value">observation:</span> <span class="ruby-value">:taxon</span>}}).
<span class="line-num">374</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;photos.license IN (?) AND taxa.rank_level &lt;= ? AND taxa.id IS NOT NULL&quot;</span>, <span class="ruby-identifier">licenses</span>, <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES_LEVEL</span>)
<span class="line-num">375</span>   
<span class="line-num">376</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;research&quot;</span>
<span class="line-num">377</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade = ?&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span>)
<span class="line-num">378</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;casual&quot;</span>
<span class="line-num">379</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade = ?&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">CASUAL</span>)
<span class="line-num">380</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;verifiable&quot;</span>
<span class="line-num">381</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade IN (?, ?)&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">NEEDS_ID</span>)
<span class="line-num">382</span>   <span class="ruby-keyword">end</span>
<span class="line-num">383</span> 
<span class="line-num">384</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">385</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-node">&quot;JOIN place_geometries ON place_geometries.place_id = #{@place.id}&quot;</span>)
<span class="line-num">386</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;ST_Intersects(place_geometries.geom, observations.private_geom)&quot;</span>)
<span class="line-num">387</span>   <span class="ruby-keyword">end</span>
<span class="line-num">388</span> 
<span class="line-num">389</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&#39;w&#39;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">390</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">391</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">392</span>       <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
<span class="line-num">393</span>         <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">record</span>)
<span class="line-num">394</span>         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">395</span>       <span class="ruby-keyword">end</span>
<span class="line-num">396</span>     <span class="ruby-keyword">else</span>
<span class="line-num">397</span>       <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">398</span>         <span class="ruby-identifier">taxon_scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendant_conditions</span> )
<span class="line-num">399</span>         <span class="ruby-identifier">taxon_scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
<span class="line-num">400</span>           <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">record</span>)
<span class="line-num">401</span>           <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">EolMedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">402</span>         <span class="ruby-keyword">end</span>
<span class="line-num">403</span>       <span class="ruby-keyword">end</span>
<span class="line-num">404</span>     <span class="ruby-keyword">end</span>
<span class="line-num">405</span>   <span class="ruby-keyword">end</span>
<span class="line-num">406</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">407</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_metadata">
            
              <b>make_metadata</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_metadata" name="method-i-make_metadata" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_metadata_source')" id="l_method-i-make_metadata_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_metadata_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">108</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_metadata</span>
<span class="line-num">109</span>   <span class="ruby-identifier">metadata_observation_params</span> = <span class="ruby-identifier">observations_params</span>
<span class="line-num">110</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">metadata_observation_params</span>[<span class="ruby-value">:created_d2</span>]
<span class="line-num">111</span>     <span class="ruby-identifier">metadata_observation_params</span>[<span class="ruby-value">:created_d2</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">112</span>   <span class="ruby-keyword">end</span>
<span class="line-num">113</span>   <span class="ruby-identifier">m</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Metadata</span>.<span class="ruby-identifier">new</span>( <span class="ruby-ivar">@opts</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">114</span>     <span class="ruby-value">observations_params:</span> <span class="ruby-identifier">metadata_observation_params</span>,
<span class="line-num">115</span>     <span class="ruby-value">template:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:metadata</span>]
<span class="line-num">116</span>   ) )
<span class="line-num">117</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-string">&quot;metadata.eml.xml&quot;</span> )
<span class="line-num">118</span>   <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">|</span>
<span class="line-num">119</span>     <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">render</span>
<span class="line-num">120</span>   <span class="ruby-keyword">end</span>
<span class="line-num">121</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">122</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_observation_fields_file">
            
              <b>make_observation_fields_file</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_observation_fields_file" name="method-i-make_observation_fields_file" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_observation_fields_file_source')" id="l_method-i-make_observation_fields_file_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_observation_fields_file_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">471</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_observation_fields_file</span>
<span class="line-num">472</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ObservationFields</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">473</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;observation_fields.csv&quot;</span>
<span class="line-num">474</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">475</span>   <span class="ruby-identifier">preloads</span> = [ { <span class="ruby-value">observation_field_values:</span> <span class="ruby-value">:observation_field</span> } ]
<span class="line-num">476</span>   <span class="ruby-identifier">file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> )
<span class="line-num">477</span>   <span class="ruby-identifier">file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">478</span>   <span class="ruby-identifier">file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">479</span>   { <span class="ruby-value">path:</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">preloads:</span> <span class="ruby-identifier">preloads</span> }
<span class="line-num">480</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_occurrence_file">
            
              <b>make_occurrence_file</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_occurrence_file" name="method-i-make_occurrence_file" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_occurrence_file_source')" id="l_method-i-make_occurrence_file_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_occurrence_file_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">261</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_occurrence_file</span>
<span class="line-num">262</span>   <span class="ruby-ivar">@occurrence_terms</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Occurrence</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>
<span class="line-num">263</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:ala</span>]
<span class="line-num">264</span>     <span class="ruby-ivar">@occurrence_terms</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Occurrence</span><span class="ruby-operator">::</span><span class="ruby-constant">ALA_EXTRA_TERMS</span>
<span class="line-num">265</span>   <span class="ruby-keyword">end</span>
<span class="line-num">266</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Occurrence</span>.<span class="ruby-identifier">term_names</span>( <span class="ruby-ivar">@occurrence_terms</span> )
<span class="line-num">267</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;observations.csv&quot;</span>
<span class="line-num">268</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">269</span> 
<span class="line-num">270</span>   <span class="ruby-identifier">preloads</span> = [
<span class="line-num">271</span>     <span class="ruby-value">:taxon</span>,
<span class="line-num">272</span>     { <span class="ruby-value">user:</span> [<span class="ruby-value">:stored_preferences</span>, <span class="ruby-value">:provider_authorizations</span>] }, 
<span class="line-num">273</span>     <span class="ruby-value">:quality_metrics</span>, 
<span class="line-num">274</span>     { <span class="ruby-value">identifications:</span> { <span class="ruby-value">user:</span> [<span class="ruby-value">:provider_authorizations</span>] } },
<span class="line-num">275</span>     { <span class="ruby-value">observations_places:</span> <span class="ruby-value">:place</span> },
<span class="line-num">276</span>     { <span class="ruby-value">annotations:</span> { <span class="ruby-value">controlled_value:</span> [<span class="ruby-value">:labels</span>], <span class="ruby-value">votes_for:</span> {} } },
<span class="line-num">277</span>     { <span class="ruby-value">site:</span> <span class="ruby-value">:place</span> }
<span class="line-num">278</span>   ]
<span class="line-num">279</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:community_taxon</span>]
<span class="line-num">280</span>     <span class="ruby-identifier">preloads</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:community_taxon</span>
<span class="line-num">281</span>   <span class="ruby-keyword">end</span>
<span class="line-num">282</span>   <span class="ruby-identifier">file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> )
<span class="line-num">283</span>   <span class="ruby-identifier">file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">284</span>   <span class="ruby-identifier">file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">285</span>   { <span class="ruby-value">path:</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">preloads:</span> <span class="ruby-identifier">preloads</span> }
<span class="line-num">286</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_project_observations_file">
            
              <b>make_project_observations_file</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_project_observations_file" name="method-i-make_project_observations_file" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_project_observations_file_source')" id="l_method-i-make_project_observations_file_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_project_observations_file_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">493</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_project_observations_file</span>
<span class="line-num">494</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ProjectObservations</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">495</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;project_observations.csv&quot;</span>
<span class="line-num">496</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">497</span>   <span class="ruby-identifier">preloads</span> = [ { <span class="ruby-value">project_observations:</span> <span class="ruby-value">:project</span> } ]
<span class="line-num">498</span>   <span class="ruby-identifier">file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> )
<span class="line-num">499</span>   <span class="ruby-identifier">file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">500</span>   <span class="ruby-identifier">file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">501</span>   { <span class="ruby-value">path:</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">preloads:</span> <span class="ruby-identifier">preloads</span> }
<span class="line-num">502</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_simple_multimedia_file">
            
              <b>make_simple_multimedia_file</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_simple_multimedia_file" name="method-i-make_simple_multimedia_file" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_simple_multimedia_file_source')" id="l_method-i-make_simple_multimedia_file_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_simple_multimedia_file_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">409</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_simple_multimedia_file</span>
<span class="line-num">410</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">411</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;media.csv&quot;</span>
<span class="line-num">412</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">413</span>   
<span class="line-num">414</span>   <span class="ruby-identifier">params</span> = <span class="ruby-identifier">observations_params</span>
<span class="line-num">415</span>   <span class="ruby-identifier">preloads</span> = [ {
<span class="line-num">416</span>     <span class="ruby-value">observation_photos:</span> {
<span class="line-num">417</span>       <span class="ruby-value">photo:</span> [
<span class="line-num">418</span>         <span class="ruby-value">:file_prefix</span>, <span class="ruby-value">:file_extension</span>, <span class="ruby-value">:user</span>, <span class="ruby-value">:flags</span>, <span class="ruby-value">:photo_metadata</span>
<span class="line-num">419</span>       ] }
<span class="line-num">420</span>     },
<span class="line-num">421</span>     {
<span class="line-num">422</span>       <span class="ruby-value">observation_sounds:</span> {
<span class="line-num">423</span>         <span class="ruby-value">sound:</span> <span class="ruby-value">:user</span>
<span class="line-num">424</span>       }
<span class="line-num">425</span>     }
<span class="line-num">426</span>   ]
<span class="line-num">427</span>   <span class="ruby-identifier">file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> )
<span class="line-num">428</span>   <span class="ruby-identifier">file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">429</span>   <span class="ruby-identifier">file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">430</span>   { <span class="ruby-value">path:</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">preloads:</span> <span class="ruby-identifier">preloads</span> }
<span class="line-num">431</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_taxon_data">
            
              <b>make_taxon_data</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_taxon_data" name="method-i-make_taxon_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_taxon_data_source')" id="l_method-i-make_taxon_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_taxon_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">315</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_taxon_data</span>
<span class="line-num">316</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">317</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;taxa.csv&quot;</span>
<span class="line-num">318</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">319</span>   
<span class="line-num">320</span>   <span class="ruby-identifier">scope</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">select</span>( <span class="ruby-string">&quot;DISTINCT ON (taxa.id) taxa.*&quot;</span> )
<span class="line-num">321</span>   
<span class="line-num">322</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photographed_taxa</span>]
<span class="line-num">323</span>     <span class="ruby-identifier">licenses</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photo_licenses</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">license_code</span><span class="ruby-operator">|</span>
<span class="line-num">324</span>       <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">license_number_for_code</span>(<span class="ruby-identifier">license_code</span>)
<span class="line-num">325</span>     <span class="ruby-keyword">end</span>
<span class="line-num">326</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.
<span class="line-num">327</span>       <span class="ruby-identifier">joins</span>(<span class="ruby-value">:observations</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:observation_photos</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:photo</span>}).
<span class="line-num">328</span>       <span class="ruby-identifier">where</span>(
<span class="line-num">329</span>         <span class="ruby-string">&quot;rank_level &lt;= ? AND observation_photos.id IS NOT NULL AND photos.license IN (?)&quot;</span>,
<span class="line-num">330</span>         <span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES_LEVEL</span>,
<span class="line-num">331</span>         <span class="ruby-identifier">licenses</span>
<span class="line-num">332</span>       )
<span class="line-num">333</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;research&quot;</span>
<span class="line-num">334</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade = ?&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span>)
<span class="line-num">335</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;casual&quot;</span>
<span class="line-num">336</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade = ?&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">CASUAL</span>)
<span class="line-num">337</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;verifiable&quot;</span>
<span class="line-num">338</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;observations.quality_grade IN (?, ?)&quot;</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">RESEARCH_GRADE</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">NEEDS_ID</span>)
<span class="line-num">339</span>     <span class="ruby-keyword">end</span>
<span class="line-num">340</span>   <span class="ruby-keyword">else</span>
<span class="line-num">341</span>     <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;is_active&quot;</span> )
<span class="line-num">342</span>   <span class="ruby-keyword">end</span>
<span class="line-num">343</span> 
<span class="line-num">344</span>   <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&#39;w&#39;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
<span class="line-num">345</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">346</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">347</span>       <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">348</span>         <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">t</span>)
<span class="line-num">349</span>         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">350</span>       <span class="ruby-keyword">end</span>
<span class="line-num">351</span>     <span class="ruby-keyword">else</span>
<span class="line-num">352</span>       <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num">353</span>         <span class="ruby-identifier">taxon_scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">descendant_conditions</span>[<span class="ruby-value">0</span>] )
<span class="line-num">354</span>         <span class="ruby-identifier">taxon_scope</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">355</span>           <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">t</span>)
<span class="line-num">356</span>           <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">357</span>         <span class="ruby-keyword">end</span>
<span class="line-num">358</span>       <span class="ruby-keyword">end</span>
<span class="line-num">359</span>     <span class="ruby-keyword">end</span>
<span class="line-num">360</span>   <span class="ruby-keyword">end</span>
<span class="line-num">361</span>   <span class="ruby-identifier">tmp_path</span>
<span class="line-num">362</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_user_file">
            
              <b>make_user_file</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_user_file" name="method-i-make_user_file" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_user_file_source')" id="l_method-i-make_user_file_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_user_file_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">515</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_user_file</span>
<span class="line-num">516</span>   <span class="ruby-identifier">headers</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">TERM_NAMES</span>
<span class="line-num">517</span>   <span class="ruby-identifier">fname</span> = <span class="ruby-string">&quot;users.csv&quot;</span>
<span class="line-num">518</span>   <span class="ruby-identifier">tmp_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:work_path</span>], <span class="ruby-identifier">fname</span>)
<span class="line-num">519</span>   <span class="ruby-identifier">preloads</span> = [ <span class="ruby-value">:user</span> ]
<span class="line-num">520</span>   <span class="ruby-identifier">file</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>( <span class="ruby-identifier">tmp_path</span>, <span class="ruby-string">&quot;w&quot;</span> )
<span class="line-num">521</span>   <span class="ruby-identifier">file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>
<span class="line-num">522</span>   <span class="ruby-identifier">file</span>.<span class="ruby-identifier">close</span>
<span class="line-num">523</span>   { <span class="ruby-value">path:</span> <span class="ruby-identifier">tmp_path</span>, <span class="ruby-value">preloads:</span> <span class="ruby-identifier">preloads</span> }
<span class="line-num">524</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-make_vernacular_names_data">
            
              <b>make_vernacular_names_data</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-make_vernacular_names_data" name="method-i-make_vernacular_names_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-make_vernacular_names_data_source')" id="l_method-i-make_vernacular_names_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-make_vernacular_names_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">533</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">make_vernacular_names_data</span>
<span class="line-num">534</span>   <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">VernacularName</span>.<span class="ruby-identifier">data</span>( <span class="ruby-ivar">@opts</span> )
<span class="line-num">535</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observations_in_batches">
            
              <b>observations_in_batches</b>( params, preloads, start_id, end_id, options = {} )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-observations_in_batches" name="method-i-observations_in_batches" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observations_in_batches_source')" id="l_method-i-observations_in_batches_source">show</a>
                

                

                
              </p>
              <div id="method-i-observations_in_batches_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">630</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observations_in_batches</span>( <span class="ruby-identifier">params</span>, <span class="ruby-identifier">preloads</span>, <span class="ruby-identifier">start_id</span>, <span class="ruby-identifier">end_id</span>, <span class="ruby-identifier">options</span> = {} )
<span class="line-num">631</span>   <span class="ruby-identifier">batch_times</span> = []
<span class="line-num">632</span>   <span class="ruby-identifier">search_chunk_size</span> = <span class="ruby-value">200000</span>
<span class="line-num">633</span>   <span class="ruby-identifier">chunk_start_id</span> = <span class="ruby-value">1</span>
<span class="line-num">634</span>   <span class="ruby-identifier">last_seen_observation_id</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">635</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:created_d1</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:created_d2</span>]
<span class="line-num">636</span>     <span class="ruby-comment"># no date limits provided. We want to set a default upper limit of roughly when</span>
<span class="line-num">637</span>     <span class="ruby-comment"># the archive started exporting. Don&#39;t add created_d2 to the ES query, which</span>
<span class="line-num">638</span>     <span class="ruby-comment"># creates slower queries, rather check the date in Ruby</span>
<span class="line-num">639</span>     <span class="ruby-identifier">max_observation_created</span> = ( <span class="ruby-ivar">@generate_started_at</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
<span class="line-num">640</span>   <span class="ruby-keyword">end</span>
<span class="line-num">641</span>   <span class="ruby-identifier">observations_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">642</span>   <span class="ruby-comment"># initial loop splits queries into batches by setting the search param</span>
<span class="line-num">643</span>   <span class="ruby-comment"># `id_below`. This make queries with very large result sets faster overall</span>
<span class="line-num">644</span>   <span class="ruby-comment"># with little overhead for small queries.</span>
<span class="line-num">645</span>   <span class="ruby-identifier">chunk_start_id</span> = <span class="ruby-identifier">start_id</span>
<span class="line-num">646</span>   <span class="ruby-keyword">while</span> <span class="ruby-identifier">chunk_start_id</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">end_id</span>
<span class="line-num">647</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:min_id</span>] = <span class="ruby-identifier">chunk_start_id</span>
<span class="line-num">648</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_id</span>] = [<span class="ruby-identifier">chunk_start_id</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">search_chunk_size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">end_id</span>].<span class="ruby-identifier">min</span>
<span class="line-num">649</span>     <span class="ruby-identifier">try_and_try_again</span>( [
<span class="line-num">650</span>               <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceUnavailable</span>,
<span class="line-num">651</span>               <span class="ruby-constant">Elasticsearch</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Transport</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span><span class="ruby-operator">::</span><span class="ruby-constant">TooManyRequests</span>], <span class="ruby-value">sleep:</span> <span class="ruby-value">1</span>, <span class="ruby-value">tries:</span> <span class="ruby-value">10</span>, <span class="ruby-value">logger:</span> <span class="ruby-identifier">logger</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">652</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">search_in_batches</span>( <span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge</span>(
<span class="line-num">653</span>         <span class="ruby-value">per_page:</span> <span class="ruby-value">1000</span>
<span class="line-num">654</span>       ), <span class="ruby-value">logger:</span> <span class="ruby-identifier">logger</span> ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">batch</span><span class="ruby-operator">|</span>
<span class="line-num">655</span>         <span class="ruby-identifier">avg_batch_time</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">batch_times</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">656</span>           (<span class="ruby-identifier">batch_times</span>.<span class="ruby-identifier">inject</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">num</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">num</span>}.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">batch_times</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">3</span>)
<span class="line-num">657</span>         <span class="ruby-keyword">else</span>
<span class="line-num">658</span>           <span class="ruby-value">0</span>
<span class="line-num">659</span>         <span class="ruby-keyword">end</span>
<span class="line-num">660</span>         <span class="ruby-identifier">avg_observation_time</span> = <span class="ruby-identifier">avg_batch_time</span> <span class="ruby-operator">/</span> <span class="ruby-constant">ObservationSearch</span><span class="ruby-operator">::</span><span class="ruby-constant">SEARCH_IN_BATCHES_BATCH_SIZE</span>
<span class="line-num">661</span>         <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;Observation batch #{batch_times.size}&quot;</span>
<span class="line-num">662</span>         <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; for #{options[:label]}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:label</span>]
<span class="line-num">663</span>         <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; (avg batch: #{avg_batch_time}s, avg obs: #{avg_observation_time}s, obs in batch: #{batch.size})&quot;</span>
<span class="line-num">664</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">batch_times</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">%</span> <span class="ruby-value">20</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">665</span>           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">msg</span>
<span class="line-num">666</span>           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">flush</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">respond_to?</span>( <span class="ruby-value">:flush</span> )
<span class="line-num">667</span>         <span class="ruby-keyword">else</span>
<span class="line-num">668</span>           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">msg</span>
<span class="line-num">669</span>         <span class="ruby-keyword">end</span>
<span class="line-num">670</span>         <span class="ruby-identifier">try_and_try_again</span>( [<span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionBad</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">StatementInvalid</span>], <span class="ruby-value">logger:</span> <span class="ruby-identifier">logger</span> ) <span class="ruby-keyword">do</span>
<span class="line-num">671</span>           <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">batch</span>, <span class="ruby-identifier">preloads</span>)
<span class="line-num">672</span>         <span class="ruby-keyword">end</span>
<span class="line-num">673</span>         <span class="ruby-identifier">filtered_obs</span> = <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">674</span>           <span class="ruby-operator">!</span> ( ( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:community_taxon</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">community_taxon</span>.<span class="ruby-identifier">blank?</span> ) <span class="ruby-operator">||</span>
<span class="line-num">675</span>               ( <span class="ruby-identifier">max_observation_created</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_observation_created</span> ) <span class="ruby-operator">||</span>
<span class="line-num">676</span>               ( <span class="ruby-identifier">last_seen_observation_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">last_seen_observation_id</span> ) )
<span class="line-num">677</span>         <span class="ruby-keyword">end</span>
<span class="line-num">678</span>         <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">uniq!</span>
<span class="line-num">679</span>         <span class="ruby-identifier">batch</span>.<span class="ruby-identifier">sort!</span>
<span class="line-num">680</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_obs</span> = <span class="ruby-identifier">filtered_obs</span>.<span class="ruby-identifier">last</span>
<span class="line-num">681</span>           <span class="ruby-identifier">last_seen_observation_id</span> = <span class="ruby-identifier">last_obs</span>.<span class="ruby-identifier">id</span>
<span class="line-num">682</span>         <span class="ruby-keyword">end</span>
<span class="line-num">683</span>         <span class="ruby-keyword">yield</span> <span class="ruby-identifier">filtered_obs</span>
<span class="line-num">684</span>         <span class="ruby-identifier">batch_times</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">observations_start</span>)
<span class="line-num">685</span>         <span class="ruby-identifier">observations_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">686</span>       <span class="ruby-keyword">end</span>
<span class="line-num">687</span>     <span class="ruby-keyword">end</span>
<span class="line-num">688</span> 
<span class="line-num">689</span>     <span class="ruby-identifier">chunk_start_id</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">search_chunk_size</span>
<span class="line-num">690</span>   <span class="ruby-keyword">end</span>
<span class="line-num">691</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observations_params">
            
              <b>observations_params</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-observations_params" name="method-i-observations_params" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observations_params_source')" id="l_method-i-observations_params_source">show</a>
                

                

                
              </p>
              <div id="method-i-observations_params_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">222</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observations_params</span>
<span class="line-num">223</span>   <span class="ruby-identifier">params</span> = {}
<span class="line-num">224</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:license</span>] = [<span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;,&quot;</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:licenses</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;ignore&quot;</span> )
<span class="line-num">225</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] = <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>
<span class="line-num">226</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_ids</span>] = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>
<span class="line-num">227</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:projects</span>] = [<span class="ruby-ivar">@project</span>.<span class="ruby-identifier">id</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@project</span>
<span class="line-num">228</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:quality_grade</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>] <span class="ruby-operator">===</span> <span class="ruby-string">&quot;verifiable&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;research,needs_id&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:quality</span>]
<span class="line-num">229</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:site_id</span>]
<span class="line-num">230</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:d1</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:d1</span>]
<span class="line-num">231</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:d2</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:d2</span>]
<span class="line-num">232</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:created_d1</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:created_d1</span>]
<span class="line-num">233</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:created_d2</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:created_d2</span>]
<span class="line-num">234</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photos</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;true&quot;</span>
<span class="line-num">235</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:with_photos</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">236</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:photos</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
<span class="line-num">237</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:with_photos</span>] = <span class="ruby-keyword">false</span>
<span class="line-num">238</span>   <span class="ruby-keyword">end</span>
<span class="line-num">239</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:ofv_datatype</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:ofv_datatype</span>]
<span class="line-num">240</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:swlat</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:swlng</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:nelat</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:nelng</span>].<span class="ruby-identifier">blank?</span> )
<span class="line-num">241</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:swlat</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:swlat</span>]
<span class="line-num">242</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:swlng</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:swlng</span>]
<span class="line-num">243</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:nelat</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:nelat</span>]
<span class="line-num">244</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:nelng</span>] = <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:nelng</span>]
<span class="line-num">245</span>   <span class="ruby-keyword">end</span>
<span class="line-num">246</span>   <span class="ruby-identifier">params</span>
<span class="line-num">247</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-process_observations">
            
              <b>process_observations</b>( params, preloads, options = {}, &amp;block )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-process_observations" name="method-i-process_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-process_observations_source')" id="l_method-i-process_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-process_observations_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">603</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">process_observations</span>( <span class="ruby-identifier">params</span>, <span class="ruby-identifier">preloads</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span> )
<span class="line-num">604</span>   <span class="ruby-identifier">max_id</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">maximum</span>( <span class="ruby-value">:id</span> )
<span class="line-num">605</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:processes</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="line-num">606</span>     <span class="ruby-comment"># use the Parallel gem if more than one process was requested</span>
<span class="line-num">607</span>     <span class="ruby-identifier">range_partitions</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Archive</span>.<span class="ruby-identifier">partition_range</span>( <span class="ruby-value">1</span>, <span class="ruby-identifier">max_id</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:processes</span>] )
<span class="line-num">608</span>     <span class="ruby-constant">Parallel</span>.<span class="ruby-identifier">each</span>( <span class="ruby-identifier">range_partitions</span>, <span class="ruby-value">in_processes:</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:processes</span>] ) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">range</span><span class="ruby-operator">|</span>
<span class="line-num">609</span>       <span class="ruby-identifier">observations_in_batches</span>(
<span class="line-num">610</span>         <span class="ruby-identifier">params</span>,
<span class="line-num">611</span>         <span class="ruby-identifier">preloads</span>,
<span class="line-num">612</span>         <span class="ruby-identifier">range</span>[<span class="ruby-value">:start_id</span>],
<span class="line-num">613</span>         <span class="ruby-identifier">range</span>[<span class="ruby-value">:end_id</span>],
<span class="line-num">614</span>         <span class="ruby-identifier">options</span>,
<span class="line-num">615</span>         <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
<span class="line-num">616</span>       )
<span class="line-num">617</span>     <span class="ruby-keyword">end</span>
<span class="line-num">618</span>   <span class="ruby-keyword">else</span>
<span class="line-num">619</span>     <span class="ruby-identifier">observations_in_batches</span>(
<span class="line-num">620</span>       <span class="ruby-identifier">params</span>,
<span class="line-num">621</span>       <span class="ruby-identifier">preloads</span>,
<span class="line-num">622</span>       <span class="ruby-value">1</span>,
<span class="line-num">623</span>       <span class="ruby-identifier">max_id</span>,
<span class="line-num">624</span>       <span class="ruby-identifier">options</span>,
<span class="line-num">625</span>       <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
<span class="line-num">626</span>     )
<span class="line-num">627</span>   <span class="ruby-keyword">end</span>
<span class="line-num">628</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-upload_to_aws_s3">
            
              <b>upload_to_aws_s3</b>()
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-upload_to_aws_s3" name="method-i-upload_to_aws_s3" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-upload_to_aws_s3_source')" id="l_method-i-upload_to_aws_s3_source">show</a>
                

                

                
              </p>
              <div id="method-i-upload_to_aws_s3_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">744</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">upload_to_aws_s3</span>
<span class="line-num">745</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:aws_s3_path</span>]
<span class="line-num">746</span>   <span class="ruby-identifier">s3_config</span> = <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load_file</span>( <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&quot;config&quot;</span>, <span class="ruby-string">&quot;s3.yml&quot;</span> ) )
<span class="line-num">747</span>   <span class="ruby-identifier">client</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Aws</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">748</span>     <span class="ruby-value">access_key_id:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;access_key_id&quot;</span>],
<span class="line-num">749</span>     <span class="ruby-value">secret_access_key:</span> <span class="ruby-identifier">s3_config</span>[<span class="ruby-string">&quot;secret_access_key&quot;</span>],
<span class="line-num">750</span>     <span class="ruby-value">region:</span> <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_region</span>
<span class="line-num">751</span>   )
<span class="line-num">752</span>   <span class="ruby-identifier">resource</span> = <span class="ruby-constant">Aws</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span><span class="ruby-operator">::</span><span class="ruby-constant">Resource</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">client:</span> <span class="ruby-identifier">client</span> )
<span class="line-num">753</span>   <span class="ruby-identifier">bucket</span> = <span class="ruby-identifier">resource</span>.<span class="ruby-identifier">bucket</span>( <span class="ruby-constant">CONFIG</span>.<span class="ruby-identifier">s3_bucket</span> )
<span class="line-num">754</span>   <span class="ruby-identifier">object</span> = <span class="ruby-identifier">bucket</span>.<span class="ruby-identifier">object</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:aws_s3_path</span>] )
<span class="line-num">755</span>   <span class="ruby-identifier">object</span>.<span class="ruby-identifier">upload_file</span>( <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:path</span>], {
<span class="line-num">756</span>     <span class="ruby-value">acl:</span> <span class="ruby-string">&quot;public-read&quot;</span>,
<span class="line-num">757</span>     <span class="ruby-value">content_encoding:</span> <span class="ruby-string">&quot;zip&quot;</span>
<span class="line-num">758</span>   } )
<span class="line-num">759</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write_observation_fields_data">
            
              <b>write_observation_fields_data</b>( observations, csv )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-write_observation_fields_data" name="method-i-write_observation_fields_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-write_observation_fields_data_source')" id="l_method-i-write_observation_fields_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-write_observation_fields_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">482</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_observation_fields_data</span>( <span class="ruby-identifier">observations</span>, <span class="ruby-identifier">csv</span> )
<span class="line-num">483</span>   <span class="ruby-ivar">@generate_started_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">484</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">485</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_field_values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ofv</span><span class="ruby-operator">|</span>
<span class="line-num">486</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@generate_started_at</span>
<span class="line-num">487</span>       <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ObservationFields</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">ofv</span>, <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>, <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>])
<span class="line-num">488</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ObservationFields</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ofv</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">489</span>     <span class="ruby-keyword">end</span>
<span class="line-num">490</span>   <span class="ruby-keyword">end</span>
<span class="line-num">491</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write_occurrence_data">
            
              <b>write_occurrence_data</b>( observations, csv )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-write_occurrence_data" name="method-i-write_occurrence_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-write_occurrence_data_source')" id="l_method-i-write_occurrence_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-write_occurrence_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">288</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_occurrence_data</span>( <span class="ruby-identifier">observations</span>, <span class="ruby-identifier">csv</span> )
<span class="line-num">289</span>   <span class="ruby-ivar">@fake_view</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">FakeView</span>.<span class="ruby-identifier">new</span>
<span class="line-num">290</span>   <span class="ruby-identifier">taxon_ranked_ancestors</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Archive</span>.<span class="ruby-identifier">lookup_taxa_for_obs_batch</span>( <span class="ruby-identifier">observations</span> )
<span class="line-num">291</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">292</span>     <span class="ruby-identifier">benchmark</span>(<span class="ruby-value">:obs</span>) <span class="ruby-keyword">do</span>
<span class="line-num">293</span>       <span class="ruby-identifier">private_coordinates</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:private_coordinates</span>]
<span class="line-num">294</span>         <span class="ruby-keyword">true</span>
<span class="line-num">295</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:taxon_private_coordinates</span>]
<span class="line-num">296</span>         [<span class="ruby-keyword">nil</span>, <span class="ruby-constant">Observation</span><span class="ruby-operator">::</span><span class="ruby-constant">OPEN</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">geoprivacy</span> )
<span class="line-num">297</span>       <span class="ruby-keyword">end</span>
<span class="line-num">298</span>       <span class="ruby-identifier">observation</span> = <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Occurrence</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">observation</span>,
<span class="line-num">299</span>         <span class="ruby-value">view:</span> <span class="ruby-ivar">@fake_view</span>,
<span class="line-num">300</span>         <span class="ruby-value">private_coordinates:</span> <span class="ruby-identifier">private_coordinates</span>,
<span class="line-num">301</span>         <span class="ruby-value">community_taxon:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:community_taxon</span>]
<span class="line-num">302</span>       )
<span class="line-num">303</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">dwc_taxon</span>
<span class="line-num">304</span>         <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">set_ranked_ancestors</span>( <span class="ruby-identifier">taxon_ranked_ancestors</span>[<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">dwc_taxon</span>.<span class="ruby-identifier">id</span>] )
<span class="line-num">305</span>       <span class="ruby-keyword">end</span>
<span class="line-num">306</span>       <span class="ruby-identifier">row</span> = <span class="ruby-ivar">@occurrence_terms</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span>
<span class="line-num">307</span>         <span class="ruby-identifier">key</span> = <span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>
<span class="line-num">308</span>         <span class="ruby-identifier">benchmark</span>( <span class="ruby-node">&quot;obs_#{key}&quot;</span> ) { <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">key</span> ) }
<span class="line-num">309</span>       <span class="ruby-keyword">end</span>
<span class="line-num">310</span>       <span class="ruby-identifier">benchmark</span>(<span class="ruby-value">:obs_csv_row</span>) { <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">row</span> }
<span class="line-num">311</span>     <span class="ruby-keyword">end</span>
<span class="line-num">312</span>   <span class="ruby-keyword">end</span>
<span class="line-num">313</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write_project_observations_data">
            
              <b>write_project_observations_data</b>( observations, csv )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-write_project_observations_data" name="method-i-write_project_observations_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-write_project_observations_data_source')" id="l_method-i-write_project_observations_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-write_project_observations_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">504</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_project_observations_data</span>( <span class="ruby-identifier">observations</span>, <span class="ruby-identifier">csv</span> )
<span class="line-num">505</span>   <span class="ruby-ivar">@generate_started_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">506</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">507</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">project_observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">po</span><span class="ruby-operator">|</span>
<span class="line-num">508</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@generate_started_at</span>
<span class="line-num">509</span>       <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ProjectObservations</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">po</span>, <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>])
<span class="line-num">510</span>       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ProjectObservations</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">po</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">511</span>     <span class="ruby-keyword">end</span>
<span class="line-num">512</span>   <span class="ruby-keyword">end</span>
<span class="line-num">513</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write_simple_multimedia_data">
            
              <b>write_simple_multimedia_data</b>( observations, csv )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-write_simple_multimedia_data" name="method-i-write_simple_multimedia_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-write_simple_multimedia_data_source')" id="l_method-i-write_simple_multimedia_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-write_simple_multimedia_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">433</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_simple_multimedia_data</span>( <span class="ruby-identifier">observations</span>, <span class="ruby-identifier">csv</span> )
<span class="line-num">434</span>   <span class="ruby-ivar">@generate_started_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num">435</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">436</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_sounds</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">437</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">438</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_photos</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">position</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">op</span><span class="ruby-operator">|</span>
<span class="line-num">439</span>         <span class="ruby-comment"># If ES is out of sync with the DB, the photo might no longer exist</span>
<span class="line-num">440</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">441</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">442</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">443</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@generate_started_at</span>
<span class="line-num">444</span>         <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@opts</span>[<span class="ruby-value">:media_licenses</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;ignore&quot;</span> )
<span class="line-num">445</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">all_rights_reserved?</span>
<span class="line-num">446</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:media_licenses</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">license_code</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> )
<span class="line-num">447</span>         <span class="ruby-keyword">end</span>
<span class="line-num">448</span>         <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span>.<span class="ruby-identifier">adapt</span>(<span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>, <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>, <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>])
<span class="line-num">449</span>         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">op</span>.<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">450</span>       <span class="ruby-keyword">end</span>
<span class="line-num">451</span>       <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">observation_sounds</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">os</span><span class="ruby-operator">|</span>
<span class="line-num">452</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">453</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">454</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">455</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">LocalSound</span> ) <span class="ruby-comment"># Soundcloud sounds don&#39;t come with stable file URLs we can share</span>
<span class="line-num">456</span>         <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@generate_started_at</span>
<span class="line-num">457</span>         <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@opts</span>[<span class="ruby-value">:media_licenses</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;ignore&quot;</span> )
<span class="line-num">458</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>.<span class="ruby-identifier">all_rights_reserved?</span>
<span class="line-num">459</span>           <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:media_licenses</span>].<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>.<span class="ruby-identifier">license_code</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> )
<span class="line-num">460</span>         <span class="ruby-keyword">end</span>
<span class="line-num">461</span>         <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span>.<span class="ruby-identifier">adapt</span>( <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>, <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span>, <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>] )
<span class="line-num">462</span>         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SimpleMultimedia</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sound</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">463</span>       <span class="ruby-keyword">end</span>
<span class="line-num">464</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">465</span>       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;make_simple_multimedia_data failed on observation #{observation.id}&quot;</span>
<span class="line-num">466</span>       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
<span class="line-num">467</span>     <span class="ruby-keyword">end</span>
<span class="line-num">468</span>   <span class="ruby-keyword">end</span>
<span class="line-num">469</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write_user_data">
            
              <b>write_user_data</b>( observations, csv )
            
            <a href="../../classes/DarwinCore/Archive.html#method-i-write_user_data" name="method-i-write_user_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-write_user_data_source')" id="l_method-i-write_user_data_source">show</a>
                

                

                
              </p>
              <div id="method-i-write_user_data_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/darwin_core/archive.rb</span>
<span class="line-num">526</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_user_data</span>( <span class="ruby-identifier">observations</span>, <span class="ruby-identifier">csv</span> )
<span class="line-num">527</span>   <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">528</span>     <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">User</span>.<span class="ruby-identifier">adapt</span>( <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user</span>, <span class="ruby-value">core:</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:core</span>], <span class="ruby-value">observation:</span> <span class="ruby-identifier">observation</span> )
<span class="line-num">529</span>     <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DarwinCore</span><span class="ruby-operator">::</span><span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">TERMS</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">default</span>, <span class="ruby-identifier">method</span><span class="ruby-operator">|</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">field</span>)}
<span class="line-num">530</span>   <span class="ruby-keyword">end</span>
<span class="line-num">531</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
