<!DOCTYPE html>
<html lang="en">
<head>
    <title>TaxaController</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["TaxaController"]'>


    <meta property="og:title" value="TaxaController">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="TaxaController class, index, show, browse_photos, taxonomy_details, tip, new, create, edit, update, destroy, clashes, search, autocomplete, browse, occur_in, children, photos, schemes, map, range, observation_photos, map_layers, taxobox, update_photos, set_photos, describe, links, refresh_wikipedia_summary, update_colors, graft, history, merge, curation, synonyms, flickr_tagger, tag_flickr_photos, tag_flickr_photos_from_observations, flickr_photos_tagged, try_show">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            TaxaController
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationController.html">ApplicationController</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/controllers/taxa_controller_rb.html">app/controllers/taxa_controller.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-autocomplete">autocomplete</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-browse">browse</a>,
              </li>
            
              
              <li>
                <a href="#method-i-browse_photos">browse_photos</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-children">children</a>,
              </li>
            
              
              <li>
                <a href="#method-i-clashes">clashes</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create">create</a>,
              </li>
            
              
              <li>
                <a href="#method-i-curation">curation</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-describe">describe</a>,
              </li>
            
              
              <li>
                <a href="#method-i-destroy">destroy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-edit">edit</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-flickr_photos_tagged">flickr_photos_tagged</a>,
              </li>
            
              
              <li>
                <a href="#method-i-flickr_tagger">flickr_tagger</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-graft">graft</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-history">history</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-index">index</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-links">links</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-map">map</a>,
              </li>
            
              
              <li>
                <a href="#method-i-map_layers">map_layers</a>,
              </li>
            
              
              <li>
                <a href="#method-i-merge">merge</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-observation_photos">observation_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-occur_in">occur_in</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-photos">photos</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-range">range</a>,
              </li>
            
              
              <li>
                <a href="#method-i-refresh_wikipedia_summary">refresh_wikipedia_summary</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-schemes">schemes</a>,
              </li>
            
              
              <li>
                <a href="#method-i-search">search</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_photos">set_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show">show</a>,
              </li>
            
              
              <li>
                <a href="#method-i-synonyms">synonyms</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-tag_flickr_photos">tag_flickr_photos</a>,
              </li>
            
              
              <li>
                <a href="#method-i-tag_flickr_photos_from_observations">tag_flickr_photos_from_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxobox">taxobox</a>,
              </li>
            
              
              <li>
                <a href="#method-i-taxonomy_details">taxonomy_details</a>,
              </li>
            
              
              <li>
                <a href="#method-i-tip">tip</a>,
              </li>
            
              
              <li>
                <a href="#method-i-try_show">try_show</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-update">update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_colors">update_colors</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_photos">update_photos</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="TaxaHelper.html">
              TaxaHelper
            </a>
          
        </li>
      
        <li>
          
            <a href="Shared/WikipediaModule.html">
              Shared::WikipediaModule
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_PHOTO_PARTIALS</td>
            <td>=</td>
            <td class="attr-value">%w( photo )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_SHOW_PARTIALS</td>
            <td>=</td>
            <td class="attr-value">%w( chooser )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">BROWSE_VIEWS</td>
            <td>=</td>
            <td class="attr-value">[GRID_VIEW, LIST_VIEW]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">GRID_VIEW</td>
            <td>=</td>
            <td class="attr-value">&quot;grid&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LIST_VIEW</td>
            <td>=</td>
            <td class="attr-value">&quot;list&quot;</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-autocomplete">
            
              <b>autocomplete</b>()
            
            <a href="../classes/TaxaController.html#method-i-autocomplete" name="method-i-autocomplete" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-autocomplete_source')" id="l_method-i-autocomplete_source">show</a>
                

                

                
              </p>
              <div id="method-i-autocomplete_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">592</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">autocomplete</span>
<span class="line-num">593</span>   <span class="ruby-ivar">@q</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:term</span>]
<span class="line-num">594</span>   <span class="ruby-ivar">@is_active</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;true&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">595</span>     <span class="ruby-keyword">true</span>
<span class="line-num">596</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
<span class="line-num">597</span>     <span class="ruby-keyword">false</span>
<span class="line-num">598</span>   <span class="ruby-keyword">else</span>
<span class="line-num">599</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>]
<span class="line-num">600</span>   <span class="ruby-keyword">end</span>
<span class="line-num">601</span>   <span class="ruby-identifier">filters</span> = [{
<span class="line-num">602</span>     <span class="ruby-value">nested:</span> {
<span class="line-num">603</span>       <span class="ruby-value">path:</span> <span class="ruby-string">&quot;names&quot;</span>,
<span class="line-num">604</span>       <span class="ruby-value">query:</span> {
<span class="line-num">605</span>         <span class="ruby-value">match:</span> { <span class="ruby-value">&quot;names.name_autocomplete&quot;:</span> { <span class="ruby-value">query:</span> <span class="ruby-ivar">@q</span>, <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span> } }
<span class="line-num">606</span>       }
<span class="line-num">607</span>     }
<span class="line-num">608</span>   }]
<span class="line-num">609</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@is_active</span> <span class="ruby-operator">===</span> <span class="ruby-keyword">true</span>
<span class="line-num">610</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">false</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@is_active</span> <span class="ruby-operator">===</span> <span class="ruby-keyword">false</span>
<span class="line-num">611</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_paginate</span>(
<span class="line-num">612</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>,
<span class="line-num">613</span>     <span class="ruby-value">sort:</span> { <span class="ruby-value">observations_count:</span> <span class="ruby-string">&quot;desc&quot;</span> },
<span class="line-num">614</span>     <span class="ruby-value">per_page:</span> <span class="ruby-value">30</span>,
<span class="line-num">615</span>     <span class="ruby-value">page:</span> <span class="ruby-value">1</span>
<span class="line-num">616</span>   )
<span class="line-num">617</span>   <span class="ruby-comment"># attempt to fetch the best exact match, which will go first</span>
<span class="line-num">618</span>   <span class="ruby-identifier">exact_results</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_paginate</span>(
<span class="line-num">619</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span> <span class="ruby-operator">+</span> [ {
<span class="line-num">620</span>       <span class="ruby-value">nested:</span> {
<span class="line-num">621</span>         <span class="ruby-value">path:</span> <span class="ruby-string">&quot;names&quot;</span>,
<span class="line-num">622</span>         <span class="ruby-value">query:</span> {
<span class="line-num">623</span>           <span class="ruby-value">match:</span> { <span class="ruby-string">&quot;names.exact_ci&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@q</span> }
<span class="line-num">624</span>         }
<span class="line-num">625</span>       }
<span class="line-num">626</span>     } ],
<span class="line-num">627</span>     <span class="ruby-value">sort:</span> { <span class="ruby-value">observations_count:</span> <span class="ruby-string">&quot;desc&quot;</span> },
<span class="line-num">628</span>     <span class="ruby-value">per_page:</span> <span class="ruby-value">1</span>,
<span class="line-num">629</span>     <span class="ruby-value">page:</span> <span class="ruby-value">1</span>
<span class="line-num">630</span>   )
<span class="line-num">631</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">exact_results</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">exact_results</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">632</span>     <span class="ruby-identifier">exact_result</span> = <span class="ruby-identifier">exact_results</span>.<span class="ruby-identifier">first</span>
<span class="line-num">633</span>     <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">delete_if</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">exact_result</span> }
<span class="line-num">634</span>     <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">exact_result</span>)
<span class="line-num">635</span>   <span class="ruby-keyword">end</span>
<span class="line-num">636</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxa</span>, [ { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> },
<span class="line-num">637</span>     <span class="ruby-value">:taxon_descriptions</span> ] )
<span class="line-num">638</span>   <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
<span class="line-num">639</span>     <span class="ruby-identifier">t</span>.<span class="ruby-identifier">html</span> = <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">render_in_format</span>(<span class="ruby-value">:html</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;chooser.html.erb&quot;</span>,
<span class="line-num">640</span>       <span class="ruby-value">:object</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>, <span class="ruby-value">:comname</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">common_name</span>)
<span class="line-num">641</span>   <span class="ruby-keyword">end</span>
<span class="line-num">642</span>   <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">uniq!</span>
<span class="line-num">643</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">644</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">645</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:html</span>])
<span class="line-num">646</span>     <span class="ruby-keyword">end</span>
<span class="line-num">647</span>   <span class="ruby-keyword">end</span>
<span class="line-num">648</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-browse">
            
              <b>browse</b>()
            
            <a href="../classes/TaxaController.html#method-i-browse" name="method-i-browse" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-browse_source')" id="l_method-i-browse_source">show</a>
                

                

                
              </p>
              <div id="method-i-browse_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">650</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">browse</span>
<span class="line-num">651</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;search&quot;</span>
<span class="line-num">652</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-browse_photos">
            
              <b>browse_photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-browse_photos" name="method-i-browse_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-browse_photos_source')" id="l_method-i-browse_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-browse_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">216</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">browse_photos</span>
<span class="line-num">217</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">218</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">219</span>       <span class="ruby-identifier">options</span> = {}
<span class="line-num">220</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:api_token</span>] = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">api_token</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>
<span class="line-num">221</span>       <span class="ruby-identifier">site_place</span> = <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">222</span>       <span class="ruby-identifier">user_place</span> = <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">place</span>
<span class="line-num">223</span>       <span class="ruby-identifier">preferred_place</span> = <span class="ruby-identifier">user_place</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">site_place</span>
<span class="line-num">224</span>       <span class="ruby-ivar">@node_taxon_json</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>(
<span class="line-num">225</span>         <span class="ruby-node">&quot;/taxa/#{@taxon.id}?preferred_place_id=#{preferred_place.try(:id)}&amp;place_id=#{@place.try(:id)}&amp;locale=#{I18n.locale}&quot;</span>,
<span class="line-num">226</span>         <span class="ruby-identifier">options</span>
<span class="line-num">227</span>       )
<span class="line-num">228</span>       <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">preferred_taxon_page_place_id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">229</span>       <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-value">:prefers_taxon_page_place_id</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">230</span>       <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">place_id</span> )
<span class="line-num">231</span>       <span class="ruby-ivar">@ancestors_shown</span> = <span class="ruby-identifier">session</span>[<span class="ruby-value">:preferred_taxon_page_ancestors_shown</span>]
<span class="line-num">232</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">233</span>     <span class="ruby-keyword">end</span>
<span class="line-num">234</span>   <span class="ruby-keyword">end</span>
<span class="line-num">235</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-children">
            
              <b>children</b>()
            
            <a href="../classes/TaxaController.html#method-i-children" name="method-i-children" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p><a href="List.html"><code>List</code></a> child taxa of this taxon</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-children_source')" id="l_method-i-children_source">show</a>
                

                

                
              </p>
              <div id="method-i-children_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">672</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">children</span>
<span class="line-num">673</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">children</span>
<span class="line-num">674</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num">675</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">inactive</span>
<span class="line-num">676</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">677</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">active</span>
<span class="line-num">678</span>   <span class="ruby-keyword">end</span>
<span class="line-num">679</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">680</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">taxon_path</span>(<span class="ruby-ivar">@taxon</span>) }
<span class="line-num">681</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span> <span class="ruby-keyword">do</span>
<span class="line-num">682</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:xml</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_xml</span>(
<span class="line-num">683</span>               <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:taxon_names</span>, <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:common_name</span>] )
<span class="line-num">684</span>     <span class="ruby-keyword">end</span>
<span class="line-num">685</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">686</span>       <span class="ruby-identifier">options</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">687</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">merge!</span>(<span class="ruby-value">:taxon_names</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:lexicon</span>]})
<span class="line-num">688</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:common_name</span>]
<span class="line-num">689</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">includes</span>([{<span class="ruby-value">:taxon_photos</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:photo</span>}, <span class="ruby-value">:taxon_names</span>]).<span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">690</span>     <span class="ruby-keyword">end</span>
<span class="line-num">691</span>   <span class="ruby-keyword">end</span>
<span class="line-num">692</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-clashes">
            
              <b>clashes</b>()
            
            <a href="../classes/TaxaController.html#method-i-clashes" name="method-i-clashes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Custom actions ############################################################</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-clashes_source')" id="l_method-i-clashes_source">show</a>
                

                

                
              </p>
              <div id="method-i-clashes_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">375</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clashes</span>
<span class="line-num">376</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">377</span>   <span class="ruby-ivar">@context</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:context</span>]
<span class="line-num">378</span>   <span class="ruby-identifier">new_parent_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:new_parent_id</span>]
<span class="line-num">379</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_parent_id</span>
<span class="line-num">380</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>( <span class="ruby-value">:no_new_parent_specified</span> )
<span class="line-num">381</span>     <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">382</span>     <span class="ruby-keyword">return</span>
<span class="line-num">383</span>   <span class="ruby-keyword">end</span>
<span class="line-num">384</span>   <span class="ruby-ivar">@results</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">clash_analysis</span>( <span class="ruby-identifier">new_parent_id</span> )
<span class="line-num">385</span>   <span class="ruby-ivar">@results</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">|</span>
<span class="line-num">386</span>     <span class="ruby-identifier">result</span>[<span class="ruby-value">:child</span>] = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>
<span class="line-num">387</span>     <span class="ruby-identifier">result</span>[<span class="ruby-value">:old_parent</span>] = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">:parent_id</span>] ).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">name</span>
<span class="line-num">388</span>     <span class="ruby-identifier">result</span>[<span class="ruby-value">:new_parent</span>] = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">new_parent_id</span> ).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">name</span>
<span class="line-num">389</span>   <span class="ruby-keyword">end</span>
<span class="line-num">390</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">format</span> <span class="ruby-operator">|</span>
<span class="line-num">391</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">392</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;clashes.html.haml&quot;</span>, <span class="ruby-value">locals:</span> { <span class="ruby-value">results:</span> <span class="ruby-ivar">@results</span> }
<span class="line-num">393</span>     <span class="ruby-keyword">end</span>
<span class="line-num">394</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">395</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@results</span>.<span class="ruby-identifier">to_json</span>( <span class="ruby-value">methods:</span> [<span class="ruby-value">:html</span>] )
<span class="line-num">396</span>     <span class="ruby-keyword">end</span>
<span class="line-num">397</span>   <span class="ruby-keyword">end</span>
<span class="line-num">398</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-create">
            
              <b>create</b>()
            
            <a href="../classes/TaxaController.html#method-i-create" name="method-i-create" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-create_source')" id="l_method-i-create_source">show</a>
                

                

                
              </p>
              <div id="method-i-create_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">292</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create</span>
<span class="line-num">293</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">new</span>
<span class="line-num">294</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">presave</span>
<span class="line-num">295</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>]
<span class="line-num">296</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">creator</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">297</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">298</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">save</span>
<span class="line-num">299</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:taxon_was_successfully_created</span>)
<span class="line-num">300</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">locked_ancestor</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">is_locked</span>.<span class="ruby-identifier">first</span>
<span class="line-num">301</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; Heads up: you just added a descendant of a &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">302</span>         <span class="ruby-node">&quot;locked taxon (&lt;a href=&#39;/taxa/#{locked_ancestor.id}&#39;&gt;&quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">303</span>         <span class="ruby-node">&quot;#{locked_ancestor.name}&lt;/a&gt;).  Please consider merging this &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">304</span>         <span class="ruby-string">&quot;into an existing taxon instead.&quot;</span>
<span class="line-num">305</span>     <span class="ruby-keyword">end</span>
<span class="line-num">306</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">parent</span>
<span class="line-num">307</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">is_active</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_active</span> <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">taxon_change</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">taxon_changes</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;committed_on IS NULL&quot;</span> ).<span class="ruby-identifier">first</span> )
<span class="line-num">308</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; Heads up: the parent of this active taxon is inactive &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">309</span>           <span class="ruby-node">&quot;but its the output of this &lt;a href=&#39;/taxon_changes/#{taxon_change.id}&#39;&gt;&quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">310</span>           <span class="ruby-string">&quot;draft taxon change&lt;/a&gt; that we assume you&#39;ll commit shortly.&quot;</span>
<span class="line-num">311</span>       <span class="ruby-keyword">end</span>
<span class="line-num">312</span>     <span class="ruby-keyword">end</span>
<span class="line-num">313</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;show&#39;</span>, <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">314</span>   <span class="ruby-keyword">else</span>
<span class="line-num">315</span>     <span class="ruby-ivar">@protected_attributes_editable</span> = <span class="ruby-keyword">true</span>
<span class="line-num">316</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;new&#39;</span>
<span class="line-num">317</span>   <span class="ruby-keyword">end</span>
<span class="line-num">318</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-curation">
            
              <b>curation</b>()
            
            <a href="../classes/TaxaController.html#method-i-curation" name="method-i-curation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-curation_source')" id="l_method-i-curation_source">show</a>
                

                

                
              </p>
              <div id="method-i-curation_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1299</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">curation</span>
<span class="line-num">1300</span>   <span class="ruby-ivar">@flags</span> = <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">resolved:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">flaggable_type:</span> <span class="ruby-string">&quot;Taxon&quot;</span>).
<span class="line-num">1301</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>).
<span class="line-num">1302</span>     <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).
<span class="line-num">1303</span>     <span class="ruby-identifier">order</span>(<span class="ruby-value">id:</span> <span class="ruby-value">:desc</span>)
<span class="line-num">1304</span>   <span class="ruby-ivar">@resolved_flags</span> = <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">resolved:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">flaggable_type:</span> <span class="ruby-string">&quot;Taxon&quot;</span>).
<span class="line-num">1305</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>, <span class="ruby-value">:resolver</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id desc&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">1306</span>   <span class="ruby-identifier">life</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-string">&#39;Life&#39;</span>)
<span class="line-num">1307</span>   <span class="ruby-ivar">@ungrafted</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">roots</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id != ?&quot;</span>, <span class="ruby-identifier">life</span>).
<span class="line-num">1308</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>).
<span class="line-num">1309</span>     <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">100</span>)
<span class="line-num">1310</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-describe">
            
              <b>describe</b>()
            
            <a href="../classes/TaxaController.html#method-i-describe" name="method-i-describe" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-describe_source')" id="l_method-i-describe_source">show</a>
                

                

                
              </p>
              <div id="method-i-describe_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1033</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">describe</span>
<span class="line-num">1034</span>   <span class="ruby-ivar">@describers</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">taxon_describers</span>
<span class="line-num">1035</span>     <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">taxon_describers</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-constant">TaxonDescribers</span>.<span class="ruby-identifier">get_describer</span>(<span class="ruby-identifier">d</span>)}.<span class="ruby-identifier">compact</span>
<span class="line-num">1036</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">iconic_taxon_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Amphibia&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">species_or_lower?</span>
<span class="line-num">1037</span>     [
<span class="line-num">1038</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Wikipedia</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> ),
<span class="line-num">1039</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">AmphibiaWeb</span>,
<span class="line-num">1040</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Eol</span>,
<span class="line-num">1041</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Inaturalist</span>
<span class="line-num">1042</span>     ]
<span class="line-num">1043</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1044</span>     [
<span class="line-num">1045</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Wikipedia</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> ),
<span class="line-num">1046</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Eol</span>,
<span class="line-num">1047</span>       <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Inaturalist</span>
<span class="line-num">1048</span>     ]
<span class="line-num">1049</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1050</span>   <span class="ruby-comment"># Perform caching here as opposed to caches_action so we can set request headers appropriately</span>
<span class="line-num">1051</span>   <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;views/taxa/#{@taxon.id}/description?#{request.query_parameters.merge( locale: I18n.locale ).to_a.join{|k,v| &quot;#{k}=#{v}&quot;}}&amp;v2&quot;</span>
<span class="line-num">1052</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">cached_description</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">read</span>( <span class="ruby-identifier">key</span> )
<span class="line-num">1053</span>     <span class="ruby-ivar">@description</span> = <span class="ruby-identifier">cached_description</span>[<span class="ruby-value">:description</span>]
<span class="line-num">1054</span>     <span class="ruby-ivar">@describer_url</span> = <span class="ruby-identifier">cached_description</span>[<span class="ruby-value">:url</span>]
<span class="line-num">1055</span>     <span class="ruby-ivar">@describer</span> = <span class="ruby-constant">TaxonDescribers</span>.<span class="ruby-identifier">get_describer</span>( <span class="ruby-identifier">cached_description</span>[<span class="ruby-value">:describer</span>] )&amp;.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">1056</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1057</span>   <span class="ruby-comment"># We only need to fetch new data for logged in users and when the cache is empty</span>
<span class="line-num">1058</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@description</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1059</span>     <span class="ruby-comment"># Fall back to English wikipedia as a last resort unless the default</span>
<span class="line-num">1060</span>     <span class="ruby-comment"># Wikipedia describer is already in English</span>
<span class="line-num">1061</span>     <span class="ruby-keyword">if</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp">/^en/</span>
<span class="line-num">1062</span>       <span class="ruby-ivar">@describers</span>.<span class="ruby-identifier">insert</span>( <span class="ruby-value">-2</span>, <span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Wikipedia</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-value">:en</span> ) )
<span class="line-num">1063</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1064</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">auto_description?</span>
<span class="line-num">1065</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">describer_klass</span> = <span class="ruby-constant">TaxonDescribers</span>.<span class="ruby-identifier">get_describer</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:from</span>])
<span class="line-num">1066</span>         <span class="ruby-ivar">@describer</span> = <span class="ruby-identifier">describer_klass</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">locale:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> )
<span class="line-num">1067</span>         <span class="ruby-ivar">@description</span> = <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">describe</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">1068</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1069</span>         <span class="ruby-ivar">@describers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
<span class="line-num">1070</span>           <span class="ruby-ivar">@describer</span> = <span class="ruby-identifier">d</span>
<span class="line-num">1071</span>           <span class="ruby-ivar">@description</span> = <span class="ruby-keyword">begin</span>
<span class="line-num">1072</span>             <span class="ruby-identifier">d</span>.<span class="ruby-identifier">describe</span>(<span class="ruby-ivar">@taxon</span>)
<span class="line-num">1073</span>           <span class="ruby-keyword">rescue</span> <span class="ruby-constant">OpenURI</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPError</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1074</span>             <span class="ruby-keyword">nil</span>
<span class="line-num">1075</span>           <span class="ruby-keyword">end</span>
<span class="line-num">1076</span>           <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@description</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1077</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1078</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1079</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@describers</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">TaxonDescribers</span><span class="ruby-operator">::</span><span class="ruby-constant">Wikipedia</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">wikipedia_summary</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1080</span>         <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">wikipedia_summary</span>( <span class="ruby-value">refresh_if_blank:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1081</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1082</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1083</span>       <span class="ruby-ivar">@describer</span> = <span class="ruby-ivar">@describers</span>.<span class="ruby-identifier">first</span>
<span class="line-num">1084</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1085</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@describer</span>
<span class="line-num">1086</span>       <span class="ruby-ivar">@describer_url</span> = <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">page_url</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">1087</span>       <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Describer-Name&quot;</span>] = <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">describer_name</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;::&quot;</span> ).<span class="ruby-identifier">last</span>
<span class="line-num">1088</span>       <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Describer-URL&quot;</span>] = <span class="ruby-ivar">@describer_url</span>
<span class="line-num">1089</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1090</span>     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@description</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">logged_in?</span>
<span class="line-num">1091</span>       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">key</span>, {
<span class="line-num">1092</span>         <span class="ruby-value">description:</span> <span class="ruby-ivar">@description</span>,
<span class="line-num">1093</span>         <span class="ruby-value">describer:</span>  <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">describer_name</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;::&quot;</span> ).<span class="ruby-identifier">last</span>,
<span class="line-num">1094</span>         <span class="ruby-value">url:</span> <span class="ruby-ivar">@describer_url</span>
<span class="line-num">1095</span>       }, <span class="ruby-value">expires_in:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> )
<span class="line-num">1096</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1097</span>   <span class="ruby-comment"># If we have cached content and a cached describer name, set the response headers</span>
<span class="line-num">1098</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@description</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@describer</span>
<span class="line-num">1099</span>     <span class="ruby-ivar">@describer_url</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">page_url</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">1100</span>     <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Describer-Name&quot;</span>] = <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">describer_name</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@describer</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;::&quot;</span> ).<span class="ruby-identifier">last</span>
<span class="line-num">1101</span>     <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;X-Describer-URL&quot;</span>] = <span class="ruby-ivar">@describer_url</span>
<span class="line-num">1102</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1103</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1104</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;description&quot;</span> }
<span class="line-num">1105</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1106</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy">
            
              <b>destroy</b>()
            
            <a href="../classes/TaxaController.html#method-i-destroy" name="method-i-destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_source')" id="l_method-i-destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">358</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
<span class="line-num">359</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">deleteable_by?</span>(<span class="ruby-identifier">current_user</span>)
<span class="line-num">360</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">creator_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">361</span>       <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_can_only_destroy_taxa_you_created</span>)
<span class="line-num">362</span>     <span class="ruby-keyword">else</span>
<span class="line-num">363</span>       <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_cannot_delete_taxa_involved_in_taxon_changes</span>)
<span class="line-num">364</span>     <span class="ruby-keyword">end</span>
<span class="line-num">365</span>     <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">366</span>     <span class="ruby-keyword">return</span>
<span class="line-num">367</span>   <span class="ruby-keyword">end</span>
<span class="line-num">368</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">369</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:taxon_deleted</span>)
<span class="line-num">370</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;index&#39;</span>
<span class="line-num">371</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit">
            
              <b>edit</b>()
            
            <a href="../classes/TaxaController.html#method-i-edit" name="method-i-edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_source')" id="l_method-i-edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">320</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit</span>
<span class="line-num">321</span>   <span class="ruby-ivar">@observations_exist</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">observations_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">322</span>   <span class="ruby-ivar">@listed_taxa_exist</span> = <span class="ruby-constant">ListedTaxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">taxon_id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">any?</span>
<span class="line-num">323</span>   <span class="ruby-ivar">@identifications_exist</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">324</span>     <span class="ruby-value">filters:</span> [{ <span class="ruby-value">term:</span> { <span class="ruby-string">&quot;taxon.id&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> } } ],
<span class="line-num">325</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>
<span class="line-num">326</span>   ).<span class="ruby-identifier">total_entries</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">327</span>   <span class="ruby-ivar">@descendants_exist</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">descendants</span>.<span class="ruby-identifier">exists?</span>
<span class="line-num">328</span>   <span class="ruby-ivar">@taxon_range</span> = <span class="ruby-constant">TaxonRange</span>.<span class="ruby-identifier">without_geom</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">taxon_id:</span> <span class="ruby-ivar">@taxon</span>).<span class="ruby-identifier">first</span>
<span class="line-num">329</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@protected_attributes_editable</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">protected_attributes_editable_by?</span>( <span class="ruby-identifier">current_user</span> )
<span class="line-num">330</span>     <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;This active taxon has more than #{Taxon::NUM_OBSERVATIONS_REQUIRING_CURATOR_TO_EDIT} downstream observations or is covered by a taxon framework, so some taxonomic attributes can only be editable by staff or taxon curators associated with that taxon framework.&quot;</span>
<span class="line-num">331</span>   <span class="ruby-keyword">end</span>
<span class="line-num">332</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flickr_photos_tagged">
            
              <b>flickr_photos_tagged</b>()
            
            <a href="../classes/TaxaController.html#method-i-flickr_photos_tagged" name="method-i-flickr_photos_tagged" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flickr_photos_tagged_source')" id="l_method-i-flickr_photos_tagged_source">show</a>
                

                

                
              </p>
              <div id="method-i-flickr_photos_tagged_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1438</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flickr_photos_tagged</span>
<span class="line-num">1439</span>   <span class="ruby-identifier">flickr</span> = <span class="ruby-identifier">get_flickraw</span>
<span class="line-num">1440</span>   
<span class="line-num">1441</span>   <span class="ruby-ivar">@tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tags</span>]
<span class="line-num">1442</span>   
<span class="line-num">1443</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1444</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:no_flickr_photos_tagged</span>)
<span class="line-num">1445</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;flickr_tagger&quot;</span>
<span class="line-num">1446</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1447</span>   
<span class="line-num">1448</span>   <span class="ruby-ivar">@flickr_photos</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">flickr_photo_id</span><span class="ruby-operator">|</span>
<span class="line-num">1449</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">1450</span>       <span class="ruby-identifier">fp</span> = <span class="ruby-identifier">flickr</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">getInfo</span>(<span class="ruby-value">:photo_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">flickr_photo_id</span>)
<span class="line-num">1451</span>       <span class="ruby-constant">FlickrPhoto</span>.<span class="ruby-identifier">new_from_flickraw</span>(<span class="ruby-identifier">fp</span>, <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">1452</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">FlickRaw</span><span class="ruby-operator">::</span><span class="ruby-constant">FailedResponse</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1453</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">1454</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1455</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1456</span> 
<span class="line-num">1457</span>   
<span class="line-num">1458</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:photos</span>).
<span class="line-num">1459</span>     <span class="ruby-identifier">where</span>(<span class="ruby-value">photos:</span> { <span class="ruby-value">native_photo_id:</span> <span class="ruby-ivar">@flickr_photos</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:native_photo_id</span>), <span class="ruby-value">subtype:</span> <span class="ruby-constant">FlickrPhoto</span>.<span class="ruby-identifier">to_s</span> })
<span class="line-num">1460</span>   <span class="ruby-ivar">@observations_by_native_photo_id</span> = {}
<span class="line-num">1461</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">observation</span><span class="ruby-operator">|</span>
<span class="line-num">1462</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">flickr_photo</span><span class="ruby-operator">|</span>
<span class="line-num">1463</span>       <span class="ruby-ivar">@observations_by_native_photo_id</span>[<span class="ruby-identifier">flickr_photo</span>.<span class="ruby-identifier">native_photo_id</span>] = <span class="ruby-identifier">observation</span>
<span class="line-num">1464</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1465</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1466</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-flickr_tagger">
            
              <b>flickr_tagger</b>()
            
            <a href="../classes/TaxaController.html#method-i-flickr_tagger" name="method-i-flickr_tagger" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-flickr_tagger_source')" id="l_method-i-flickr_tagger_source">show</a>
                

                

                
              </p>
              <div id="method-i-flickr_tagger_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1334</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flickr_tagger</span>    
<span class="line-num">1335</span>   <span class="ruby-identifier">f</span> = <span class="ruby-identifier">get_flickraw</span>
<span class="line-num">1336</span>   
<span class="line-num">1337</span>   <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]
<span class="line-num">1338</span>   <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>]
<span class="line-num">1339</span>   
<span class="line-num">1340</span>   <span class="ruby-ivar">@flickr_photo_ids</span> = [<span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photo_id</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>]].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1341</span>   <span class="ruby-ivar">@flickr_photos</span> = <span class="ruby-ivar">@flickr_photo_ids</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">flickr_photo_id</span><span class="ruby-operator">|</span>
<span class="line-num">1342</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">1343</span>       <span class="ruby-identifier">original</span> = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">getInfo</span>(<span class="ruby-value">:photo_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">flickr_photo_id</span>)
<span class="line-num">1344</span>       <span class="ruby-identifier">flickr_photo</span> = <span class="ruby-constant">FlickrPhoto</span>.<span class="ruby-identifier">new_from_api_response</span>(<span class="ruby-identifier">original</span>)
<span class="line-num">1345</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">flickr_photo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1346</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span> = <span class="ruby-identifier">flickr_photo</span>.<span class="ruby-identifier">to_taxa</span>
<span class="line-num">1347</span>           <span class="ruby-ivar">@taxon</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">ancestry</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>}.<span class="ruby-identifier">last</span>
<span class="line-num">1348</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1349</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1350</span>       <span class="ruby-identifier">flickr_photo</span>
<span class="line-num">1351</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">FlickRaw</span><span class="ruby-operator">::</span><span class="ruby-constant">FailedResponse</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1352</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_one_of_those_flickr_photos_either_doesnt_exist_or</span>)
<span class="line-num">1353</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">1354</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1355</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">1356</span>   
<span class="line-num">1357</span>   <span class="ruby-ivar">@tags</span> = <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">to_tags</span> <span class="ruby-operator">:</span> []
<span class="line-num">1358</span>   
<span class="line-num">1359</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1360</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1361</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@tags</span>}
<span class="line-num">1362</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1363</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graft">
            
              <b>graft</b>()
            
            <a href="../classes/TaxaController.html#method-i-graft" name="method-i-graft" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graft_source')" id="l_method-i-graft_source">show</a>
                

                

                
              </p>
              <div id="method-i-graft_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1162</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graft</span>
<span class="line-num">1163</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1164</span>     <span class="ruby-identifier">lineage</span> = <span class="ruby-identifier">ratatosk</span>.<span class="ruby-identifier">graft</span>(<span class="ruby-ivar">@taxon</span>)
<span class="line-num">1165</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1166</span>     <span class="ruby-ivar">@error_message</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">1167</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RatatoskGraftError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1168</span>     <span class="ruby-ivar">@error_message</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">1169</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1170</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">1171</span>   <span class="ruby-ivar">@error_message</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;Graft failed. Please graft manually by editing the taxon.&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">grafted?</span>
<span class="line-num">1172</span>   
<span class="line-num">1173</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1174</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1175</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-ivar">@error_message</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@error_message</span>
<span class="line-num">1176</span>       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">edit_taxon_path</span>(<span class="ruby-ivar">@taxon</span>))
<span class="line-num">1177</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1178</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> <span class="ruby-keyword">do</span>
<span class="line-num">1179</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@error_message</span>
<span class="line-num">1180</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@error_message</span>
<span class="line-num">1181</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1182</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;Taxon grafted to #{@taxon.parent.name}&quot;</span>
<span class="line-num">1183</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1184</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1185</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1186</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@error_message</span>
<span class="line-num">1187</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@error_message</span>}
<span class="line-num">1188</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1189</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:msg</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;Taxon grafted to #{@taxon.parent.name}&quot;</span>}
<span class="line-num">1190</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1191</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1192</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1193</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-history">
            
              <b>history</b>()
            
            <a href="../classes/TaxaController.html#method-i-history" name="method-i-history" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-history_source')" id="l_method-i-history_source">show</a>
                

                

                
              </p>
              <div id="method-i-history_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1195</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">history</span>
<span class="line-num">1196</span>   <span class="ruby-ivar">@record</span> = <span class="ruby-ivar">@taxon</span>
<span class="line-num">1197</span>   <span class="ruby-identifier">audit_scope</span> = <span class="ruby-constant">Audited</span><span class="ruby-operator">::</span><span class="ruby-constant">Audit</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">auditable_type:</span> <span class="ruby-string">&quot;Taxon&quot;</span>, <span class="ruby-value">auditable_id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">or</span>(
<span class="line-num">1198</span>     <span class="ruby-constant">Audited</span><span class="ruby-operator">::</span><span class="ruby-constant">Audit</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">associated_type:</span> <span class="ruby-string">&quot;Taxon&quot;</span>, <span class="ruby-value">associated_id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1199</span>   )
<span class="line-num">1200</span>   <span class="ruby-identifier">audited_types</span> = <span class="ruby-node">%w(Taxon TaxonName PlaceTaxonName ConservationStatus)</span>
<span class="line-num">1201</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">audited_types</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_type</span>] ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-ivar">@auditable_type</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_type</span>] )
<span class="line-num">1202</span>     <span class="ruby-identifier">audit_scope</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">auditable_type:</span> <span class="ruby-ivar">@auditable_type</span> )
<span class="line-num">1203</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1204</span>   <span class="ruby-keyword">if</span> (
<span class="line-num">1205</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1206</span>       <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_id</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_id</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1207</span>       ( <span class="ruby-ivar">@auditable_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:auditable_id</span>] )
<span class="line-num">1208</span>   )
<span class="line-num">1209</span>     <span class="ruby-identifier">audit_scope</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">auditable_id:</span> <span class="ruby-ivar">@auditable_id</span> )
<span class="line-num">1210</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1211</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@user_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>] )
<span class="line-num">1212</span>     <span class="ruby-identifier">audit_scope</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@user_id</span> )
<span class="line-num">1213</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1214</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@audit_action</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:audit_action</span>] )
<span class="line-num">1215</span>     <span class="ruby-identifier">audit_scope</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">action:</span> <span class="ruby-ivar">@audit_action</span> )
<span class="line-num">1216</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1217</span>   <span class="ruby-ivar">@audit_days</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;audits.created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:first</span>).<span class="ruby-identifier">reverse</span>
<span class="line-num">1218</span>   <span class="ruby-ivar">@date</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:year</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1219</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:month</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1220</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:day</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">1221</span>     ( <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{params[:year]}-#{params[:month]}-#{params[:day]}&quot;</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span> )
<span class="line-num">1222</span>   <span class="ruby-comment"># At this point @audit_days is an array of arrays with the first elt of</span>
<span class="line-num">1223</span>   <span class="ruby-comment"># each being a date sorted in descending order, so &amp;.first&amp;.first should</span>
<span class="line-num">1224</span>   <span class="ruby-comment"># be the most recent date</span>
<span class="line-num">1225</span>   <span class="ruby-ivar">@date</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@audit_days</span>&amp;.<span class="ruby-identifier">first</span>&amp;.<span class="ruby-identifier">first</span>
<span class="line-num">1226</span>   <span class="ruby-ivar">@show_all</span> = <span class="ruby-ivar">@date</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">500</span>
<span class="line-num">1227</span>   <span class="ruby-ivar">@audits</span> = <span class="ruby-identifier">audit_scope</span>.<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;created_at desc&quot;</span> )
<span class="line-num">1228</span>   <span class="ruby-ivar">@audits</span> = <span class="ruby-ivar">@audits</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at::date = ?&quot;</span>, <span class="ruby-ivar">@date</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@show_all</span>
<span class="line-num">1229</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap-container&quot;</span>
<span class="line-num">1230</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index">
            
              <b>index</b>()
            
            <a href="../classes/TaxaController.html#method-i-index" name="method-i-index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>GET /observations GET /observations.xml</p>

<p>@param name: Return all taxa where name is an EXACT match @param q:    Return all taxa where the name begins with q</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_source')" id="l_method-i-index_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num"> 66</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
<span class="line-num"> 67</span>   <span class="ruby-identifier">find_taxa</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">html?</span>
<span class="line-num"> 68</span>   
<span class="line-num"> 69</span>   <span class="ruby-keyword">begin</span>
<span class="line-num"> 70</span>     <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">try</span>( <span class="ruby-value">:total_entries</span> )
<span class="line-num"> 71</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num"> 72</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR] Taxon index failed: #{e}&quot;</span>
<span class="line-num"> 73</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">WillPaginate</span><span class="ruby-operator">::</span><span class="ruby-constant">Collection</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">1</span>, <span class="ruby-value">30</span>, <span class="ruby-value">0</span>)
<span class="line-num"> 74</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 75</span>   
<span class="line-num"> 76</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 77</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span> <span class="ruby-comment"># index.html.erb</span>
<span class="line-num"> 78</span>       <span class="ruby-ivar">@site_place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>
<span class="line-num"> 79</span>       <span class="ruby-ivar">@featured_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa.featured_at IS NOT NULL&quot;</span>).
<span class="line-num"> 80</span>         <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;taxa.featured_at DESC&quot;</span>).
<span class="line-num"> 81</span>         <span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num"> 82</span>       <span class="ruby-ivar">@featured_taxa</span> = <span class="ruby-ivar">@featured_taxa</span>.<span class="ruby-identifier">from_place</span>(<span class="ruby-ivar">@site_place</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site_place</span>
<span class="line-num"> 83</span>       
<span class="line-num"> 84</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@featured_taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 85</span>         <span class="ruby-ivar">@featured_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:photos</span>).<span class="ruby-identifier">where</span>(
<span class="line-num"> 86</span>           <span class="ruby-string">&quot;taxa.wikipedia_summary IS NOT NULL AND &quot;</span> <span class="ruby-operator">+</span>
<span class="line-num"> 87</span>           <span class="ruby-string">&quot;photos.id IS NOT NULL AND &quot;</span> <span class="ruby-operator">+</span>
<span class="line-num"> 88</span>           <span class="ruby-string">&quot;taxa.observations_count &gt; 1&quot;</span>
<span class="line-num"> 89</span>         ).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;taxa.id DESC&quot;</span>)
<span class="line-num"> 90</span>         <span class="ruby-ivar">@featured_taxa</span> = <span class="ruby-ivar">@featured_taxa</span>.<span class="ruby-identifier">from_place</span>(<span class="ruby-ivar">@site_place</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site_place</span>
<span class="line-num"> 91</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 92</span>       
<span class="line-num"> 93</span>       <span class="ruby-comment"># Shuffle the taxa (http://snippets.dzone.com/posts/show/2994)</span>
<span class="line-num"> 94</span>       <span class="ruby-ivar">@featured_taxa</span> = <span class="ruby-ivar">@featured_taxa</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-identifier">rand</span>}[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">10</span>]
<span class="line-num"> 95</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@featured_taxa</span>, [
<span class="line-num"> 96</span>         <span class="ruby-value">:iconic_taxon</span>, <span class="ruby-value">:photos</span>, <span class="ruby-value">:taxon_descriptions</span>,
<span class="line-num"> 97</span>         { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> } ])
<span class="line-num"> 98</span>       <span class="ruby-ivar">@featured_taxa_obs</span> = <span class="ruby-ivar">@featured_taxa</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">taxon</span><span class="ruby-operator">|</span>
<span class="line-num"> 99</span>         <span class="ruby-identifier">taxon_obs_params</span> = { <span class="ruby-value">taxon_id:</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">1</span> }
<span class="line-num">100</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>
<span class="line-num">101</span>           <span class="ruby-identifier">taxon_obs_params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">102</span>         <span class="ruby-keyword">end</span>
<span class="line-num">103</span>         <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>(<span class="ruby-identifier">taxon_obs_params</span>).<span class="ruby-identifier">first</span>
<span class="line-num">104</span>       <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">taxon</span>}
<span class="line-num">105</span>       <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@featured_taxa_obs</span>, [<span class="ruby-value">:user</span>, <span class="ruby-value">:taxon</span>])
<span class="line-num">106</span>       
<span class="line-num">107</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-ivar">@status</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@status</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">108</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>]
<span class="line-num">109</span>         <span class="ruby-identifier">find_taxa</span>
<span class="line-num">110</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:search</span>
<span class="line-num">111</span>       <span class="ruby-keyword">else</span>
<span class="line-num">112</span>         <span class="ruby-ivar">@iconic_taxa</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>
<span class="line-num">113</span>         <span class="ruby-identifier">recent_params</span> = { <span class="ruby-value">d1:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>,
<span class="line-num">114</span>           <span class="ruby-value">quality_grade:</span> <span class="ruby-value">:research</span>, <span class="ruby-value">order_by:</span> <span class="ruby-value">:observed_on</span> }
<span class="line-num">115</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>
<span class="line-num">116</span>           <span class="ruby-identifier">recent_params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span>
<span class="line-num">117</span>         <span class="ruby-keyword">end</span>
<span class="line-num">118</span>         <span class="ruby-comment"># group by taxon ID and get the first obs of each taxon</span>
<span class="line-num">119</span>         <span class="ruby-ivar">@recent</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>(<span class="ruby-identifier">recent_params</span>).
<span class="line-num">120</span>           <span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon_id</span>).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">first</span> }[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">5</span>]
<span class="line-num">121</span>         <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@recent</span>,{
<span class="line-num">122</span>           <span class="ruby-value">taxon:</span> [ { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> }, <span class="ruby-value">:photos</span> ] } )
<span class="line-num">123</span>         <span class="ruby-ivar">@recent</span> = <span class="ruby-ivar">@recent</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>).<span class="ruby-identifier">reverse</span>
<span class="line-num">124</span>       <span class="ruby-keyword">end</span>
<span class="line-num">125</span>     <span class="ruby-keyword">end</span>
<span class="line-num">126</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  <span class="ruby-keyword">do</span>
<span class="line-num">127</span>       <span class="ruby-identifier">render</span>(<span class="ruby-value">:xml</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_xml</span>(<span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:common_name</span>]))
<span class="line-num">128</span>     <span class="ruby-keyword">end</span>
<span class="line-num">129</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">130</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:names</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">131</span>         <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>
<span class="line-num">132</span>       <span class="ruby-keyword">end</span>
<span class="line-num">133</span>       <span class="ruby-identifier">pagination_headers_for</span> <span class="ruby-ivar">@taxa</span>
<span class="line-num">134</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxa</span>, [
<span class="line-num">135</span>         { <span class="ruby-value">taxon_photos:</span> { <span class="ruby-value">photo:</span> <span class="ruby-value">:user</span> } }, <span class="ruby-value">:taxon_descriptions</span>,
<span class="line-num">136</span>         { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> }, <span class="ruby-value">:iconic_taxon</span> ] )
<span class="line-num">137</span>       <span class="ruby-identifier">options</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">138</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">merge!</span>(
<span class="line-num">139</span>         <span class="ruby-value">:iconic_taxon</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>]},
<span class="line-num">140</span>         <span class="ruby-value">:taxon_names</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:lexicon</span>]}
<span class="line-num">141</span>       )
<span class="line-num">142</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:common_name</span>, <span class="ruby-value">:image_url</span>, <span class="ruby-value">:default_name</span>]
<span class="line-num">143</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">options</span>)
<span class="line-num">144</span>     <span class="ruby-keyword">end</span>
<span class="line-num">145</span>   <span class="ruby-keyword">end</span>
<span class="line-num">146</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-links">
            
              <b>links</b>()
            
            <a href="../classes/TaxaController.html#method-i-links" name="method-i-links" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-links_source')" id="l_method-i-links_source">show</a>
                

                

                
              </p>
              <div id="method-i-links_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1108</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">links</span>
<span class="line-num">1109</span>   <span class="ruby-identifier">places_exist</span> = <span class="ruby-constant">ListedTaxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;place_id IS NOT NULL AND taxon_id = ?&quot;</span>, <span class="ruby-ivar">@taxon</span> ).<span class="ruby-identifier">exists?</span>
<span class="line-num">1110</span>   <span class="ruby-identifier">place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_id</span>] )
<span class="line-num">1111</span>   <span class="ruby-identifier">taxon_links</span> = <span class="ruby-constant">TaxonLink</span>.<span class="ruby-identifier">by_taxon</span>( <span class="ruby-ivar">@taxon</span>, <span class="ruby-value">reject_places:</span> <span class="ruby-operator">!</span><span class="ruby-identifier">places_exist</span>, <span class="ruby-value">place:</span> <span class="ruby-identifier">place</span> )
<span class="line-num">1112</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1113</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-identifier">taxon_links</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tl</span><span class="ruby-operator">|</span> {
<span class="line-num">1114</span>       <span class="ruby-value">taxon_link:</span> <span class="ruby-identifier">tl</span>,
<span class="line-num">1115</span>       <span class="ruby-value">url:</span> <span class="ruby-identifier">tl</span>.<span class="ruby-identifier">url_for_taxon</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">1116</span>     } } }
<span class="line-num">1117</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1118</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-map">
            
              <b>map</b>()
            
            <a href="../classes/TaxaController.html#method-i-map" name="method-i-map" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-map_source')" id="l_method-i-map_source">show</a>
                

                

                
              </p>
              <div id="method-i-map_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">739</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">map</span>
<span class="line-num">740</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">741</span>   <span class="ruby-identifier">taxon_ids</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxa</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
<span class="line-num">742</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxa</span>]
<span class="line-num">743</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxa</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num">744</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxa</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="line-num">745</span>   <span class="ruby-keyword">end</span>
<span class="line-num">746</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon_ids</span>
<span class="line-num">747</span>     <span class="ruby-ivar">@taxa</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">taxon_ids</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span> }).<span class="ruby-identifier">limit</span>(<span class="ruby-value">20</span>)
<span class="line-num">748</span>   <span class="ruby-keyword">end</span>
<span class="line-num">749</span>   <span class="ruby-identifier">render_404</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">750</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-map_layers">
            
              <b>map_layers</b>()
            
            <a href="../classes/TaxaController.html#method-i-map_layers" name="method-i-map_layers" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-map_layers_source')" id="l_method-i-map_layers_source">show</a>
                

                

                
              </p>
              <div id="method-i-map_layers_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">850</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">map_layers</span>
<span class="line-num">851</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> {
<span class="line-num">852</span>     <span class="ruby-value">id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">853</span>     <span class="ruby-value">ranges:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_range</span>.<span class="ruby-identifier">present?</span>,
<span class="line-num">854</span>     <span class="ruby-value">gbif_id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">get_gbif_id</span>,
<span class="line-num">855</span>     <span class="ruby-value">listed_places:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">listed_taxa</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">place:</span> <span class="ruby-value">:place_geometry</span>).<span class="ruby-identifier">exists?</span>
<span class="line-num">856</span>   }
<span class="line-num">857</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-merge">
            
              <b>merge</b>()
            
            <a href="../classes/TaxaController.html#method-i-merge" name="method-i-merge" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-merge_source')" id="l_method-i-merge_source">show</a>
                

                

                
              </p>
              <div id="method-i-merge_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1252</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">merge</span>
<span class="line-num">1253</span>   <span class="ruby-ivar">@keeper</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">1254</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@keeper</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@keeper</span>.<span class="ruby-identifier">mergeable_by?</span>(<span class="ruby-identifier">current_user</span>, <span class="ruby-ivar">@taxon</span>)
<span class="line-num">1255</span>     <span class="ruby-identifier">respond_to_merge_error</span>(<span class="ruby-string">&quot;The merge tool can only be used for taxa you created or exact synonyms&quot;</span>)
<span class="line-num">1256</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1257</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1258</span> 
<span class="line-num">1259</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@keeper</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@keeper</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1260</span>     <span class="ruby-identifier">respond_to_merge_error</span> <span class="ruby-node">&quot;Failed to merge taxon #{@taxon.id} (#{@taxon.name}) into taxon #{@keeper.id} (#{@keeper.name}).  You can&#39;t merge a taxon with itself.&quot;</span>
<span class="line-num">1261</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1262</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1263</span>   
<span class="line-num">1264</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@keeper</span>
<span class="line-num">1265</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@keeper_id</span>
<span class="line-num">1266</span>       <span class="ruby-identifier">respond_to_merge_error</span>(<span class="ruby-identifier">t</span>(<span class="ruby-value">:cant_merge_a_taxon_with_itself</span>))
<span class="line-num">1267</span>       <span class="ruby-keyword">return</span>
<span class="line-num">1268</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1269</span>     
<span class="line-num">1270</span>     <span class="ruby-ivar">@keeper</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-ivar">@taxon</span>)
<span class="line-num">1271</span> 
<span class="line-num">1272</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1273</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1274</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;#{@taxon.name} (#{@taxon.id}) merged into &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">1275</span>           <span class="ruby-node">&quot;#{@keeper.name} (#{@keeper.id}).  #{@taxon.name} (#{@taxon.id}) &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">1276</span>           <span class="ruby-string">&quot;has been deleted.&quot;</span>
<span class="line-num">1277</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-value">:return_to</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/#{@taxon.id}/</span>
<span class="line-num">1278</span>           <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@keeper</span>
<span class="line-num">1279</span>         <span class="ruby-keyword">else</span>
<span class="line-num">1280</span>           <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-ivar">@keeper</span>)
<span class="line-num">1281</span>         <span class="ruby-keyword">end</span>
<span class="line-num">1282</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1283</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@keeper</span> }
<span class="line-num">1284</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1285</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1286</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1287</span>   
<span class="line-num">1288</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1289</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">1290</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> <span class="ruby-keyword">do</span>
<span class="line-num">1291</span>       <span class="ruby-ivar">@taxon_change</span> = <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">input_taxon</span>(<span class="ruby-ivar">@taxon</span>).<span class="ruby-identifier">output_taxon</span>(<span class="ruby-ivar">@keeper</span>).<span class="ruby-identifier">first</span>
<span class="line-num">1292</span>       <span class="ruby-ivar">@taxon_change</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">input_taxon</span>(<span class="ruby-ivar">@keeper</span>).<span class="ruby-identifier">output_taxon</span>(<span class="ruby-ivar">@taxon</span>).<span class="ruby-identifier">first</span>
<span class="line-num">1293</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;taxa/merge&quot;</span>
<span class="line-num">1294</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1295</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@keeper</span> }
<span class="line-num">1296</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1297</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new">
            
              <b>new</b>()
            
            <a href="../classes/TaxaController.html#method-i-new" name="method-i-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_source')" id="l_method-i-new_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">287</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new</span>
<span class="line-num">288</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:name</span>] )
<span class="line-num">289</span>   <span class="ruby-ivar">@protected_attributes_editable</span> = <span class="ruby-keyword">true</span>
<span class="line-num">290</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-observation_photos">
            
              <b>observation_photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-observation_photos" name="method-i-observation_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-observation_photos_source')" id="l_method-i-observation_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-observation_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">770</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">observation_photos</span>
<span class="line-num">771</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>).<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_i</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">772</span>   <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>] )
<span class="line-num">773</span>   <span class="ruby-identifier">licensed</span> = <span class="ruby-node">%w(t any true)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:licensed</span>].<span class="ruby-identifier">to_s</span>)
<span class="line-num">774</span>   <span class="ruby-identifier">quality_grades</span> = <span class="ruby-node">%w(research needs_id)</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:quality_grade</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>( <span class="ruby-string">&quot;,&quot;</span> )
<span class="line-num">775</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">per_page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>]
<span class="line-num">776</span>     <span class="ruby-identifier">per_page</span> = <span class="ruby-identifier">per_page</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">50</span> <span class="ruby-operator">?</span> <span class="ruby-value">50</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">per_page</span>.<span class="ruby-identifier">to_i</span>
<span class="line-num">777</span>   <span class="ruby-keyword">end</span>
<span class="line-num">778</span>   <span class="ruby-identifier">observations</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">779</span>     <span class="ruby-identifier">obs</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">of</span>(<span class="ruby-ivar">@taxon</span>).
<span class="line-num">780</span>       <span class="ruby-identifier">joins</span>(<span class="ruby-value">:photos</span>).
<span class="line-num">781</span>       <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;photos.id IS NOT NULL AND photos.user_id IS NOT NULL AND photos.license IS NOT NULL&quot;</span>).
<span class="line-num">782</span>       <span class="ruby-identifier">paginate_with_count_over</span>(<span class="ruby-value">:page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], <span class="ruby-value">:per_page</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">per_page</span>)
<span class="line-num">783</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">licensed</span>
<span class="line-num">784</span>       <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;photos.license IS NOT NULL AND photos.license &gt; ? OR photos.user_id = ?&quot;</span>, <span class="ruby-constant">Photo</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT</span>, <span class="ruby-identifier">current_user</span>)
<span class="line-num">785</span>     <span class="ruby-keyword">end</span>
<span class="line-num">786</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quality_grades</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">787</span>       <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;quality_grade IN (?)&quot;</span>, <span class="ruby-identifier">quality_grades</span> )
<span class="line-num">788</span>     <span class="ruby-keyword">end</span>
<span class="line-num">789</span>     <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num">790</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">791</span>     <span class="ruby-comment"># Look up photos associated with a specific observation</span>
<span class="line-num">792</span>     <span class="ruby-identifier">obs</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>] )
<span class="line-num">793</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quality_grades</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">794</span>       <span class="ruby-identifier">obs</span> = <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;quality_grade IN (?)&quot;</span>, <span class="ruby-identifier">quality_grades</span> )
<span class="line-num">795</span>     <span class="ruby-keyword">end</span>
<span class="line-num">796</span>     <span class="ruby-identifier">obs</span>
<span class="line-num">797</span>   <span class="ruby-keyword">else</span>
<span class="line-num">798</span>     <span class="ruby-identifier">filters</span> = [ { <span class="ruby-value">exists:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;photos_count&quot;</span> } } ]
<span class="line-num">799</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">800</span>       <span class="ruby-identifier">searched_taxa</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">matching_taxon_ids</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>] )
<span class="line-num">801</span>       <span class="ruby-identifier">taxon_search_filter</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">searched_taxa</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-string">&quot;taxon.id&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">searched_taxa</span> } }
<span class="line-num">802</span>       <span class="ruby-identifier">match_filter</span> = {
<span class="line-num">803</span>         <span class="ruby-value">multi_match:</span> {
<span class="line-num">804</span>           <span class="ruby-value">query:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>],
<span class="line-num">805</span>           <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span>,
<span class="line-num">806</span>           <span class="ruby-value">fields:</span> [ <span class="ruby-value">:description</span>, <span class="ruby-string">&quot;user.login&quot;</span>, <span class="ruby-string">&quot;field_values.value&quot;</span> ]
<span class="line-num">807</span>         }
<span class="line-num">808</span>       }
<span class="line-num">809</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">match_filter</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">taxon_search_filter</span>
<span class="line-num">810</span>         <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">811</span>           <span class="ruby-value">bool:</span> {
<span class="line-num">812</span>             <span class="ruby-value">should:</span> [
<span class="line-num">813</span>               <span class="ruby-identifier">match_filter</span>,
<span class="line-num">814</span>               <span class="ruby-identifier">taxon_search_filter</span>
<span class="line-num">815</span>             ]
<span class="line-num">816</span>           }
<span class="line-num">817</span>         }
<span class="line-num">818</span>       <span class="ruby-keyword">else</span>
<span class="line-num">819</span>         <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">match_filter</span>
<span class="line-num">820</span>       <span class="ruby-keyword">end</span>
<span class="line-num">821</span>     <span class="ruby-keyword">end</span>
<span class="line-num">822</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quality_grades</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">823</span>       <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">824</span>         <span class="ruby-value">terms:</span> {
<span class="line-num">825</span>           <span class="ruby-value">quality_grade:</span> <span class="ruby-identifier">quality_grades</span>
<span class="line-num">826</span>         }
<span class="line-num">827</span>       }
<span class="line-num">828</span>     <span class="ruby-keyword">end</span>
<span class="line-num">829</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_paginate</span>(
<span class="line-num">830</span>       <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>,
<span class="line-num">831</span>       <span class="ruby-value">per_page:</span> <span class="ruby-identifier">per_page</span>,
<span class="line-num">832</span>       <span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>])
<span class="line-num">833</span>   <span class="ruby-keyword">end</span>
<span class="line-num">834</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">observations</span>, { <span class="ruby-value">photos:</span> <span class="ruby-value">:user</span> })
<span class="line-num">835</span>   <span class="ruby-ivar">@photos</span> = <span class="ruby-identifier">observations</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:photos</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">reject</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">blank?</span>}
<span class="line-num">836</span>   <span class="ruby-ivar">@photos</span> = <span class="ruby-ivar">@photos</span>.<span class="ruby-identifier">reject</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">license</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Photo</span><span class="ruby-operator">::</span><span class="ruby-constant">COPYRIGHT</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">licensed</span>
<span class="line-num">837</span>   <span class="ruby-identifier">partial</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>].<span class="ruby-identifier">to_s</span>
<span class="line-num">838</span>   <span class="ruby-identifier">partial</span> = <span class="ruby-string">&#39;photo_list_form&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-node">%w(photo_list_form bootstrap_photo_list_form)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">partial</span>)    
<span class="line-num">839</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">840</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">841</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">partial:</span> <span class="ruby-node">&quot;photos/#{partial}&quot;</span>, <span class="ruby-value">locals:</span> {
<span class="line-num">842</span>         <span class="ruby-value">photos:</span> <span class="ruby-ivar">@photos</span>, 
<span class="line-num">843</span>         <span class="ruby-value">index:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:index</span>],
<span class="line-num">844</span>         <span class="ruby-value">local_photos:</span> <span class="ruby-keyword">false</span> }
<span class="line-num">845</span>     <span class="ruby-keyword">end</span>
<span class="line-num">846</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@photos</span> }
<span class="line-num">847</span>   <span class="ruby-keyword">end</span>
<span class="line-num">848</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-occur_in">
            
              <b>occur_in</b>()
            
            <a href="../classes/TaxaController.html#method-i-occur_in" name="method-i-occur_in" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-occur_in_source')" id="l_method-i-occur_in_source">show</a>
                

                

                
              </p>
              <div id="method-i-occur_in_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">654</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">occur_in</span>
<span class="line-num">655</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">occurs_in</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:swlng</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:swlat</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:nelng</span>], 
<span class="line-num">656</span>                           <span class="ruby-identifier">params</span>[<span class="ruby-value">:nelat</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:startDate</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:endDate</span>])
<span class="line-num">657</span>   <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">sort!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> 
<span class="line-num">658</span>     (<span class="ruby-identifier">a</span>.<span class="ruby-identifier">common_name</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span>) <span class="ruby-operator">&lt;=&gt;</span> (<span class="ruby-identifier">b</span>.<span class="ruby-identifier">common_name</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">common_name</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">name</span>)
<span class="line-num">659</span>   <span class="ruby-keyword">end</span>
<span class="line-num">660</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">661</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">662</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">663</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">to_json</span>(
<span class="line-num">664</span>                <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:common_name</span>] )
<span class="line-num">665</span>     <span class="ruby-keyword">end</span>
<span class="line-num">666</span>   <span class="ruby-keyword">end</span>
<span class="line-num">667</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-photos">
            
              <b>photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-photos" name="method-i-photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-photos_source')" id="l_method-i-photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">694</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">photos</span>
<span class="line-num">695</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:limit</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">696</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-value">24</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">697</span>   <span class="ruby-identifier">limit</span> = <span class="ruby-value">50</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">50</span>
<span class="line-num">698</span>   
<span class="line-num">699</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">700</span>     <span class="ruby-ivar">@photos</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos_with_external_cache_key</span>) <span class="ruby-keyword">do</span>
<span class="line-num">701</span>       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos_with_backfill</span>(<span class="ruby-value">:limit</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">50</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fp</span><span class="ruby-operator">|</span>
<span class="line-num">702</span>         <span class="ruby-identifier">fp</span>.<span class="ruby-identifier">api_response</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">703</span>         <span class="ruby-identifier">fp</span>
<span class="line-num">704</span>       <span class="ruby-keyword">end</span>
<span class="line-num">705</span>     <span class="ruby-keyword">end</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">limit</span><span class="ruby-value">-1</span>)]
<span class="line-num">706</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">JSON</span><span class="ruby-operator">::</span><span class="ruby-constant">ParserError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">707</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR #{Time.now}] Flickr error: #{e}&quot;</span>
<span class="line-num">708</span>     <span class="ruby-ivar">@photos</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos</span>
<span class="line-num">709</span>   <span class="ruby-keyword">end</span>
<span class="line-num">710</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ALLOWED_PHOTO_PARTIALS</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] )
<span class="line-num">711</span>     <span class="ruby-identifier">key</span> = {<span class="ruby-value">:controller</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;taxa&#39;</span>, <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;photos&#39;</span>, <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]}
<span class="line-num">712</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-identifier">key</span>)
<span class="line-num">713</span>       <span class="ruby-identifier">content</span> = <span class="ruby-identifier">read_fragment</span>(<span class="ruby-identifier">key</span>)
<span class="line-num">714</span>     <span class="ruby-keyword">else</span>
<span class="line-num">715</span>       <span class="ruby-identifier">content</span> = <span class="ruby-keyword">if</span> <span class="ruby-ivar">@photos</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">716</span>         <span class="ruby-string">&#39;&lt;div class=&quot;description&quot;&gt;No matching photos.&lt;/div&gt;&#39;</span>
<span class="line-num">717</span>       <span class="ruby-keyword">else</span>
<span class="line-num">718</span>         <span class="ruby-identifier">render_to_string</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;taxa/#{params[:partial]}&quot;</span>, <span class="ruby-value">:collection</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@photos</span>
<span class="line-num">719</span>       <span class="ruby-keyword">end</span>
<span class="line-num">720</span>       <span class="ruby-identifier">write_fragment</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">content</span>)
<span class="line-num">721</span>     <span class="ruby-keyword">end</span>
<span class="line-num">722</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">content</span>
<span class="line-num">723</span>   <span class="ruby-keyword">else</span>
<span class="line-num">724</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;photos&quot;</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">725</span>       <span class="ruby-value">:photos</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@photos</span>
<span class="line-num">726</span>     }
<span class="line-num">727</span>   <span class="ruby-keyword">end</span>
<span class="line-num">728</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">SocketError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">729</span>   <span class="ruby-identifier">raise</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">development?</span>
<span class="line-num">730</span>   <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;[DEBUG] Looks like you&#39;re offline, skipping flickr&quot;</span>
<span class="line-num">731</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;You&#39;re offline.&quot;</span>
<span class="line-num">732</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-range">
            
              <b>range</b>()
            
            <a href="../classes/TaxaController.html#method-i-range" name="method-i-range" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-range_source')" id="l_method-i-range_source">show</a>
                

                

                
              </p>
              <div id="method-i-range_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">752</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">range</span>
<span class="line-num">753</span>   <span class="ruby-ivar">@taxon_range</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span> <span class="ruby-operator">==</span> <span class="ruby-value">:geojson</span>
<span class="line-num">754</span>     <span class="ruby-constant">TaxonRange</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">taxon_id:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">simplified</span>.<span class="ruby-identifier">first</span>
<span class="line-num">755</span>   <span class="ruby-keyword">else</span>
<span class="line-num">756</span>     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_range</span>
<span class="line-num">757</span>   <span class="ruby-keyword">end</span>
<span class="line-num">758</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon_range</span>
<span class="line-num">759</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:taxon_doesnt_have_a_range</span>)
<span class="line-num">760</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">761</span>     <span class="ruby-keyword">return</span>
<span class="line-num">762</span>   <span class="ruby-keyword">end</span>
<span class="line-num">763</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">764</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">taxon_range_path</span>( <span class="ruby-ivar">@taxon_range</span> ) }
<span class="line-num">765</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">kml</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@taxon_range</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">url</span> }
<span class="line-num">766</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">geojson</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-ivar">@taxon_range</span>].<span class="ruby-identifier">to_geojson</span> }
<span class="line-num">767</span>   <span class="ruby-keyword">end</span>
<span class="line-num">768</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-refresh_wikipedia_summary">
            
              <b>refresh_wikipedia_summary</b>()
            
            <a href="../classes/TaxaController.html#method-i-refresh_wikipedia_summary" name="method-i-refresh_wikipedia_summary" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-refresh_wikipedia_summary_source')" id="l_method-i-refresh_wikipedia_summary_source">show</a>
                

                

                
              </p>
              <div id="method-i-refresh_wikipedia_summary_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1120</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">refresh_wikipedia_summary</span>
<span class="line-num">1121</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1122</span>     <span class="ruby-identifier">summary</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">set_wikipedia_summary</span>(<span class="ruby-value">force_update:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">1123</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1124</span>     <span class="ruby-identifier">error_text</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">1125</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1126</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1127</span>     <span class="ruby-identifier">error_text</span> <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;Could&#39;t retrieve the Wikipedia &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">1128</span>       <span class="ruby-node">&quot;summary for #{@taxon.name}.  Make sure there is actually a &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">1129</span>       <span class="ruby-string">&quot;corresponding article on Wikipedia.&quot;</span>
<span class="line-num">1130</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">404</span>, <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">error_text</span>
<span class="line-num">1131</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1132</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:plain</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">summary</span>
<span class="line-num">1133</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1134</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-schemes">
            
              <b>schemes</b>()
            
            <a href="../classes/TaxaController.html#method-i-schemes" name="method-i-schemes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-schemes_source')" id="l_method-i-schemes_source">show</a>
                

                

                
              </p>
              <div id="method-i-schemes_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">734</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">schemes</span>
<span class="line-num">735</span>   <span class="ruby-ivar">@scheme_taxa</span> = <span class="ruby-constant">TaxonSchemeTaxon</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_name</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:taxon_id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">736</span>   <span class="ruby-identifier">respond_to</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span> <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>}
<span class="line-num">737</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-search">
            
              <b>search</b>()
            
            <a href="../classes/TaxaController.html#method-i-search" name="method-i-search" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>/taxa/browse?q=bird /taxa/browse?q=bird&amp;places=1,2 TODO: /taxa/browse?q=bird&amp;places=usa-ca-berkeley,usa-ct-clinton</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-search_source')" id="l_method-i-search_source">show</a>
                

                

                
              </p>
              <div id="method-i-search_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">403</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">search</span>
<span class="line-num">404</span>   <span class="ruby-ivar">@q</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sanitize_encoding</span>
<span class="line-num">405</span> 
<span class="line-num">406</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>]
<span class="line-num">407</span>     <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon_id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">408</span>   <span class="ruby-keyword">end</span>
<span class="line-num">409</span>   
<span class="line-num">410</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;true&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">411</span>     <span class="ruby-ivar">@is_active</span> = <span class="ruby-keyword">true</span>
<span class="line-num">412</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
<span class="line-num">413</span>     <span class="ruby-ivar">@is_active</span> = <span class="ruby-keyword">false</span>
<span class="line-num">414</span>   <span class="ruby-keyword">else</span>
<span class="line-num">415</span>     <span class="ruby-ivar">@is_active</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:is_active</span>]
<span class="line-num">416</span>   <span class="ruby-keyword">end</span>
<span class="line-num">417</span>   
<span class="line-num">418</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:iconic_taxa</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@iconic_taxa_ids</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:iconic_taxa</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="line-num">419</span>     <span class="ruby-ivar">@iconic_taxa_ids</span> = <span class="ruby-ivar">@iconic_taxa_ids</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
<span class="line-num">420</span>     <span class="ruby-ivar">@iconic_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@iconic_taxa_ids</span>)
<span class="line-num">421</span>   <span class="ruby-keyword">end</span>
<span class="line-num">422</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:places</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@place_ids</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:places</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="line-num">423</span>     <span class="ruby-ivar">@place_ids</span> = <span class="ruby-ivar">@place_ids</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
<span class="line-num">424</span>     <span class="ruby-ivar">@places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@place_ids</span>)
<span class="line-num">425</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@site_place</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:everywhere</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">426</span>     <span class="ruby-ivar">@place_ids</span> = [<span class="ruby-ivar">@site_place</span>.<span class="ruby-identifier">id</span>]
<span class="line-num">427</span>     <span class="ruby-ivar">@places</span> = [<span class="ruby-ivar">@site_place</span>]
<span class="line-num">428</span>   <span class="ruby-keyword">end</span>
<span class="line-num">429</span> 
<span class="line-num">430</span>   <span class="ruby-identifier">page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
<span class="line-num">431</span>   <span class="ruby-identifier">user_per_page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">24</span>
<span class="line-num">432</span>   <span class="ruby-identifier">user_per_page</span> = <span class="ruby-value">24</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_per_page</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">433</span>   <span class="ruby-identifier">user_per_page</span> = <span class="ruby-value">100</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">user_per_page</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>
<span class="line-num">434</span>   <span class="ruby-identifier">per_page</span> = <span class="ruby-identifier">page</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">user_per_page</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">50</span> <span class="ruby-operator">?</span> <span class="ruby-value">50</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">user_per_page</span>
<span class="line-num">435</span> 
<span class="line-num">436</span>   <span class="ruby-identifier">filters</span> = [ ]
<span class="line-num">437</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@q</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">438</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> {
<span class="line-num">439</span>       <span class="ruby-value">nested:</span> {
<span class="line-num">440</span>         <span class="ruby-value">path:</span> <span class="ruby-string">&quot;names&quot;</span>,
<span class="line-num">441</span>         <span class="ruby-value">query:</span> {
<span class="line-num">442</span>           <span class="ruby-value">match:</span> { <span class="ruby-value">&quot;names.name&quot;:</span> { <span class="ruby-value">query:</span> <span class="ruby-ivar">@q</span>, <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span> } }
<span class="line-num">443</span>         }
<span class="line-num">444</span>       }
<span class="line-num">445</span>     }
<span class="line-num">446</span>   <span class="ruby-keyword">end</span>
<span class="line-num">447</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@is_active</span> <span class="ruby-operator">===</span> <span class="ruby-keyword">true</span>
<span class="line-num">448</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">is_active:</span> <span class="ruby-keyword">false</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@is_active</span> <span class="ruby-operator">===</span> <span class="ruby-keyword">false</span>
<span class="line-num">449</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-ivar">@iconic_taxa_ids</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@iconic_taxa_ids</span>
<span class="line-num">450</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">place_ids:</span> <span class="ruby-ivar">@place_ids</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place_ids</span>
<span class="line-num">451</span>   <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">ancestor_ids:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span> } } <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">452</span>   <span class="ruby-identifier">search_options</span> = { <span class="ruby-value">sort:</span> { <span class="ruby-value">observations_count:</span> <span class="ruby-string">&quot;desc&quot;</span> },
<span class="line-num">453</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">454</span>       <span class="ruby-value">iconic_taxon_id:</span> { <span class="ruby-value">&quot;iconic_taxon_id&quot;:</span> <span class="ruby-value">12</span> },
<span class="line-num">455</span>       <span class="ruby-value">place:</span> { <span class="ruby-value">&quot;places.id&quot;:</span> <span class="ruby-value">12</span> }
<span class="line-num">456</span>     } }
<span class="line-num">457</span>   <span class="ruby-identifier">search_result</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_search</span>(<span class="ruby-identifier">search_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>)).
<span class="line-num">458</span>     <span class="ruby-identifier">per_page</span>(<span class="ruby-identifier">per_page</span>).<span class="ruby-identifier">page</span>(<span class="ruby-identifier">page</span>)
<span class="line-num">459</span>   <span class="ruby-comment"># if there are no search results, and the search was performed with</span>
<span class="line-num">460</span>   <span class="ruby-comment"># a search ID filter, but one wasn&#39;t asked for. This will happen when</span>
<span class="line-num">461</span>   <span class="ruby-comment"># rendering a partner site and a search filter is</span>
<span class="line-num">462</span>   <span class="ruby-comment"># set automatically. Re-run the search w/o the place filter</span>
<span class="line-num">463</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">search_result</span>.<span class="ruby-identifier">total_entries</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:places</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@place_ids</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">464</span>     <span class="ruby-identifier">without_place_filters</span> = <span class="ruby-identifier">filters</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span>( <span class="ruby-identifier">f</span>[<span class="ruby-value">:terms</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">:terms</span>][<span class="ruby-value">:place_ids</span>] ) }
<span class="line-num">465</span>     <span class="ruby-identifier">search_result</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">elastic_search</span>(<span class="ruby-identifier">search_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">filters:</span> <span class="ruby-identifier">without_place_filters</span>)).
<span class="line-num">466</span>       <span class="ruby-identifier">per_page</span>(<span class="ruby-identifier">per_page</span>).<span class="ruby-identifier">page</span>(<span class="ruby-identifier">page</span>)
<span class="line-num">467</span>   <span class="ruby-keyword">end</span>
<span class="line-num">468</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">result_to_will_paginate_collection</span>(<span class="ruby-identifier">search_result</span>)
<span class="line-num">469</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxa</span>, [ { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> },
<span class="line-num">470</span>     { <span class="ruby-value">taxon_photos:</span> <span class="ruby-value">:photo</span> }, <span class="ruby-value">:taxon_descriptions</span> ] )
<span class="line-num">471</span> 
<span class="line-num">472</span>   <span class="ruby-ivar">@facets</span> = { }
<span class="line-num">473</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@facets</span>[<span class="ruby-value">:iconic_taxon_id</span>] = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">search_result</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">iconic_taxon_id</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>], <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] ]}]
<span class="line-num">474</span>     <span class="ruby-ivar">@faceted_iconic_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@facets</span>[<span class="ruby-value">:iconic_taxon_id</span>].<span class="ruby-identifier">keys</span>).
<span class="line-num">475</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>, <span class="ruby-value">:photos</span>)
<span class="line-num">476</span>     <span class="ruby-ivar">@faceted_iconic_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">sort_by_ancestry</span>(<span class="ruby-ivar">@faceted_iconic_taxa</span>)
<span class="line-num">477</span>     <span class="ruby-ivar">@faceted_iconic_taxa_by_id</span> = <span class="ruby-ivar">@faceted_iconic_taxa</span>.<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">478</span>   <span class="ruby-keyword">end</span>
<span class="line-num">479</span> 
<span class="line-num">480</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@places</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@facets</span>[<span class="ruby-value">:places</span>] = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">search_result</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">place</span>.<span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>], <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] ]}]
<span class="line-num">481</span>     <span class="ruby-identifier">place_ids_to_load</span> = [<span class="ruby-ivar">@facets</span>[<span class="ruby-value">:places</span>].<span class="ruby-identifier">keys</span>, <span class="ruby-ivar">@place_ids</span>].<span class="ruby-identifier">flatten</span>
<span class="line-num">482</span>     <span class="ruby-ivar">@faceted_places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id in (?)&quot;</span>, <span class="ruby-identifier">place_ids_to_load</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;name ASC&quot;</span>)
<span class="line-num">483</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">place</span> = <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">first</span>)
<span class="line-num">484</span>       <span class="ruby-ivar">@faceted_places</span> = <span class="ruby-ivar">@faceted_places</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">place</span>.<span class="ruby-identifier">descendant_conditions</span>)
<span class="line-num">485</span>     <span class="ruby-keyword">end</span>
<span class="line-num">486</span>     <span class="ruby-ivar">@faceted_places_by_id</span> = <span class="ruby-ivar">@faceted_places</span>.<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">487</span>   <span class="ruby-keyword">end</span>
<span class="line-num">488</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">489</span>     <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">490</span>   <span class="ruby-keyword">rescue</span>
<span class="line-num">491</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR] Failed taxon search: #{e}&quot;</span>
<span class="line-num">492</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">WillPaginate</span><span class="ruby-operator">::</span><span class="ruby-constant">Collection</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">1</span>, <span class="ruby-value">30</span>, <span class="ruby-value">0</span>)
<span class="line-num">493</span>   <span class="ruby-keyword">end</span>
<span class="line-num">494</span> 
<span class="line-num">495</span>   <span class="ruby-identifier">do_external_lookups</span>
<span class="line-num">496</span> 
<span class="line-num">497</span>   <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">compact!</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">498</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">499</span>     <span class="ruby-comment"># if there&#39;s an exact match among the hits, make sure it&#39;s first</span>
<span class="line-num">500</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">exact_index</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">index</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">all_names</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>)}
<span class="line-num">501</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">exact_index</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">502</span>         <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">delete_at</span>(<span class="ruby-identifier">exact_index</span>)
<span class="line-num">503</span>       <span class="ruby-keyword">end</span>
<span class="line-num">504</span>     <span class="ruby-keyword">end</span>
<span class="line-num">505</span>   <span class="ruby-keyword">end</span>
<span class="line-num">506</span> 
<span class="line-num">507</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">page</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> }
<span class="line-num">508</span>     <span class="ruby-identifier">exact_taxon_scope</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(name) = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>).
<span class="line-num">509</span>       <span class="ruby-identifier">where</span>(<span class="ruby-value">is_active:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">510</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@iconic_taxa_ids</span>
<span class="line-num">511</span>       <span class="ruby-identifier">exact_taxon_scope</span> = <span class="ruby-identifier">exact_taxon_scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">iconic_taxon_id:</span> <span class="ruby-ivar">@iconic_taxa_ids</span> )
<span class="line-num">512</span>     <span class="ruby-keyword">end</span>
<span class="line-num">513</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">exact_taxon</span> = <span class="ruby-identifier">exact_taxon_scope</span>.<span class="ruby-identifier">first</span>
<span class="line-num">514</span>       <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">exact_taxon</span>
<span class="line-num">515</span>     <span class="ruby-keyword">end</span>
<span class="line-num">516</span>   <span class="ruby-keyword">end</span>
<span class="line-num">517</span> 
<span class="line-num">518</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">page</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">per_page</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">user_per_page</span>
<span class="line-num">519</span>     <span class="ruby-identifier">old_taxa</span> = <span class="ruby-ivar">@taxa</span>
<span class="line-num">520</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">WillPaginate</span><span class="ruby-operator">::</span><span class="ruby-constant">Collection</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">user_per_page</span>, <span class="ruby-identifier">old_taxa</span>.<span class="ruby-identifier">total_entries</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pager</span><span class="ruby-operator">|</span>
<span class="line-num">521</span>       <span class="ruby-identifier">pager</span>.<span class="ruby-identifier">replace</span>(<span class="ruby-identifier">old_taxa</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">user_per_page</span>])
<span class="line-num">522</span>     <span class="ruby-keyword">end</span>
<span class="line-num">523</span>   <span class="ruby-keyword">end</span>
<span class="line-num">524</span>   
<span class="line-num">525</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">526</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">527</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:return_to</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:return_to</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">528</span>       <span class="ruby-ivar">@view</span> = <span class="ruby-constant">BROWSE_VIEWS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>]) <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>] <span class="ruby-operator">:</span> <span class="ruby-constant">GRID_VIEW</span>
<span class="line-num">529</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-ivar">@status</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@status</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">530</span>       
<span class="line-num">531</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">532</span>         <span class="ruby-ivar">@all_iconic_taxa</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">ICONIC_TAXA</span>
<span class="line-num">533</span>       <span class="ruby-keyword">end</span>
<span class="line-num">534</span>       
<span class="line-num">535</span>       <span class="ruby-identifier">partial_path</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;taxon&quot;</span> 
<span class="line-num">536</span>         <span class="ruby-node">&quot;shared/#{params[:partial]}.html.erb&quot;</span>
<span class="line-num">537</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] 
<span class="line-num">538</span>         <span class="ruby-node">&quot;taxa/#{params[:partial]}.html.erb&quot;</span>
<span class="line-num">539</span>       <span class="ruby-keyword">end</span>       
<span class="line-num">540</span>       
<span class="line-num">541</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">partial_path</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lookup_context</span>.<span class="ruby-identifier">find_all</span>(<span class="ruby-identifier">partial_path</span>).<span class="ruby-identifier">any?</span>
<span class="line-num">542</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">partial_path</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">543</span>           <span class="ruby-value">:js_link</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:js_link</span>]
<span class="line-num">544</span>         }
<span class="line-num">545</span>       <span class="ruby-keyword">else</span>
<span class="line-num">546</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:browse</span>
<span class="line-num">547</span>       <span class="ruby-keyword">end</span>
<span class="line-num">548</span>     <span class="ruby-keyword">end</span>
<span class="line-num">549</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">550</span>       <span class="ruby-identifier">pagination_headers_for</span>(<span class="ruby-ivar">@taxa</span>)
<span class="line-num">551</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;elastic&quot;</span>
<span class="line-num">552</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-ivar">@taxa</span>).<span class="ruby-identifier">load_for_index</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:as_indexed_json</span>)
<span class="line-num">553</span>       <span class="ruby-keyword">else</span>
<span class="line-num">554</span>         <span class="ruby-identifier">options</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">555</span>         <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>].<span class="ruby-identifier">merge!</span>(
<span class="line-num">556</span>           <span class="ruby-value">:iconic_taxon</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>]},
<span class="line-num">557</span>           <span class="ruby-value">:taxon_names</span> <span class="ruby-operator">=&gt;</span> {
<span class="line-num">558</span>             <span class="ruby-value">:only</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>, <span class="ruby-value">:lexicon</span>, <span class="ruby-value">:is_valid</span>, <span class="ruby-value">:position</span>]
<span class="line-num">559</span>           }
<span class="line-num">560</span>         )
<span class="line-num">561</span>         <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:image_url</span>, <span class="ruby-value">:default_name</span>]
<span class="line-num">562</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">prefers_common_names?</span>
<span class="line-num">563</span>           <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:common_name</span>]
<span class="line-num">564</span>         <span class="ruby-keyword">end</span>
<span class="line-num">565</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]
<span class="line-num">566</span>           <span class="ruby-identifier">partial_path</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;taxon&quot;</span>
<span class="line-num">567</span>             <span class="ruby-node">&quot;shared/#{params[:partial]}.html.erb&quot;</span>
<span class="line-num">568</span>           <span class="ruby-keyword">else</span>
<span class="line-num">569</span>             <span class="ruby-node">&quot;taxa/#{params[:partial]}.html.erb&quot;</span>
<span class="line-num">570</span>           <span class="ruby-keyword">end</span>
<span class="line-num">571</span>         <span class="ruby-keyword">end</span>
<span class="line-num">572</span>         <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
<span class="line-num">573</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]
<span class="line-num">574</span>             <span class="ruby-ivar">@taxa</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">html</span> = <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">partial_path</span>, <span class="ruby-value">:locals</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">t</span>})
<span class="line-num">575</span>             <span class="ruby-identifier">options</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:html</span>
<span class="line-num">576</span>           <span class="ruby-keyword">end</span>
<span class="line-num">577</span>           <span class="ruby-ivar">@taxa</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">578</span>         <span class="ruby-keyword">end</span>
<span class="line-num">579</span>         <span class="ruby-identifier">json</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">as_json</span>( <span class="ruby-identifier">options</span> )
<span class="line-num">580</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">prefers_common_names?</span>
<span class="line-num">581</span>           <span class="ruby-identifier">json</span> = <span class="ruby-identifier">json</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">jt</span><span class="ruby-operator">|</span>
<span class="line-num">582</span>             <span class="ruby-identifier">jt</span>[<span class="ruby-string">&quot;taxon_names&quot;</span>] = <span class="ruby-identifier">jt</span>[<span class="ruby-string">&quot;taxon_names&quot;</span>].<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>[<span class="ruby-string">&quot;lexicon&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">TaxonName</span><span class="ruby-operator">::</span><span class="ruby-constant">LEXICONS</span>[<span class="ruby-value">:SCIENTIFIC_NAMES</span>] }
<span class="line-num">583</span>             <span class="ruby-identifier">jt</span>
<span class="line-num">584</span>           <span class="ruby-keyword">end</span>
<span class="line-num">585</span>         <span class="ruby-keyword">end</span>
<span class="line-num">586</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-identifier">json</span>
<span class="line-num">587</span>       <span class="ruby-keyword">end</span>
<span class="line-num">588</span>     <span class="ruby-keyword">end</span>
<span class="line-num">589</span>   <span class="ruby-keyword">end</span>
<span class="line-num">590</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_photos">
            
              <b>set_photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-set_photos" name="method-i-set_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Basically the same as update photos except it just takes a JSON array of photo-like objects congtaining the keys id, type, and native_photo_id, and sets them as the photos, respecting their position.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_photos_source')" id="l_method-i-set_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_photos_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num"> 933</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_photos</span>
<span class="line-num"> 934</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos_locked?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num"> 935</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 936</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 937</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">json:</span> {
<span class="line-num"> 938</span>           <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_edit_those_photos</span>)
<span class="line-num"> 939</span>         }
<span class="line-num"> 940</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 941</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 942</span>     <span class="ruby-keyword">return</span>
<span class="line-num"> 943</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 944</span>   <span class="ruby-identifier">photos</span> = ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:photos</span>] <span class="ruby-operator">||</span> [] ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num"> 945</span>     <span class="ruby-identifier">subclass</span> = <span class="ruby-constant">LocalPhoto</span>
<span class="line-num"> 946</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>[<span class="ruby-value">:type</span>]
<span class="line-num"> 947</span>       <span class="ruby-identifier">subclass</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>( <span class="ruby-identifier">photo</span>[<span class="ruby-value">:type</span>].<span class="ruby-identifier">camelize</span> )
<span class="line-num"> 948</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 949</span>     <span class="ruby-identifier">record</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">photo</span>[<span class="ruby-value">:id</span>] )
<span class="line-num"> 950</span>     <span class="ruby-comment"># attempt to lookup photo with native_photo_id</span>
<span class="line-num"> 951</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>[<span class="ruby-value">:native_photo_id</span>]
<span class="line-num"> 952</span>       <span class="ruby-comment"># look within the custom subclass</span>
<span class="line-num"> 953</span>       <span class="ruby-identifier">record</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>(
<span class="line-num"> 954</span>         <span class="ruby-value">native_photo_id:</span> <span class="ruby-identifier">photo</span>[<span class="ruby-value">:native_photo_id</span>],
<span class="line-num"> 955</span>         <span class="ruby-value">type:</span> <span class="ruby-identifier">photo</span>[<span class="ruby-value">:type</span>],
<span class="line-num"> 956</span>         <span class="ruby-value">subtype:</span> <span class="ruby-keyword">nil</span>
<span class="line-num"> 957</span>       ).<span class="ruby-identifier">first</span>
<span class="line-num"> 958</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">subclass</span> <span class="ruby-operator">==</span> <span class="ruby-constant">LocalPhoto</span>
<span class="line-num"> 959</span>         <span class="ruby-comment"># look at LocalPhotos whose subtype is the custom subclass</span>
<span class="line-num"> 960</span>         <span class="ruby-identifier">record</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>(
<span class="line-num"> 961</span>           <span class="ruby-value">native_photo_id:</span> <span class="ruby-identifier">photo</span>[<span class="ruby-value">:native_photo_id</span>],
<span class="line-num"> 962</span>           <span class="ruby-value">type:</span> <span class="ruby-string">&quot;LocalPhoto&quot;</span>,
<span class="line-num"> 963</span>           <span class="ruby-value">subtype:</span> <span class="ruby-identifier">subclass</span>.<span class="ruby-identifier">name</span>
<span class="line-num"> 964</span>         ).<span class="ruby-identifier">first</span>
<span class="line-num"> 965</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 966</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 967</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">record</span>
<span class="line-num"> 968</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">api_response</span> = <span class="ruby-identifier">subclass</span>.<span class="ruby-identifier">get_api_response</span>( <span class="ruby-identifier">photo</span>[<span class="ruby-value">:native_photo_id</span>] )
<span class="line-num"> 969</span>         <span class="ruby-identifier">record</span> = <span class="ruby-identifier">subclass</span>.<span class="ruby-identifier">new_from_api_response</span>( <span class="ruby-identifier">api_response</span> )
<span class="line-num"> 970</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 971</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 972</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">record</span>
<span class="line-num"> 973</span>       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] failed to find record for #{photo}&quot;</span>
<span class="line-num"> 974</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 975</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">LocalPhoto</span> )
<span class="line-num"> 976</span>       <span class="ruby-comment"># turn all remote photos into LocalPhotos</span>
<span class="line-num"> 977</span>       <span class="ruby-identifier">record</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">local_photo_from_remote_photo</span>( <span class="ruby-identifier">record</span> )
<span class="line-num"> 978</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 979</span>     <span class="ruby-identifier">record</span>
<span class="line-num"> 980</span>   }.<span class="ruby-identifier">compact</span>
<span class="line-num"> 981</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_photos</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
<span class="line-num"> 982</span>     <span class="ruby-identifier">taxon_photo</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_photos</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">tp</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tp</span>.<span class="ruby-identifier">photo_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">id</span> }
<span class="line-num"> 983</span>     <span class="ruby-identifier">taxon_photo</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonPhoto</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">taxon:</span> <span class="ruby-ivar">@taxon</span>, <span class="ruby-value">photo:</span> <span class="ruby-identifier">photo</span> )
<span class="line-num"> 984</span>     <span class="ruby-identifier">taxon_photo</span>.<span class="ruby-identifier">position</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">index</span>( <span class="ruby-identifier">photo</span> )
<span class="line-num"> 985</span>     <span class="ruby-identifier">taxon_photo</span>.<span class="ruby-identifier">skip_taxon_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 986</span>     <span class="ruby-identifier">taxon_photo</span>
<span class="line-num"> 987</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 988</span>   <span class="ruby-comment"># no need to index the taxon&#39;s observations if only photos are being changed</span>
<span class="line-num"> 989</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">skip_observation_indexing</span> = <span class="ruby-keyword">true</span>
<span class="line-num"> 990</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">save</span>
<span class="line-num"> 991</span>     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">reload</span>
<span class="line-num"> 992</span>     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num"> 993</span>   <span class="ruby-keyword">else</span>
<span class="line-num"> 994</span>     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[DEBUG] error: #{@taxon.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num"> 995</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num"> 996</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 997</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> {
<span class="line-num"> 998</span>           <span class="ruby-value">error:</span> <span class="ruby-node">&quot;Failed to save taxon: #{@taxon.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num"> 999</span>         }
<span class="line-num">1000</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1001</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1002</span>     <span class="ruby-keyword">return</span>
<span class="line-num">1003</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1004</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">1005</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">update_ancestor_photos</span>( <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">1006</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1007</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1008</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@taxon</span> }
<span class="line-num">1009</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1010</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ETIMEDOUT</span>
<span class="line-num">1011</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1012</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:request_timed_out</span>) }, <span class="ruby-value">status:</span> <span class="ruby-value">:request_timeout</span> }
<span class="line-num">1013</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">1014</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:request_timed_out</span>)
<span class="line-num">1015</span>       <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> ) )
<span class="line-num">1016</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1017</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1018</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">APIError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1019</span>   <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/OAuthException/</span>
<span class="line-num">1020</span>   <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(
<span class="line-num">1021</span>     <span class="ruby-value">:facebook_needs_the_owner_of_that_photo_to</span>,
<span class="line-num">1022</span>     <span class="ruby-value">site_name_short:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">1023</span>   )
<span class="line-num">1024</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1025</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> }, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">1026</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">1027</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span> 
<span class="line-num">1028</span>       <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> ) )
<span class="line-num">1029</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1030</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1031</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show">
            
              <b>show</b>()
            
            <a href="../classes/TaxaController.html#method-i-show" name="method-i-show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_source')" id="l_method-i-show_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">148</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show</span>
<span class="line-num">149</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]
<span class="line-num">150</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">151</span>       <span class="ruby-ivar">@taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]).<span class="ruby-identifier">includes</span>({ <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> }).<span class="ruby-identifier">first</span>
<span class="line-num">152</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RangeError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">153</span>       <span class="ruby-constant">Logstasher</span>.<span class="ruby-identifier">write_exception</span>(<span class="ruby-identifier">e</span>, <span class="ruby-value">request:</span> <span class="ruby-identifier">request</span>, <span class="ruby-value">session:</span> <span class="ruby-identifier">session</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">154</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">155</span>     <span class="ruby-keyword">end</span>
<span class="line-num">156</span>   <span class="ruby-keyword">end</span>
<span class="line-num">157</span>   
<span class="line-num">158</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">render_404</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">159</span>   
<span class="line-num">160</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">161</span> 
<span class="line-num">162</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">163</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Life&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">parent_id</span>
<span class="line-num">164</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span>( <span class="ruby-value">action:</span> <span class="ruby-string">&quot;index&quot;</span> )
<span class="line-num">165</span>       <span class="ruby-keyword">end</span>
<span class="line-num">166</span>       
<span class="line-num">167</span>       <span class="ruby-identifier">site_place</span> = <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">place</span>
<span class="line-num">168</span>       <span class="ruby-identifier">user_place</span> = <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">place</span>
<span class="line-num">169</span>       <span class="ruby-identifier">preferred_place</span> = <span class="ruby-identifier">user_place</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">site_place</span>
<span class="line-num">170</span>       <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">preferred_taxon_page_place_id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">logged_in?</span>
<span class="line-num">171</span>       <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-value">:preferred_taxon_page_place_id</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">172</span>       <span class="ruby-comment"># If there&#39;s no place and there is a preferred place and this user has</span>
<span class="line-num">173</span>       <span class="ruby-comment"># never changed their taxon page place preference, use the preferred</span>
<span class="line-num">174</span>       <span class="ruby-comment"># place</span>
<span class="line-num">175</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">preferred_place</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">session</span>.<span class="ruby-identifier">has_key?</span>( <span class="ruby-value">:preferred_taxon_page_place_id</span> )
<span class="line-num">176</span>         <span class="ruby-identifier">place_id</span> = <span class="ruby-identifier">preferred_place</span>.<span class="ruby-identifier">id</span>
<span class="line-num">177</span>       <span class="ruby-keyword">end</span>
<span class="line-num">178</span>       <span class="ruby-identifier">api_url</span> = <span class="ruby-node">&quot;/taxa/#{@taxon.id}?preferred_place_id=#{preferred_place.try(:id)}&amp;place_id=#{@place.try(:id)}&amp;locale=#{I18n.locale}&quot;</span>
<span class="line-num">179</span>       <span class="ruby-identifier">options</span> = {}
<span class="line-num">180</span>       <span class="ruby-identifier">options</span>[<span class="ruby-value">:authenticate</span>] = <span class="ruby-identifier">current_user</span>
<span class="line-num">181</span>       <span class="ruby-ivar">@node_taxon_json</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-identifier">api_url</span>, <span class="ruby-identifier">options</span> )
<span class="line-num">182</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">render_404</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@node_taxon_json</span>
<span class="line-num">183</span>       <span class="ruby-ivar">@node_place_json</span> = ( <span class="ruby-identifier">place_id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">place_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> ) <span class="ruby-operator">?</span>
<span class="line-num">184</span>         <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get_json</span>( <span class="ruby-node">&quot;/places/#{place_id.to_i}&quot;</span> )
<span class="line-num">185</span>       <span class="ruby-ivar">@chosen_tab</span> = <span class="ruby-identifier">session</span>[<span class="ruby-value">:preferred_taxon_page_tab</span>]
<span class="line-num">186</span>       <span class="ruby-ivar">@ancestors_shown</span> = <span class="ruby-identifier">session</span>[<span class="ruby-value">:preferred_taxon_page_ancestors_shown</span>]
<span class="line-num">187</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;show&quot;</span>
<span class="line-num">188</span>     <span class="ruby-keyword">end</span>
<span class="line-num">189</span>     
<span class="line-num">190</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span> <span class="ruby-keyword">do</span>
<span class="line-num">191</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:xml</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">to_xml</span>(
<span class="line-num">192</span>         <span class="ruby-value">:include</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:taxon_names</span>, <span class="ruby-value">:iconic_taxon</span>], 
<span class="line-num">193</span>         <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-value">:common_name</span>]
<span class="line-num">194</span>       )
<span class="line-num">195</span>     <span class="ruby-keyword">end</span>
<span class="line-num">196</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">197</span>       <span class="ruby-keyword">if</span> (<span class="ruby-identifier">partial</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:partial</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ALLOWED_SHOW_PARTIALS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">partial</span>)
<span class="line-num">198</span>         <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">html</span> = <span class="ruby-identifier">render_to_string</span>(<span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-node">&quot;#{partial}.html.erb&quot;</span>, <span class="ruby-value">:object</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>)
<span class="line-num">199</span>       <span class="ruby-keyword">end</span>
<span class="line-num">200</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>([<span class="ruby-ivar">@taxon</span>], [
<span class="line-num">201</span>         { <span class="ruby-value">taxon_photos:</span> { <span class="ruby-value">photo:</span> <span class="ruby-value">:user</span> } },
<span class="line-num">202</span>         { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> }, <span class="ruby-value">:iconic_taxon</span> ] )
<span class="line-num">203</span> 
<span class="line-num">204</span>       <span class="ruby-identifier">opts</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">205</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:include</span>][<span class="ruby-value">:taxon_names</span>] = {}
<span class="line-num">206</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:include</span>][<span class="ruby-value">:iconic_taxon</span>] = {<span class="ruby-value">only:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>]}
<span class="line-num">207</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods</span>] <span class="ruby-operator">+=</span> [<span class="ruby-value">:common_name</span>, <span class="ruby-value">:image_url</span>, <span class="ruby-value">:taxon_range_kml_url</span>, <span class="ruby-value">:html</span>, <span class="ruby-value">:default_photo</span>]
<span class="line-num">208</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@taxon</span>, { <span class="ruby-value">taxon_photos:</span> <span class="ruby-value">:photo</span> })
<span class="line-num">209</span>       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">210</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-identifier">opts</span>)
<span class="line-num">211</span>     <span class="ruby-keyword">end</span>
<span class="line-num">212</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">node</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">jit_taxon_node</span>(<span class="ruby-ivar">@taxon</span>) }
<span class="line-num">213</span>   <span class="ruby-keyword">end</span>
<span class="line-num">214</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-synonyms">
            
              <b>synonyms</b>()
            
            <a href="../classes/TaxaController.html#method-i-synonyms" name="method-i-synonyms" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-synonyms_source')" id="l_method-i-synonyms_source">show</a>
                

                

                
              </p>
              <div id="method-i-synonyms_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1312</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">synonyms</span>
<span class="line-num">1313</span>   <span class="ruby-identifier">filters</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:filters</span>] <span class="ruby-operator">||</span> {}
<span class="line-num">1314</span>   <span class="ruby-ivar">@iconic_taxon</span> = <span class="ruby-identifier">filters</span>[<span class="ruby-value">:iconic_taxon</span>]
<span class="line-num">1315</span>   <span class="ruby-ivar">@rank</span> = <span class="ruby-identifier">filters</span>[<span class="ruby-value">:rank</span>]
<span class="line-num">1316</span>   <span class="ruby-ivar">@within_iconic</span> = <span class="ruby-identifier">filters</span>[<span class="ruby-value">:within_iconic</span>]
<span class="line-num">1317</span> 
<span class="line-num">1318</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">page</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).
<span class="line-num">1319</span>     <span class="ruby-identifier">per_page</span>(<span class="ruby-value">100</span>).
<span class="line-num">1320</span>     <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;rank_level&quot;</span>).
<span class="line-num">1321</span>     <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;LEFT OUTER JOIN taxa t ON t.name = taxa.name&quot;</span>).
<span class="line-num">1322</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;t.id IS NOT NULL AND t.id != taxa.id AND t.is_active = ?&quot;</span>, <span class="ruby-keyword">true</span>)
<span class="line-num">1323</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">self_and_descendants_of</span>(<span class="ruby-ivar">@iconic_taxon</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@iconic_taxon</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1324</span>   <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">of_rank</span>(<span class="ruby-ivar">@rank</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@rank</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1325</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@within_iconic</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;t&#39;</span>
<span class="line-num">1326</span>     <span class="ruby-ivar">@taxa</span> = <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;taxa.iconic_taxon_id = t.iconic_taxon_id OR taxa.iconic_taxon_id IS NULL OR t.iconic_taxon_id IS NULL&quot;</span>)
<span class="line-num">1327</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1328</span>   <span class="ruby-ivar">@synonyms</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">active</span>.
<span class="line-num">1329</span>     <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;name IN (?)&quot;</span>, <span class="ruby-ivar">@taxa</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}).
<span class="line-num">1330</span>     <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>, <span class="ruby-value">:taxon_schemes</span>)
<span class="line-num">1331</span>   <span class="ruby-ivar">@synonyms_by_name</span> = <span class="ruby-ivar">@synonyms</span>.<span class="ruby-identifier">group_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}
<span class="line-num">1332</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-tag_flickr_photos">
            
              <b>tag_flickr_photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-tag_flickr_photos" name="method-i-tag_flickr_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-tag_flickr_photos_source')" id="l_method-i-tag_flickr_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-tag_flickr_photos_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1365</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">tag_flickr_photos</span>
<span class="line-num">1366</span>   <span class="ruby-comment"># Post tags to flickr</span>
<span class="line-num">1367</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1368</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_didnt_select_any_photos_to_tag</span>)
<span class="line-num">1369</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;flickr_tagger&#39;</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
<span class="line-num">1370</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1371</span>   
<span class="line-num">1372</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">flickr_identity</span>
<span class="line-num">1373</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:sorry_you_need_to_be_signed_in_and</span>)
<span class="line-num">1374</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;flickr_tagger&#39;</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
<span class="line-num">1375</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1376</span>   
<span class="line-num">1377</span>   <span class="ruby-identifier">flickr</span> = <span class="ruby-identifier">get_flickraw</span>
<span class="line-num">1378</span>   
<span class="line-num">1379</span>   <span class="ruby-identifier">photos</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">subtype:</span> <span class="ruby-string">&#39;FlickrPhoto&#39;</span>, <span class="ruby-value">native_photo_id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>]).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:observations</span>)
<span class="line-num">1380</span>   
<span class="line-num">1381</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">flickr_photo_id</span><span class="ruby-operator">|</span>
<span class="line-num">1382</span>     <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tags</span>]
<span class="line-num">1383</span>     <span class="ruby-identifier">photo</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">1384</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">native_photo_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">flickr_photo_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">subtype</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;FlickrPhoto&quot;</span> }
<span class="line-num">1385</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;inaturalist:observation=#{o.id}&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39; &#39;</span>)
<span class="line-num">1386</span>       <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">strip!</span>
<span class="line-num">1387</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1388</span>     <span class="ruby-identifier">tag_flickr_photo</span>(<span class="ruby-identifier">flickr_photo_id</span>, <span class="ruby-identifier">tags</span>, <span class="ruby-value">:flickr</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">flickr</span>)
<span class="line-num">1389</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;flickr_tagger&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1390</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1391</span>   
<span class="line-num">1392</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:your_photos_have_been_tagged</span>)
<span class="line-num">1393</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;flickr_photos_tagged&#39;</span>, 
<span class="line-num">1394</span>     <span class="ruby-value">:flickr_photos</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flickr_photos</span>], <span class="ruby-value">:tags</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:tags</span>]
<span class="line-num">1395</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-tag_flickr_photos_from_observations">
            
              <b>tag_flickr_photos_from_observations</b>()
            
            <a href="../classes/TaxaController.html#method-i-tag_flickr_photos_from_observations" name="method-i-tag_flickr_photos_from_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-tag_flickr_photos_from_observations_source')" id="l_method-i-tag_flickr_photos_from_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-tag_flickr_photos_from_observations_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1397</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">tag_flickr_photos_from_observations</span>
<span class="line-num">1398</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:o</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1399</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_didnt_select_any_observations</span>)
<span class="line-num">1400</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">flickr_tagger_path</span> )
<span class="line-num">1401</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1402</span>   
<span class="line-num">1403</span>   <span class="ruby-ivar">@observations</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:o</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)).
<span class="line-num">1404</span>     <span class="ruby-identifier">includes</span>([ <span class="ruby-value">:photos</span>, { <span class="ruby-value">:taxon</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:taxon_names</span> } ])
<span class="line-num">1405</span>   
<span class="line-num">1406</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1407</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:no_observations_matching_those_ids</span>)
<span class="line-num">1408</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">flickr_tagger_path</span> )
<span class="line-num">1409</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1410</span>   
<span class="line-num">1411</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:user_id</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1412</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_edit_those_photos</span>)
<span class="line-num">1413</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">flickr_tagger_path</span> )
<span class="line-num">1414</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1415</span>   
<span class="line-num">1416</span>   <span class="ruby-identifier">flickr</span> = <span class="ruby-identifier">get_flickraw</span>
<span class="line-num">1417</span> 
<span class="line-num">1418</span>   <span class="ruby-identifier">flickr_photo_ids</span> = []
<span class="line-num">1419</span>   <span class="ruby-ivar">@observations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">observation</span> <span class="ruby-operator">|</span>
<span class="line-num">1420</span>     <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">photos</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">photo</span> <span class="ruby-operator">|</span>
<span class="line-num">1421</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">FlickrPhoto</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">subtype</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;FlickrPhoto&quot;</span>
<span class="line-num">1422</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">1423</span> 
<span class="line-num">1424</span>       <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">observation</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">to_tags</span>
<span class="line-num">1425</span>       <span class="ruby-identifier">tags</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;inaturalist:observation=#{observation.id}&quot;</span>
<span class="line-num">1426</span>       <span class="ruby-identifier">tag_flickr_photo</span>( <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_photo_id</span>, <span class="ruby-identifier">tags</span>, <span class="ruby-value">flickr:</span> <span class="ruby-identifier">flickr</span> )
<span class="line-num">1427</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1428</span>         <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">flickr_tagger_path</span> )
<span class="line-num">1429</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1430</span> 
<span class="line-num">1431</span>       <span class="ruby-identifier">flickr_photo_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">native_photo_id</span>
<span class="line-num">1432</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1433</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1434</span> 
<span class="line-num">1435</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;flickr_photos_tagged&#39;</span>, <span class="ruby-value">:flickr_photos</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">flickr_photo_ids</span>
<span class="line-num">1436</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxobox">
            
              <b>taxobox</b>()
            
            <a href="../classes/TaxaController.html#method-i-taxobox" name="method-i-taxobox" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxobox_source')" id="l_method-i-taxobox_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxobox_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">859</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxobox</span>
<span class="line-num">860</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">861</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">partial:</span> <span class="ruby-string">&quot;wikipedia_taxobox&quot;</span>, <span class="ruby-value">object:</span> <span class="ruby-ivar">@taxon</span> }
<span class="line-num">862</span>   <span class="ruby-keyword">end</span>
<span class="line-num">863</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-taxonomy_details">
            
              <b>taxonomy_details</b>()
            
            <a href="../classes/TaxaController.html#method-i-taxonomy_details" name="method-i-taxonomy_details" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-taxonomy_details_source')" id="l_method-i-taxonomy_details_source">show</a>
                

                

                
              </p>
              <div id="method-i-taxonomy_details_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">237</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">taxonomy_details</span>
<span class="line-num">238</span>   <span class="ruby-ivar">@rank_levels</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_FOR_RANK_LEVEL</span>.<span class="ruby-identifier">invert</span>
<span class="line-num">239</span>   <span class="ruby-ivar">@taxon_framework</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_framework</span>
<span class="line-num">240</span>   
<span class="line-num">241</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@upstream_taxon_framework</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">upstream_taxon_framework</span>
<span class="line-num">242</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@upstream_taxon_framework</span>.<span class="ruby-identifier">source_id</span>
<span class="line-num">243</span>       <span class="ruby-ivar">@taxon_framework_relationship</span> = <span class="ruby-constant">TaxonFrameworkRelationship</span>.
<span class="line-num">244</span>         <span class="ruby-identifier">includes</span>( <span class="ruby-string">&quot;taxa&quot;</span>,<span class="ruby-string">&quot;external_taxa&quot;</span> ).
<span class="line-num">245</span>         <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN taxa ON taxa.taxon_framework_relationship_id = taxon_framework_relationships.id&quot;</span> ).
<span class="line-num">246</span>         <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxa.id = ? AND taxon_framework_id = ?&quot;</span>, <span class="ruby-ivar">@taxon</span>, <span class="ruby-ivar">@upstream_taxon_framework</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">247</span>       <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon_framework</span>
<span class="line-num">248</span>         <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon_framework_relationship</span>
<span class="line-num">249</span>           <span class="ruby-ivar">@downstream_deviations_counts</span> = <span class="ruby-ivar">@taxon_framework_relationship</span>.<span class="ruby-identifier">internal_taxa</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span> {<span class="ruby-value">internal_taxon:</span> <span class="ruby-identifier">it</span>, <span class="ruby-value">count:</span> <span class="ruby-constant">TaxonFrameworkRelationship</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_framework_id = ? AND relationship != &#39;match&#39; AND relationship != &#39;alternate_position&#39;&quot;</span>, <span class="ruby-ivar">@upstream_taxon_framework</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">internal_taxon</span>(<span class="ruby-identifier">it</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> } }
<span class="line-num">250</span>         <span class="ruby-keyword">end</span>
<span class="line-num">251</span>         <span class="ruby-ivar">@downstream_flagged_taxa</span> = <span class="ruby-ivar">@upstream_taxon_framework</span>.<span class="ruby-identifier">get_flagged_taxa</span>({<span class="ruby-value">taxon:</span> <span class="ruby-ivar">@taxon</span>})
<span class="line-num">252</span>         <span class="ruby-ivar">@downstream_flagged_taxa_count</span> = <span class="ruby-ivar">@upstream_taxon_framework</span>.<span class="ruby-identifier">get_flagged_taxa_count</span>({<span class="ruby-value">taxon:</span> <span class="ruby-ivar">@taxon</span>})
<span class="line-num">253</span>       <span class="ruby-keyword">end</span>
<span class="line-num">254</span>     <span class="ruby-keyword">end</span>
<span class="line-num">255</span>   <span class="ruby-keyword">end</span>
<span class="line-num">256</span>   
<span class="line-num">257</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon_framework</span>
<span class="line-num">258</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">covers?</span>
<span class="line-num">259</span>       <span class="ruby-ivar">@taxon_curators</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">taxon_curators</span>
<span class="line-num">260</span>       <span class="ruby-ivar">@overlapping_downstream_taxon_frameworks_count</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">get_downstream_taxon_frameworks_count</span>
<span class="line-num">261</span>       <span class="ruby-ivar">@overlapping_downstream_taxon_frameworks</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">get_downstream_taxon_frameworks</span>
<span class="line-num">262</span>       <span class="ruby-ivar">@flagged_taxa</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">get_flagged_taxa</span>
<span class="line-num">263</span>       <span class="ruby-ivar">@flagged_taxa_count</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">get_flagged_taxa_count</span>
<span class="line-num">264</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">source_id</span>
<span class="line-num">265</span>         <span class="ruby-ivar">@tfr_count</span> = <span class="ruby-constant">TaxonFrameworkRelationship</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_framework_id = ?&quot;</span>, <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">266</span>         <span class="ruby-ivar">@deviations_count</span> = <span class="ruby-constant">TaxonFrameworkRelationship</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;taxon_framework_id = ? AND relationship != &#39;match&#39; AND relationship != &#39;alternate_position&#39;&quot;</span>, <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">267</span>         <span class="ruby-ivar">@relationship_unknown_count</span> = <span class="ruby-ivar">@taxon_framework</span>.<span class="ruby-identifier">get_internal_taxa_covered_by_taxon_framework</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">taxon_framework_relationship_id:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>
<span class="line-num">268</span>       <span class="ruby-keyword">end</span>
<span class="line-num">269</span>     <span class="ruby-keyword">end</span>
<span class="line-num">270</span>   <span class="ruby-keyword">end</span>
<span class="line-num">271</span>   
<span class="line-num">272</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">273</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">274</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">275</span>     <span class="ruby-keyword">end</span>
<span class="line-num">276</span>   <span class="ruby-keyword">end</span>
<span class="line-num">277</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-tip">
            
              <b>tip</b>()
            
            <a href="../classes/TaxaController.html#method-i-tip" name="method-i-tip" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-tip_source')" id="l_method-i-tip_source">show</a>
                

                

                
              </p>
              <div id="method-i-tip_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">279</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">tip</span>
<span class="line-num">280</span>   <span class="ruby-ivar">@observation</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:observation_id</span>]
<span class="line-num">281</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@observation</span>
<span class="line-num">282</span>     <span class="ruby-ivar">@places</span> = <span class="ruby-ivar">@observation</span>.<span class="ruby-identifier">public_system_places</span>
<span class="line-num">283</span>   <span class="ruby-keyword">end</span>
<span class="line-num">284</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>
<span class="line-num">285</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-try_show">
            
              <b>try_show</b>()
            
            <a href="../classes/TaxaController.html#method-i-try_show" name="method-i-try_show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Try to find a taxon from urls like /taxa/Animalia or /taxa/Homo_sapiens</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-try_show_source')" id="l_method-i-try_show_source">show</a>
                

                

                
              </p>
              <div id="method-i-try_show_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1469</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">try_show</span>
<span class="line-num">1470</span>   <span class="ruby-identifier">name</span>, <span class="ruby-identifier">format</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sanitize_encoding</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;_&#39;</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;.&#39;</span>)
<span class="line-num">1471</span>   <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span> = <span class="ruby-identifier">format</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">format</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1472</span>   <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">1473</span>   <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">single_taxon_for_name</span>(<span class="ruby-identifier">name</span>)
<span class="line-num">1474</span>   
<span class="line-num">1475</span>   <span class="ruby-comment"># Redirect to a canonical form</span>
<span class="line-num">1476</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1477</span>     <span class="ruby-identifier">canonical</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;_&quot;</span> )
<span class="line-num">1478</span>     <span class="ruby-identifier">taxon_names</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">1479</span>     <span class="ruby-identifier">acceptable_names</span> = [<span class="ruby-identifier">canonical</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>)}
<span class="line-num">1480</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">acceptable_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>])
<span class="line-num">1481</span>       <span class="ruby-identifier">sciname_candidates</span> = [
<span class="line-num">1482</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:action</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sanitize_encoding</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>).<span class="ruby-identifier">downcase</span>, 
<span class="line-num">1483</span>         <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sanitize_encoding</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>).<span class="ruby-identifier">downcase</span>,
<span class="line-num">1484</span>         <span class="ruby-identifier">canonical</span>.<span class="ruby-identifier">downcase</span>
<span class="line-num">1485</span>       ]
<span class="line-num">1486</span>       <span class="ruby-identifier">redirect_target</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">sciname_candidates</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>).<span class="ruby-identifier">downcase</span>)
<span class="line-num">1487</span>         <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>)
<span class="line-num">1488</span>       <span class="ruby-keyword">else</span>
<span class="line-num">1489</span>         <span class="ruby-identifier">canonical</span>
<span class="line-num">1490</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1491</span>       <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">taxa_try_show_path</span>( { <span class="ruby-value">q:</span> <span class="ruby-identifier">redirect_target</span> }.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">request</span>.<span class="ruby-constant">GET</span> ) ) )
<span class="line-num">1492</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1493</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1494</span>   
<span class="line-num">1495</span>   <span class="ruby-comment"># TODO: if multiple exact matches, render a disambig page with status 300 (Mulitple choices)</span>
<span class="line-num">1496</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1497</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;search&#39;</span>, <span class="ruby-value">:q</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">name</span>
<span class="line-num">1498</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1499</span>     <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:q</span>)
<span class="line-num">1500</span>     <span class="ruby-identifier">return_here</span>
<span class="line-num">1501</span>     <span class="ruby-identifier">show</span>
<span class="line-num">1502</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1503</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>()
            
            <a href="../classes/TaxaController.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">334</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>
<span class="line-num">335</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">presave</span>
<span class="line-num">336</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>])
<span class="line-num">337</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:taxon_was_successfully_updated</span>)
<span class="line-num">338</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">locked_ancestor</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">is_locked</span>.<span class="ruby-identifier">first</span>
<span class="line-num">339</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; Heads up: you just added a descendant of a &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">340</span>         <span class="ruby-node">&quot;locked taxon (&lt;a href=&#39;/taxa/#{locked_ancestor.id}&#39;&gt;&quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">341</span>         <span class="ruby-node">&quot;#{locked_ancestor.name}&lt;/a&gt;).  Please consider merging this &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">342</span>         <span class="ruby-string">&quot;into an existing taxon instead.&quot;</span>
<span class="line-num">343</span>     <span class="ruby-keyword">end</span>
<span class="line-num">344</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">parent</span>
<span class="line-num">345</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">is_active</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_active</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">taxon_change</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">taxon_changes</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;committed_on IS NULL&quot;</span> ).<span class="ruby-identifier">first</span>)
<span class="line-num">346</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; Heads up: the parent of this active taxon is inactive &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">347</span>           <span class="ruby-node">&quot;but its the output of this &lt;a href=&#39;/taxon_changes/#{taxon_change.id}&#39;&gt;&quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">348</span>           <span class="ruby-string">&quot;draft taxon change&lt;/a&gt; that we assume you&#39;ll commit shortly.&quot;</span>
<span class="line-num">349</span>       <span class="ruby-keyword">end</span>
<span class="line-num">350</span>     <span class="ruby-keyword">end</span>
<span class="line-num">351</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">taxon_path</span>(<span class="ruby-ivar">@taxon</span>)
<span class="line-num">352</span>     <span class="ruby-keyword">return</span>
<span class="line-num">353</span>   <span class="ruby-keyword">else</span>
<span class="line-num">354</span>     <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;edit&#39;</span>
<span class="line-num">355</span>   <span class="ruby-keyword">end</span>
<span class="line-num">356</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_colors">
            
              <b>update_colors</b>()
            
            <a href="../classes/TaxaController.html#method-i-update_colors" name="method-i-update_colors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_colors_source')" id="l_method-i-update_colors_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_colors_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">1136</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_colors</span>
<span class="line-num">1137</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>][<span class="ruby-value">:color_ids</span>]
<span class="line-num">1138</span>     <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1139</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1140</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>][<span class="ruby-value">:color_ids</span>].<span class="ruby-identifier">delete_if</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:blank?</span>)
<span class="line-num">1141</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">colors</span> = <span class="ruby-constant">Color</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:taxon</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-value">:color_ids</span>))
<span class="line-num">1142</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1143</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">save</span>
<span class="line-num">1144</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@taxon</span> }
<span class="line-num">1145</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1146</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1147</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1148</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1149</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:there_were_some_problems_saving_those_colors</span>, <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;, &#39;</span>))
<span class="line-num">1150</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1151</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">1152</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@taxon</span>
<span class="line-num">1153</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1154</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1155</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>}, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>
<span class="line-num">1156</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1157</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1158</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1159</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_photos">
            
              <b>update_photos</b>()
            
            <a href="../classes/TaxaController.html#method-i-update_photos" name="method-i-update_photos" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_photos_source')" id="l_method-i-update_photos_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_photos_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/taxa_controller.rb</span>
<span class="line-num">865</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_photos</span>
<span class="line-num">866</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos_locked?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">867</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">868</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">869</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">json:</span> {
<span class="line-num">870</span>           <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_edit_those_photos</span>)
<span class="line-num">871</span>         }
<span class="line-num">872</span>       <span class="ruby-keyword">end</span>
<span class="line-num">873</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">874</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_edit_those_photos</span>)
<span class="line-num">875</span>         <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> ) )
<span class="line-num">876</span>       <span class="ruby-keyword">end</span>
<span class="line-num">877</span>     <span class="ruby-keyword">end</span>
<span class="line-num">878</span>     <span class="ruby-keyword">return</span>
<span class="line-num">879</span>   <span class="ruby-keyword">end</span>
<span class="line-num">880</span>   <span class="ruby-identifier">photos</span> = <span class="ruby-identifier">retrieve_photos</span>
<span class="line-num">881</span>   <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
<span class="line-num">882</span>     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>
<span class="line-num">883</span>   <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">884</span>   <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">photos</span> = <span class="ruby-identifier">photos</span>
<span class="line-num">885</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">save</span>
<span class="line-num">886</span>     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">reload</span>
<span class="line-num">887</span>     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">elastic_index!</span>
<span class="line-num">888</span>   <span class="ruby-keyword">else</span>
<span class="line-num">889</span>     <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Failed to save taxon: #{@taxon.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">890</span>   <span class="ruby-keyword">end</span>
<span class="line-num">891</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">892</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">delay</span>( <span class="ruby-value">priority:</span> <span class="ruby-constant">INTEGRITY_PRIORITY</span> ).<span class="ruby-identifier">update_ancestor_photos</span>( <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">photos</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">893</span>   <span class="ruby-keyword">end</span>
<span class="line-num">894</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">895</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">to_json</span> }
<span class="line-num">896</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">897</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">898</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:taxon_photos_updated</span>)
<span class="line-num">899</span>       <span class="ruby-keyword">else</span>
<span class="line-num">900</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:some_of_those_photos_couldnt_be_saved</span>, <span class="ruby-value">:error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">to_sentence</span>.<span class="ruby-identifier">downcase</span>)
<span class="line-num">901</span>       <span class="ruby-keyword">end</span>
<span class="line-num">902</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> )
<span class="line-num">903</span>     <span class="ruby-keyword">end</span>
<span class="line-num">904</span>   <span class="ruby-keyword">end</span>
<span class="line-num">905</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ETIMEDOUT</span>
<span class="line-num">906</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">907</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:request_timed_out</span>) }, <span class="ruby-value">status:</span> <span class="ruby-value">:request_timeout</span> }
<span class="line-num">908</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">909</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:request_timed_out</span>)
<span class="line-num">910</span>       <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> ) )
<span class="line-num">911</span>     <span class="ruby-keyword">end</span>
<span class="line-num">912</span>   <span class="ruby-keyword">end</span>
<span class="line-num">913</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">APIError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">914</span>   <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/OAuthException/</span>
<span class="line-num">915</span>   <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>(
<span class="line-num">916</span>     <span class="ruby-value">:facebook_needs_the_owner_of_that_photo_to</span>,
<span class="line-num">917</span>     <span class="ruby-value">site_name_short:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">site_name_short</span>
<span class="line-num">918</span>   )
<span class="line-num">919</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">920</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> }, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span> }
<span class="line-num">921</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">any</span> <span class="ruby-keyword">do</span>
<span class="line-num">922</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span> 
<span class="line-num">923</span>       <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">taxon_path</span>( <span class="ruby-ivar">@taxon</span> ) )
<span class="line-num">924</span>     <span class="ruby-keyword">end</span>
<span class="line-num">925</span>   <span class="ruby-keyword">end</span>
<span class="line-num">926</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
