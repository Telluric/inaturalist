<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ratatosk::Ratatosk</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../../">
<meta name="data-tree-keys" content='["Ratatosk", "Ratatosk"]'>


    <meta property="og:title" value="Ratatosk::Ratatosk">

  

    <meta name="keywords" content="Ratatosk::Ratatosk class, new, to_s, find, graft, graft_point_and_lineage, get_graft_point_for, find_existing_taxon, polynom_parent">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Ratatosk::Ratatosk
            
                <span class="parent">&lt;
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../files/lib/ratatosk/lib/ratatosk_rb.html">lib/ratatosk/lib/ratatosk.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-find">find</a>,
              </li>
            
              
              <li>
                <a href="#method-i-find_existing_taxon">find_existing_taxon</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-get_graft_point_for">get_graft_point_for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graft">graft</a>,
              </li>
            
              
              <li>
                <a href="#method-i-graft_point_and_lineage">graft_point_and_lineage</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-polynom_parent">polynom_parent</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>name_providers</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-new">
            
              <b>new</b>(params = {})
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a new <a href="Ratatosk.html"><code>Ratatosk</code></a> instance</p>
<ul><li><dl class="rdoc-list label-list"><dt><a href="Ratatosk.html#attribute-i-name_providers"><code>name_providers</code></a>
<dd>
<p>array of NameProvider instances to use as providers.  Can also be specified as an array of prefixes, e.g. [&#39;col&#39;, &#39;ubio&#39;]</p>
</dd></dl>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                

                

                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">63</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">params</span> = {})
<span class="line-num">64</span>   <span class="ruby-ivar">@name_providers</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:name_providers</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:name_providers</span>].<span class="ruby-identifier">first</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:get_lineage_for</span>)
<span class="line-num">65</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:name_providers</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prefix</span><span class="ruby-operator">|</span>
<span class="line-num">66</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">class_name</span> = <span class="ruby-constant">NameProviders</span>.<span class="ruby-identifier">constants</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-node">&quot;#{prefix.to_s.camelcase}NameProvider&quot;</span>.<span class="ruby-identifier">downcase</span>}
<span class="line-num">67</span>         <span class="ruby-constant">NameProviders</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">class_name</span>).<span class="ruby-identifier">new</span>
<span class="line-num">68</span>       <span class="ruby-keyword">end</span>
<span class="line-num">69</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">70</span>   <span class="ruby-keyword">else</span>
<span class="line-num">71</span>     <span class="ruby-identifier">params</span>[<span class="ruby-value">:name_providers</span>]
<span class="line-num">72</span>   <span class="ruby-keyword">end</span>
<span class="line-num">73</span>   <span class="ruby-comment"># include all name providers by default, starting with the most taxonomically</span>
<span class="line-num">74</span>   <span class="ruby-comment"># and geographically general</span>
<span class="line-num">75</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@name_providers</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">76</span>     <span class="ruby-ivar">@name_providers</span> = [
<span class="line-num">77</span>       <span class="ruby-constant">NameProviders</span><span class="ruby-operator">::</span><span class="ruby-constant">ColNameProvider</span>.<span class="ruby-identifier">new</span>,
<span class="line-num">78</span>       <span class="ruby-constant">NameProviders</span><span class="ruby-operator">::</span><span class="ruby-constant">UBioNameProvider</span>.<span class="ruby-identifier">new</span>,
<span class="line-num">79</span>       <span class="ruby-constant">NameProviders</span><span class="ruby-operator">::</span><span class="ruby-constant">NZORNameProvider</span>.<span class="ruby-identifier">new</span>
<span class="line-num">80</span>     ]
<span class="line-num">81</span>   <span class="ruby-keyword">end</span>
<span class="line-num">82</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-find">
            
              <b>find</b>(q)
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-find" name="method-i-find" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Find a taxon using each of the name providers in sequence, returning the first successful response.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-find_source')" id="l_method-i-find_source">show</a>
                

                

                
              </p>
              <div id="method-i-find_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num"> 92</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find</span>(<span class="ruby-identifier">q</span>)
<span class="line-num"> 93</span>   <span class="ruby-ivar">@name_providers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name_provider</span><span class="ruby-operator">|</span>
<span class="line-num"> 94</span>     <span class="ruby-keyword">begin</span>
<span class="line-num"> 95</span>       <span class="ruby-identifier">names</span> = <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">q</span>)
<span class="line-num"> 96</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num"> 97</span>       <span class="ruby-comment"># skip to next name provider if one times out</span>
<span class="line-num"> 98</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">name_provider</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@name_providers</span>.<span class="ruby-identifier">last</span>
<span class="line-num"> 99</span>         <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
<span class="line-num">100</span>       <span class="ruby-keyword">else</span>
<span class="line-num">101</span>         <span class="ruby-keyword">next</span>
<span class="line-num">102</span>       <span class="ruby-keyword">end</span>
<span class="line-num">103</span>     <span class="ruby-keyword">end</span>
<span class="line-num">104</span>     
<span class="line-num">105</span>     <span class="ruby-comment"># make sure names are unique on name and lexicon</span>
<span class="line-num">106</span>     <span class="ruby-comment"># This is sort of a duplication of the validation that should occur in</span>
<span class="line-num">107</span>     <span class="ruby-comment"># TaxonName, but since all the adapters hold NEW objects at this</span>
<span class="line-num">108</span>     <span class="ruby-comment"># point, two identical names with identical Taxon objects will both</span>
<span class="line-num">109</span>     <span class="ruby-comment"># save as valid, because the Taxon objects are unsaved and the</span>
<span class="line-num">110</span>     <span class="ruby-comment"># validation to keep taxon names unique within a lexicon and a taxon</span>
<span class="line-num">111</span>     <span class="ruby-comment"># will pass because the taxa are different objects from ActiveRecord&#39;s</span>
<span class="line-num">112</span>     <span class="ruby-comment"># point of view.  The alternative would be to ALWAYS save taxon</span>
<span class="line-num">113</span>     <span class="ruby-comment"># objects upon creation in the TaxonNameAdapters, but I tried to avoid</span>
<span class="line-num">114</span>     <span class="ruby-comment"># incurring the DB writing overhead.</span>
<span class="line-num">115</span>     <span class="ruby-identifier">unique_names</span> = {}
<span class="line-num">116</span>     <span class="ruby-identifier">unique_taxa</span> = {}
<span class="line-num">117</span>     <span class="ruby-identifier">names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> 
<span class="line-num">118</span>       <span class="ruby-identifier">phylum_name</span> = <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">get_phylum_for</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>).<span class="ruby-identifier">name</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">119</span>       <span class="ruby-identifier">unique_taxa</span>[[<span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">phylum_name</span>]] <span class="ruby-operator">||=</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">120</span>       <span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">unique_taxa</span>[[<span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">phylum_name</span>]] <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">121</span>       <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">122</span>       <span class="ruby-identifier">unique_names</span>[[<span class="ruby-identifier">n</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">n</span>.<span class="ruby-identifier">lexicon</span>, <span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">phylum_name</span>]] = <span class="ruby-identifier">n</span>
<span class="line-num">123</span>     <span class="ruby-keyword">end</span>
<span class="line-num">124</span>     <span class="ruby-identifier">names</span> = <span class="ruby-identifier">unique_names</span>.<span class="ruby-identifier">values</span>
<span class="line-num">125</span>     
<span class="line-num">126</span>     <span class="ruby-identifier">names</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
<span class="line-num">127</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-operator">&amp;&amp;</span> 
<span class="line-num">128</span>           <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">129</span>           (<span class="ruby-identifier">existing_taxon</span> = <span class="ruby-identifier">find_existing_taxon</span>(<span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span>))
<span class="line-num">130</span>         <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">existing_taxon</span>
<span class="line-num">131</span>       <span class="ruby-keyword">end</span>
<span class="line-num">132</span>       
<span class="line-num">133</span>       <span class="ruby-keyword">unless</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">134</span>         <span class="ruby-comment"># If the name was invalid b/c its taxon was saved first, and the</span>
<span class="line-num">135</span>         <span class="ruby-comment"># taxon made a TaxonName from its own scientific name already,</span>
<span class="line-num">136</span>         <span class="ruby-comment"># just use that scientific name</span>
<span class="line-num">137</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">138</span>           <span class="ruby-identifier">name</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing</span> = <span class="ruby-constant">TaxonName</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;name = ? AND taxon_id = ?&quot;</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon_id</span>).<span class="ruby-identifier">first</span>
<span class="line-num">139</span>             <span class="ruby-identifier">existing</span>
<span class="line-num">140</span>           <span class="ruby-keyword">else</span>
<span class="line-num">141</span>             <span class="ruby-identifier">name</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">taxon_names</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">name</span>}
<span class="line-num">142</span>           <span class="ruby-keyword">end</span>
<span class="line-num">143</span>         
<span class="line-num">144</span>         <span class="ruby-comment"># This *might* be the cause of https://github.com/inaturalist/inaturalist/issues/1602, but it&#39;s really hard to replicate</span>
<span class="line-num">145</span>         <span class="ruby-comment"># # If the taxon was invalid, try to see if something similar has</span>
<span class="line-num">146</span>         <span class="ruby-comment"># # already been saved</span>
<span class="line-num">147</span>         <span class="ruby-comment"># elsif existing = Taxon.where(source_identifier: name.taxon.source_identifier,</span>
<span class="line-num">148</span>         <span class="ruby-comment">#   name_provider: name.taxon.name_provider).first</span>
<span class="line-num">149</span>         <span class="ruby-comment">#   name.taxon = existing</span>
<span class="line-num">150</span>         <span class="ruby-keyword">else</span>
<span class="line-num">151</span>           <span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">152</span>         <span class="ruby-keyword">end</span>
<span class="line-num">153</span>       <span class="ruby-keyword">end</span>
<span class="line-num">154</span>       <span class="ruby-identifier">name</span>
<span class="line-num">155</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">156</span>     
<span class="line-num">157</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">names</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">158</span>   <span class="ruby-keyword">end</span>
<span class="line-num">159</span>   []
<span class="line-num">160</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-find_existing_taxon">
            
              <b>find_existing_taxon</b>(taxon_adapter, name_provider = nil)
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-find_existing_taxon" name="method-i-find_existing_taxon" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-find_existing_taxon_source')" id="l_method-i-find_existing_taxon_source">show</a>
                

                

                
              </p>
              <div id="method-i-find_existing_taxon_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">310</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_existing_taxon</span>(<span class="ruby-identifier">taxon_adapter</span>, <span class="ruby-identifier">name_provider</span> = <span class="ruby-keyword">nil</span>)
<span class="line-num">311</span>   <span class="ruby-identifier">name_provider</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">NameProviders</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">taxon_adapter</span>.<span class="ruby-identifier">name_provider</span>).<span class="ruby-identifier">new</span>
<span class="line-num">312</span>   <span class="ruby-identifier">existing_ancestor</span> = <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">phylum</span> = <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">get_phylum_for</span>( <span class="ruby-identifier">taxon_adapter</span> ) )
<span class="line-num">313</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;lower(name) = ? AND rank = &#39;phylum&#39;&quot;</span>, <span class="ruby-identifier">phylum</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">314</span>   <span class="ruby-keyword">end</span>
<span class="line-num">315</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing_ancestor</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">existing_ancestor</span>.<span class="ruby-identifier">current_synonymous_taxon</span>
<span class="line-num">316</span>     <span class="ruby-identifier">existing_ancestor</span> = <span class="ruby-identifier">existing_ancestor</span>.<span class="ruby-identifier">current_synonymous_taxon</span>
<span class="line-num">317</span>   <span class="ruby-keyword">end</span>
<span class="line-num">318</span>   <span class="ruby-identifier">existing_taxon</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">319</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing_ancestor</span>
<span class="line-num">320</span>     <span class="ruby-identifier">existing_taxon</span> = <span class="ruby-identifier">existing_ancestor</span>.<span class="ruby-identifier">descendants</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(name) = ?&quot;</span>, <span class="ruby-identifier">taxon_adapter</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">first</span>
<span class="line-num">321</span>   <span class="ruby-keyword">end</span>
<span class="line-num">322</span>   <span class="ruby-identifier">existing_taxon</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(name) = ?&quot;</span>, <span class="ruby-identifier">taxon_adapter</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">first</span>
<span class="line-num">323</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_graft_point_for">
            
              <b>get_graft_point_for</b>(lineage)
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-get_graft_point_for" name="method-i-get_graft_point_for" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_graft_point_for_source')" id="l_method-i-get_graft_point_for_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_graft_point_for_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">262</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_graft_point_for</span>(<span class="ruby-identifier">lineage</span>)
<span class="line-num">263</span>   <span class="ruby-identifier">name_provider</span> = <span class="ruby-constant">NameProviders</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">name_provider</span>).<span class="ruby-identifier">new</span>
<span class="line-num">264</span>   <span class="ruby-identifier">new_lineage</span> = []
<span class="line-num">265</span>   <span class="ruby-identifier">graft_point</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">266</span>   
<span class="line-num">267</span>   <span class="ruby-comment"># Exclude non-preferred ranks from lineage</span>
<span class="line-num">268</span>   <span class="ruby-comment"># Note: this coupling to the iNat Taxon class isn&#39;t ideal, and should</span>
<span class="line-num">269</span>   <span class="ruby-comment"># be refactored if this plugin ever needs to be separated.</span>
<span class="line-num">270</span>   <span class="ruby-identifier">lineage</span> = <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tn</span><span class="ruby-operator">|</span>
<span class="line-num">271</span>     <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Taxon</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">tn</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">tn</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">272</span>     <span class="ruby-identifier">rank</span> = <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_EQUIVALENTS</span>[<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">rank</span>
<span class="line-num">273</span>     <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">PREFERRED_RANKS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rank</span>)
<span class="line-num">274</span>   <span class="ruby-keyword">end</span>
<span class="line-num">275</span>   
<span class="line-num">276</span>   <span class="ruby-identifier">ancestor_phylum</span> = <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">get_phylum_for</span>(<span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">lineage</span>)
<span class="line-num">277</span>   <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ancestor</span><span class="ruby-operator">|</span>
<span class="line-num">278</span>     <span class="ruby-identifier">existing_homonyms</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">new_record?</span>
<span class="line-num">279</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">name</span>)
<span class="line-num">280</span>     <span class="ruby-keyword">else</span>
<span class="line-num">281</span>       <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id != ?&quot;</span>, <span class="ruby-identifier">ancestor</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">282</span>     <span class="ruby-keyword">end</span>
<span class="line-num">283</span> 
<span class="line-num">284</span>     <span class="ruby-identifier">graft_point</span> = <span class="ruby-identifier">existing_homonyms</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">homonym</span><span class="ruby-operator">|</span>
<span class="line-num">285</span>       <span class="ruby-identifier">ancestor_phylum</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">homonym</span>.<span class="ruby-identifier">phylum</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ancestor_phylum</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">homonym</span>.<span class="ruby-identifier">phylum</span>.<span class="ruby-identifier">name</span>
<span class="line-num">286</span>     <span class="ruby-keyword">end</span>.<span class="ruby-identifier">first</span>
<span class="line-num">287</span>     
<span class="line-num">288</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing_homonyms</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="line-num">289</span>       <span class="ruby-identifier">graft_point</span> = <span class="ruby-identifier">existing_homonyms</span>.<span class="ruby-identifier">first</span>
<span class="line-num">290</span>       <span class="ruby-identifier">lineage</span> = <span class="ruby-identifier">new_lineage</span>
<span class="line-num">291</span>       <span class="ruby-keyword">break</span>
<span class="line-num">292</span>     <span class="ruby-keyword">end</span>
<span class="line-num">293</span>     
<span class="line-num">294</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">graft_point</span>
<span class="line-num">295</span>       <span class="ruby-identifier">lineage</span> = <span class="ruby-identifier">new_lineage</span>
<span class="line-num">296</span>       <span class="ruby-keyword">break</span>
<span class="line-num">297</span>     <span class="ruby-keyword">end</span>
<span class="line-num">298</span> 
<span class="line-num">299</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">existing_homonyms</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">300</span>       <span class="ruby-comment"># Do not import ancestors that probably already exist in the db</span>
<span class="line-num">301</span>       <span class="ruby-keyword">break</span>
<span class="line-num">302</span>     <span class="ruby-keyword">end</span>
<span class="line-num">303</span>     
<span class="line-num">304</span>     <span class="ruby-identifier">new_lineage</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ancestor</span>
<span class="line-num">305</span>   <span class="ruby-keyword">end</span>
<span class="line-num">306</span>   <span class="ruby-identifier">graft_point</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-string">&#39;Life&#39;</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">root</span>
<span class="line-num">307</span>   [<span class="ruby-identifier">graft_point</span>, <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">compact</span>]
<span class="line-num">308</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graft">
            
              <b>graft</b>(taxon, options = {})
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-graft" name="method-i-graft" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Take an ungrafted taxon and find its ancestor taxa from itself to an existing taxon in our tree, saving any new members of this branch and attaching it to the existing taxon (the graft point).</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graft_source')" id="l_method-i-graft_source">show</a>
                

                

                
              </p>
              <div id="method-i-graft_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">167</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graft</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">168</span>   <span class="ruby-comment"># if this is an adapter of some kind, just get the underlying Taxon</span>
<span class="line-num">169</span>   <span class="ruby-comment"># object. It will smooth the way with nested_set...</span>
<span class="line-num">170</span>   <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Taxon</span>
<span class="line-num">171</span>   <span class="ruby-identifier">raise</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-string">&quot;Can&#39;t graft unsaved taxa&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">new_record?</span>
<span class="line-num">172</span> 
<span class="line-num">173</span>   <span class="ruby-identifier">graft_point</span>, <span class="ruby-identifier">lineage</span> = <span class="ruby-identifier">graft_point_and_lineage</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span>)
<span class="line-num">174</span> 
<span class="line-num">175</span>   <span class="ruby-comment"># Return an empty lineage if this has already been grafted</span>
<span class="line-num">176</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">177</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">parent</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">last</span>
<span class="line-num">178</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">grafted?</span>
<span class="line-num">179</span>   <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">graft_point</span>
<span class="line-num">180</span>   
<span class="line-num">181</span>   <span class="ruby-identifier">raise</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-string">&quot;destination covered by curated taxon framework&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">graft_point</span>.<span class="ruby-identifier">can_be_grafted_to</span>
<span class="line-num">182</span> 
<span class="line-num">183</span>   <span class="ruby-comment"># For each new taxon (starting with the highest), move it to the graft</span>
<span class="line-num">184</span>   <span class="ruby-comment"># point, moving the point as we walk along the branch</span>
<span class="line-num">185</span>   <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">new_taxon</span><span class="ruby-operator">|</span>
<span class="line-num">186</span>     <span class="ruby-identifier">new_taxon</span> = <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">taxon</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Taxon</span>
<span class="line-num">187</span>     <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">save</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-comment"># can&#39;t move new nodes</span>
<span class="line-num">188</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">189</span>       <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;Failed to graft #{new_taxon} because it was invalid: &quot;</span> <span class="ruby-operator">+</span> 
<span class="line-num">190</span>         <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;, &#39;</span>)
<span class="line-num">191</span>       <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;[ERROR] #{msg}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">logger</span>
<span class="line-num">192</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-identifier">msg</span>
<span class="line-num">193</span>     <span class="ruby-keyword">end</span>
<span class="line-num">194</span>     <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">set_scientific_taxon_name</span>
<span class="line-num">195</span>     <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">move_to_child_of</span>(<span class="ruby-identifier">graft_point</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">persisted?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">graft_point</span>.<span class="ruby-identifier">persisted?</span>
<span class="line-num">196</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">197</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:ancestry</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/locked/</span>
<span class="line-num">198</span>         <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;it failed to graft to #{graft_point.name}, which &quot;</span>
<span class="line-num">199</span>         <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">locked?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;is locked. &quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;descends from a locked taxon. &quot;</span>
<span class="line-num">200</span>         <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;Please merge or delete, or edit and add it if it&#39;s legit.&quot;</span>
<span class="line-num">201</span>         <span class="ruby-identifier">f</span> = <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">flags</span>.<span class="ruby-identifier">build</span>(<span class="ruby-value">:flag</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>) 
<span class="line-num">202</span>         <span class="ruby-keyword">unless</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">save</span>
<span class="line-num">203</span>           <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Failed to save flag: #{f.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">204</span>         <span class="ruby-keyword">end</span>
<span class="line-num">205</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:ancestry</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/taxon framework/</span>
<span class="line-num">206</span>           <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;it failed to graft to #{graft_point.name}, which &quot;</span>
<span class="line-num">207</span>           <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;is covered by a curated taxon framework. &quot;</span>
<span class="line-num">208</span>           <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;This should be reviewed by the appropriate taxon curator&quot;</span>
<span class="line-num">209</span>           <span class="ruby-identifier">f</span> = <span class="ruby-identifier">new_taxon</span>.<span class="ruby-identifier">flags</span>.<span class="ruby-identifier">build</span>(<span class="ruby-value">:flag</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">msg</span>) 
<span class="line-num">210</span>           <span class="ruby-keyword">unless</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">save</span>
<span class="line-num">211</span>             <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Failed to save flag: #{f.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">212</span>           <span class="ruby-keyword">end</span>
<span class="line-num">213</span>       <span class="ruby-keyword">else</span>
<span class="line-num">214</span>         <span class="ruby-identifier">raise</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-node">&quot;New taxon had errors: #{new_taxon.errors.full_messages.to_sentence}&quot;</span>
<span class="line-num">215</span>       <span class="ruby-keyword">end</span>
<span class="line-num">216</span>     <span class="ruby-keyword">end</span>
<span class="line-num">217</span>     <span class="ruby-identifier">graft_point</span> = <span class="ruby-identifier">new_taxon</span>
<span class="line-num">218</span>   <span class="ruby-keyword">end</span>
<span class="line-num">219</span> 
<span class="line-num">220</span>   <span class="ruby-identifier">lineage</span>
<span class="line-num">221</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-graft_point_and_lineage">
            
              <b>graft_point_and_lineage</b>(taxon, options = {})
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-graft_point_and_lineage" name="method-i-graft_point_and_lineage" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-graft_point_and_lineage_source')" id="l_method-i-graft_point_and_lineage_source">show</a>
                

                

                
              </p>
              <div id="method-i-graft_point_and_lineage_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">223</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">graft_point_and_lineage</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">224</span>   <span class="ruby-comment"># Try a simple polynom lookup first</span>
<span class="line-num">225</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">polynom_parent</span>(<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>)
<span class="line-num">226</span>     <span class="ruby-keyword">return</span> [<span class="ruby-identifier">parent</span>, [<span class="ruby-identifier">taxon</span>]]
<span class="line-num">227</span>   <span class="ruby-keyword">end</span>
<span class="line-num">228</span>   
<span class="line-num">229</span>   <span class="ruby-comment"># retrieve the Name Provider used to find this taxon</span>
<span class="line-num">230</span>   <span class="ruby-identifier">name_provider</span> = <span class="ruby-ivar">@name_providers</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">np</span><span class="ruby-operator">|</span>
<span class="line-num">231</span>     <span class="ruby-identifier">np</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name_provider</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">np</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;::&#39;</span>).<span class="ruby-identifier">last</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name_provider</span>
<span class="line-num">232</span>   <span class="ruby-keyword">end</span>
<span class="line-num">233</span>   <span class="ruby-identifier">name_provider</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">NameProviders</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name_provider</span>).<span class="ruby-identifier">new</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
<span class="line-num">234</span>   <span class="ruby-identifier">lineage</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">nil?</span>
<span class="line-num">235</span>     [<span class="ruby-identifier">taxon</span>]
<span class="line-num">236</span>   <span class="ruby-keyword">else</span>
<span class="line-num">237</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">238</span>       <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">get_lineage_for</span>(<span class="ruby-identifier">taxon</span>)
<span class="line-num">239</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">NameProviderError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">240</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">RatatoskGraftError</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="line-num">241</span>     <span class="ruby-keyword">end</span>
<span class="line-num">242</span>   <span class="ruby-keyword">end</span>
<span class="line-num">243</span>   
<span class="line-num">244</span>   <span class="ruby-comment"># This basically means the name provider wasn&#39;t able to find a lineage</span>
<span class="line-num">245</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">rank_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">RANK_LEVELS</span>[<span class="ruby-string">&#39;phylum&#39;</span>]
<span class="line-num">246</span>     <span class="ruby-comment"># try retrieving an external parent based on a polynom, e.g. if the</span>
<span class="line-num">247</span>     <span class="ruby-comment"># name is Homo sapiens and there&#39;s no Homo taxon, try to get Homo from</span>
<span class="line-num">248</span>     <span class="ruby-comment"># the NameProvider</span>
<span class="line-num">249</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">polynom_parent</span>(<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:external_parent</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>))
<span class="line-num">250</span>       <span class="ruby-identifier">taxon_phylum</span> = <span class="ruby-identifier">name_provider</span>.<span class="ruby-identifier">get_phylum_for</span>(<span class="ruby-identifier">taxon</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">name_provider</span>
<span class="line-num">251</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">phylum</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">taxon_phylum</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">phylum</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">taxon_phylum</span>.<span class="ruby-identifier">name</span>
<span class="line-num">252</span>         <span class="ruby-keyword">return</span> [<span class="ruby-identifier">parent</span>, [<span class="ruby-identifier">taxon</span>]]
<span class="line-num">253</span>       <span class="ruby-keyword">end</span>
<span class="line-num">254</span>     <span class="ruby-keyword">end</span>
<span class="line-num">255</span>     <span class="ruby-keyword">return</span> [<span class="ruby-identifier">lineage</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">lineage</span>]
<span class="line-num">256</span>   <span class="ruby-keyword">end</span>
<span class="line-num">257</span>   
<span class="line-num">258</span>   <span class="ruby-comment"># Set the point on the tree to which we will graft, default is root</span>
<span class="line-num">259</span>   <span class="ruby-identifier">get_graft_point_for</span>(<span class="ruby-identifier">lineage</span>)
<span class="line-num">260</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s</b>()
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                

                

                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">84</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_s</span>
<span class="line-num">85</span>   <span class="ruby-string">&quot;&lt;Ratatosk: I am Ratatosk, the Dark Squirrel of Doom!&gt;&quot;</span>
<span class="line-num">86</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
      <h2 class="sectiontitle">Instance Protected methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-polynom_parent">
            
              <b>polynom_parent</b>(name, options = {})
            
            <a href="../../classes/Ratatosk/Ratatosk.html#method-i-polynom_parent" name="method-i-polynom_parent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Try to find the parent taxon given a polynomial name, e.g. Homo sapiens (a binom) or Ensatina eschscholtzii xanthoptica (a trinom).  Returns nil if none found or if not a polynom.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-polynom_parent_source')" id="l_method-i-polynom_parent_source">show</a>
                

                

                
              </p>
              <div id="method-i-polynom_parent_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File lib/ratatosk/lib/ratatosk.rb</span>
<span class="line-num">332</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">polynom_parent</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {})
<span class="line-num">333</span>   <span class="ruby-identifier">parent_name</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\s+\s+/</span>
<span class="line-num">334</span>     <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">first</span>
<span class="line-num">335</span>   <span class="ruby-keyword">else</span>
<span class="line-num">336</span>     <span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39; &#39;</span>)
<span class="line-num">337</span>   <span class="ruby-keyword">end</span>
<span class="line-num">338</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent_name</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">339</span>   <span class="ruby-identifier">parent</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>]
<span class="line-num">340</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">options</span>[<span class="ruby-value">:ancestor</span>].<span class="ruby-identifier">descendant_conditions</span> ).
<span class="line-num">341</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;name = ?&quot;</span>, <span class="ruby-identifier">parent_name</span> ).
<span class="line-num">342</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;rank IN (?)&quot;</span>, [<span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">GENUS</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">343</span>   <span class="ruby-keyword">else</span>
<span class="line-num">344</span>     <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;rank IN (?)&quot;</span>, [<span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">GENUS</span>, <span class="ruby-constant">Taxon</span><span class="ruby-operator">::</span><span class="ruby-constant">SPECIES</span>] ).
<span class="line-num">345</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">name:</span> <span class="ruby-identifier">parent_name</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">346</span>   <span class="ruby-keyword">end</span>
<span class="line-num">347</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:external_parent</span>]
<span class="line-num">348</span>     <span class="ruby-identifier">names</span> = <span class="ruby-identifier">find</span>(<span class="ruby-identifier">parent_name</span>)
<span class="line-num">349</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">parent_name</span>}
<span class="line-num">350</span>       <span class="ruby-identifier">match</span>.<span class="ruby-identifier">save</span>
<span class="line-num">351</span>       <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">match</span>.<span class="ruby-identifier">taxon</span>
<span class="line-num">352</span>       <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">graft_silently</span>
<span class="line-num">353</span>     <span class="ruby-keyword">end</span>
<span class="line-num">354</span>   <span class="ruby-keyword">end</span>
<span class="line-num">355</span>   <span class="ruby-identifier">parent</span>
<span class="line-num">356</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
