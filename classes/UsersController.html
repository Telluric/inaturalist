<!DOCTYPE html>
<html lang="en">
<head>
    <title>UsersController</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/turbolinks.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/search_index.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../panel/tree.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/searchdoc.js" type="text/javascript" charset="utf-8"></script>
<meta name="data-rel-prefix" content="../">
<meta name="data-tree-keys" content='["UsersController"]'>


    <meta property="og:title" value="UsersController">

  
    
    <meta name="description" content="encoding: utf-8.">
    <meta property="og:description" content="encoding: utf-8.">
  

    <meta name="keywords" content="UsersController class, suspend, unsuspend, add_role, remove_role, delete, destroy, set_spammer, index, leaderboard, show, followers, following, relationships, get_nearby_taxa_obs_counts, get_local_onboarding_content, dashboard_updates, dashboard, updates_count, new_updates, edit, edit_after_auth, update, curation, recent, merge, update_session, api_token, join_test, leave_test, trust, untrust, parental_consent, mute, unmute, block, unblock, moderation, add_friend, remove_friend, update_password, find_user, ensure_user_is_current_user_or_admin, counts_for_users, most_observations, most_species, most_identifications, permit_params, before_edit, site_admin_of_user_required">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            UsersController
            
                <span class="parent">&lt;
                    
                    <a href="ApplicationController.html">ApplicationController</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../files/app/controllers/users_controller_rb.html">app/controllers/users_controller.rb</a></li>
            
        </ul>
        
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>encoding: utf-8</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add_friend">add_friend</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_role">add_role</a>,
              </li>
            
              
              <li>
                <a href="#method-i-api_token">api_token</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-before_edit">before_edit</a>,
              </li>
            
              
              <li>
                <a href="#method-i-block">block</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-counts_for_users">counts_for_users</a>,
              </li>
            
              
              <li>
                <a href="#method-i-curation">curation</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-dashboard">dashboard</a>,
              </li>
            
              
              <li>
                <a href="#method-i-dashboard_updates">dashboard_updates</a>,
              </li>
            
              
              <li>
                <a href="#method-i-delete">delete</a>,
              </li>
            
              
              <li>
                <a href="#method-i-destroy">destroy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-edit">edit</a>,
              </li>
            
              
              <li>
                <a href="#method-i-edit_after_auth">edit_after_auth</a>,
              </li>
            
              
              <li>
                <a href="#method-i-ensure_user_is_current_user_or_admin">ensure_user_is_current_user_or_admin</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-find_user">find_user</a>,
              </li>
            
              
              <li>
                <a href="#method-i-followers">followers</a>,
              </li>
            
              
              <li>
                <a href="#method-i-following">following</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-get_local_onboarding_content">get_local_onboarding_content</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_nearby_taxa_obs_counts">get_nearby_taxa_obs_counts</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-index">index</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>J</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-join_test">join_test</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-leaderboard">leaderboard</a>,
              </li>
            
              
              <li>
                <a href="#method-i-leave_test">leave_test</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-merge">merge</a>,
              </li>
            
              
              <li>
                <a href="#method-i-moderation">moderation</a>,
              </li>
            
              
              <li>
                <a href="#method-i-most_identifications">most_identifications</a>,
              </li>
            
              
              <li>
                <a href="#method-i-most_observations">most_observations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-most_species">most_species</a>,
              </li>
            
              
              <li>
                <a href="#method-i-mute">mute</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-new_updates">new_updates</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-parental_consent">parental_consent</a>,
              </li>
            
              
              <li>
                <a href="#method-i-permit_params">permit_params</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-recent">recent</a>,
              </li>
            
              
              <li>
                <a href="#method-i-relationships">relationships</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_friend">remove_friend</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remove_role">remove_role</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-set_spammer">set_spammer</a>,
              </li>
            
              
              <li>
                <a href="#method-i-show">show</a>,
              </li>
            
              
              <li>
                <a href="#method-i-site_admin_of_user_required">site_admin_of_user_required</a>,
              </li>
            
              
              <li>
                <a href="#method-i-suspend">suspend</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-trust">trust</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-unblock">unblock</a>,
              </li>
            
              
              <li>
                <a href="#method-i-unmute">unmute</a>,
              </li>
            
              
              <li>
                <a href="#method-i-unsuspend">unsuspend</a>,
              </li>
            
              
              <li>
                <a href="#method-i-untrust">untrust</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update">update</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_password">update_password</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_session">update_session</a>,
              </li>
            
              
              <li>
                <a href="#method-i-updates_count">updates_count</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-add_role">
            
              <b>add_role</b>()
            
            <a href="../classes/UsersController.html#method-i-add_role" name="method-i-add_role" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_role_source')" id="l_method-i-add_role_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_role_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num"> 94</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_role</span>
<span class="line-num"> 95</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@role</span> = <span class="ruby-constant">Role</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:role</span>])
<span class="line-num"> 96</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_role_doesnt_exist</span>)
<span class="line-num"> 97</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num"> 98</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 99</span>   
<span class="line-num">100</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">is_admin?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">101</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>)
<span class="line-num">102</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num">103</span>   <span class="ruby-keyword">end</span>
<span class="line-num">104</span> 
<span class="line-num">105</span>   <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">roles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@role</span>
<span class="line-num">106</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@role</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">===</span> <span class="ruby-constant">Role</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>
<span class="line-num">107</span>     <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">curator_sponsor:</span> <span class="ruby-identifier">current_user</span> )
<span class="line-num">108</span>   <span class="ruby-keyword">end</span>
<span class="line-num">109</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;Added #{@role.name} status to #{@user.login}&quot;</span>
<span class="line-num">110</span>   <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num">111</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-api_token">
            
              <b>api_token</b>()
            
            <a href="../classes/UsersController.html#method-i-api_token" name="method-i-api_token" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-api_token_source')" id="l_method-i-api_token_source">show</a>
                

                

                
              </p>
              <div id="method-i-api_token_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">832</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">api_token</span>
<span class="line-num">833</span>   <span class="ruby-comment"># not sure why current_user would be nil here, but sometimes it is</span>
<span class="line-num">834</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">login_path</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>
<span class="line-num">835</span>   <span class="ruby-identifier">payload</span> = { <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> }
<span class="line-num">836</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">doorkeeper_token</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">a</span> = <span class="ruby-identifier">doorkeeper_token</span>.<span class="ruby-identifier">application</span>)
<span class="line-num">837</span>     <span class="ruby-identifier">payload</span>[<span class="ruby-value">:oauth_application_id</span>] = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">becomes</span>( <span class="ruby-constant">OauthApplication</span> ).<span class="ruby-identifier">id</span>
<span class="line-num">838</span>   <span class="ruby-keyword">end</span>
<span class="line-num">839</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">api_token:</span> <span class="ruby-constant">JsonWebToken</span>.<span class="ruby-identifier">encode</span>( <span class="ruby-identifier">payload</span> ) }
<span class="line-num">840</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-block">
            
              <b>block</b>()
            
            <a href="../classes/UsersController.html#method-i-block" name="method-i-block" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-block_source')" id="l_method-i-block_source">show</a>
                

                

                
              </p>
              <div id="method-i-block_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">931</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">block</span>
<span class="line-num">932</span>   <span class="ruby-ivar">@user_block</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_blocks</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">blocked_user_id:</span> <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">933</span>   <span class="ruby-ivar">@user_block</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_blocks</span>.<span class="ruby-identifier">create</span>( <span class="ruby-value">blocked_user:</span> <span class="ruby-ivar">@user</span> )
<span class="line-num">934</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">935</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">936</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_block</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">937</span>         <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">938</span>       <span class="ruby-keyword">else</span>
<span class="line-num">939</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">errors:</span> <span class="ruby-ivar">@user_block</span>.<span class="ruby-identifier">errors</span> }
<span class="line-num">940</span>       <span class="ruby-keyword">end</span>
<span class="line-num">941</span>     <span class="ruby-keyword">end</span>
<span class="line-num">942</span>   <span class="ruby-keyword">end</span>
<span class="line-num">943</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-curation">
            
              <b>curation</b>()
            
            <a href="../classes/UsersController.html#method-i-curation" name="method-i-curation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-curation_source')" id="l_method-i-curation_source">show</a>
                

                

                
              </p>
              <div id="method-i-curation_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">701</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">curation</span>
<span class="line-num">702</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">703</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>]).<span class="ruby-identifier">order</span>(<span class="ruby-value">id:</span> <span class="ruby-value">:desc</span>)
<span class="line-num">704</span>     <span class="ruby-ivar">@comment_counts_by_user_id</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-ivar">@users</span>).<span class="ruby-identifier">group</span>(<span class="ruby-value">:user_id</span>).<span class="ruby-identifier">count</span>
<span class="line-num">705</span>   <span class="ruby-keyword">else</span>
<span class="line-num">706</span>     <span class="ruby-ivar">@display_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_i</span>)
<span class="line-num">707</span>     <span class="ruby-ivar">@display_user</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">708</span>     <span class="ruby-ivar">@display_user</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_email</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">709</span>     <span class="ruby-ivar">@display_user</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;email ILIKE ?&quot;</span>, <span class="ruby-node">&quot;%#{params[:id]}%&quot;</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">710</span>     <span class="ruby-ivar">@display_user</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">elastic_paginate</span>( <span class="ruby-value">query:</span> {
<span class="line-num">711</span>       <span class="ruby-value">bool:</span> {
<span class="line-num">712</span>         <span class="ruby-value">should:</span> [
<span class="line-num">713</span>           { <span class="ruby-value">match:</span> { <span class="ruby-value">name:</span> { <span class="ruby-value">query:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>], <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span> } } },
<span class="line-num">714</span>           { <span class="ruby-value">match:</span> { <span class="ruby-value">login:</span> { <span class="ruby-value">query:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>], <span class="ruby-value">operator:</span> <span class="ruby-string">&quot;and&quot;</span> } } }
<span class="line-num">715</span>         ]
<span class="line-num">716</span>       }
<span class="line-num">717</span>     } ).<span class="ruby-identifier">first</span>
<span class="line-num">718</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">719</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:couldnt_find_a_user_matching_x_param</span>, <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">720</span>     <span class="ruby-keyword">else</span>
<span class="line-num">721</span>       <span class="ruby-ivar">@observations</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>( <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">722</span>     <span class="ruby-keyword">end</span>
<span class="line-num">723</span>   <span class="ruby-keyword">end</span>
<span class="line-num">724</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">725</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span> }
<span class="line-num">726</span>   <span class="ruby-keyword">end</span>
<span class="line-num">727</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-dashboard">
            
              <b>dashboard</b>()
            
            <a href="../classes/UsersController.html#method-i-dashboard" name="method-i-dashboard" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-dashboard_source')" id="l_method-i-dashboard_source">show</a>
                

                

                
              </p>
              <div id="method-i-dashboard_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">472</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">dashboard</span>
<span class="line-num">473</span>   <span class="ruby-ivar">@has_updates</span> = (<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
<span class="line-num">474</span>   <span class="ruby-comment"># onboarding content not shown in the dashboard if a user has updates</span>
<span class="line-num">475</span>   <span class="ruby-ivar">@local_onboarding_content</span> = <span class="ruby-ivar">@has_updates</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">get_local_onboarding_content</span>
<span class="line-num">476</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@site</span>.<span class="ruby-identifier">discourse_url</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@discourse_url</span> = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">discourse_url</span>
<span class="line-num">477</span>     <span class="ruby-identifier">cache_key</span> = <span class="ruby-node">&quot;dashboard-discourse-data-#{@site.id}&quot;</span>
<span class="line-num">478</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">479</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">discourse_category</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">480</span>         <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;#{@discourse_url}/latest.json?order=created&quot;</span>
<span class="line-num">481</span>         <span class="ruby-ivar">@discourse_topics_url</span> = <span class="ruby-ivar">@discourse_url</span>
<span class="line-num">482</span>       <span class="ruby-keyword">else</span>
<span class="line-num">483</span>         <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;#{@discourse_url}/c/#{@site.discourse_category}.json?order=created&quot;</span>
<span class="line-num">484</span>         <span class="ruby-ivar">@discourse_topics_url</span> = <span class="ruby-node">&quot;#{@discourse_url}/c/#{@site.discourse_category}&quot;</span>
<span class="line-num">485</span>       <span class="ruby-keyword">end</span>
<span class="line-num">486</span>       <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@discourse_data</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">read</span>( <span class="ruby-identifier">cache_key</span> )
<span class="line-num">487</span>         <span class="ruby-ivar">@discourse_data</span> = {}
<span class="line-num">488</span>         <span class="ruby-ivar">@discourse_data</span>[<span class="ruby-value">:categories</span>] = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(
<span class="line-num">489</span>           <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">execute</span>( <span class="ruby-value">method:</span> <span class="ruby-string">&quot;get&quot;</span>,
<span class="line-num">490</span>             <span class="ruby-value">url:</span> <span class="ruby-node">&quot;#{@discourse_url}/categories.json&quot;</span>, <span class="ruby-value">open_timeout:</span> <span class="ruby-value">1</span>, <span class="ruby-value">timeout:</span> <span class="ruby-value">5</span> ).<span class="ruby-identifier">body</span>
<span class="line-num">491</span>         )[<span class="ruby-string">&quot;category_list&quot;</span>][<span class="ruby-string">&quot;categories&quot;</span>].<span class="ruby-identifier">index_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;id&quot;</span>]}
<span class="line-num">492</span>         <span class="ruby-identifier">forum_feedback_category</span> = <span class="ruby-ivar">@discourse_data</span>[<span class="ruby-value">:categories</span>].<span class="ruby-identifier">values</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;name&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Forum Feedback&quot;</span>}
<span class="line-num">493</span>         <span class="ruby-ivar">@discourse_data</span>[<span class="ruby-value">:topics</span>] = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(
<span class="line-num">494</span>           <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">execute</span>(
<span class="line-num">495</span>             <span class="ruby-value">method:</span> <span class="ruby-string">&quot;get&quot;</span>,
<span class="line-num">496</span>             <span class="ruby-value">url:</span> <span class="ruby-identifier">url</span>,
<span class="line-num">497</span>             <span class="ruby-value">open_timeout:</span> <span class="ruby-value">1</span>,
<span class="line-num">498</span>             <span class="ruby-value">timeout:</span> <span class="ruby-value">5</span>
<span class="line-num">499</span>           ).<span class="ruby-identifier">body</span>
<span class="line-num">500</span>         )[<span class="ruby-string">&quot;topic_list&quot;</span>][<span class="ruby-string">&quot;topics&quot;</span>].<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span>
<span class="line-num">501</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>[<span class="ruby-string">&quot;pinned&quot;</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">502</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>[<span class="ruby-string">&quot;closed&quot;</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">503</span>           <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>[<span class="ruby-string">&quot;has_accepted_answer&quot;</span>] <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">504</span>           <span class="ruby-comment"># Remove posts in the Forum Feedback category</span>
<span class="line-num">505</span>           (
<span class="line-num">506</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>[<span class="ruby-string">&quot;category_id&quot;</span>] <span class="ruby-operator">||</span>
<span class="line-num">507</span>             <span class="ruby-operator">!</span><span class="ruby-identifier">forum_feedback_category</span> <span class="ruby-operator">||</span>
<span class="line-num">508</span>             <span class="ruby-identifier">t</span>[<span class="ruby-string">&quot;category_id&quot;</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">forum_feedback_category</span>[<span class="ruby-string">&quot;id&quot;</span>]
<span class="line-num">509</span>           )
<span class="line-num">510</span>         }[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">5</span>]
<span class="line-num">511</span>         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">cache_key</span>, <span class="ruby-ivar">@discourse_data</span>, <span class="ruby-value">expires_in:</span> <span class="ruby-value">15</span>.<span class="ruby-identifier">minutes</span> )
<span class="line-num">512</span>       <span class="ruby-keyword">end</span>
<span class="line-num">513</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">SocketError</span>, <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">RestClient</span><span class="ruby-operator">::</span><span class="ruby-constant">Exceptions</span><span class="ruby-operator">::</span><span class="ruby-constant">Timeout</span>
<span class="line-num">514</span>       <span class="ruby-ivar">@discourse_data</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">515</span>       <span class="ruby-comment"># No connection or other connection issue</span>
<span class="line-num">516</span>       <span class="ruby-keyword">nil</span>
<span class="line-num">517</span>     <span class="ruby-keyword">end</span>
<span class="line-num">518</span>   <span class="ruby-keyword">end</span>
<span class="line-num">519</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">520</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">521</span>       <span class="ruby-ivar">@announcements</span> = [
<span class="line-num">522</span>         <span class="ruby-constant">Announcement</span>.<span class="ruby-identifier">active_in_placement</span>( <span class="ruby-string">&quot;users/dashboard&quot;</span>, <span class="ruby-ivar">@site</span>),
<span class="line-num">523</span>         <span class="ruby-constant">Announcement</span>.<span class="ruby-identifier">active_in_placement</span>( <span class="ruby-string">&quot;users/dashboard#sidebar&quot;</span>, <span class="ruby-ivar">@site</span> )
<span class="line-num">524</span>       ].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
<span class="line-num">525</span>       <span class="ruby-ivar">@subscriptions</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">subscriptions</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:resource</span>).
<span class="line-num">526</span>         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;resource_type in (&#39;Place&#39;, &#39;Taxon&#39;)&quot;</span>).
<span class="line-num">527</span>         <span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">528</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_curator?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">529</span>         <span class="ruby-ivar">@flags</span> = <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id desc&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;resolved = ? AND (user_id != 0 OR (user_id = 0 AND flaggable_type = &#39;Taxon&#39;))&quot;</span>, <span class="ruby-keyword">false</span>).
<span class="line-num">530</span>           <span class="ruby-identifier">includes</span>(<span class="ruby-value">:user</span>, <span class="ruby-value">:resolver</span>, <span class="ruby-value">:comments</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>)
<span class="line-num">531</span>         <span class="ruby-ivar">@ungrafted_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;id desc&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;ancestry IS NULL&quot;</span>).
<span class="line-num">532</span>           <span class="ruby-identifier">includes</span>(<span class="ruby-value">:taxon_names</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">active</span>
<span class="line-num">533</span>       <span class="ruby-keyword">end</span>
<span class="line-num">534</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">535</span>     <span class="ruby-keyword">end</span>
<span class="line-num">536</span>   <span class="ruby-keyword">end</span>
<span class="line-num">537</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-dashboard_updates">
            
              <b>dashboard_updates</b>()
            
            <a href="../classes/UsersController.html#method-i-dashboard_updates" name="method-i-dashboard_updates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-dashboard_updates_source')" id="l_method-i-dashboard_updates_source">show</a>
                

                

                
              </p>
              <div id="method-i-dashboard_updates_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">432</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">dashboard_updates</span>
<span class="line-num">433</span>   <span class="ruby-identifier">filters</span> = [ ]
<span class="line-num">434</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from</span>]
<span class="line-num">435</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">id:</span> { <span class="ruby-value">lt:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from</span>] } } }
<span class="line-num">436</span>   <span class="ruby-keyword">end</span>
<span class="line-num">437</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:notifier_type</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">438</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">notifier_type:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:notifier_type</span>] } }
<span class="line-num">439</span>   <span class="ruby-keyword">end</span>
<span class="line-num">440</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:filter</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;you&quot;</span>
<span class="line-num">441</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">resource_owner_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> } }
<span class="line-num">442</span>     <span class="ruby-ivar">@you</span> = <span class="ruby-keyword">true</span>
<span class="line-num">443</span>   <span class="ruby-keyword">end</span>
<span class="line-num">444</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:filter</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;following&quot;</span>
<span class="line-num">445</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">notification:</span> <span class="ruby-node">%w(created_observations new_observations)</span> } }
<span class="line-num">446</span>   <span class="ruby-keyword">end</span>
<span class="line-num">447</span>   
<span class="line-num">448</span>   <span class="ruby-ivar">@pagination_updates</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>(
<span class="line-num">449</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">50</span>)
<span class="line-num">450</span>   <span class="ruby-ivar">@updates</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">load_additional_activity_updates</span>(<span class="ruby-ivar">@pagination_updates</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">451</span>   <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@updates</span>, [ <span class="ruby-value">:resource</span>, <span class="ruby-value">:notifier</span>, <span class="ruby-value">:resource_owner</span> ])
<span class="line-num">452</span>   <span class="ruby-identifier">obs</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">components_of_class</span>(<span class="ruby-constant">Observation</span>, <span class="ruby-ivar">@updates</span>)
<span class="line-num">453</span>   <span class="ruby-identifier">taxa</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">components_of_class</span>(<span class="ruby-constant">Taxon</span>, <span class="ruby-ivar">@updates</span>)
<span class="line-num">454</span>   <span class="ruby-identifier">with_taxa</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">components_with_assoc</span>(<span class="ruby-value">:taxon</span>, <span class="ruby-ivar">@updates</span>)
<span class="line-num">455</span>   <span class="ruby-identifier">with_user</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">components_with_assoc</span>(<span class="ruby-value">:user</span>, <span class="ruby-ivar">@updates</span>)
<span class="line-num">456</span>   <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">obs</span>, [<span class="ruby-value">:comments</span>, <span class="ruby-value">:identifications</span>, <span class="ruby-value">:photos</span>])
<span class="line-num">457</span>   <span class="ruby-identifier">with_taxa</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:identifications</span>).<span class="ruby-identifier">flatten</span>
<span class="line-num">458</span>   <span class="ruby-identifier">with_user</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:identifications</span>).<span class="ruby-identifier">flatten</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">obs</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:comments</span>).<span class="ruby-identifier">flatten</span>
<span class="line-num">459</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">with_taxa</span>, <span class="ruby-value">:taxon</span>)
<span class="line-num">460</span>   <span class="ruby-identifier">taxa</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">with_taxa</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:taxon</span>)
<span class="line-num">461</span>   <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">taxa</span>, { <span class="ruby-value">taxon_names:</span> <span class="ruby-value">:place_taxon_names</span> })
<span class="line-num">462</span>   <span class="ruby-constant">User</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">with_user</span>, <span class="ruby-value">:user</span>)
<span class="line-num">463</span>   <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">delete_if</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">resource</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">notifier</span>.<span class="ruby-identifier">nil?</span> }
<span class="line-num">464</span>   <span class="ruby-ivar">@grouped_updates</span> = <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">group_and_sort</span>(<span class="ruby-ivar">@updates</span>, <span class="ruby-value">hour_groups:</span> <span class="ruby-keyword">true</span>)
<span class="line-num">465</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">466</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">467</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;dashboard_updates&#39;</span>, <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>
<span class="line-num">468</span>     <span class="ruby-keyword">end</span>
<span class="line-num">469</span>   <span class="ruby-keyword">end</span>
<span class="line-num">470</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-delete">
            
              <b>delete</b>()
            
            <a href="../classes/UsersController.html#method-i-delete" name="method-i-delete" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-delete_source')" id="l_method-i-delete_source">show</a>
                

                

                
              </p>
              <div id="method-i-delete_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">135</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">delete</span>
<span class="line-num">136</span>   <span class="ruby-ivar">@observations_count</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">observations_count</span>
<span class="line-num">137</span>   <span class="ruby-ivar">@helpers_count</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">get</span>( <span class="ruby-string">&quot;/observations/identifiers&quot;</span>,
<span class="line-num">138</span>     <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">0</span> ).<span class="ruby-identifier">total_results</span>
<span class="line-num">139</span>   <span class="ruby-ivar">@comments_count</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">count</span>
<span class="line-num">140</span>   <span class="ruby-identifier">projects_with_managers_count</span> = <span class="ruby-constant">ProjectUser</span>.
<span class="line-num">141</span>     <span class="ruby-identifier">joins</span>(<span class="ruby-value">:project</span>).
<span class="line-num">142</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;projects.user_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span> ).
<span class="line-num">143</span>     <span class="ruby-identifier">where</span>( <span class="ruby-value">role:</span> <span class="ruby-constant">ProjectUser</span><span class="ruby-operator">::</span><span class="ruby-constant">MANAGER</span> ).
<span class="line-num">144</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;project_users.user_id != ?&quot;</span>, <span class="ruby-identifier">current_user</span> ).
<span class="line-num">145</span>     <span class="ruby-identifier">count</span>( <span class="ruby-string">&quot;DISTINCT project_id&quot;</span> )
<span class="line-num">146</span>   <span class="ruby-ivar">@projects_count</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">projects_with_managers_count</span>
<span class="line-num">147</span>   <span class="ruby-identifier">ident_response</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">148</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">149</span>     <span class="ruby-value">filters:</span> [
<span class="line-num">150</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">&quot;user.id&quot;:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> } },
<span class="line-num">151</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">own_observation:</span> <span class="ruby-keyword">false</span> } },
<span class="line-num">152</span>       { <span class="ruby-value">term:</span> { <span class="ruby-value">current:</span> <span class="ruby-keyword">true</span> } }
<span class="line-num">153</span>     ],
<span class="line-num">154</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">155</span>       <span class="ruby-value">distinct_obs_users:</span> {
<span class="line-num">156</span>         <span class="ruby-value">cardinality:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;observation.user_id&quot;</span> }
<span class="line-num">157</span>       }
<span class="line-num">158</span>     },
<span class="line-num">159</span>     <span class="ruby-value">track_total_hits:</span> <span class="ruby-keyword">true</span>
<span class="line-num">160</span>   )
<span class="line-num">161</span>   <span class="ruby-ivar">@identifications_count</span> = <span class="ruby-identifier">ident_response</span>.<span class="ruby-identifier">total_entries</span>
<span class="line-num">162</span>   <span class="ruby-ivar">@helpees_count</span> = <span class="ruby-identifier">ident_response</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">distinct_obs_users</span>.<span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
<span class="line-num">163</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">164</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">165</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">166</span>     <span class="ruby-keyword">end</span>
<span class="line-num">167</span>   <span class="ruby-keyword">end</span>
<span class="line-num">168</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-destroy">
            
              <b>destroy</b>()
            
            <a href="../classes/UsersController.html#method-i-destroy" name="method-i-destroy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-destroy_source')" id="l_method-i-destroy_source">show</a>
                

                

                
              </p>
              <div id="method-i-destroy_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">170</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
<span class="line-num">171</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation_code</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation_code</span>] )
<span class="line-num">172</span>     <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;views.users.delete.you_must_enter_confirmation_code_in_the_form&quot;</span>, <span class="ruby-value">confirmation_code:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:confirmation_code</span>] )
<span class="line-num">173</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">174</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">175</span>         <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">msg</span>
<span class="line-num">176</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">delete_users_path</span>
<span class="line-num">177</span>       <span class="ruby-keyword">end</span>
<span class="line-num">178</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">179</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">msg</span> }, <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>
<span class="line-num">180</span>       <span class="ruby-keyword">end</span>
<span class="line-num">181</span>     <span class="ruby-keyword">end</span>
<span class="line-num">182</span>     <span class="ruby-keyword">return</span>
<span class="line-num">183</span>   <span class="ruby-keyword">end</span>
<span class="line-num">184</span>   <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">priority:</span> <span class="ruby-constant">USER_PRIORITY</span>,
<span class="line-num">185</span>     <span class="ruby-value">unique_hash:</span> { <span class="ruby-value">&quot;User::sane_destroy&quot;:</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span> }).<span class="ruby-identifier">sane_destroy</span>
<span class="line-num">186</span>   <span class="ruby-identifier">sign_out</span>(<span class="ruby-ivar">@user</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@user</span>
<span class="line-num">187</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">188</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">189</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;#{@user.login} has been removed from #{@site.name} &quot;</span> <span class="ruby-operator">+</span>
<span class="line-num">190</span>         <span class="ruby-string">&quot;(it may take up to an hour to completely delete all associated content)&quot;</span>
<span class="line-num">191</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_path</span>
<span class="line-num">192</span>     <span class="ruby-keyword">end</span>
<span class="line-num">193</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
<span class="line-num">194</span>   <span class="ruby-keyword">end</span>
<span class="line-num">195</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit">
            
              <b>edit</b>()
            
            <a href="../classes/UsersController.html#method-i-edit" name="method-i-edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_source')" id="l_method-i-edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">581</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit</span>
<span class="line-num">582</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">583</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">584</span>       <span class="ruby-ivar">@monthly_supporter</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">donorbox_plan_status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;active&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">donorbox_plan_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;monthly&quot;</span>
<span class="line-num">585</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:edit2</span>, <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">586</span>     <span class="ruby-keyword">end</span>
<span class="line-num">587</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">588</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">to_json</span>(
<span class="line-num">589</span>         <span class="ruby-value">:except</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">590</span>           <span class="ruby-value">:crypted_password</span>, <span class="ruby-value">:salt</span>, <span class="ruby-value">:old_preferences</span>, <span class="ruby-value">:activation_code</span>,
<span class="line-num">591</span>           <span class="ruby-value">:remember_token</span>, <span class="ruby-value">:last_ip</span>, <span class="ruby-value">:suspended_at</span>, <span class="ruby-value">:suspension_reason</span>,
<span class="line-num">592</span>           <span class="ruby-value">:icon_content_type</span>, <span class="ruby-value">:icon_file_name</span>, <span class="ruby-value">:icon_file_size</span>,
<span class="line-num">593</span>           <span class="ruby-value">:icon_updated_at</span>, <span class="ruby-value">:deleted_at</span>, <span class="ruby-value">:remember_token_expires_at</span>,
<span class="line-num">594</span>           <span class="ruby-value">:icon_url</span>, <span class="ruby-value">:latitude</span>, <span class="ruby-value">:longitude</span>, <span class="ruby-value">:lat_lon_acc_admin_level</span>
<span class="line-num">595</span>         ],
<span class="line-num">596</span>         <span class="ruby-value">:methods</span> <span class="ruby-operator">=&gt;</span> [
<span class="line-num">597</span>           <span class="ruby-value">:user_icon_url</span>, <span class="ruby-value">:medium_user_icon_url</span>, <span class="ruby-value">:original_user_icon_url</span>,
<span class="line-num">598</span>           <span class="ruby-value">:prefers_no_tracking</span>
<span class="line-num">599</span>         ]
<span class="line-num">600</span>       )
<span class="line-num">601</span>     <span class="ruby-keyword">end</span>
<span class="line-num">602</span>   <span class="ruby-keyword">end</span>
<span class="line-num">603</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-edit_after_auth">
            
              <b>edit_after_auth</b>()
            
            <a href="../classes/UsersController.html#method-i-edit_after_auth" name="method-i-edit_after_auth" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>this is the page that&#39;s shown after a new user is created via 3rd party provider_authorization allows user to pick a new username if he doesn&#39;t like the one we autogenerated.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-edit_after_auth_source')" id="l_method-i-edit_after_auth_source">show</a>
                

                

                
              </p>
              <div id="method-i-edit_after_auth_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">607</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">edit_after_auth</span>
<span class="line-num">608</span>   <span class="ruby-identifier">redirect_to</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">flash</span>[<span class="ruby-value">:allow_edit_after_auth</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:test</span>])
<span class="line-num">609</span>   <span class="ruby-identifier">load_registration_form_data</span>
<span class="line-num">610</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">611</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">612</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;registrations&quot;</span>
<span class="line-num">613</span>     <span class="ruby-keyword">end</span>
<span class="line-num">614</span>   <span class="ruby-keyword">end</span>
<span class="line-num">615</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-followers">
            
              <b>followers</b>()
            
            <a href="../classes/UsersController.html#method-i-followers" name="method-i-followers" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-followers_source')" id="l_method-i-followers_source">show</a>
                

                

                
              </p>
              <div id="method-i-followers_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">344</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">followers</span>
<span class="line-num">345</span>   <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">followers</span>
<span class="line-num">346</span>   <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">page</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] ).<span class="ruby-identifier">order</span>( <span class="ruby-value">:login</span> )
<span class="line-num">347</span>   <span class="ruby-identifier">counts_for_users</span>
<span class="line-num">348</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">349</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:friendship_users</span>, <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span> }
<span class="line-num">350</span>   <span class="ruby-keyword">end</span>
<span class="line-num">351</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-following">
            
              <b>following</b>()
            
            <a href="../classes/UsersController.html#method-i-following" name="method-i-following" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-following_source')" id="l_method-i-following_source">show</a>
                

                

                
              </p>
              <div id="method-i-following_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">353</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">following</span>
<span class="line-num">354</span>   <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">followees</span>
<span class="line-num">355</span>   <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">page</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] ).<span class="ruby-identifier">order</span>( <span class="ruby-value">:login</span> )
<span class="line-num">356</span>   <span class="ruby-identifier">counts_for_users</span>
<span class="line-num">357</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">358</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:friendship_users</span>, <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span> }
<span class="line-num">359</span>   <span class="ruby-keyword">end</span>
<span class="line-num">360</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_local_onboarding_content">
            
              <b>get_local_onboarding_content</b>()
            
            <a href="../classes/UsersController.html#method-i-get_local_onboarding_content" name="method-i-get_local_onboarding_content" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_local_onboarding_content_source')" id="l_method-i-get_local_onboarding_content_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_local_onboarding_content_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">372</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_local_onboarding_content</span>
<span class="line-num">373</span>   <span class="ruby-identifier">local_onboarding_content</span> = {<span class="ruby-value">local_results:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">target_taxa:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">to_follows:</span> <span class="ruby-keyword">nil</span>}
<span class="line-num">374</span>   <span class="ruby-keyword">if</span> (<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">latitude</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">longitude</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-comment">#show global content</span>
<span class="line-num">375</span>     <span class="ruby-identifier">search_params</span> = { <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">d1:</span> <span class="ruby-value">12</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-value">rank:</span> <span class="ruby-string">&#39;species&#39;</span> }
<span class="line-num">376</span>     <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>( <span class="ruby-identifier">search_params</span> )
<span class="line-num">377</span>     <span class="ruby-identifier">local_onboarding_content</span>[<span class="ruby-value">:local_results</span>] = <span class="ruby-keyword">false</span>
<span class="line-num">378</span>   <span class="ruby-keyword">else</span>
<span class="line-num">379</span>     <span class="ruby-comment"># have latitude and longitude so show local content</span>
<span class="line-num">380</span>     <span class="ruby-comment"># use place_id to fetch content from country or state</span>
<span class="line-num">381</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">lat_lon_acc_admin_level</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">lat_lon_acc_admin_level</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Place</span><span class="ruby-operator">::</span><span class="ruby-constant">STATE_LEVEL</span>
<span class="line-num">382</span>       <span class="ruby-identifier">place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">containing_lat_lng</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">longitude</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">admin_level:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">lat_lon_acc_admin_level</span>).<span class="ruby-identifier">first</span>
<span class="line-num">383</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>
<span class="line-num">384</span>         <span class="ruby-identifier">search_params</span> = { <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">place_id:</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">d1:</span> <span class="ruby-value">12</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-value">rank:</span> <span class="ruby-string">&#39;species&#39;</span> }
<span class="line-num">385</span>         <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">386</span>         <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] }.<span class="ruby-identifier">sum</span>
<span class="line-num">387</span>       <span class="ruby-keyword">else</span>
<span class="line-num">388</span>         <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-value">0</span>
<span class="line-num">389</span>       <span class="ruby-keyword">end</span>
<span class="line-num">390</span>     <span class="ruby-keyword">else</span> <span class="ruby-comment">#use lat-lon and radius to fetch content</span>
<span class="line-num">391</span>       <span class="ruby-identifier">local_onboarding_content</span>[<span class="ruby-value">:local_results</span>] = <span class="ruby-keyword">true</span>        
<span class="line-num">392</span>       <span class="ruby-identifier">search_params</span> = { <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">lat:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">latitude</span>, <span class="ruby-value">lng:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">longitude</span>, <span class="ruby-value">radius:</span> <span class="ruby-value">1</span>, <span class="ruby-value">d1:</span> <span class="ruby-value">12</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-value">rank:</span> <span class="ruby-string">&#39;species&#39;</span> }
<span class="line-num">393</span>       <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">394</span>       <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] }.<span class="ruby-identifier">sum</span>
<span class="line-num">395</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">nearby_taxa_obs_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">50</span>
<span class="line-num">396</span>         <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:radius</span>] = <span class="ruby-value">100</span>  <span class="ruby-comment"># expand radius</span>
<span class="line-num">397</span>         <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">398</span>         <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] }.<span class="ruby-identifier">sum</span>
<span class="line-num">399</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">nearby_taxa_obs_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">50</span>
<span class="line-num">400</span>           <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:d1</span>] = <span class="ruby-value">12</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span>  <span class="ruby-comment"># expand time period</span>
<span class="line-num">401</span>           <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">402</span>           <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] }.<span class="ruby-identifier">sum</span>
<span class="line-num">403</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">nearby_taxa_obs_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">50</span>
<span class="line-num">404</span>             <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:radius</span>] = <span class="ruby-value">1000</span> <span class="ruby-comment"># expand radius</span>
<span class="line-num">405</span>             <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">406</span>             <span class="ruby-identifier">nearby_taxa_obs_count</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] }.<span class="ruby-identifier">sum</span>
<span class="line-num">407</span>           <span class="ruby-keyword">end</span>
<span class="line-num">408</span>         <span class="ruby-keyword">end</span>
<span class="line-num">409</span>       <span class="ruby-keyword">end</span>
<span class="line-num">410</span>     <span class="ruby-keyword">end</span>
<span class="line-num">411</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">nearby_taxa_obs_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">50</span> <span class="ruby-comment">#not enough content so settle for global results</span>
<span class="line-num">412</span>       <span class="ruby-identifier">search_params</span> = { <span class="ruby-value">verifiable:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">d1:</span> <span class="ruby-value">12</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">d2:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-value">rank:</span> <span class="ruby-string">&#39;species&#39;</span> }
<span class="line-num">413</span>       <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">get_nearby_taxa_obs_counts</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">414</span>       <span class="ruby-identifier">local_onboarding_content</span>[<span class="ruby-value">:local_results</span>] = <span class="ruby-keyword">false</span>
<span class="line-num">415</span>     <span class="ruby-keyword">end</span>
<span class="line-num">416</span>   <span class="ruby-keyword">end</span>
<span class="line-num">417</span>   
<span class="line-num">418</span>   <span class="ruby-comment">#fetch target_taxa from results</span>
<span class="line-num">419</span>   <span class="ruby-identifier">target_taxa_ids</span> = <span class="ruby-identifier">nearby_taxa_results</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>] }
<span class="line-num">420</span>   <span class="ruby-identifier">target_taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">target_taxa_ids</span>)
<span class="line-num">421</span>   <span class="ruby-identifier">local_onboarding_content</span>[<span class="ruby-value">:target_taxa</span>] = <span class="ruby-identifier">target_taxa</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">target_taxa</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">422</span> 
<span class="line-num">423</span>   <span class="ruby-comment">#fetch followers from results</span>
<span class="line-num">424</span>   <span class="ruby-identifier">follower_ids</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_user_observation_counts</span>(<span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>(<span class="ruby-identifier">search_params</span>), <span class="ruby-value">4</span>)[<span class="ruby-value">:counts</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>[<span class="ruby-string">&quot;user_id&quot;</span>]}
<span class="line-num">425</span>   <span class="ruby-identifier">follower_ids</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>) <span class="ruby-comment">#exclude the current user</span>
<span class="line-num">426</span>   <span class="ruby-identifier">followers</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;id IN (?)&quot;</span>, <span class="ruby-identifier">follower_ids</span>)
<span class="line-num">427</span>   <span class="ruby-identifier">local_onboarding_content</span>[<span class="ruby-value">:to_follows</span>] = <span class="ruby-identifier">followers</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">followers</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">428</span> 
<span class="line-num">429</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">local_onboarding_content</span>
<span class="line-num">430</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_nearby_taxa_obs_counts">
            
              <b>get_nearby_taxa_obs_counts</b>(search_params)
            
            <a href="../classes/UsersController.html#method-i-get_nearby_taxa_obs_counts" name="method-i-get_nearby_taxa_obs_counts" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-get_nearby_taxa_obs_counts_source')" id="l_method-i-get_nearby_taxa_obs_counts_source">show</a>
                

                

                
              </p>
              <div id="method-i-get_nearby_taxa_obs_counts_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">366</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_nearby_taxa_obs_counts</span> <span class="ruby-identifier">search_params</span>
<span class="line-num">367</span>   <span class="ruby-identifier">elastic_params</span> =  <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>(<span class="ruby-identifier">search_params</span>)
<span class="line-num">368</span>   <span class="ruby-identifier">species_counts</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_search</span>(<span class="ruby-identifier">elastic_params</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">size:</span> <span class="ruby-value">0</span>, <span class="ruby-value">aggregate:</span> { <span class="ruby-value">species:</span> { <span class="ruby-value">&quot;taxon.id&quot;:</span> <span class="ruby-value">4</span> } })).<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>
<span class="line-num">369</span>   <span class="ruby-identifier">nearby_taxa_results</span> = <span class="ruby-identifier">species_counts</span>.<span class="ruby-identifier">species</span>.<span class="ruby-identifier">buckets</span>
<span class="line-num">370</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-index">
            
              <b>index</b>()
            
            <a href="../classes/UsersController.html#method-i-index" name="method-i-index" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Methods below here are added by iNaturalist</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-index_source')" id="l_method-i-index_source">show</a>
                

                

                
              </p>
              <div id="method-i-index_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">217</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
<span class="line-num">218</span>   <span class="ruby-ivar">@recently_active_key</span> = <span class="ruby-node">&quot;recently_active_#{I18n.locale}_site_#{@site.id}&quot;</span>
<span class="line-num">219</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@recently_active_key</span>)
<span class="line-num">220</span>     <span class="ruby-ivar">@updates</span> = []
<span class="line-num">221</span>     [<span class="ruby-constant">Observation</span>, <span class="ruby-constant">Identification</span>, <span class="ruby-constant">Post</span>, <span class="ruby-constant">Comment</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span>
<span class="line-num">222</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">klass</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Observation</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">223</span>         <span class="ruby-ivar">@updates</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">page_of_results</span>( <span class="ruby-value">d1:</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">week</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_s</span> )
<span class="line-num">224</span>       <span class="ruby-keyword">else</span>
<span class="line-num">225</span>         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">30</span>).
<span class="line-num">226</span>           <span class="ruby-identifier">order</span>(<span class="ruby-node">&quot;#{klass.table_name}.created_at DESC&quot;</span>).
<span class="line-num">227</span>           <span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;#{klass.table_name}.created_at &gt; ?&quot;</span>, <span class="ruby-value">1</span>.<span class="ruby-identifier">week</span>.<span class="ruby-identifier">ago</span>).
<span class="line-num">228</span>           <span class="ruby-identifier">joins</span>(<span class="ruby-value">:user</span>).
<span class="line-num">229</span>           <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id IS NOT NULL&quot;</span>)
<span class="line-num">230</span>         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.site_id = ?&quot;</span>, <span class="ruby-ivar">@site</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">231</span>         <span class="ruby-ivar">@updates</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">all</span>
<span class="line-num">232</span>       <span class="ruby-keyword">end</span>
<span class="line-num">233</span>     <span class="ruby-keyword">end</span>
<span class="line-num">234</span>     <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@updates</span>, <span class="ruby-value">:user</span>)
<span class="line-num">235</span>     <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
<span class="line-num">236</span>       ( <span class="ruby-identifier">u</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Post</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">draft?</span> ) <span class="ruby-operator">||</span>
<span class="line-num">237</span>       ( <span class="ruby-identifier">u</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Identification</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">taxon_change_id</span> ) <span class="ruby-operator">||</span>
<span class="line-num">238</span>       ( <span class="ruby-identifier">u</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Identification</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">observation</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">user_id</span> )
<span class="line-num">239</span>     <span class="ruby-keyword">end</span>
<span class="line-num">240</span>     <span class="ruby-identifier">hash</span> = {}
<span class="line-num">241</span>     <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:created_at</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
<span class="line-num">242</span>       <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">record</span>.<span class="ruby-identifier">user_id</span>] = <span class="ruby-identifier">record</span>
<span class="line-num">243</span>     <span class="ruby-keyword">end</span>
<span class="line-num">244</span>     <span class="ruby-ivar">@updates</span> = <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:created_at</span>).<span class="ruby-identifier">reverse</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">11</span>]
<span class="line-num">245</span>   <span class="ruby-keyword">end</span>
<span class="line-num">246</span> 
<span class="line-num">247</span>   <span class="ruby-ivar">@leaderboard_key</span> = <span class="ruby-node">&quot;leaderboard_#{I18n.locale}_site_#{@site.id}_4&quot;</span>
<span class="line-num">248</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@leaderboard_key</span>)
<span class="line-num">249</span>     <span class="ruby-ivar">@most_observations</span> = <span class="ruby-identifier">most_observations</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>)
<span class="line-num">250</span>     <span class="ruby-ivar">@most_species</span> = <span class="ruby-identifier">most_species</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>)
<span class="line-num">251</span>     <span class="ruby-ivar">@most_identifications</span> = <span class="ruby-identifier">most_identifications</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>)
<span class="line-num">252</span>     <span class="ruby-ivar">@most_observations_year</span> = <span class="ruby-identifier">most_observations</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>)
<span class="line-num">253</span>     <span class="ruby-ivar">@most_species_year</span> = <span class="ruby-identifier">most_species</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>)
<span class="line-num">254</span>     <span class="ruby-ivar">@most_identifications_year</span> = <span class="ruby-identifier">most_identifications</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>)
<span class="line-num">255</span>   <span class="ruby-keyword">end</span>
<span class="line-num">256</span> 
<span class="line-num">257</span>   <span class="ruby-ivar">@curators_key</span> = <span class="ruby-node">&quot;users_index_curators_#{I18n.locale}_site_#{@site.id}_4&quot;</span>
<span class="line-num">258</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@curators_key</span>)
<span class="line-num">259</span>     <span class="ruby-ivar">@curators</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">curators</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">500</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:roles</span>).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;updated_at DESC&quot;</span> )
<span class="line-num">260</span>     <span class="ruby-ivar">@curators</span> = <span class="ruby-ivar">@curators</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.site_id = ?&quot;</span>, <span class="ruby-ivar">@site</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">261</span>     <span class="ruby-ivar">@curators</span> = <span class="ruby-ivar">@curators</span>.<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:is_admin?</span>)
<span class="line-num">262</span>     <span class="ruby-ivar">@updated_taxa_counts</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;updater_id IN (?)&quot;</span>, <span class="ruby-ivar">@curators</span>).<span class="ruby-identifier">group</span>(<span class="ruby-value">:updater_id</span>).<span class="ruby-identifier">count</span>
<span class="line-num">263</span>     <span class="ruby-ivar">@taxon_change_counts</span> = <span class="ruby-constant">TaxonChange</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;user_id IN (?)&quot;</span>, <span class="ruby-ivar">@curators</span>).<span class="ruby-identifier">group</span>(<span class="ruby-value">:user_id</span>).<span class="ruby-identifier">count</span>
<span class="line-num">264</span>     <span class="ruby-ivar">@resolved_flag_counts</span> = <span class="ruby-constant">Flag</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;resolver_id IN (?)&quot;</span>, <span class="ruby-ivar">@curators</span>).<span class="ruby-identifier">group</span>(<span class="ruby-value">:resolver_id</span>).<span class="ruby-identifier">count</span>
<span class="line-num">265</span>     <span class="ruby-ivar">@curators</span> = <span class="ruby-ivar">@curators</span>.<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
<span class="line-num">266</span>       <span class="ruby-value">-1</span> <span class="ruby-operator">*</span> (
<span class="line-num">267</span>         <span class="ruby-ivar">@resolved_flag_counts</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span>
<span class="line-num">268</span>         <span class="ruby-ivar">@updated_taxa_counts</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span>
<span class="line-num">269</span>         <span class="ruby-ivar">@taxon_change_counts</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">to_i</span>
<span class="line-num">270</span>       )
<span class="line-num">271</span>     <span class="ruby-keyword">end</span>
<span class="line-num">272</span>   <span class="ruby-keyword">end</span>
<span class="line-num">273</span> 
<span class="line-num">274</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">275</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
<span class="line-num">276</span>   <span class="ruby-keyword">end</span>
<span class="line-num">277</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-join_test">
            
              <b>join_test</b>()
            
            <a href="../classes/UsersController.html#method-i-join_test" name="method-i-join_test" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-join_test_source')" id="l_method-i-join_test_source">show</a>
                

                

                
              </p>
              <div id="method-i-join_test_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">842</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">join_test</span>
<span class="line-num">843</span>   <span class="ruby-identifier">groups</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">test_groups_array</span>
<span class="line-num">844</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:leave</span>]
<span class="line-num">845</span>     <span class="ruby-identifier">groups</span> <span class="ruby-operator">-=</span> [<span class="ruby-identifier">params</span>[<span class="ruby-value">:leave</span>]].<span class="ruby-identifier">flatten</span>
<span class="line-num">846</span>   <span class="ruby-keyword">end</span>
<span class="line-num">847</span>   <span class="ruby-identifier">groups</span> = ( <span class="ruby-identifier">groups</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">params</span>[<span class="ruby-value">:test</span>]] ).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">848</span>   <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">test_groups:</span> <span class="ruby-identifier">groups</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;|&quot;</span> ) )
<span class="line-num">849</span>   <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">root_path</span> )
<span class="line-num">850</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-leaderboard">
            
              <b>leaderboard</b>()
            
            <a href="../classes/UsersController.html#method-i-leaderboard" name="method-i-leaderboard" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-leaderboard_source')" id="l_method-i-leaderboard_source">show</a>
                

                

                
              </p>
              <div id="method-i-leaderboard_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">279</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">leaderboard</span>
<span class="line-num">280</span>   <span class="ruby-ivar">@year</span> = (<span class="ruby-identifier">params</span>[<span class="ruby-value">:year</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>).<span class="ruby-identifier">to_i</span>
<span class="line-num">281</span>   <span class="ruby-ivar">@month</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:month</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:month</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">282</span>   <span class="ruby-ivar">@date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-node">&quot;#{@year}-#{@month || &#39;01&#39;}-01&quot;</span>)
<span class="line-num">283</span>   <span class="ruby-ivar">@time_unit</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:month</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;year&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">284</span>   <span class="ruby-ivar">@leaderboard_key</span> = <span class="ruby-node">&quot;leaderboard_#{I18n.locale}_site_#{@site.id}_#{@year}_#{@month}&quot;</span>
<span class="line-num">285</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fragment_exist?</span>(<span class="ruby-ivar">@leaderboard_key</span>)
<span class="line-num">286</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:month</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">287</span>       <span class="ruby-ivar">@most_observations</span> = <span class="ruby-identifier">most_observations</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>)
<span class="line-num">288</span>       <span class="ruby-ivar">@most_species</span> = <span class="ruby-identifier">most_species</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>)
<span class="line-num">289</span>       <span class="ruby-ivar">@most_identifications</span> = <span class="ruby-identifier">most_identifications</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;year&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>)
<span class="line-num">290</span>     <span class="ruby-keyword">else</span>
<span class="line-num">291</span>       <span class="ruby-ivar">@most_observations</span> = <span class="ruby-identifier">most_observations</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>, <span class="ruby-value">:month</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@month</span>)
<span class="line-num">292</span>       <span class="ruby-ivar">@most_species</span> = <span class="ruby-identifier">most_species</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>, <span class="ruby-value">:month</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@month</span>)
<span class="line-num">293</span>       <span class="ruby-ivar">@most_identifications</span> = <span class="ruby-identifier">most_identifications</span>(<span class="ruby-value">:per</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;month&#39;</span>, <span class="ruby-value">:year</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@year</span>, <span class="ruby-value">:month</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@month</span>)
<span class="line-num">294</span>     <span class="ruby-keyword">end</span>
<span class="line-num">295</span>   <span class="ruby-keyword">end</span>
<span class="line-num">296</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-leave_test">
            
              <b>leave_test</b>()
            
            <a href="../classes/UsersController.html#method-i-leave_test" name="method-i-leave_test" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-leave_test_source')" id="l_method-i-leave_test_source">show</a>
                

                

                
              </p>
              <div id="method-i-leave_test_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">852</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">leave_test</span>
<span class="line-num">853</span>   <span class="ruby-identifier">groups</span> = ( <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">test_groups_array</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">params</span>[<span class="ruby-value">:test</span>]].<span class="ruby-identifier">flatten</span> ).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">854</span>   <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">test_groups:</span> <span class="ruby-identifier">groups</span>.<span class="ruby-identifier">join</span>( <span class="ruby-string">&quot;|&quot;</span> ) )
<span class="line-num">855</span>   <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-identifier">root_path</span> )
<span class="line-num">856</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-merge">
            
              <b>merge</b>()
            
            <a href="../classes/UsersController.html#method-i-merge" name="method-i-merge" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-merge_source')" id="l_method-i-merge_source">show</a>
                

                

                
              </p>
              <div id="method-i-merge_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">798</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">merge</span>
<span class="line-num">799</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@reject_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:reject_user_id</span>] )
<span class="line-num">800</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-string">&quot;Couldn&#39;t find user to delete&quot;</span>
<span class="line-num">801</span>     <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-string">&quot;/&quot;</span>
<span class="line-num">802</span>   <span class="ruby-keyword">end</span>
<span class="line-num">803</span>   <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-ivar">@reject_user</span> )
<span class="line-num">804</span>   <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;Merged user #{@reject_user.login} deleted&quot;</span>
<span class="line-num">805</span>   <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-string">&quot;/&quot;</span>
<span class="line-num">806</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-moderation">
            
              <b>moderation</b>()
            
            <a href="../classes/UsersController.html#method-i-moderation" name="method-i-moderation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-moderation_source')" id="l_method-i-moderation_source">show</a>
                

                

                
              </p>
              <div id="method-i-moderation_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num"> 959</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">moderation</span>
<span class="line-num"> 960</span>   <span class="ruby-identifier">before</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:before</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
<span class="line-num"> 961</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num"> 962</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>)
<span class="line-num"> 963</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-identifier">person_by_login_path</span>( <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">login</span> )
<span class="line-num"> 964</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 965</span>   <span class="ruby-identifier">max</span> = <span class="ruby-value">100</span>
<span class="line-num"> 966</span>   <span class="ruby-ivar">@valid_years</span> = ( <span class="ruby-value">2008</span><span class="ruby-operator">..</span><span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">year</span> ).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">reverse</span>
<span class="line-num"> 967</span>   <span class="ruby-ivar">@years</span> = ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:years</span>] <span class="ruby-operator">||</span> [] ).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-ivar">@valid_years</span>
<span class="line-num"> 968</span>   <span class="ruby-ivar">@types</span> = ( <span class="ruby-identifier">params</span>[<span class="ruby-value">:types</span>] <span class="ruby-operator">||</span> [] ) <span class="ruby-operator">&amp;</span> <span class="ruby-node">%w(Flag ModeratorNote ModeratorAction)</span>
<span class="line-num"> 969</span>   <span class="ruby-identifier">scopes</span> = {}
<span class="line-num"> 970</span>   <span class="ruby-identifier">scopes</span>[<span class="ruby-string">&quot;ModeratorNote&quot;</span>] = <span class="ruby-constant">ModeratorNote</span>.
<span class="line-num"> 971</span>     <span class="ruby-identifier">where</span>( <span class="ruby-value">subject_user_id:</span> <span class="ruby-ivar">@user</span> ).
<span class="line-num"> 972</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at &lt; ?&quot;</span>, <span class="ruby-identifier">before</span> ).
<span class="line-num"> 973</span>     <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id desc&quot;</span> )
<span class="line-num"> 974</span>   <span class="ruby-identifier">scopes</span>[<span class="ruby-string">&quot;Flag&quot;</span>] = <span class="ruby-constant">Flag</span>.
<span class="line-num"> 975</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at &lt; ?&quot;</span>, <span class="ruby-identifier">before</span> ).
<span class="line-num"> 976</span>     <span class="ruby-identifier">where</span>( <span class="ruby-value">flaggable_user_id:</span> <span class="ruby-ivar">@user</span> ).
<span class="line-num"> 977</span>     <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;flaggable_type != &#39;Taxon&#39;&quot;</span> ).
<span class="line-num"> 978</span>     <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id desc&quot;</span> )
<span class="line-num"> 979</span>   <span class="ruby-ivar">@records</span> = []
<span class="line-num"> 980</span>   <span class="ruby-identifier">scopes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">type</span>, <span class="ruby-identifier">scope</span><span class="ruby-operator">|</span>
<span class="line-num"> 981</span>     <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@types</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@types</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">type</span> )
<span class="line-num"> 982</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 983</span>       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">limit</span>( <span class="ruby-identifier">max</span> )
<span class="line-num"> 984</span>     <span class="ruby-keyword">else</span>
<span class="line-num"> 985</span>       <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">year</span><span class="ruby-operator">|</span>
<span class="line-num"> 986</span>         <span class="ruby-identifier">d1</span> = <span class="ruby-node">&quot;#{year}-01-01&quot;</span>
<span class="line-num"> 987</span>         <span class="ruby-identifier">d2</span> = <span class="ruby-node">&quot;#{year}-12-31&quot;</span>
<span class="line-num"> 988</span>         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">where</span>( <span class="ruby-node">&quot;#{Object.const_get( type ).table_name}.created_at BETWEEN ? AND ?&quot;</span>, <span class="ruby-identifier">d1</span>, <span class="ruby-identifier">d2</span> )
<span class="line-num"> 989</span>       <span class="ruby-keyword">end</span>
<span class="line-num"> 990</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 991</span>     <span class="ruby-ivar">@records</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_a</span>
<span class="line-num"> 992</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 993</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@types</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@types</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-string">&quot;ModeratorAction&quot;</span> )
<span class="line-num"> 994</span>     <span class="ruby-identifier">ma_scope</span> = <span class="ruby-constant">ModeratorAction</span>.
<span class="line-num"> 995</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;moderator_actions.created_at &lt; ?&quot;</span>, <span class="ruby-identifier">before</span> ).
<span class="line-num"> 996</span>       <span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;moderator_actions.id desc&quot;</span> )
<span class="line-num"> 997</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num"> 998</span>       <span class="ruby-identifier">ma_scope</span> = <span class="ruby-identifier">ma_scope</span>.<span class="ruby-identifier">limit</span>( <span class="ruby-identifier">max</span> )
<span class="line-num"> 999</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1000</span>       <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">year</span><span class="ruby-operator">|</span>
<span class="line-num">1001</span>         <span class="ruby-identifier">ma_scope</span> = <span class="ruby-identifier">ma_scope</span>.<span class="ruby-identifier">where</span>(
<span class="line-num">1002</span>           <span class="ruby-string">&quot;moderator_actions.created_at BETWEEN ? AND ?&quot;</span>,
<span class="line-num">1003</span>           <span class="ruby-node">&quot;#{year}-01-01&quot;</span>,
<span class="line-num">1004</span>           <span class="ruby-node">&quot;#{year}-12-31&quot;</span>
<span class="line-num">1005</span>         )
<span class="line-num">1006</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1007</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1008</span>     <span class="ruby-ivar">@records</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">ma_scope</span>.
<span class="line-num">1009</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">resource_type:</span> <span class="ruby-string">&quot;Identification&quot;</span> ).
<span class="line-num">1010</span>       <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN identifications i ON i.id = moderator_actions.resource_id&quot;</span> ).
<span class="line-num">1011</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;i.user_id = ?&quot;</span>, <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">1012</span>     <span class="ruby-ivar">@records</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">ma_scope</span>.
<span class="line-num">1013</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">resource_type:</span> <span class="ruby-string">&quot;Comment&quot;</span> ).
<span class="line-num">1014</span>       <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN comments c ON c.id = moderator_actions.resource_id&quot;</span> ).
<span class="line-num">1015</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;c.user_id = ?&quot;</span>, <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">1016</span>     <span class="ruby-ivar">@records</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">ma_scope</span>.
<span class="line-num">1017</span>       <span class="ruby-identifier">where</span>( <span class="ruby-value">resource_type:</span> <span class="ruby-string">&quot;User&quot;</span> ).
<span class="line-num">1018</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;moderator_actions.resource_id = ?&quot;</span>, <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">to_a</span>
<span class="line-num">1019</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1020</span>   <span class="ruby-ivar">@records</span> = <span class="ruby-ivar">@records</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">created_at</span> }
<span class="line-num">1021</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1022</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1023</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap-container&quot;</span>
<span class="line-num">1024</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1025</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1026</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mute">
            
              <b>mute</b>()
            
            <a href="../classes/UsersController.html#method-i-mute" name="method-i-mute" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-mute_source')" id="l_method-i-mute_source">show</a>
                

                

                
              </p>
              <div id="method-i-mute_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">903</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mute</span>
<span class="line-num">904</span>   <span class="ruby-ivar">@user_mute</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_mutes</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">muted_user_id:</span> <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">905</span>   <span class="ruby-ivar">@user_mute</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_mutes</span>.<span class="ruby-identifier">create</span>( <span class="ruby-value">muted_user:</span> <span class="ruby-ivar">@user</span> )
<span class="line-num">906</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">907</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">908</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_mute</span>.<span class="ruby-identifier">valid?</span>
<span class="line-num">909</span>         <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">910</span>       <span class="ruby-keyword">else</span>
<span class="line-num">911</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">errors:</span> <span class="ruby-ivar">@user_mute</span>.<span class="ruby-identifier">errors</span> }
<span class="line-num">912</span>       <span class="ruby-keyword">end</span>
<span class="line-num">913</span>     <span class="ruby-keyword">end</span>
<span class="line-num">914</span>   <span class="ruby-keyword">end</span>
<span class="line-num">915</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-new_updates">
            
              <b>new_updates</b>()
            
            <a href="../classes/UsersController.html#method-i-new_updates" name="method-i-new_updates" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-new_updates_source')" id="l_method-i-new_updates_source">show</a>
                

                

                
              </p>
              <div id="method-i-new_updates_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">546</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_updates</span>
<span class="line-num">547</span>   <span class="ruby-comment"># not sure why current_user would be nil here, but sometimes it is</span>
<span class="line-num">548</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">login_path</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>
<span class="line-num">549</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:notification</span>] <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;activity&quot;</span>
<span class="line-num">550</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:notification</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:notification</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="line-num">551</span>   <span class="ruby-identifier">filters</span> = [ { <span class="ruby-value">terms:</span> { <span class="ruby-value">notification:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:notification</span>] } } ]
<span class="line-num">552</span>   <span class="ruby-identifier">notifier_types</span> = [(<span class="ruby-identifier">params</span>[<span class="ruby-value">:notifier_types</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:notifier_type</span>])].<span class="ruby-identifier">compact</span>
<span class="line-num">553</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">notifier_types</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">554</span>     <span class="ruby-identifier">notifier_types</span> = <span class="ruby-identifier">notifier_types</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">555</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">terms:</span> { <span class="ruby-value">notifier_type:</span> <span class="ruby-identifier">notifier_types</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:capitalize</span>) } }
<span class="line-num">556</span>   <span class="ruby-keyword">end</span>
<span class="line-num">557</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:resource_type</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">558</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">term:</span> { <span class="ruby-value">resource_type:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:resource_type</span>].<span class="ruby-identifier">capitalize</span> } }
<span class="line-num">559</span>   <span class="ruby-keyword">end</span>
<span class="line-num">560</span>   <span class="ruby-ivar">@updates</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>(<span class="ruby-value">unviewed:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">200</span>, <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>)
<span class="line-num">561</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">format</span>.<span class="ruby-identifier">json?</span>
<span class="line-num">562</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">563</span>       <span class="ruby-ivar">@updates</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>(<span class="ruby-value">viewed:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">10</span>, <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>)
<span class="line-num">564</span>     <span class="ruby-keyword">end</span>
<span class="line-num">565</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="line-num">566</span>       <span class="ruby-ivar">@updates</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>(<span class="ruby-value">per_page:</span> <span class="ruby-value">5</span>, <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>)
<span class="line-num">567</span>     <span class="ruby-keyword">end</span>
<span class="line-num">568</span>   <span class="ruby-keyword">end</span>
<span class="line-num">569</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-node">%w(1 yes y true t)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:skip_view</span>].<span class="ruby-identifier">to_s</span>)
<span class="line-num">570</span>     <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">user_viewed_updates</span>(<span class="ruby-ivar">@updates</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">571</span>     <span class="ruby-identifier">session</span>[<span class="ruby-value">:updates_count</span>] = <span class="ruby-value">0</span>
<span class="line-num">572</span>   <span class="ruby-keyword">end</span>
<span class="line-num">573</span>   <span class="ruby-constant">UpdateAction</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-ivar">@updates</span>, [ <span class="ruby-value">:resource</span>, <span class="ruby-value">:notifier</span>, <span class="ruby-value">:resource_owner</span> ])
<span class="line-num">574</span>   <span class="ruby-ivar">@updates</span> = <span class="ruby-ivar">@updates</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">-1</span>}
<span class="line-num">575</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">576</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:layout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span> }
<span class="line-num">577</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@updates</span> }
<span class="line-num">578</span>   <span class="ruby-keyword">end</span>
<span class="line-num">579</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-parental_consent">
            
              <b>parental_consent</b>()
            
            <a href="../classes/UsersController.html#method-i-parental_consent" name="method-i-parental_consent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-parental_consent_source')" id="l_method-i-parental_consent_source">show</a>
                

                

                
              </p>
              <div id="method-i-parental_consent_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">878</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parental_consent</span>
<span class="line-num">879</span>   <span class="ruby-identifier">error_msg</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">880</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:email</span>]
<span class="line-num">881</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-value">:must_specify_email</span>
<span class="line-num">882</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:email</span>] <span class="ruby-operator">!~</span> <span class="ruby-constant">Devise</span>.<span class="ruby-identifier">email_regexp</span>
<span class="line-num">883</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-value">:invalid_email</span>
<span class="line-num">884</span>   <span class="ruby-keyword">end</span>
<span class="line-num">885</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">error_msg</span>
<span class="line-num">886</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">887</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>( <span class="ruby-node">&quot;parental_consent.#{error_msg}&quot;</span> ) } }
<span class="line-num">888</span>     <span class="ruby-keyword">end</span>
<span class="line-num">889</span>     <span class="ruby-keyword">return</span>
<span class="line-num">890</span>   <span class="ruby-keyword">end</span>
<span class="line-num">891</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Devise</span><span class="ruby-operator">::</span><span class="ruby-constant">Strategies</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationJsonWebToken</span><span class="ruby-operator">::</span><span class="ruby-constant">ANONYMOUS_USER_ID</span>
<span class="line-num">892</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">893</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:forbidden</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-string">&quot;forbidden&quot;</span> } }
<span class="line-num">894</span>     <span class="ruby-keyword">end</span>
<span class="line-num">895</span>     <span class="ruby-keyword">return</span>
<span class="line-num">896</span>   <span class="ruby-keyword">end</span>
<span class="line-num">897</span>   <span class="ruby-constant">Emailer</span>.<span class="ruby-identifier">parental_consent</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:email</span>] ).<span class="ruby-identifier">deliver_now</span>
<span class="line-num">898</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">899</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
<span class="line-num">900</span>   <span class="ruby-keyword">end</span>
<span class="line-num">901</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-recent">
            
              <b>recent</b>()
            
            <a href="../classes/UsersController.html#method-i-recent" name="method-i-recent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-recent_source')" id="l_method-i-recent_source">show</a>
                

                

                
              </p>
              <div id="method-i-recent_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">729</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">recent</span>
<span class="line-num">730</span>   <span class="ruby-ivar">@users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;id desc&quot;</span> ).<span class="ruby-identifier">page</span>( <span class="ruby-value">1</span> ).<span class="ruby-identifier">per_page</span>( <span class="ruby-value">10</span> )
<span class="line-num">731</span>   <span class="ruby-ivar">@spammer</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:spammer</span>]
<span class="line-num">732</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@spammer</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@spammer</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;unknown&quot;</span>
<span class="line-num">733</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;spammer IS NULL&quot;</span> )
<span class="line-num">734</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@spammer</span>.<span class="ruby-identifier">yesish?</span>
<span class="line-num">735</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;spammer&quot;</span> )
<span class="line-num">736</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flagged_by</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;auto&quot;</span>
<span class="line-num">737</span>       <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:flags</span>).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;NOT resolved AND flag = &#39;spam&#39;&quot;</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;flags.user_id = 0&quot;</span> )
<span class="line-num">738</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:flagged_by</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;manual&quot;</span>
<span class="line-num">739</span>       <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:flags</span>).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;NOT flags.resolved AND flag = &#39;spam&#39;&quot;</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;flags.user_id &gt; 0&quot;</span> )
<span class="line-num">740</span>     <span class="ruby-keyword">end</span>
<span class="line-num">741</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@spammer</span>.<span class="ruby-identifier">noish?</span>
<span class="line-num">742</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;NOT spammer&quot;</span> )
<span class="line-num">743</span>   <span class="ruby-keyword">end</span>
<span class="line-num">744</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:obs</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">745</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations_count &gt; 0&quot;</span> )
<span class="line-num">746</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:obs</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num">747</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations_count = 0&quot;</span> )
<span class="line-num">748</span>   <span class="ruby-keyword">end</span>
<span class="line-num">749</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:ids</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">750</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications_count &gt; 0&quot;</span> )
<span class="line-num">751</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:ids</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num">752</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;identifications_count = 0&quot;</span> )
<span class="line-num">753</span>   <span class="ruby-keyword">end</span>
<span class="line-num">754</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:description</span>].<span class="ruby-identifier">yesish?</span>
<span class="line-num">755</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;description IS NOT NULL AND description != &#39;&#39;&quot;</span> )
<span class="line-num">756</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:description</span>].<span class="ruby-identifier">noish?</span>
<span class="line-num">757</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;description IS NULL OR description = &#39;&#39;&quot;</span> )
<span class="line-num">758</span>   <span class="ruby-keyword">end</span>
<span class="line-num">759</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="line-num">760</span>     <span class="ruby-ivar">@users</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;users.id &lt; ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">to_i</span> )
<span class="line-num">761</span>   <span class="ruby-keyword">end</span>
<span class="line-num">762</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:chart</span>]
<span class="line-num">763</span>     <span class="ruby-identifier">start_date</span> = <span class="ruby-value">3</span>.<span class="ruby-identifier">months</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">to_date</span>
<span class="line-num">764</span>     <span class="ruby-identifier">total_new_user_counts</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at &gt; ?&quot;</span>, <span class="ruby-identifier">start_date</span> ).<span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">765</span>     <span class="ruby-identifier">new_automated_spam_flag_counts</span> = <span class="ruby-constant">Flag</span>.
<span class="line-num">766</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;u.created_at &gt; ? AND flaggable_type = &#39;User&#39; AND flag = &#39;spam&#39; AND NOT resolved AND user_id = 0&quot;</span>, <span class="ruby-identifier">start_date</span> ).
<span class="line-num">767</span>       <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN users u ON u.id = flags.flaggable_id&quot;</span> ).
<span class="line-num">768</span>       <span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;u.created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">769</span>     <span class="ruby-identifier">new_manual_spam_flag_counts</span> = <span class="ruby-constant">Flag</span>.
<span class="line-num">770</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;u.created_at &gt; ? AND flaggable_type = &#39;User&#39; AND flag = &#39;spam&#39; AND NOT resolved AND user_id &gt; 0&quot;</span>, <span class="ruby-identifier">start_date</span> ).
<span class="line-num">771</span>       <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN users u ON u.id = flags.flaggable_id&quot;</span> ).
<span class="line-num">772</span>       <span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;u.created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">773</span>     <span class="ruby-identifier">probable_spam_user_counts</span> = <span class="ruby-constant">User</span>.
<span class="line-num">774</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;spammer IS NULL&quot;</span> ).
<span class="line-num">775</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;observations_count = 0 AND identifications_count = 0&quot;</span> ).
<span class="line-num">776</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;description IS NOT NULL AND description != &#39;&#39;&quot;</span> ).
<span class="line-num">777</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;created_at &gt; ?&quot;</span>, <span class="ruby-identifier">start_date</span> ).<span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">778</span>     <span class="ruby-identifier">false_positive_counts</span> = <span class="ruby-constant">Flag</span>.
<span class="line-num">779</span>       <span class="ruby-identifier">where</span>( <span class="ruby-string">&quot;u.created_at &gt; ? AND flaggable_type = &#39;User&#39; AND flag = &#39;spam&#39; AND resolved&quot;</span>, <span class="ruby-identifier">start_date</span> ).
<span class="line-num">780</span>       <span class="ruby-identifier">joins</span>( <span class="ruby-string">&quot;JOIN users u ON u.id = flags.flaggable_id&quot;</span> ).
<span class="line-num">781</span>       <span class="ruby-identifier">group</span>( <span class="ruby-string">&quot;u.created_at::date&quot;</span> ).<span class="ruby-identifier">count</span>
<span class="line-num">782</span>     <span class="ruby-ivar">@stats</span> = ( <span class="ruby-identifier">start_date</span><span class="ruby-operator">...</span><span class="ruby-constant">Date</span>.<span class="ruby-identifier">tomorrow</span> ).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
<span class="line-num">783</span>       {
<span class="line-num">784</span>         <span class="ruby-value">date:</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">to_s</span>,
<span class="line-num">785</span>         <span class="ruby-value">new_users:</span> <span class="ruby-identifier">total_new_user_counts</span>[<span class="ruby-identifier">d</span>],
<span class="line-num">786</span>         <span class="ruby-value">auto_spam:</span> <span class="ruby-identifier">new_automated_spam_flag_counts</span>[<span class="ruby-identifier">d</span>],
<span class="line-num">787</span>         <span class="ruby-value">manual_spam:</span> <span class="ruby-identifier">new_manual_spam_flag_counts</span>[<span class="ruby-identifier">d</span>],
<span class="line-num">788</span>         <span class="ruby-value">probable_spam:</span> <span class="ruby-identifier">probable_spam_user_counts</span>[<span class="ruby-identifier">d</span>],
<span class="line-num">789</span>         <span class="ruby-value">false_positives:</span> <span class="ruby-identifier">false_positive_counts</span>[<span class="ruby-identifier">d</span>]
<span class="line-num">790</span>       }
<span class="line-num">791</span>     <span class="ruby-keyword">end</span>
<span class="line-num">792</span>   <span class="ruby-keyword">end</span>
<span class="line-num">793</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">794</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span> }
<span class="line-num">795</span>   <span class="ruby-keyword">end</span>
<span class="line-num">796</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-relationships">
            
              <b>relationships</b>()
            
            <a href="../classes/UsersController.html#method-i-relationships" name="method-i-relationships" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-relationships_source')" id="l_method-i-relationships_source">show</a>
                

                

                
              </p>
              <div id="method-i-relationships_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">362</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">relationships</span>
<span class="line-num">363</span>   <span class="ruby-ivar">@friendships</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">page</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] )
<span class="line-num">364</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_role">
            
              <b>remove_role</b>()
            
            <a href="../classes/UsersController.html#method-i-remove_role" name="method-i-remove_role" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_role_source')" id="l_method-i-remove_role_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_role_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">113</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_role</span>
<span class="line-num">114</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@role</span> = <span class="ruby-constant">Role</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:role</span>])
<span class="line-num">115</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:that_role_doesnt_exist</span>)
<span class="line-num">116</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num">117</span>   <span class="ruby-keyword">end</span>
<span class="line-num">118</span> 
<span class="line-num">119</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">is_admin?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_admin?</span>
<span class="line-num">120</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>)
<span class="line-num">121</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num">122</span>   <span class="ruby-keyword">end</span>
<span class="line-num">123</span> 
<span class="line-num">124</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">roles</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@role</span>)
<span class="line-num">125</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-node">&quot;Removed #{@role.name} status from #{@user.login}&quot;</span>
<span class="line-num">126</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@role</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">===</span> <span class="ruby-constant">Role</span><span class="ruby-operator">::</span><span class="ruby-constant">CURATOR</span>
<span class="line-num">127</span>       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">curator_sponsor:</span> <span class="ruby-keyword">nil</span> )
<span class="line-num">128</span>     <span class="ruby-keyword">end</span>
<span class="line-num">129</span>   <span class="ruby-keyword">else</span>
<span class="line-num">130</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-node">&quot;#{@user.login} doesn&#39;t have #{@role.name} status&quot;</span>
<span class="line-num">131</span>   <span class="ruby-keyword">end</span>
<span class="line-num">132</span>   <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-ivar">@user</span>
<span class="line-num">133</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_spammer">
            
              <b>set_spammer</b>()
            
            <a href="../classes/UsersController.html#method-i-set_spammer" name="method-i-set_spammer" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-set_spammer_source')" id="l_method-i-set_spammer_source">show</a>
                

                

                
              </p>
              <div id="method-i-set_spammer_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">197</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_spammer</span>
<span class="line-num">198</span>   <span class="ruby-keyword">if</span> [ <span class="ruby-string">&quot;true&quot;</span>, <span class="ruby-string">&quot;false&quot;</span> ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:spammer</span>])
<span class="line-num">199</span>     <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">spammer:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:spammer</span>])
<span class="line-num">200</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:spammer</span>] <span class="ruby-operator">===</span> <span class="ruby-string">&quot;false&quot;</span>
<span class="line-num">201</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:user_flagged_as_a_non_spammer_html</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">link_to_user</span>( <span class="ruby-ivar">@user</span> ) )
<span class="line-num">202</span>       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">flags_on_spam_content</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">flag</span><span class="ruby-operator">|</span>
<span class="line-num">203</span>         <span class="ruby-identifier">flag</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">resolved:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">resolver:</span> <span class="ruby-identifier">current_user</span>)
<span class="line-num">204</span>       <span class="ruby-keyword">end</span>
<span class="line-num">205</span>       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">flags</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">flag:</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">SPAM</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-value">resolved:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">resolver_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">206</span>       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">unsuspend!</span>
<span class="line-num">207</span>     <span class="ruby-keyword">else</span>
<span class="line-num">208</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:user_flagged_as_a_spammer_html</span>, <span class="ruby-value">user:</span> <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">link_to_user</span>( <span class="ruby-ivar">@user</span> ) )
<span class="line-num">209</span>       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">add_flag</span>( <span class="ruby-value">flag:</span> <span class="ruby-constant">Flag</span><span class="ruby-operator">::</span><span class="ruby-constant">SPAM</span>, <span class="ruby-value">user_id:</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span> )
<span class="line-num">210</span>     <span class="ruby-keyword">end</span>
<span class="line-num">211</span>   <span class="ruby-keyword">end</span>
<span class="line-num">212</span>   <span class="ruby-identifier">redirect_back_or_default</span>( <span class="ruby-ivar">@user</span> )
<span class="line-num">213</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-show">
            
              <b>show</b>()
            
            <a href="../classes/UsersController.html#method-i-show" name="method-i-show" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-show_source')" id="l_method-i-show_source">show</a>
                

                

                
              </p>
              <div id="method-i-show_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">298</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">show</span>
<span class="line-num">299</span>   <span class="ruby-ivar">@selected_user</span> = <span class="ruby-ivar">@user</span>
<span class="line-num">300</span>   <span class="ruby-ivar">@login</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">login</span>
<span class="line-num">301</span>   <span class="ruby-ivar">@followees</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">followees</span>.<span class="ruby-identifier">page</span>( <span class="ruby-value">1</span> ).<span class="ruby-identifier">per_page</span>( <span class="ruby-value">15</span> ).<span class="ruby-identifier">order</span>( <span class="ruby-string">&quot;users.id desc&quot;</span> )
<span class="line-num">302</span>   <span class="ruby-ivar">@favorites_list</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">lists</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-string">&quot;Favorites&quot;</span>)
<span class="line-num">303</span>   <span class="ruby-ivar">@favorites_list</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">lists</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-identifier">t</span>(<span class="ruby-value">:favorites</span>))
<span class="line-num">304</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@favorites_list</span>
<span class="line-num">305</span>     <span class="ruby-ivar">@favorite_listed_taxa</span> = <span class="ruby-ivar">@favorites_list</span>.<span class="ruby-identifier">listed_taxa</span>.
<span class="line-num">306</span>       <span class="ruby-identifier">includes</span>(<span class="ruby-value">taxon:</span> [<span class="ruby-value">:photos</span>, <span class="ruby-value">:taxon_names</span> ]).
<span class="line-num">307</span>       <span class="ruby-identifier">paginate</span>(<span class="ruby-value">page:</span> <span class="ruby-value">1</span>, <span class="ruby-value">per_page:</span> <span class="ruby-value">15</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;listed_taxa.id desc&quot;</span>)
<span class="line-num">308</span>   <span class="ruby-keyword">end</span>
<span class="line-num">309</span> 
<span class="line-num">310</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">311</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">312</span>       <span class="ruby-ivar">@shareable_image_url</span> = <span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">icon</span>.<span class="ruby-identifier">url</span>(<span class="ruby-value">:original</span>))
<span class="line-num">313</span>       <span class="ruby-ivar">@shareable_description</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">description</span>
<span class="line-num">314</span>       <span class="ruby-ivar">@shareable_description</span> = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>(<span class="ruby-value">:user_is_a_naturalist</span>, <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">login</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@shareable_description</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">315</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">last_active</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">316</span>         <span class="ruby-identifier">times</span> = [
<span class="line-num">317</span>           <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_query</span>(
<span class="line-num">318</span>             <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">319</span>             <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;created_at&quot;</span>,
<span class="line-num">320</span>             <span class="ruby-value">order:</span> <span class="ruby-string">&quot;desc&quot;</span>
<span class="line-num">321</span>           ).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:created_at</span>)
<span class="line-num">322</span>         ]
<span class="line-num">323</span>         <span class="ruby-identifier">idents</span> = <span class="ruby-constant">INatAPIService</span>.<span class="ruby-identifier">identifications</span>(
<span class="line-num">324</span>           <span class="ruby-value">user_id:</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">id</span>,
<span class="line-num">325</span>           <span class="ruby-value">order_by:</span> <span class="ruby-string">&quot;created_at&quot;</span>,
<span class="line-num">326</span>           <span class="ruby-value">order:</span> <span class="ruby-string">&quot;desc&quot;</span>,
<span class="line-num">327</span>           <span class="ruby-value">is_change:</span> <span class="ruby-keyword">false</span>
<span class="line-num">328</span>         )
<span class="line-num">329</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">idents</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">results</span>
<span class="line-num">330</span>           <span class="ruby-identifier">times</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">idents</span>.<span class="ruby-identifier">results</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-string">&quot;created_at&quot;</span> ).<span class="ruby-identifier">try</span>(<span class="ruby-value">:to_time</span>)
<span class="line-num">331</span>         <span class="ruby-keyword">end</span>
<span class="line-num">332</span>         <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">last_active</span> = <span class="ruby-identifier">times</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">in_time_zone</span>( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span> ).<span class="ruby-identifier">to_date</span> }.<span class="ruby-identifier">last</span>
<span class="line-num">333</span>       <span class="ruby-keyword">end</span>
<span class="line-num">334</span>       <span class="ruby-ivar">@donor_since</span> = <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">display_donor_since</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">display_donor_since</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="line-num">335</span>       <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">336</span>     <span class="ruby-keyword">end</span>
<span class="line-num">337</span>     <span class="ruby-identifier">opts</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">default_json_options</span>
<span class="line-num">338</span>     <span class="ruby-identifier">opts</span>[<span class="ruby-value">:only</span>] <span class="ruby-operator">||=</span> []
<span class="line-num">339</span>     <span class="ruby-identifier">opts</span>[<span class="ruby-value">:only</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:description</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">known_non_spammer?</span>
<span class="line-num">340</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@selected_user</span>.<span class="ruby-identifier">to_json</span>( <span class="ruby-identifier">opts</span> ) }
<span class="line-num">341</span>   <span class="ruby-keyword">end</span>
<span class="line-num">342</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-suspend">
            
              <b>suspend</b>()
            
            <a href="../classes/UsersController.html#method-i-suspend" name="method-i-suspend" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-suspend_source')" id="l_method-i-suspend_source">show</a>
                

                

                
              </p>
              <div id="method-i-suspend_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">68</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">suspend</span>
<span class="line-num">69</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">suspended?</span>
<span class="line-num">70</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-string">&quot;You cannot suspend someone who is already suspended&quot;</span>
<span class="line-num">71</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-identifier">person_path</span>( <span class="ruby-ivar">@user</span> )
<span class="line-num">72</span>   <span class="ruby-keyword">end</span>
<span class="line-num">73</span>   <span class="ruby-ivar">@moderator_action</span> = <span class="ruby-constant">ModeratorAction</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">74</span>     <span class="ruby-value">resource:</span> <span class="ruby-ivar">@user</span>,
<span class="line-num">75</span>     <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">76</span>     <span class="ruby-value">action:</span> <span class="ruby-constant">ModeratorAction</span><span class="ruby-operator">::</span><span class="ruby-constant">SUSPEND</span>
<span class="line-num">77</span>   )
<span class="line-num">78</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">79</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-trust">
            
              <b>trust</b>()
            
            <a href="../classes/UsersController.html#method-i-trust" name="method-i-trust" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-trust_source')" id="l_method-i-trust_source">show</a>
                

                

                
              </p>
              <div id="method-i-trust_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">858</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">trust</span>
<span class="line-num">859</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">860</span>     <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">trust:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">861</span>   <span class="ruby-keyword">else</span>
<span class="line-num">862</span>     <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">create!</span>( <span class="ruby-value">friend:</span> <span class="ruby-ivar">@user</span>, <span class="ruby-value">trust:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">following:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">863</span>   <span class="ruby-keyword">end</span>
<span class="line-num">864</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">865</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">friendship:</span> <span class="ruby-identifier">friendship</span> } }
<span class="line-num">866</span>   <span class="ruby-keyword">end</span>
<span class="line-num">867</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unblock">
            
              <b>unblock</b>()
            
            <a href="../classes/UsersController.html#method-i-unblock" name="method-i-unblock" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unblock_source')" id="l_method-i-unblock_source">show</a>
                

                

                
              </p>
              <div id="method-i-unblock_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">945</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unblock</span>
<span class="line-num">946</span>   <span class="ruby-ivar">@user_block</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_blocks</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">blocked_user_id:</span> <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">947</span>   <span class="ruby-ivar">@user_block</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_block</span>
<span class="line-num">948</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">949</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">950</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_block</span>
<span class="line-num">951</span>         <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">952</span>       <span class="ruby-keyword">else</span>
<span class="line-num">953</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">errors:</span> [<span class="ruby-node">&quot;User #{@user.id} was not blocked&quot;</span>] }
<span class="line-num">954</span>       <span class="ruby-keyword">end</span>
<span class="line-num">955</span>     <span class="ruby-keyword">end</span>
<span class="line-num">956</span>   <span class="ruby-keyword">end</span>
<span class="line-num">957</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unmute">
            
              <b>unmute</b>()
            
            <a href="../classes/UsersController.html#method-i-unmute" name="method-i-unmute" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unmute_source')" id="l_method-i-unmute_source">show</a>
                

                

                
              </p>
              <div id="method-i-unmute_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">917</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unmute</span>
<span class="line-num">918</span>   <span class="ruby-ivar">@user_mute</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">user_mutes</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">muted_user_id:</span> <span class="ruby-ivar">@user</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">919</span>   <span class="ruby-ivar">@user_mute</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_mute</span>
<span class="line-num">920</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">921</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">922</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user_mute</span>
<span class="line-num">923</span>         <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">924</span>       <span class="ruby-keyword">else</span>
<span class="line-num">925</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">errors:</span> [<span class="ruby-node">&quot;User #{@user.id} was not muted&quot;</span>] }
<span class="line-num">926</span>       <span class="ruby-keyword">end</span>
<span class="line-num">927</span>     <span class="ruby-keyword">end</span>
<span class="line-num">928</span>   <span class="ruby-keyword">end</span>
<span class="line-num">929</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-unsuspend">
            
              <b>unsuspend</b>()
            
            <a href="../classes/UsersController.html#method-i-unsuspend" name="method-i-unsuspend" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-unsuspend_source')" id="l_method-i-unsuspend_source">show</a>
                

                

                
              </p>
              <div id="method-i-unsuspend_source" class="dyn-source">
                <pre>   <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">81</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unsuspend</span>
<span class="line-num">82</span>   <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">suspended?</span>
<span class="line-num">83</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-string">&quot;You cannot unsuspend someone who is not suspended&quot;</span>
<span class="line-num">84</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_back_or_default</span> <span class="ruby-identifier">person_path</span>( <span class="ruby-ivar">@user</span> )
<span class="line-num">85</span>   <span class="ruby-keyword">end</span>
<span class="line-num">86</span>   <span class="ruby-ivar">@moderator_action</span> = <span class="ruby-constant">ModeratorAction</span>.<span class="ruby-identifier">new</span>(
<span class="line-num">87</span>     <span class="ruby-value">resource:</span> <span class="ruby-ivar">@user</span>,
<span class="line-num">88</span>     <span class="ruby-value">user:</span> <span class="ruby-identifier">current_user</span>,
<span class="line-num">89</span>     <span class="ruby-value">action:</span> <span class="ruby-constant">ModeratorAction</span><span class="ruby-operator">::</span><span class="ruby-constant">UNSUSPEND</span>
<span class="line-num">90</span>   )
<span class="line-num">91</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">92</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-untrust">
            
              <b>untrust</b>()
            
            <a href="../classes/UsersController.html#method-i-untrust" name="method-i-untrust" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-untrust_source')" id="l_method-i-untrust_source">show</a>
                

                

                
              </p>
              <div id="method-i-untrust_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">869</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">untrust</span>
<span class="line-num">870</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">871</span>     <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">trust:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">872</span>   <span class="ruby-keyword">end</span>
<span class="line-num">873</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">874</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">json:</span> { <span class="ruby-value">friendship:</span> <span class="ruby-identifier">friendship</span> } }
<span class="line-num">875</span>   <span class="ruby-keyword">end</span>
<span class="line-num">876</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update">
            
              <b>update</b>()
            
            <a href="../classes/UsersController.html#method-i-update" name="method-i-update" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_source')" id="l_method-i-update_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">617</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>
<span class="line-num">618</span>   <span class="ruby-ivar">@display_user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">619</span>   <span class="ruby-ivar">@login</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">login</span>
<span class="line-num">620</span>   <span class="ruby-ivar">@original_user</span> = <span class="ruby-ivar">@display_user</span>
<span class="line-num">621</span>   
<span class="line-num">622</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_friend</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:friend_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">623</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">remove_friend</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:remove_friend_id</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">624</span>   <span class="ruby-keyword">return</span> <span class="ruby-identifier">update_password</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">params</span>[<span class="ruby-value">:password</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:commit</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/password/i</span>)
<span class="line-num">625</span>   
<span class="line-num">626</span>   <span class="ruby-comment"># Nix the icon_url if an icon file was provided</span>
<span class="line-num">627</span>   <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">icon_url</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">try</span>(<span class="ruby-value">:[]</span>, <span class="ruby-value">:icon</span>)
<span class="line-num">628</span>   <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">icon</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:icon_delete</span>]
<span class="line-num">629</span>   
<span class="line-num">630</span>   <span class="ruby-identifier">locale_was</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">631</span>   <span class="ruby-identifier">preferred_project_addition_by_was</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">preferred_project_addition_by</span>
<span class="line-num">632</span> 
<span class="line-num">633</span>   <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">assign_attributes</span>( <span class="ruby-identifier">permit_params</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">permit_params</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">634</span>   <span class="ruby-identifier">place_id_changed</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">will_save_change_to_place_id?</span>
<span class="line-num">635</span>   <span class="ruby-identifier">prefers_no_place_changed</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">prefers_no_place_changed?</span>
<span class="line-num">636</span>   <span class="ruby-identifier">prefers_no_site_changed</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">prefers_no_site_changed?</span>
<span class="line-num">637</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">save</span>
<span class="line-num">638</span>     <span class="ruby-comment"># user changed their project addition rules and nothing else, so</span>
<span class="line-num">639</span>     <span class="ruby-comment"># updated_at wasn&#39;t touched on user. Set set updated_at on the user</span>
<span class="line-num">640</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">preferred_project_addition_by</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">preferred_project_addition_by_was</span> <span class="ruby-operator">&amp;&amp;</span>
<span class="line-num">641</span>        <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">previous_changes</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">642</span>       <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">update_columns</span>(<span class="ruby-value">updated_at:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
<span class="line-num">643</span>     <span class="ruby-keyword">end</span>
<span class="line-num">644</span>     <span class="ruby-identifier">bypass_sign_in</span>( <span class="ruby-ivar">@display_user</span> )
<span class="line-num">645</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">646</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">647</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">locale_was</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">648</span>           <span class="ruby-identifier">session</span>[<span class="ruby-value">:locale</span>] = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">locale</span>
<span class="line-num">649</span>         <span class="ruby-keyword">end</span>
<span class="line-num">650</span> 
<span class="line-num">651</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_id_changed</span>
<span class="line-num">652</span>           <span class="ruby-identifier">session</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:potential_place</span>)
<span class="line-num">653</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from_potential_place</span>]
<span class="line-num">654</span>             <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;views.users.edit.place_preference_changed_notice_html&quot;</span> )
<span class="line-num">655</span>           <span class="ruby-keyword">end</span>
<span class="line-num">656</span>         <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">prefers_no_place_changed</span>
<span class="line-num">657</span>           <span class="ruby-identifier">session</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:potential_place</span>)
<span class="line-num">658</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from_potential_place</span>]
<span class="line-num">659</span>             <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;views.users.edit.if_you_change_your_mind_you_can_always_edit_your_settings_html&quot;</span> )
<span class="line-num">660</span>           <span class="ruby-keyword">end</span>
<span class="line-num">661</span>         <span class="ruby-keyword">end</span>
<span class="line-num">662</span> 
<span class="line-num">663</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">prefers_no_site_changed</span>
<span class="line-num">664</span>           <span class="ruby-identifier">session</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:potential_site</span>)
<span class="line-num">665</span>           <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from_potential_site</span>]
<span class="line-num">666</span>             <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">t</span>( <span class="ruby-string">&quot;views.users.edit.if_you_change_your_mind_you_can_always_edit_your_settings_html&quot;</span> )
<span class="line-num">667</span>           <span class="ruby-keyword">end</span>
<span class="line-num">668</span>         <span class="ruby-keyword">end</span>
<span class="line-num">669</span> 
<span class="line-num">670</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from_edit_after_auth</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">671</span>           <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:your_profile_was_successfully_updated</span>)
<span class="line-num">672</span>           <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">person_by_login_path</span>(<span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">673</span>         <span class="ruby-keyword">else</span>
<span class="line-num">674</span>           <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">dashboard_path</span>)
<span class="line-num">675</span>         <span class="ruby-keyword">end</span>
<span class="line-num">676</span>       <span class="ruby-keyword">end</span>
<span class="line-num">677</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">678</span>         <span class="ruby-constant">User</span>.<span class="ruby-identifier">refresh_es_index</span>
<span class="line-num">679</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">to_json</span>(<span class="ruby-constant">User</span>.<span class="ruby-identifier">default_json_options</span>)
<span class="line-num">680</span>       <span class="ruby-keyword">end</span>
<span class="line-num">681</span>     <span class="ruby-keyword">end</span>
<span class="line-num">682</span>   <span class="ruby-keyword">else</span>
<span class="line-num">683</span>     <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">login</span> = <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">login_was</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:login</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">684</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">685</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">686</span>         <span class="ruby-identifier">before_edit</span>
<span class="line-num">687</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&#39;HTTP_REFERER&#39;</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/edit_after_auth/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:from_edit_after_auth</span>]
<span class="line-num">688</span>           <span class="ruby-identifier">load_registration_form_data</span>
<span class="line-num">689</span>           <span class="ruby-identifier">render</span> <span class="ruby-string">&quot;users/registrations/new&quot;</span>, <span class="ruby-value">layout:</span> <span class="ruby-string">&quot;bootstrap&quot;</span>
<span class="line-num">690</span>         <span class="ruby-keyword">else</span>
<span class="line-num">691</span>           <span class="ruby-identifier">render</span> <span class="ruby-value">:action</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&#39;edit&#39;</span>, <span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@original_user</span>.<span class="ruby-identifier">login</span>
<span class="line-num">692</span>         <span class="ruby-keyword">end</span>
<span class="line-num">693</span>       <span class="ruby-keyword">end</span>
<span class="line-num">694</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">695</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:errors</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@display_user</span>.<span class="ruby-identifier">errors</span>}, <span class="ruby-value">:status</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-value">:unprocessable_entity</span>
<span class="line-num">696</span>       <span class="ruby-keyword">end</span>
<span class="line-num">697</span>     <span class="ruby-keyword">end</span>
<span class="line-num">698</span>   <span class="ruby-keyword">end</span>
<span class="line-num">699</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_session">
            
              <b>update_session</b>()
            
            <a href="../classes/UsersController.html#method-i-update_session" name="method-i-update_session" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_session_source')" id="l_method-i-update_session_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_session_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">808</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_session</span>
<span class="line-num">809</span>   <span class="ruby-identifier">allowed_patterns</span> = [
<span class="line-num">810</span>     <span class="ruby-regexp">/^show_quality_metrics$/</span>,
<span class="line-num">811</span>     <span class="ruby-regexp">/^user-seen-ann*/</span>,
<span class="line-num">812</span>     <span class="ruby-regexp">/^prefers_*/</span>,
<span class="line-num">813</span>     <span class="ruby-regexp">/^preferred_*/</span>,
<span class="line-num">814</span>     <span class="ruby-regexp">/^header_search_open$/</span>
<span class="line-num">815</span>   ]
<span class="line-num">816</span>   <span class="ruby-identifier">updates</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">to_unsafe_h</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">817</span>     <span class="ruby-identifier">allowed_patterns</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> 
<span class="line-num">818</span>       <span class="ruby-identifier">k</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">p</span>)
<span class="line-num">819</span>     }
<span class="line-num">820</span>   }.<span class="ruby-identifier">symbolize_keys</span>
<span class="line-num">821</span>   <span class="ruby-identifier">updates</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">822</span>     <span class="ruby-identifier">v</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">yesish?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;1&quot;</span>
<span class="line-num">823</span>     <span class="ruby-identifier">v</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">noish?</span>
<span class="line-num">824</span>     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>
<span class="line-num">825</span>     <span class="ruby-keyword">if</span> (<span class="ruby-identifier">k</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^prefers_/</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^preferred_/</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">k</span>)
<span class="line-num">826</span>       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">k</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">v</span>)
<span class="line-num">827</span>     <span class="ruby-keyword">end</span>
<span class="line-num">828</span>   <span class="ruby-keyword">end</span>
<span class="line-num">829</span>   <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span>
<span class="line-num">830</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-updates_count">
            
              <b>updates_count</b>()
            
            <a href="../classes/UsersController.html#method-i-updates_count" name="method-i-updates_count" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-updates_count_source')" id="l_method-i-updates_count_source">show</a>
                

                

                
              </p>
              <div id="method-i-updates_count_source" class="dyn-source">
                <pre>    <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">539</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">updates_count</span>
<span class="line-num">540</span>   <span class="ruby-identifier">count</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">recent_notifications</span>(<span class="ruby-value">unviewed:</span> <span class="ruby-keyword">true</span>,
<span class="line-num">541</span>     <span class="ruby-value">filters:</span> [ { <span class="ruby-value">terms:</span> { <span class="ruby-value">notification:</span> [ <span class="ruby-string">&quot;activity&quot;</span>, <span class="ruby-string">&quot;mention&quot;</span> ] } } ], <span class="ruby-value">per_page:</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">total_entries</span>
<span class="line-num">542</span>   <span class="ruby-identifier">session</span>[<span class="ruby-value">:updates_count</span>] = <span class="ruby-identifier">count</span>
<span class="line-num">543</span>   <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:count</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">count</span>}
<span class="line-num">544</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
      <h2 class="sectiontitle">Instance Protected methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-add_friend">
            
              <b>add_friend</b>()
            
            <a href="../classes/UsersController.html#method-i-add_friend" name="method-i-add_friend" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-add_friend_source')" id="l_method-i-add_friend_source">show</a>
                

                

                
              </p>
              <div id="method-i-add_friend_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1030</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_friend</span>
<span class="line-num">1031</span>   <span class="ruby-identifier">error_msg</span>, <span class="ruby-identifier">notice_msg</span> = [<span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>]
<span class="line-num">1032</span>   <span class="ruby-identifier">friend_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:friend_id</span>])
<span class="line-num">1033</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">friend_user</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">friend_user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">following:</span> <span class="ruby-keyword">true</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1034</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:either_that_user_doesnt_exist_or</span>)
<span class="line-num">1035</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1036</span>     <span class="ruby-identifier">notice_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_are_now_following_x</span>, <span class="ruby-value">:friend_user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">friend_user</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">1037</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">friend_id:</span> <span class="ruby-identifier">friend_user</span>.<span class="ruby-identifier">id</span> ).<span class="ruby-identifier">first</span>
<span class="line-num">1038</span>       <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">following:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1039</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1040</span>       <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">create</span>( <span class="ruby-value">friend:</span> <span class="ruby-identifier">friend_user</span>, <span class="ruby-value">following:</span> <span class="ruby-keyword">true</span> )
<span class="line-num">1041</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1042</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1043</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1044</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1045</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">error_msg</span>
<span class="line-num">1046</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">notice_msg</span>
<span class="line-num">1047</span>       <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">person_by_login_path</span>(<span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">1048</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1049</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:msg</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">error_msg</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">notice_msg</span>, <span class="ruby-value">:friendship</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">friendship</span>} }
<span class="line-num">1050</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1051</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-before_edit">
            
              <b>before_edit</b>()
            
            <a href="../classes/UsersController.html#method-i-before_edit" name="method-i-before_edit" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-before_edit_source')" id="l_method-i-before_edit_source">show</a>
                

                

                
              </p>
              <div id="method-i-before_edit_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1275</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_edit</span>
<span class="line-num">1276</span>   <span class="ruby-ivar">@sites</span> = <span class="ruby-constant">Site</span>.<span class="ruby-identifier">live</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>)
<span class="line-num">1277</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
<span class="line-num">1278</span>     <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">site_id</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:id</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@sites</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1279</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1280</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-counts_for_users">
            
              <b>counts_for_users</b>()
            
            <a href="../classes/UsersController.html#method-i-counts_for_users" name="method-i-counts_for_users" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-counts_for_users_source')" id="l_method-i-counts_for_users_source">show</a>
                

                

                
              </p>
              <div id="method-i-counts_for_users_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1117</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">counts_for_users</span>
<span class="line-num">1118</span>   <span class="ruby-ivar">@species_counts</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">i</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">i</span>.<span class="ruby-identifier">species_count</span>] }.<span class="ruby-identifier">to_h</span>
<span class="line-num">1119</span>   <span class="ruby-ivar">@post_counts</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">user_id:</span> <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">to_a</span>, <span class="ruby-value">parent_type:</span> <span class="ruby-string">&quot;User&quot;</span>).<span class="ruby-identifier">group</span>(<span class="ruby-value">:user_id</span>).<span class="ruby-identifier">count</span>
<span class="line-num">1120</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-ensure_user_is_current_user_or_admin">
            
              <b>ensure_user_is_current_user_or_admin</b>()
            
            <a href="../classes/UsersController.html#method-i-ensure_user_is_current_user_or_admin" name="method-i-ensure_user_is_current_user_or_admin" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-ensure_user_is_current_user_or_admin_source')" id="l_method-i-ensure_user_is_current_user_or_admin_source">show</a>
                

                

                
              </p>
              <div id="method-i-ensure_user_is_current_user_or_admin_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1104</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ensure_user_is_current_user_or_admin</span>
<span class="line-num">1105</span>   <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">has_role?</span>( <span class="ruby-value">:admin</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
<span class="line-num">1106</span>     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1107</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1108</span>         <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_user_path</span>(<span class="ruby-identifier">current_user</span>, <span class="ruby-value">:id</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">1109</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1110</span>       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
<span class="line-num">1111</span>         <span class="ruby-identifier">render</span> <span class="ruby-value">status:</span> <span class="ruby-value">:unprocessable_entity</span>, <span class="ruby-value">json:</span> { <span class="ruby-value">error:</span> <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_dont_have_permission_to_do_that</span>) }
<span class="line-num">1112</span>       <span class="ruby-keyword">end</span>
<span class="line-num">1113</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1114</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1115</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-find_user">
            
              <b>find_user</b>()
            
            <a href="../classes/UsersController.html#method-i-find_user" name="method-i-find_user" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-find_user_source')" id="l_method-i-find_user_source">show</a>
                

                

                
              </p>
              <div id="method-i-find_user_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1093</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_user</span>
<span class="line-num">1094</span>   <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:login</span>]
<span class="line-num">1095</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1096</span>     <span class="ruby-ivar">@user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="line-num">1097</span>   <span class="ruby-keyword">rescue</span>
<span class="line-num">1098</span>     <span class="ruby-ivar">@user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;lower(login) = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>).<span class="ruby-identifier">first</span>
<span class="line-num">1099</span>     <span class="ruby-ivar">@user</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>( <span class="ruby-value">uuid:</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] ).<span class="ruby-identifier">first</span>
<span class="line-num">1100</span>     <span class="ruby-identifier">render_404</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">blank?</span>
<span class="line-num">1101</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1102</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-most_identifications">
            
              <b>most_identifications</b>(options = {})
            
            <a href="../classes/UsersController.html#method-i-most_identifications" name="method-i-most_identifications" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-most_identifications_source')" id="l_method-i-most_identifications_source">show</a>
                

                

                
              </p>
              <div id="method-i-most_identifications_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1158</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">most_identifications</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1159</span>   <span class="ruby-identifier">per</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:per</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1160</span>   <span class="ruby-identifier">year</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:year</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>
<span class="line-num">1161</span>   <span class="ruby-identifier">month</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:month</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>
<span class="line-num">1162</span>   <span class="ruby-identifier">site_filter</span> = <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">1163</span>   <span class="ruby-identifier">filters</span> = [
<span class="line-num">1164</span>     { <span class="ruby-value">term:</span> { <span class="ruby-value">own_observation:</span> <span class="ruby-keyword">false</span> } }
<span class="line-num">1165</span>     <span class="ruby-comment"># Uncomment if / when we want to only show ident stats from verifiable obs</span>
<span class="line-num">1166</span>     <span class="ruby-comment"># {</span>
<span class="line-num">1167</span>     <span class="ruby-comment">#   terms: {</span>
<span class="line-num">1168</span>     <span class="ruby-comment">#     &quot;observation.quality_grade&quot;: [Observation::RESEARCH_GRADE, Observation::NEEDS_ID]</span>
<span class="line-num">1169</span>     <span class="ruby-comment">#   }</span>
<span class="line-num">1170</span>     <span class="ruby-comment"># }</span>
<span class="line-num">1171</span>   ]
<span class="line-num">1172</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">per</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1173</span>     <span class="ruby-identifier">date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-node">&quot;#{ year }-#{ month }-1&quot;</span>)
<span class="line-num">1174</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">created_at:</span> {
<span class="line-num">1175</span>       <span class="ruby-value">gte:</span> <span class="ruby-identifier">date</span>,
<span class="line-num">1176</span>       <span class="ruby-value">lte:</span> <span class="ruby-identifier">date</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>
<span class="line-num">1177</span>     }}}
<span class="line-num">1178</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1179</span>     <span class="ruby-identifier">date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-node">&quot;#{ year }-1-1&quot;</span>)
<span class="line-num">1180</span>     <span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-value">range:</span> { <span class="ruby-value">created_at:</span> {
<span class="line-num">1181</span>       <span class="ruby-value">gte:</span> <span class="ruby-identifier">date</span>,
<span class="line-num">1182</span>       <span class="ruby-value">lte:</span> <span class="ruby-identifier">date</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">year</span>
<span class="line-num">1183</span>     }}}
<span class="line-num">1184</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1185</span> 
<span class="line-num">1186</span>   <span class="ruby-comment"># This is brittle and will continue to cause problems for individual sites</span>
<span class="line-num">1187</span>   <span class="ruby-comment"># as we grow and their top users fall out of the global top 500.</span>
<span class="line-num">1188</span>   <span class="ruby-identifier">result</span> = <span class="ruby-constant">Identification</span>.<span class="ruby-identifier">elastic_search</span>(
<span class="line-num">1189</span>     <span class="ruby-value">filters:</span> <span class="ruby-identifier">filters</span>,
<span class="line-num">1190</span>     <span class="ruby-value">size:</span> <span class="ruby-value">0</span>,
<span class="line-num">1191</span>     <span class="ruby-value">aggregate:</span> {
<span class="line-num">1192</span>       <span class="ruby-value">obs:</span> {
<span class="line-num">1193</span>         <span class="ruby-value">terms:</span> { <span class="ruby-value">field:</span> <span class="ruby-string">&quot;user.id&quot;</span>, <span class="ruby-value">size:</span> <span class="ruby-identifier">site_filter</span> <span class="ruby-operator">?</span> <span class="ruby-value">500</span> <span class="ruby-operator">:</span> <span class="ruby-value">20</span> }
<span class="line-num">1194</span>       }
<span class="line-num">1195</span>     }
<span class="line-num">1196</span>   )
<span class="line-num">1197</span> 
<span class="line-num">1198</span>   <span class="ruby-identifier">user_counts</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">response</span>.<span class="ruby-identifier">aggregations</span>.<span class="ruby-identifier">obs</span>.
<span class="line-num">1199</span>     <span class="ruby-identifier">buckets</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span> { <span class="ruby-value">user_id:</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;key&quot;</span>], <span class="ruby-value">count:</span> <span class="ruby-identifier">b</span>[<span class="ruby-string">&quot;doc_count&quot;</span>] } }
<span class="line-num">1200</span>   <span class="ruby-identifier">users_scope</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">uc</span><span class="ruby-operator">|</span> <span class="ruby-identifier">uc</span>[<span class="ruby-value">:user_id</span>] })
<span class="line-num">1201</span>   <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">1202</span>     <span class="ruby-comment"># only return users associated with the site</span>
<span class="line-num">1203</span>     <span class="ruby-identifier">users_scope</span> = <span class="ruby-identifier">users_scope</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">site_id:</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span>)
<span class="line-num">1204</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1205</span>   <span class="ruby-identifier">users</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">users_scope</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">u</span> ] }]
<span class="line-num">1206</span>   <span class="ruby-comment"># assign user instances into their user_counts</span>
<span class="line-num">1207</span>   <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">uc</span><span class="ruby-operator">|</span> <span class="ruby-identifier">uc</span>[<span class="ruby-value">:user</span>] = <span class="ruby-identifier">users</span>[<span class="ruby-identifier">uc</span>[<span class="ruby-value">:user_id</span>]] <span class="ruby-keyword">if</span> <span class="ruby-identifier">users</span>[<span class="ruby-identifier">uc</span>[<span class="ruby-value">:user_id</span>]] }
<span class="line-num">1208</span>   <span class="ruby-comment"># return the top 5 user_counts with users</span>
<span class="line-num">1209</span>   <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">uc</span><span class="ruby-operator">|</span> <span class="ruby-identifier">uc</span>[<span class="ruby-value">:user</span>] }[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">5</span>].<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">uc</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">uc</span>[<span class="ruby-value">:user</span>], <span class="ruby-identifier">uc</span>[<span class="ruby-value">:count</span>] ]}]
<span class="line-num">1210</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-most_observations">
            
              <b>most_observations</b>(options = {})
            
            <a href="../classes/UsersController.html#method-i-most_observations" name="method-i-most_observations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-most_observations_source')" id="l_method-i-most_observations_source">show</a>
                

                

                
              </p>
              <div id="method-i-most_observations_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1122</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">most_observations</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1123</span>   <span class="ruby-identifier">per</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:per</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1124</span>   <span class="ruby-identifier">year</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:year</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>
<span class="line-num">1125</span>   <span class="ruby-identifier">month</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:month</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>
<span class="line-num">1126</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">per</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1127</span>     <span class="ruby-identifier">elastic_params</span> = { <span class="ruby-value">observed_on_year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">observed_on_month:</span> <span class="ruby-identifier">month</span> }
<span class="line-num">1128</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1129</span>     <span class="ruby-identifier">elastic_params</span> = { <span class="ruby-value">observed_on_year:</span> <span class="ruby-identifier">year</span> }
<span class="line-num">1130</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1131</span>   <span class="ruby-identifier">elastic_params</span>[<span class="ruby-value">:verifiable</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1132</span>   <span class="ruby-identifier">elastic_params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">1133</span>   <span class="ruby-identifier">elastic_query</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>(<span class="ruby-identifier">elastic_params</span>)
<span class="line-num">1134</span>   <span class="ruby-identifier">counts</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_user_observation_counts</span>(<span class="ruby-identifier">elastic_query</span>, <span class="ruby-value">5</span>)
<span class="line-num">1135</span>   <span class="ruby-identifier">user_counts</span> = <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">counts</span>[<span class="ruby-value">:counts</span>].<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;user_id&quot;</span>], <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;count_all&quot;</span>] ] } ]
<span class="line-num">1136</span>   <span class="ruby-identifier">users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">keys</span>).<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1137</span>   <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">users</span>[<span class="ruby-identifier">id</span>].<span class="ruby-identifier">first</span>, <span class="ruby-identifier">c</span> ] } ]
<span class="line-num">1138</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-most_species">
            
              <b>most_species</b>(options = {})
            
            <a href="../classes/UsersController.html#method-i-most_species" name="method-i-most_species" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-most_species_source')" id="l_method-i-most_species_source">show</a>
                

                

                
              </p>
              <div id="method-i-most_species_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1140</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">most_species</span>(<span class="ruby-identifier">options</span> = {})
<span class="line-num">1141</span>   <span class="ruby-identifier">per</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:per</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1142</span>   <span class="ruby-identifier">year</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:year</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>
<span class="line-num">1143</span>   <span class="ruby-identifier">month</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:month</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>
<span class="line-num">1144</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">per</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;month&#39;</span>
<span class="line-num">1145</span>     <span class="ruby-identifier">elastic_params</span> = { <span class="ruby-value">observed_on_year:</span> <span class="ruby-identifier">year</span>, <span class="ruby-value">observed_on_month:</span> <span class="ruby-identifier">month</span> }
<span class="line-num">1146</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1147</span>     <span class="ruby-identifier">elastic_params</span> = { <span class="ruby-value">observed_on_year:</span> <span class="ruby-identifier">year</span> }
<span class="line-num">1148</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1149</span>   <span class="ruby-identifier">elastic_params</span>[<span class="ruby-value">:verifiable</span>] = <span class="ruby-keyword">true</span>
<span class="line-num">1150</span>   <span class="ruby-identifier">elastic_params</span>[<span class="ruby-value">:site_id</span>] = <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@site</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@site</span>.<span class="ruby-identifier">prefers_site_only_users?</span>
<span class="line-num">1151</span>   <span class="ruby-identifier">elastic_query</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">params_to_elastic_query</span>(<span class="ruby-identifier">elastic_params</span>)
<span class="line-num">1152</span>   <span class="ruby-identifier">counts</span> = <span class="ruby-constant">Observation</span>.<span class="ruby-identifier">elastic_user_taxon_counts</span>(<span class="ruby-identifier">elastic_query</span>, <span class="ruby-value">limit:</span> <span class="ruby-value">5</span>, <span class="ruby-value">batch:</span> <span class="ruby-keyword">false</span>)
<span class="line-num">1153</span>   <span class="ruby-identifier">user_counts</span> = <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;user_id&quot;</span>], <span class="ruby-identifier">c</span>[<span class="ruby-string">&quot;count_all&quot;</span>] ] } ]
<span class="line-num">1154</span>   <span class="ruby-identifier">users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">keys</span>).<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
<span class="line-num">1155</span>   <span class="ruby-constant">Hash</span>[ <span class="ruby-identifier">user_counts</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>,<span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">users</span>[<span class="ruby-identifier">id</span>].<span class="ruby-identifier">first</span>, <span class="ruby-identifier">c</span> ] } ]
<span class="line-num">1156</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-permit_params">
            
              <b>permit_params</b>()
            
            <a href="../classes/UsersController.html#method-i-permit_params" name="method-i-permit_params" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-permit_params_source')" id="l_method-i-permit_params_source">show</a>
                

                

                
              </p>
              <div id="method-i-permit_params_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1212</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">permit_params</span>
<span class="line-num">1213</span>   <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1214</span>   <span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(<span class="ruby-value">:user</span>).<span class="ruby-identifier">permit</span>(
<span class="line-num">1215</span>     <span class="ruby-value">:data_transfer_consent</span>,
<span class="line-num">1216</span>     <span class="ruby-value">:description</span>,
<span class="line-num">1217</span>     <span class="ruby-value">:email</span>,
<span class="line-num">1218</span>     <span class="ruby-value">:icon</span>,
<span class="line-num">1219</span>     <span class="ruby-value">:icon_url</span>,
<span class="line-num">1220</span>     <span class="ruby-value">:lists_by_login_order</span>,
<span class="line-num">1221</span>     <span class="ruby-value">:lists_by_login_sort</span>,
<span class="line-num">1222</span>     <span class="ruby-value">:locale</span>,
<span class="line-num">1223</span>     <span class="ruby-value">:login</span>,
<span class="line-num">1224</span>     <span class="ruby-value">:make_observation_licenses_same</span>,
<span class="line-num">1225</span>     <span class="ruby-value">:make_photo_licenses_same</span>,
<span class="line-num">1226</span>     <span class="ruby-value">:make_sound_licenses_same</span>,
<span class="line-num">1227</span>     <span class="ruby-value">:name</span>,
<span class="line-num">1228</span>     <span class="ruby-value">:password</span>,
<span class="line-num">1229</span>     <span class="ruby-value">:password_confirmation</span>,
<span class="line-num">1230</span>     <span class="ruby-value">:per_page</span>,
<span class="line-num">1231</span>     <span class="ruby-value">:pi_consent</span>,
<span class="line-num">1232</span>     <span class="ruby-value">:place_id</span>,
<span class="line-num">1233</span>     <span class="ruby-value">:preferred_identify_image_size</span>,
<span class="line-num">1234</span>     <span class="ruby-value">:preferred_observation_fields_by</span>,
<span class="line-num">1235</span>     <span class="ruby-value">:preferred_observation_license</span>,
<span class="line-num">1236</span>     <span class="ruby-value">:preferred_observations_search_map_type</span>,
<span class="line-num">1237</span>     <span class="ruby-value">:preferred_observations_view</span>,
<span class="line-num">1238</span>     <span class="ruby-value">:preferred_photo_license</span>,
<span class="line-num">1239</span>     <span class="ruby-value">:preferred_project_addition_by</span>,
<span class="line-num">1240</span>     <span class="ruby-value">:preferred_sound_license</span>,
<span class="line-num">1241</span>     <span class="ruby-value">:prefers_captive_obs_maps</span>,
<span class="line-num">1242</span>     <span class="ruby-value">:prefers_comment_email_notification</span>,
<span class="line-num">1243</span>     <span class="ruby-value">:prefers_forum_topics_on_dashboard</span>,
<span class="line-num">1244</span>     <span class="ruby-value">:prefers_identification_email_notification</span>,
<span class="line-num">1245</span>     <span class="ruby-value">:prefers_identify_side_bar</span>,
<span class="line-num">1246</span>     <span class="ruby-value">:prefers_message_email_notification</span>,
<span class="line-num">1247</span>     <span class="ruby-value">:prefers_medialess_obs_maps</span>,
<span class="line-num">1248</span>     <span class="ruby-value">:prefers_project_invitation_email_notification</span>,
<span class="line-num">1249</span>     <span class="ruby-value">:prefers_mention_email_notification</span>,
<span class="line-num">1250</span>     <span class="ruby-value">:prefers_project_journal_post_email_notification</span>,
<span class="line-num">1251</span>     <span class="ruby-value">:prefers_project_curator_change_email_notification</span>,
<span class="line-num">1252</span>     <span class="ruby-value">:prefers_project_added_your_observation_email_notification</span>,
<span class="line-num">1253</span>     <span class="ruby-value">:prefers_taxon_change_email_notification</span>,
<span class="line-num">1254</span>     <span class="ruby-value">:prefers_user_observation_email_notification</span>,
<span class="line-num">1255</span>     <span class="ruby-value">:prefers_taxon_or_place_observation_email_notification</span>,
<span class="line-num">1256</span>     <span class="ruby-value">:prefers_no_email</span>,
<span class="line-num">1257</span>     <span class="ruby-value">:prefers_automatic_taxonomic_changes</span>,
<span class="line-num">1258</span>     <span class="ruby-value">:prefers_community_taxa</span>,
<span class="line-num">1259</span>     <span class="ruby-value">:prefers_location_details</span>,
<span class="line-num">1260</span>     <span class="ruby-value">:prefers_receive_mentions</span>,
<span class="line-num">1261</span>     <span class="ruby-value">:prefers_redundant_identification_notifications</span>,
<span class="line-num">1262</span>     <span class="ruby-value">:prefers_common_names</span>,
<span class="line-num">1263</span>     <span class="ruby-value">:prefers_scientific_name_first</span>,
<span class="line-num">1264</span>     <span class="ruby-value">:prefers_no_place</span>,
<span class="line-num">1265</span>     <span class="ruby-value">:prefers_no_site</span>,
<span class="line-num">1266</span>     <span class="ruby-value">:prefers_no_tracking</span>,
<span class="line-num">1267</span>     <span class="ruby-value">:prefers_monthly_supporter_badge</span>,
<span class="line-num">1268</span>     <span class="ruby-value">:search_place_id</span>,
<span class="line-num">1269</span>     <span class="ruby-value">:site_id</span>,
<span class="line-num">1270</span>     <span class="ruby-value">:test_groups</span>,
<span class="line-num">1271</span>     <span class="ruby-value">:time_zone</span>
<span class="line-num">1272</span>   )
<span class="line-num">1273</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-remove_friend">
            
              <b>remove_friend</b>()
            
            <a href="../classes/UsersController.html#method-i-remove_friend" name="method-i-remove_friend" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-remove_friend_source')" id="l_method-i-remove_friend_source">show</a>
                

                

                
              </p>
              <div id="method-i-remove_friend_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1053</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_friend</span>
<span class="line-num">1054</span>   <span class="ruby-identifier">error_msg</span>, <span class="ruby-identifier">notice_msg</span> = [<span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>]
<span class="line-num">1055</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">friendship</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">friendships</span>.<span class="ruby-identifier">find_by_friend_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:remove_friend_id</span>])
<span class="line-num">1056</span>     <span class="ruby-identifier">notice_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_are_no_longer_following_x</span>, <span class="ruby-value">:friend</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">friend</span>.<span class="ruby-identifier">login</span>)
<span class="line-num">1057</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">trust?</span>
<span class="line-num">1058</span>       <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">update</span>( <span class="ruby-value">following:</span> <span class="ruby-keyword">false</span> )
<span class="line-num">1059</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1060</span>       <span class="ruby-identifier">friendship</span>.<span class="ruby-identifier">destroy</span>
<span class="line-num">1061</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1062</span>   <span class="ruby-keyword">else</span>
<span class="line-num">1063</span>     <span class="ruby-identifier">error_msg</span> = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_arent_following_that_person</span>)
<span class="line-num">1064</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1065</span>   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
<span class="line-num">1066</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-keyword">do</span>
<span class="line-num">1067</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">error_msg</span>
<span class="line-num">1068</span>       <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">notice_msg</span>
<span class="line-num">1069</span>       <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">person_by_login_path</span>(<span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">1070</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1071</span>     <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> <span class="ruby-operator">=&gt;</span> {<span class="ruby-value">:msg</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">error_msg</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">notice_msg</span>, <span class="ruby-value">:friendship</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">friendship</span>} }
<span class="line-num">1072</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1073</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-site_admin_of_user_required">
            
              <b>site_admin_of_user_required</b>()
            
            <a href="../classes/UsersController.html#method-i-site_admin_of_user_required" name="method-i-site_admin_of_user_required" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-site_admin_of_user_required_source')" id="l_method-i-site_admin_of_user_required_source">show</a>
                

                

                
              </p>
              <div id="method-i-site_admin_of_user_required_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1282</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">site_admin_of_user_required</span>
<span class="line-num">1283</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_site_admin_of?</span>( <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">site</span> )
<span class="line-num">1284</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:only_administrators_may_access_that_page</span>)
<span class="line-num">1285</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-value">:return_to</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">fullpath</span>
<span class="line-num">1286</span>       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>
<span class="line-num">1287</span>     <span class="ruby-keyword">else</span>
<span class="line-num">1288</span>       <span class="ruby-identifier">redirect_back_or_default</span>(<span class="ruby-identifier">root_url</span>)
<span class="line-num">1289</span>     <span class="ruby-keyword">end</span>
<span class="line-num">1290</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="line-num">1291</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1292</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-update_password">
            
              <b>update_password</b>()
            
            <a href="../classes/UsersController.html#method-i-update_password" name="method-i-update_password" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                 Source: 

                
                  <a href="javascript:toggleSource('method-i-update_password_source')" id="l_method-i-update_password_source">show</a>
                

                

                
              </p>
              <div id="method-i-update_password_source" class="dyn-source">
                <pre>     <span class="ruby-comment"># File app/controllers/users_controller.rb</span>
<span class="line-num">1075</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_password</span>
<span class="line-num">1076</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:password</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:password_confirmation</span>].<span class="ruby-identifier">blank?</span>
<span class="line-num">1077</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:you_must_specify_and_confirm_a_new_password</span>)
<span class="line-num">1078</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">edit_person_path</span>(<span class="ruby-ivar">@user</span>))
<span class="line-num">1079</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1080</span>   
<span class="line-num">1081</span>   <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">password</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:password</span>]
<span class="line-num">1082</span>   <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">password_confirmation</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:password_confirmation</span>]
<span class="line-num">1083</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">1084</span>     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">save!</span>
<span class="line-num">1085</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:successfully_changed_your_password</span>)
<span class="line-num">1086</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordInvalid</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">1087</span>     <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">t</span>(<span class="ruby-value">:couldnt_change_your_password</span>, <span class="ruby-value">:e</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>)
<span class="line-num">1088</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">edit_person_path</span>(<span class="ruby-ivar">@user</span>))
<span class="line-num">1089</span>   <span class="ruby-keyword">end</span>
<span class="line-num">1090</span>   <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">person_by_login_path</span>(<span class="ruby-value">:login</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>))
<span class="line-num">1091</span> <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
